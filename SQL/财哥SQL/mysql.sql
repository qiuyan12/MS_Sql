

--鑫威--执行的时候不要选取已经屏蔽的!!!!!!



/*

use master 

exec sp_who_lock

exec sp_kill_lockprocess



select *
--update t1 set fname=fname+'[禁用]' 
from t_user t1 where fforbidden=1 and fname not like '%禁用%'

select distinct t3.fitemid into #data
from t_icitem t3  --套件
inner join icbom t7 on t3.fitemid=t7.fitemid
inner join icbomchild t8 on t7.finterid=t8.finterid
inner join t_icitem t4 on t8.fitemid=t4.fitemid --子件
where left(t4.fnumber,1) in ('7','8')


SELECT t7.finterid,t8.fentryid,t3.fnumber 编码,t3.fname 名称,t3.fmodel 规格型号,
t4.fnumber 子件编码,t4.fname 子件名称,t4.fmodel 子件规格型号,t6.fname 单位,
t8.fqty 单位用量,0 调整后用量
from t_icitem t3  --套件
inner join icbom t7 on t3.fitemid=t7.fitemid
inner join icbomchild t8 on t7.finterid=t8.finterid
inner join t_icitem t4 on t8.fitemid=t4.fitemid --子件
inner join t_measureunit t6 on t6.FMeasureUnitID=t4.funitid
where t3.fitemid in (select fitemid from #data)
order by t3.fnumber,t8.fentryid,t4.fnumber

drop table icbombak drop table icbomchildbak
select * into icbombak from icbom
select * into icbomchildbak from icbomchild

drop table #data

--select t7.fnumber,t7.fname,t6.fnumber,t6.fname,t8.fnumber,t8.fname,t8.fitemid
select t2.finterid,t12.fitemid,sum(t12.fqty) fqty into #data
--delete t12
from t_icitem t1
inner join icbom t2 on t1.fitemid=t2.fitemid --and t2.fstatus>0 --成品
inner join icbomchild t3 on t2.finterid=t3.finterid  --半成品
inner join icbom t11 on t11.fitemid=t3.fitemid  --半成品
inner join icbomchild t12 on t11.finterid=t12.finterid  --半成品子项

inner join t_icitem t6 on t6.fitemid=t3.fitemid --半成品
inner join t_icitem t7 on t7.fitemid=t2.fitemid --成品
inner join t_icitem t8 on t8.fitemid=t12.fitemid --半成品子项
where t8.fnumber like '2.09%' --t8.fshortnumber ='253037'
--and t12.fqty>1
--and t7.fnumber='V.A.A0021.01.VA04967'
--order by t7.fnumber
group by t2.finterid,t12.fitemid
order by t2.finterid
	
--只有一条记录的
--INSERT INTO ICBomChild (FInterID,    FEntryID,            FBrNo,FItemID,    FMachinePos,FNote,FAuxQty,       FScrap,FOffSetDay,FUnitID,    FQty,        FMaterielType,FMarshalType,FBeginDay,   FEndDay,     FPercent,FPositionNo,FItemSize,FItemSuite,FOperSN,FOperID,FBackFlush,FStockID,      FSPID,FAuxPropID,FPDMImportDate,FDetailID) 
select                    t12.FInterID,(select (max(fentryid)+1) from icbomchild where finterid=t12.finterid) fentryid,    
                                                            '0',  t12.fitemid,'',         '',   t12.fqty,      0,     0,         t2.FUnitID, t12.fqty,    371,          385,         '1900-01-01','2100-01-01',100,     '',         '',       '',        '',     0,      1059,      t2.fdefaultloc,0,    0,         null,          NEWID() 
from #data t12 
inner join t_icitem t2 on t12.fitemid=t2.fitemid
where t12.finterid not in (select finterid from #data group by finterid having count(1)>1)


--select * from #data
--select * from t_databom

select distinct t0.finterid into t_databom from #data t0 where finterid in (select finterid from #data group by finterid having count(1)>1)
select * into t_databomdetail from #data t0 where finterid in (select finterid from #data group by finterid having count(1)>1)

select t7.fnumber,t7.fname,t6.fnumber,t6.fname
--delete t3
from t_icitem t1
inner join icbom t2 on t1.fitemid=t2.fitemid --and t2.fstatus>0 --成品
inner join icbomchild t3 on t2.finterid=t3.finterid  --半成品
inner join t_icitem t6 on t6.fitemid=t3.fitemid --半成品
inner join t_icitem t7 on t7.fitemid=t2.fitemid --成品
where t6.fnumber like '2.09%' --t8.fshortnumber ='253037'
and t2.finterid in (select finterid from t_databom)

select t1.fnumber,t1.fname
from t_icitem t1
inner join icbom t2 on t1.fitemid=t2.fitemid
where t2.finterid in (select finterid from t_databom)

declare @finterid int,@fentryid int, @fqty decimal(24,6),@funitid int,@fitemid int,@fstockid int

DECLARE authors_cursor CURSOR FOR	
select distinct t0.finterid from t_databom t0 

OPEN authors_cursor

FETCH NEXT FROM authors_cursor 
INTO @finterid

WHILE @@FETCH_STATUS = 0
BEGIN
	select @fentryid=isnull(max(fentryid),0)+1 from icbomchild where finterid=@finterid

	DECLARE authorsentry_cursor CURSOR FOR
	select t2.funitid,t1.fitemid,t2.fdefaultloc fstockid,t1.fqty
	from t_databomdetail t1 
	inner join t_icitem t2 on t1.fitemid=t2.fitemid
	where t1.finterid=@finterid
	order by t2.fnumber
		
	OPEN authorsentry_cursor

	FETCH NEXT FROM authorsentry_cursor 
	INTO @funitid,@fitemid,@fstockid,@fqty

	WHILE @@FETCH_STATUS = 0
	BEGIN 
		INSERT INTO ICBomChild (FInterID, FEntryID,            FBrNo,FItemID, FMachinePos,FNote,FAuxQty,    FScrap,FOffSetDay,FUnitID,  FQty,     FMaterielType,FMarshalType,FBeginDay,   FEndDay,     FPercent,FPositionNo,FItemSize,FItemSuite,FOperSN,FOperID,FBackFlush,FStockID,      FSPID,FAuxPropID,FPDMImportDate,FDetailID) 
					values (    @FInterID,@fentryid,           '0',  @fitemid,'',         '',   @fqty,      0,     0,         @FUnitID, @fqty,    371,          385,         '1900-01-01','2100-01-01',100,     '',         '',       '',        '',     0,      1059,      @FStockID,     0,    0,         null,          NEWID() )

		set @fentryid=@fentryid+1

		FETCH NEXT FROM authorsentry_cursor 
		INTO @funitid,@fitemid,@fstockid,@fqty
	END

	CLOSE authorsentry_cursor
	DEALLOCATE authorsentry_cursor


    FETCH NEXT FROM authors_cursor 
    INTO @finterid
END

CLOSE authors_cursor
DEALLOCATE authors_cursor

go

select month(t1.fdate) 期间,sum(fbuqty) 补,sum(ftuiqty) 退,sum(fqty) 正常
from
(
	select t3.fdate,(case when t2.fsourcetrantype=200000014 and t2.fqty>0 then t2.famount else 0 end) fbuqty
	,(case when t2.fsourcetrantype=200000014 and t2.fqty<0 then t2.famount else 0 end) ftuiqty
	,(case when t2.fsourcetrantype=85 then t2.famount else 0 end) fqty,
	t2.famount 金额--,t1.fnote 任务单备注--,t4.fplanprice,t4.fplanprice*t2.fqty
	from icstockbillentry t2 
	inner join icstockbill t3 on t2.finterid=t3.finterid
	inner join t_icitem t4 on t4.fitemid=t2.fitemid
	inner join icmo t1 on t1.finterid=t2.ficmointerid
	inner join t_icitem t5 on t5.fitemid=t1.fitemid
	where year(t3.fdate)=2016 
	and month(t3.fdate) in (9,10,11) and t3.ftrantype=24
) t1
group by month(t1.fdate)


select t1.fbillno 任务单号,t5.fnumber 产品编码,t5.fname 名称,t5.fmodel 规格型号,t3.fdate 领料日期,
t3.fbillno 领料单号,t4.fnumber 物料编码,t4.fname 物料名称,t4.fmodel 物料规格型号,t2.fqty 数量,t2.fprice 单价,
t2.famount 金额--,t1.fnote 任务单备注--,t4.fplanprice,t4.fplanprice*t2.fqty
from icstockbillentry t2 
inner join icstockbill t3 on t2.finterid=t3.finterid
inner join t_icitem t4 on t4.fitemid=t2.fitemid
inner join icmo t1 on t1.finterid=t2.ficmointerid
inner join t_icitem t5 on t5.fitemid=t1.fitemid
where year(t3.fdate)=2016 
and month(t3.fdate) in (9,10,11) and t1.fnote like '%返工%' and t3.ftrantype=24
and left(t4.fnumber,1) not in ('3','4','5','7','8')
order by t3.fdate,t5.fnumber,t4.fnumber



select t1.fbillno 任务单号,t5.fnumber 产品编码,t5.fname 名称,t5.fmodel 规格型号,t3.fdate 入库日期,
t3.fbillno 入库单号,t2.fqty 数量,t2.fprice 单价,t2.famount 金额--,t1.fnote 任务单备注 --,t4.fplanprice,t4.fplanprice*t2.fqty
from icstockbillentry t2 
inner join icstockbill t3 on t2.finterid=t3.finterid
inner join t_icitem t4 on t4.fitemid=t2.fitemid
inner join icmo t1 on t1.finterid=t2.ficmointerid
inner join t_icitem t5 on t5.fitemid=t1.fitemid
where year(t3.fdate)=2016 
and month(t3.fdate) in (9,10,11) and t1.fnote like '%返工%' and t3.ftrantype=2
order by t3.fdate,t5.fnumber,t4.fnumber



select *
--update t1 set fheadselfa0234='2016-11-01',fdate='2016-11-01'
from icstockbill t1 where fbillno>='cin052672' and fbillno<='cin052678'

--国家
seorder  fheadselfs0146
seoutstock fheadselfs0247
icstockbill fheadselfb0154

update t4 set fheadselfs0247=t1.fheadselfs0146
from seorder t1
inner join seorderentry t2 on t1.finterid=t2.finterid
inner join seoutstockentry t3 on t3.fsourceinterid=t2.finterid and t3.fsourceentryid=t2.fentryid and t3.fsourcetrantype=81
inner join seoutstock t4 on t4.finterid=t3.finterid

update t4 set fheadselfb0154=t1.fheadselfs0146
from seorder t1
inner join seorderentry t2 on t1.finterid=t2.finterid
inner join icstockbillentry t3 on t3.forderinterid=t2.finterid and t3.forderentryid=t2.fentryid and t3.fsourcetrantype=83
inner join icstockbill t4 on t4.finterid=t3.finterid and t4.ftrantype=21


select t1.fbillno 任务单号,t4.fname 生产车间,t6.fnumber 编码,t6.fname 产品名称,t3.fbillno 入库领料单号,t3.fdate 入库领料日期,t5.fname 入库领料部门
--update t3 set fdeptid=t1.fworkshop
from icmo t1
inner join icstockbillentry t2 on t1.finterid=t2.ficmointerid
inner join icstockbill t3 on t2.finterid=t3.finterid
inner join t_department t4 on t4.fitemid=t1.fworkshop
inner join t_department t5 on t5.fitemid=t3.fdeptid
inner join t_icitem t6 on t6.fitemid=t1.fitemid
where t3.fdeptid<>t1.fworkshop
and t3.fdate>='2016-11-01'

--采购订单-外调品
select t2.fentryid,t7.fnumber, t1.fnumber ,t2.fcommitqty,t2.fbcommitqty,t13.fqty,t2.*
--update t2 set fbcommitqty=isnull(t13.fqty,0),fauxbcommitqty=isnull(t13.fqty,0),fordercommitqty=isnull(t13.fqty,0)
                              FROM t_ICItem t7 
                              inner join seorderentry t2 on t7.fitemid=t2.fitemid 
                              inner join seorder t3 on t2.finterid=t3.finterid 
                              inner join icbom t14 on t14.fitemid=t7.fitemid 
                              inner join icbomchild t15 on t15.finterid=t14.finterid 
                              inner join t_ICItem t1 on t1.fitemid=t15.fitemid 
							  left join poorderentry t13 on t13.fsourceinterid=t2.finterid and t13.fsourceentryid=t2.fentryid and t13.fsourcetrantype=81
                              where t3.fbillno like '%1610135'
                              and left(t1.fnumber,1) in ('7','8') 


select t2.fitemid,t2.fnumber 编码,t2.fname 名称,t2.fmodel 规格型号,t1.fbatchno 批号,
--t1.fbegbal 期初余额,t1.fbegqty 期初数量,frecieve 本期收入,fsend 本期发出,
t1.fendqty 期末数量,
--fdebit,fcredit,
t1.fendbal 期末余额,
cast(t1.fendbal/t1.fendqty as decimal(24,4)) 平均单价,--cast(0 as decimal(24,4)) 最新单价
cast(t2.fplanprice as decimal(24,4)) 最新单价
into #data
from [192.168.1.6\sql2005].[AIS20120820103535].dbo.icbal t1 
inner join [192.168.1.6\sql2005].[AIS20120820103535].dbo.t_icitem t2 on t1.fitemid=t2.fitemid 
where t1.fyear=2016 and t1.fperiod=8 --and t2.fnumber like '2%' 
and t1.fendqty<>0 --and t1.fbegbal/t1.fbegqty>20

select
--update t1 set 最新单价=t2.fprice
from #data t1 
inner join 
(
	select t4.fitemid,(case when t5.fcyid=1000 then t5.ftaxprice*t1.fexchangerate else t5.ftaxprice end) fprice
	--into #temp --
	from (select fitemid,max(fentryid) fentryid from (select t1.fitemid,t1.fentryid from t_supplyentry t1 inner join (select fitemid,max(FQuoteTime) FQuoteTime from t_SupplyEntry group by fitemid) t2 on t1.fitemid=t2.fitemid and t1.FQuoteTime=t2.FQuoteTime) t1 group by fitemid) t4 
	inner join t_supplyentry t5 on t4.fitemid=t5.fitemid and t4.fentryid=t5.fentryid
	inner join t_currency t1 on t1.fcurrencyid=t5.fcyid
) t2 on t1.fitemid=t2.fitemid

select * from #data order by 编码

drop table #data

--当一次一次被所谓的更高优先级中断当下评估过的所谓最高优先级事务，情绪似乎有点不可控制起来。。。

--9.1号前下的订单，金额与含税金额都是含税金额  -> 把金额除于1.17，刷新成不含税金额

select t8.fbillno forderbillno,t1.fbillno,t11.fname fsupname,
t9.fnumber,t9.fname,t9.fmodel,--t10.fnumber ,t10.fname,t10.fmodel,
t7.fqty forderqty,t7.fprice,
t2.fqty finqty,t5.fperqty,t2.fqty/t5.fperqty fsuitinqty,t7.finterid,t7.fentryid
--update t2 set fprice=cast(t2.fprice/1.17 as decimal(24,6) )
--update t2 set famount=cast(t2.fprice*t2.fqty as decimal(24,2) )
from icstockbill t1
inner join icstockbillentry t2 on t1.finterid=t2.finterid
inner join poinstockentry t3 on t2.fsourceinterid=t3.finterid and t2.fsourceentryid=t3.fentryid and t2.fsourcetrantype=72
inner join poinstock t4 on t3.finterid=t4.finterid
inner join t_bosPlasticPoInStockEntry t5 on t5.fid=t3.fsourceinterid and t5.fentryid=t3.fsourceentryid and t3.fsourcetrantype=200000022
inner join t_bosPlasticPoInStock t6 on t6.fid=t5.fid
inner join poorderentry t7 on t7.finterid=t5.fid_src and t7.fentryid=t5.fentryid_src 
inner join poorder t8 on t8.finterid=t7.finterid
inner join t_icitem t9 on t9.fitemid=t7.fitemid
inner join t_icitem t10 on t10.fitemid=t2.fitemid
inner join t_supplier t11 on t11.fitemid=t8.fsupplyid
where t1.fdate>='2016-09-01' --and t1.fdate<=''
and t8.fdate<='2016-08-31'


--9.1号开始下的订单，金额与含税金额列都是不含税金额  -> 把含税金额刷新成：金额乘于1.17

select t8.fbillno forderbillno,t1.fbillno,t11.fname fsupname,
t9.fnumber,t9.fname,t9.fmodel,--t10.fnumber ,t10.fname,t10.fmodel,
t7.fqty forderqty,t7.fprice,
t2.fqty finqty,t5.fperqty,t2.fqty/t5.fperqty fsuitinqty,t7.finterid,t7.fentryid
--update t2 set fentryselfa0154=cast(t2.fprice*1.17 as decimal(24,6) )
--update t2 set fentryselfa0155=cast(t2.fentryselfa0154*t2.fqty as decimal(24,2) )
from icstockbill t1
inner join icstockbillentry t2 on t1.finterid=t2.finterid
inner join poinstockentry t3 on t2.fsourceinterid=t3.finterid and t2.fsourceentryid=t3.fentryid and t2.fsourcetrantype=72
inner join poinstock t4 on t3.finterid=t4.finterid
inner join t_bosPlasticPoInStockEntry t5 on t5.fid=t3.fsourceinterid and t5.fentryid=t3.fsourceentryid and t3.fsourcetrantype=200000022
inner join t_bosPlasticPoInStock t6 on t6.fid=t5.fid
inner join poorderentry t7 on t7.finterid=t5.fid_src and t7.fentryid=t5.fentryid_src 
inner join poorder t8 on t8.finterid=t7.finterid
inner join t_icitem t9 on t9.fitemid=t7.fitemid
inner join t_icitem t10 on t10.fitemid=t2.fitemid
inner join t_supplier t11 on t11.fitemid=t8.fsupplyid
where t1.fdate>='2016-09-01' --and t1.fdate<=''
and t8.fdate>='2016-09-01'



select * from t_stock where fname like '%临时%'


--半成品

select t9.fstockid,t0.*
--update t9 set fstockid=(case when t23.ftypeid=503 then 216967 else 214953 end)  --8.31之前有领料记录的，把仓库改成临时仓
--select distinct t21.finterid into #data
--delete t21  --删掉8.31之前的领料记录
from icmo t0   
inner join t_icitem t7 on t0.fitemid=t7.fitemid 
inner join ppbomentry t9 on t9.ficmointerid=t0.finterid
inner join ppbom t10 on t10.finterid=t9.finterid
inner join t_icitem t11 on t11.fitemid=t9.fitemid
inner join icstockbillentry t21 on t21.ficmointerid=t0.finterid
inner join icstockbill t22 on t22.finterid=t21.finterid and t22.ftrantype=24 and t22.fdate<='2016-08-31'
left join t_stock t23 on t23.fitemid=t11.fdefaultloc
where t0.fbillno in (select zp201608003 from sheet73$) or t0.fbillno='zp201608003'

select 1
--update t1 set fcheckerid=0,fstatus=0
--delete t1   --删除表头
from icstockbill t1 where finterid not in (select finterid from icstockbillentry) 
and t1.fdate>='2016-07-01' and t1.ftrantype=24



select t0.*
--update t9 set fstockqty=0,fauxstockqty=0,fqty=0,fauxqty=0,FQtyPick=0,FAuxQtyPick=0  --清除投料单已领数
from icmo t0  
inner join t_icitem t7 on t0.fitemid=t7.fitemid 
inner join ppbomentry t9 on t9.ficmointerid=t0.finterid
inner join ppbom t10 on t10.finterid=t9.finterid
inner join t_icitem t11 on t11.fitemid=t9.fitemid
where (t0.fbillno in (select zp201608003 from sheet73$) or t0.fbillno='zp201608003')

update t1 set fqty=isnull(t2.fqty,0),fauxqty=isnull(t2.fqty,0)  --更新投料关联数
from PPBOMEntry t1 --
inner join 
(
	select t1.ficmointerid,t1.fppbomentryid,t1.fitemid,sum(t1.fqty) fqty
	from ICStockBill t0 --
	inner join ICStockBillEntry t1 on t0.finterid=t1.finterid  --
	inner join icmo t3 on t3.finterid=t1.ficmointerid
	where t0.ftrantype=24 and t1.fsourcetrantype in (85,200000014)
	and (t3.fbillno in (select zp201608003 from sheet73$) or t3.fbillno='zp201608003')
	group by t1.ficmointerid,t1.fppbomentryid,t1.fitemid
) t2 on t1.ficmointerid=t2.ficmointerid and t1.FEntryID=t2.fppbomentryid and t1.fitemid=t2.fitemid


--成品


select t1.t9.fstockqty,t9.fqty
--update t9 set fstockid=(case when t23.ftypeid=503 then 216967 else 214953 end) --8.31之前有领料记录的，把仓库改成临时仓
--select distinct t21.finterid into #data
--delete t21  --删掉8.31之前的领料记录
from icmo t0 
inner join SeorderEntry t12 on t0.forderinterid=t12.finterid and t0.fsourceentryid=t12.fentryid and t0.fitemid=t12.fitemid
inner join seorder t1 on t1.finterid=t12.finterid  
inner join t_User t4 on t0.fbillerid=t4.fuserid and t4.fuserid<>0  
left join t_User t5 on t0.fconfirmerid=t5.fuserid and t5.fuserid<>0  
left join t_User t6 on t0.fconveyerid=t6.fuserid and t6.fuserid<>0  
inner join t_icitem t7 on t12.fitemid=t7.fitemid 
left join t_Organization t2 on t1.fcustid=t2.fitemid
inner join t_department t8 on t8.fitemid=t0.fworkshop
inner join ppbomentry t9 on t9.ficmointerid=t0.finterid
inner join ppbom t10 on t10.finterid=t9.finterid
inner join t_icitem t11 on t11.fitemid=t9.fitemid
inner join icstockbillentry t21 on t21.ficmointerid=t0.finterid
inner join icstockbill t22 on t22.finterid=t21.finterid and t22.ftrantype=24 and t22.fdate<='2016-08-31'
left join t_stock t23 on t23.fitemid=t11.fdefaultloc
where --t23.ftypeid<>503 and --非代管
t1.fbillno in ('XW1608027','XW1608077','XW1608098','XW1607089',
					   	'XW1607199','XW1608017','XW1608029','XW1608030','XW1608037','XW1608036','XW1608043','XW1608048','XW1608050',
						'XW1608054','XW1608088','XW1608103','XW1608109','XW1608115','XW1608124','XW1608130','XW1608021','XW1608074','XW1608044','XW1608089')

select 1
--update t1 set fcheckerid=0,fstatus=0
--delete t1  --删除表头
from icstockbill t1 where finterid in (select finterid from #data) 

select
--update t9 set fstockqty=0,fauxstockqty=0,fqty=0,fauxqty=0,FQtyPick=0,FAuxQtyPick=0   --清除投料单已领数
from icmo t0 
inner join SeorderEntry t12 on t0.forderinterid=t12.finterid and t0.fsourceentryid=t12.fentryid and t0.fitemid=t12.fitemid
inner join seorder t1 on t1.finterid=t12.finterid  
inner join t_User t4 on t0.fbillerid=t4.fuserid and t4.fuserid<>0  
left join t_User t5 on t0.fconfirmerid=t5.fuserid and t5.fuserid<>0  
left join t_User t6 on t0.fconveyerid=t6.fuserid and t6.fuserid<>0  
inner join t_icitem t7 on t12.fitemid=t7.fitemid 
left join t_Organization t2 on t1.fcustid=t2.fitemid
inner join t_department t8 on t8.fitemid=t0.fworkshop
inner join ppbomentry t9 on t9.ficmointerid=t0.finterid
inner join ppbom t10 on t10.finterid=t9.finterid
inner join t_icitem t11 on t11.fitemid=t9.fitemid
where t1.fbillno in ('XW1608027','XW1608077','XW1608098','XW1607089',
					   	'XW1607199','XW1608017','XW1608029','XW1608030','XW1608037','XW1608036','XW1608043','XW1608048','XW1608050',
						'XW1608054','XW1608088','XW1608103','XW1608109','XW1608115','XW1608124','XW1608130','XW1608021','XW1608074','XW1608044','XW1608089')

update t1 set fqty=isnull(t2.fqty,0),fauxqty=isnull(t2.fqty,0)  ----更新投料关联数
from PPBOMEntry t1 --
inner join 
(
	select t1.ficmointerid,t1.fppbomentryid,t1.fitemid,sum(t1.fqty) fqty
	from ICStockBill t0 --
	inner join ICStockBillEntry t1 on t0.finterid=t1.finterid  --
	inner join icmo t3 on t3.finterid=t1.ficmointerid
	inner join seorder t4 on t4.finterid=t3.forderinterid
	where t0.ftrantype=24 and t1.fsourcetrantype in (85,200000014)
	and t4.fbillno in ('XW1608027','XW1608077','XW1608098','XW1607089',
					   	'XW1607199','XW1608017','XW1608029','XW1608030','XW1608037','XW1608036','XW1608043','XW1608048','XW1608050',
						'XW1608054','XW1608088','XW1608103','XW1608109','XW1608115','XW1608124','XW1608130','XW1608021','XW1608074','XW1608044','XW1608089')
	group by t1.ficmointerid,t1.fppbomentryid,t1.fitemid
) t2 on t1.ficmointerid=t2.ficmointerid and t1.FEntryID=t2.fppbomentryid and t1.fitemid=t2.fitemid




--人工
select t3.fqty*(isnull(t1.FPiece,0)+isnull(t2.FPieceRate,0.35))
from icstockbillentry t3
inner join t_icitem t2 on t2.fitemid=t3.fitemid
inner join icstockbill t4 on t4.finterid=t3.finterid 
left join  
(
	select fitemid,sum(FPiece) FPiece
	from
	(
		select t1.fitemid,isnull(t4.FPieceRate,0)*t3.fqty FPiece
		from t_icitem t1
		inner join icbom t2 on t1.fitemid=t2.fitemid
		inner join icbomchild t3 on t2.finterid=t3.finterid
		inner join t_icitem t4 on t3.fitemid=t4.fitemid
		where left(t4.fnumber,1) in ('3','4','5')
	) t1 group by t1.fitemid
) t1 on t3.fitemid=t1.fitemid 
where t4.ftrantype=21 and year(t4.fdate)=2016 and month(t4.fdate)=5

select * 
--update t1 set fcaption=t1.fcaption+'-中山鑫威'
from [dbo].[ICTemplate] t1
inner join ictranstype t2 on t1.fid=t2.ftemplateid 
where t1.fctlindex=-1 and t1.ftabindex=0 and t1.fctltype=6 
and t1.fcaption not like '%中山鑫威%'


--纯PCS数
--销售订单
seorderentry.FEntrySelfS0188
--销售出库   
icstockbillentry.FEntrySelfB0160
--产品入库
icstockbillentry.FEntrySelfA0238
--发货通知单
SEOutStockEntry.FEntrySelfS0238
--任务单
icmo.FHeadSelfJ0183

--外购产品利润分析
select t2.fdate 日期,t3.fname 客户,t1.forderbillno 订单编号,t4.fnumber 编码,t4.fname 名称,t4.fmodel 规格型号,
t1.fqty 数量,t1.fprice 单位成本,t1.famount 成本,t1.fconsignprice 销售单价,t1.fconsignamount 销售金额
from icstockbillentry t1  
inner join icstockbill t2 on t1.finterid=t2.finterid  
inner join t_icitem t4 on t1.fitemid=t4.fitemid
inner join t_supplier t5 on t5.fitemid=t1.fentryselfb0161
inner join t_organization t3 on t3.fitemid=t2.fsupplyid
where t2.fdate>='2015-01-01' and t2.fdate<='2016-04-30' and t2.ftrantype=21
and t5.fname not like '%鑫威%'
order by t2.fdate,t1.forderbillno

--套装
select distinct t3.fitemid,t3.fnumber,t3.fname,t3.fmodel into #data
from
(
	select fitemid from
	(
		select t1.fitemid,t1.fnumber,t1.fname
		from t_icitem t1
		inner join icbom t2 on t1.fitemid=t2.fitemid
		inner join icbomchild t3 on t2.finterid=t3.finterid
		inner join t_icitem t4 on t3.fitemid=t4.fitemid
		where t1.fname not like '%禁用%' and t1.fdeleted=0 
		--and left(t1.fnumber,1) in ('v') 
		and left(t4.fnumber,1) in ('3','4','5','7','8')
	) t1 group by t1.fitemid
	having count(1)>1
	union all
	select fitemid from
	(
		select t1.fitemid,t1.fnumber,t1.fname
		from t_icitem t1
		inner join icbom t2 on t1.fitemid=t2.fitemid
		inner join icbomchild t3 on t2.finterid=t3.finterid
		inner join t_icitem t4 on t3.fitemid=t4.fitemid
		where t1.fname not like '%禁用%' and t1.fdeleted=0 
		--and left(t1.fnumber,1) in ('v') and 
		and t3.fqty>1
		and left(t4.fnumber,1) in ('3','4','5','7','8')
	) t1 group by t1.fitemid
	union all
	select fitemid from
	(
		select distinct t1.fitemid,t1.fnumber,t1.fname
		from t_icitem t1
		inner join icbom t2 on t1.fitemid=t2.fitemid
		inner join icbomchild t3 on t2.finterid=t3.finterid
		inner join t_icitem t4 on t3.fitemid=t4.fitemid
		where t1.fname not like '%禁用%' and t1.fdeleted=0 and t1.fname like '%套%'
		--and left(t1.fnumber,1) in ('v') 
		and left(t4.fnumber,1) in ('3','4','5','7','8') and t1.fitemid<197229
	) t1 group by t1.fitemid
) t1 inner join t_ICItemCustom t12 on t1.fitemid=t12.fitemid
inner join t_icitem t3 on t3.fitemid=t1.fitemid
order by t3.fitemid

select t3.fnumber,t3.fname,t6.fname,t3.funitid,t3.funitgroupid
--update t2 set FUnitID=235, FUnitGroupID=220,FOrderUnitID=235, FSaleUnitID=235,FStoreUnitID=235, FProductUnitID=235
from t_icitem t3  --套件
inner join t_measureunit t6 on t6.FMeasureUnitID=t3.funitid
inner join #data t1 on t1.fitemid=t3.fitemid
inner JOIN t_ICItemBase AS t2 ON t1.FItemID = t2.FItemID 
order by t6.fname

select * from t_measureunit

SELECT t7.finterid,t8.fentryid,t3.fnumber 编码,t3.fname 名称,t3.fmodel 规格型号,
t4.fnumber 子件编码,t4.fname 子件名称,t4.fmodel 子件规格型号,t6.fname 单位,
t8.fqty 单位用量,0 调整后用量
from t_icitem t3  --套件
inner join icbom t7 on t3.fitemid=t7.fitemid
inner join icbomchild t8 on t7.finterid=t8.finterid
inner join t_icitem t4 on t8.fitemid=t4.fitemid --子件
inner join t_measureunit t6 on t6.FMeasureUnitID=t4.funitid
where t3.fitemid in (select fitemid from #data)
order by t3.fnumber,t4.fnumber

SELECT t7.fid,t8.fentryid,t3.fnumber 编码,t3.fname 名称,t3.fmodel 规格型号,
t4.fnumber 子件编码,t4.fname 子件名称,t4.fmodel 子件规格型号,t6.fname 单位,
t8.fqty 单位用量,0 调整后用量
from t_icitem t3  --套件
inner join t_bospacksub t7 on t3.fitemid=t7.fproductid
inner join t_bospacksubentry t8 on t7.fid=t8.fid
inner join t_icitem t4 on t8.fitemid=t4.fitemid --子件
inner join t_measureunit t6 on t6.FMeasureUnitID=t4.funitid
where t3.fitemid in (select fitemid from #data)
order by t3.fnumber,t4.fnumber

--对账
--select t5.fnumber,t5.fname
--update t3 set fentryselfa0154=t2.ftaxprice,fentryselfa0155=cast(t2.ftaxprice*t3.fqty as decimal(24,2) ) --,t3.famount=cast(t3.ftaxprice*t3.fqty as decimal(24,2))
from poorder t1  
inner join poorderentry t2 on t1.finterid=t2.finterid  
inner join icstockbillentry t3 on t3.forderinterid=t2.finterid and t3.forderentryid=t2.fentryid and t2.fitemid=t3.fitemid 
inner join icstockbill t4 on t3.finterid=t4.finterid  
inner join t_icitem t5 on t5.fitemid=t3.fitemid
where year(t4.fdate)=2016  and month(t4.fdate)=9 
and t4.ftrantype=1 and isnull(t4.FVchInterID,0)=0 
--and t5.fnumber like '6.%'

update t3 set fentryselfa0155=cast(t3.fprice*t3.fqty as decimal(24,2)),t3.famount=cast(t3.fprice*t3.fqty as decimal(24,2))
--select t5.fnumber,t5.fname,t3.fprice,t3.fqty,t3.famount 
from icstockbillentry t3 
inner join icstockbill t4 on t3.finterid=t4.finterid 
inner join t_icitem t5 on t5.fitemid=t3.fitemid
where year(t4.fdate)=2015  and month(t4.fdate)=8 
and t4.ftrantype=1 and isnull(t4.FVchInterID,0)=0 and t5.fnumber like '6.%'
and t4.fbillno like 'win027050'

--更新外购入库单的含税单价--人民币
select t1.fcurrencyid,t5.fnumber,t5.fname,t3.fsourcetrantype,t3.fentryselfa0154,t3.fentryselfa0155,t3.fprice,t3.famount,t2.fprice,t2.famount
--update t3 set fentryselfa0154=t2.fprice,fentryselfa0155=cast(t2.fprice*t3.fqty as decimal(24,2)) --,t3.famount=cast(t3.fprice*t3.fqty as decimal(24,2))
from poinstock t1  
inner join poinstockentry t2 on t1.finterid=t2.finterid  
inner join icstockbillentry t3 on t3.fsourceinterid=t2.finterid and t3.fsourceentryid=t2.fentryid  
inner join icstockbill t4 on t3.finterid=t4.finterid  
inner join t_icitem t5 on t5.fitemid=t3.fitemid
where year(t4.fdate)=2016  and month(t4.fdate)=3 
and t4.ftrantype=1 and isnull(t4.FVchInterID,0)=0 
and isnull(t3.fentryselfa0154,0)<>t2.fprice and t1.fcurrencyid=1

--更新外购入库单的含税单价--美金
select t1.fcurrencyid,t5.fnumber,t5.fname,t3.fsourcetrantype,cast(t2.fprice*t1.fexchangerate as decimal(24,4)),t3.fentryselfa0154,t3.fentryselfa0155,t3.fprice,t3.famount,t2.fprice,t2.famount
--update t3 set fentryselfa0154=cast(t2.fprice*t1.fexchangerate as decimal(24,4)),fentryselfa0155=cast(t2.fprice*t1.fexchangerate*t3.fqty as decimal(24,2)) 
from poorder t1  
inner join poorderentry t2 on t1.finterid=t2.finterid  
inner join icstockbillentry t3 on t3.forderinterid=t2.finterid and t3.forderentryid=t2.fentryid 
inner join icstockbill t4 on t3.finterid=t4.finterid  
inner join t_icitem t5 on t5.fitemid=t3.fitemid
where year(t4.fdate)=2016  and month(t4.fdate)=3 
and t4.ftrantype=1 and isnull(t4.FVchInterID,0)=0 
and t1.fcurrencyid=1000

--select * from t_Item_3018

--产品分级
select t6.F_136
--update t9 set F_136=177686
from t_icitem t6 
inner join t_ICItemCustom t9 on t9.fitemid=t6.fitemid
left join t_Item_3018 t4 on t6.F_136=t4.fitemid
where left(t6.fnumber,1) in ('Q')	

--外盒尺寸
select t6.F_103
--update t9 set F_103=0
from t_icitem t6 
inner join t_ICItemCustom t9 on t9.fitemid=t6.fitemid
where left(t6.fnumber,1) in ('q')	
and isnull(t6.F_103,0)<>0

--标准包装价
select t6.F_138
--update t9 set F_138=0
from t_icitem t6 
inner join t_ICItemCustom t9 on t9.fitemid=t6.fitemid
where left(t6.fnumber,1) in ('q')	
and isnull(t6.F_138,0)<>0

select * 
--delete t1
from cbCostObj t1 where fnumber not in (select fnumber from t_icitem) and fitemid not in (55,56)

select * 
--delete t1
from t_item t1 where fitemclassid=2001 and fdetail=1 and fnumber not in (select fnumber from cbCostObj) and fitemid not in (55,56) and flevel in (5)

--错位
select t0.fname,replace(replace(replace(t0.fname,char(9),' '),char(10),' '),char(13),' ')
--update t10 set fname=replace(replace(replace(t10.fname,char(9),''),char(10),''),char(13),'')
--update t0 set fname=replace(replace(replace(t0.fname,char(9),''),char(10),''),char(13),'')
--update t0 set fmodel=replace(replace(replace(t0.fmodel,char(9),''),char(10),''),char(13),'')
FROM t_ICItemCore t0
LEFT JOIN t_ICItemBase t1 ON t0.FItemID=t1.FItemID
inner join t_icitem t9 on t9.fitemid=t0.fitemid
inner join t_item t10 on t9.fitemid=t10.fitemid


--外购入库单价更新
select t6.FVchInterID,t1.*
--update t5 set fprice=t4.fprice,fauxprice=t4.fprice,famount=cast(t5.fqty*t4.fprice as decimal(24,2))
from POOrder t1 
inner JOIN poorderentry t4 ON t1.finterid=t4.finterid 
inner JOIN t_ICItem t7 ON t4.fitemid=t7.FItemID AND t7.FItemID<>0 
inner JOIN t_supplier t3 ON t3.fitemid=t1.FSupplyID AND t3.FItemID<>0 
inner Join icstockbillentry t5 on t5.forderinterid=t4.finterid and t5.forderentryid=t4.fentryid  
inner join icstockbill t6 on t6.finterid=t5.finterid 
where t6.ftrantype=1 and t6.fdate>='2015-12-01' and t1.fcurrencyid=1 and t7.fnumber not like '6%'

select t2.fprice,t3.fprice
--update t2 set fprice=t3.fprice,fauxprice=t3.fprice,famount=cast(t2.fqty*t3.fprice as decimal(24,2))
from icstockbill t1
inner join icstockbillentry t2 on t1.finterid=t2.finterid
inner join poinstockentry t3 on t2.fsourceinterid=t3.finterid and t2.fsourceentryid=t3.fentryid and t2.fsourcetrantype=72
inner join poinstock t4 on t3.finterid=t4.finterid
inner JOIN t_ICItem t7 ON t2.fitemid=t7.FItemID AND t7.FItemID<>0 
where t1.ftrantype=1 and t1.fdate>='2015-12-01' and t7.fnumber like '6%'



--重新导入傲威
select t1.fshortnumber 短代码,t1.fnumber 长代码,t1.fname 产品名称,t3.ffullname 全称,t1.fmodel 规格型号,
replace(convert(varchar(10),isnull(t2.flastmoddate,t2.fcreatedate),111),'/','-') 修改日期,isnull(t4.fname,'') 审核人
--update t2 set flastmoddate='2015-12-14'
from t_icitem t1
inner join t_baseproperty t2 on t1.fitemid=t2.fitemid
inner join t_item t3 on t3.fitemid=t1.fitemid
inner join t_user t4 on t4.fuserid=t3.FChkUserID and t4.fuserid<>0
inner join icbom t5 on t5.fitemid=t1.fitemid and t5.fstatus>0
where isnull(t3.FChkUserID,0)>0 and left(t1.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0)
and left(t1.fnumber,4) in('v.b.')

select t1.fpiecerate
--update t1 set fpiecerate=0.35
from t_ICItemStandard t1
inner join t_icitem t2 on t1.fitemid=t2.fitemid
where left(t2.fnumber,1) in ('A','P','J','X','Y','V')
and isnull(t1.fpiecerate,0)<>0.35

--无标准人工的半成品
select distinct t1.fnumber,t1.fname,t1.fmodel 
from t_icitem t1
inner join icbomchild t2 on t1.fitemid=t2.fitemid
inner join icbom t3 on t2.finterid=t3.finterid
inner join t_icitem t4 on t4.fitemid=t3.fitemid --成品
where left(t1.fnumber,1) in ('3','4','5') and t1.fpiecerate=0 and t1.fdeleted=0 
and t4.fdeleted=0 and t4.fname not like '%禁用%'
order by t1.fnumber


--无产品分级的成品
select distinct t1.fnumber,t1.fname,t1.fmodel 
from t_icitem t1
inner join icbom t2 on t1.fitemid=t2.fitemid
where isnull(t1.f_126,0)=40019 and t1.fname not like '%禁用%' and t2.fstatus>0 and t1.fdeleted=0 
and isnull(t1.F_136,0)=0
order by t1.fnumber


select distinct t1.fnumber,t1.fname,t1.fmodel , t6.fnumber,t6.fname,t6.fmodel 
from t_icitem t1
inner join icbom t2 on t1.fitemid=t2.fitemid
inner join icbomchild t5 on t2.finterid=t5.finterid
inner join t_icitem t6 on t5.fitemid=t6.fitemid
where isnull(t1.f_126,0)=40019 and t1.fname not like '%禁用%' and t2.fstatus>0 and t1.fdeleted=0 
and isnull(t1.F_136,0)=0 and left(t6.fnumber,1) in ('3','4','5','7','8')
order by t1.fnumber

-------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------


select t1.fprice,t1.ftaxprice,cast(t1.ftaxprice/(1+isnull(t3.f_103,0)/100) as decimal(24,4)),t2.fnumber,t2.fname
--update t1 set fprice=cast(t1.ftaxprice/(1+isnull(t3.f_103,0)/100) as decimal(24,4))
from t_supplyentry t1
inner join t_icitem t2 on t1.fitemid=t2.fitemid
inner join t_supplier t3 on t1.fsupid=t3.fitemid
--where left(t2.fnumber,1) in ('7','8')

--采购单价
select t4.fitemid,(case when t5.fcyid=1000 then t5.fprice*t1.fexchangerate else t5.fprice end) fprice
into #temp --
from (select fitemid,max(fentryid) fentryid from (select t1.fitemid,t1.fentryid from t_supplyentry t1 inner join (select fitemid,max(FQuoteTime) FQuoteTime from t_SupplyEntry group by fitemid) t2 on t1.fitemid=t2.fitemid and t1.FQuoteTime=t2.FQuoteTime) t1 group by fitemid) t4 
inner join t_supplyentry t5 on t4.fitemid=t5.fitemid and t4.fentryid=t5.fentryid
inner join t_currency t1 on t1.fcurrencyid=t5.fcyid

insert into #temp(fitemid,fprice)
select            fitemid,fprice
from
(
	select t1.fitemid,max(t1.fprice) fprice
	from icstockbillentry t1
	inner join 
	(
		select t2.fitemid,max(t1.finterid) finterid
		from icstockbill t1
		inner join icstockbillentry t2 on t1.finterid=t2.finterid
		inner join t_icitem t3 on t2.fitemid=t3.fitemid 
		where t1.ftrantype in (1,2,10,29) and t2.fprice>0 and left(t3.fnumber,1) not in (select fitemtype from v_myitemtype where ftype=0)
		and t3.fnumber not like '6.%'
		group by t2.fitemid
	) t2 on t1.finterid=t2.finterid
	group by t1.fitemid
) t1 where t1.fitemid not in (select fitemid from #temp)

----人民币销量--非价格哦引擎的要转换成价格引擎
--select t2.fengineid fitemid,sum(t2.fqty) fqty,sum(t2.famount) famount into #sale1
--from
--(
--	select t1.fcurrencyid,t2.fitemid,(case when isnull(t3.F_126,0)=40019 then t3.fitemid when isnull(t3.F_126,0)<>40019 and isnull(t3.F_127,0)=0 then t3.fitemid else isnull(t3.F_127,0) end) fengineid,t2.fqty,t2.famount
--	from icsale t1
--	inner join icsaleentry t2 on t1.finterid=t2.finterid
--	inner join t_icitem t3 on t3.fitemid=t2.fitemid
--	where t1.fdate>='2015-01-01' and t1.fdate<='2015-11-30' and left(t3.fnumber,1) in ('A','P','J','X','Y','V')
--	--and t1.fcustid in (123,16708)
--	and t1.fcurrencyid=1 and t2.fqty>0
--) t2 group by t2.fengineid


----美金销量
--select t2.fengineid fitemid,sum(t2.fqty) fqty,sum(t2.famount) famount into #sale1000
--from
--(
--	select t1.fcurrencyid,t2.fitemid,(case when isnull(t3.F_126,0)=40019 then t3.fitemid when isnull(t3.F_126,0)<>40019 and isnull(t3.F_127,0)=0 then t3.fitemid else isnull(t3.F_127,0) end) fengineid,t2.fqty,t2.famount
--	from icsale t1
--	inner join icsaleentry t2 on t1.finterid=t2.finterid
--	inner join t_icitem t3 on t3.fitemid=t2.fitemid
--	where t1.fdate>='2015-01-01' and t1.fdate<='2015-11-30' and left(t3.fnumber,1) in ('A','P','J','X','Y','V')
--	--and t1.fcustid in (123,16708)
--	and t1.fcurrencyid=1000 and t2.fqty>0
--) t2 group by t2.fengineid

select t3.fitemid,t3.fnumber 产品编码,t3.fname 产品名称,t3.fmodel 规格型号,isnull(t3.f_105,'') 描述,--isnull(t3.F_106,'') 适用机型,--(case when t3.F_126=40019 then t3.fitemid else isnull(t3.F_127,0) end) fengineid
t4.fitemid fchilditemid,t4.fnumber 半成品编码,t4.fname 半成品名称,(case when isnull(t4.fmodel,'')='' then '///' else t4.fmodel end) 半成品规格型号,
--isnull(t11.fname,'') 结算类别,cast(isnull(t11.f_101,0) as decimal(24,2)) 系数,
cast(t3.F_138 as decimal(24,2)) 标准彩盒费,cast(0.0000 as decimal(24,4)) 最新材料成本,
(case when Charindex('高配',t3.fname,1)>0 then 0.93 else 0.95 end) 结算系数,
t13.fname 外盒尺寸, --cast(t12.F_103 as decimal(24,2)) 标准彩盒费,
--isnull(t2.fqty,0) 人民币数量,isnull(t2.famount,0) 人民币金额,isnull(t5.fqty,0) 美金数量,isnull(t5.famount,0) 美金金额,
(case when t1.fbanqty>1 then 'Y' else '' end) 套装,
cast(0.0000 as decimal(24,4)) 半成品用量 --,cast(0.0000 as decimal(24,4)) favgmaterialcost,cast('' as varchar(50)) fiscomplete
into #data
from
(
	select fitemid,max(fbanitemid) fbanitemid,max(fxinitemid) fxinitemid,isnull(sum(fbanqty),0) fbanqty
	from
	(
		select t1.fitemid,
		case when left(t4.fnumber,1) in ('3','4','5','7','8') then t4.fitemid else 0 end fbanitemid,
		case when left(t4.fnumber,1) in ('3','4','5','7','8') then 1 else 0 end fbanqty,
		case when left(t4.fnumber,10) in ('1.01.0010.') then t4.fitemid else 0 end fxinitemid
		from t_icitem t1
		inner join icbom t2 on t1.fitemid=t2.fitemid
		inner join icbomchild t3 on t2.finterid=t3.finterid
		inner join t_icitem t4 on t3.fitemid=t4.fitemid
		where isnull(t1.f_126,0)=40019 and t1.fname not like '%禁用%' and t2.fstatus>0 and t1.fdeleted=0 --left(t1.fnumber,4) in ('a.01','p.01','j.01','x.01','y.01')
	) t1 group by t1.fitemid
) t1 inner join t_ICItem t3 on t3.fitemid=t1.fitemid
inner join t_ICItem t4 on t4.fitemid=t1.fbanitemid
left join t_item t13 on t13.fitemid=t3.F_103 and t13.fitemclassid=3004  --外盒尺寸
left join t_item_3005 t11 on t11.fitemid=t3.F_104 --and t11.fitemclassid=3005  --结算类别
left join t_Item_3012 t12 on t3.F_103=t12.F_102 and t12.fname like '%彩盒%' --and 
--left join #sale1 t2 on t2.fitemid=t1.fitemid
--left join #sale1000 t5 on t5.fitemid=t1.fitemid
where isnull(t3.f_126,0)=40019 --是价格引擎的
order by t3.fnumber


--成品
update t4 set 最新材料成本=t2.fprice
--select t3.fnumber 产品编码,t3.fname 产品名称,t3.fmodel 产品规格型号,t2.fprice 单位成本
from t_ICItemMaterial t1
inner join 
(
	select t1.fitemid,sum(fprice) fprice
	from
	(
		select t2.fitemid,(t3.fqty*t5.fprice) fprice
		from t_icitem t1
		inner join icbom t2 on t1.fitemid=t2.fitemid --and t2.fstatus>0
		inner join icbomchild t3 on t2.finterid=t3.finterid
		inner join #temp t5 on t5.fitemid=t3.fitemid
		inner join t_icitem t6 on t6.fitemid=t3.fitemid
		where left(t6.fnumber,1) not in ('3','4','5') --and t1.ferpclsid=2 
		and t1.fitemid in (select fitemid from #data) and left(t1.fnumber,1) in ('A', 'J', 'P', 'Q', 'R', 'V', 'X', 'Y')
		and t6.fdefaultloc<>16483  --
		union all
		select t2.fitemid,(t3.fqty*t12.fqty*t5.fprice) fprice
		from t_icitem t1
		inner join icbom t2 on t1.fitemid=t2.fitemid --and t2.fstatus>0 --成品
		inner join icbomchild t3 on t2.finterid=t3.finterid  --半成品
		inner join icbom t11 on t11.fitemid=t3.fitemid  --半成品
		inner join icbomchild t12 on t11.finterid=t12.finterid  --半成品子项
		inner join #temp t5 on t5.fitemid=t12.fitemid
		inner join t_icitem t6 on t6.fitemid=t3.fitemid --半成品
		inner join t_icitem t7 on t7.fitemid=t2.fitemid --成品
		inner join t_icitem t8 on t8.fitemid=t12.fitemid --半成品子项
		where left(t6.fnumber,1) in ('3','4') --and t1.ferpclsid=2
		and t1.fitemid in (select fitemid from #data) and left(t1.fnumber,1) in ('A', 'J', 'P', 'Q', 'R', 'V', 'X', 'Y')
		union all
		select t2.fitemid,(t3.fqty*t12.fqty*t5.fprice) fprice
		from t_icitem t1
		inner join icbom t2 on t1.fitemid=t2.fitemid --and t2.fstatus>0 --成品
		inner join icbomchild t3 on t2.finterid=t3.finterid  --半成品
		inner join icbom t11 on t11.fitemid=t3.fitemid  --半成品
		inner join icbomchild t12 on t11.finterid=t12.finterid  --半成品子项
		inner join #temp t5 on t5.fitemid=t12.fitemid
		inner join t_icitem t6 on t6.fitemid=t3.fitemid --半成品
		inner join t_icitem t7 on t7.fitemid=t2.fitemid --成品
		inner join t_icitem t8 on t8.fitemid=t12.fitemid --半成品子项
		where left(t6.fnumber,1) in ('5') and t8.fname not like '回收件%' --and t1.ferpclsid=2
		and t1.fitemid in (select fitemid from #data) and left(t1.fnumber,1) in ('A', 'J', 'P', 'Q', 'R', 'V', 'X', 'Y')
		union all
		select t2.fitemid,(t3.fqty*t5.fprice) fprice
		from t_icitem t1
		inner join icbom t2 on t1.fitemid=t2.fitemid --and t2.fstatus>0 --成品
		inner join icbomchild t3 on t2.finterid=t3.finterid  --半成品
		inner join icbom t11 on t11.fitemid=t3.fitemid  --半成品
		inner join (
-- 			select distinct t1.fitemid,(select top 1 fitemid from t_icitem where fparentid=t1.fparentid and fname like '%拆盒%' ) fchiheitemid
-- 			from t_icitem t1
-- 			inner join icbomchild t2 on t1.fitemid=t2.fitemid
-- 			where t1.fnumber like '5.%' and t1.fname not like '%拆盒%'
			select distinct t1.fitemid,
			(
				select top 1 m4.fitemid 
				from t_icitem m1 
				inner join icbomchild m2 on m1.fitemid=m2.fitemid
				inner join icbom m3 on m2.finterid=m3.finterid
				inner join t_icitem m4 on m3.fitemid=m4.fitemid
				where m4.fnumber like '5.%' and m4.fname like '%拆盒%' and m1.fitemid=t5.fitemid 
			) fchiheitemid
			from t_icitem t1
			inner join icbomchild t2 on t1.fitemid=t2.fitemid
			inner join icbom t3 on t1.fitemid=t3.fitemid
			inner join icbomchild t4 on t4.finterid=t3.finterid
			inner join t_icitem t5 on t5.fitemid=t4.fitemid
			where t1.fnumber like '5.%' and t1.fname not like '%拆盒%' and t5.fnumber like '1.02.%'
		) t12 on t11.fitemid=t12.fitemid --半成品同级回收壳
		inner join t_icitem t6 on t6.fitemid=t3.fitemid --半成品
		inner join t_icitem t7 on t7.fitemid=t2.fitemid --成品
		inner join t_icitem t8 on t8.fitemid=t12.fchiheitemid --半成品同级回收壳
		inner join #temp t5 on t5.fitemid=t8.fitemid
		where left(t6.fnumber,1) in ('5') --and t1.ferpclsid=2
		and t1.fitemid in (select fitemid from #data) and left(t1.fnumber,1) in ('A', 'J', 'P', 'Q', 'R', 'V', 'X', 'Y')
	) t1 group by t1.fitemid
) t2 on t1.fitemid=t2.fitemid
inner join t_icitem t3 on t3.fitemid=t1.fitemid
inner join #data t4 on t4.fitemid=t1.fitemid


select t1.产品编码,t1.产品名称,t1.规格型号,t1.描述,t1.半成品编码,t1.半成品名称,t1.半成品规格型号,
t1.标准彩盒费,t1.最新材料成本,t1.结算系数,t1.外盒尺寸,t1.套装,t1.半成品用量 
from #data t1
where t1.套装=''
union all
select t1.产品编码,t1.产品名称,t1.规格型号,t1.描述,t4.fnumber 半成品编码,t4.fname 半成品名称,(case when isnull(t4.fmodel,'')='' then '///' else t4.fmodel end) 半成品规格型号,
t1.标准彩盒费,t1.最新材料成本,t1.结算系数,t1.外盒尺寸,t1.套装,t3.fqty 半成品用量 
from #data t1
inner join icbom t2 on t1.fitemid=t2.fitemid
inner join icbomchild t3 on t2.finterid=t3.finterid
inner join t_icitem t4 on t4.fitemid=t3.fitemid and t1.fchilditemid=t4.fitemid 
where t1.套装='Y' 
union all
select t1.产品编码,t1.产品名称,t1.规格型号,t1.描述,t4.fnumber 半成品编码,t4.fname 半成品名称,(case when isnull(t4.fmodel,'')='' then '///' else t4.fmodel end) 半成品规格型号,
0 标准彩盒费,0 最新材料成本,0 结算系数,''外盒尺寸,t1.套装,t3.fqty 半成品用量 
from #data t1
inner join icbom t2 on t1.fitemid=t2.fitemid
inner join icbomchild t3 on t2.finterid=t3.finterid
inner join t_icitem t4 on t4.fitemid=t3.fitemid and t1.fchilditemid<>t4.fitemid and left(t4.fnumber,1) in ('3','4','5','7','8')
where t1.套装='Y' 
order by 产品编码,最新材料成本 desc

--drop table #temp  --drop table #data  --drop table #sale1000  --drop table #sale1
---------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------

--能找到
select t3.fnumber,t3.fname,t3.fmodel,t4.fnumber,t4.fname,t4.fmodel
--update t12 set F_126=40020,F_127=t2.fitemid
from
(
	select fitemid,max(fbanitemid) fbanitemid,isnull(max(fxinitemid),0) fxinitemid from
	(
		select t1.fitemid,
		case when left(t4.fnumber,1) in ('3','4','5','7','8') then t4.fitemid else 0 end fbanitemid,
		case when left(t4.fnumber,10) in ('1.01.0010.') then t4.fitemid else 0 end fxinitemid
		from t_icitem t1
		inner join icbom t2 on t1.fitemid=t2.fitemid
		inner join icbomchild t3 on t2.finterid=t3.finterid
		inner join t_icitem t4 on t3.fitemid=t4.fitemid
		where t1.fname not like '%禁用%' and t1.fdeleted=0 
		and left(t1.fnumber,4) not in ('A.01','P.01','J.01','X.01','Y.01') 
		and left(t1.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0)
	) t1 group by t1.fitemid
) t1 inner join
(
	select fitemid,max(fbanitemid) fbanitemid,isnull(max(fxinitemid),0) fxinitemid from
	(
		select t1.fitemid,
		case when left(t4.fnumber,1) in ('3','4','5','7','8') then t4.fitemid else 0 end fbanitemid,
		case when left(t4.fnumber,10) in ('1.01.0010.') then t4.fitemid else 0 end fxinitemid
		from t_icitem t1
		inner join icbom t2 on t1.fitemid=t2.fitemid
		inner join icbomchild t3 on t2.finterid=t3.finterid
		inner join t_icitem t4 on t3.fitemid=t4.fitemid
		where t1.fname not like '%禁用%' and t1.fdeleted=0 
		and left(t1.fnumber,4) in ('A.01','P.01','J.01','X.01','Y.01') 
	) t1 group by t1.fitemid
) t2 on t1.fbanitemid=t2.fbanitemid and t1.fxinitemid=t2.fxinitemid
inner join t_ICItemCustom t12 on t1.fitemid=t12.fitemid
inner join t_icitem t3 on t3.fitemid=t1.fitemid
inner join t_icitem t4 on t4.fitemid=t2.fitemid
where isnull(t12.F_127,0)<>t2.fitemid


--找不到
select t3.fnumber,t3.fname,t3.fmodel,t4.fnumber,t4.fname,t4.fmodel
--update t12 set F_126=40019,F_127=0
from
(
	select fitemid,max(fbanitemid) fbanitemid,isnull(max(fxinitemid),0) fxinitemid from
	(
		select t1.fitemid,
		case when left(t4.fnumber,1) in ('3','4','5','7','8') then t4.fitemid else 0 end fbanitemid,
		case when left(t4.fnumber,10) in ('1.01.0010.') then t4.fitemid else 0 end fxinitemid
		from t_icitem t1
		inner join icbom t2 on t1.fitemid=t2.fitemid
		inner join icbomchild t3 on t2.finterid=t3.finterid
		inner join t_icitem t4 on t3.fitemid=t4.fitemid
		where t1.fname not like '%禁用%' and t1.fdeleted=0 
		and left(t1.fnumber,1) in ('v') 
		and left(t1.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0)
	) t1 group by t1.fitemid
) t1 left join
(
	select fitemid,max(fbanitemid) fbanitemid,isnull(max(fxinitemid),0) fxinitemid from
	(
		select t1.fitemid,
		case when left(t4.fnumber,1) in ('3','4','5','7','8') then t4.fitemid else 0 end fbanitemid,
		case when left(t4.fnumber,10) in ('1.01.0010.') then t4.fitemid else 0 end fxinitemid
		from t_icitem t1
		inner join icbom t2 on t1.fitemid=t2.fitemid
		inner join icbomchild t3 on t2.finterid=t3.finterid
		inner join t_icitem t4 on t3.fitemid=t4.fitemid
		where t1.fname not like '%禁用%' and t1.fdeleted=0 
		and left(t1.fnumber,4) in ('A.01','P.01','J.01','X.01','Y.01') 
	) t1 group by t1.fitemid
) t2 on t1.fbanitemid=t2.fbanitemid and t1.fxinitemid=t2.fxinitemid
inner join t_ICItemCustom t12 on t1.fitemid=t12.fitemid
inner join t_icitem t3 on t3.fitemid=t1.fitemid
left join t_icitem t4 on t4.fitemid=t2.fitemid
where t2.fitemid is null

--套装
select t3.fnumber,t3.fname,t3.fmodel
--update t12 set F_126=40019,F_127=0
from
(
	select fitemid from
	(
		select t1.fitemid,t1.fnumber,t1.fname
		from t_icitem t1
		inner join icbom t2 on t1.fitemid=t2.fitemid
		inner join icbomchild t3 on t2.finterid=t3.finterid
		inner join t_icitem t4 on t3.fitemid=t4.fitemid
		where t1.fname not like '%禁用%' and t1.fdeleted=0 
		and left(t1.fnumber,1) in ('v') and left(t4.fnumber,1) in ('3','4','5','7','8')
	) t1 group by t1.fitemid
	having count(1)>1
) t1 inner join t_ICItemCustom t12 on t1.fitemid=t12.fitemid
inner join t_icitem t3 on t3.fitemid=t1.fitemid


select t2.fnote,t4.fremark
--update t4 set fremark=t2.fnote
from poorder t1
inner join poorderentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid  --套件
inner join t_BOSPlasticPoInStockEntry t4 on t4.FID_SRC=t2.finterid 
where t3.fnumber like '1.02.%' and t2.fnote<>''

select t3.fnote,t5.fremark
--update t3 set fnote=t5.fremark
from poinstockentry t3 
inner join poinstock t4 on t3.finterid=t4.finterid
inner join t_bosPlasticPoInStockEntry t5 on t5.fid=t3.fsourceinterid and t5.fentryid=t3.fsourceentryid and t3.fsourcetrantype=200000022
inner join t_bosPlasticPoInStock t6 on t6.fid=t5.fid
where t5.fremark<>''

--子件外购入库单审核时，自动更新子件收料申请单的[关联入库数]
--子件收料通知单，系统自带功能会更新子件收料申请单的[关联数]和[未关联数]，退料通知单则不能回写负数，用触发器处理

--半成品不一致
select fitemid,max(fbanitemid) fbanitemid,max(fxinitemid) fxinitemid into #data
from
(
	select t1.fitemid,
	case when left(t4.fnumber,1) in ('3','4','5','7','8') then t4.fitemid else 0 end fbanitemid,
	case when left(t4.fnumber,10) in ('1.01.0010.') then t4.fitemid else 0 end fxinitemid
	from t_icitem t1
	inner join icbom t2 on t1.fitemid=t2.fitemid
	inner join icbomchild t3 on t2.finterid=t3.finterid
	inner join t_icitem t4 on t3.fitemid=t4.fitemid
	where t1.fname not like '%禁用%' and t1.fdeleted=0 and left(t1.fnumber,1) in ('a','p','j','x','y','v')
) t1 group by t1.fitemid

--与引擎不一致
select t1.fnumber 编码,t1.fname 名称,t1.fmodel 规格型号,
t23.fnumber 半成品编码,t23.fname 半成品名称,(case when isnull(t23.fmodel,'')='' then '///' else t23.fmodel end) 半成品规格型号,
isnull(t11.fnumber,'') 引擎编码,t11.fname 引擎名称,t11.fmodel 引擎规格型号,  --isnull(t12.fname,'') 是否引擎,
t24.fnumber 引擎半成品编码,t24.fname 引擎半成品名称,(case when isnull(t24.fmodel,'')='' then '///'  else t24.fmodel end) 引擎半成品规格型号
from t_icitem t1 
inner join t_ICItemCustom t3 on t1.fitemid=t3.fitemid
left join t_submessage t4 on t1.f_128=t4.finterid
inner join t_icitem t11 on t11.fitemid=t1.f_127  --引擎
left join t_submessage t12 on t12.finterid=t1.f_126
left join icbom t13 on t13.fitemid=t1.fitemid
left join t_submessage t14 on t14.finterid=t13.fheadselfz0134
inner join #data t21 on t21.fitemid=t1.fitemid 
inner join #data t22 on t22.fitemid=t11.fitemid --引擎
inner join t_icitem t23 on t23.fitemid=t21.fbanitemid 
inner join t_icitem t24 on t24.fitemid=t22.fbanitemid and t23.fitemid<>t24.fitemid --引擎
WHERE (left(t1.fnumber,1) in ('a','p','j','x','y') or t1.fnumber like 'v.b.%') and isnull(t1.f_126,0)<>40019 
order by t1.fnumber,t11.fnumber

--在傲威中性中找不到对应的[半成品+芯片]信息

select distinct t1.fnumber 编码,t1.fname 名称,t1.fmodel 规格型号,isnull(t12.fname,'') 是否引擎,
t23.fnumber 半成品编码,t23.fname 半成品名称,(case when isnull(t23.fmodel,'')='' then '///' else t23.fmodel end) 半成品规格型号, 
isnull(t24.fnumber,'') 芯片编码,isnull(t24.fname,'') 芯片名称,(case when isnull(t24.fmodel,'')='' then '///' else t24.fmodel end) 芯片规格型号
from t_icitem t1 
left join t_submessage t12 on t12.finterid=t1.f_126
inner join #data t21 on t21.fitemid=t1.fitemid 
inner join t_icitem t23 on t23.fitemid=t21.fbanitemid 
left join t_icitem t24 on t24.fitemid=t21.fxinitemid
left join
(
	select cast(t22.fbanitemid as varchar(50))+'///'+cast(isnull(t22.fxinitemid,0) as varchar(50)) fflag
	from #data t22
	inner join t_icitem t5 on t5.fitemid=t22.fitemid
	where left(t5.fnumber,4) in ('A.01','P.01','J.01','X.01','Y.01')
) t6 on t6.fflag=cast(t21.fbanitemid as varchar(50))+'///'+cast(isnull(t21.fxinitemid,0) as varchar(50))
WHERE left(t1.fnumber,1) in ('a','p','j','x','y','v') and left(t1.fnumber,4) not in ('A.01','P.01','J.01','X.01','Y.01')
and t6.fflag is null --and t1.fnumber like '%X00629%'
and isnull(t1.f_126,0)<>40019 --价格引擎排除掉

order by t1.fnumber

--半成品+芯片重复
select t1.fnumber 编码,t1.fname 名称,t1.fmodel 规格型号,isnull(t12.fname,'') 是否引擎,
t23.fnumber 半成品编码,t23.fname 半成品名称,(case when isnull(t23.fmodel,'')='' then '///' else t23.fmodel end) 半成品规格型号, 
isnull(t24.fnumber,'') 芯片编码,isnull(t24.fname,'') 芯片名称,(case when isnull(t24.fmodel,'')='' then '///' else t24.fmodel end) 芯片规格型号
from t_icitem t1 
left join t_submessage t12 on t12.finterid=t1.f_126
inner join #data t21 on t21.fitemid=t1.fitemid 
inner join t_icitem t23 on t23.fitemid=t21.fbanitemid 
left join t_icitem t24 on t24.fitemid=t21.fxinitemid
inner join
(
	select cast(t22.fbanitemid as varchar(50))+'///'+cast(isnull(t22.fxinitemid,0) as varchar(50)) fflag
	from #data t22
	inner join t_icitem t5 on t5.fitemid=t22.fitemid
	where left(t5.fnumber,4) in ('A.01','P.01','J.01','X.01','Y.01')
	group by cast(t22.fbanitemid as varchar(50))+'///'+cast(isnull(t22.fxinitemid,0)as varchar(50))
	having count(1)>1
) t6 on t6.fflag=cast(t21.fbanitemid as varchar(50))+'///'+cast(isnull(t21.fxinitemid,0) as varchar(50))
WHERE left(t1.fnumber,4) in ('A.01','P.01','J.01','X.01','Y.01')
--left(t1.fnumber,1) in ('a','p','j','x','y','v') and 
--and t6.fflag is null and isnull(t1.f_126,0)<>40019 
order by cast(t21.fbanitemid as varchar(50))+'///'+cast(isnull(t21.fxinitemid,0) as varchar(50)),t1.fnumber

--高配标配混用
select t1.fnumber 编码,t1.fname 名称,t1.fmodel 规格型号,isnull(t12.fname,'') 是否引擎,
t23.fnumber 半成品编码,t23.fname 半成品名称,(case when isnull(t23.fmodel,'')='' then '///' else t23.fmodel end) 半成品规格型号, 
isnull(t24.fnumber,'') 芯片编码,isnull(t24.fname,'') 芯片名称,(case when isnull(t24.fmodel,'')='' then '///' else t24.fmodel end) 芯片规格型号
from t_icitem t1 
left join t_submessage t12 on t12.finterid=t1.f_126
inner join #data t21 on t21.fitemid=t1.fitemid 
inner join t_icitem t23 on t23.fitemid=t21.fbanitemid 
left join t_icitem t24 on t24.fitemid=t21.fxinitemid
where (t1.fname like '%高配%' and t23.fname not like '%高配%') or (t23.fname like '%高配%' and t1.fname not like '%高配%')
order by t1.fnumber

--全部
select t1.fnumber 编码,t1.fname 名称,t1.fmodel 规格型号,isnull(t12.fname,'') 是否引擎,
t23.fnumber 半成品编码,t23.fname 半成品名称,(case when isnull(t23.fmodel,'')='' then '///' else t23.fmodel end) 半成品规格型号, 
isnull(t24.fnumber,'') 芯片编码,isnull(t24.fname,'') 芯片名称,(case when isnull(t24.fmodel,'')='' then '///' else t24.fmodel end) 芯片规格型号
from t_icitem t1 
left join t_submessage t12 on t12.finterid=t1.f_126
inner join #data t21 on t21.fitemid=t1.fitemid 
inner join t_icitem t23 on t23.fitemid=t21.fbanitemid 
left join t_icitem t24 on t24.fitemid=t21.fxinitemid
where t1.fnumber like '%A00003%' --and (t1.fname like '%高配%' and t23.fname not like '%高配%') or (t23.fname like '%高配%' and t1.fname not like '%高配%')
order by t1.fnumber


select sum(t2.fqty)
from icstockbill t1
inner join icstockbillentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
where left(t3.fnumber,1) in ('a','p','x','y','j','v') and t1.ftrantype=21 and t1.fdate>='2015-08-01' and t1.fdate<='2015-08-31'
and t2.fqty>0 and t3.fmodel like '%2612%'

select sum(t2.fqty)
from icstockbill t1
inner join icstockbillentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
where left(t3.fnumber,1) in ('a','p','x','y','j','v') and t1.ftrantype=21 and t1.fdate>='2015-08-01' and t1.fdate<='2015-08-31'
and t2.fqty>0 and (t3.fmodel like '%2612%' or t3.fmodel like '%435%' or t3.fmodel like '%436%' or t3.fmodel like '%285%'  
or t3.fmodel like '%278%' or t3.fmodel like '%fx9%' or t3.fmodel like '%fx-9%' or t3.fmodel like '%fx10%')



--select * from IcPrcPlyEntry  --frelatedid=20011

select distinct frelatedid from IcPrcPlyEntry  --frelatedid=20011

select * from IcPrcPly

select * from t_submessage where ftypeid=501 and finterid=20011


select t3.fnumber,t3.fname,t3.fmodel,t4.fnumber,t4.fname,t4.fmodel,t2.fqty
	from icbom t1
	inner join icbomchild t2 on t1.finterid=t2.finterid
	inner join t_icitem t3 on t1.fitemid=t3.fitemid
	inner join t_icitem t4 on t2.fitemid=t4.fitemid
where (t3.fname like '%HP-再生标配%' or t3.fname like '%HP-再生高配%')
and (left(t4.fnumber,1) in ('3','4','5','7','8') or t4.fnumber like '1.01.0010%')
order by t3.fnumber,t4.fnumber




select t4.fumber,t4.fname,t3.fqtymust,t3.fstockqty,(t3.fqtymust-t3.fstockqty)
--update t3 set fstockqty=20,fauxstockqty=20
from icmo t5 
inner join ppbom t2 on t5.finterid=t2.ficmointerid
inner join ppbomentry t3 on t2.finterid=t3.finterid
inner join t_icitem t4 on t3.fitemid=t4.fitemid --子项
inner join t_icitem t8 on t5.fitemid=t8.fitemid --父项
where t5.fbillno='WORK045030-1' and t4.fshortnumber='001446' -- and --t5.fstatus in (1,2,5) and (t3.fqtymust-t3.fstockqty)>0 

select t4.fumber,t4.fname,t3.fqtymust,t3.fstockqty,(t3.fqtymust-t3.fstockqty)
--update t3 set fstockqty=180,fauxstockqty=180
from icmo t5 
inner join ppbom t2 on t5.finterid=t2.ficmointerid
inner join ppbomentry t3 on t2.finterid=t3.finterid
inner join t_icitem t4 on t3.fitemid=t4.fitemid --子项
inner join t_icitem t8 on t5.fitemid=t8.fitemid --父项
where t5.fbillno='WORK045030-2' and t4.fshortnumber='001446' -- and --t5.fstatus in (1,2,5) and (t3.fqtymust-t3.fstockqty)>0 

select t4.fumber,t4.fname,t3.fqtymust,t3.fstockqty,(t3.fqtymust-t3.fstockqty)
--update t3 set fstockqty=40,fauxstockqty=40
from icmo t5 
inner join ppbom t2 on t5.finterid=t2.ficmointerid
inner join ppbomentry t3 on t2.finterid=t3.finterid
inner join t_icitem t4 on t3.fitemid=t4.fitemid --子项
inner join t_icitem t8 on t5.fitemid=t8.fitemid --父项
where t5.fbillno='WORK045030-3' and t4.fshortnumber='001446' -- and --t5.fstatus in (1,2,5) and (t3.fqtymust-t3.fstockqty)>0 

--修改日志、回车即查询--delete from t_subsItem

declare @fmaxnum int,@fdate datetime,@fmaxbill int,@fmaxbillno varchar

set @fmaxnum=1000
select @fmaxnum=fmaxnum from icmaxnum where ftablename='t_subsItem'

--select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')
--select @fmaxbill=cast(max(right(FBomNumber,6)) as int) from icbom where FBomNumber like 'BOM%'

create table #mybom(fid int identity(1,1),fproductid int,fitemid int,frepitemid int,forder int)

insert into #mybom(fproductid,   fitemid,   frepitemid    ,forder)
select distinct    t1.fproductid,t2.fitemid,t2.frepitemid ,t2.forder
from t_BOSICItemReplace t1 
inner join t_BOSICItemReplaceEntry t2 on t1.fid=t2.fid
where isnull(t1.fproductid,0)=0

insert into #mybom(fproductid,   fitemid,   frepitemid ,   forder)
select distinct    t1.fproductid,t2.fitemid,t2.frepitemid ,t2.forder
from t_BOSICItemReplace t1 
inner join t_BOSICItemReplaceEntry t2 on t1.fid=t2.fid
inner join icbom t3 on t3.fitemid=t1.fproductid
where isnull(t1.fproductid,0)<>0 
and not exists(select 1 from #mybom where fitemid=t2.fitemid and frepitemid=t2.frepitemid)

Insert Into t_subsItem   (FInterID,       FItemID,   FSubsItemID,   FOrder,   FapplicableItem ,FapplicableBOM,       Frate,FsubsRate,FeachOther,Fnote,FPriorityID,FEnabledDate,FDisabledDate)  
select                    @fmaxnum+t1.fid,t1.fitemid,t1.frepitemid ,t1.forder,t1.fproductid,   isnull(t2.finterid,0),1,    1,        0,         '',   1,          '1900-01-01','9999-01-01'
from #mybom t1
left join icbom t2 on t1.fproductid=t2.fitemid
order by t1.fid


update icmaxnum set fmaxnum=(select max(FInterID) from t_subsItem) where ftablename='t_subsItem'

drop table #mybom  --truncate table t_subsItem

-------------------------------------------------------------------------
select t3.fnumber 厂商编码,isnull(t3.fname,'') 厂商名称,
t2.fnumber 物料编码,t2.fname 名称,
t2.fmodel 规格型号,isnull(t2.f_105,'') 描述,t4.fname 币别,t1.fprice 单价,t1.ftaxprice 含税单价,FQuoteTime 报价日期
from t_supplyentry t1
inner join t_icitem t2 on t1.fitemid=t2.fitemid
inner join t_supplier t3 on t3.fitemid=t1.fsupid
inner join t_currency t4 on t4.fcurrencyid=t1.fcyid
order by t3.fnumber,t2.fnumber

select t1.fnumber 编码,t1.fname 名称,t1.fmodel 规格型号,isnull(t5.fprice,0) 售价,isnull(t4.fname,t14.fname) 项目经理,
isnull(t12.fname,'') 是否引擎,isnull(t11.fnumber,'') 引擎编码,isnull(t11.fname,'') 引擎名称,isnull(t11.fmodel,'') 引擎规格型号,
isnull(t2.fprice,0) 引擎售价
from t_icitem t1 
inner join t_ICItemCustom t3 on t1.fitemid=t3.fitemid
left join t_submessage t4 on t1.f_128=t4.finterid
left join t_icitem t11 on t11.fitemid=t1.f_127
left join t_submessage t12 on t12.finterid=t1.f_126
left join icbom t13 on t13.fitemid=t1.fitemid
left join t_submessage t14 on t14.finterid=t13.fheadselfz0134
left join IcPrcPlyEntry t2 on t2.fitemid=t11.fitemid and t2.frelatedid=20011
left join IcPrcPlyEntry t5 on t5.fitemid=t1.fitemid and t5.frelatedid=20011
WHERE t1.fnumber like '%vb03982%'

select t6.fbillno,t6.FHeadSelfS0148,t5.fdate,t4.fnumber,t4.fname,t1.fqty,isnull(t1.fstockqty,0) fstockqty,isnull(t2.fplanqty,0) fplanqty,
isnull(t3.FQtyFinish,0) FQtyFinish,t1.*
from icmo t1 
Left Join 
( 
    select t1.fsourceinterid,sum(t1.FQtyFinish) FQtyFinish 
    from ICMORptEntry t1 
    inner join ICMORpt t2 on t1.finterid=t2.finterid 
    where t2.fheadselfj1112<'2015-04-22' 
    group by t1.fsourceinterid 
) t3 on t1.finterid=t3.fsourceinterid 
Left Join 
( 
    select ficmointerid,sum(fqty) fplanqty 
    From my_t_scheduledetail 
    where fsourcetrantype=85 and fdate>='2015-04-22' 
    group by ficmointerid 
) t2 on t1.finterid=t2.ficmointerid 
inner join t_icitem t4 on t4.fitemid=t1.fitemid
inner join seorderentry t5 on t5.finterid=t1.forderinterid and t5.fentryid=t1.fsourceentryid
inner join seorder t6 on t5.finterid=t6.finterid
where t1.fqty>isnull(t1.fstockqty,0) and t1.fstatus in (1,2,5)  and t1.forderinterid<>0 and t6.fstatus<>3
and t1.fqty<>(isnull(t2.fplanqty,0)+isnull(t3.FQtyFinish,0)) and t6.FHeadSelfS0148<>'1900-01-01'


select 1
--update t1 set FCurrencyID=t2.fcyid
from t_Supply t1
inner join t_SupplyEntry t2 on t1.fitemid=t2.fitemid and t1.fsupid=t2.FSupID
where t1.FCurrencyID<>t2.fcyid

select *
--update t1 set fmaxnum=163075
from icmaxnum t1 where ftablename='zpstockbill'

select max(finterid) from zpstockbill


--采购发票有税点导致生成凭证的问题


select * from t_itempropdesc where fitemclassid=4


--是否引擎 F_126	  产品引擎 F_127	 	--是  40019	否  40020

select 是否为引擎产品,借用产品引擎,t3.*
--update t2 set F_126=40019
from t_icitem t1
inner join t_ICItemCustom t2 on t1.fitemid=t2.fitemid
inner join engintemp$ t3 on t1.fnumber=t3.代码
where t3.是否为引擎产品='Y'

select t3.*
--update t2 set F_127=t4.fitemid
from t_icitem t1
inner join t_ICItemCustom t2 on t1.fitemid=t2.fitemid
inner join engintemp$ t3 on t1.fnumber=t3.代码
inner join t_icitem t4 on t4.fnumber=t3.借用产品引擎
where t3.是否为引擎产品 is null




--下达
select t1.*
--update t1  set Fstatus=1,FConfirmerID=16394 , FConfirmDate='2015-02-03' , FConveyerID=16394 , FCommitDate='2015-02-03'
from icmo t1
inner join seorderentry t2 on t1.forderinterid=t2.finterid and t1.fsourceentryid=t2.fentryid
inner join seorder t3 on t2.finterid=t3.finterid
where t3.fbillno like 'KW1501520' and t1.fstatus=0


-----------------------------------------------------------

select 0 fdefaultloc,t14.FInterID fbomgroupid,t4.funitid,t4.fitemid,t3.fitemid fproductid,cast(t1.用量 as decimal(24,4)) fqty
into #data
from sheet11$ t1
inner join t_icitem t3 on REVERSE(left(REVERSE(父项代码),CHARINDEX('.',REVERSE(父项代码))-1))=t3.fshortnumber --套件
inner join t_icitem t4 on REVERSE(left(REVERSE(子件代码),CHARINDEX('.',REVERSE(子件代码))-1))=t4.fshortnumber
inner join t_item t13 on t3.FParentID=t13.fitemid
inner join ICBomGroup t14 on t14.fnumber=t13.fnumber
order by t3.fnumber,t4.fnumber

--truncate table t_BOSFreezeRequest  truncate table t_BOSFreezeRequestEntry

select distinct fnumber,fname,fmodel
from
(
	select REVERSE(left(REVERSE(父项代码),CHARINDEX('.',REVERSE(父项代码))-1)) fnumber,父项名称 fname,父项规格 fmodel
	from sheet11$
	union all
	select REVERSE(left(REVERSE(子件代码),CHARINDEX('.',REVERSE(子件代码))-1)) fnumber,子件名称 fname,子件规格 fmodel
	from sheet11$
	union all
	select REVERSE(left(REVERSE(父项代码),CHARINDEX('.',REVERSE(父项代码))-1)) fnumber,父项名称 fname,父项规格 fmodel
	from sheet22$
	union all
	select REVERSE(left(REVERSE(被替代物料代码),CHARINDEX('.',REVERSE(被替代物料代码))-1)) fnumber,被替代物料名称 fname,被替代物料规格 fmodel
	from sheet22$
	union all
	select REVERSE(left(REVERSE(替代物料代码),CHARINDEX('.',REVERSE(替代物料代码))-1)) fnumber,替代物料名称 fname,替代物料规格 fmodel
	from sheet22$
) t1 where fnumber not in (select fshortnumber from t_icitem)
order by fnumber

select *
from sheet22$


--drop table #data

select distinct identity(int,1,1) findex,isnull(t16.fshortname,'') 主供应商,
isnull(t7.fitemid,0) 产品内码,isnull(t7.fnumber,'') 产品编码,isnull(t7.FName,'') 产品名称,isnull(t7.F_105,'')+'///'+ isnull(t7.fmodel,'') 规格型号,
isnull(t10.fnumber,'') 芯片编码,isnull(t10.FName,'') 芯片名称,isnull(t10.F_105,'')+'///'+ isnull(t10.fmodel,'') 芯片规格型号,
isnull(t11.fnumber,'') 半成品编码,isnull(t11.FName,'') 半成品名称,isnull(t11.F_105,'')+'///'+ isnull(t11.fmodel,'') 半成品规格型号,
isnull(t13.fnumber,'') 芯片版本编码,isnull(t13.FName,'') 芯片版本名称,
isnull(t19.fitemid,0) 包装方式内码,isnull(t19.fnumber,'') 包装方式编码,isnull(t19.FName,'') 包装方式名称
into #data
from seorder t1   
--inner join t_User t4 on t1.fbillerid=t4.fuserid and t4.fuserid<>0  
--left join t_User t5 on t1.fcheckerid=t5.fuserid and t5.fuserid<>0  
inner join SeorderEntry t12 on t1.finterid=t12.finterid  
inner join t_icitem t7 on t12.fitemid=t7.fitemid 
--left join t_Organization t2 on t1.fcustid=t2.fitemid
--inner join t_measureunit t3 on t3.fitemid=t12.funitid
--LEFT OUTER JOIN t_SubMessage t8 ON t1.FFetchStyle = t8.FInterID AND t8.FInterID <>0 
--LEFT OUTER JOIN t_Settle t14 ON t1.FSettleID = t14.FItemID AND t14.FItemID <>0 
--inner join t_currency t17 on t17.fcurrencyid=t1.fcurrencyid
--left join icbom t6 on t6.fitemid=t12.fitemid --and t6.fusestatus=1072
--left join t_item t9 on t9.fitemclassid=3002 and t9.fitemid=t12.fentryselfs0158
left join t_icitem t10 on t10.fitemid=t12.fentryselfs0161  --芯片
left join t_icitem t11 on t11.fitemid=t12.fentryselfs0164  --半成品
left join t_item t13 on t13.fitemid=t12.fentryselfs0160  --芯片版本
--left join t_submessage t15 on t12.fentryselfs0175=t15.finterid
left join t_supplier t16 on t16.fitemid=t7.F_117 --t3.fsource
--left join t_submessage t18 on t18.finterid=t1.fheadselfs0147 and t18.ftypeid=10007
inner join t_item t19 on t19.fitemclassid=3002 and t19.fitemid=t12.fentryselfs0158 and t19.fdeleted=0  --包装方式
where year(t1.fdate)=2014 and t1.FCancellation=0 and left(t7.fnumber,1) in ('A','P')  AND  
(t19.FName = '傲威中性'
  OR  
t19.FName = 'Starink2010'
  OR  
t19.FName = 'Starink2014'
  OR  
t19.FName = '鑫威白盒'
  OR  
t19.FName = '鑫威咖啡盒')
order by isnull(t7.fnumber,''),isnull(t19.fnumber,'')


select t0.findex 索引,主供应商,产品编码,产品名称,规格型号,芯片编码,
芯片名称,芯片规格型号,
半成品编码,
半成品名称,半成品规格型号,--芯片版本编码,
芯片版本名称,--包装方式编码,
包装方式名称,
t4.fnumber 包材编码,
t4.fname 包材名称,t4.fmodel 包材规格型号 
from #data t0
inner join t_BOSPackSub t1 on t1.fproductid=t0.产品内码 and t1.fbrandid=t0.包装方式内码
inner join t_BOSPackSubEntry t2 on t1.fid=t2.fid
inner join t_icitem t4 on t2.fitemid=t4.fitemid
order by t0.findex



--包材附件下载重复
create table #temp(findex int,fitemid int)

declare @fuserid int,@ftrantype int,@fbillno varchar(50) --
select @fuserid =16455,@ftrantype =71,@fbillno ='xw-PO1411477'

If @ftrantype = 71 
begin
	insert into #temp(findex,fitemid)
	select min(t1.fentryid),t3.fitemid 
	from poorder t2  
	inner join poorderentry t1 on t1.finterid=t2.finterid  
	inner join t_icitem t3 on t1.fitemid=t3.fitemid  
	where t2.fbillno=@fbillno and (t3.fshortnumber like '2%' or t3.fshortnumber like 'BX%')
	group by t3.fitemid
	order by min(t1.fentryid) 
end

If @ftrantype = 70 
begin
	insert into #temp(findex,fitemid)
	select min(t1.fentryid),t3.fitemid 
	from porequest t2  
	inner join porequestentry t1 on t1.finterid=t2.finterid  
	inner join t_icitem t3 on t1.fitemid=t3.fitemid  
	where t2.fbillno=@fbillno and (t3.fshortnumber like '2%' or t3.fshortnumber like 'BX%')
	group by t3.fitemid
	order by min(t1.fentryid) 
end

If @ftrantype = 81 
begin
	insert into #temp(findex,fitemid)
	select min(t1.fentryid),t3.fitemid
    from seorder t2  
    inner join seorderentry t1 on t1.finterid=t2.finterid  
    inner join t_BOSPackSub t4 on t4.fproductid=t1.fitemid and t4.fbrandid=t1.fentryselfs0158  
    inner join t_BOSPackSubEntry t5 on t4.fid=t5.fid  
    inner join t_icitem t3 on t5.fitemid=t3.fitemid  
    left join t_icitem t8 on t8.fitemid=t4.fproductid  
    left join t_submessage t11 on t11.finterid=t8.F_102 and t11.ftypeid=10001  
    where t2.fbillno=@fbillno and (t3.fshortnumber like '2%' or t3.fshortnumber like 'BX%') 
    group by t3.fitemid
    order by min(t1.fentryid) 
end
  
select t3.fnumber,t3.fname,isnull(t3.fmodel,'') fmodel,isnull(t3.f_105,'') fdescription,
t3.FLength,t3.FWidth,t3.FHeight,isnull(t1.fpath,'') fpath,'' 产品信息 ,
Reverse(isnull(t1.fpath,'')),(Charindex('\',Reverse(isnull(t1.fpath,'')),1)-1),
left(Reverse(isnull(t1.fpath,'')),(Charindex('\',Reverse(isnull(t1.fpath,'')),1)-1)),
Charindex(isnull(t1.fpath,''), '\') + 1,Len(isnull(t1.fpath,'')),Charindex(isnull(t1.fpath,''), '\'),
Substring(isnull(t1.fpath,''), Charindex(isnull(t1.fpath,''), '\') + 1, Len(isnull(t1.fpath,'')) - Charindex(isnull(t1.fpath,''), '\'))
from t_icitem t3
inner join #temp t2 on t3.fitemid=t2.fitemid
left join My_PackDesignFilePathTemp t1 on t1.fuserid=16455 and Charindex(t3.fshortnumber,t1.fpath)>0
order by Substring(isnull(t1.fpath,''), Charindex(isnull(t1.fpath,''), '\') + 1, Len(isnull(t1.fpath,'')) - Charindex(isnull(t1.fpath,''), '\'))

drop table #temp

1.01.0001.000910

--批次错误
select fbatchmanager,t1.fnumber,t2.* 
from t_icitem t1 
inner join icinventory t2 on t1.fitemid=t2.fitemid
where t1.fshortnumber in ('002426')

select fbatchmanager,t1.fnumber,t2.fbatchno,t3.fdate
from t_icitem t1 
inner join icstockbillentry t2 on t1.fitemid=t2.fitemid
inner join icstockbill t3 on t2.finterid=t3.finterid
where t1.fshortnumber in ('000910', '000928')
and t2.fbatchno=''


select fbatchmanager,t1.fnumber,t2.* 
--update t2 set fbatchno='999'
--update t2 set fbatchno=''
from t_icitem t1 
inner join icbal t2 on t1.fitemid=t2.fitemid
where t1.fshortnumber in ('002426')
and t2.FYear=2015 and t2.fperiod=3 and t2.fbatchno=''


select fbatchmanager,t1.fnumber,t2.* 
--update t2 set fbatchno='999'
--update t2 set fbatchno=''
from t_icitem t1 
inner join icinvbal t2 on t1.fitemid=t2.fitemid
where t1.fshortnumber in ('002426')
and t2.FYear=2015 and t2.fperiod=3 and t2.fbatchno=''


SELECT t2.FBatchManager,
t0.FItemID,t0.FModel,t0.FName,t0.FHelpCode,t0.FDeleted,t0.FShortNumber,t0.FNumber,
t1.FErpClsID,t1.FUnitID,t1.FUnitGroupID,t1.FDefaultLoc
--update t2 set FBatchManager=1  --批次管理
--update t2 set FBatchManager=0
FROM t_ICItemCore t0
LEFT JOIN t_ICItemBase t1 ON t0.FItemID=t1.FItemID
inner join t_ICItemMaterial t2 on t2.fitemid=t1.fitemid
inner join t_icitem t9 on t9.fitemid=t0.fitemid
where t0.fshortnumber in ('002426') and left(t9.fnumber,9) in ('1.01.0001') and t2.FBatchManager=0


SELECT t3.fbatchno,t9.fnumber,t9.fname,t9.fmodel
--update t3 set fbatchno='2015-04-01'
FROM t_icitem t9 
inner join icstockbillentry t3 on t3.fitemid=t9.fitemid
inner join icstockbill t4 on t3.finterid=t4.finterid
where left(t9.fnumber,1) in ('1.01.0001') and t9.FBatchManager=1
and t3.fbatchno=''
and t4.fdate>='2015-04-01'


SELECT t3.fbatchno,t9.fnumber,t9.fname,t9.fmodel
--update t3 set fbatchno='2014-05-20'
FROM t_icitem t9 
inner join poinstockentry t3 on t3.fitemid=t9.fitemid
inner join poinstock t4 on t3.finterid=t4.finterid
where left(t9.fnumber,1) in ('1.01.0001') and t9.FBatchManager=1
and t3.fbatchno=''
and t4.fdate>='2015-04-01'




--物料单位信息
SELECT t1.FUnitID, t1.FUnitGroupID,t1.FSecUnitID,t1.FOrderUnitID, t1.FSaleUnitID,t1.FStoreUnitID, t1.FProductUnitID,t3.FCUUnitID, t8.FFirstUnit, t8.FSecondUnit,
t0.FItemID, t0.FModel, t0.FName, t0.FHelpCode, t0.FDeleted, t0.FShortNumber, t0.FNumber, t0.FModifyTime, t0.FParentID, t0.FBrNo, t0.FTopID, t0.FRP, 
                      t0.FOmortize, t0.FOmortizeScale, t0.FForSale, t0.FStaCost, t0.FOrderPrice, t0.FOrderMethod, t0.FPriceFixingType, t0.FSalePriceFixingType, 
                      t0.FPerWastage, t0.FARAcctID, t0.FPlanPriceMethod, t0.FPlanClass, t1.FErpClsID, t1.FUnitID, t1.FUnitGroupID, t1.FDefaultLoc, t1.FSPID, t1.FSource, 
                      t1.FQtyDecimal, t1.FLowLimit, t1.FHighLimit, t1.FSecInv, t1.FUseState, t1.FIsEquipment, t1.FEquipmentNum, t1.FIsSparePart, t1.FFullName, 
                      t1.FSecUnitID, t1.FSecCoefficient, t1.FSecUnitDecimal, t1.FAlias, t1.FOrderUnitID, t1.FSaleUnitID, t1.FStoreUnitID, t1.FProductUnitID, t1.FApproveNo, 
                      t1.FAuxClassID, t1.FTypeID, t1.FPreDeadLine, t1.FSerialClassID, t2.FOrderRector, t2.FPOHghPrcMnyType, t2.FPOHighPrice, t2.FWWHghPrc, 
                      t2.FWWHghPrcMnyType, t2.FSOLowPrc, t2.FSOLowPrcMnyType, t2.FIsSale, t2.FProfitRate, t2.FSalePrice, t2.FBatchManager, t2.FISKFPeriod, 
                      t2.FKFPeriod, t2.FTrack, t2.FPlanPrice, t2.FPriceDecimal, t2.FAcctID, t2.FSaleAcctID, t2.FCostAcctID, t2.FAPAcctID, t2.FGoodSpec, t2.FCostProject, 
                      t2.FIsSnManage, t2.FStockTime, t2.FBookPlan, t2.FBeforeExpire, t2.FTaxRate, t2.FAdminAcctID, t2.FNote, t2.FIsSpecialTax, t2.FSOHighLimit, 
                      t2.FSOLowLimit, t2.FOIHighLimit, t2.FOILowLimit, t2.FDaysPer, t2.FLastCheckDate, t2.FCheckCycle, t2.FCheckCycUnit, t2.FStockPrice, t2.FABCCls, 
                      t2.FBatchQty, t2.FClass, t2.FCostDiffRate, t2.FDepartment, t2.FSaleTaxAcctID, t2.FCBBmStandardID, t3.FPlanTrategy, t3.FOrderTrategy, t3.FLeadTime, 
                      t3.FFixLeadTime, t3.FTotalTQQ, t3.FQtyMin, t3.FQtyMax, t3.FCUUnitID, t3.FOrderInterVal, t3.FBatchAppendQty, t3.FOrderPoint, t3.FBatFixEconomy, 
                      t3.FBatChangeEconomy, t3.FRequirePoint, t3.FPlanPoint, t3.FDefaultRoutingID, t3.FDefaultWorkTypeID, t3.FProductPrincipal, t3.FDailyConsume, 
                      t3.FMRPCon, t3.FPlanner, t3.FPutInteger, t3.FInHighLimit, t3.FInLowLimit, t3.FLowestBomCode, t3.FMRPOrder, t3.FIsCharSourceItem, 
                      t3.FCharSourceItemID, --t7.F_102, t7.F_103, t7.F_104, t7.F_105, t7.F_106, t7.F_107, t7.F_108, t7.F_109, t7.F_110, 
					  t4.FChartNumber, t4.FIsKeyItem, 
                      t4.FMaund, t4.FGrossWeight, t4.FNetWeight, t4.FCubicMeasure, t4.FLength, t4.FWidth, t4.FHeight, t4.FSize, t4.FVersion, t5.FStandardCost, 
                      t5.FStandardManHour, t5.FStdPayRate, t5.FChgFeeRate, t5.FStdFixFeeRate, t5.FOutMachFee, t5.FPieceRate, t6.FInspectionLevel, t6.FInspectionProject,
                       t6.FIsListControl, t6.FProChkMde, t6.FWWChkMde, t6.FSOChkMde, t6.FWthDrwChkMde, t6.FStkChkMde, t6.FOtherChkMde, t6.FStkChkPrd, 
                      t6.FStkChkAlrm, t6.FIdentifier, t8.FNameEn, t8.FModelEn, t8.FHSNumber, t8.FFirstUnit, t8.FSecondUnit, t8.FFirstUnitRate, t8.FSecondUnitRate, 
                      t8.FIsManage, t8.FPackType, t8.FLenDecimal, t8.FCubageDecimal, t8.FWeightDecimal, t8.FImpostTaxRate, t8.FConsumeTaxRate, 
                      t8.FManageType
--update t1 set FUnitID=231, FUnitGroupID=216,FOrderUnitID=231, FSaleUnitID=231,FStoreUnitID=231, FProductUnitID=231
FROM         dbo.t_ICItemCore AS t0 LEFT OUTER JOIN
                      dbo.t_ICItemBase AS t1 ON t0.FItemID = t1.FItemID LEFT OUTER JOIN
                      dbo.t_ICItemMaterial AS t2 ON t0.FItemID = t2.FItemID LEFT OUTER JOIN
                      dbo.t_ICItemPlan AS t3 ON t0.FItemID = t3.FItemID LEFT OUTER JOIN
                      dbo.t_ICItemDesign AS t4 ON t0.FItemID = t4.FItemID LEFT OUTER JOIN
                      dbo.t_ICItemStandard AS t5 ON t0.FItemID = t5.FItemID LEFT OUTER JOIN
                      dbo.t_ICItemQuality AS t6 ON t0.FItemID = t6.FItemID LEFT OUTER JOIN
                      dbo.t_ICItemCustom AS t7 ON t0.FItemID = t7.FItemID LEFT OUTER JOIN
                      dbo.T_BASE_ICItemEntrance AS t8 ON t0.FItemID = t8.FItemID
where t0.fshortnumber in ('290016') 
and t1.FUnitID=0

select t2.funitid,t3.fnumber,t3.fname,t3.fmodel
--update t2 set funitid=231
from icbom t1
inner join icbomchild t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
where --t3.fnumber like '1.15%' and
t3.fshortnumber in ('290016') 
isnull(t2.funitid,0)=0

select t2.funitid
--update t2 set funitid=231
from ppbom t1
inner join ppbomentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
where --t3.fnumber like '1.15%' and
t3.fshortnumber in ('290016') 
isnull(t2.funitid,0)=0

select t2.funitid
--update t2 set funitid=231
from poinstock t1
inner join poinstockentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
where --t3.fnumber like '1.15%' and
t3.fshortnumber in ('290016') 
isnull(t2.funitid,0)=0

select t2.funitid
--update t2 set funitid=231
from poorder t1
inner join poorderentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
where --t3.fnumber like '1.15%' and
t3.fshortnumber in ('290016','290016') 
isnull(t2.funitid,0)=0

select t2.funitid
--update t2 set funitid=231
from icstockbill t1
inner join icstockbillentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
where --t3.fnumber like '1.15%' and
t3.fshortnumber in ('290016') 
isnull(t2.funitid,0)=0


select t2.funitid
--update t2 set funitid=231
from SEorder t1
inner join SEorderentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
where --t3.fnumber like '1.15%' and
t3.fshortnumber in ('290016') 
isnull(t2.funitid,0)=0

select * from t_measureunit


--任务单关联入库数量
select *
--update t1 set fstockqty=0,fauxstockqty=0,fcommitqty=0,fauxcommitqty=0
from icmo t1 where fbillno in ('work028211','work028212','work028213','work028214')

--订单交期
select FHeadSelfS0148=t1.fdate,FHeadSelfS0154=(case when DateDiff(day,'2014-06-25',t1.fdate)>=3 then DateAdd(day, -3, t1.fdate) else '2014-06-25' end)
--update t2 set FHeadSelfS0148=t1.fdate,FHeadSelfS0154=DateAdd(day, -3, t1.fdate)
from seorder t2 
inner join seorderentry t1 on t1.finterid=t2.finterid

select * from t_stock

--标签仓


select t0.fnumber,t10.fnumber,t10.fname,t10.fmodel,t1.FDefaultLoc,t9.fname
--update t1 set FDefaultLoc=49979
FROM t_ICItemCore t0
    LEFT JOIN t_ICItemBase t1 ON t0.FItemID=t1.FItemID
    inner join t_stock t9 on t9.fitemid=t1.FDefaultLoc
    inner join t_icitem t10 on t10.fitemid=t0.fitemid
where (t0.fnumber like '2.05.%' or 
t0.fnumber like '2.06.%' or
t0.fnumber like '2.07.%' or
t0.fnumber like '2.12.%' or
t0.fnumber like '2.15.%' or
t0.fnumber like '2.18.%' or
t0.fnumber like '2.19.%' or
t0.fnumber like '2.21.%' or
t0.fnumber like '2.22.%' or
t0.fnumber like '2.23.%' or
t0.fnumber like '2.24.%' or
t0.fnumber like '2.25.%') and isnull(t1.FDefaultLoc,0)<>49979
and t10.fname not like '%代管%' and t9.fname not like '%代管%'


select t3.fnumber,t3.fname
--update t2 set fstockid=t3.FDefaultLoc
from ppbom t1
inner join ppbomentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_stock t9 on t9.fitemid=t2.fstockid
where (t3.fnumber like '2.05.%' or 
t3.fnumber like '2.06.%' or
t3.fnumber like '2.07.%' or
t3.fnumber like '2.12.%' or
t3.fnumber like '2.15.%' or
t3.fnumber like '2.18.%' or
t3.fnumber like '2.19.%' or
t3.fnumber like '2.21.%' or
t3.fnumber like '2.22.%' or
t3.fnumber like '2.23.%' or
t3.fnumber like '2.24.%' or
t3.fnumber like '2.25.%') and isnull(t2.fstockid,0)<>49979
and t3.fname not like '%代管%' and t9.fname not like '%代管%'

select t3.fnumber,t3.fname,t9.fname
--update t2 set fstockid=t3.FDefaultLoc
from icbom t1
inner join icbomchild t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_stock t9 on t9.fitemid=t2.fstockid
where (t3.fnumber like '2.05.%' or 
t3.fnumber like '2.06.%' or
t3.fnumber like '2.07.%' or
t3.fnumber like '2.12.%' or
t3.fnumber like '2.15.%' or
t3.fnumber like '2.18.%' or
t3.fnumber like '2.19.%' or
t3.fnumber like '2.21.%' or
t3.fnumber like '2.22.%' or
t3.fnumber like '2.23.%' or
t3.fnumber like '2.24.%' or
t3.fnumber like '2.25.%') and isnull(t2.fstockid,0)<>49979
and t3.fname not like '%代管%' and t9.fname not like '%代管%'

--BOM单位不正确
select t3.fnumber,t3.fmodel,t3.fname,t3.funitid,t2.funitid,t2.*
--update t2 set fstockid=t3.FDefaultLoc
--update t2 set funitid=t3.funitid
from icbom t1
inner join icbomchild t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_icitem t4 on t1.fitemid=t4.fitemid
where t2.funitid<>t3.funitid and t4.fnumber like '%300211%' 

--彩盒余额有问题
select t2.fnumber,t2.fname,t2.fmodel,t1.fbegbal,t1.fbegqty,t1.fbegbal/t1.fbegqty fprice
from icbal t1 
inner join t_icitem t2 on t1.fitemid=t2.fitemid 
where t1.fyear=2014 and t1.fperiod=5 and t2.fnumber like '2%' 
and t1.fbegqty>0 and t1.fbegbal/t1.fbegqty>20


from icstockbill t1
inner join icstockbillentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
left join seorderentry t4 on t2.forderinterid=t4.finterid and t2.forderentryid=t4.fentryid
left join seorder t5 on t4.finterid=t5.finterid
inner join t_Organization t6 on t1.fsupplyid=t6.fitemid
inner join icsaleentry t7 on t2.finterid=t7.fsourceinterid and t2.fentryid=t7.fsourceentryid and t2.fitemid=t7.fitemid and t7.fsourcetrantype=21
inner join icsale t8 on t7.finterid=t8.finterid
where t1.ftrantype=21 AND t1.fdate>='********' AND t1.fdate<='########'
and t7.fstdamount>0

--标准产品
select t0.fnumber 编码,t0.fname 名称,t0.ffullname 全称,isnull(t1.fmodel,'') 规格型号,isnull(t1.F_106,'') 适用机型,isnull(t1.f_105,'') 描述
from t_item t0
left join t_icitem t1 on t0.fitemid=t1.fitemid
where t0.fitemclassid=4 
and left(t0.fnumber,4) in ('A.01','P.01','J.01','X.01','Y.01')
order by t0.fnumber



--成本推算
select t1.fnumber 编码,t1.fname 名称,t1.fmodel 规格型号,t1.F_106 适用机型,isnull(t1.f_105,'') 描述,
isnull(t13.fname,'') 外盒尺寸,isnull(t14.fname,'') 打印机品牌,isnull(t15.fshortname,'') 主供应商,
isnull(t2.fqty,0) 入库数量,isnull(t2.fprice,0) 入库材料成本,
cast(isnull(t3.fqty,0)/6 as int) 月均出库数量,
case when cast(isnull(t3.fqty,0)/6 as int)>10000 then '1' 
     when cast(isnull(t3.fqty,0)/6 as int)>5000 and cast(isnull(t3.fqty,0)/6 as int)<=10000 then '2'
     when t1.fshortnumber not in ('A10193','A10194','A10195','A10196','A10197','A10198','A10199','A10200''A10201') and cast(isnull(t3.fqty,0)/6 as int)<=5000 then '3'   
     when t1.fshortnumber     in ('A10193','A10194','A10195','A10196','A10197','A10198','A10199','A10200''A10201') and cast(isnull(t3.fqty,0)/6 as int)<=5000 then '4' end 等级,  
case when cast(isnull(t3.fqty,0)/6 as int)>10000 then '5' 
     when cast(isnull(t3.fqty,0)/6 as int)>5000 and cast(isnull(t3.fqty,0)/6 as int)<=10000 then '10'
     when t1.fshortnumber not in ('A10193','A10194','A10195','A10196','A10197','A10198','A10199','A10200''A10201') and cast(isnull(t3.fqty,0)/6 as int)<=5000 then '15'   
     when t1.fshortnumber     in ('A10193','A10194','A10195','A10196','A10197','A10198','A10199','A10200''A10201') and cast(isnull(t3.fqty,0)/6 as int)<=5000 then '25' end [目标净利润率(%)], 
isnull(t11.fname,'') 结算类别,isnull(t11.f_101,0) 系数,          
isnull(t3.fqty,0) 出库数量,isnull(t3.fprice,0) 出库均价
from t_icitem t1
left join 
(
	select t2.fitemid,sum(t2.fqty) fqty,cast(sum(t2.famount)/sum(t2.fqty) as decimal(24,4)) fprice
	from icstockbillentry t2 
	inner join icstockbill t3 on t2.finterid=t3.finterid 
	where t3.ftrantype=2 and t3.fdate>='2014-01-01' and t3.fdate<='2014-06-30'
	--and t3.frob=-1
	group by t2.fitemid
) t2 on t1.fitemid=t2.fitemid
left join 
(
	select fitemid,fqty,cast(famount/fqty as decimal(24,4)) fprice
	from
	(
		select t2.fitemid,sum(t2.fqty) fqty,--sum(t2.fstdamount) famount,cast(sum(t2.fstdamount)/sum(t2.fqty) as decimal(24,4)) fprice
		sum(case when t3.fcustid=16708 and t3.fcurrencyid=1000 and Charindex('裸包',isnull(t9.fname,''),1)>0 then t2.fstdamount/1.06*1.11+isnull(t10.F_103,0.4)*6.1 --香港傲威、美金、裸包
				 when t3.fcustid=16708 and t3.fcurrencyid=1000 and Charindex('裸包',isnull(t9.fname,''),1)=0 then t2.fstdamount/1.06*1.11 --香港傲威、美金、非裸包
				 when t3.fcustid<>16708 and t3.fcurrencyid=1000 and Charindex('裸包',isnull(t9.fname,''),1)>0 then t2.fstdamount*1.11+isnull(t10.F_103,0.4)*6.1 --非香港傲威、美金、裸包
				 when t3.fcustid<>16708 and t3.fcurrencyid=1000 and Charindex('裸包',isnull(t9.fname,''),1)=0 then t2.fstdamount*1.11 --非香港傲威、美金、非裸包
				 when t3.fcurrencyid<>1000 and Charindex('裸包',isnull(t9.fname,''),1)>0 then t2.fstdamount+isnull(t10.F_103,0.4)*6.1 --非美金、裸包
				 when t3.fcurrencyid<>1000 and Charindex('裸包',isnull(t9.fname,''),1)=0 then t2.fstdamount --非美金、非裸包
				 end ) famount
		from icsaleentry t2 
		inner join icsale t3 on t2.finterid=t3.finterid 
		left join seorderentry t4 on t4.finterid=t2.forderinterid and t4.fentryid=t2.forderentryid
		left join t_icitem t5 on t5.fitemid=t2.fitemid
		left join t_item t13 on t13.fitemid=t5.F_103 and t13.fitemclassid=3004  --外盒尺寸
		--left join t_BOSPackSub t11 on t11.fproductid=t4.fitemid and t11.fbrandid=t4.fentryselfs0158  --包装方案
		left join t_item t9 on t9.fitemclassid=3002 and t9.fitemid=t4.fentryselfs0158 --包装方式
		left join t_Item_3012 t10 on t10.f_102=t13.fitemid and t10.f_101=25955 --彩盒费用
		where t3.fdate>='2014-01-01' and t3.fdate<='2014-06-30'
		group by t2.fitemid
	) t1
) t3 on t1.fitemid=t3.fitemid
left join t_item t13 on t13.fitemid=t1.F_103 and t13.fitemclassid=3004  --外盒尺寸
left join t_SubMessage t14 on t14.finterid=t1.F_102  --打印机品牌
left join t_supplier t15 on t15.fitemid=t1.F_117
left join t_item_3005 t11 on t11.fitemid=t1.F_104 --and t11.fitemclassid=3005
where t1.fdeleted=0 and left(t1.fnumber,1) in ('A','P')
order by t1.fnumber



--销售数据统计
select t4.fnumber 编码,t4.fname+'//'+t4.fmodel 规格型号,t4.F_106 适用机型,isnull(t13.fname,'') 外盒尺寸,isnull(t14.fname,'') 打印机品牌,
sum(t1.fqty) 数量,sum(t3.fprice*t5.fexchangerate*t1.fqty) 金额,cast(sum(t3.fprice*t5.fexchangerate*t1.fqty)/sum(t1.fqty) as decimal(24,4)) 平均单价,
cast(min(t3.fprice*t5.fexchangerate) as decimal(24,4)) 最低单价
from icstockbillentry t1  
inner join icstockbill t2 on t1.finterid=t2.finterid  
inner join t_icitem t4 on t1.fitemid=t4.fitemid
left join t_item t13 on t13.fitemid=t4.F_103 and t13.fitemclassid=3004  --外盒尺寸
left join t_SubMessage t14 on t14.finterid=t4.F_102  --打印机品牌
inner join seorderentry t3 on t1.forderinterid=t3.finterid and t1.forderentryid=t3.fentryid
inner join seorder t5 on t3.finterid=t5.finterid
left join icsaleentry t7 on t1.finterid=t7.fsourceinterid and t1.fentryid=t7.fsourceentryid and t7.fsourcetrantype=21
left join icsale t8 on t7.finterid=t8.finterid
where t2.fdate>='2014-01-01' and t2.fdate<='2014-05-20' and t2.ftrantype=21 and left(t4.fnumber,1) in ('A','P') and t3.fprice*t5.fexchangerate>10
and t4.fname like '%高配%'
group by t4.fnumber,t4.fname,t4.fmodel,t4.F_106 ,t14.fname,t13.fname
order by isnull(t14.fname,''),t4.fnumber



--MRP性能
select distinct 物料内码 into #data from my_v_MrpResultDetail where 计算编号= 3238 and 净需求>0

select * from my_v_MrpResultDetail where 计算编号= 3238  
and 物料内码 in (select 物料内码 from #data) order by 物料编码,需求日期

select * from my_v_MrpResultDetail where 计算编号= 3238  
and 物料内码 in (select 物料内码 from my_v_MrpResultDetail where 计算编号= 3238 and 净需求>0) order by 物料编码,需求日期


--BOS单据过滤错误
select * from t_user where fname='刘友情'
select * from ICBillNo where fbillname like '%塑胶子件%'

delete t1 FROM ICClassUserProfile t1 WHERE FUserID in (16413) AND FSection='FilterSet200000022'
delete t1  from ICClassProfile t1 where FSchemeName = 'Default Schema'  And FUserID in (16413) And FTranType = 200000022 AND FSysName = '' 
delete t1   FROM ICClassUserProfile t1 WHERE FUserID in (16413) AND FSection='BOSFilter200000022' AND FKey='DefaultScheme'

--Mrp性能优化
Delete from My_t_MrpRoughNeedSource where frunid in (select frunid from my_t_Mrp where fdate<=Dateadd(day,-20,getdate()))
Delete from My_t_MrpWillInStock where frunid in (select frunid from my_t_Mrp where fdate<=Dateadd(day,-20,getdate()))
Delete from my_t_MrpResultDetail where frunid in (select frunid from my_t_Mrp where fdate<=Dateadd(day,-20,getdate()))
Delete from my_t_MrpResultSum where frunid in (select frunid from my_t_Mrp where fdate<=Dateadd(day,-20,getdate()))
Delete from My_t_MrpStock where frunid in (select frunid from my_t_Mrp where fdate<=Dateadd(day,-20,getdate()))

--Delete from my_t_Mrp where fdate<=Dateadd(day,-20,getdate())  --要是清除的话，MRP计算过的单据会显示没有计算过

--包装资料更新

select t17.fname,t12.fname,t11.芯片版本,t16.fname,t11.打印机品牌,t11.海关产品分类,t13.fname,t11.外盒尺寸类别,t14.fname,t11.工厂结算类别,t15.fname,t11.* 
--update t7 set F_111=t11.标准外盒尺寸,F_112=cast(t11.整箱净重 as decimal(24,3)),F_119=cast(t11.整箱毛重 as decimal(24,3)),F_110=t11.标准装箱数,F_109=t11.标准外箱尺寸,F_120=t11.裸包外箱尺寸规格,F_122=cast(t11.裸包整箱净重 as decimal(24,3)),F_123=cast(t11.裸包整箱毛重 as decimal(24,3)),F_121=t11.裸包装箱数
--update t7 set F_102=isnull(t16.finterid,0)
--update t0 set fname=t0.fname+'/'+t11.芯片版本
--update t17 set fname=t17.fname+'/'+t11.芯片版本
--update t18 set flastmoddate='2014-04-01'
from sheet1$ t11 
inner join t_icitem t12 on t11.代码=t12.fnumber
inner join dbo.t_ICItemCore AS t0 on t0.fitemid=t12.fitemid LEFT OUTER JOIN
dbo.t_ICItemBase AS t1 ON t0.FItemID = t1.FItemID LEFT OUTER JOIN
dbo.t_ICItemMaterial AS t2 ON t0.FItemID = t2.FItemID LEFT OUTER JOIN
dbo.t_ICItemPlan AS t3 ON t0.FItemID = t3.FItemID LEFT OUTER JOIN
dbo.t_ICItemDesign AS t4 ON t0.FItemID = t4.FItemID LEFT OUTER JOIN
dbo.t_ICItemStandard AS t5 ON t0.FItemID = t5.FItemID LEFT OUTER JOIN
dbo.t_ICItemQuality AS t6 ON t0.FItemID = t6.FItemID LEFT OUTER JOIN
dbo.t_ICItemCustom AS t7 ON t0.FItemID = t7.FItemID LEFT OUTER JOIN
dbo.T_BASE_ICItemEntrance AS t8 ON t0.FItemID = t8.FItemID
left join t_item t13 on t13.fname=t11.海关产品分类 and t13.fitemclassid=3003
left join t_item t14 on t14.fname=t11.外盒尺寸类别 and t14.fitemclassid=3004
left join t_item t15 on t15.fname=t11.工厂结算类别 and t15.fitemclassid=3005
left join t_submessage t16 on t16.fname=t11.打印机品牌 and t16.ftypeid=10001
inner join t_item t17 on t17.fitemid=t12.fitemid
inner join t_baseproperty t18 on t12.fitemid=t18.fitemid
where t13.fname is null or t14.fname is null or t15.fname is null 

select * from t_itemclass

select * from t_submestype

打印机品牌	F_102
外盒尺寸类别	F_103
工厂结算类别	F_104
海关产品分类	F_108
标准外箱尺寸(mm)	F_109 ------------
标准装箱数	F_110
标准外盒尺寸(mm)	F_111
整箱净重(kg)	F_112
整箱毛重(kg)	F_119
裸包标准外箱尺寸(mm)	F_120 -------
裸包标准装箱数	F_121
裸包整箱净重(kg)	F_122 ---------
裸包整箱毛重(kg)	F_123 ------------

--交付方式
select t1.fentryselfs0175,t2.FEntrySelfS0237
--update t2 set FEntrySelfS0237=t1.fentryselfs0175
from seorderentry t1 
inner join seoutstockentry t2 on t1.finterid=t2.fsourceinterid and t1.fentryid=t2.fsourceentryid

select t1.fentryselfs0175,t2.FEntrySelfB0159
--update t2 set FEntrySelfB0159=t1.fentryselfs0175
from seorderentry t1 
inner join icstockbillentry t2 on t1.finterid=t2.forderinterid and t1.fentryid=t2.forderentryid


--点零版本对应表
select t2.fnumber,t2.fname,t2.fmodel,t4.fnumber,t4.fname,t4.fmodel,t5.fnumber,t5.fname,t5.fmodel
from icbom t1
inner join t_icitem t2 on t1.fitemid=t2.fitemid
inner join icbomchild t3 on t1.finterid=t3.finterid
inner join t_icitem t4 on t3.fitemid=t4.fitemid
inner join t_icitem t5 on t5.fitemid<>t4.fitemid and left(t5.fnumber,9)=left(t4.fnumber,9)
inner join icbom t6 on t5.fitemid=t6.fitemid
where left(t2.fnumber,1) in ('A','P')
order by t2.fnumber,t5.fnumber


--半成品进行批次管理--
SELECT 
t0.FItemID,t0.FModel,t0.FName,t0.FHelpCode,t0.FDeleted,t0.FShortNumber,t0.FNumber,
t1.FErpClsID,t1.FUnitID,t1.FUnitGroupID,t1.FDefaultLoc
--update t2 set FBatchManager=1  --批次管理
FROM t_ICItemCore t0
LEFT JOIN t_ICItemBase t1 ON t0.FItemID=t1.FItemID
inner join t_ICItemMaterial t2 on t2.fitemid=t1.fitemid
inner join t_icitem t9 on t9.fitemid=t0.fitemid
where left(t9.fnumber,9) in ('1.01.0001') and t2.FBatchManager=0

SELECT t3.fbatchno,t9.fnumber,t9.fname,t9.fmodel
--update t3 set fbatchno='2015-04-01'
FROM t_icitem t9 
inner join icstockbillentry t3 on t3.fitemid=t9.fitemid
inner join icstockbill t4 on t3.finterid=t4.finterid
where left(t9.fnumber,1) in ('1.01.0001') and t9.FBatchManager=1
and t3.fbatchno=''
and t4.fdate>='2015-04-01'

SELECT t3.fbatchno,t9.fnumber,t9.fname,t9.fmodel
--update t3 set fbatchno='2014-05-20'
FROM t_icitem t9 
inner join poinstockentry t3 on t3.fitemid=t9.fitemid
inner join poinstock t4 on t3.finterid=t4.finterid
where left(t9.fnumber,1) in ('1.01.0001') and t9.FBatchManager=1
and t3.fbatchno=''
and t4.fdate>='2015-04-01'


SELECT t3.FGMPBatchNo,t9.fnumber,t9.fname,t9.fmodel
--update t3 set FGMPBatchNo=t3.fbillno
FROM t_icitem t9 
inner join icmo t3 on t3.fitemid=t9.fitemid
where left(t9.fnumber,1) in ('3','4') --and t2.FBatchManager=1
and t3.fcheckdate>='2014-01-01'


select t1.* 
--update t1 set fbatchno='999'
from icbal t1
inner join t_icitem t2 on t1.fitemid=t2.fitemid
where left(t2.fnumber,1) in ('3','4') and t1.fyear=2014 and t1.fperiod=1
order by t1.fitemid

select t1.* 
--update t1 set fbatchno='999'
from icinvbal t1
inner join t_icitem t2 on t1.fitemid=t2.fitemid
where left(t2.fnumber,1) in ('3','4') and t1.fyear=2014 and t1.fperiod=1
order by t1.fitemid

--投料单是否有替换--检查
select t4.fnumber,t4.fname,t4.fmodel,t3.FEntrySelfY0259,t5.fnumber,t5.fname,t5.fmodel, isnull(t3.folditemid,0)
from icmo t1
inner join ppbom t2 on t2.ficmointerid=t1.finterid
inner join ppbomentry t3 on t2.finterid=t3.finterid
inner join t_icitem t4 on t4.fitemid=t3.fitemid
left join t_icitem t5 on t5.fitemid=t3.folditemid
where t1.fbillno='work017718'



--检查科目是否使用--------------------------------------------------------------------------

select * from t_account where fnumber like '2211%'

Create table #ObjectItemID(ItemID INT NOT NULL,FUsedFlag INT DEFAULT(2),FDescription VARCHAR(400) NULL)

INSERT INTO #ObjectItemID (ItemID) VALUES(2220)

UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='核算项目_客户' FROM #ObjectItemID t1,t_Organization  WHERE t1.ItemID=FARAccountID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='核算项目_客户' FROM #ObjectItemID t1,t_Organization  WHERE t1.ItemID=FPreAcctID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='核算项目_供应商' FROM #ObjectItemID t1,t_Supplier  WHERE t1.ItemID=FPreARAcctID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='核算项目_供应商' FROM #ObjectItemID t1,t_Supplier  WHERE t1.ItemID=FOtherARAcctID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='核算项目_要素费用' FROM #ObjectItemID t1,cbExpense  WHERE t1.ItemID=FBaseAcctID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='核算项目_要素费用' FROM #ObjectItemID t1,cbExpense  WHERE t1.ItemID=FAssistAcctID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='核算项目_要素费用' FROM #ObjectItemID t1,cbExpense  WHERE t1.ItemID=FMakeAcctID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='核算项目_要素费用' FROM #ObjectItemID t1,cbExpense  WHERE t1.ItemID=FAcctID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='核算项目_成本中心' FROM #ObjectItemID t1,t_BASE_CostCenter  WHERE t1.ItemID=FAcctID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='核算项目_客户' FROM #ObjectItemID t1,t_Organization  WHERE t1.ItemID=FOtherARAcctID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='核算项目_客户' FROM #ObjectItemID t1,t_Organization  WHERE t1.ItemID=FPayTaxAcctID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='核算项目_客户' FROM #ObjectItemID t1,t_Organization  WHERE t1.ItemID=FAPAccountID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='核算项目_客户' FROM #ObjectItemID t1,t_Organization  WHERE t1.ItemID=FPreAPAcctID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='核算项目_客户' FROM #ObjectItemID t1,t_Organization  WHERE t1.ItemID=FOtherAPAcctID AND FUsedFlag <> 1

UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='核算项目_部门' FROM #ObjectItemID t1,t_Department  WHERE t1.ItemID=FAcctID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='核算项目_部门' FROM #ObjectItemID t1,t_Department  WHERE t1.ItemID=FOtherARAcctID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='核算项目_部门' FROM #ObjectItemID t1,t_Department  WHERE t1.ItemID=FPreARAcctID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='核算项目_部门' FROM #ObjectItemID t1,t_Department  WHERE t1.ItemID=FOtherAPAcctID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='核算项目_部门' FROM #ObjectItemID t1,t_Department  WHERE t1.ItemID=FPreAPAcctID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='核算项目_职员' FROM #ObjectItemID t1,t_Emp  WHERE t1.ItemID=FOtherARAcctID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='核算项目_职员' FROM #ObjectItemID t1,t_Emp  WHERE t1.ItemID=FPreARAcctID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='核算项目_职员' FROM #ObjectItemID t1,t_Emp  WHERE t1.ItemID=FOtherAPAcctID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='核算项目_职员' FROM #ObjectItemID t1,t_Emp  WHERE t1.ItemID=FPreAPAcctID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='核算项目_物料' FROM #ObjectItemID t1,t_ICItem  WHERE t1.ItemID=FAcctID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='核算项目_物料' FROM #ObjectItemID t1,t_ICItem  WHERE t1.ItemID=FSaleAcctID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='核算项目_物料' FROM #ObjectItemID t1,t_ICItem  WHERE t1.ItemID=FCostAcctID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='核算项目_物料' FROM #ObjectItemID t1,t_ICItem  WHERE t1.ItemID=FAPAcctID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='核算项目_物料' FROM #ObjectItemID t1,t_ICItem  WHERE t1.ItemID=FAdminAcctID AND FUsedFlag <> 1

UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='核算项目_供应商' FROM #ObjectItemID t1,t_Supplier  WHERE t1.ItemID=FAPAccountID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='核算项目_供应商' FROM #ObjectItemID t1,t_Supplier  WHERE t1.ItemID=FPreAcctID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='核算项目_供应商' FROM #ObjectItemID t1,t_Supplier  WHERE t1.ItemID=FOtherAPAcctID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='核算项目_供应商' FROM #ObjectItemID t1,t_Supplier  WHERE t1.ItemID=FPayTaxAcctID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='核算项目_供应商' FROM #ObjectItemID t1,t_Supplier  WHERE t1.ItemID=FARAccountID AND FUsedFlag <> 1

UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='余额表_科目' FROM #ObjectItemID t1,t_Balance WHERE t1.ItemID=FAccountID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='凭证分录_科目' FROM #ObjectItemID t1, t_VoucherEntry WHERE t1.ItemID=FAccountID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='预算表_科目' FROM #ObjectItemID t1, t_Budget WHERE t1.ItemID=FAccountID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='损益科目_科目' FROM #ObjectItemID t1, (SELECT distinct(FAccountID) FROM t_ProfitAndLoss WHERE (FYtdAmountFor+FYtdAmount)<>0) t2 WHERE 
t1.ItemID=t2.FAccountID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='应收应付_销售发票' FROM #ObjectItemID t1,(select FAcctID from ICSale where FSubSystemID=1) t2 WHERE t1.ItemID=FAcctID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='应收应付_采购发票' FROM #ObjectItemID t1,(select FAcctID from ICPurchase where FSubSystemID=1) t2 WHERE t1.ItemID=FAcctID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='应收应付_收付款单据' FROM #ObjectItemID t1,t_rp_ARBillOfSH WHERE t1.ItemID=FAccountID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='应收应付_其他应收应付单据' FROM #ObjectItemID t1,t_rp_arpbill WHERE t1.ItemID=FAccountID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='应收应付_初始化单据' FROM #ObjectItemID t1,t_rp_begdata WHERE t1.ItemID=FAccountID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='固定资产_卡片' FROM #ObjectItemID t1,t_FACard t2 WHERE t1.ItemID=t2.FAssetAcctID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='固定资产_卡片组' FROM #ObjectItemID t1,t_FAGroup t2 WHERE t1.ItemID=t2.FAssetAcctID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='固定资产_折旧费用科目' FROM #ObjectItemID t1,t_FAExpense t2 WHERE t1.ItemID=t2.FAcctID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='固定资产_变动方式科目' FROM #ObjectItemID t1,t_FAAlterMode t2 WHERE t1.ItemID=t2.FAcctID AND FUsedFlag <> 1

UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='固定资产_费用分配科目' FROM #ObjectItemID t1,t_FACard t2 WHERE t1.ItemID=t2.FDeprAcctID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='凭证-科目' FROM #ObjectItemID t1,t_VoucherEntry WHERE t1.ItemID=FAccountID AND FUsedFlag <> 1
UPDATE #ObjectItemID SET FUsedFlag = 1,FDescription='凭证模板-科目' FROM #ObjectItemID t1,(SELECT DISTINCT(FAccID) FROM ICVouchertplEntry WHERE FInterID>=1000) t2 WHERE t1.ItemID=t2.FAccID AND FUsedFlag <> 1

select * from #ObjectItemID where FUsedFlag=1

Drop table #ObjectItemID

go


--科目信息
SELECT t0.FShortNumber, t0.FNumber,t2.FTrack,t2.FAcctID, t2.FSaleAcctID, t2.FCostAcctID,t1.FUnitID, t1.FUnitGroupID,t1.FSecUnitID,t1.FOrderUnitID, t1.FSaleUnitID,t1.FStoreUnitID, t1.FProductUnitID,t3.FCUUnitID, t8.FFirstUnit, t8.FSecondUnit,
t0.FItemID, t0.FModel, t0.FName, t0.FHelpCode, t0.FDeleted,  t0.FModifyTime, t0.FParentID, t0.FBrNo, t0.FTopID, t0.FRP, 
                      t0.FOmortize, t0.FOmortizeScale, t0.FForSale, t0.FStaCost, t0.FOrderPrice, t0.FOrderMethod, t0.FPriceFixingType, t0.FSalePriceFixingType, 
                      t0.FPerWastage, t0.FARAcctID, t0.FPlanPriceMethod, t0.FPlanClass, t1.FErpClsID, t1.FUnitID, t1.FUnitGroupID, t1.FDefaultLoc, t1.FSPID, t1.FSource, 
                      t1.FQtyDecimal, t1.FLowLimit, t1.FHighLimit, t1.FSecInv, t1.FUseState, t1.FIsEquipment, t1.FEquipmentNum, t1.FIsSparePart, t1.FFullName, 
                      t1.FSecUnitID, t1.FSecCoefficient, t1.FSecUnitDecimal, t1.FAlias, t1.FOrderUnitID, t1.FSaleUnitID, t1.FStoreUnitID, t1.FProductUnitID, t1.FApproveNo, 
                      t1.FAuxClassID, t1.FTypeID, t1.FPreDeadLine, t1.FSerialClassID, t2.FOrderRector, t2.FPOHghPrcMnyType, t2.FPOHighPrice, t2.FWWHghPrc, 
                      t2.FWWHghPrcMnyType, t2.FSOLowPrc, t2.FSOLowPrcMnyType, t2.FIsSale, t2.FProfitRate, t2.FSalePrice, t2.FBatchManager, t2.FISKFPeriod, 
                      t2.FKFPeriod, t2.FTrack, t2.FPlanPrice, t2.FPriceDecimal,  t2.FAPAcctID, t2.FGoodSpec, t2.FCostProject, 
                      t2.FIsSnManage, t2.FStockTime, t2.FBookPlan, t2.FBeforeExpire, t2.FTaxRate, t2.FAdminAcctID, t2.FNote, t2.FIsSpecialTax, t2.FSOHighLimit, 
                      t2.FSOLowLimit, t2.FOIHighLimit, t2.FOILowLimit, t2.FDaysPer, t2.FLastCheckDate, t2.FCheckCycle, t2.FCheckCycUnit, t2.FStockPrice, t2.FABCCls, 
                      t2.FBatchQty, t2.FClass, t2.FCostDiffRate, t2.FDepartment, t2.FSaleTaxAcctID, t2.FCBBmStandardID, t3.FPlanTrategy, t3.FOrderTrategy, t3.FLeadTime, 
                      t3.FFixLeadTime, t3.FTotalTQQ, t3.FQtyMin, t3.FQtyMax, t3.FCUUnitID, t3.FOrderInterVal, t3.FBatchAppendQty, t3.FOrderPoint, t3.FBatFixEconomy, 
                      t3.FBatChangeEconomy, t3.FRequirePoint, t3.FPlanPoint, t3.FDefaultRoutingID, t3.FDefaultWorkTypeID, t3.FProductPrincipal, t3.FDailyConsume, 
                      t3.FMRPCon, t3.FPlanner, t3.FPutInteger, t3.FInHighLimit, t3.FInLowLimit, t3.FLowestBomCode, t3.FMRPOrder, t3.FIsCharSourceItem, 
                      t3.FCharSourceItemID, t7.F_102, t7.F_103, t7.F_104, t7.F_105, t7.F_106, t7.F_107, t7.F_108, t7.F_109, t7.F_110, t4.FChartNumber, t4.FIsKeyItem, 
                      t4.FMaund, t4.FGrossWeight, t4.FNetWeight, t4.FCubicMeasure, t4.FLength, t4.FWidth, t4.FHeight, t4.FSize, t4.FVersion, t5.FStandardCost, 
                      t5.FStandardManHour, t5.FStdPayRate, t5.FChgFeeRate, t5.FStdFixFeeRate, t5.FOutMachFee, t5.FPieceRate, t6.FInspectionLevel, t6.FInspectionProject,
                       t6.FIsListControl, t6.FProChkMde, t6.FWWChkMde, t6.FSOChkMde, t6.FWthDrwChkMde, t6.FStkChkMde, t6.FOtherChkMde, t6.FStkChkPrd, 
                      t6.FStkChkAlrm, t6.FIdentifier, t8.FNameEn, t8.FModelEn, t8.FHSNumber, t8.FFirstUnit, t8.FSecondUnit, t8.FFirstUnitRate, t8.FSecondUnitRate, 
                      t8.FIsManage, t8.FPackType, t8.FLenDecimal, t8.FCubageDecimal, t8.FWeightDecimal, t8.FImpostTaxRate, t8.FConsumeTaxRate, 
                      t8.FManageType
--update t2 set t2.FSaleAcctID=1435, t2.FCostAcctID=1457
--update t2 set FAcctID=1314
FROM         dbo.t_ICItemCore AS t0 LEFT OUTER JOIN
                      dbo.t_ICItemBase AS t1 ON t0.FItemID = t1.FItemID LEFT OUTER JOIN
                      dbo.t_ICItemMaterial AS t2 ON t0.FItemID = t2.FItemID LEFT OUTER JOIN
                      dbo.t_ICItemPlan AS t3 ON t0.FItemID = t3.FItemID LEFT OUTER JOIN
                      dbo.t_ICItemDesign AS t4 ON t0.FItemID = t4.FItemID LEFT OUTER JOIN
                      dbo.t_ICItemStandard AS t5 ON t0.FItemID = t5.FItemID LEFT OUTER JOIN
                      dbo.t_ICItemQuality AS t6 ON t0.FItemID = t6.FItemID LEFT OUTER JOIN
                      dbo.t_ICItemCustom AS t7 ON t0.FItemID = t7.FItemID LEFT OUTER JOIN
                      dbo.T_BASE_ICItemEntrance AS t8 ON t0.FItemID = t8.FItemID
where left(t0.fnumber,1) in ('2') and 
isnull(t2.FAcctID,0)<>1314

1435	6001.01.06	外部客户  --主营业务收入
1457	6401.01.06	外部客户  --主营业务成本

select * from t_account where fnumber like '14%' 

1014	1403.01	易耗件
1311	1403.02	塑胶件
1312	1403.03	辅料
1313	1403.04	回收件
1314	1403.05	包装材料

select * from t_itempropdesc where fitemclassid=4

--更改销售订单本位币
select t4.fname,t1.fdate,t2.fallamount,t2.fallstdamount,t1.fexchangerate,t2.*
--update t2 set fallstdamount=cast(t2.fallamount*t1.fexchangerate as decimal(24,2))
from seorder t1
inner join seorderentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_organization t4 on t4.fitemid=t1.fcustid
where t1.fcurrencyid=1000  and t2.fallamount=t2.fallstdamount

select t6.fnumber 物料编码,t6.fname 名称,t6.fmodel 规格型号,min(t1.fchildinvqty) 子项最小库存,
max(t1.fchildinvqty) 子项最大库存,min(finvqty) 可配套数
from
(
	select t5.fitemid,isnull(t1.fqty,0) fchildinvqty,isnull(t1.fqty,0)/t4.fqty finvqty
	from icbomchild t4 
	inner join icbom t5 on t5.finterid=t4.finterid
	inner join t_icitem t6 on t6.fitemid=t5.fitemid
	inner join t_icitem t2 on t4.fitemid=t2.fitemid
	left join icinventory t1 on t4.fitemid=t1.fitemid
	left join t_stock t3 on t1.fstockid=t3.fitemid
	where t2.fnumber like '6.%' --and isnull(t1.fqty,0)=0
	and t6.fnumber like '1.02.%'
) t1 inner join t_icitem t6 on t1.fitemid=t6.fitemid
group by t6.fnumber,t6.fname,t6.fmodel

select t6.fnumber,t6.fname,t6.fmodel,t2.fnumber,t2.fname,t2.fmodel,t1.fqty
--delete t4
from icbomchild t4 
inner join icbom t5 on t5.finterid=t4.finterid
inner join t_icitem t6 on t6.fitemid=t5.fitemid
inner join t_icitem t2 on t4.fitemid=t2.fitemid
left join icinventory t1 on t4.fitemid=t1.fitemid and t1.fstockid=39615
left join t_stock t3 on t1.fstockid=t3.fitemid
where t2.fnumber like '6.%' --and isnull(t1.fqty,0)=0
and t6.fnumber like '1.02.%' and (t2.fname like '%插销%')
and (t2.fnumber  in ('6.06.060062.602919','6.06.060062.602920','6.06.060088.602978','6.01.060121.603228',
'6.01.060128.603308','6.01.060176.603607','6.06.060229.604023','6.01.060125.604316',
'6.01.060126.604333','6.01.060269.604734','6.01.060269.604735','6.06.060270.604752','6.06.060270.604753') or charindex('冻结',t6.fname)>0)


--子件
select distinct t3.fname
from icinventory t1
inner join t_icitem t2 on t1.fitemid=t2.fitemid
inner join t_stock t3 on t1.fstockid=t3.fitemid
where t2.fnumber like '6.%' and t1.fqty<>0


select distinct t3.fname
from poinventory t1
inner join t_icitem t2 on t1.fitemid=t2.fitemid
inner join t_stock t3 on t1.fstockid=t3.fitemid
where t2.fnumber like '6.%' and t1.fqty<>0

--套件
select distinct t3.fname
from icinventory t1
inner join t_icitem t2 on t1.fitemid=t2.fitemid
inner join t_stock t3 on t1.fstockid=t3.fitemid
where t2.fnumber like '1.02.%' and t1.fqty<>0

select distinct t3.fname
from poinventory t1
inner join t_icitem t2 on t1.fitemid=t2.fitemid
inner join t_stock t3 on t1.fstockid=t3.fitemid
where t2.fnumber like '1.02.%' and t1.fqty<>0


--国家
select t1.FHeadSelfS0146,t4.FHeadSelfS0247
--update t4 set t4.FHeadSelfS0247=t1.FHeadSelfS0146
from seorder t1
inner join seorderentry t2 on t1.finterid=t2.finterid
inner join seoutstockentry t3 on t3.fsourceinterid=t2.finterid and t3.fsourceentryid=t2.fentryid and t3.fsourcetrantype=81
inner join seoutstock t4 on t3.finterid=t4.finterid

select t1.FHeadSelfS0146,t4.FHeadSelfP0248
--update t4 set t4.FHeadSelfP0248=t1.FHeadSelfS0146
from seorder t1
inner join seorderentry t2 on t1.finterid=t2.finterid
inner join poorderentry t3 on t3.fsourceinterid=t2.finterid and t3.fsourceentryid=t2.fentryid and t3.fsourcetrantype=81
inner join poorder t4 on t3.finterid=t4.finterid

select t1.FHeadSelfS0146,t4.FHeadSelfS0247,t6.FHeadSelfB0154
--update t6 set t6.FHeadSelfB0154=t1.FHeadSelfS0146
from seorder t1
inner join seorderentry t2 on t1.finterid=t2.finterid
inner join seoutstockentry t3 on t3.fsourceinterid=t2.finterid and t3.fsourceentryid=t2.fentryid and t3.fsourcetrantype=81
inner join seoutstock t4 on t3.finterid=t4.finterid
inner join icstockbillentry t5 on t5.fsourceinterid=t3.finterid and t3.fsourceentryid=t3.fentryid and t5.fsourcetrantype=83
inner join icstockbill t6 on t6.finterid=t5.finterid


产品配置+半成品/芯片 动态库存 ,成品任务单下达才计入订单进度跟踪表，下达或刷新投料单要检查全部信息已经做完  --

select t8.fbillno forderbillno,t1.fbillno,t11.fname fsupname,
t9.fnumber,t9.fname,t9.fmodel,--t10.fnumber ,t10.fname,t10.fmodel,
t7.fqty forderqty,t7.fprice,
t2.fqty finqty,t5.fperqty,t2.fqty/t5.fperqty fsuitinqty,t7.finterid,t7.fentryid
from icstockbill t1
inner join icstockbillentry t2 on t1.finterid=t2.finterid
inner join poinstockentry t3 on t2.fsourceinterid=t3.finterid and t2.fsourceentryid=t3.fentryid and t2.fsourcetrantype=72
inner join poinstock t4 on t3.finterid=t4.finterid
inner join t_bosPlasticPoInStockEntry t5 on t5.fid=t3.fsourceinterid and t5.fentryid=t3.fsourceentryid and t3.fsourcetrantype=200000022
inner join t_bosPlasticPoInStock t6 on t6.fid=t5.fid
inner join poorderentry t7 on t7.finterid=t5.fid_src and t7.fentryid=t5.fentryid_src 
inner join poorder t8 on t8.finterid=t7.finterid
inner join t_icitem t9 on t9.fitemid=t7.fitemid
inner join t_icitem t10 on t10.fitemid=t2.fitemid
inner join t_supplier t11 on t11.fitemid=t8.fsupplyid
where t1.fbillno='win006605'

00346

--塑胶子件投料单初始化
declare @fuserid int,@ficmointerid int,@fitemtype int
declare @fplanprice decimal(18,4),@fitemid int,@fpitemid int,@funitid int,@entryid int,@fqty int
declare @InterID int,@BillNo varchar (20),@FStockId int,@StockNumber varchar (20)
DECLARE @TmpID INT ,@fsupplyid int,@fcurrencyid int,@FMyPoInStockInterId int,@fscrap decimal(24,4)
declare @fsupplyno varchar(20),@forderdate datetime,@FValueAddRate decimal(28, 2),@FSendItemDate datetime
declare @iLength int,@FPrice decimal(28, 5),@FAmount decimal(20, 2),@FExchangeRate decimal(28, 10)
declare @FTaxPrice decimal(28, 5),@FTaxAmount decimal(20, 2),@SupplyId int,@FQtyScrap decimal(24,4)
declare @fprojectval varchar(200),@fspid int,@fempid int,@fdeptid int,@fqtymust decimal(24,2)
declare @FDateFormat varchar(200),@fdate datetime,@forginterid int,@FBomInputQty decimal(24,4)
declare @fsourceNumber varchar(200),@fpSourceNumber varchar(200),@fpXxSourceNumber varchar(200)
declare @fXxOldSourceNumber varchar(200),@empid int,@fsourcetrantype int
declare @FDCStockID int,@xx_FItemIDOld int,@fxxitemid int,@FOrgPPOInterID int
declare @FDCSPID int,@forderinterid int,@forderentryid int
declare @fsourceInterid int,@fsourceEntryid int,@fsourceBillNo varchar (100)
declare @fyear int,@fperiod int,@FMangerID int,@FSourceSEBillNo varchar (100),@FSourcePOBillNo varchar (100)
declare @fresultbillno varchar (800),@FPlanFinishDate datetime,@fnote varchar(500)
declare @ftempbillno varchar(50),@fcostobjid int,@fplancommitdate datetime,@fsourceid int
declare @fplanorderinterid int,@fbominterid int,@forgsaleinterid int,@forgentryid int
--AIS20041229163526   AIS20080129143619
--declare @fbout varchar(10),@fcommitdate datetime

select @fuserid=16394
select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期
set @forderdate=@fdate  --'2009-06-15' --下单日期
--set @fcommitdate='2009-07-21' --到货日期
select @fresultbillno='',@BillNo='',@InterID=0

create table #DataEntry(funitid int,fitemid int,FQtyScrap decimal(24,4),FBomInputQty  decimal(24,4),fscrap  decimal(24,4),fqtymust decimal(24,2),fstockid int)

declare @finterid int

DECLARE authors_cursor CURSOR FOR	
select distinct t0.finterid --,t0.fbillno
from icmo t0 
inner join t_icitem t7 on t0.fitemid=t7.fitemid 
inner join ppbomentry t9 on t9.ficmointerid=t0.finterid
inner join ppbom t10 on t10.finterid=t9.finterid
inner join t_icitem t11 on t11.fitemid=t9.fitemid
inner join t_measureunit t3 on t3.fitemid=t11.funitid
where t0.fstatus in (1,2)  and t11.fnumber like '1.02.%' and t9.fqty=0
and t9.fqtymust>0 --and t0.fbillno='ZP201311220'

OPEN authors_cursor

FETCH NEXT FROM authors_cursor 
INTO @ficmointerid

WHILE @@FETCH_STATUS = 0
BEGIN
	select @FItemId=t1.fitemid,@funitid=t1.funitid,@fqty=t1.fqty,@fcostobjid=t1.FCostObjID,
	@fsourceid=t1.fworkshop,@InterID=isnull(t2.finterid,0),@FSendItemDate=t1.fplancommitdate,
	@fplancommitdate=fplancommitdate,@FPlanFinishDate=FPlanFinishDate,@fnote=isnull(t1.fnote,''),
	@FSourcePOBillNo=t1.FHeadSelfJ0176,@FSourceSEBillNo=t1.FHeadSelfJ0177
	from icmo t1
	left join ppbom t2 on t2.ficmointerid=t1.finterid
	where t1.finterid=@ficmointerid

	delete from #DataEntry

	insert into #DataEntry(funitid,   fitemid,   FQtyScrap,        FBomInputQty,                fscrap,   fqtymust,                                                           fstockid)
	select t6.funitid,t6.fitemid,t1.fqty*t5.fqty FQtyScrap,t8.fqty*t1.fqty*t5.fqty FBomInputQty,(1+t1.fscrap)*t5.fscrap fscrap,cast((t8.fqty*t1.fqty*(1+t1.fscrap/100)*t5.fqty*(1+t5.fscrap/100)) as decimal(24,2)) fqtymust,isnull(t6.fdefaultloc,0) fstockid
	from icbomchild t1 
	inner join icbom t7 on t1.finterid=t7.finterid
	inner join t_icitem t2 on t7.fitemid=t2.fitemid 
	inner join t_measureunit t3 on t3.fitemid=t2.funitid
	inner join icmo t8 on t8.fitemid=t7.fitemid
	inner join t_icitem t9 on t9.fitemid=t1.fitemid  --半成品BOM的常规物料或包材(有些包材直接用在半成品上)
	inner join icbom t4 on t4.fitemid=t9.fitemid
	inner join icbomchild t5 on t5.finterid=t4.finterid
	inner join t_icitem t6 on t6.fitemid=t5.fitemid
	where t8.finterid=@ficmointerid and t7.fusestatus=1072 and isnull(t8.forderinterid,0)=0 
	and t9.fnumber like '1.02.%' and t6.fnumber like '6.%' --如果是套件,则展开到子件

	delete t1 
	from ppbomentry t1 
	inner join t_icitem t2 on t1.fitemid=t2.fitemid
	where t1.finterid=@InterID and t2.fnumber like '1.02.%'

	select @entryid=isnull(max(fentryid),0)+1 from ppbomentry where finterid=@InterID

	DECLARE authorsentry_cursor CURSOR FOR
	select t1.funitid,t1.fitemid,t1.FQtyScrap,t1.FBomInputQty,t1.fscrap,t1.fqtymust,t1.fstockid 
	from #DataEntry t1 
	inner join t_icitem t2 on t1.fitemid=t2.fitemid
	order by t2.fnumber
		
	OPEN authorsentry_cursor

	FETCH NEXT FROM authorsentry_cursor 
	INTO @funitid,@fitemid,@FQtyScrap,@FBomInputQty,@fscrap,@fqtymust,@fstockid

	WHILE @@FETCH_STATUS = 0
	BEGIN 
		--icmo fstatus 5 确认 0 计划 1,2 下达 3 结案  fmrp 11061 mps产生 1052 手工录入 11077 mrp产生 
		--ppbomentry fqtyscrp 单位用量  FScrap 损耗率
		Insert Into PPBOMEntry (FEntrySelfY0259,fentryselfy0257,FICMOinterID,   FBrNo,FInterID,FEntryID,FItemID, FUnitID, FAuxQtyMust,FAuxQty,FMachinePos,FBomInputAuxQty,FauxQtyLoss,FSequenceID,FStockID, FNote,FSourceEntryID,FAuxQtyScrap,FScrap,  FSendItemDate,  FAuxQtyPick,  FSPID,FOperID,FOperSN,FMaterielType,FBackFlush,FMarshalType,FBOMInterID,FBatchNO )
		Values (                @fitemtype,     @fcostobjid,    @ficmointerid,  '0',  @Interid,@entryid,@fitemid,@funitid,@fqtymust,  0,      '',         @FBomInputQty,  0,          '',         @fstockid,'',   0,             @FQtyScrap,  @fscrap, @FSendItemDate, @FBomInputQty,0,    0,      0,      371,          1059,      385,         0,          '')

		set @entryid=@entryid+1

		FETCH NEXT FROM authorsentry_cursor 
		INTO @funitid,@fitemid,@FQtyScrap,@FBomInputQty,@fscrap,@fqtymust,@fstockid
	END

	CLOSE authorsentry_cursor
	DEALLOCATE authorsentry_cursor


	EXEC prc_SHUpdateBillDoubleQty 88,@Interid

    FETCH NEXT FROM authors_cursor 
    INTO @ficmointerid
END

CLOSE authors_cursor
DEALLOCATE authors_cursor


drop table #DataEntry

go


--子件收料申请初始化
declare @finterid int
DECLARE authors_cursor CURSOR FOR	
select distinct t1.finterid
from poorder t1
inner join poorderentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
where t1.fstatus>0 and t3.fnumber like '1.02.%'
and t2.fcommitqty=0 and t2.finterid not in (select finterid from poorderentry where fcommitqty>0)

OPEN authors_cursor

FETCH NEXT FROM authors_cursor 
INTO @finterid

WHILE @@FETCH_STATUS = 0
BEGIN
	exec My_p_GeneratePlasticPoInStock @finterid,16394,0,0 	

    FETCH NEXT FROM authors_cursor 
    INTO @finterid
END

CLOSE authors_cursor
DEALLOCATE authors_cursor

--批量审核和使用BOM
select t2.fnumber,t2.fname
--Update t1 Set FUseStatus=1072,FStatus = 1, FCheckerID = 16398, FAudDate = Convert(Varchar(10),Getdate(),120), FBeenChecked = 1
from ICBOM t1
inner join t_icitem t2 on t1.fitemid=t2.fitemid
where t2.fnumber like '1.02.%' --isnull(t1.FCheckerID,0)=0 

--计划禁用
SELECT t10.fname+'[计划禁用]',t10.fdeleted,
t0.FItemID,t0.FModel,t0.FName,t0.FHelpCode,t0.FDeleted,t0.FShortNumber,t0.FNumber,
t1.FErpClsID,t1.FUnitID,t1.FUnitGroupID,t1.FDefaultLoc
--update t10 set fname=t10.fname+'[计划禁用]'
--update t0 set fname=t0.fname+'[计划禁用]'
FROM t_ICItemCore t0
LEFT JOIN t_ICItemBase t1 ON t0.FItemID=t1.FItemID
inner join t_icitem t9 on t9.fitemid=t0.fitemid
inner join t_item t10 on t9.fitemid=t10.fitemid
inner join sheet1$ t11 on t11.fshortnumber=t9.fshortnumber

--塑胶子件成套数--
set nocount on

select identity(int,1,1) as 序号,*
into #t1
from
(
	SELECT t3.fnumber 编码,t3.fname 名称,t3.fmodel 规格型号,
	0 库存成套数,0 待成检套数,
	t4.fnumber 子件编码,t4.fname 子件名称,t4.fmodel 子件规格型号,t6.fname 单位,
	t8.fqty 单位用量,isnull(t2.fqty,0) 子件库存,isnull(t5.fqty,0) 子件待检,
	isnull(t2.fqty,0)/t8.fqty 单项库存可配套数,
	isnull(t5.fqty,0)/t8.fqty 单项待检可配套数
	from t_icitem t3  --套件
	inner join icbom t7 on t3.fitemid=t7.fitemid
	inner join icbomchild t8 on t7.finterid=t8.finterid
	inner join t_icitem t4 on t8.fitemid=t4.fitemid --子件
	left join (select fitemid,sum(fqty) fqty from icinventory where FStockID not in (16478,16572,16573,20355,20652) and fqty>0 group by fitemid) t2 on t2.fitemid=t4.fitemid  --库存
	left join (select fitemid,sum(fqty) fqty from poinventory where FStockID not in (16478,16572,16573,20355,20652) and fqty>0 group by fitemid) t5 on t5.fitemid=t4.fitemid  --待检
	inner join t_measureunit t6 on t6.fitemid=t4.funitid
	where t3.fnumber like '1.02.%' and t4.fnumber like '6.%' AND t3.fnumber like '%@@ItemNumber@@%'
) t1 order by 编码,子件编码

--select * from #t1 where 编码 like '%060063%'

update t1 set 库存成套数=t2.单项库存可配套数,待成检套数=t2.单项待检可配套数
from #t1 t1
inner join (select 编码,min(序号) 序号,min(单项库存可配套数) 单项库存可配套数,min(单项待检可配套数) 单项待检可配套数 from #t1 group by 编码) t2 on t1.编码=t2.编码
where t1.序号=t2.序号 

update t1 set 编码='',名称='',规格型号='',库存成套数=null,待成检套数=null
from #t1 t1
left join (select 编码,min(序号) 序号 from #t1 group by 编码) t2 on t1.编码=t2.编码
where t1.序号<>t2.序号 

select * FROM #t1 order by 序号

drop table #t1

set nocount off

--delete from ICBomGroup

--新增BOM组别
declare @finterid int,@s varchar(500),@fnumber varchar(50),@fname varchar(500)
declare @FParentNumber varchar(50),@FParentID int,@FBootID int

DECLARE icbom_cursor CURSOR FOR	
select t1.fnumber,t1.fname 
from t_item t1
left join ICBomGroup t2 on t1.fnumber=t2.fnumber
where t1.fitemclassid=4 and left(t1.fnumber,1) in ('3','4','5','A','P','R','Q','J','X','Y','V') and t1.fdetail=0 
and t2.fnumber is null
order by t1.fnumber

OPEN icbom_cursor

FETCH NEXT FROM icbom_cursor 
INTO @fnumber,@fname

WHILE @@FETCH_STATUS = 0
BEGIN 
	if not exists(select 1 from ICBomGroup where fnumber=@fnumber)
	begin
		set @finterid=0
		SELECT @finterid=isnull(FMaxNum,0) FROM ICMaxNum WHERE FTableName='ICBOMGroup'
		set @finterid=@finterid+1

		if CHARINDEX('.',@fnumber)=0
		begin
			select @FParentID=0,@FBootID=@finterid
		end
		else
		begin
			select @FParentNumber=REVERSE(right(REVERSE(@fnumber),len(@fnumber)-CHARINDEX('.',REVERSE(@fnumber))))
			select @FParentID=FInterID,@FBootID=finterid from ICBomGroup where fnumber=@FParentNumber
		end

		INSERT INTO ICBomGroup (FInterID, FNumber, FName, FParentID, FBootID) 
		VALUES (				@finterid,@fnumber,@fname,@FParentID,@FBootID)

		UPDATE ICMaxNum SET FMaxNum=@finterid WHERE FTableName='ICBOMGroup'
	end

	FETCH NEXT FROM icbom_cursor 
    INTO @fnumber,@fname
END

CLOSE icbom_cursor
DEALLOCATE icbom_cursor

--BOM组别更新
select t3.fnumber,left(t3.fnumber,len(t3.fnumber)-1)
--update t3 set fnumber=left(t3.fnumber,len(t3.fnumber)-1)
from ICBomGroup t3
where right(t3.fnumber,1) in (char(10),char(13),char(32))

select t1.fnumber,t1.fname,t3.fnumber,
REVERSE(right(REVERSE(t1.fnumber),len(t1.fnumber)-CHARINDEX('.',REVERSE(t1.fnumber)))) ,t4.fnumber
--update t2 set fparentid=t4.finterid
from t_icitem t1
inner join icbom t2 on t1.fitemid=t2.fitemid
inner join ICBomGroup t3 on t2.FParentID =t3.finterid
inner join ICBomGroup t4 on t4.fnumber=REVERSE(right(REVERSE(t1.fnumber),len(t1.fnumber)-CHARINDEX('.',REVERSE(t1.fnumber)))) 
where REVERSE(right(REVERSE(t1.fnumber),len(t1.fnumber)-CHARINDEX('.',REVERSE(t1.fnumber))))<>t3.fnumber
and t1.fnumber not like 'r%'

select t1.fnumber,t1.fname,t13.fnumber,
REVERSE(right(REVERSE(t1.fnumber),len(t1.fnumber)-CHARINDEX('.',REVERSE(t1.fnumber)))) ,t14.fnumber
--update t2 set fparentid=t14.finterid
from t_icitem t1
inner join icbom t2 on t1.fitemid=t2.fitemid
inner join t_item t13 on t1.FParentID=t13.fitemid
inner join ICBomGroup t14 on t14.fnumber=t13.fnumber
where t2.fparentid<>t14.finterid

--塑胶子件不进行批次管理
SELECT 
t0.FItemID,t0.FModel,t0.FName,t0.FHelpCode,t0.FDeleted,t0.FShortNumber,t0.FNumber,
t1.FErpClsID,t1.FUnitID,t1.FUnitGroupID,t1.FDefaultLoc
--update t2 set FBatchManager=0  --批次管理
FROM t_ICItemCore t0
LEFT JOIN t_ICItemBase t1 ON t0.FItemID=t1.FItemID
inner join t_ICItemMaterial t2 on t2.fitemid=t1.fitemid
inner join t_icitem t9 on t9.fitemid=t0.fitemid
where t9.fnumber like '6.%' and t2.FBatchManager=1

--塑胶子件默认仓库
SELECT 
t0.FItemID,t0.FModel,t0.FName,t0.FHelpCode,t0.FDeleted,t0.FShortNumber,t0.FNumber,
t1.FErpClsID,t1.FUnitID,t1.FUnitGroupID,t1.FDefaultLoc
--update t1 set FDefaultLoc=39615  --塑胶子件仓(实仓)
--update t7 set F_116=0  --单位用量清0
FROM t_ICItemCore t0
LEFT JOIN t_ICItemBase t1 ON t0.FItemID=t1.FItemID
inner join t_icitem t9 on t9.fitemid=t0.fitemid
inner join t_ICItemCustom AS t7 ON t0.FItemID = t7.FItemID 
where t9.fnumber like '6.%' 



--塑胶件物料属性--
SELECT 
t0.FItemID,t0.FModel,t0.FName,t0.FHelpCode,t0.FDeleted,t0.FShortNumber,t0.FNumber,
t1.FErpClsID,t1.FUnitID,t1.FUnitGroupID,t1.FDefaultLoc
--update t1 set FErpClsID=5  --虚拟件
FROM t_ICItemCore t0
LEFT JOIN t_ICItemBase t1 ON t0.FItemID=t1.FItemID
inner join t_icitem t9 on t9.fitemid=t0.fitemid
where t9.fnumber like '1.02.%' 


--套件导入BOM--
select t4.fdefaultloc,t14.FInterID fbomgroupid,t4.funitid,t4.fitemid,t3.fitemid fproductid,(case when isnull(t4.F_116,0)=0 then 1 else t4.F_116 end) fqty
into #data
from t_icitem t3  --套件
inner join t_icitem t4 on Charindex(t3.fshortnumber,t4.fnumber)>0  --t3.fshortnumber=substring(t4.fnumber,6,6) --子件
inner join t_item t13 on t3.FParentID=t13.fitemid
inner join ICBomGroup t14 on t14.fnumber=t13.fnumber
where t3.fnumber like '1.02.%' and t4.fnumber like '6.%' 
and not exists(select 1 from icbom where fitemid=t3.fitemid)
and t3.fdeleted=0 and t4.fdeleted=0
order by t3.fnumber,t4.fnumber


select t4.fdefaultloc,t14.FInterID fbomgroupid,t4.funitid,t4.fitemid,t3.fitemid fproductid,cast(t1.数量 as decimal(24,5)) fqty
into #data
from sheet3$ t1
inner join t_icitem t3 on REVERSE(left(REVERSE(t1.成品代码),CHARINDEX('.',REVERSE(t1.成品代码))-1))=t3.fshortnumber --父件
inner join t_icitem t4 on REVERSE(left(REVERSE(t1.物料),CHARINDEX('.',REVERSE(t1.物料))-1))=t4.fshortnumber --子件
inner join t_item t13 on t3.FParentID=t13.fitemid
inner join ICBomGroup t14 on t14.fnumber=t13.fnumber
where not exists(select 1 from icbom where fitemid=t3.fitemid)
and t3.fdeleted=0 and t4.fdeleted=0
order by t3.fnumber,t4.fnumber

--drop table #data drop table #mybom drop table #mybomchild

declare @fmaxnum int,@fdate datetime,@fmaxbill int,@fmaxbillno varchar

select @fmaxnum=fmaxnum from icmaxnum where ftablename='icbom'

select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')
select @fmaxbill=cast(max(right(FBomNumber,6)) as int) from icbom where FBomNumber like 'BOM%'

create table #mybom(fid int identity(1,1),fproductid int,fbomgroupid int)

insert into #mybom(fproductid,fbomgroupid)
select distinct    fproductid,fbomgroupid 
from #data t1 

--select fproductid,fbrandid from #mybom group by fproductid,fbrandid having count(1)>1
--select * from #mybom 

INSERT INTO ICBom(FInterID,        FBomNumber,                                                             FItemID,      FOperatorID,FEnterTime,FBrNo,FTranType,FCancellation,FStatus,FVersion,FUseStatus,FUnitID,   FAuxPropID,FAuxQty,fqty,FYield,FNote,FCheckID,FCheckDate,FRoutingID,FBomType,FCustID,FParentID,     FAudDate,FImpMode,FPDMImportDate,FBOMSkip) 
select            @fmaxnum+t1.fid,'BOM'+left('000000',6-len(@fmaxbill))+cast(@fmaxbill+t1.fid as varchar), t1.fproductid,16394,      @fdate,    '0',  50,       0,            0,      '',      1073,      t2.FUnitID,0,         1,      1,   100,   '',   0,       null,      0,         0,       0,      t1.fbomgroupid,null,    0,       null,          1059
from #mybom t1
inner join t_icitem t2 on t1.fproductid=t2.fitemid
order by t1.fid

--delete from t_bospacksub  delete from t_bospacksubentry

create table #mybomchild(fid int,fentryid int identity(1,1),fitemid int,funitid int,fqty decimal(28,1),fdefaultloc int)

insert into #mybomchild(fid,  fitemid,  funitid,  fqty,  fdefaultloc)
select                  a.fid,b.fitemid,b.funitid,b.fqty,b.fdefaultloc
from #mybom a 
inner join #data b on a.fproductid=b.fproductid 

--select * from #mybomchild order by fid

INSERT INTO ICBomChild (FInterID,      FEntryID,FBrNo,FItemID,      FMachinePos,FNote,FAuxQty, FScrap,FOffSetDay,FUnitID,  FQty,  FMaterielType,FMarshalType,FBeginDay,   FEndDay,     FPercent,FPositionNo,FItemSize,FItemSuite,FOperSN,FOperID,FBackFlush,FStockID,     FSPID,FAuxPropID,FPDMImportDate,FDetailID) 
select                  @fmaxnum+a.fid,
								       (select count(fentryid) from #mybomchild where fid=a.fid and fentryid<=a.fentryid),
												'0',  a.fitemid,    '',         '',   a.fqty,  0,     0,         a.FUnitID,a.fqty,371,          385,         '1900-01-01','2100-01-01',100,     '',         '',       '',        '',     0,      1059,      a.fdefaultloc,0,    0,         null,          NEWID() 
from #mybomchild a 
order by a.fid,a.fentryid

update icmaxnum set fmaxnum=(select max(finterid) from icbom) where ftablename='icbom'

drop table #data drop table #mybom drop table #mybomchild

go


select * from t_stock
select t3.fentryid,t1.fitemid,t3.fitemid,t3.fqty,t3.*
--update t3 set fscrap=1 from icbomchild t3 where finterid=1807 and fentryid=8 update t3 set fscrap=0 from icbomchild t3 where finterid=1807 and fentryid=9
from icbom t1
inner join t_icitem t2 on t1.fitemid=t2.fitemid
inner join icbomchild t3 on t1.finterid=t3.finterid
inner join t_icitem t4 on t3.fitemid=t4.fitemid
where t2.fnumber like '%300222' and t3.fentryid in (8,9)

select t1.fscrap,t2.fscrap
--update t1 set fscrap=t2.fscrap
from icbomchild t1
inner join test.dbo.icbomchild t2 on t1.finterid=t2.finterid and t1.fentryid=t2.fentryid
where t1.fentryid in (8,9)


select t3.fscrap,t2.fnumber,t2.fname,t4.fnumber,t4.fname
--update t3 set fscrap=1
from icbom t1
inner join t_icitem t2 on t1.fitemid=t2.fitemid
inner join icbomchild t3 on t1.finterid=t3.finterid
inner join t_icitem t4 on t3.fitemid=t4.fitemid
where t2.fnumber like '3.%'
and t4.fnumber like '1.01.0009%'



--没有成本对象
select t2.fitemid,t1.fcostobjid,* 
--update t1 set fcostobjid=t2.fitemid
from icmo t1
inner join t_icitem t3 on t1.fitemid=t3.fitemid
inner join cbcostobj t2 on t1.fitemid=t2.fstdproductid
where isnull(t1.fcostobjid,0)=0
and t1.fbillno='zp201608101'

select t2.fitemid,t2.fstdproductid,t1.fcostobjid,* 
--update t1 set fcostobjid=t2.fitemid
from icmo t1
inner join t_icitem t3 on t1.fitemid=t3.fitemid
inner join cbcostobj t2 on t2.fnumber=t3.fnumber
where isnull(t1.fcostobjid,0)=0
and t1.fbillno='zp201608101'

update m2 set FEntrySelfY0257=m1.fcostobjid --FEntrySelfY0257=m2.FAuxQtyMust-m2.FAuxQty
from ppbomentry m2 
inner join ppbom m3 on m2.finterid=m3.finterid
inner join icmo m1 on m1.finterid=m2.ficmointerid
where isnull(m2.FEntrySelfY0257,0)=0

select t2.fitemid,t1.fcostobjid,* 
--update t3 set fcostobjid=t1.fcostobjid
from icmo t1
--inner join cbcostobj t2 on t1.fitemid=t2.fstdproductid
inner join icstockbillentry t3 on t3.ficmointerid=t1.finterid
inner join icstockbill t4 on t3.finterid=t4.finterid and t4.ftrantype=24
where isnull(t3.fcostobjid,0)=0

--采购订单行业务关闭按钮不见
select t_MenuToolBar.*
--update t_MenuToolBar set FVisible=1
FROM dbo.t_BandToolMapping INNER JOIN
      dbo.t_MenuBand ON 
      dbo.t_BandToolMapping.FBandID = dbo.t_MenuBand.FBandID INNER JOIN
      dbo.t_MenuFunctionMapping ON 
      dbo.t_BandToolMapping.FID = dbo.t_MenuFunctionMapping.FMenuGroupID LEFT OUTER
       JOIN
      dbo.t_MenuBand t_MenuBand_1 ON 
      dbo.t_BandToolMapping.FSubBandID = t_MenuBand_1.FBandID LEFT OUTER JOIN
      dbo.t_MenuToolBar ON 
      dbo.t_BandToolMapping.FToolID = dbo.t_MenuToolBar.FToolID
where t_MenuFunctionMapping.FMenuGroupID = 81 --order by FBandID,FIndex
and t_MenuToolBar.fname in ('BizClosed','BizUnClosed') and t_MenuBand.FStyle=4

--初始化投料单MRP类型
select t4.fnumber,t4.fname,t4.fdefaultloc,t3.fstockid,t5.fname,t6.fname
--update t3 set FEntrySelfY0259=0
from icmo t1 
inner join seorder t2 on t1.forderinterid=t2.finterid
inner join ppbomentry t3 on t1.finterid=t3.ficmointerid
inner join t_icitem t4 on t3.fitemid=t4.fitemid
inner join t_stock t5 on t5.fitemid=t4.fdefaultloc
inner join t_stock t6 on t6.fitemid=t3.fstockid
inner join t_icitem t7 on t1.fitemid=t7.fitemid
where t3.FEntrySelfY0259 is null and t4.fnumber not like '2.%' and left(t7.fnumber,1) in ('A','P')

--更新投料单发料仓库
select t4.fnumber,t4.fname,t4.fdefaultloc,t3.fstockid,t5.fname,t6.fname
--update t3 set t3.fstockid=t4.fdefaultloc
from icmo t1 
inner join seorder t2 on t1.forderinterid=t2.finterid
inner join ppbomentry t3 on t1.finterid=t3.ficmointerid
inner join t_icitem t4 on t3.fitemid=t4.fitemid
inner join t_stock t5 on t5.fitemid=t4.fdefaultloc
inner join t_stock t6 on t6.fitemid=t3.fstockid
where t2.fbillno='XW1306081' and t4.fdefaultloc<>t3.fstockid

--更新投料单发料仓库
select t4.fnumber,t4.fname,t4.fdefaultloc,t3.fstockid,t5.fname,t6.fname
--update t3 set t3.fstockid=t4.fdefaultloc
from icmo t1 
left join seorder t2 on t1.forderinterid=t2.finterid
inner join ppbomentry t3 on t1.finterid=t3.ficmointerid
inner join t_icitem t4 on t3.fitemid=t4.fitemid
left join t_stock t5 on t5.fitemid=t4.fdefaultloc
left join t_stock t6 on t6.fitemid=t3.fstockid
where isnull(t3.fstockid,0)=0

--采购订单
select t1.fbillno,t4.fheadselfp0238
--update t4 set fheadselfp0238=t1.fbillno
from seorder t1
inner join seorderentry t2 on t1.finterid=t2.finterid
inner join poorderentry t3 on t2.finterid=t3.fsourceinterid and t2.fentryid=t3.fsourceentryid and t3.fsourcetrantype=81
inner join poorder t4 on t4.finterid=t3.finterid

--初始化主供应商
update t2 set fentryselfs0176=t3.F_117
from seorder t1
inner join seorderentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid

update t2 set fentryselfs0175=40089  
from seorder t1
inner join seorderentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
where isnull(t2.fentryselfs0176,0)=25952 and isnull(t2.fentryselfs0175,0)=0

update t4 set fheadselfj0180=25952
from seorder t1
inner join seorderentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join icmo t4 on t4.forderinterid=t2.finterid and t4.fsourceentryid=t2.fentryid
where isnull(t2.fentryselfs0175,0) not in (40090,40091)

update t4 set fheadselfj0182=40089
from seorder t1
inner join seorderentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join icmo t4 on t4.forderinterid=t2.finterid and t4.fsourceentryid=t2.fentryid
where isnull(t2.fentryselfs0175,0) not in (40090,40091)

select *
--delete t1
from my_t_Mrp t1 
where t1.frunid not in (select frunid from My_t_MrpRoughNeedSource)
and t1.frunid not in (select isnull(FHeadSelfJ0175,0) from icmo)
and t1.frunid not in (select frunid from my_t_MrpResultDetail)
and t1.frunid not in (select frunid from my_t_MrpStock)

--销售订单排产初始化

select finterid into #data from seorder where FHeadSelfS0148>='2015-04-22'

update t2 set fdate=t1.FHeadSelfS0148
from seorder t1
inner join seorderentry t2 on t1.finterid=t2.finterid
where t2.finterid in (select finterid from #data)

delete t1
from my_t_scheduledetail t1
inner join icmo t2 on t1.ficmointerid=t2.finterid
inner join seorderentry t3 on t2.forderinterid=t3.finterid and t2.fsourceentryid=t3.fentryid
where t3.finterid in (select finterid from #data)

insert into my_t_scheduledetail (fdate,                                                              fbillerid, fsourcetrantype, ficmointerid, funitid,   fitemid,   fdeptid,     fqty,                 fnote)
select                           case when t3.fdate<'2015-04-22' then '2015-04-22' else t3.fdate end,16394,     85,              t2.FInterId,  t2.funitid,t2.fitemid,t2.fworkshop,t2.fqty-t2.FQtyFinish,''
from icmo t2 
inner join seorderentry t3 on t2.forderinterid=t3.finterid and t2.fsourceentryid=t3.fentryid
where t3.fmrpclosed=0 and t3.finterid in (select finterid from #data)


--物料修改记录表
select t1.fnumber 编码,t1.fname 名称,t1.fmodel 规格型号,
t1.fmodel 规格型号,isnull(t1.f_105,'') 描述,isnull(t1.f_106,'') 适用机型,
isnull(t13.fname,'') 外盒尺寸,t2.fcreatedate 创建时间,t2.fcreateuser 创建人,
t2.flastmoddate 最后修改时间,t2.flastmoduser 最后修改人,t2.fdeletedate 禁用时间,t2.fdeleteuser 禁用人
from t_icitem t1
inner join t_baseproperty t2 on t1.fitemid=t2.fitemid
left join t_item t13 on t13.fitemid=t1.F_103 and t13.fitemclassid=3004  --外盒尺寸
where replace(convert(varchar(10),isnull(t2.flastmoddate,t2.fcreatedate),111),'/','-')>='********'
and replace(convert(varchar(10),isnull(t2.flastmoddate,t2.fcreatedate),111),'/','-')<='########'
order by t1.fnumber


--包装方式+产品重复
select t2.fnumber,t2.fname,t2.fmodel,t3.fnumber,t3.fname,t1.fproductid,t1.fbrandid
from t_BOSPackSub t1 
inner join t_icitem t2 on t1.fproductid=t2.fitemid
inner join t_item t3 on t3.fitemid=t1.fbrandid
group by t2.fnumber,t2.fname,t2.fmodel,t3.fnumber,t3.fname,t1.fproductid,t1.fbrandid 
having count(1)>1 order by t2.fnumber

--批量反审核包装方案
declare @finterid int,@fbillno varchar(50)

DECLARE icbom_cursor CURSOR FOR	
select t1.fid,t1.fbillno
from t_BOSPackSub t1 
inner join t_item t3 on t3.fitemid=t1.fbrandid
where t3.fname like '%诚威通用%' and isnull(t1.FChecker,0)>0

OPEN icbom_cursor

FETCH NEXT FROM icbom_cursor 
INTO @finterid,@fbillno

WHILE @@FETCH_STATUS = 0
BEGIN 
	Update ICClassCheckStatus200000005 Set FBillID = FBillID  Where FBillID = @finterid And FPage = 1 And FBillEntryID = 0

	Insert Into ICClassCheckRecords200000005(FPage,FBillID,  FBillEntryID,FBillNo, FBillEntryIndex,FCheckLevel,FCheckLevelTo,FMode,FCheckMan, FCheckIdea,FCheckDate,FDescriptions)  Values 
											(1,    @finterid,0,           @fbillno,0,              -1,         1,            2,    16394,     '',        GetDate(), '驳回')

	Update ICClassCheckStatus200000005 Set  FBillNo = @fbillno, FCurrentLevel = FCurrentLevel - 1, FCheckMan1 = 0, FCheckDate1 = Null, FCheckIdea1 = '' Where FBillID = @finterid And FPage = 1 And FBillEntryID = 0

	Update t_BOSPackSub Set 
	FChecker =  0 ,FCheckDate =  Null 
	Where FClassTypeID=200000005
	And FID = @finterid

	FETCH NEXT FROM icbom_cursor 
    INTO @finterid,@fbillno
END

CLOSE icbom_cursor
DEALLOCATE icbom_cursor

go

--任务单生产拉线更新
declare @finterid int,@s varchar(500)

DECLARE icbom_cursor CURSOR FOR	
select finterid from icstockbill where ftrantype=2

OPEN icbom_cursor

FETCH NEXT FROM icbom_cursor 
INTO @finterid

WHILE @@FETCH_STATUS = 0
BEGIN 
	set @s=''
	select @s=t1.fname from icstockbill t3	inner join t_Item_3008 t1 on t1.fitemid=t3.fheadselfa0229 where t3.finterid=@finterid

	if @s<>''
	begin
		update t1 set fheadselfj0181=isnull(t1.fheadselfj0181,'')+','+@s
		from icmo t1
		inner join 
		(
			select t1.ficmointerid
			from icstockbill t3
			inner join icstockbillentry t1 on t1.finterid=t3.finterid
			where t3.finterid=@finterid
			group by t1.ficmointerid
		) t2 on t1.finterid=t2.ficmointerid
		where Charindex(@s,isnull(t1.fheadselfj0181,''))<=0
	end
	FETCH NEXT FROM icbom_cursor 
    INTO @finterid
END

CLOSE icbom_cursor
DEALLOCATE icbom_cursor

--日志查询
select t2.fname,t1.* from t_log t1 inner join t_user t2 on t1.fuserid=t2.fuserid 
where t1.fdescription like '%sout%23735%' 
union all
select t2.fname,t1.* from t_logbak t1 inner join t_user t2 on t1.fuserid=t2.fuserid 
where t1.fdescription like '%sout%23735%' 


--计划日期错误
select * 
--update t1 set fdate='2013-06-05'
from my_t_scheduledetail t1 where fdate>'2013-06-05'

--币别错误
--select * from t_currency  --select fname,* from t_organization

select t1.fbillno,t3.fname,t1.fcurrencyid,t2.fname,t1.*
--update t1 set fcurrencyid=1000
--update t1 set fcustid=16705
from seorder t1 
inner join t_organization t2 on t1.fcustid=t2.fitemid
inner join t_currency t3 on t3.fcurrencyid=t1.fcurrencyid
where t1.fbillno in ('PISA1305LAI01')
t1.fbillno like '%28%'

update t1 set fstatus=1 from icmo t1 where fbillno in ('work000296','work000297')

select * 
--update t1 set ficmobillno=t1.fsourcebillno,ficmointerid=t1.fsourceinterid,fppbomentryid=t1.fsourceentryid
from ZPStockBillEntry t1
where fsourcetrantype=85 

--是否倒冲

update icbomchild set FBackFlush=1059
update ppbomentry set FBackFlush=1059

--虚仓出库任务单内码
update ZPStockBillEntry set FEntrySelfZOU30=ficmointerid,FEntrySelfZOU31=fppbomentryid,FEntrySelfZOU32=ficmobillno

--塑胶子件批次管理

declare @fbatchno varchar(50),@fitemid int,@fstockid int

DECLARE authorsentry2_cursor CURSOR FOR
select t1.fbatchno,t1.fitemid,t1.fstockid
from POInvBal t1 
inner join t_icitem t2 on t1.fitemid=t2.fitemid 
where t2.fnumber like '6.%' and t1.fyear=2013 and t1.fperiod=3
	
OPEN authorsentry2_cursor

FETCH NEXT FROM authorsentry2_cursor 
INTO @fbatchno,@fitemid,@fstockid

WHILE @@FETCH_STATUS = 0
BEGIN 
	update t1 set fbatchno='999'
	from POInvBal t1 
	inner join t_icitem t2 on t1.fitemid=t2.fitemid 
	where t2.fnumber like '6.%' and t1.fyear=2013 and t1.fperiod=3 and t1.fitemid=@fitemid
	and t1.fstockid=@fstockid

	FETCH NEXT FROM authorsentry2_cursor 
	INTO @fbatchno,@fitemid,@fstockid
END

CLOSE authorsentry2_cursor
DEALLOCATE authorsentry2_cursor

go

select t1.fbatchno,t1.fitemid,t1.fstockid
--delete t1
from POInvBal t1 
inner join t_icitem t2 on t1.fitemid=t2.fitemid 
where t2.fnumber like '6.%' and t1.fyear=2013 and t1.fperiod=3 and t1.fitemid=17779
and isnull(t1.fbatchno,'')='0'

update t1 set fbatchno='999'
from POInvBal t1 
inner join t_icitem t2 on t1.fitemid=t2.fitemid 
where t2.fnumber like '6.%' and t1.fyear=2013 and t1.fperiod=3 

update t1 set fbatchno='999'
from zpstockbillentry t1 
inner join t_icitem t2 on t1.fitemid=t2.fitemid 
inner join zpstockbill t3 on t1.finterid=t3.finterid
where t2.fnumber like '6.%' and year(t3.fdate)=2013 and month(t3.fdate)=3

--投料单关联错误--选单数
select t3.fbillno,t0.fbillno,t1.ficmointerid,t1.fppbomentryid,t1.fitemid,t1.fqty fqty,t1.fsourcetrantype,t1.fsourcebillno,t1.fsourceinterid,t1.fsourceentryid,t1.*
--update t1 set ficmointerid=t1.fsourceinterid,fppbomentryid=t1.fsourceentryid
from ICStockBill t0 --
inner join ICStockBillEntry t1 on t0.finterid=t1.finterid  --
inner join t_BOSBackOrOutStockEntry t2 on t2.fid=t1.fsourceinterid and t1.fsourceentryid=t2.fentryid
inner join ppbomentry t4 on t4.finterid=t2.fid_src and t4.fentryid=t2.fentryid_src
inner join icmo t3 on t3.finterid=t4.ficmointerid
where t0.ftrantype=24 --and t0.fbillno='ZOUT000548' 
and t1.fsourcetrantype in (200000014) and isnull(t1.ficmointerid,0)=0 
and isnull(t1.fsourceinterid,0)<>0 

--如果是直接在后台加上的字段，则K3前台界面保存时，会丢掉值，要改成利用K3自定义界面增加
select t3.fbillno,t0.fbillno,t1.FEntrySelfZOU30 ficmointerid,t1.FEntrySelfZOU31 fppbomentryid,t1.fitemid,t1.fqty fqty,t1.fsourcetrantype,t1.fsourcebillno,t1.fsourceinterid,t1.fsourceentryid,t1.*
--update t1 set FEntrySelfZOU30=t1.fsourceinterid,FEntrySelfZOU31=t1.fsourceentryid
from ZPStockBill t0 --
inner join ZPStockBillEntry t1 on t0.finterid=t1.finterid  --
inner join icmo t3 on t3.finterid=t1.FSourceInterId
where t0.ftrantype=26 --and t0.fbillno='ZOUT000548' 
and t1.fsourcetrantype in (85) and isnull(t1.FEntrySelfZOU30,0)=0 
and isnull(t1.fsourceinterid,0)<>0 

select t3.fbillno,t0.fbillno,t1.FEntrySelfZOU30 ficmointerid,t1.FEntrySelfZOU31 fppbomentryid,t1.fitemid,t1.fqty fqty,t1.fsourcetrantype,t1.fsourcebillno,t1.fsourceinterid,t1.fsourceentryid,t1.*
--update t1 set FEntrySelfZOU30=,FEntrySelfZOU31=
from ZPStockBill t0 --
inner join ZPStockBillEntry t1 on t0.finterid=t1.finterid  --
inner join t_BOSBackOrOutStockEntry t2 on t2.fid=t1.fsourceinterid and t1.fsourceentryid=t2.fentryid
inner join ppbomentry t4 on t4.finterid=t2.fid_src and t4.fentryid=t2.fentryid_src
inner join icmo t3 on t3.finterid=t4.ficmointerid
where t0.ftrantype=26 --and t0.fbillno='ZOUT000548' 
and t1.fsourcetrantype in (200000014) and isnull(t1.FEntrySelfZOU30,0)=0 
and isnull(t1.fsourceinterid,0)<>0 

--投料单关联错误--选单数
select t3.FCheckDate,t3.fbillno,t4.fnumber,t4.fname,t4.fmodel,t1.fqty,isnull(t2.fqty,0) fselectqty
--update t1 set fqty=isnull(t2.fqty,0),fauxqty=isnull(t2.fqty,0)
from PPBOMEntry t1 --
left join 
(
	select t1.FEntrySelfZOU30 ficmointerid,t1.FEntrySelfZOU31 fppbomentryid,t1.fitemid,sum(t1.fqty) fqty
	from ZPStockBill t0 --
	inner join ZPStockBillEntry t1 on t0.finterid=t1.finterid  --
	inner join icmo t3 on t3.finterid=t1.FEntrySelfZOU30
	where t0.ftrantype=26 and t1.fsourcetrantype in (85,200000014)
	group by t1.FEntrySelfZOU30,t1.FEntrySelfZOU31,t1.fitemid
	union all
	select t1.ficmointerid,t1.fppbomentryid,t1.fitemid,sum(t1.fqty) fqty
	from ICStockBill t0 --
	inner join ICStockBillEntry t1 on t0.finterid=t1.finterid  --
	inner join icmo t3 on t3.finterid=t1.ficmointerid
	where t0.ftrantype=24 and t1.fsourcetrantype in (85,200000014)
	group by t1.ficmointerid,t1.fppbomentryid,t1.fitemid
) t2 on t1.ficmointerid=t2.ficmointerid and t1.FEntryID=t2.fppbomentryid and t1.fitemid=t2.fitemid
inner join icmo t3 on t1.ficmointerid=t3.finterid
inner join t_icitem t4 on t1.fitemid=t4.fitemid
where t1.fqty<>isnull(t2.fqty,0) and t3.fbillno='WORK000942'

--投料单关联错误--领料数
select t3.FCheckDate,t3.fbillno,t4.fnumber,t4.fname,t4.fmodel,t1.fstockqty,isnull(t2.fqty,0) fselectqty
--update t1 set fstockqty=isnull(t2.fqty,0),fauxstockqty=isnull(t2.fqty,0)
from PPBOMEntry t1 --
left join 
(
	select t1.FEntrySelfZOU30 ficmointerid,t1.FEntrySelfZOU31 fppbomentryid,t1.fitemid,sum(t1.fqty) fqty
	from ZPStockBill t0 --
	inner join ZPStockBillEntry t1 on t0.finterid=t1.finterid  --
	inner join icmo t3 on t3.finterid=t1.FEntrySelfZOU30
	where t0.ftrantype=26 and t1.fsourcetrantype in (85,200000014) and t0.fstatus>0
	group by t1.FEntrySelfZOU30,t1.FEntrySelfZOU31,t1.fitemid
	union all
	select t1.ficmointerid,t1.fppbomentryid,t1.fitemid,sum(t1.fqty) fqty
	from ICStockBill t0 --
	inner join ICStockBillEntry t1 on t0.finterid=t1.finterid  --
	inner join icmo t3 on t3.finterid=t1.ficmointerid
	where t0.ftrantype=24 and t1.fsourcetrantype in (85,200000014) and t0.fstatus>0
	group by t1.ficmointerid,t1.fppbomentryid,t1.fitemid
) t2 on t1.ficmointerid=t2.ficmointerid and t1.FEntryID=t2.fppbomentryid and t1.fitemid=t2.fitemid
inner join icmo t3 on t1.ficmointerid=t3.finterid
inner join t_icitem t4 on t1.fitemid=t4.fitemid
where t1.fstockqty<>isnull(t2.fqty,0) and t3.fbillno='WORK001065'

select t1.fsourcetrantype,t1.FEntrySelfZOU30 ficmointerid,t1.FEntrySelfZOU31 fppbomentryid,t1.fitemid,t1.fqty,t1.fsourceinterid,t1.fsourceentryid,t1.fsourcebillno,t1.FEntrySelfZOU32 ficmobillno
from ZPStockBill t0 --
inner join ZPStockBillEntry t1 on t0.finterid=t1.finterid  --
inner join icmo t3 on t3.finterid=t1.FEntrySelfZOU30
inner join t_icitem t4 on t1.fitemid=t4.fitemid
where t0.ftrantype=26 and t1.fsourcetrantype in (85,200000014)
and t3.fbillno='ZP201303033' and t4.fnumber='1.01.0003.000199'
union all
select t1.fsourcetrantype,t1.ficmointerid,t1.fppbomentryid,t1.fitemid,t1.fqty,t1.fsourceinterid,t1.fsourceentryid,t1.fsourcebillno,t1.ficmobillno
from ICStockBill t0 --
inner join ICStockBillEntry t1 on t0.finterid=t1.finterid  --
inner join icmo t3 on t3.finterid=t1.ficmointerid
inner join t_icitem t4 on t1.fitemid=t4.fitemid
where t0.ftrantype=24 and t1.fsourcetrantype in (85,200000014) 
and t3.fbillno='ZP201303033' and t4.fnumber='1.01.0003.000199'


--销售单价错误
declare @ftaxprice decimal(24,4),@fqty decimal(24,2),@fcess decimal(24,2)
declare @fprice decimal(24,4),@famount decimal(24,2)
declare @fallamount decimal(24,2),@finterid int,@fentryid int
declare @FAllStdAmount decimal(24,2)
declare @FTaxAmt decimal(24,2),@interid int

DECLARE authorsentry2_cursor CURSOR FOR
select t1.finterid,t1.fentryid,t1.ftaxprice*0.995,t1.fcess,t1.fqty
from SEOrderEntry t1
inner join seorder t2 on t1.finterid=t2.finterid
where t2.fbillno='PICM1303LAM15' --and t1.fentryid=2
	
OPEN authorsentry2_cursor

FETCH NEXT FROM authorsentry2_cursor 
INTO @finterid,@fentryid,@ftaxprice,@fcess,@fqty

WHILE @@FETCH_STATUS = 0
BEGIN 

	--select @ftaxprice=39.5,@fqty=70,@fcess=0
	select @fprice=@ftaxprice/(1+@fcess/100)
	select @famount=@fprice*@fqty
	select @fallamount=@ftaxprice*@fqty
	--select @FAllStdAmount=@fallamount*@FExchangeRate
	select @FTaxAmt=@famount*(@fcess/100)  --销项税额 --fentryselfs0163 裸包单价 --fentryselfs0169 实际裸包单价 fentryselfs0168 价格类别 fentryselfs0164 包装单价 fentryselfs0165 标准包装单价

	--select t2.finterid,Fauxprice=@fprice,FAuxTaxPrice=@ftaxprice,Famount=@famount,FCess=@FCess,FAuxPriceDiscount=@ftaxprice,FTaxAmt=@FTaxAmt,FAllAmount=@FAllAmount,FAllStdAmount=@fallamount*t2.FExchangeRate
	update t1 set Fauxprice=@fprice,FAuxTaxPrice=@ftaxprice,Famount=@famount,FCess=@FCess,FAuxPriceDiscount=@ftaxprice,FTaxAmt=@FTaxAmt,FAllAmount=@FAllAmount,FAllStdAmount=@fallamount*t2.FExchangeRate
	from SEOrderEntry t1
	inner join seorder t2 on t1.finterid=t2.finterid
	where t1.finterid=@finterid and t1.fentryid=@fentryid
	
	FETCH NEXT FROM authorsentry2_cursor 
	INTO @finterid,@fentryid,@ftaxprice,@fcess,@fqty
END

CLOSE authorsentry2_cursor
DEALLOCATE authorsentry2_cursor

select @finterid=1304

EXEC p_UpdateBillRelateData 81,@finterid  --通过非Aux来更新Aux,非AUX为基本单位

go

-----------------------------------
select Fauxprice=@fprice,FPrice=@fprice,Famount=@famount,fentryselfs0235=@ftaxprice,fentryselfs0236=@fallamount
--update t1 set Fauxprice=@fprice,FAuxTaxPrice=@ftaxprice,Famount=@famount,FCess=@FCess,FAuxPriceDiscount=@ftaxprice,FTaxAmt=@FTaxAmt,FAllAmount=@FAllAmount,FAllStdAmount=@fallamount*t2.FExchangeRate
from SEOrderEntry t1
inner join seorder t2 on t1.finterid=t2.finterid
inner join seoutstockentry t3 on t3.forderinterid=t1.finterid and t3.forderentryid=t1.fentryid
where t2.fbillno='xw1301053' and t1.fentryid=1

--投料单重新刷新
declare @InterID int

DECLARE authorsentry2_cursor CURSOR FOR
select finterid from icmo where isnull(forderinterid,0)<>0
	
OPEN authorsentry2_cursor

FETCH NEXT FROM authorsentry2_cursor 
INTO @InterID

WHILE @@FETCH_STATUS = 0
BEGIN 
	exec My_P_AddOrEditPPBom 16394,@InterID

	FETCH NEXT FROM authorsentry2_cursor 
	INTO @InterID
END

CLOSE authorsentry2_cursor
DEALLOCATE authorsentry2_cursor

--源采购订单号,源销售订单号, 有误
select
--update t1 set FHeadSelfJ0176=isnull(t2.fheadselfs0143,'')/*源采购订单号*/,FHeadSelfJ0177=isnull(t2.fheadselfs0144,'')/*源采购订单号*/
from icmo t1
inner join seorder t2 on t1.forderinterid=t2.finterid

select
--update t3 set FHeadSelfY0224=isnull(t2.fheadselfs0143,'')/*源采购订单号*/,FHeadSelfY0225=isnull(t2.fheadselfs0144,'')/*源采购订单号*/,FHeadSelfY0226=t1.fnote
from icmo t1
inner join seorder t2 on t1.forderinterid=t2.finterid
inner join ppbom t3 on t1.finterid=t3.ficmointerid

select fheadselfs0143
--update t2 set fheadselfs0143='DR14080401' /*源采购订单号*/
from seorder t2 
where t2.fbillno like 'XW1408023'

--订单的购货单位错误
select fname,* from t_organization
select *
--update t1 set fcustid=16709
from seorder t1
where t1.fbillno like '%xw1212087'

--没有分仓领料权限是因为没有给委外加工出库单权限

--收料计划初始化
insert into my_t_scheduledetail (fbillerid,   fsourcetrantype, fsourceinterid, fsourceentryid, funitid,   fitemid,   fdate,   fqty,   fnote)
		select					 t4.fbillerid,t4.ftrantype,    t1.finterid,    t1.fentryid,    t1.funitid,t1.fitemid,t1.fdate,t1.fqty,''	
from poorderentry t1
inner join poorder t4 on t1.finterid=t4.finterid
where t1.fqty>isnull(t1.fcommitqty,0) and t4.fstatus in (1,2) --未完成的采购订单
--and t1.fqty<>(isnull(t2.fplanqty,0)+isnull(t3.FQtyFinish,0)) 
and t1.fmrpclosed<>1
and not exists (select 1 from my_t_scheduledetail m1 where m1.fsourceinterid=t1.finterid and m1.fsourceentryid=t1.fentryid)

--塑胶子件初始化库存

INSERT INTO POInventory(FBrNo,FItemID,   FBatchNo,FAuxPropID,FStockID,FStockPlaceID,FKFPeriod,FKFDate,FQty, FSecQty)
SELECT                  '0',  t4.FItemID,'',      0,         18073,   0,            0,        '',     sum(t2.fqty*(case when isnull(t4.F_116,0)=0 then 1 else t4.F_116 end)/*单位用量*/) fqty,0
from (select fitemid,sum(fqty) fqty from icinventory where fqty>0 group by fitemid) t2
inner join t_icitem t3 on t2.fitemid=t3.fitemid  --套件
inner join t_icitem t4 on Charindex(t3.fshortnumber,t4.fnumber)>0  --t3.fshortnumber=substring(t4.fnumber,6,6) --子件
where t3.fnumber like '1.02.%' and t4.fnumber like '6.%'
group by t4.fitemid

exec AddSystemProfileItem 'IC', 'FIsPlasticManage', '是否启用塑胶子件管理系统', '是否启用塑胶子件管理系统', '1', 'Boolean', 3

--select * from POInventory where fstockid=18073  --delete from POInventory where fstockid=18073

求整函数:  ceiling

select t1.fhelpcode,t2.fhelpcode
--update t2 set fhelpcode=t1.fhelpcode
from opendatasource('SQLOLEDB','Password=123456;Persist Security Info=True;User ID=sa;Data Source=192.168.2.118').newway.dbo.t_Supplier t1
inner join t_Supplier t2 on t1.fitemid=t2.fitemid

--物料资料有误
SELECT t7.F_107,
t0.FItemID,t0.FModel,t0.FName,t0.FHelpCode,t0.FDeleted,t0.FShortNumber,t0.FNumber,t0.FModifyTime,t0.FParentID,t0.FBrNo,t0.FTopID,t0.FRP,t0.FOmortize,t0.FOmortizeScale,t0.FForSale,t0.FStaCost,t0.FOrderPrice,t0.FOrderMethod,t0.FPriceFixingType,t0.FSalePriceFixingType,t0.FPerWastage,t0.FARAcctID,t0.FPlanPriceMethod,t0.FPlanClass,
t1.FErpClsID,t1.FUnitID,t1.FUnitGroupID,t1.FDefaultLoc,t1.FSPID,t1.FSource,t1.FQtyDecimal,t1.FLowLimit,t1.FHighLimit,t1.FSecInv,t1.FUseState,t1.FIsEquipment,t1.FEquipmentNum,t1.FIsSparePart,t1.FFullName,t1.FSecUnitID,t1.FSecCoefficient,t1.FSecUnitDecimal,t1.FAlias,t1.FOrderUnitID,t1.FSaleUnitID,t1.FStoreUnitID,t1.FProductUnitID,t1.FApproveNo,t1.FAuxClassID,t1.FTypeID,t1.FPreDeadLine,t1.FSerialClassID,
t2.FOrderRector,t2.FPOHghPrcMnyType,t2.FPOHighPrice,t2.FWWHghPrc,t2.FWWHghPrcMnyType,t2.FSOLowPrc,t2.FSOLowPrcMnyType,t2.FIsSale,t2.FProfitRate,t2.FSalePrice,t2.FBatchManager,t2.FISKFPeriod,t2.FKFPeriod,t2.FTrack,t2.FPlanPrice,t2.FPriceDecimal,t2.FAcctID,t2.FSaleAcctID,t2.FCostAcctID,t2.FAPAcctID,t2.FGoodSpec,t2.FCostProject,t2.FIsSnManage,t2.FStockTime,t2.FBookPlan,t2.FBeforeExpire,t2.FTaxRate,t2.FAdminAcctID,t2.FNote,t2.FIsSpecialTax,t2.FSOHighLimit,t2.FSOLowLimit,t2.FOIHighLimit,t2.FOILowLimit,t2.FDaysPer,t2.FLastCheckDate,t2.FCheckCycle,t2.FCheckCycUnit,t2.FStockPrice,t2.FABCCls,t2.FBatchQty,t2.FClass,t2.FCostDiffRate,t2.FDepartment,t2.FSaleTaxAcctID,t2.FCBBmStandardID,
t3.FPlanTrategy,--
t3.FOrderTrategy,t3.FLeadTime,t3.FFixLeadTime,t3.FTotalTQQ,t3.FQtyMin,t3.FQtyMax,t3.FCUUnitID,t3.FOrderInterVal,t3.FBatchAppendQty,t3.FOrderPoint,t3.FBatFixEconomy,t3.FBatChangeEconomy,t3.FRequirePoint,t3.FPlanPoint,t3.FDefaultRoutingID,t3.FDefaultWorkTypeID,t3.FProductPrincipal,t3.FDailyConsume,t3.FMRPCon,t3.FPlanner,t3.FPutInteger,t3.FInHighLimit,t3.FInLowLimit,t3.FLowestBomCode,t3.FMRPOrder,t3.FIsCharSourceItem,t3.FCharSourceItemID,--t7.F_101,t7.F_102,
t4.FChartNumber,t4.FIsKeyItem,t4.FMaund,t4.FGrossWeight,t4.FNetWeight,t4.FCubicMeasure,t4.FLength,t4.FWidth,t4.FHeight,t4.FSize,t4.FVersion,
t5.FStandardCost,t5.FStandardManHour,t5.FStdPayRate,t5.FChgFeeRate,t5.FStdFixFeeRate,t5.FOutMachFee,t5.FPieceRate,
t6.FInspectionLevel,t6.FInspectionProject,t6.FIsListControl,t6.FProChkMde,t6.FWWChkMde,t6.FSOChkMde,t6.FWthDrwChkMde,t6.FStkChkMde,t6.FOtherChkMde,t6.FStkChkPrd,t6.FStkChkAlrm,t6.FIdentifier,
t8.FNameEn,t8.FModelEn,t8.FHSNumber,t8.FFirstUnit,t8.FSecondUnit,t8.FFirstUnitRate,t8.FSecondUnitRate,t8.FIsManage,t8.FPackType,t8.FLenDecimal,t8.FCubageDecimal,t8.FWeightDecimal,t8.FImpostTaxRate,t8.FConsumeTaxRate,t8.FManageType 
--update t7 set F_107='Universal'
FROM t_ICItemCore t0
    LEFT JOIN t_ICItemBase t1 ON t0.FItemID=t1.FItemID
    LEFT JOIN t_ICItemMaterial t2 ON t0.FItemID=t2.FItemID
    LEFT JOIN t_ICItemPlan t3 ON t0.FItemID=t3.FItemID
    LEFT JOIN t_ICItemDesign t4 ON t0.FItemID=t4.FItemID 
    LEFT JOIN t_ICItemStandard t5 ON t0.FItemID=t5.FItemID
    LEFT JOIN t_ICItemQuality t6 ON t0.FItemID=t6.FItemID
    LEFT JOIN t_ICItemCustom t7 ON t0.FItemID=t7.FItemID
    LEFT JOIN T_BASE_ICItemEntrance t8 ON t0.FItemID=t8.FItemID
inner join t_icitem t9 on t9.fitemid=t0.fitemid
where t9.fnumber like 'A.%' or t9.fnumber like 'P.%' --and t9.ferpclsid=2 and (t9.fnumber not like 'A.%' and t9.fnumber not like 'P.%')
and isnull(t7.F_107,'')=''

select * from t_itempropdesc where fitemclassid=4
175 装配车间
176 包装车间

update t1 set fsource=176
FROM t_ICItemCore t0
    LEFT JOIN t_ICItemBase t1 ON t0.FItemID=t1.FItemID
inner join t_icitem t9 on t9.fitemid=t0.fitemid
where t9.ferpclsid=2 and (t9.fnumber like 'A.%' OR t9.fnumber like 'P.%')

update t1 set fsource=175
FROM t_ICItemCore t0
    LEFT JOIN t_ICItemBase t1 ON t0.FItemID=t1.FItemID
inner join t_icitem t9 on t9.fitemid=t0.fitemid
where t9.ferpclsid=2 and (t9.fnumber like '3.%' OR t9.fnumber like '4.%')


*/

--正式代码

if not exists (select * from sysobjects where name='my_t_BarcodePrintSub' and xtype='u')  --drop  Table my_t_BarcodePrintSub go
begin
	CREATE TABLE [dbo].my_t_BarcodePrintSub
	(fid [int] IDENTITY(1,1) NOT NULL,fname varchar(200),fuserid int,fisdefault int default 0,
	fprefix varchar(40) default '',fsuffix varchar(40) default '',ftemplatename varchar(50) default '',
	ftype varchar(50) default '自定义',fqty int default 1,
	fbeg int default 1,fend int default 1,fstep int default 1,flength int default 3)
end

--select * from my_t_BarcodePrintSub
go

if not exists (select * from sysobjects where name='my_t_Item' and xtype='u')  --drop  Table my_t_Item go
begin
	CREATE TABLE [dbo].[my_t_Item](
		[FItemID] [int] NOT NULL DEFAULT ((-1)),
		[FItemClassID] [int] NOT NULL,
		[FNumber] [varchar](80) COLLATE Chinese_PRC_CI_AS NOT NULL,
		[FParentID] [int] NOT NULL,
		fkitemid int default 0,
		[FLevel] [smallint] NOT NULL,
		[FDetail] [bit] NOT NULL,
		[FName] [varchar](255) COLLATE Chinese_PRC_CI_AS NOT NULL,
		[FFullNumber] [varchar](80) COLLATE Chinese_PRC_CI_AS NOT NULL DEFAULT (''),
		[FDeleted] [smallint] NOT NULL DEFAULT (0),
		[FShortNumber] [varchar](80) COLLATE Chinese_PRC_CI_AS NULL,
		[FFullName] [varchar](250) COLLATE Chinese_PRC_CI_AS NULL
	 CONSTRAINT [PK_my_t_Item] PRIMARY KEY NONCLUSTERED 
	(
		[FItemID] ASC
	) ON [PRIMARY],
	 CONSTRAINT [uk_my_t_Item2] UNIQUE CLUSTERED 
	(
		[FItemClassID] ASC,
		[FNumber] ASC
	) ON [PRIMARY]
	) ON [PRIMARY]


	CREATE STATISTICS [hind_1141579105_1A_4A] ON [dbo].[my_t_Item]([FItemID], [FNumber], [FItemClassID])

	CREATE STATISTICS [hind_1141579105_4A_1A] ON [dbo].[my_t_Item]([FNumber], [FItemID], [FItemClassID])

	CREATE STATISTICS [hind_1141579105_4A_2A] ON [dbo].[my_t_Item]([FNumber], [FItemClassID])

	--INSERT INTO my_t_Item (FItemClassID, FParentID, FLevel, FName, FNumber, FShortNumber, FFullNumber,FDetail, fitemid) 
	--select                 0,	     0,         1,	'*',   '*',	NULL,	      '',         1,	   0

end

go

if not exists (select * from sysobjects where name='my_t_Identity' and xtype='u')  --drop  Table my_t_Identity go
begin
	CREATE TABLE [dbo].[my_t_Identity](
		[FName] [varchar](30) COLLATE Chinese_PRC_CI_AS NOT NULL,
		[FNext] [int] NOT NULL DEFAULT (1),
		[FStep] [smallint] NOT NULL DEFAULT (1),
	 CONSTRAINT [pk_my_t_Identity] PRIMARY KEY CLUSTERED 
	(
		[FName] ASC
	) ON [PRIMARY]
	) ON [PRIMARY]
end

go



if not exists(select 1 from my_t_Identity where fname='my_t_Item')
begin
  insert into my_t_Identity(fname,fnext,fstep) values('my_t_Item',1,1)
end

go

IF not EXISTS (select * from sysobjects where name='MyICMaxNum' and xtype='u')  --drop  Table MyICMaxNum
begin
	CREATE TABLE [dbo].[MyICMaxNum](
		[FItemID] [numeric](18, 0) IDENTITY(1,1) NOT NULL,
		[FMaxNum] [numeric](10, 0) NULL,
		[FTypeID] [int] NULL,FTableName varchar(100),
	 CONSTRAINT [PK_MyICMaxNum] PRIMARY KEY CLUSTERED 
	(
		[FItemID] ASC
	)WITH  FILLFACTOR = 90 ON [PRIMARY]
	) ON [PRIMARY]
end

go


IF EXISTS (select * from sysobjects where name='my_t_Item_AutoNumber'  and xtype='TR')  drop  TRIGGER my_t_Item_AutoNumber
go
Create TRIGGER [my_t_Item_AutoNumber] ON [dbo].[my_t_Item] --###
FOR INSERT 
NOT FOR REPLICATION
AS

DECLARE @Next int,
	@Step smallint,
	@ID int,
	@TableName varchar(30)

if @@Rowcount = 0
	return
set @TableName = 'my_t_Item' --###
SELECT @Next = FNext,@Step = FStep
FROM my_t_Identity
WHERE FName = @TableName
declare ID_Curs cursor for
select FItemID --###
from Inserted
	
open ID_Curs
fetch ID_Curs into @ID
	
while(@@fetch_status = 0)
begin
	if @ID = -1
	begin
		UPDATE a SET a.FItemID = @Next--###
		FROM my_t_Item a--###
		WHERE a.FItemID = @ID --###
		set @Next = @Next + @Step
	end
	else
		if @ID >= @Next 
			set @Next = @ID + @Step
	fetch ID_Curs into @ID
end

UPDATE my_t_Identity SET FNext = @Next WHERE FName = @TableName
UPDATE MyICMaxNum SET FMaxNum = @Next WHERE FTableName = @TableName

close ID_Curs
deallocate ID_Curs

GO



if not exists (select * from sysobjects where name='my_t_template' and xtype='u')  --drop  Table my_t_template go
begin
CREATE TABLE my_t_template(
	fitemid int,
	fkitemid int default 0,
	fnumber varchar(100),
	fcardid varchar(50),fcontent ntext default '',
	fname varchar(500),fdeptid int,ftype int)
end


go



IF EXISTS (select * from sysobjects where name='my_t_Item_Delete'  and xtype='TR')  drop  TRIGGER my_t_Item_Delete
go
Create TRIGGER [my_t_Item_Delete] ON [dbo].[my_t_Item] 
FOR DELETE
NOT FOR REPLICATION
AS
	declare @fitemclassid int,@fitemid int,@fdetail int,@fnumber varchar(50)
	select @fitemclassid=fitemclassid,@fitemid=fitemid,@fdetail=fdetail,@fnumber=fnumber from deleted

-- 	if @fdetail=0 and exists (select 1 from t_item where fparentid=@fitemid)
-- 	begin
-- 		--ROLLBACK TRAN
-- 		RAISERROR('已经有下级数据关联,不能删除!',18,18)
-- 	end

	if @fdetail=1
	begin
		if @fitemclassid=9901
		begin
			--if exists ( select 1 from MyICRecAndSendEntry where freceiveid=@fitemid
			--			union all
			--			select 1 from MyICRecAndSendEntry where fsendid=@fitemid
			--			)
			--	RAISERROR('该职员已经有单据关联，无法删除!',18,18)

			delete from my_t_template where fitemid=@fitemid
		end
		
		--INSERT INTO t_Log (FDate,FUserID,FFunctionID,FStatement,FDescription,FMachineName,FIPAddress) 
		--VALUES (getdate(),@fuserid,'A00701',5,'删除核算项目:@fnumber 核算项目类别:'+@ftypename,'K101',@fnumber)
	end

GO



IF EXISTS (select * from sysobjects where name='My_Tri_BOSICItemReplace_In'  and xtype='TR')  drop  TRIGGER My_Tri_BOSICItemReplace_In

go

Create TRIGGER [dbo].My_Tri_BOSICItemReplace_In ON [dbo].t_BOSICItemReplace
FOR insert

AS
BEGIN
	SET NOCOUNT ON
	declare @FInterID int,@ftargetitemid int,@fsourceinterid int,@ftargetinterid int  
	declare @FChecker int,@FBrandId int,@FProductID int
	declare @fbillno varchar(30)
	declare @fstatus int,@s varchar(800)
	declare @fsourcebillno varchar(50),@ftargetbillno varchar(50),@fsourceitemid int

	select top 1 @fbillno=fbillno,@FInterID=fid,@FProductID=isnull(FProductID,0) from INSERTED 

	if exists (select 1
			   from t_BOSICItemReplace t1
			   where t1.fid<>@FInterID and t1.FProductID=@FProductID and isnull(t1.FProductID,0)<>0 and @FProductID<>0
	)
	begin
		select @s='产品重复!'
		--ROLLBACK TRAN
		RAISERROR(@s,18,18)
	end

	if exists (select 1
			   from t_BOSICItemReplaceEntry t1
			   inner join inserted t2 on t1.fid=t2.fid
			   group by t1.fid,t1.FRepItemId,t1.FItemID
	)
	begin
		select @s='[物料+替代物料]重复!'
		--ROLLBACK TRAN
		RAISERROR(@s,18,18)
	end	
	
	update t1 set fproductid=@fproductid from t_BOSICItemReplaceEntry t1 where fid=@finterid
	
	--select t2.fproductid,t1.fproductid
	--update t1 set fproductid=t2.fproductid
	--from t_BOSICItemReplaceEntry t1
	--inner join t_BOSICItemReplace t2 on t1.fid=t2.fid
END

GO

if not exists (select * from sysobjects where name='my_t_Barcode' and xtype='u')  --drop  Table my_t_Barcode go
begin
	CREATE TABLE [dbo].[my_t_Barcode](fitemid int IDENTITY (1, 1),
	fnumber varchar(100),fsourceinterid int default 0,fsourceentryid int default 0,fsourcetrantype int default 0,fsourcebillno varchar(50) default '',
	fsourceqty decimal(24,2) default 0,
	fprintcount int default 0,flastprinttime datetime,flastprinterid int default 0,
	fmaterielid int,fqty decimal(24,2) default 1,fserieno varchar(100) default '',fbatchno varchar(100) default '')
end

--select * from my_t_Barcode

go


IF not EXISTS (select * from sysobjects where name='My_t_ICTableTemp' and xtype='u')  --drop  Table My_t_ICTableTemp
begin
	create table My_t_ICTableTemp(fuserid int,finterid int,fentryid int,ftrantype int) 
end

go


IF not EXISTS (select * from sysobjects where name='My_t_TableTemp' and xtype='u')  --drop  Table My_t_TableTemp 
begin
	create table My_t_TableTemp 
	(fuserid int,findex int IDENTITY(1,1) NOT NULL,
	fitemid int,fbarcode varchar(50),fbarcodeid int) 
end

go


if not exists (select * from sysobjects where name='my_t_rout' and xtype='u')  --drop  Table my_t_rout go
begin
CREATE TABLE my_t_rout(
	fitemid int,
	fkitemid int default 0,
	fnumber varchar(100),
	fname varchar(500),frecordbillno varchar(30),
	fisinoutmanage varchar(10),fisschemanage varchar(10),frptroutid int
	)
end

go

IF not EXISTS (select * from sysobjects where name='MyAssemble' and xtype='u') --drop  Table MyAssemble
begin
CREATE TABLE MyAssemble(
	finterid int not null,
	fbillno varchar(50) not null,
	fdate datetime not null,
	fbarcode varchar(50) ,
	fbillerid int not null,
	fmodifierID int,
	fmodifytime datetime,
	fbilltime datetime,
	fchecktime datetime,
	fcheckerid int,
	fcheckdate datetime,
	fstaffer int default 0,
	froutid int,
	fstatus int,--3 关闭--业务执行完毕
	fnote varchar(500),
	fitemid int,
	CONSTRAINT [PK_MyAssemble] PRIMARY KEY CLUSTERED 
	(
		[finterid] ASC
	)WITH  FILLFACTOR = 90 ON [PRIMARY]
) ON [PRIMARY]
end

go



IF not EXISTS (select * from sysobjects where name='MyAssembleEntry' and xtype='u')  --drop  Table MyAssembleEntry
begin
CREATE TABLE MyAssembleEntry(
	FInterID int default 1 NOT NULL,
	FEntryID int IDENTITY (1, 1) NOT NULL,
	fdate datetime not null,fdatetime datetime default getdate(),
	fstaffer int default 0,	fbillerid int,	
	FItemID int NOT NULL,
	FUnitID int ,
	FQty decimal(18, 2) ,forderinterid int,forderbillno varchar(50),ficmointerid int,ficmobillno varchar(50),
	fbarcode varchar(100),
	fbarcodeid int,
	Frequency varchar(50),
	fchilditemid int not null,
	fchildbarcode varchar(50),
	fchildbarcodeid int,
	fchildqty decimal(18, 2) , 
	FNote varchar(500) NULL,
	fisappend int default(0),--是否追加
	froutid int default(0),--组装工序
	CONSTRAINT [PK_MyAssembleEntry] PRIMARY KEY CLUSTERED 
	(
		FInterID ASC,
		FEntryID ASC
	) ON [PRIMARY]
) ON [PRIMARY]
end

go

--前台优先级手工输入
--exec My_P_ICItemReplaceQry 16394,20381,0,1  --My_P_ICItemReplaceQry 16394,0,0,3
IF EXISTS (select * from sysobjects where name='My_P_ICItemReplaceQry' and xtype='p')  drop  procedure My_P_ICItemReplaceQry
go

create procedure [dbo].My_P_ICItemReplaceQry (@fuserid int,@fbominterid int,@fitemid int,@ftype int)  --@ftype 1 BOM 2  多级展开 3 单级反查 

as
set nocount on

declare @fproductid int
select @fproductid=fitemid from icbom where finterid=@fbominterid

create table #data(fproductid int,findex int,fentryid int,fitemid int,fqty decimal(24,5),forder int,fsubsitemid int,flevelstring varchar(50))

-- if @ftype=1 --BOM
-- begin
-- 	select t3.fnumber 物料编码,t3.fname 名称,isnull(t3.fmodel,'') 规格型号,isnull(t3.F_105,'') 描述,t9.fname 单位,cast(t4.fqty as decimal(24,5)) 用量
-- 	from icbom t1
-- 	inner join t_icitem t2 on t1.fitemid=t2.fitemid
-- 	inner join icbomchild t4 on t1.finterid=t4.finterid 
-- 	inner join t_icitem t3 on t3.fitemid=t4.fitemid
-- 	inner join t_measureunit t9 on t9.fitemid=t4.funitid
-- 	where t1.fitemid=@fproductid
-- 	order by t3.fnumber
-- end
-- 
-- if @ftype=2  --替代关系
-- begin
-- 	insert into #data(fproductid,fitemid)
-- 	select distinct   t1.fitemid,t4.fitemid
-- 	from icbom t1
-- 	inner join t_icitem t2 on t1.fitemid=t2.fitemid
-- 	inner join icbomchild t4 on t1.finterid=t4.finterid 
-- 	inner join t_icitem t3 on t3.fitemid=t4.fitemid
-- 	where t1.fitemid=@fproductid
-- 
-- 	select t2.fnumber 物料编码,t2.fname+'///'+isnull(t2.fmodel,'')+'///'+isnull(t2.F_105,'') 名称,--isnull(t2.fmodel,'') 规格型号,isnull(t2.F_105,'') 描述,
-- 	       t3.fnumber 替代编码,t3.fname+'///'+isnull(t3.fmodel,'')+'///'+isnull(t3.F_105,'') 替代名称,--isnull(t3.fmodel,'') 替代规格型号,isnull(t3.F_105,'') 替代描述,
-- 	       t1.forder 优先级
-- 	from
-- 	(
-- 		select t2.fitemid,t2.fsubsitemid,t2.forder
-- 		from #data t1
-- 		inner join t_subsItem t2 on t1.fproductid=t2.FApplicableItem and t1.fitemid=t2.fitemid
-- 		union all
-- 		select t2.fitemid,t2.fsubsitemid,t2.forder
-- 		from #data t1
-- 		inner join t_subsItem t2 on t1.fitemid=t2.fitemid
-- 		where t2.FApplicableItem=0
-- 	) t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid
-- 	inner join t_icitem t3 on t3.fitemid=t1.fsubsitemid
-- 	order by t2.fnumber,t1.forder
-- 
-- 	truncate table #data
-- end

if @ftype=1  --合并BOM
begin
	insert into #data(fproductid,fentryid,   fitemid   ,fqty,   forder,fsubsitemid)
	select            t1.fitemid,t4.fentryid,t4.fitemid,t4.fqty,0,     t4.fitemid
	from icbom t1
	inner join t_icitem t2 on t1.fitemid=t2.fitemid
	inner join icbomchild t4 on t1.finterid=t4.finterid 
	inner join t_icitem t3 on t3.fitemid=t4.fitemid
	where t1.fitemid=@fproductid

	insert into #data(fproductid,   fentryid,   fitemid   ,fqty,   forder,   fsubsitemid)
	select            t1.fproductid,t1.fentryid,t1.fitemid,t1.fqty,t1.forder,t1.fsubsitemid
	from
	(
		select t1.fproductid,t2.fitemid,t2.fsubsitemid,t2.forder,t1.fqty,t1.fentryid
		from #data t1
		inner join t_subsItem t2 on t1.fproductid=t2.FApplicableItem and t1.fitemid=t2.fitemid
		union all
		select t1.fproductid,t2.fitemid,t2.fsubsitemid,t2.forder,t1.fqty,t1.fentryid
		from #data t1
		inner join t_subsItem t2 on t1.fitemid=t2.fitemid
		where t2.FApplicableItem=0
	) t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid
	inner join t_icitem t3 on t3.fitemid=t1.fsubsitemid

	select --t1.fentryid 分录号,
	t3.fitemid 原物料内码,
	t2.fitemid 物料内码,t2.fnumber 物料编码,t2.fname 名称,isnull(t2.fmodel,'') 规格型号,--isnull(t2.F_105,'') 描述,
	t9.fname 单位,cast(t1.fqty as decimal(24,5)) 用量,t1.forder 优先级
	from #data t1
	inner join t_icitem t2 on t1.fsubsitemid=t2.fitemid
	inner join t_icitem t3 on t3.fitemid=t1.fitemid
	inner join t_measureunit t9 on t9.fitemid=t2.funitid
	order by t1.fentryid,t1.forder

	truncate table #data
end

if @ftype=2  --多级展开
begin
	--declare @fproductid int set @fproductid=66597 --select fitemid from t_icitem where fshortnumber=''
	
	Create Table #Mutidata     (  FIndex int IDENTITY,FEntryID INT, FBomInterid int, FItemID int null, FNeedQty decimal(28,14) default(0) null, FBOMLevel int null, 
	FItemType int null, FParentID int default(0)null, FRate   decimal(28,14) default(0) null, FHistory int default(0) null, FHaveMrp smallint default(0) null, 
	FLevelString varchar(300) null, FBom int, FMaterielType int  default(371) null,FOperSN Int NULL DEFAULT(0),FOperID int default(0)) 
	 
	Create Table #MutiParentItem(  FIndex int IDENTITY,FEntryID INT default(0), FBomInterid int, FItemID int null, FNeedQty decimal(28,14) default(0) null, FBOMLevel 
	int null, FItemType int null,  FParentID int default(0)null, FRate   decimal(28,14) default(0) null, FHistory int default(0) null, FHaveMrp smallint default(0) 
	null, FLevelString varchar(300) null , FBom int, FMaterielType int  default(371) null,FOperSN Int NULL DEFAULT(0),FOperID int default(0)) 
	
	Create Table #Errors ( FIndex int IDENTITY, FType smallint default(0), FErrText nvarchar(655) )

	Insert into #mutiParentItem (fbominterid,FItemID,FNeedQty,FBOMLevel,FParentID,FItemType,FBom)
	Select a.finterid, t1.FItemID,a.fqty, 0,0,(case t5.FID when 'WG' then 
	0 when 'ZZ' then 1 when 'WWJG' then 1 else 2 end) FItemtype,t1.FItemID 
	From icbom a
	inner join t_ICItem t1 on t1.FItemID = a.fitemid
	left join t_Submessage t5 on t1.FErpClsID = t5.FInterID 
	where --t5.FTypeID = 210 and  
	t1.fitemid =@fproductid and a.fusestatus=1072 

	declare @p5 int
	set @p5=0
	declare @p6 nchar(400)
	set @p6=''
	exec PlanMutiBomExpand 50,1,'1900-01-01 00:00:00:000','2100-01-01 00:00:00:000',@p5 output,@p6 output
 
	insert into #data(fproductid, findex,   fitemid   ,fqty,       forder,fsubsitemid,flevelstring)
	select            t4.fitemid, t1.findex,t1.fitemid,t1.fneedqty,0,     t1.fitemid,t1.flevelstring
	from #Mutidata t1 
	inner join t_icitem t2 on t1.fitemid=t2.fitemid 
	inner join icbomchild t3 on t1.fbominterid=t3.finterid and t3.fentryid=t1.fentryid
	inner join icbom t4 on t4.finterid=t3.finterid

	insert into #data(fproductid,   findex,   fitemid   ,fqty,   forder,   fsubsitemid,   flevelstring)
	select            t1.fproductid,t1.findex,t1.fitemid,t1.fqty,t1.forder,t1.fsubsitemid,t1.flevelstring
	from
	(
		select t1.fproductid,t2.fitemid,t2.fsubsitemid,t2.forder,t1.fqty,t1.findex,t1.flevelstring
		from #data t1
		inner join t_subsItem t2 on t1.fproductid=t2.FApplicableItem and t1.fitemid=t2.fitemid
		union all
		select t1.fproductid,t2.fitemid,t2.fsubsitemid,t2.forder,t1.fqty,t1.findex,t1.flevelstring
		from #data t1
		inner join t_subsItem t2 on t1.fitemid=t2.fitemid
		where t2.FApplicableItem=0
	) t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid
	inner join t_icitem t3 on t3.fitemid=t1.fsubsitemid

	select --t1.findex 序号,
	t1.flevelstring 级次,t2.fnumber 物料编码,t2.fname 名称,isnull(t2.fmodel,'') 规格型号,
	isnull(t2.F_105,'') 描述,t9.fname 单位,cast(t1.fqty as decimal(24,5)) 用量,t1.forder 优先级
	from #data t1
	inner join t_icitem t2 on t1.fsubsitemid=t2.fitemid
	inner join t_icitem t3 on t3.fitemid=t1.fitemid
	inner join t_measureunit t9 on t9.fitemid=t2.funitid
	order by t1.findex,t1.forder

	truncate table #data
	drop table #Mutidata
	drop table #mutiParentItem
	drop table #Errors
end


if @ftype=3  --单级反查  --select fitemid from t_icitem where fshortnumber='000006'  
begin
	insert into #data(fproductid,fitemid   ,forder,    fsubsitemid)
	select   distinct t1.fitemid,t4.fitemid,t5.forder, t5.fsubsitemid
	from icbom t1
	inner join t_icitem t2 on t1.fitemid=t2.fitemid
	inner join icbomchild t4 on t1.finterid=t4.finterid --and t4.fitemid=68175
	inner join t_icitem t3 on t3.fitemid=t4.fitemid
	inner join t_subsItem t5 on t5.fitemid=t4.fitemid and t5.FApplicableItem=t1.fitemid
	where t4.fitemid=@fitemid  --有关这个物料的替代关系

	insert into #data(fproductid,fitemid   ,forder,   fsubsitemid)
	select   distinct t1.fitemid,t4.fitemid,t5.forder,t5.fsubsitemid
	from icbom t1
	inner join t_icitem t2 on t1.fitemid=t2.fitemid
	inner join icbomchild t4 on t1.finterid=t4.finterid --and t4.fitemid=68175
	inner join t_icitem t3 on t3.fitemid=t4.fitemid
	inner join t_subsItem t5 on t5.fitemid=t4.fitemid and t5.FApplicableItem=0
	where t4.fitemid=@fitemid

	insert into #data(fproductid,fitemid   ,forder,    fsubsitemid)
	select   distinct t1.fitemid,t4.fitemid,0,         0
	from icbom t1
	inner join t_icitem t2 on t1.fitemid=t2.fitemid
	inner join icbomchild t4 on t1.finterid=t4.finterid --and t4.fitemid=68175
	inner join t_icitem t3 on t3.fitemid=t4.fitemid
	where t4.fitemid=@fitemid 

	select cast(0 as bit) 选择,t1.fproductid 产品内码,t5.finterid BOM内码,t4.fnumber 产品编码,t4.fname+'///'+isnull(t4.fmodel,'')+'///'+isnull(t4.F_105,'') 产品名称,--isnull(t4.fmodel,'') 产品规格型号,isnull(t4.F_105,'') 产品描述,
	--t2.fnumber 物料编码,t2.fname+'///'+isnull(t2.fmodel,'')+'///'+isnull(t2.F_105,'') 物料名称,--isnull(t2.fmodel,'') 规格型号,isnull(t2.F_105,'') 描述,
	isnull(t1.fsubsitemid,0) 替代内码,isnull(t3.fnumber,'') 替代编码,isnull(t3.fname,'')+'///'+isnull(t3.fmodel,'')+'///'+isnull(t3.F_105,'') 替代名称,--isnull(t3.fmodel,'') 替代规格型号,isnull(t3.F_105,'') 替代描述,
	t1.forder 优先级
	from #data t1
	left join t_icitem t3 on t1.fsubsitemid=t3.fitemid
	inner join t_icitem t2 on t2.fitemid=t1.fitemid
	inner join t_icitem t4 on t4.fitemid=t1.fproductid
	inner join icbom t5 on t5.fitemid=t1.fproductid
	order by t4.fnumber,t2.fnumber,t1.forder

	truncate table #data
end

drop table #data

set nocount off

go





IF not EXISTS (select * from sysobjects where name='My_t_BillNaviga' and xtype='u')  --drop  Table My_t_BillNaviga
begin
	CREATE TABLE [dbo].My_t_BillNaviga(
		[FUserID] [int] NOT NULL,
		[FBillType] [int] NOT NULL,
		[FIndex] [int] NOT NULL,
		[FBillNo] [varchar](50) COLLATE Chinese_PRC_CI_AS NULL,
	 CONSTRAINT [PK_My_t_BillNaviga] PRIMARY KEY CLUSTERED 
	(
		[FUserID] ASC,
		[FBillType] ASC,
		[FIndex] ASC
	)WITH  FILLFACTOR = 90 ON [PRIMARY]
	) ON [PRIMARY]
end

go



IF not EXISTS (select * from sysobjects where name='MyICRecAndSend' and xtype='u') --drop Table MyICRecAndSend 
begin
CREATE TABLE MyICRecAndSend(
	finterid int not null,
	fbillno varchar(50) not null,
	fdate datetime not null,
	ftrantype int,
	fcustid int,
	fsupplyid int,
	fdeptid int,
	fbillerid int not null,
	fmodifierID int,
	fmodifytime datetime,
	fbilltime datetime,
	fchecktime datetime,
	fcheckerid int,
	fcheckdate datetime,
	ficmobillno varchar(50) default '',
	fstatus int default(0),--3 关闭--业务执行完毕
	fnote varchar(500),
	freceiveid int default(0), --收货人
	fsendid int,--发货人
	fstaffer int,--担当
	froutid int default(0),--本工序
	fpreroutid int default(0),--上工序--暂时不用
	fisfirstrout int default(0),--本工序是否首工序--暂时不用
	CONSTRAINT [PK_MyICRecAndSend] PRIMARY KEY CLUSTERED 
	(
		[finterid] ASC
	)WITH  FILLFACTOR = 90 ON [PRIMARY]
) ON [PRIMARY]
end

go

if not exists(select 1 from MyICRecAndSend)
begin
	INSERT INTO MyICRecAndSend (finterid, fbillno,     fbillerid,fmodifierID,fmodifytime,fbilltime,fdate,    froutid, fstatus,fchecktime,fcheckerid,fcheckdate) 
                        VALUES (1,        'RC00000001',16394,    16394,      getdate(),  getdate(),getdate(),0,       0      ,null,      null,      null)
end

go

IF not EXISTS (select * from sysobjects where name='MyICRecAndSendEntry' and xtype='u')  --drop Table MyICRecAndSendEntry
begin
CREATE TABLE MyICRecAndSendEntry(
	FInterID int default 1 NOT NULL,
	FEntryID int /*IDENTITY (1, 1)*/ NOT NULL,fbillerid int,
	frecordbillno varchar(30) default '',fbillno varchar(30) default '',
	froutid int default(0),--本工序  --与表头的本工序一致
	fpreroutid int default(0),--上工序
	FItemID int NOT NULL,FIsReWork bit default 0,
	FUnitID int default(0),
	fstaffer int default 0,fdate datetime,fdatetime datetime default getdate(),
	FQty decimal(18, 4) default(0),
	fbarcode varchar(100),
	fbarcodeid int,fsourcetrantype int,fsourceinterid int,fsourceentryid int,
	FNote varchar(500) NULL,
	fissend int default 0,--是否已转移 --1 是
	fisassemble int default 0,--是否已组装 --1 是
	fisadd int default 0,--是否已追加 --1 是
	fisreplace int default 0,--是否已替换 --1 是
	CONSTRAINT [PK_MyICRecAndSendEntry] PRIMARY KEY CLUSTERED 
	(
		FInterID ASC,
		FEntryID ASC
	) ON [PRIMARY]
) ON [PRIMARY]
end

go


--单据编码规则

declare @fmybilltypeid int
--收发
exec My_p_AddBillNo @fmybilltypeid output, 'MyICRecAndSend', 'SF'
--组装
exec My_p_AddBillNo @fmybilltypeid output, 'MyAssemble', 'AB'


------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------

--新增系统设置项目

IF EXISTS (select * from sysobjects where name='AddSystemProfileItem' and xtype='p')  drop  procedure AddSystemProfileItem

go

create procedure AddSystemProfileItem(
 @FCategory varchar(200),
 @fkey varchar(200),
 @fdesc_cht varchar(100),
 @fdesc_en varchar(100),
 @fvalue varchar(100),
 @fformat varchar(200),
 @fid int
) as

declare @findex int
declare @fpropertyid int
if @fformat='TXT'
begin
	set @fpropertyid = 3  --txt
end

if @fformat='Interger'
begin
	set @fpropertyid = 0 --integer
end

if @fformat='Boolean'
begin
	set @fpropertyid = 1 --Boolean
end

delete from t_SystemProfile where FCategory=@FCategory and FKey=@fkey
delete from ICSystemProfile where FCategory=@FCategory and FKey=@fkey

select @findex = max(findex) + 1000 from ICSystemProfile where fid=@fid

INSERT INTO t_SystemProfile(FCategory, FKey, FValue, FReadonly,FDescription,FLevel,FFormat, fdescription_cht, fdescription_en)
     VALUES (               @FCategory,@fkey,@fvalue,0,        @fdesc_cht,  '',    @fformat,@fdesc_cht,       @fdesc_en)

insert into ICSystemProfile(fid, findex, fpropertyid,fcaption, fcategory, fkey, fvalue, fcaption_cht, fcaption_en)
values(@fid, @findex, @fpropertyid, @fdesc_cht, @FCategory, @fkey, 0, @fdesc_cht, @fdesc_en)

go

--exec AddSystemProfileItem 'IC', 'FUpDatePath', '程序更新目录', '程序更新目录', 'C:\OurwayUpdate\', 'TXT', 3
exec AddSystemProfileItem 'IC', 'FUpDatePath', '程序更新目录', '程序更新目录', '\\192.168.2.3\NewwayUpdate\', 'TXT', 3

--exec AddSystemProfileItem 'IC', 'FOurwayUrl', 'OurwayUrl', 'OurwayUrl', 'http://localhost/MyWinceWS/MyScanService.asmx', 'TXT', 3
exec AddSystemProfileItem 'IC', 'FOurwayUrl', 'OurwayUrl', 'OurwayUrl', 'http://ourwayink.gnway.org:33757/MyWinceWS/MyScanService.asmx', 'TXT', 3
exec AddSystemProfileItem 'IC', 'FSupriColorUrl', 'SupriColorUrl', 'SupriColorUrl', 'http://mysupri.gnway.org:33757/MyWinceWS/MyScanService.asmx', 'TXT', 3
exec AddSystemProfileItem 'IC', 'FAiconUrl', 'AiconUrl', 'AiconUrl', 'http://ourwayink.gnway.org:33757/MyWinceWS/MyScanService.asmx', 'TXT', 3


exec AddSystemProfileItem 'IC', 'FZhOurwayUrl', 'FZhOurwayUrl', 'FZhOurwayUrl', 'http://119.146.246.142:33757/MyWinceWS/MyScanService.asmx', 'TXT', 3
exec AddSystemProfileItem 'IC', 'FHKOurwayUrl', 'FHKOurwayUrl', 'FHKOurwayUrl', 'http://119.146.246.142:33757/MyHKWinceWS/MyScanService.asmx', 'TXT', 3


--exec AddSystemProfileItem 'IC', 'FLocalConnectString', 'LocalConnectString', 'LocalConnectString', 'server=.;User ID=sa;Password=123456;database=xinwei', 'TXT', 3
exec AddSystemProfileItem 'IC', 'FLocalConnectString', 'LocalConnectString', 'LocalConnectString', 'server=192.168.2.3;User ID=sa;Password=ourwayink.com;database=AIS20120820103535', 'TXT', 3

exec AddSystemProfileItem 'IC', 'FLeastGrossMargin', '下限毛利率(%)', '下限毛利率(%)', '5', 'TXT', 3
exec AddSystemProfileItem 'IC', 'FStandardMakeFee', '标准制造费', '标准制造费', '2', 'TXT', 3

exec AddSystemProfileItem 'IC', 'FUSDExchangerate', '美金转换汇率', '美金转换汇率', '6.15', 'TXT', 3
exec AddSystemProfileItem 'IC', 'FMakeDivPiece', '制造费用/直接人工', '制造费用/直接人工', '0.951197', 'TXT', 3
exec AddSystemProfileItem 'IC', 'FThreeDivPiece', '三大费用/直接人工', '制造费用/直接人工', '1.176724', 'TXT', 3
exec AddSystemProfileItem 'IC', 'FTax', '所得税率', '所得税率', '0.25', 'TXT', 3
exec AddSystemProfileItem 'IC', 'FBackTax', '怔退税率差', '怔退税率差', '0.02', 'TXT', 3
exec AddSystemProfileItem 'IC', 'FStdPackPiece', '包装标准人工', '包装标准人工', '0.35', 'TXT', 3

exec AddSystemProfileItem 'IC', 'FOrderPatchFilePath', '订单附件目录', '订单附件目录', '\\192.168.2.2\OrderPatchFile$\', 'TXT', 3

--exec AddSystemProfileItem 'IC', 'FIsBackFlush', '是否启用倒冲', '是否启用倒冲', '0', 'Boolean', 3
--exec AddSystemProfileItem 'IC', 'FIsPassWhenNotEnough', '倒冲时库存不足是否允许通过', '倒冲时库存不足是否允许通过', '0', 'Boolean', 3
--exec AddSystemProfileItem 'IC', 'FIsPlasticManage', '是否启用塑胶子件管理系统', '是否启用塑胶子件管理系统', '0', 'Boolean', 3

exec AddSystemProfileItem 'IC', 'FProductProspectDays', '成品展望期', '成品展望期', '30', 'TXT', 3
exec AddSystemProfileItem 'IC', 'FHalfProductProspectDays', '半成品展望期', '半成品展望期', '30', 'TXT', 3

exec AddSystemProfileItem 'IC', 'FProductPrepareDays', '成品准备期', '成品准备期', '3', 'TXT', 3
exec AddSystemProfileItem 'IC', 'FHalfProductPrepareDays', '半成品准备期', '半成品准备期', '3', 'TXT', 3

exec AddSystemProfileItem 'IC', 'FPackDesignFilePath', '包材设计文件目录', '包材设计文件目录', '\\192.168.2.2\Picture', 'TXT', 3

exec AddSystemProfileItem 'IC', 'FPODateChangeMsgTo', '采购订单交期变更信息通知', '采购订单交期变更信息通知', '刘晶,胡治菲,', 'TXT', 3
exec AddSystemProfileItem 'IC', 'FSEDateChangeMsgTo', '销售订单交期变更信息通知', '销售订单交期变更信息通知', '刘晶,胡治菲,', 'TXT', 3

--select * from t_SystemProfile where FCategory='IC' and fkey='FPODateChangeMsgTo'

--成品展望期 半成品展望期 半成品提前期

go

IF not EXISTS (select * from sysobjects where name='My_t_GridContentTemp' and xtype='u')  --drop  Table My_t_GridContentTemp
begin
	create table My_t_GridContentTemp(fuserid int,fitemid int,FQty decimal(24,4),fstockid int,fbatchno varchar(200)) 
end

go


--*****
IF not EXISTS (select * from sysobjects where name='My_t_ICStockBill24Temp' and xtype='u')  --drop  Table My_t_ICStockBill24Temp
begin
	create table My_t_ICStockBill24Temp(fuserid int,finterid int,fbillno varchar(50),
	fitemid int,funitid int,FCostOBJID int,FStockId int,fqtymust decimal(24,4),
	FICMOInterID int,FPPBomEntryID int,FQty decimal(24,4),FNote varchar(100),FICMOBillNo varchar(20),fdeptid int) 
end

go

IF not EXISTS (select * from sysobjects where name='My_PackDesignFilePathTemp' and xtype='u')  --drop  Table My_PackDesignFilePathTemp
begin
	create table My_PackDesignFilePathTemp(fuserid int,fpath varchar(500))
end

go


IF not EXISTS (select * from sysobjects where name='t_logbak' and xtype='u')  --drop Table t_logbak
begin
	select * into t_logbak from t_log	
	truncate table t_log
end

go

IF not EXISTS (select * from sysobjects where name='My_t_BosPackSubTemp' and xtype='u')  --drop  Table My_t_BosPackSubTemp
begin
	create table My_t_BosPackSubTemp(fuserid int,finterid int,fentryid int) 
end

go

IF not EXISTS (select t1.id
from sysobjects t1 
inner join syscolumns t2 on t1.id=t2.id
where t1.name='t_Message' and t1.xtype='u' and t2.name='fmymestype')
begin
	alter table t_Message add fmymestype int default 0
end

go

--*****
IF not EXISTS (select t1.id
from sysobjects t1 
inner join syscolumns t2 on t1.id=t2.id
where t1.name='ICMO' and t1.xtype='u' and t2.name='FIsMrp')
begin
	alter table ICMO add FIsMrp bit default 0
end

go


--鑫威成本核算-------------------------------------------------------------------------------------


--my_p_calcost 2,2016,9

IF EXISTS (select * from sysobjects where name='my_p_calcost' and xtype='p')  drop  procedure my_p_calcost

go

create procedure [dbo].my_p_calcost(@ftype int,@fyear int,@fperiod int)

as

set nocount on

--declare @ftype int,@fyear int,@fperiod int select @fyear=2016,@fperiod=11,@ftype=2 --1、半成品 2、成品、配件
--

----赠送入库
----update t2 set fprice=0.01,fauxprice=0.01,famount=cast(t2.fqty*0.01 as decimal(24,2))
--update t2 set famount=0.01,fprice=cast(0.01/t2.fqty as decimal(24,5)),fauxprice=cast(0.01/t2.fqty as decimal(24,5))
--from icstockbillentry t2  
--inner join icstockbill t3 on t2.finterid=t3.finterid  
--inner join t_icitem t11 on t11.fitemid=t2.fitemid   
--inner join t_item t1 on t1.fitemclassid=3010 and t1.fitemid=t3.fheadselfa9737
--left join t_SupplyEntry t13 on t13.fitemid=t2.fitemid  --子
--where year(t3.fdate)=@fyear and month(t3.fdate)=@fperiod  and t3.ftrantype in (10)  --
--and isnull(t3.FVchInterID,0)=0 and t3.FCancellation = 0 
--and t1.fname like '%赠送%'

--更改返工任务单类型-----
update t1 set fworktypeid=55,
fnote=(isnull(t1.fnote,'')+(case when Charindex('返工',isnull(t1.fnote,''))<=0 then +'//返工' else '' end))
from icstockbillentry t2 
inner join icstockbill t3 on t2.finterid=t3.finterid
inner join t_icitem t4 on t4.fitemid=t2.fitemid
inner join icmo t1 on t1.finterid=t2.ficmointerid
where year(t3.fdate)=@fyear 
and month(t3.fdate)=@fperiod 
and t1.fworktypeid=56
--and t3.ftrantype =cast(@fbilltype as int)
--and isnull(t3.FVchInterID,0)=0 

update t2 set fprice=0.01,fauxprice=0.01,famount=cast(t2.fqty*0.01 as decimal(24,2))
--update t2 set famount=0.01,fprice=cast(0.01/t2.fqty as decimal(24,5)),fauxprice=cast(0.01/t2.fqty as decimal(24,5))
from icstockbillentry t2  
inner join icstockbill t3 on t2.finterid=t3.finterid  
inner join t_icitem t11 on t11.fitemid=t2.fitemid   
inner join t_item t1 on t1.fitemclassid=3010 and t1.fitemid=t3.fheadselfa9737
left join t_SupplyEntry t13 on t13.fitemid=t2.fitemid  --子
where year(t3.fdate)=@fyear and month(t3.fdate)=@fperiod  and t3.ftrantype in (10)  --
and isnull(t3.FVchInterID,0)=0 and t3.FCancellation = 0 
and t1.fitemid=217073  --冲物料领用-制造费用(自行打印标签入库）
--and t1.fname like '%赠送%'

--SELECT fcussentacctid,* 
update t1 set fcussentacctid=1746
FROM ICSTOCKBILL t1 WHERE FTRANTYPE=1 and year(t1.fdate)=@fyear and month(t1.fdate)=@fperiod
and isnull(t1.FVchInterID,0)=0
and (isnull(t1.fcussentacctid,0)=0)

--单价太小,导致金额为0
--select t2.fqty,t3.ftrantype,t3.fbillno,t11.fnumber,t11.fname,t11.fmodel,t3.fcheckerid,t2.fprice,t11.fplanprice,t2.fqty,t11.fplanprice*t2.fqty
update t2 set famount=0.01,fprice=cast(0.01/t2.fqty as decimal(24,6)),fauxprice=cast(0.01/t2.fqty as decimal(24,6))
from icstockbillentry t2  
inner join icstockbill t3 on t2.finterid=t3.finterid  
inner join t_icitem t11 on t11.fitemid=t2.fitemid   
where year(t3.fdate)=@fyear and month(t3.fdate)=@fperiod --and t11.fshortnumber='210644' 
and isnull(t3.FVchInterID,0)=0 
and (t2.fprice>0 and t2.famount=0 ) --and t11.fnumber like '1.06.001.001432%

create table #ICInvBal
(
FItemID int not null ,
FQty decimal(28,10) not null default(0),
famount decimal(28,2) not null default(0)
)

--本期的期初放在临时表
insert into #ICInvBal(FItemID,fqty,famount)
select t1.fitemid,t1.fbegqty,t1.FBegBal
from
(
	select t1.FItemID,sum(t1.FBegQty) FBegQty,sum(t1.FBegBal) FBegBal
	From ICInvBal t1
	inner join t_icitem t2 on t1.fitemid=t2.fitemid
	Where t1.FPeriod = @FPeriod And t1.FYear = @FYear --And (t1.FBegQty <> 0 Or t1.FSecBegQty<>0 Or t1.FBegBal <> 0 or t1.FBegDiff<>0)
	--and t2.ferpclsid=1
	group by t1.fitemid 
) t1 where t1.FBegQty > 0 and t1.FBegBal>0


--本期入
insert into #ICInvBal(FItemID,fqty,famount)
select t2.FItemID,sum(t2.FQty),sum(round(t2.FAmount,2))
from ICStockBill t1,ICStockBillEntry t2,t_ICItem t3
where t1.FInterID=t2.FInterID and year(t1.FDate)=@FYear and month(t1.FDate)=@FPeriod
and t1.FCancellation=0 and t2.FItemID=t3.FItemID and (t1.FTrantype in(1,2,5,10,40,101,102) OR (t1.FtranType=100 AND t1.FBillTypeID=12542))
--and t3.ferpclsid=1 
and (t2.fprice>0 or t2.famount<>0)
group by t2.FItemID

select t1.fitemid,cast(sum(t1.famount)/sum(t1.fqty) as decimal(24,6)) fprice 
into #temp
from #ICInvBal t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid
group by t1.fitemid
having sum(t1.fqty)>0

delete from #temp where fprice<=0

----0 出库价
--insert into #temp(fitemid,fprice)
--select t2.fitemid,cast(max(t2.fprice) as decimal(24,6)) as fprice
----into #temp
--from icstockbill t1
--inner join icstockbillentry t2 on t1.finterid=t2.finterid
--inner join t_icitem t3 on t2.fitemid=t3.fitemid
--where year(t1.fdate)=@fyear --(select fvalue from t_systemprofile where fcategory='ic' and fkey='currentyear') 
--and month(t1.fdate)=@fperiod --(select fvalue from t_systemprofile where fcategory='ic' and fkey='currentperiod')
----left(t3.fnumber,1) in ('1','2','3','4') and 
--and t3.ferpclsid=2
--and t1.ftrantype in (24,29) and t1.frob=1 and t2.fprice>0 
--and t2.fitemid not in(select fitemid from #temp)
--group by t2.fitemid

----3 期初单价
--insert into #temp(fitemid,fprice)
--select fitemid,fprice
--from 
--(
--	select fitemid,sum(fbegbal)/sum(fbegqty) as fprice 
--	from icbal 
--	where fyear=@fyear --(select fvalue from t_systemprofile where fcategory='ic' and fkey='currentyear') 
--	and fperiod=@fperiod --(select fvalue from t_systemprofile where fcategory='ic' and fkey='currentperiod') 
--	and fbegqty>0 and fbegbal>0
--	group by fitemid 
--) a where fitemid not in(select fitemid from #temp)

-----2 当期采购订单
--insert into #temp
--select t2.fitemid,
--max((case when fcurrencyid='1' then t2.fprice else cast(t2.fprice*t1.fexchangerate as decimal(24,6)) end)) as fprice
--from poorder t1
--inner join poorderentry t2 on t1.finterid=t2.finterid
--where t2.fitemid not in(select fitemid from #temp)
--and t1.fdate>='2016-09-01' 
----and year(t1.fdate)=(select fvalue from t_systemprofile where fcategory='ic' and fkey='currentyear') and month(t1.fdate)=(select fvalue from t_systemprofile where fcategory='ic' and fkey='currentperiod')and 
--and t2.fprice>0
--group by t2.fitemid

---1 采购价格库

insert into #temp(fitemid,fprice)
select t4.fitemid,(case when t5.fcyid=1000 then t5.fprice*t1.fexchangerate else t5.fprice end) fprice
from (select fitemid,max(fentryid) fentryid from (select t1.fitemid,t1.fentryid from t_supplyentry t1 inner join (select fitemid,max(FQuoteTime) FQuoteTime from t_SupplyEntry group by fitemid) t2 on t1.fitemid=t2.fitemid and t1.FQuoteTime=t2.FQuoteTime) t1 group by fitemid) t4 
inner join t_supplyentry t5 on t4.fitemid=t5.fitemid and t4.fentryid=t5.fentryid
inner join t_currency t1 on t1.fcurrencyid=t5.fcyid
where t5.fitemid not in (select fitemid from #temp)

--有价格的话先删掉，因为以算出来为准

--1、半成品 2、成品、配件

if @ftype=1
begin
	delete t1 from #temp t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid where left(t2.fnumber,1) in ('3','4','5')
end

if @ftype=2
begin
	delete t1 from #temp t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid where left(t2.fnumber,1) not in ('1','2','3','4','5','6','7','8','9')
end

--update t_ICItemMaterial set fplanprice=0


--drop table #temp


--半成品 ----如果不是计算[半成品]，那么上面就有了，这里也不会再计算了

--半成品
insert into #temp(fitemid,fprice)
select t1.fitemid,sum(fprice) fprice
from
(
	select t2.fitemid,(t3.fqty*t5.fprice) fprice
	from t_icitem t1
	inner join icbom t2 on t1.fitemid=t2.fitemid --and t2.fstatus>0
	inner join icbomchild t3 on t2.finterid=t3.finterid
	inner join #temp t5 on t5.fitemid=t3.fitemid
	inner join t_icitem t6 on t6.fitemid=t3.fitemid
	where left(t1.fnumber,1) in ('3','4') --and t1.ferpclsid=2 
	--and t1.fitemid in (select fitemid from #data)
	union all
	select t11.fitemid,(t12.fqty*t5.fprice) fprice
	from icbom t11   --半成品
	inner join icbomchild t12 on t11.finterid=t12.finterid  --半成品子项
	inner join #temp t5 on t5.fitemid=t12.fitemid
	inner join t_icitem t6 on t6.fitemid=t11.fitemid --半成品
	inner join t_icitem t8 on t8.fitemid=t12.fitemid --半成品子项
	where left(t6.fnumber,1) in ('5') and t8.fname not like '回收件%' --and t1.ferpclsid=2
	--and t11.fitemid in (select fitemid from #data)
	union all
	select t11.fitemid,(1*t5.fprice) fprice
	from icbom t11   --半成品
	inner join (
-- 			select distinct t1.fitemid,(select top 1 fitemid from t_icitem where fparentid=t1.fparentid and fname like '%拆盒%' ) fchiheitemid
-- 			from t_icitem t1
-- 			inner join icbomchild t2 on t1.fitemid=t2.fitemid
-- 			where t1.fnumber like '5.%' and t1.fname not like '%拆盒%'
		select distinct t1.fitemid,
		(
			select top 1 m4.fitemid 
			from t_icitem m1 
			inner join icbomchild m2 on m1.fitemid=m2.fitemid
			inner join icbom m3 on m2.finterid=m3.finterid
			inner join t_icitem m4 on m3.fitemid=m4.fitemid
			where m4.fnumber like '5.%' and m4.fname like '%拆盒%' and m1.fitemid=t5.fitemid 
		) fchiheitemid
		from t_icitem t1
		inner join icbomchild t2 on t1.fitemid=t2.fitemid
		inner join icbom t3 on t1.fitemid=t3.fitemid
		inner join icbomchild t4 on t4.finterid=t3.finterid
		inner join t_icitem t5 on t5.fitemid=t4.fitemid
		where t1.fnumber like '5.%' and t1.fname not like '%拆盒%' and t5.fnumber like '1.02.%'
	) t12 on t11.fitemid=t12.fitemid --半成品同级回收壳
	inner join t_icitem t6 on t6.fitemid=t11.fitemid --半成品
	inner join t_icitem t8 on t8.fitemid=t12.fchiheitemid --半成品同级回收壳
	inner join #temp t5 on t5.fitemid=t8.fitemid
	where left(t6.fnumber,1) in ('5') --and t1.ferpclsid=2
	--and t11.fitemid in (select fitemid from #data)
) t1 where t1.fitemid not in (select fitemid from #temp) 
group by t1.fitemid

--成品
insert into #temp(fitemid,fprice)
select t1.fitemid,sum(isnull(t6.fprice,0)*t2.fqty) fprice
from icbom t1
inner join icbomchild t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t1.fitemid=t3.fitemid
inner join t_icitem t4 on t2.fitemid=t4.fitemid
inner join (select fitemid,max(finterid) finterid from icbom group by fitemid) t5 on t5.finterid=t1.finterid  --防止一物有多个BOM
left join #temp t6 on t6.fitemid=t4.fitemid
where --not (left(t4.fnumber,5) in ('1.06.','2.20.','1.04.') and t4.funitid<>29056) and --膜 单位非PCS --and t2.foperid not in (40013,40019,40020,40028,40026,40012,40014,40039,40023)
left(t3.fnumber,1) not in ('3','4','5')
and t1.fitemid not in (select fitemid from #temp)
group by t1.fitemid

--先清0
update t1 set fplanprice=0 from t_ICItemMaterial t1 

update t1 set fplanprice=t2.fprice
from t_ICItemMaterial t1 inner join #temp t2 on t1.fitemid=t2.fitemid
where t2.fprice>0

--包括了半成品、成品
select distinct t2.fitemid,t1.fbatchno,cast(t2.fplanprice as decimal(24,6)) fprice,0 fbrandid,cast('' as varchar(20)) fisexistbom into #data
from icstockbillentry t1 
inner join t_icitem t2 on t1.fitemid=t2.fitemid 
inner join icstockbill t3 on t3.finterid=t1.finterid
where year(t3.fdate)=@fyear --(select fvalue from t_systemprofile where fcategory='ic' and fkey='currentyear') 
and month(t3.fdate)=@fperiod --(select fvalue from t_systemprofile where fcategory='ic' and fkey='currentperiod')  --and t2.fnumber like '2%' 
and t3.frob=1 --and (t3.ftrantype in (2) or (t3.ftrantype in (10) and t2.ferpclsid=2))
and t2.ferpclsid=2

--1、半成品 2、成品、配件

if @ftype=1
begin
	delete t1 from #data t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid where left(t2.fnumber,1) not in ('3','4','5')
end

if @ftype=2
begin
	delete t1 from #data t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid where left(t2.fnumber,1) in ('3','4','5')
end

--update t1 set fprice=t2.fprice
--from #data t1
--inner join 
--(
--	select t2.fitemid,t2.fbatchno,sum(fprice) fprice
--	from
--	(
--		select t1.fitemid,t1.fbatchno,t11.fqty*(1+t11.fscrap/100)*t9.fplanprice fprice
--		from #data t1 
--		inner join t_icitem t2 on t1.fitemid=t2.fitemid 
--		inner join t_measureunit t3 on t3.fitemid=t2.funitid
--		inner join icbom t10 on t10.fitemid=t1.fitemid --and t10.fusestatus=1072
--		inner join icbomchild t11 on t11.finterid=t10.finterid
--		inner join t_icitem t9 on t9.fitemid=t11.fitemid  
--		--and t2.fitemid in (select fitemid from #data)
--	) t2 group by t2.fitemid,t2.fbatchno
--) t2 on t1.fitemid=t2.fitemid and t1.fbatchno=t2.fbatchno
--inner join t_icitem t3 on t1.fitemid=t3.fitemid

--update t1 set fplanprice=t2.fprice
--from t_ICItemMaterial t1 inner join #data t2 on t1.fitemid=t2.fitemid
--where t2.fprice>0


update t1 set fisexistbom='N'
from #data t1
inner join t_icitem t2 on t1.fitemid=t2.fitemid
where --t2.fshortnumber='f04404' and 
t1.fitemid not in (select fitemid from icbom)

select t2.fitemid,t2.fnumber 编码,t2.fname 名称,t2.fmodel 规格型号,t1.fbatchno 批号,t1.fprice 单价,t1.fisexistbom BOM信息
from #data t1 
inner join t_icitem t2 on t1.fitemid=t2.fitemid 
--where left(t2.fnumber,1) not in ('5')
order by t2.fnumber


drop table #ICInvBal
drop table #data
drop table #temp

set nocount off

go


--成本明细------------
--my_p_costdetail 2,2016,9

IF EXISTS (select * from sysobjects where name='my_p_costdetail' and xtype='p')  drop  procedure my_p_costdetail

go

create procedure [dbo].my_p_costdetail(@ftype int,@fyear int,@fperiod int)

as

set nocount on

--declare @ftype int,@fyear int,@fperiod int select @fyear=2016,@fperiod=11,@ftype=1 --1、半成品 2、成品、配件
--

----赠送入库
----update t2 set fprice=0.01,fauxprice=0.01,famount=cast(t2.fqty*0.01 as decimal(24,2))
--update t2 set famount=0.01,fprice=cast(0.01/t2.fqty as decimal(24,5)),fauxprice=cast(0.01/t2.fqty as decimal(24,5))
--from icstockbillentry t2  
--inner join icstockbill t3 on t2.finterid=t3.finterid  
--inner join t_icitem t11 on t11.fitemid=t2.fitemid   
--inner join t_item t1 on t1.fitemclassid=3010 and t1.fitemid=t3.fheadselfa9737
--left join t_SupplyEntry t13 on t13.fitemid=t2.fitemid  --子
--where year(t3.fdate)=@fyear and month(t3.fdate)=@fperiod  and t3.ftrantype in (10)  --
--and isnull(t3.FVchInterID,0)=0 and t3.FCancellation = 0 
--and t1.fname like '%赠送%'

create table #ICInvBal
(
	FItemID int not null ,
	FQty decimal(28,10) default(0),
	famount decimal(28,2) default(0),
	FBegQty decimal(28,10) default(0),
	fbegamount decimal(28,2) default(0),
	FInQty decimal(28,10) default(0),
	finamount decimal(28,2) default(0)
)

--本期的期初放在临时表
insert into #ICInvBal(FItemID,fqty,famount,fbegqty,fbegamount)
select t1.fitemid,t1.fbegqty,t1.FBegBal,t1.fbegqty,t1.FBegBal
from
(
	select t1.FItemID,sum(t1.FBegQty) FBegQty,sum(t1.FBegBal) FBegBal
	From ICInvBal t1
	inner join t_icitem t2 on t1.fitemid=t2.fitemid
	Where t1.FPeriod = @FPeriod And t1.FYear = @FYear --And (t1.FBegQty <> 0 Or t1.FSecBegQty<>0 Or t1.FBegBal <> 0 or t1.FBegDiff<>0)
	--and t2.ferpclsid=1
	group by t1.fitemid 
) t1 where t1.FBegQty > 0 and t1.FBegBal>0


--本期入
insert into #ICInvBal(FItemID,fqty,famount,finqty,finamount)
select t2.FItemID,sum(t2.FQty),sum(round(t2.FAmount,2)),sum(t2.FQty),sum(round(t2.FAmount,2))
from ICStockBill t1,ICStockBillEntry t2,t_ICItem t3
where t1.FInterID=t2.FInterID and year(t1.FDate)=@FYear and month(t1.FDate)=@FPeriod
and t1.FCancellation=0 and t2.FItemID=t3.FItemID and (t1.FTrantype in(1,2,5,10,40,101,102) OR (t1.FtranType=100 AND t1.FBillTypeID=12542))
--and t3.ferpclsid=1 
and (t2.fprice>0 or t2.famount<>0)  --单价为0也插入，因为要统计入库数量
group by t2.FItemID

create table #temp
(
	FItemID int not null ,
	FQty decimal(28,10) default(0),
	famount decimal(28,2) default(0),
	FBegQty decimal(28,10) default(0),
	fbegamount decimal(28,2) default(0),
	FInQty decimal(28,10) default(0),
	finamount decimal(28,2) default(0),
	fprice decimal(28,6) default(0),
	fstdprice decimal(28,6) default(0)
)

--加权单价--
insert into #temp(FItemID,FQty,famount,FBegQty,fbegamount,FInQty,finamount,fprice,fstdprice)
select t1.fitemid,
sum(t1.fqty) fqty,sum(t1.famount) famount,
sum(t1.fbegqty) fbegqty,sum(t1.fbegamount) fbegamount,
sum(t1.finqty) finqty,sum(t1.finamount) finamount,
cast(sum(t1.famount)/sum(t1.fqty) as decimal(24,6)) fprice,
cast(0 as decimal(24,6)) fstdprice 
from #ICInvBal t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid
group by t1.fitemid
having sum(t1.fqty)>0

--delete from #temp where fprice<=0
---1 采购价格库

select t4.fitemid,(case when t5.fcyid=1000 then t5.fprice*t1.fexchangerate else t5.fprice end) fprice into #t_supplyentry
from (select fitemid,max(fentryid) fentryid from (select t1.fitemid,t1.fentryid from t_supplyentry t1 inner join (select fitemid,max(FQuoteTime) FQuoteTime from t_SupplyEntry group by fitemid) t2 on t1.fitemid=t2.fitemid and t1.FQuoteTime=t2.FQuoteTime) t1 group by fitemid) t4 
inner join t_supplyentry t5 on t4.fitemid=t5.fitemid and t4.fentryid=t5.fentryid
inner join t_currency t1 on t1.fcurrencyid=t5.fcyid

--没有加权单价则用标准采购作为加权单价
--1、无记录
insert into #temp(fitemid,fprice)
select t5.fitemid,t5.fprice
from #t_supplyentry t5
where t5.fitemid not in (select fitemid from #temp)  

--2、有记录但加权单价为0--可能还没有进行出库核算
update t5 set fprice=t4.fprice
from #t_supplyentry t4
inner join #temp t5 on t4.fitemid=t5.fitemid
where t5.fprice=0  --

--标准采购成本
update t5 set fstdprice=t4.fprice
from #t_supplyentry t4
inner join #temp t5 on t4.fitemid=t5.fitemid

--有价格的话先删掉，因为以算出来为准

--1、半成品 2、成品、配件

if @ftype=1
begin
	delete t1 from #temp t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid where left(t2.fnumber,1) in ('3','4','5')
end

if @ftype=2
begin
	delete t1 from #temp t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid where left(t2.fnumber,1) not in ('1','2','3','4','5','6','7','8','9')
end

--update t_ICItemMaterial set fplanprice=0


--drop table #temp

--包括了半成品、成品
select distinct t2.fitemid,cast(t2.fplanprice as decimal(24,6)) fprice,--t1.fbatchno,0 fbrandid,
cast('' as varchar(20)) fisexistbom into #data
from icstockbillentry t1 
inner join t_icitem t2 on t1.fitemid=t2.fitemid 
inner join icstockbill t3 on t3.finterid=t1.finterid
where year(t3.fdate)=@fyear --(select fvalue from t_systemprofile where fcategory='ic' and fkey='currentyear') 
and month(t3.fdate)=@fperiod --(select fvalue from t_systemprofile where fcategory='ic' and fkey='currentperiod')  --and t2.fnumber like '2%' 
and t3.frob=1 --and (t3.ftrantype in (2) or (t3.ftrantype in (10) and t2.ferpclsid=2))
and t2.ferpclsid=2

--1、半成品 2、成品、配件

if @ftype=1
begin
	delete t1 from #data t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid where left(t2.fnumber,1) not in ('3','4','5')
end

if @ftype=2
begin
	delete t1 from #data t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid where left(t2.fnumber,1) in ('3','4','5')
end

create table #icbom(fitemid int,fchilditemid int,fperqty decimal(28,10) default(0))

--半成品--全部取出来
insert into #icbom(fitemid,fchilditemid,fperqty)
select t1.fitemid,t6.fitemid fchilditemid,t3.fqty fperqty --,t1.fnumber,t1.fname,t1.fmode,t6.fitemid fchilditemid,t6.fnumber fitemnumber,t6.fname fitemname,t6.fmodel fitemmodel,t5.fbegqty,t5.fbegamount,t5.finqty,t5.finamount,t5.fqty,t5.famount,t5.fprice,t5.fstdprice,t3.fqty fperqty,(t3.fqty*t5.fprice) fcost,(t3.fqty*t5.fstdprice) fstdcost
from t_icitem t1
inner join icbom t2 on t1.fitemid=t2.fitemid --and t2.fstatus>0
inner join icbomchild t3 on t2.finterid=t3.finterid
inner join t_icitem t6 on t6.fitemid=t3.fitemid
where left(t1.fnumber,1) in ('3','4') --and t1.ferpclsid=2 
--and t1.fitemid in (select fitemid from #data)
union all
select t6.fitemid,t8.fitemid fchilditemid,t12.fqty fperqty --,t6.fnumber,t6.fname,t6.fmode,t8.fitemid fchilditemid,t8.fnumber fitemnumber,t8.fname fitemname,t8.fmodel fitemmodel,t5.fbegqty,t5.fbegamount,t5.finqty,t5.finamount,t5.fqty,t5.famount,t5.fprice,t5.fstdprice,t12.fqty fperqty,(t12.fqty*t5.fprice) fcost,(t12.fqty*t5.fstdprice) fstdcost
from icbom t11   --半成品
inner join icbomchild t12 on t11.finterid=t12.finterid  --半成品子项
inner join t_icitem t6 on t6.fitemid=t11.fitemid --半成品
inner join t_icitem t8 on t8.fitemid=t12.fitemid --半成品子项
where left(t6.fnumber,1) in ('5') and t8.fname not like '回收件%' --and t1.ferpclsid=2
--and t11.fitemid in (select fitemid from #data)
union all
select t6.fitemid,t8.fitemid fchilditemid,1 fperqty --,t6.fnumber,t6.fname,t6.fmode,t8.fitemid fchilditemid,t8.fnumber fitemnumber,t8.fname fitemname,t8.fmodel fitemmodel,t5.fbegqty,t5.fbegamount,t5.finqty,t5.finamount,t5.fqty,t5.famount,t5.fprice,t5.fstdprice,1 fperqty,(1*t5.fprice) fcost,(1*t5.fstdprice) fstdcost
from icbom t11   --半成品
inner join (
-- 			select distinct t1.fitemid,(select top 1 fitemid from t_icitem where fparentid=t1.fparentid and fname like '%拆盒%' ) fchiheitemid
-- 			from t_icitem t1
-- 			inner join icbomchild t2 on t1.fitemid=t2.fitemid
-- 			where t1.fnumber like '5.%' and t1.fname not like '%拆盒%'
	select distinct t1.fitemid,
	(
		select top 1 m4.fitemid 
		from t_icitem m1 
		inner join icbomchild m2 on m1.fitemid=m2.fitemid
		inner join icbom m3 on m2.finterid=m3.finterid
		inner join t_icitem m4 on m3.fitemid=m4.fitemid
		where m4.fnumber like '5.%' and m4.fname like '%拆盒%' and m1.fitemid=t5.fitemid 
	) fchiheitemid
	from t_icitem t1
	inner join icbomchild t2 on t1.fitemid=t2.fitemid
	inner join icbom t3 on t1.fitemid=t3.fitemid
	inner join icbomchild t4 on t4.finterid=t3.finterid
	inner join t_icitem t5 on t5.fitemid=t4.fitemid
	where t1.fnumber like '5.%' and t1.fname not like '%拆盒%' and t5.fnumber like '1.02.%'
) t12 on t11.fitemid=t12.fitemid --半成品同级回收壳
inner join t_icitem t6 on t6.fitemid=t11.fitemid --半成品
inner join t_icitem t8 on t8.fitemid=t12.fchiheitemid --半成品同级回收壳
where left(t6.fnumber,1) in ('5') --and t1.ferpclsid=2
--and t11.fitemid in (select fitemid from #data)

--成品--只要有本期入库的
insert into #icbom(fitemid,fchilditemid,fperqty)
select t1.fitemid,t2.fitemid fchilditemid,t2.fqty --sum(isnull(t6.fprice,0)*t2.fqty) fprice
from icbom t1
inner join icbomchild t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t1.fitemid=t3.fitemid
inner join t_icitem t4 on t2.fitemid=t4.fitemid
where --not (left(t4.fnumber,5) in ('1.06.','2.20.','1.04.') and t4.funitid<>29056) and --膜 单位非PCS --and t2.foperid not in (40013,40019,40020,40028,40026,40012,40014,40039,40023)
left(t3.fnumber,1) not in ('3','4','5')
and t1.fitemid in (select fitemid from #data)

--半成品 ----如果不是计算[半成品]，那么上面就有了，这里也不会再计算了

--没有加权单价则用标准采购作为加权单价
--1、无记录
insert into #temp(fitemid,fprice)
select t5.fitemid,t5.fprice
from
(
	select t1.fitemid,sum(isnull(t6.fstdprice,0)*t1.fperqty) fprice
	from #icbom t1
	inner join t_icitem t3 on t1.fitemid=t3.fitemid
	inner join t_icitem t4 on t1.fchilditemid=t4.fitemid
	left join #temp t6 on t6.fitemid=t4.fitemid
	where left(t3.fnumber,1) in ('3','4','5') 
	group by t1.fitemid
) t5 where t5.fitemid not in (select fitemid from #temp)

--2、有记录但加权单价为0--可能还没有进行出库核算
update t5 set fprice=t4.fprice
from 
(
	select t1.fitemid,sum(isnull(t6.fstdprice,0)*t1.fperqty) fprice
	from #icbom t1
	inner join t_icitem t3 on t1.fitemid=t3.fitemid
	inner join t_icitem t4 on t1.fchilditemid=t4.fitemid
	left join #temp t6 on t6.fitemid=t4.fitemid
	where left(t3.fnumber,1) in ('3','4','5') 
	group by t1.fitemid
) t4 inner join #temp t5 on t4.fitemid=t5.fitemid
where t5.fprice=0  --

--标准采购成本
update t5 set fstdprice=t4.fprice
from 
(
	select t1.fitemid,sum(isnull(t6.fstdprice,0)*t1.fperqty) fprice
	from #icbom t1
	inner join t_icitem t3 on t1.fitemid=t3.fitemid
	inner join t_icitem t4 on t1.fchilditemid=t4.fitemid
	left join #temp t6 on t6.fitemid=t4.fitemid
	where left(t3.fnumber,1) in ('3','4','5') 
	group by t1.fitemid
) t4 inner join #temp t5 on t4.fitemid=t5.fitemid


--成品
--没有加权单价则用标准采购作为加权单价
--1、无记录
insert into #temp(fitemid,fprice)
select t5.fitemid,t5.fprice
from
(
	select t1.fitemid,sum(isnull(t6.fstdprice,0)*t1.fperqty) fprice
	from #icbom t1
	inner join t_icitem t3 on t1.fitemid=t3.fitemid
	inner join t_icitem t4 on t1.fchilditemid=t4.fitemid
	left join #temp t6 on t6.fitemid=t4.fitemid
	where left(t3.fnumber,1) not in ('3','4','5') 
	group by t1.fitemid
) t5 where t5.fitemid not in (select fitemid from #temp)

--2、有记录但加权单价为0--可能还没有进行出库核算
update t5 set fprice=t4.fprice
from 
(
	select t1.fitemid,sum(isnull(t6.fstdprice,0)*t1.fperqty) fprice
	from #icbom t1
	inner join t_icitem t3 on t1.fitemid=t3.fitemid
	inner join t_icitem t4 on t1.fchilditemid=t4.fitemid
	left join #temp t6 on t6.fitemid=t4.fitemid
	where left(t3.fnumber,1) not in ('3','4','5') 
	group by t1.fitemid
) t4 inner join #temp t5 on t4.fitemid=t5.fitemid
where t5.fprice=0  --

--标准采购成本
update t5 set fstdprice=t4.fprice
from 
(
	select t1.fitemid,sum(isnull(t6.fstdprice,0)*t1.fperqty) fprice
	from #icbom t1
	inner join t_icitem t3 on t1.fitemid=t3.fitemid
	inner join t_icitem t4 on t1.fchilditemid=t4.fitemid
	left join #temp t6 on t6.fitemid=t4.fitemid
	where left(t3.fnumber,1) not in ('3','4','5') 
	group by t1.fitemid
) t4 inner join #temp t5 on t4.fitemid=t5.fitemid


----先清0
--update t1 set fplanprice=0 from t_ICItemMaterial t1 

--update t1 set fplanprice=t2.fprice
--from t_ICItemMaterial t1 inner join #temp t2 on t1.fitemid=t2.fitemid
--where t2.fprice>0

--update t1 set fprice=t2.fprice
--from #data t1
--inner join 
--(
--	select t2.fitemid,t2.fbatchno,sum(fprice) fprice
--	from
--	(
--		select t1.fitemid,t1.fbatchno,t11.fqty*(1+t11.fscrap/100)*t9.fplanprice fprice
--		from #data t1 
--		inner join t_icitem t2 on t1.fitemid=t2.fitemid 
--		inner join t_measureunit t3 on t3.fitemid=t2.funitid
--		inner join icbom t10 on t10.fitemid=t1.fitemid --and t10.fusestatus=1072
--		inner join icbomchild t11 on t11.finterid=t10.finterid
--		inner join t_icitem t9 on t9.fitemid=t11.fitemid  
--		--and t2.fitemid in (select fitemid from #data)
--	) t2 group by t2.fitemid,t2.fbatchno
--) t2 on t1.fitemid=t2.fitemid and t1.fbatchno=t2.fbatchno
--inner join t_icitem t3 on t1.fitemid=t3.fitemid

--update t1 set fplanprice=t2.fprice
--from t_ICItemMaterial t1 inner join #data t2 on t1.fitemid=t2.fitemid
--where t2.fprice>0


update t1 set fisexistbom='N'
from #data t1
inner join t_icitem t2 on t1.fitemid=t2.fitemid
where --t2.fshortnumber='f04404' and 
t1.fitemid not in (select fitemid from icbom)

--select t2.fitemid,t2.fnumber 编码,t2.fname 名称,t2.fmodel 规格型号,t1.fbatchno 批号,t1.fprice 单价,t1.fisexistbom BOM信息
--from #data t1 
--inner join t_icitem t2 on t1.fitemid=t2.fitemid 
----where left(t2.fnumber,1) not in ('5')
--order by t2.fnumber

select t2.fnumber 产品编码,t2.fname 产品名称,t2.fmodel 产品规格型号,--t4.fbatchno 批号,--t6.fitemid fchilditemid,
t6.fnumber 物料编码,t6.fname 物料名称,t6.fmodel 物料规格型号,
t5.fbegqty 期初数量,t5.fbegamount 期初余额,t5.finqty 入库数量,t5.finamount 入库金额,
t5.fqty 总数量,t5.famount 总金额,t5.fprice 加权单价,t5.fstdprice 标准单价,
t1.fperqty 单位用量,(t1.fperqty*isnull(t5.fprice,0)) 成本,(t1.fperqty*t5.fstdprice) 标准成本
into #source
from #icbom t1
inner join t_icitem t2 on t1.fitemid=t2.fitemid --and t2.fstatus>0
inner join t_icitem t6 on t6.fitemid=t1.fchilditemid
left join #temp t5 on t5.fitemid=t6.fitemid
inner join #data t4 on t4.fitemid=t1.fitemid
--where left(t1.fnumber,1) in ('3','4') --and t1.ferpclsid=2 
--and t1.fitemid in (select fitemid from #data)
order by t2.fnumber,t6.fnumber

select 产品编码,产品名称,产品规格型号,物料编码,物料名称,物料规格型号,期初数量,期初余额,入库数量,入库金额,总数量,总金额,加权单价,标准单价,单位用量,成本,标准成本 from #source
union all
select 产品编码,'ZZZZZZZZZZ'产品名称,''产品规格型号,''物料编码,''物料名称,''物料规格型号,0 期初数量,0 期初余额,0 入库数量,0 入库金额,0 总数量,0 总金额,0 加权单价,0 标准单价,0 单位用量,sum(成本) 成本,sum(标准成本) 标准成本 from #source group by 产品编码
order by 产品编码,产品名称

drop table #ICInvBal
drop table #data
drop table #temp
drop table #t_supplyentry
drop table #icbom
drop table #source

set nocount off

go


--my_BackAndDeleteLog

IF EXISTS (select * from sysobjects where name='my_BackAndDeleteLog' and xtype='p')  drop  procedure my_BackAndDeleteLog
go

create procedure [dbo].[my_BackAndDeleteLog]

as

declare @maxlogid int

select @maxlogid=max(flogid) from t_log

set IDENTITY_INSERT t_logbak on

insert into t_logbak (FLogID,
FDate,
FUserID,
FFunctionID,
FStatement,
FDescription,
FMachineName,
FIPAddress) select FLogID,
FDate,
FUserID,
FFunctionID,
FStatement,
FDescription,
FMachineName,
FIPAddress from t_log where flogid<=@maxlogid

set IDENTITY_INSERT t_logbak off

delete from t_log where flogid<=@maxlogid

GO


IF not EXISTS (select * from sysobjects where name='My_t_Identify' and xtype='u')  --drop  Table My_t_Identify
begin
	CREATE TABLE [dbo].My_t_Identify(
		[FID] [int] ,
		[FDate] [datetime] NULL,
		[FUserID] [smallint] NULL,
		[FTrantypeID] [varchar](20) NULL,
		[FStatement] [int] NULL,
		[FDescription] [varchar](255) NULL,
		[FMachineName] [varchar](70) NULL,
		[FIPAddress] [char](15) NULL)
end

GO



--物料表触发器--新增、更新
IF EXISTS (select * from sysobjects where name='My_Tri_ICItemCore_In'  and xtype='TR')  drop  TRIGGER My_Tri_ICItemCore_In
go

Create TRIGGER My_Tri_ICItemCore_In
            ON t_ICItemCore
for insert

AS
BEGIN
	SET NOCOUNT ON
	declare @fshortnumber varchar(50),@fitemid int,@fname varchar(2000),@fmodel varchar(2000)
	select top 1 @fshortnumber=fshortnumber,@fitemid=fitemid,@fname=fname,@fmodel=fmodel from INSERTED

	if @fshortnumber<>'0' and exists (select 1 from t_ICItemCore t1 where fshortnumber=@fshortnumber and fitemid<>@fitemid ) --and len(fshortnumber)=6
	begin
		RAISERROR('物料短代码重复!',18,18)
		rollback tran
	end

	if exists (select 1 from t_ICItemCore t1 where fname+fmodel=@fname+@fmodel and fitemid<>@fitemid ) --and len(fshortnumber)=6
	begin
		RAISERROR('物料[名称+规格型号]重复!',18,18)
		rollback tran
	end

end

go



IF EXISTS (select * from sysobjects where name='My_Tri_Item'  and xtype='TR')  drop  TRIGGER My_Tri_Item
go

Create TRIGGER My_Tri_Item ON [dbo].[t_Item]
FOR insert,UPDATE

AS
BEGIN
	SET NOCOUNT ON

	declare @fdeleted smallint,@s varchar(8000),@FChkUserID int,@fitemid int,@ferpclsid int,@fitemclassid int
	select top 1 @FChkUserID=isnull(FChkUserID,0),@ferpclsid=0,@fitemid=fitemid,@s='',@fitemclassid=fitemclassid from inserted
		
	if update(FChkUserID) and @FChkUserID>0 and @fitemclassid=4
	begin
		update t1 set fcheckdate=getdate()
		from t_Item t1 
		inner join INSERTED t2 on t1.fitemid=t2.fitemid 

		update t3 set flastmoddate=getdate()
		from t_Item t1 
		inner join INSERTED t2 on t1.fitemid=t2.fitemid 
		inner join t_baseproperty t3 on t3.fitemid=t1.fitemid
			
		select top 1 @ferpclsid=ferpclsid from t_icitem where fitemid=@fitemid
	
		if @ferpclsid=2 
		begin
			if not exists(select 1
					  from inserted t1
					  inner join icbom t2 on t1.fitemid=t2.fitemid
					  where t2.fstatus>0)
			begin
				set @s='该物料没有BOM或者BOM未审核!'  ----

				RAISERROR(@s,18,18)
				rollback tran		
			end		
		end				  
	end
	
	if update(FChkUserID) and @FChkUserID=0 and @fitemclassid=4
	begin
		update t1 set fcheckdate=null
		from t_Item t1 
		inner join INSERTED t2 on t1.fitemid=t2.fitemid 
	end	
	
	set nocount off
end

go


IF EXISTS (select * from sysobjects where name='My_Tri_ICItemCustom'  and xtype='TR')  drop  TRIGGER My_Tri_ICItemCustom
go

Create TRIGGER My_Tri_ICItemCustom ON [dbo].[t_ICItemCustom]
FOR insert,UPDATE

AS
BEGIN
	SET NOCOUNT ON

	declare @fdeleted smallint,@s varchar(8000),@FNumber varchar(80),@fshortnumber varchar(80),@fname varchar(800),@fmodel varchar(800) 
	--select top 1 @fdeleted=fdeleted,@s='',@FNumber=fnumber,@fname=fname,@fmodel=fmodel,@fshortnumber=fshortnumber from inserted

	set @s=''

	if exists(	select 1
			from inserted t1
			inner join t_ICItemCore t2 on t1.fitemid=t2.fitemid
			where isnull(t1.F_126,0)=40019 and isnull(t1.F_127,0)<>0
		  )
	begin
			set @s='引擎产品无需指定引用引擎!'  ----

			RAISERROR(@s,18,18)
			rollback tran		
	end

	if exists(	select 1
			from inserted t1
			inner join t_ICItemCore t2 on t1.fitemid=t2.fitemid
			where left(t2.fnumber,4) in ('a.01','p.01','j.01','x.01','y.01') and isnull(t1.F_126,0)<>40019 
		  )
	begin
			set @s='傲威中性必须是价格引擎!'  ----

			RAISERROR(@s,18,18)
			rollback tran		
	end

	if exists(	select 1
			from inserted t1
			inner join t_ICItemCore t2 on t1.fitemid=t2.fitemid
			left join t_icitem t3 on t3.fitemid=t1.f_127
			where isnull(t1.F_126,0)=40019 
			and left(t2.fnumber,4) in ('a.02','a.03','a.04','p.02','p.03','p.04','j.02','j.03','j.04','x.02','x.03','x.04','y.02','y.03','y.04')
			and t2.fname not like '%禁用%'
		  )
	begin
			set @s='[咖啡盒、白盒、STARINK]引用引擎必须指向傲威中性!!!'  ----

			RAISERROR(@s,18,18)
			rollback tran		
	end

	if exists(	select 1
			from inserted t1
			inner join t_ICItemCore t2 on t1.fitemid=t2.fitemid
			left join t_icitem t3 on t3.fitemid=t1.f_127
			where left(isnull(t3.fnumber,''),4) not in ('a.01','p.01','j.01','x.01','y.01') and isnull(t1.F_126,0)<>40019 
			and (left(t2.fnumber,4) in ('a.02','a.03','a.04','p.02','p.03','p.04','j.02','j.03','j.04','x.02','x.03','x.04','y.02','y.03','y.04') or left(t2.fnumber,1) in ('v'))
			and t2.fname not like '%禁用%'
		  )
	begin
			set @s='非引擎产品必须指向傲威中性!'  ----

			RAISERROR(@s,18,18)
			rollback tran		
	end 
	--select * from t_itempropdesc where fitemclassid=4  --f_127 引用引擎   --F_129   引擎代码(系统填充无需录入)
	update t4 set F_129=isnull(t3.fnumber,'')  --select t4.F_129,isnull(t3.fnumber,''),t2.fnumber,t2.fname
	from inserted t1
	inner join t_ICItemCore t2 on t1.fitemid=t2.fitemid
	left join t_icitem t3 on t3.fitemid=t1.f_127
	inner join t_ICItemCustom t4 on t1.fitemid=t4.fitemid
	where (left(t2.fnumber,4) in ('a.02','a.03','a.04','p.02','p.03','p.04','j.02','j.03','j.04','x.02','x.03','x.04','y.02','y.03','y.04') or left(t2.fnumber,1) in ('v'))
	and isnull(t1.F_126,0)<>40019 and t2.fname not like '%禁用%'

	update t4 set F_129=''
	from inserted t1
	inner join t_ICItemCore t2 on t1.fitemid=t2.fitemid
	left join t_icitem t3 on t3.fitemid=t1.f_127
	inner join t_ICItemCustom t4 on t1.fitemid=t4.fitemid
	where isnull(t1.F_126,0)=40019 and t2.fname not like '%禁用%'

-- 	if exists(	select 1
-- 			from inserted t1
-- 			inner join t_ICItemCore t2 on t1.fitemid=t2.fitemid
-- 			where left(t2.fnumber,4) in ('a.02','a.03','a.04','p.02','p.03','p.04','j.02','j.03','j.04','x.02','x.03','x.04','y.02','y.03','y.04')
-- 			and (isnull(t1.F_126,0)=40019 or isnull(t1.F_127,0)=0) )
-- 	begin
-- 			set @s='非傲威中性不能是价格引擎且必须指定引用引擎!'  ----
-- 
-- 			RAISERROR(@s,18,18)
-- 			rollback tran		
-- 	end

	set nocount off
end

go



IF EXISTS (select * from sysobjects where name='My_Tri_ICItemCore'  and xtype='TR')  drop  TRIGGER My_Tri_ICItemCore
go

Create TRIGGER My_Tri_ICItemCore ON [dbo].[t_ICItemCore]
FOR insert,UPDATE

AS
BEGIN
	SET NOCOUNT ON

	declare @fdeleted smallint,@s varchar(8000),@FNumber varchar(80),@fshortnumber varchar(80),@fname varchar(800),@fmodel varchar(800) 
	select top 1 @fdeleted=fdeleted,@s='',@FNumber=fnumber,@fname=fname,@fmodel=fmodel,@fshortnumber=fshortnumber from inserted

	--/*
	if update(forderprice) 
	begin
		update t1 set forderprice=0 
		from t_ICItemCore t1 
		inner join INSERTED t2 on t1.fitemid=t2.fitemid 
		where isnull(t2.forderprice,0)<>0
	end
	--*/

	if update(fmodel) and left(@FNumber,5)='1.02.'
	begin
		update t3 set fmodel=@fshortnumber+'/'+right(@fname,(len(@fname)-charindex('注塑套件',@fname)-4))+'套件/'+@fmodel
		from t_ICItemCore t1 --套件
		inner join INSERTED t2 on t1.fitemid=t2.fitemid 
		inner join t_ICItemCore t3 on Charindex(t1.fshortnumber,t3.fnumber)>0 and left(t3.fnumber,1)='6'
	end

	if update(fdeleted) and @fdeleted=1
	begin
		if exists (select 1 from inserted t1 inner join icinventory t2 on t1.fitemid=t2.fitemid where t2.fqty>0)
		begin
			select @s=@s+','+m1.fnumber from
			(
				select distinct t3.fnumber 
				from inserted t1 
				inner join icinventory t2 on t1.fitemid=t2.fitemid 
				inner join t_icitem t3 on t1.fitemid=t3.fitemid
				where t2.fqty>0
			) m1

			set @s='物料['+@s+']还有库存!'  ----

			RAISERROR(@s,18,18)
			rollback tran
		end
	end

	set nocount off
end

go


--获取新单编号和内码--------------------------------------------------------------------------------
IF EXISTS (select * from sysobjects where name='My_p_GetBillNo' and xtype='p')  drop  procedure My_p_GetBillNo
go

create procedure [dbo].[My_p_GetBillNo](
	@TypeId int,
	@TableName varchar(50),
	@InterID int output,
	@BillNo varchar(50) output
)
as

exec GetICMaxNum @TableName, @InterID output

-- 10.4
Update t_BillCodeRule Set FReChar = FReChar Where FBillTypeID =@TypeId

declare @TmpID int
SET @TmpID = (SELECT FID FROM t_BillCodeRule WITH(READUNCOMMITTED) WHERE fbilltypeid=@TypeId and fprojectid=3)

update t_billcoderule set fprojectval = fprojectval+1,flength=case when (flength-len(fprojectval)) >= 0 then flength else len(fprojectval) end where FID =  @TmpID 
Update ICBillNo Set FCurNo = (select top 1 isnull(fprojectval,1) from t_billcoderule where fprojectid = 3 and fbilltypeid =@TypeId) where fbillid = @TypeId
   
--长度和目前编码
declare @fprojectval varchar(20), @iLength int
select @fprojectval=(fprojectval-1),@iLength=flength from t_BillCodeRule where fprojectid = 3 and fbilltypeid = @TypeId

--日期
--select fprojectval,GetDate() AS DateNow from t_BillCodeRule where fprojectid = 2 and fbilltypeid = 100
  --  sDateFormat = tempRs.Fields(fprojectval)
  --  sDateFormat = Format(DateValue(tempRs.Fields(DateNow)), sDateFormat)

-- 前缀
select @BillNo=fprojectval+left('0000000000',@iLength-(len(@fprojectval)))+@fprojectval from t_BillCodeRule where fprojectid = 1 and fbilltypeid = @TypeId  --@iLength

go

IF not EXISTS (select * from sysobjects where name='My_t_PackSubTemp' and xtype='u')  --drop  Table My_t_PackSubTemp
begin
	create table My_t_PackSubTemp(fuserid int,fbrandid int ,fitemid int) 
end

go

IF EXISTS (select * from sysobjects where name='My_Tri_BosPackSub_In'  and xtype='TR')  drop  TRIGGER My_Tri_BosPackSub_In
go

Create TRIGGER [dbo].[My_Tri_BosPackSub_In] ON [dbo].[t_BOSPackSub]
FOR insert

AS
BEGIN
	SET NOCOUNT ON
	declare @FInterID int  
	declare @FChecker int,@FBrandId int,@FProductID int
	declare @fbillno varchar(30)
	declare @fstatus int,@s varchar(800)
	declare @fsourcebillno varchar(50),@ftargetbillno varchar(50),@fsourceitemid int,@ftargetitemid int,@fsourceinterid int,@ftargetinterid int

	select top 1 @fbillno=fbillno,@FInterID=fid,@FSourceInterID=fid,@FChecker=isnull(FChecker,0),@FBrandId=FBrandId,@FProductID=FProductID from INSERTED 

	if exists (select 1
	from t_BosPackSub t1
	where t1.fid<>@FInterID and t1.FBrandId=@FBrandId and t1.FProductID=@FProductID
	)
	begin
		select @s='[包装方式+产品]重复!'
		--ROLLBACK TRAN
		RAISERROR(@s,18,18)
	end

END

GO

IF EXISTS (select * from sysobjects where name='My_Tri_BosPackSub'  and xtype='TR')  drop  TRIGGER My_Tri_BosPackSub
go

Create TRIGGER [dbo].[My_Tri_BosPackSub] ON [dbo].[t_BOSPackSub]
FOR UPDATE

AS
BEGIN
	SET NOCOUNT ON
	declare @FInterID int  
	declare @FChecker int,@FBrandId int,@FProductID int
	declare @fbillno varchar(30)
	declare @fstatus int,@s varchar(800)
	declare @fsourcebillno varchar(50),@ftargetbillno varchar(50),@fsourceitemid int,@ftargetitemid int,@fsourceinterid int,@ftargetinterid int

	select top 1 @fbillno=fbillno,@FInterID=fid,@FSourceInterID=fid,@FChecker=isnull(FChecker,0),@FBrandId=FBrandId,@FProductID=FProductID from INSERTED 

	/*
	if update(FChecker) and @FChecker=0  --反审核
	begin
		if exists (select 1
		from seorder t1
		inner join seorderentry t2 on t1.finterid=t2.finterid
		inner join t_icitem t4 on t4.fitemid=t2.fitemid
		where t2.fentryselfs0160=@fbillno
		)
		begin
			select @s='该包装方案已经被销售订单使用,不能反审核!'
			--ROLLBACK TRAN
			RAISERROR(@s,18,18)
		end
	end
	*/

	if update(FChecker) and @FChecker<>0  --审核
	begin
		if exists (select 1
		from t_bospacksub t1
		where t1.fbillno<>@fbillno and t1.FBrandId=@FBrandId and t1.FProductID=@FProductID and isnull(t1.fchecker,0)>0)
		begin
			set @s=''
			DECLARE icbomchild_cursor CURSOR FOR	
			select t1.fid
			from t_bospacksub t1
			where t1.fbillno<>@fbillno and t1.FBrandId=@FBrandId and t1.FProductID=@FProductID and isnull(t1.fchecker,0)>0

			OPEN icbomchild_cursor

			FETCH NEXT FROM icbomchild_cursor 
			INTO @ftargetinterid

			WHILE @@FETCH_STATUS = 0
			BEGIN 
				set @fsourceitemid=0
				set @ftargetitemid=0

				select @fsourceitemid=m1.fitemid,@ftargetitemid=m2.fitemid
				from
				(
					select t1.fitemid,t2.fnumber,sum(t1.fqty) fqty
					from t_bospacksubentry t1 
					inner join t_icitem t2 on t1.fitemid=t2.fitemid
					where t1.fid=@fsourceinterid
					group by t1.fitemid,t2.fnumber
				) m1 full join 
				(
					select t1.fitemid,t2.fnumber,sum(t1.fqty) fqty
					from t_bospacksubentry t1
					inner join t_icitem t2 on t1.fitemid=t2.fitemid
					where t1.fid=@ftargetinterid
					group by t1.fitemid,t2.fnumber
				) m2 on m1.fitemid=m2.fitemid and m1.fqty=m2.fqty 
				where m1.fitemid is null or m1.fqty is null 
				or m2.fitemid is null or m2.fqty is null  --有差异

				if @fsourceitemid=0 and @ftargetitemid=0  --没差异
				begin	
					set @fsourcebillno=(select top 1 t2.fbillno from t_icitem t1 inner join t_bospacksub t2 on t1.fitemid=t2.fproductid where t2.fid=@fsourceinterid)
					set @ftargetbillno=(select top 1 t2.fbillno from t_icitem t1 inner join t_bospacksub t2 on t1.fitemid=t2.fproductid where t2.fid=@ftargetinterid)
					set @s=@s+@fsourcebillno+' 包装方案与['+@ftargetbillno+']相同' +char(13)
				end 
				
				FETCH NEXT FROM icbomchild_cursor 
				INTO @ftargetinterid
			END
			CLOSE icbomchild_cursor
			DEALLOCATE icbomchild_cursor

			if @s<>''
			begin
				--ROLLBACK TRAN
				RAISERROR(@s,18,18)
			end
		end
	end
END


GO

--获取设计文件路径--My_P_GetPackDesighFilePath 16394,71,'xw-po1412546'

IF EXISTS (select * from sysobjects where name='My_P_GetPackDesighFilePath' and xtype='p')  drop  procedure My_P_GetPackDesighFilePath
go

create procedure [dbo].My_P_GetPackDesighFilePath (@fuserid int,@ftrantype int,@fbillno varchar(50))  --

as
set nocount on

create table #temp(findex int,fitemid int)

If @ftrantype = 71 
begin
	insert into #temp(findex,fitemid)
	select min(t1.fentryid),t3.fitemid 
	from poorder t2  
	inner join poorderentry t1 on t1.finterid=t2.finterid  
	inner join t_icitem t3 on t1.fitemid=t3.fitemid  
	where t2.fbillno=@fbillno and (t3.fshortnumber like '2%' or t3.fshortnumber like 'BX%')
	group by t3.fitemid
	order by min(t1.fentryid) 
end

If @ftrantype = 70 
begin
	insert into #temp(findex,fitemid)
	select min(t1.fentryid),t3.fitemid 
	from porequest t2  
	inner join porequestentry t1 on t1.finterid=t2.finterid  
	inner join t_icitem t3 on t1.fitemid=t3.fitemid  
	where t2.fbillno=@fbillno and (t3.fshortnumber like '2%' or t3.fshortnumber like 'BX%')
	group by t3.fitemid
	order by min(t1.fentryid) 
end

If @ftrantype = 81 
begin
	insert into #temp(findex,fitemid)
	select min(t1.fentryid),t3.fitemid
    from seorder t2  
    inner join seorderentry t1 on t1.finterid=t2.finterid  
    inner join icbom t4 on t4.fitemid=t1.fitemid 
    inner join icbomchild t5 on t4.finterid=t5.finterid  
    inner join t_icitem t3 on t5.fitemid=t3.fitemid  
    left join t_icitem t8 on t8.fitemid=t4.fitemid  
    left join t_submessage t11 on t11.finterid=t8.F_102 and t11.ftypeid=10001  
    where t2.fbillno=@fbillno and (t3.fshortnumber like '2%' or t3.fshortnumber like 'BX%') 
    group by t3.fitemid
    order by min(t1.fentryid) 
end
  
select t3.fnumber,t3.fname,isnull(t3.fmodel,'') fmodel,isnull(t3.f_105,'') fdescription,
t3.FLength,t3.FWidth,t3.FHeight,isnull(t1.fpath,'') fpath,'' 产品信息 
from t_icitem t3
inner join #temp t2 on t3.fitemid=t2.fitemid
left join My_PackDesignFilePathTemp t1 on t1.fuserid=@fuserid and Charindex(t3.fshortnumber,t1.fpath)>0
order by t2.findex

drop table #temp

set nocount off

go

--exec My_P_ProductConfig 1132,1  --select * from seorder where fbillno='XW1212001'

--产品配置--选择半成品配方
IF EXISTS (select * from sysobjects where name='My_P_ProductConfig' and xtype='p')  drop  procedure My_P_ProductConfig
go

create procedure [dbo].My_P_ProductConfig (@finterid int,@fentryid int)  --

as
set nocount on
--declare @finterid int,@fentryid int select @finterid =1127,@fentryid =1

declare @fsourcenumber varchar(20)

select top 1 @fsourcenumber=left(t4.fnumber,len(t4.fnumber)-1)
from seorderentry t1
inner join icbom t2 on t1.fitemid=t2.fitemid
inner join icbomchild t3 on t2.finterid=t3.finterid
inner join t_icitem t4 on t3.fitemid=t4.fitemid
where t1.finterid=@finterid and t1.fentryid=@fentryid

--数据源
create table #data(fitemid int,
finvqty decimal(24,4) default 0/*父项库存*/,
fwillinqty decimal(24,4) default 0/*父项预计入途*/,fwilloutqty decimal(24,4) default 0/*预计出库*/,
famount decimal(24,2) default 0/*单位成本*/,
ffinalsupportqty decimal(24,4) default 0/*最终配套数*/,fsupportqty decimal(24,4) default 0 /*配套数*/,
frequency int default 0 /*频率*/,fchilditemid int,
fchildperqty decimal(24,4) default 0,fchildprice  decimal(24,5) default 0,fchildamount decimal(24,2) default 0,
fchildtempinvqty decimal(24,4) default 0/*子项待检*/,fchildinvqty decimal(24,4) default 0/*子项库存*/,
fchildonorderqty decimal(24,4) default 0/*子项在途*/,
fchildnosendqty decimal(24,4) default 0/*子项已投未领*/,fchildnoputqty decimal(24,4) default 0/*子项已配未投*/
--fchildwilloutqty decimal(24,4) default 0 /*子项预计出库*/
)

insert into #data(fitemid,fchilditemid,fchildperqty)
select t1.fitemid,t3.fitemid,t3.fqty
from icbom t1
inner join t_icitem t2 on t1.fitemid=t2.fitemid
inner join icbomchild t3 on t1.finterid=t3.finterid
inner join t_icitem t4 on t3.fitemid=t4.fitemid
where t2.fnumber like @fsourcenumber+'%'
and t4.fnumber not like '1.02.%'
--and t1.fusestatus=1072

insert into #data(fitemid,fchilditemid,fchildperqty)
select t1.fitemid,t5.fitemid,t3.fqty*t12.fqty
from icbom t1
inner join t_icitem t2 on t1.fitemid=t2.fitemid
inner join icbomchild t3 on t1.finterid=t3.finterid
inner join t_icitem t4 on t3.fitemid=t4.fitemid
inner join icbom t11 on t11.fitemid=t3.fitemid --and t11.fusestatus=1072
inner join icbomchild t12 on t11.finterid=t12.finterid
inner join t_icitem t5 on t12.fitemid=t5.fitemid
where t2.fnumber like @fsourcenumber+'%'
and t4.fnumber like '1.02.%'
--and t1.fusestatus=1072


--选择频率--半成品
update t2 set frequency=t1.fcount
from 
(
	select t1.fentryselfs0164 fitemid,count(1) fcount 
	from seorderentry t1
	where isnull(t1.fentryselfs0164,0)<>0
	group by t1.fentryselfs0164
) t1 inner join #Data t2 on t1.fitemid=t2.fitemid

--库存--半成品
update t2 set finvqty=t1.fqty
from 
(
	select t1.fitemid,sum(t1.fqty) fqty
	from icinventory t1
	inner join t_ICItem t2 on t1.FItemID=t2.FItemID
	inner join t_stock t3 on t3.fitemid=t1.fstockid
	where --t2.ferpclsid in (1) and 
	t1.fqty>0 and t3.fname not like '%报废%' and t3.fname not like '%不良%'   
	group by t1.fitemid
) t1 inner join #Data t2 on t1.fitemid=t2.fitemid


--已禁用且没库存的
delete t1
from #data t1
inner join t_icitem t2 on t1.fitemid=t2.fitemid
where t2.fdeleted=1 and t1.finvqty=0

--已冻结且没库存的
delete t1
from #data t1
inner join t_icitem t2 on t1.fitemid=t2.fitemid
inner join t_bosfreezerequestentry t3 on t3.fitemid=t2.fitemid 
where t1.finvqty=0

--预计入库--半成品
update t2 set fwillinqty=t1.fqty
from 
(
	select t1.fitemid,sum(t1.fqty-t1.fstockqty) fqty
	from icmo t1
	inner join t_ICItem t2 on t1.FItemID=t2.FItemID
	where t1.fstatus in (1,2) and t1.fqty>t1.fstockqty
	group by t1.fitemid
) t1 inner join #Data t2 on t1.fitemid=t2.fitemid

--预计出库--半成品
update t2 set fwilloutqty=t1.fqty
from 
(
	select t1.fitemid,sum(t1.fqty) fqty
	from
	(
		select t4.fitemid,(t3.fqtymust-t3.fstockqty) fqty
		from icmo t5 
		inner join ppbom t2 on t5.finterid=t2.ficmointerid
		inner join ppbomentry t3 on t2.finterid=t3.finterid
		inner join t_icitem t4 on t3.fitemid=t4.fitemid --半成品
		inner join t_icitem t8 on t5.fitemid=t8.fitemid --成品
		where t5.fstatus in (1,2) and (t3.fqtymust-t3.fstockqty)>0 
		union all
		select t3.fitemid,t4.fqty
		from seorderentry t4 
		inner join seorder t5  on t5.finterid=t4.finterid
		inner join t_icitem t8 on t8.fitemid=t4.fitemid  --成品
		inner join t_icitem t3 on t3.fitemid=t4.fentryselfs0164 --半成品
		where t4.fmrpclosed<>1 
		--and (isnull(t5.fstatus,0)>0 or isnull(t5.FMultiCheckLevel1,0)>0) 
		and not exists (select 1 from icmo where forderinterid=t4.finterid and fsourceentryid=t4.fentryid)  --未下任务单
	) t1 group by t1.fitemid
) t1 inner join #Data t2 on t1.fitemid=t2.fitemid

--最新单价--原材料成本
--create table #newprice(fitemid int,fprice decimal(24,5)
--insert into #newprice(fitemid,fprice)

update t2 set fchildprice=t1.fprice,fchildamount=t2.fchildperqty*t1.fprice
from 
(
	select t1.fitemid,t1.fprice 
	from t_SupplyEntry t1
	left join t_supplier t2 on t1.fsupid=t2.fitemid
	left join t_icitem t3 on t1.fsupid=t3.fsource and t1.fitemid=t3.fitemid  --只抓取主供应商的价格?
) t1 inner join #Data t2 on t1.fitemid=t2.fchilditemid

--待检--原材料
--create table #TempInventory(fitemid int,fqty decimal(24,2))
--insert into #TempInventory(fitemid,   fqty)

update t2 set fchildtempinvqty=t1.fqty
from 
(
	select t1.fitemid,sum(t1.fqty) fqty
	from
	(
		--代检仓
		/*
		select t1.fitemid,t1.fqty
		from POInventory t1
		inner join t_ICItem t2 on t1.FItemID=t2.FItemID
		inner join t_stock t3 on t3.fitemid=t1.FStockID
		where t1.fqty>0 --and t1.fstockid=31441
		*/
		--已经审核且未关闭的收料通知单
		select t2.fitemid,(t2.fqty-t2.fcommitqty-t2.fbackqty) fqty
		from poinstock t1
		inner join poinstockentry t2 on t1.finterid=t2.finterid
		inner join t_icitem t3 on t2.fitemid=t3.fitemid
		inner join t_department t4 on t1.fdeptid=t4.fitemid
		where t1.fstatus in (1,2) and t2.fqty>(t2.fcommitqty+t2.fbackqty) and t1.ftrantype=72
		union all
		--代检--未审核的外购入库单
		select               t2.fitemid,t2.fqty
		from icstockbill t1
		inner join icstockbillentry t2 on t1.finterid=t2.finterid
		inner join t_icitem t3 on t2.fitemid=t3.fitemid
		where --exists (select 1 from t_systemprofile t1 where fkey = 'UpStockWhenSave' and fvalue=0) and
		t3.ferpclsid in (1) and t1.ftrantype=1 and t1.fstatus=0 and t2.FSourceTranType=72
	) t1 group by t1.fitemid
) t1 inner join #Data t2 on t1.fitemid=t2.fchilditemid

--库存--原材料
--create table #Invdata(fitemid int,fqty decimal(24,2))
--insert into #Invdata(fitemid,   fqty)

update t2 set fchildinvqty=t1.fqty
from 
(
	select t1.fitemid,sum(t1.fqty) fqty
	from icinventory t1
	inner join t_ICItem t2 on t1.FItemID=t2.FItemID
	inner join t_stock t3 on t3.fitemid=t1.fstockid
	where --t2.ferpclsid in (1) and 
	t1.fqty>0 and t3.fname not like '%报废%' and t3.fname not like '%不良%'   
	group by t1.fitemid
) t1 inner join #Data t2 on t1.fitemid=t2.fchilditemid

--在途--原材料
--create table #OnOrder(fitemid int,fqty decimal(24,2))
--insert into #OnOrder(fitemid,   fqty)

update t2 set fchildonorderqty=t1.fqty
from
(
	select fitemid,sum(t1.fqty) fqty
	from 
	(
		--在途--塑胶子件-塑胶子件收料申请单--子件在途=子件收料申请单未关联数+未审核的收料通知单
		select t2.fitemid,(t2.fqty-t2.fcommitqty) fqty
		from t_BOSPlasticPoInStock t1
		inner join t_BOSPlasticPoInStockEntry t2 on t1.fid=t2.fid
		inner join t_icitem t3 on t2.fitemid=t3.fitemid
		inner join poorderentry t7 on t7.finterid=t2.fid_src and t7.fentryid=t2.fentryid_src 
		where t7.FMrpClosed<>1 and --t1.FClosed<>1 
		isnull(t2.fmrpclosed,0)<>40019 --and t1.fstatus>0 
		and (t2.fqty-t2.fcommitqty)>0
		union all
		--在途--采购订单
		select t2.fitemid,(t2.fqty-t2.fcommitqty) fqty
		from poorder t1
		inner join poorderentry t2 on t1.finterid=t2.finterid
		inner join t_icitem t3 on t2.fitemid=t3.fitemid
		where --t1.FClosed<>1 
		t2.fmrpclosed<>1 --and t1.fstatus>0 
		and t1.fstatus<>3  --采购订单收料完毕就关闭，但不一定已经入库
		and (t2.fqty-t2.fcommitqty)>0
		union all
		--在途--采购申请单
		--insert into #OnOrder(fitemid,   fqty)
		select t2.fitemid,(t2.fqty-t2.fcommitqty) fqty
		from porequest t1
		inner join porequestentry t2 on t1.finterid=t2.finterid
		inner join t_icitem t3 on t2.fitemid=t3.fitemid
		where --t1.fstatus>0 and 
		t1.fstatus<>3 and t2.fmrpclosed<>1
		and (t2.fqty-t2.fcommitqty)>0
		union all
		--在途--未审核的收料通知单
		select               t2.fitemid,t2.fqty-t2.fcommitqty-t2.fbackqty
		from poinstock t1
		inner join poinstockentry t2 on t1.finterid=t2.finterid
		inner join t_icitem t3 on t2.fitemid=t3.fitemid
		where t1.fstatus<>3 and t1.fstatus=0 and t2.fqty>(t2.fcommitqty+t2.fbackqty)
		and t3.ferpclsid in (1) and t1.ftrantype=72  --and exists (select 1 from t_systemprofile t1 where fkey = 'UpStockWhenSave' and fvalue=0)
	) t1 group by fitemid
) t1 inner join #Data t2 on t1.fitemid=t2.fchilditemid


--已投未领--原材料
--create table #NotSend(fitemid int,fqty decimal(24,2))
--insert into #NotSend(fitemid,   fqty)

update t2 set fchildnosendqty=t1.fqty
from
(
	select t4.fitemid,sum(t4.fqtymust-t4.fstockqty) fqty
	from icmo t1 
	inner join t_icitem t2 on t1.fitemid=t2.fitemid 
	inner join ppbom t3 on t1.finterid=t3.ficmointerid 
	inner join ppbomentry t4 on t3.finterid=t4.finterid
	inner join t_icitem t5 on t5.fitemid=t4.fitemid
	where t1.fstatus in (1,5) and t4.fqtymust>t4.fstockqty 
	group by t4.fitemid
) t1 inner join #Data t2 on t1.fitemid=t2.fchilditemid

--已配未投--原材料
--create table #NotPut(fitemid int,fqty decimal(24,2))
--insert into #NotPut(fitemid,   fqty)

update t2 set fchildnoputqty=t1.fqty
from
(
	select t4.fitemid,sum(t2.fqty*t4.fqty) fqty
	from seorder t1 
	inner join seorderentry t2 on t1.finterid=t2.finterid 
	inner join icbom t3 on t2.fitemid=t3.fitemid 
	inner join icbomchild t4 on t3.finterid=t4.finterid
	inner join t_icitem t5 on t5.fitemid=t4.fitemid
	inner join t_icitem t6 on t6.fitemid=t2.fitemid
	where not (t2.finterid=@finterid and t2.fentryid=@fentryid) --and len(t6.fnumber)>10--已经选了配方的
	and not exists (select 1 from icmo where forderinterid=t2.finterid and fsourceentryid=t2.fentryid)  --未下任务
	group by t4.fitemid
) t1 inner join #Data t2 on t1.fitemid=t2.fchilditemid

--select * from #Data order by fitemid

update #data set fsupportqty=(fchildtempinvqty+fchildinvqty+fchildonorderqty-fchildnosendqty-fchildnoputqty)/fchildperqty

--可配套--以最小套为准--半成品
update t1 set ffinalsupportqty=t2.fsupportqty
from #data t1
inner join (select fitemid,min(fsupportqty) fsupportqty from #data group by fitemid) t2 on t1.fitemid=t2.fitemid

--单位成本--半成品
update t1 set famount=t2.fallamount
from #data t1
inner join (select fitemid,sum(famount) fallamount from #data group by fitemid) t2 on t1.fitemid=t2.fitemid

select t2.fitemid 产品内码,t2.fnumber 产品编码,t2.fname 产品名称,
isnull(t2.F_105,'')+'///'+isnull(t2.fmodel,'') 产品规格型号,
t1.finvqty 父项库存,t1.fwillinqty 父项预计入库,t1.fwilloutqty 父项预计出库,
(t1.finvqty+t1.fwillinqty-t1.fwilloutqty) 父项预计可用,
(case when t4.fusestatus=1072 then 'Y' else '' end) BOM使用状态,
t1.famount 单位成本,t1.ffinalsupportqty 可配套,
t3.fnumber 子项编码,t3.fname 子项名称,isnull(t3.F_105,'')+'///'+isnull(t3.fmodel,'') 子项规格型号,
t1.fchildperqty 子项用量,t1.fchildprice 单价,t1.fchildamount 金额,t1.fchildinvqty 子项库存,t1.fchildtempinvqty 子项待检,
t1.fchildonorderqty 子项在途,t1.fchildnosendqty 子项已投未领,t1.fchildnoputqty 子项已配未投,
(t1.fchildtempinvqty+t1.fchildinvqty+t1.fchildonorderqty-t1.fchildnosendqty-t1.fchildnoputqty) 子项预计可用
from #data t1
inner join t_icitem t2 on t1.fitemid=t2.fitemid
inner join t_icitem t3 on t3.fitemid=t1.fchilditemid
inner join icbom t4 on t2.fitemid=t4.fitemid 
where t2.FDeleted<>1
order by t1.frequency desc,t1.famount,t1.ffinalsupportqty desc,t2.fnumber,t3.fnumber

drop table #data

set nocount off

go

--变更制单人--获取修改权限
IF EXISTS (select * from sysobjects where name='My_P_ChangeBiller' and xtype='p')  drop  procedure My_P_ChangeBiller
go

create procedure [dbo].My_P_ChangeBiller (@finterid int,@ftrantype int,@fuserid int)  --

as

if @ftrantype=72
begin
	update t1 set fheadselfp0339=t2.fname
	from poinstock t1
	inner join t_user t2 on t1.fbillerid=t2.fuserid
	where t1.finterid=@finterid and isnull(t1.fheadselfp0339,'')='' and t1.ftrantype=72 and t1.fstatus=0

	update t1 set fbillerid=@fuserid from poinstock t1 where t1.finterid=@finterid and fstatus=0 and t1.ftrantype=72
end 

if @ftrantype=83
begin
	update t1 set fheadselfs0245=t2.fname
	from seoutstock t1
	inner join t_user t2 on t1.fbillerid=t2.fuserid
	where t1.finterid=@finterid and isnull(t1.fheadselfs0245,'')='' and t1.fstatus=0

	update t1 set fbillerid=@fuserid from seoutstock t1 where t1.finterid=@finterid and fstatus=0
end 

if @ftrantype=24
begin
	update t1 set fheadselfb0439=t2.fname
	from icstockbill t1
	inner join t_user t2 on t1.fbillerid=t2.fuserid
	where t1.finterid=@finterid and isnull(t1.fheadselfb0439,'')='' and t1.fstatus=0
end 

if @ftrantype=41
begin
	update t1 set fheadselfd0134=t2.fname
	from icstockbill t1
	inner join t_user t2 on t1.fbillerid=t2.fuserid
	where t1.finterid=@finterid and isnull(t1.fheadselfd0134,'')='' and t1.fstatus=0
end 

if @ftrantype=29
begin
	update t1 set fheadselfb0937=t2.fname
	from icstockbill t1
	inner join t_user t2 on t1.fbillerid=t2.fuserid
	where t1.finterid=@finterid and isnull(t1.fheadselfb0937,'')='' and t1.fstatus=0
end 

if @ftrantype in (24,41,29)
begin
	update t1 set fbillerid=@fuserid from icstockbill t1 where t1.finterid=@finterid and fstatus=0
end

if @ftrantype=26
begin
	update t1 set fheadselfzou37=t2.fname
	from zpstockbill t1
	inner join t_user t2 on t1.fbillerid=t2.fuserid
	where t1.finterid=@finterid and isnull(t1.fheadselfzou37,'')='' and t1.fstatus=0

	update t1 set fbillerid=@fuserid from zpstockbill t1 where t1.finterid=@finterid and fstatus=0
end 

go

--
-----获取理论库存
--IF EXISTS (select * from sysobjects where name='My_P_GetTheoryInv' and xtype='p')  drop  procedure My_P_GetTheoryInv
--go
--
--create procedure [dbo].My_P_GetTheoryInv (@finterid int,@ftrantype int,@fitemid int,@fqty decimal(24,4) output)  --
--
--as
--
--set nocount on
--
--declare @finvqty decimal(24,4),@fwillinqty decimal(24,4),@fwilloutqty decimal(24,4)
--
--select @finvqty=0,@fwillinqty=0,@fwilloutqty=0
--
--/*
--select fitemid,fname,* from t_stock
--16478	来料不良品仓
--16479	装配车间仓
--16480	包装车间仓
--16572	作业不良品仓
--16573	报废仓
--*/
--
--if @ftrantype in (24,29,41)
--begin
--	select @finvqty=sum(t1.fqty)
--	from icinventory t1
--	where t1.fitemid=@fitemid and t1.fstockid not in (16478,16479,16480,16572,16573)
--	group by t1.fitemid
--
--	select @fwillinqty=sum(t2.fqty)
--	from icstockbill t1
--	inner join icstockbillentry t2 on t1.finterid=t2.finterid
--	where t1.ftrantype in (1,2,5,10,40) and t1.finterid<>@finterid and t2.fitemid=@fitemid and t1.fstatus=0 
--	group by t2.fitemid
--
--	select @fwilloutqty=sum(t2.fqty)
--	from icstockbill t1
--	inner join icstockbillentry t2 on t1.finterid=t2.finterid
--	where t1.ftrantype in (21,24,28,29,43) and t1.finterid<>@finterid and t2.fitemid=@fitemid and t1.fstatus=0 
--	group by t2.fitemid
--end 
--
--if @ftrantype in (26)
--begin
--	select @finvqty=sum(t1.fqty)
--	from poinventory t1
--	where t1.fitemid=@fitemid
--	group by t1.fitemid
--
--	select @fwillinqty=sum(t2.fqty)
--	from zpstockbill t1
--	inner join zpstockbillentry t2 on t1.finterid=t2.finterid
--	where t1.ftrantype in (6) and t1.finterid<>@finterid and t2.fitemid=@fitemid and t1.fstatus=0 
--	group by t2.fitemid
--
--	select @fwilloutqty=sum(t2.fqty)
--	from zpstockbill t1
--	inner join zpstockbillentry t2 on t1.finterid=t2.finterid
--	where t1.ftrantype in (26) and t1.finterid<>@finterid and t2.fitemid=@fitemid and t1.fstatus=0 
--	group by t2.fitemid
--end 
--
--select @fqty=@finvqty+@fwillinqty-@fwilloutqty
--
--set nocount off
--
--go


--产品配置--选择芯片
IF EXISTS (select * from sysobjects where name='My_P_ChipConfig' and xtype='p')  drop  procedure My_P_ChipConfig
go

create procedure [dbo].My_P_ChipConfig (@finterid int,@fentryid int)  --

as
set nocount on
--declare @finterid int,@fentryid int select @finterid =0,@fentryid =0

--数据源
create table #data(fitemid int,fchilditemid int,
fchildperqty decimal(24,4) default 0,fchildprice  decimal(24,5) default 0,fchildamount decimal(24,2) default 0,
fchildtempinvqty decimal(24,4) default 0/*待检*/,fchildinvqty decimal(24,4) default 0/*库存*/,
fchildonorderqty decimal(24,4) default 0/*在途*/,fchildnosendqty decimal(24,4) default 0/*已投未领*/,
fchildnoputqty decimal(24,4) default 0/*已配未投*/)

insert into #data(fitemid,fchilditemid,fchildperqty)
select t1.fproductid,t3.fitemid,1
from t_BOSChipMapping t1
inner join t_icitem t2 on t1.fproductid=t2.fitemid
inner join t_BOSChipMappingEntry t3 on t1.fid=t3.fid
inner join t_icitem t4 on t3.fitemid=t4.fitemid
inner join seorderentry t5 on t5.fitemid=t1.fproductid and t5.fentryselfs0160=t3.fchipverid
where t5.finterid=@finterid and t5.fentryid=@fentryid

--最新单价--原材料成本
--create table #newprice(fitemid int,fprice decimal(24,5)
--insert into #newprice(fitemid,fprice)

update t2 set fchildprice=t1.fprice,fchildamount=t2.fchildperqty*t1.fprice
from 
(
	select t1.fitemid,t1.fprice 
	from t_SupplyEntry t1
	left join t_supplier t2 on t1.fsupid=t2.fitemid
	left join t_icitem t3 on t1.fsupid=t3.fsource and t1.fitemid=t3.fitemid  --只抓取主供应商的价格?
) t1 inner join #Data t2 on t1.fitemid=t2.fchilditemid

--待检--原材料
--create table #TempInventory(fitemid int,fqty decimal(24,2))
--insert into #TempInventory(fitemid,   fqty)

update t2 set fchildtempinvqty=t1.fqty
from 
(
	select t1.fitemid,sum(t1.fqty) fqty
	from
	(
		--代检仓
		/*
		select t1.fitemid,t1.fqty
		from POInventory t1
		inner join t_ICItem t2 on t1.FItemID=t2.FItemID
		inner join t_stock t3 on t3.fitemid=t1.FStockID
		where t1.fqty>0 --and t1.fstockid=31441
		*/
		--已经审核且未关闭的收料通知单
		select t2.fitemid,(t2.fqty-t2.fcommitqty-t2.fbackqty) fqty
		from poinstock t1
		inner join poinstockentry t2 on t1.finterid=t2.finterid
		inner join t_icitem t3 on t2.fitemid=t3.fitemid
		inner join t_department t4 on t1.fdeptid=t4.fitemid
		where t1.fstatus in (1,2) and t2.fqty>(t2.fcommitqty+t2.fbackqty) and t1.ftrantype=72
		union all
		--代检--未审核的外购入库单
		select               t2.fitemid,t2.fqty
		from icstockbill t1
		inner join icstockbillentry t2 on t1.finterid=t2.finterid
		inner join t_icitem t3 on t2.fitemid=t3.fitemid
		where --exists (select 1 from t_systemprofile t1 where fkey = 'UpStockWhenSave' and fvalue=0) and
		t3.ferpclsid in (1) and t1.ftrantype=1 and t1.fstatus=0 and t2.FSourceTranType=72
	) t1 group by t1.fitemid
) t1 inner join #Data t2 on t1.fitemid=t2.fchilditemid

--库存--原材料
--create table #Invdata(fitemid int,fqty decimal(24,2))
--insert into #Invdata(fitemid,   fqty)

update t2 set fchildinvqty=t1.fqty
from 
(
	select t1.fitemid,sum(t1.fqty) fqty
	from icinventory t1
	inner join t_ICItem t2 on t1.FItemID=t2.FItemID
	inner join t_stock t3 on t3.fitemid=t1.fstockid
	where --t2.ferpclsid in (1) and 
	t1.fqty>0 --and t3.fnumber not like 'F.%'  and t3.fitemid not in (31438,39170)
	and t1.fstockid not in (16478,16479,16480,16572,16573)
	group by t1.fitemid
) t1 inner join #Data t2 on t1.fitemid=t2.fchilditemid

--在途--原材料
--create table #OnOrder(fitemid int,fqty decimal(24,2))
--insert into #OnOrder(fitemid,   fqty)

update t2 set fchildonorderqty=t1.fqty
from
(
	select fitemid,sum(t1.fqty) fqty
	from 
	(
		--在途--采购订单
		select t2.fitemid,(t2.fqty-t2.fcommitqty) fqty
		from poorder t1
		inner join poorderentry t2 on t1.finterid=t2.finterid
		inner join t_icitem t3 on t2.fitemid=t3.fitemid
		where --t1.FClosed<>1 
		t2.fmrpclosed<>1 --and t1.fstatus>0 
		and t1.fstatus<>3  --采购订单收料完毕就关闭，但不一定已经入库
		and (t2.fqty-t2.fcommitqty)>0
		union all
		--在途--采购申请单
		--insert into #OnOrder(fitemid,   fqty)
		select t2.fitemid,(t2.fqty-t2.fcommitqty) fqty
		from porequest t1
		inner join porequestentry t2 on t1.finterid=t2.finterid
		inner join t_icitem t3 on t2.fitemid=t3.fitemid
		where --t1.fstatus>0 and 
		t1.fstatus<>3 and t2.fmrpclosed<>1
		and (t2.fqty-t2.fcommitqty)>0
		union all
		--在途--未审核的收料通知单
		select               t2.fitemid,t2.fqty-t2.fcommitqty-t2.fbackqty
		from poinstock t1
		inner join poinstockentry t2 on t1.finterid=t2.finterid
		inner join t_icitem t3 on t2.fitemid=t3.fitemid
		where t1.fstatus<>3 and t1.fstatus=0 and t2.fqty>(t2.fcommitqty+t2.fbackqty)
		and t3.ferpclsid in (1) and t1.ftrantype=72  --and exists (select 1 from t_systemprofile t1 where fkey = 'UpStockWhenSave' and fvalue=0)
	) t1 group by fitemid
) t1 inner join #Data t2 on t1.fitemid=t2.fchilditemid

--已投未领--原材料
--create table #NotSend(fitemid int,fqty decimal(24,2))
--insert into #NotSend(fitemid,   fqty)

update t2 set fchildnosendqty=t1.fqty
from
(
	select t4.fitemid,sum(t4.fqtymust-t4.fstockqty) fqty
	from icmo t1 
	inner join t_icitem t2 on t1.fitemid=t2.fitemid 
	inner join ppbom t3 on t1.finterid=t3.ficmointerid 
	inner join ppbomentry t4 on t3.finterid=t4.finterid
	inner join t_icitem t5 on t5.fitemid=t4.fitemid
	where t1.fstatus in (1,5) and t4.fqtymust>t4.fstockqty 
	group by t4.fitemid
) t1 inner join #Data t2 on t1.fitemid=t2.fchilditemid

--已配未投--原材料
--create table #NotPut(fitemid int,fqty decimal(24,2))
--insert into #NotPut(fitemid,   fqty)

update t2 set fchildnoputqty=t1.fqty
from
(
	select t4.fitemid,sum(t2.fqty*t4.fqty) fqty
	from seorder t1 
	inner join seorderentry t2 on t1.finterid=t2.finterid 
	inner join icbom t3 on t2.fitemid=t3.fitemid 
	inner join icbomchild t4 on t3.finterid=t4.finterid
	inner join t_icitem t5 on t5.fitemid=t4.fitemid
	inner join t_icitem t6 on t6.fitemid=t2.fitemid
	where not (t2.finterid=@finterid and t2.fentryid=@fentryid) --and len(t6.fnumber)>10--已经选了配方的
	and not exists (select 1 from icmo where forderinterid=t2.finterid and fsourceentryid=t2.fentryid)  --未下任务
	group by t4.fitemid
) t1 inner join #Data t2 on t1.fitemid=t2.fchilditemid

--select * from #Data order by fitemid

select t3.fitemid 芯片内码,t3.fnumber 芯片编码,t3.fname 芯片名称,isnull(t3.F_105,'')+'///'+isnull(t3.fmodel,'') 规格型号,
t1.fchildperqty 用量,t1.fchildprice 单价,t1.fchildinvqty 库存,t1.fchildtempinvqty 待检,
t1.fchildonorderqty 在途,t1.fchildnosendqty 已投未领,t1.fchildnoputqty 已配未投,
(t1.fchildtempinvqty+t1.fchildinvqty+t1.fchildonorderqty-t1.fchildnosendqty-t1.fchildnoputqty) 预计可用
from #data t1
inner join t_icitem t2 on t1.fitemid=t2.fitemid
inner join t_icitem t3 on t3.fitemid=t1.fchilditemid
where t2.FDeleted<>1
order by t3.fnumber

drop table #data

set nocount off

go

--*****
IF not EXISTS (select * from sysobjects where name='My_t_ICMOTemp' and xtype='u')  --drop  Table My_t_ICMOTemp
begin
	create table My_t_ICMOTemp(findex int IDENTITY (1, 1),fuserid int,finterid int,
	FInQty decimal(24,2),FRptQty decimal(24,2)) 
end

go

--*****
IF not EXISTS (select * from sysobjects where name='My_t_PPBomTemp' and xtype='u')  --drop  Table My_t_PPBomTemp
begin
	create table My_t_PPBomTemp(findex int IDENTITY (1, 1),fuserid int,finterid int,FEntryID int) 
end

go

IF EXISTS (select * from sysobjects where name='My_t_ICMOTemp' and xtype='u') and not EXISTS (select t1.id
from sysobjects t1 
inner join syscolumns t2 on t1.id=t2.id
where t1.name='My_t_ICMOTemp' and t1.xtype='u' and t2.name='findex')
begin
	alter table My_t_ICMOTemp add findex int IDENTITY (1, 1)
end

go

--*****
IF not EXISTS (select * from sysobjects where name='My_t_OutOrBackRequestTemp' and xtype='u')  --drop  Table My_t_OutOrBackRequestTemp
begin
	create table My_t_OutOrBackRequestTemp(fuserid int,finterid int) 
end

go


--*****
IF not EXISTS (select * from sysobjects where name='My_t_OtherOutRequestTemp' and xtype='u')  --drop  Table My_t_OtherOutRequestTemp
begin
	create table My_t_OtherOutRequestTemp(fuserid int,finterid int) 
end

go

--*****
IF not EXISTS (select * from sysobjects where name='My_t_POOrderTemp' and xtype='u')  --drop  Table My_t_POOrderTemp
begin
	create table My_t_POOrderTemp(findex int IDENTITY (1, 1),fuserid int,finterid int,
	fentryid int,FReceiveQty decimal(24,2) ) 
end

go

IF EXISTS (select * from sysobjects where name='My_t_POOrderTemp' and xtype='u') and not EXISTS (select t1.id
from sysobjects t1 
inner join syscolumns t2 on t1.id=t2.id
where t1.name='My_t_POOrderTemp' and t1.xtype='u' and t2.name='findex')
begin
	alter table My_t_POOrderTemp add findex int IDENTITY (1, 1)
end

go


IF EXISTS (select * from sysobjects where name='My_F_Charindex' and xtype='FN')  drop  function My_F_Charindex  

go

create function [dbo].[My_F_Charindex](@Str varchar(8000),@StrSep varchar(10),@AppPos int) returns int
begin
    declare @i int
    declare @ii int
    set @Str=rtrim(ltrim(@Str))
    set @i=1
    select @ii=charindex(@StrSep,@Str)
    if @i=@AppPos
        return @ii
    else
    while @AppPos>@i
    begin
        if charindex(@StrSep,right(@Str,len(@Str)-@ii))<>0
                select @ii=charindex(@StrSep,right(@Str,len(@Str)-@ii))+@ii
        else
                set @ii=0
        set @i=@i+1
    end

    return @ii
end

go

--&&&&&
--exec My_p_UpdateBillRelateData_24_26 24,25168--如果是审核后更新库存，则审核后调用，否则保存时调用--暂时未使用 

IF EXISTS (select * from sysobjects where name='My_p_UpdateBillRelateData_24_26' and xtype='p')  drop  procedure My_p_UpdateBillRelateData_24_26  --一定是审核时调用，考虑性能问题

go

create procedure My_p_UpdateBillRelateData_24_26 (@ftrantype int,@FInterid int) --@ftype 0 删除 1 保存 2 反审核 3 审核 
as

set nocount on 

select @ftrantype=@ftrantype

--IF @ftrantype=24  --   
--BEGIN
--	--更新计划投料单已领数量/未领数量--暂时未使用
--	update t1 set fcommitqty=isnull(t2.fqty,0),FNoOutStockQty=t1.fqty-isnull(t2.fqty,0)  --t2.fqty 为目前已领数量
--	from t_BOSPlanChangeStockEntry t1 --
--	inner join 
--	(
--		select t1.fitemid,t3.forderinterid,t3.fsourceentryid,isnull(sum(t1.fqty),0) fqty
--		from ICStockBill t0 --
--		inner join ICStockBillEntry t1 on t0.finterid=t1.finterid  --
--		inner join icmo t3 on t3.finterid=t1.ficmointerid
--		inner join 
--		(	  
--			  select distinct t2.forderinterid,t2.fsourceentryid 
--			  from ICStockBillEntry t1--
--			  inner join icmo t2 on t1.ficmointerid=t2.finterid
--			  where t1.finterid=@finterid 
--		) t2 on t3.forderinterid=t2.forderinterid and t3.fsourceentryid=t2.fsourceentryid
--		where t0.ftrantype=24 and t0.fstatus>0
--		group by t3.forderinterid,t3.fsourceentryid,t1.fitemid
--	) t2 on t1.FID_SRC=t2.forderinterid and t1.FEntryID_SRC=t2.fsourceentryid and t1.fitemid=t2.fitemid
--	--where isnull(t1.fmrpclosed,0)<>40019 

	--ICStockBill领料单K3是自动反写[领料数]的,只要icmointerid和ppbomentryid正确即可
	--[选单数]在删除时的触发器ICStockBill_DEL和保存时的触发器My_Tri_ICStockBill_In直接写明
--	update t1 set fstockqty=isnull(t2.fqty,0),fauxstockqty=isnull(t2.fqty,0)
--	from PPBOMEntry t1 --
--	inner join 
--	(
--		select t1.ficmointerid,t1.fppbomentryid,t1.fitemid,sum(t1.fqty) fqty
--		from ICStockBill t0 --
--		inner join ICStockBillEntry t1 on t0.finterid=t1.finterid  --
--		inner join 
--		(	  
--			  select distinct t1.ficmointerid 
--			  from ICStockBillEntry t1--
--			  where t1.finterid=@finterid 
--		) t2 on t1.ficmointerid=t2.ficmointerid
--		inner join icmo t3 on t3.finterid=t1.ficmointerid
--		where t0.ftrantype=24 and t0.fstatus>0 and t1.fsourcetrantype in (85,200000014)
--		group by t1.ficmointerid,t1.fppbomentryid,t1.fitemid
--	) t2 on t1.ficmointerid=t2.ficmointerid and t1.FEntryID=t2.fppbomentryid and t1.fitemid=t2.fitemid
--end

--IF @ftrantype=26  --更新计划投料单的已领数量/未领数量
--BEGIN
--	--暂时未使用 
--	update t1 set fcommitqty=isnull(t2.fqty,0),FNoOutStockQty=t1.fqty-isnull(t2.fqty,0)  --t2.fqty 为目前已领数量
--	from t_BOSPlanChangeStockEntry t1 --
--	inner join 
--	(
--		select t1.fitemid,t3.forderinterid,t3.fsourceentryid,sum(t1.fqty) fqty
--		from ZPStockBill t0 --
--		inner join ZPStockBillEntry t1 on t0.finterid=t1.finterid  --
--		inner join icmo t3 on t3.finterid=t1.FSourceInterId
--		inner join 
--		(	  
--			  select distinct t3.forderinterid,t3.fsourceentryid 
--			  from ZPStockBillEntry t1--
--			  inner join icmo t3 on t3.finterid=t1.FSourceInterId	
--			  where t1.finterid=@finterid 
--		) t2 on t3.forderinterid=t2.forderinterid and t3.fsourceentryid=t2.fsourceentryid
--		where t0.ftrantype=26 and ((t0.fstatus>0 and t0.FUpStockWhenSave=0) or (t0.fstatus=0 and t0.FUpStockWhenSave=1))
--		group by t3.forderinterid,t3.fsourceentryid,t1.fitemid
--	) t2 on t1.FID_SRC=t2.forderinterid and t1.FEntryID_SRC=t2.fsourceentryid and t1.fitemid=t2.fitemid

	--ZpStockBill反审核和审核已经在触发器My_Tri_ZPStockBill_In中直接写明
	--删除已经在触发器ZPStockBill_DEL中直接写明;保存已经在触发器My_Tri_ZPStockBill中直接写明;
	--更新投料单的已领数量 --因为虚仓单审核，K3自带的功能是不能反写的;
--	update t1 set fstockqty=isnull(t2.fqty,0),fauxstockqty=isnull(t2.fqty,0)
--	from PPBOMEntry t1 --
--	inner join 
--	(
--		select t1.ficmointerid,t1.fppbomentryid,t1.fitemid,sum(t1.fqty) fqty
--		from ZPStockBill t0 --
--		inner join ZPStockBillEntry t1 on t0.finterid=t1.finterid  --
--		inner join 
--		(	  
--			  select distinct t1.ficmointerid 
--			  from ZPStockBillEntry t1--
--			  where t1.finterid=@finterid 
--		) t2 on t1.ficmointerid=t2.ficmointerid
--		inner join icmo t3 on t3.finterid=t1.ficmointerid
--		where t0.ftrantype=26 and t0.fstatus>0 and t1.fsourcetrantype in (85,200000014)
--		group by t1.ficmointerid,t1.fppbomentryid,t1.fitemid
--	) t2 on t1.ficmointerid=t2.ficmointerid and t1.FEntryID=t2.fppbomentryid and t1.fitemid=t2.fitemid
--end

set nocount off

go


----批量生成调拨单--由日计划明细生成(原来是生成直入直出单据)--还是直接由销售订单生成生产领料单????
----My_P_GenerateChangeStock 16394,'',''
--IF EXISTS (select * from sysobjects where name='My_P_GenerateChangeStock' and xtype='p')  drop  procedure My_P_GenerateChangeStock
--
--go
--
--create procedure  [dbo].My_P_GenerateChangeStock(@fuserid int,@fbegbillno varchar(30) output,@fendbillno varchar(30) output,@fidentify int output)  --
--
--as
--set nocount on
--
----declare @ficmointerid int,@finbillno varchar(30),@ftype int set @ficmointerid=293576--select * from My_t_ICMOTemp
--
--declare @ficmointerid int,@fcostobjid int,@FDIOFInFanager int,@FDIOFOutSanager int
--declare @fcheck_fail int,@fppbominterid int,@FDIOFInSanager int,@FDIOFOutFanager int
--declare @fsrccommitfield_prevalue decimal(28,13),@fininterid int
--declare @fsrccommitfield_endvalue decimal(28,13),@UpStockWhenSave int,@fspid int,@fempid int,@fdeptid int,@fppbomentryid int
--declare @foutinterid int,@fpqty int,@xx_FItemIDOld int,@fxxitemid int,@InterId int,@CostObjGroupID int
--declare @fplanamount decimal (24,2),@fstockid int,@fcbitemid int,@frob int,@fisbackflush int
--declare @fsourceInterid int,@fsourceEntryid int,@fsourceBillNo varchar (100),@FCustBillNo varchar(30)
--declare @ficmobillno varchar(20),@UserId int,@fqtymust int,@s varchar(5000),@fstockmanagerid int
--
--declare @fplanprice decimal(18,4),@fitemid int,@funitid int,@entryid int,@fqty int
--declare @FInterID int,@BillNo varchar (20),@StockId int,@StockNumber varchar (20)
--DECLARE @TmpID INT ,@fperqty int,@fsourceqty int,@iLength int,@iFind bit,@finqty int
--declare @fprojectval  varchar(200),@FDateFormat  varchar(200),@fcount int,@fplanbegindate datetime
--declare @FDCStockID int,@FSCStockID int,@FDCSPID int,@fscspid int,@FVersion int
--declare @famount decimal (18,2),@fpitemid int,@fdate datetime,@fserial int,@FStockManagerName varchar(30)
--declare @foutbillinterid int,@foutbillentryid int,@FSrcMpsPlanOrderInterid int,@fmpsqty int,@fsourceplanbegindate datetime
--declare @findex int,@fsrcplanorderinterid int,@flag int,@FVarSrcPlanOrderInterid int
--declare @iCurrentRecord int,@k int,@fxishu int,@forderinterid int,@forderentryid int
--declare @forderqty int,@foutqty int,@iMaxRecord int,@fsourcetrantype int,@ffmanagerid int
--
--
--select @fidentify=isnull(max(fid),0)+1 from my_t_identify
--insert into my_t_identify(fid,fuserid,fdate,FTrantypeID) values(@fidentify,@fuserid,getdate(),41)
--
--select @fdate=replace(convert(varchar(10),getdate(),111),'/','-'),@fcount=1,@fbegbillno='',@fendbillno=''
----select fnumber,fname,* from t_emp where fname like '莫%'
--
--select @UpStockWhenSave=fvalue from T_SYSTEMPROFILE where  fkey='UPSTOCKWHENSAVE'
--
--select 0 ficmointerid,0 fcbitemid,t3.fqty fqtymust,t3.fqty, 
--0 fppbominterid,0 fppbomentryid,t3.fdeptid,isnull(t4.fdefaultloc,0) FSCStockID, --调出仓库 	
--0 FCostObjID,t4.ferpclsid,0 fplanprice,0 fplanamount,cast('' as varchar(10)) ficmobillno,t3.funitid,
--18106 FDCStockID,--调入仓库 --包装车间计划仓
--t3.fitemid,t1.fbillno fsourcebillno,
----t3.forderinterid fsourceinterid,t3.forderentryid fsourceentryid,--不用订单内码了
--t3.finterid fsourceinterid,0 fsourceentryid,
--81 fsourcetrantype,t17.finterid fisbackflush,
--t13.finterid fstockmanagerid,isnull((select top 1 fitemid from t_emp where fname=t13.fname),25326) ffmanagerid,t3.fdate fplanbegindate
--into #SourceData
--from My_t_ScheduleDetailTemp t2 
--inner join my_t_scheduledetail t3 on t2.finterid=t3.finterid
--inner join t_icitem t4 on t3.fitemid=t4.fitemid
--inner join t_SubMessage t13 on t13.finterid=t4.f_114 and t13.ftypeid=10004  --仓管员
--inner join t_SubMessage t17 on t17.finterid=t4.f_115 and t17.ftypeid=10003  --倒冲
--inner join t_department t7 on t7.fitemid=t3.fdeptid
--inner join seorder t1 on t1.finterid=t3.forderinterid
--where t2.fuserid=@fuserid and t4.ferpclsid<>2 and t4.fnumber not like '7.%' --
----order by t4.fshortnumber
--
--
----仓管员
--DECLARE icbom_cursor CURSOR FOR	
--select distinct t1.fstockmanagerid --t1.fdeptid,t1.fsourcetrantype,t1.fsourceinterid,t1.fisbackflush,
--from #SourceData t1 
--inner join t_icitem t2 on t1.fitemid=t2.fitemid --where fnumber like '01.%' and fnumber not like '01.01.%'  --屏蔽掉产成品,半成品/原材料/委外件都自动生成领料单
--order by t1.fstockmanagerid --,t1.fdeptid,t1.fsourcetrantype,t1.fsourceinteridt1.fisbackflush,
--
--OPEN icbom_cursor
--
--FETCH NEXT FROM icbom_cursor 
--INTO @fstockmanagerid --@fdeptid,@fsourcetrantype,@fsourceinterid,@fisbackflush,
--
--WHILE @@FETCH_STATUS = 0
--BEGIN 
--	exec My_p_GetBillNo 41,'icstockbill',@Interid output, @BillNo output
--
--    if @fcount=1 set @fbegbillno=@BillNo
--		           	
--	DECLARE authors_cursor CURSOR FOR	
--
--	select t1.fsourcetrantype,t1.fsourceinterid,t1.fsourcebillno,t1.fsourceentryid,t1.ffmanagerid,t1.fplanbegindate,t1.fcbitemid,t1.fitemid,t1.funitid,t1.FSCStockID,t1.FDCStockID,t1.fdeptid,t1.fqtymust,t1.fqty,t1.ficmointerid,t1.ficmobillno,t1.fplanprice,t1.fplanamount,t1.fcostobjid,t1.fppbominterid,t1.fppbomentryid 
--	from #SourceData t1
--	inner join t_icitem t2 on t1.fitemid=t2.fitemid
--	where t1.fstockmanagerid=@fstockmanagerid  --t1.fdeptid=@fdeptid and t1.fsourcetrantype=@fsourcetrantype and t1.fsourceinterid=@fsourceinterid and t1.fisbackflush=@fisbackflush and 
--	order by t2.fnumber
--
--    set @entryid=1
--
--	OPEN authors_cursor
--
--	FETCH NEXT FROM authors_cursor 
--	INTO @fsourcetrantype,@fsourceinterid,@fsourcebillno,@fsourceentryid,@ffmanagerid,@fplanbegindate,@fcbitemid,@fitemid,@funitid,@FSCStockID,@FDCStockID,@fdeptid,@fqtymust,@fqty,@ficmointerid,@ficmobillno,@fplanprice,@fplanamount,@fcostobjid,@fppbominterid,@fppbomentryid
--
--	WHILE @@FETCH_STATUS = 0
--	BEGIN 		
--		INSERT INTO ICStockBillEntry (FInterID,FEntryID,FBrNo,FItemID,FAuxPropID,FBatchNo,FQtyMust, FQty,     FReProduceType,FCostOBJID, FCostObjGroupID,FUnitID ,FAuxQtyMust,Fauxqty,FSecCoefficient,FSecQty,FAuxPlanPrice,FPlanAmount, Fauxprice,Famount,FBomInterID,Fnote,FKFDate,FKFPeriod,FPeriodDate,FSCStockID, FDCStockID, FOperSN,FOperID,FSNListID,FSourceBillNo,  FSourceTranType,FSourceInterId,   FSourceEntryID,  FICMOBillNo, FICMOInterID, FPPBomEntryID, FInStockID) 
--		VALUES (                      @Interid,@EntryId,'0',  @fitemid,0,        '',      @fqtymust,@fqty   , 1059,          @fcostobjid,0,              @FUnitID,@fqtymust , @fqty,  0,              0,      @fplanprice,  @fplanamount,0,        0,      0,          '',   Null,   0,        Null,       @FSCStockID,@FDCStockID,0,      0,      0,        @FSourceBillNo, 81,             @FSourceInterId,  @FSourceEntryID, @ficmobillno,@ficmointerid,@fppbomentryid,0) 
--
--		set @entryid=@entryid+1
--		set @fcount=@fcount+1
--
--		FETCH NEXT FROM authors_cursor 
--		INTO @fsourcetrantype,@fsourceinterid,@fsourcebillno,@fsourceentryid,@ffmanagerid,@fplanbegindate,@fcbitemid,@fitemid,@funitid,@FSCStockID,@FDCStockID,@fdeptid,@fqtymust,@fqty,@ficmointerid,@ficmobillno,@fplanprice,@fplanamount,@fcostobjid,@fppbominterid,@fppbomentryid
--	END
--
--	CLOSE authors_cursor
--	DEALLOCATE authors_cursor
--
--	/*
--	if @fsourcetrantype=81
--		select @fsourcebillno=fbillno,@FCustBillNo=fheadselfs0144 from seorder where finterid=@fsourceinterid
--	else
--		select @fsourcebillno=fbillno from pporder where finterid=@fsourceinterid
--	*/
--
--	INSERT INTO ICStockBill(fheadselfd0133,fheadselfd0132,FInterID,FBillNo,FBrNo,FTranType,FCancellation,FStatus,FUpStockWhenSave,FVchInterID,FROB,    FHookStatus,Fdate, FDeptID, Fuse,FCheckDate,FSManagerID, FFManagerID,  FBillerID,   FAcctID,FMultiCheckLevel1,FMultiCheckDate1,FMultiCheckLevel2,FMultiCheckDate2,FMultiCheckLevel3,FMultiCheckDate3,FMultiCheckLevel4,FMultiCheckDate4,FMultiCheckLevel5,FMultiCheckDate5,FMultiCheckLevel6,FMultiCheckDate6,freftype,FWBINTERID,FSelTranType,FBackFlushed) 
--	VALUES (		        40103,         @fidentify,    @InterId,@BillNo,'0',  41,       0,            0,      @UpStockWhenSave,0,          1,       0,          @fdate,@fdeptid,'',  Null,      @ffmanagerid,0,            @fuserid,    0,      Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,40103,0,81,1)
--	 
--	exec My_p_UpdateBillRelateData @InterId --更新关联数
--	--exec My_p_UpdateBillRelateData_24_26 24,@InterId --更新计划投料单数量
--
--	UPDATE ICStockBill SET FUUID=NEWID() WHERE FInterID=@InterId
--	
--	INSERT INTO t_Log (FDate,FUserID,FFunctionID,FStatement,FDescription,FMachineName,FIPAddress) VALUES (getdate(),@UserId,'K010001',3,'编号为'+@BillNo+'的单据保存成功','KSW118','192.168.0.159')
--	set @fendbillno=@BillNo
--	FETCH NEXT FROM icbom_cursor 
--    INTO @fstockmanagerid --@fdeptid,@fsourcetrantype,@fsourceinterid,@fisbackflush,
--END
--
--CLOSE icbom_cursor
--DEALLOCATE icbom_cursor
--
----select * from #SourceData
--
--drop table #SourceData
--
--
--set nocount off
--
--go


----批量生成调拨单--由任务单批量生成
----My_P_GenerateOutStock41 16394,'',''
--IF EXISTS (select * from sysobjects where name='My_P_GenerateOutStock41' and xtype='p')  drop  procedure My_P_GenerateOutStock41
--
--go
--
--create procedure  [dbo].My_P_GenerateOutStock41(@fuserid int,@fbegbillno varchar(30) output,@fendbillno varchar(30) output,@fidentify int output)  --
--
--as
--set nocount on
--
----declare @ficmointerid int,@finbillno varchar(30),@ftype int set @ficmointerid=293576--select * from My_t_ICMOTemp
--
--declare @ficmointerid int,@fcostobjid int,@FDIOFInFanager int,@FDIOFOutSanager int
--declare @fcheck_fail int,@fppbominterid int,@FDIOFInSanager int,@FDIOFOutFanager int
--declare @fsrccommitfield_prevalue decimal(28,13),@fininterid int
--declare @fsrccommitfield_endvalue decimal(28,13),@UpStockWhenSave int,@fspid int,@fempid int,@fdeptid int,@fppbomentryid int
--declare @foutinterid int,@fpqty int,@xx_FItemIDOld int,@fxxitemid int,@InterId int,@CostObjGroupID int
--declare @fplanamount decimal (24,2),@fstockid int,@fcbitemid int,@frob int,@fisbackflush int
--declare @fsourceInterid int,@fsourceEntryid int,@fsourceBillNo varchar (100),@FCustBillNo varchar(30)
--declare @ficmobillno varchar(20),@UserId int,@fqtymust int,@s varchar(5000),@fstockmanagerid int
--
--declare @fplanprice decimal(18,4),@fitemid int,@funitid int,@entryid int,@fqty int
--declare @FInterID int,@BillNo varchar (20),@StockId int,@StockNumber varchar (20)
--DECLARE @TmpID INT ,@fperqty int,@fsourceqty int,@iLength int,@iFind bit,@finqty int
--declare @fprojectval  varchar(200),@FDateFormat  varchar(200),@fcount int,@fplanbegindate datetime
--declare @FDCStockID int,@FSCStockID int,@FDCSPID int,@fscspid int,@FVersion int
--declare @famount decimal (18,2),@fpitemid int,@fdate datetime,@fserial int,@FStockManagerName varchar(30)
--declare @foutbillinterid int,@foutbillentryid int,@FSrcMpsPlanOrderInterid int,@fmpsqty int,@fsourceplanbegindate datetime
--declare @findex int,@fsrcplanorderinterid int,@flag int,@FVarSrcPlanOrderInterid int
--declare @iCurrentRecord int,@k int,@fxishu int,@forderinterid int,@forderentryid int
--declare @forderqty int,@foutqty int,@iMaxRecord int,@fsourcetrantype int,@ffmanagerid int
--
--select @fidentify=isnull(max(fid),0)+1 from my_t_identify
--insert into my_t_identify(fid,fuserid,fdate,FTrantypeID) values(@fidentify,@fuserid,getdate(),41)
--
--select @fdate=replace(convert(varchar(10),getdate(),111),'/','-'),@fcount=1,@fbegbillno='',@fendbillno=''
----select fnumber,fname,* from t_emp where fname like '莫%'
--
--select @UpStockWhenSave=fvalue from T_SYSTEMPROFILE where  fkey='UPSTOCKWHENSAVE'
--
--select t5.finterid ficmointerid,t5.fitemid fcbitemid,
--(t3.fauxqtymust-t3.fseltranslateauxqty) fqtymust,(t3.fauxqtymust-t3.fseltranslateauxqty )fqty, 
--t2.finterid fppbominterid,t3.fentryid fppbomentryid,t5.fworkshop fdeptid,isnull(t4.fdefaultloc,0) FSCStockID, --调出仓库 	
--t5.FCostObjID,t4.ferpclsid,0 fplanprice,0 fplanamount,t5.fbillno ficmobillno,t3.funitid,
--case when left(t7.fnumber,6)= '08.11.' and left(t7.fnumber,8)= '08.11.1.' then  29025	--专利装配车间仓
--	 when left(t7.fnumber,6)= '08.11.' and left(t7.fnumber,8)<>'08.11.1.' then  29026	--专利包装车间仓
--     when left(t7.fnumber,6)<>'08.11.' and left(t7.fnumber,8)= '08.10.1.' then  18113	--装配车间仓
--	 when left(t7.fnumber,6)<>'08.11.' and left(t7.fnumber,8)<>'08.10.1.' then  18114	--包装车间仓
--end FDCStockID,--调入仓库
--t3.fitemid,(case when t5.forderinterid<>0 then t5.forderinterid else t5.FPPOrderInterID end) fsourceinterid,t5.fsourceentryid,
--(case when t5.forderinterid<>0 then 81 else 87 end) fsourcetrantype,t17.finterid fisbackflush,
--t13.finterid fstockmanagerid,isnull((select top 1 fitemid from t_emp where fname=t13.fname),25326) ffmanagerid,t5.FPlanCommitDate fplanbegindate
--into #SourceData
--from icmo t5 
--inner join ppbom t2 on t5.finterid=t2.ficmointerid
--inner join ppbomentry t3 on t2.finterid=t3.finterid
--inner join t_icitem t4 on t3.fitemid=t4.fitemid
--inner join t_icitem t8 on t5.fitemid=t8.fitemid
--inner join t_SubMessage t13 on t13.finterid=t4.f_114 and t13.ftypeid=10003  --仓管员
--inner join t_SubMessage t17 on t17.finterid=t4.f_115 and t17.ftypeid=10002  --倒冲
--inner join My_t_ICMOTemp t1 on t1.finterid=t5.finterid and t1.fuserid=@fuserid
--inner join t_department t7 on t7.fitemid=t5.fworkshop
--where t5.fstatus in (1,2) and (t3.fauxqtymust-t3.fseltranslateauxqty)>0  --
----and t4.ferpclsid=2 
--and t17.fname='是'
----order by t4.fshortnumber
--
--
----仓管员
--DECLARE icbom_cursor CURSOR FOR	
--select distinct t1.fstockmanagerid --t1.fdeptid,t1.fsourcetrantype,t1.fsourceinterid,t1.fisbackflush,
--from #SourceData t1 
--inner join t_icitem t2 on t1.fitemid=t2.fitemid --where fnumber like '01.%' and fnumber not like '01.01.%'  --屏蔽掉产成品,半成品/原材料/委外件都自动生成领料单
--order by t1.fstockmanagerid --,t1.fdeptid,t1.fsourcetrantype,t1.fsourceinteridt1.fisbackflush,
--
--OPEN icbom_cursor
--
--FETCH NEXT FROM icbom_cursor 
--INTO @fstockmanagerid --@fdeptid,@fsourcetrantype,@fsourceinterid,@fisbackflush,
--
--WHILE @@FETCH_STATUS = 0
--BEGIN 
--	exec My_p_GetBillNo 41,'icstockbill',@Interid output, @BillNo output
--
--    if @fcount=1 set @fbegbillno=@BillNo
--		           	
--	DECLARE authors_cursor CURSOR FOR	
--
--	select t1.ffmanagerid,t1.fplanbegindate,t1.fcbitemid,t1.fitemid,t1.funitid,t1.FSCStockID,t1.FDCStockID,t1.fdeptid,t1.fqtymust,t1.fqty,t1.ficmointerid,t1.ficmobillno,t1.fplanprice,t1.fplanamount,t1.fcostobjid,t1.fppbominterid,t1.fppbomentryid 
--	from #SourceData t1
--	inner join t_icitem t2 on t1.fitemid=t2.fitemid
--	where t1.fstockmanagerid=@fstockmanagerid  --t1.fdeptid=@fdeptid and t1.fsourcetrantype=@fsourcetrantype and t1.fsourceinterid=@fsourceinterid and t1.fisbackflush=@fisbackflush and 
--	order by t2.fnumber
--
--    set @entryid=1
--
--	OPEN authors_cursor
--
--	FETCH NEXT FROM authors_cursor 
--	INTO @ffmanagerid,@fplanbegindate,@fcbitemid,@fitemid,@funitid,@FSCStockID,@FDCStockID,@fdeptid,@fqtymust,@fqty,@ficmointerid,@ficmobillno,@fplanprice,@fplanamount,@fcostobjid,@fppbominterid,@fppbomentryid
--
--	WHILE @@FETCH_STATUS = 0
--	BEGIN 		
--		INSERT INTO ICStockBillEntry (FInterID,FEntryID,FBrNo,FItemID,FAuxPropID,FBatchNo,FQtyMust, FQty,     FReProduceType,FCostOBJID, FCostObjGroupID,FUnitID ,FAuxQtyMust,Fauxqty,FSecCoefficient,FSecQty,FAuxPlanPrice,FPlanAmount, Fauxprice,Famount,FBomInterID,Fnote,FKFDate,FKFPeriod,FPeriodDate,FSCStockID, FDCStockID, FOperSN,FOperID,FSNListID,FSourceBillNo,FSourceTranType,FSourceInterId, FSourceEntryID, FICMOBillNo, FICMOInterID, FPPBomEntryID, FInStockID) 
--		VALUES (                      @Interid,@EntryId,'0',  @fitemid,0,        '',      @fqtymust,@fqty   , 1059,          @fcostobjid,0,              @FUnitID,@fqtymust , @fqty,  0,              0,      @fplanprice,  @fplanamount,0,        0,      0,          '',   Null,   0,        Null,       @FSCStockID,@FDCStockID,0,      0,      0,        @ficmobillno, 85,             @ficmointerid,  @fppbomentryid, @ficmobillno,@ficmointerid,@fppbomentryid,0) 
--
--		set @entryid=@entryid+1
--		set @fcount=@fcount+1
--
--		FETCH NEXT FROM authors_cursor 
--		INTO @ffmanagerid,@fplanbegindate,@fcbitemid,@fitemid,@funitid,@FSCStockID,@FDCStockID,@fdeptid,@fqtymust,@fqty,@ficmointerid,@ficmobillno,@fplanprice,@fplanamount,@fcostobjid,@fppbominterid,@fppbomentryid
--	END
--
--	CLOSE authors_cursor
--	DEALLOCATE authors_cursor
--
--	if @fsourcetrantype=81
--		select @fsourcebillno=fbillno,@FCustBillNo=fheadselfs0144 from seorder where finterid=@fsourceinterid
--	else
--		select @fsourcebillno=fbillno from pporder where finterid=@fsourceinterid
--
--	INSERT INTO ICStockBill(fheadselfd0133,fheadselfd0132, FInterID,FBillNo,FBrNo,FTranType,FCancellation,FStatus,FUpStockWhenSave,FVchInterID,FROB,    FHookStatus,Fdate, FDeptID, Fuse,FCheckDate,FSManagerID, FFManagerID,  FBillerID,   FAcctID,FMultiCheckLevel1,FMultiCheckDate1,FMultiCheckLevel2,FMultiCheckDate2,FMultiCheckLevel3,FMultiCheckDate3,FMultiCheckLevel4,FMultiCheckDate4,FMultiCheckLevel5,FMultiCheckDate5,FMultiCheckLevel6,FMultiCheckDate6,freftype,FWBINTERID,FSelTranType,FBackFlushed) 
--	VALUES (		        40102,         @fidentify,     @InterId,@BillNo,'0',  41,       0,            0,      @UpStockWhenSave,0,          1,       0,          @fdate,@fdeptid,'',  Null,      @ffmanagerid,0,            @fuserid,    0,      Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,40102,0,85,1)
--	 
--	exec My_p_UpdateBillRelateData @InterId --更新关联数
--	--exec My_p_UpdateBillRelateData_24_26 24,@InterId --更新计划投料单数量
--
--	UPDATE ICStockBill SET FUUID=NEWID() WHERE FInterID=@InterId
--	
--	INSERT INTO t_Log (FDate,FUserID,FFunctionID,FStatement,FDescription,FMachineName,FIPAddress) VALUES (getdate(),@UserId,'K010001',3,'编号为'+@BillNo+'的单据保存成功','KSW118','192.168.0.159')
--	set @fendbillno=@BillNo
--	FETCH NEXT FROM icbom_cursor 
--    INTO @fstockmanagerid --@fdeptid,@fsourcetrantype,@fsourceinterid,@fisbackflush,
--END
--
--CLOSE icbom_cursor
--DEALLOCATE icbom_cursor
--
----select * from #SourceData
--
--drop table #SourceData
--
--
--set nocount off
--
--go
--

----批量生成领料单/虚仓出库单----由任务单批量生成
----My_P_GenerateOutStock24 16394,'','',0
--IF EXISTS (select * from sysobjects where name='My_P_GenerateOutStock24' and xtype='p')  drop  procedure My_P_GenerateOutStock24
--
--go
--
--create procedure  [dbo].My_P_GenerateOutStock24(@fuserid int,@fbegbillno varchar(30) output,@fendbillno varchar(30) output,@fidentify int output)  --
--
--as
--set nocount on
--
----declare @ficmointerid int,@finbillno varchar(30),@ftype int set @ficmointerid=293576--select * from My_t_ICMOTemp
--
--declare @ficmointerid int,@fcostobjid int,@FDIOFInFanager int,@FDIOFOutSanager int
--declare @fcheck_fail int,@fppbominterid int,@FDIOFInSanager int,@FDIOFOutFanager int
--declare @fsrccommitfield_prevalue decimal(28,13),@fininterid int
--declare @fsrccommitfield_endvalue decimal(28,13),@UpStockWhenSave int,@fspid int,@fempid int,@fdeptid int,@fppbomentryid int
--declare @foutinterid int,@fpqty int,@xx_FItemIDOld int,@fxxitemid int,@InterId int,@CostObjGroupID int
--declare @fplanamount decimal (24,2),@fstockid int,@fcbitemid int,@frob int,@fisbackflush int
--declare @fsourceInterid int,@fsourceEntryid int,@fsourceBillNo varchar (100),@FCustBillNo varchar(30)
--declare @ficmobillno varchar(20),@UserId int,@fqtymust int,@s varchar(5000),@fstockmanagerid int
--
--declare @fplanprice decimal(18,4),@fitemid int,@funitid int,@entryid int,@fqty int
--declare @FInterID int,@BillNo varchar (20),@StockId int,@StockNumber varchar (20)
--DECLARE @TmpID INT ,@fperqty int,@fsourceqty int,@iLength int,@iFind bit,@finqty int
--declare @fprojectval  varchar(200),@FDateFormat  varchar(200),@fcount int,@fplanbegindate datetime
--declare @FDCStockID int,@FSCStockID int,@FDCSPID int,@fscspid int,@FVersion int
--declare @famount decimal (18,2),@fpitemid int,@fdate datetime,@fserial int,@FStockManagerName varchar(30)
--declare @foutbillinterid int,@foutbillentryid int,@FSrcMpsPlanOrderInterid int,@fmpsqty int,@fsourceplanbegindate datetime
--declare @findex int,@fsrcplanorderinterid int,@flag int,@FVarSrcPlanOrderInterid int
--declare @iCurrentRecord int,@k int,@fxishu int,@forderinterid int,@forderentryid int
--declare @forderqty int,@foutqty int,@iMaxRecord int,@fsourcetrantype int,@ffmanagerid int
--
--select @fidentify=isnull(max(fid),0)+1 from my_t_identify
--insert into my_t_identify(fid,fuserid,fdate,FTrantypeID) values(@fidentify,@fuserid,getdate(),24)
--
--select @fdate=replace(convert(varchar(10),getdate(),111),'/','-'),@fcount=1,@fbegbillno='',@fendbillno=''
----select fnumber,fname,* from t_emp where fname like '莫%'
--
--select @UpStockWhenSave=fvalue from T_SYSTEMPROFILE where  fkey='UPSTOCKWHENSAVE'
--
----领料--	
--
--select t5.finterid ficmointerid,t5.fitemid fcbitemid,
--(t3.fauxqtymust-t3.fauxqty) fqtymust,(t3.fauxqtymust-t3.fauxqty )fqty, 
--t2.finterid fppbominterid,t3.fentryid fppbomentryid,t5.fworkshop fdeptid,isnull(t4.fdefaultloc,0) fstockid,
--t5.FCostObjID,t4.ferpclsid,0 fplanprice,0 fplanamount,t5.fbillno ficmobillno,t3.funitid,isnull(t4.fspid,0) fspid,
--t3.fitemid,
----(case when t5.forderinterid<>0 then t5.forderinterid else t5.FPPOrderInterID end) fsourceinterid,
--isnull(t5.forderinterid,0) fsourceinterid,--预测订单不按订单打印，只按部门打印
--t5.fsourceentryid,
--(case when t5.forderinterid<>0 then 81 else 87 end) fsourcetrantype,t17.finterid fisbackflush,
--t13.finterid fstockmanagerid,isnull((select top 1 fitemid from t_emp where fname=t13.fname),25326) ffmanagerid,t5.FPlanCommitDate fplanbegindate
--into #SourceData
--from icmo t5 
--inner join ppbom t2 on t5.finterid=t2.ficmointerid
--inner join ppbomentry t3 on t2.finterid=t3.finterid
--inner join t_icitem t4 on t3.fitemid=t4.fitemid
--inner join t_icitem t8 on t5.fitemid=t8.fitemid
--inner join t_SubMessage t13 on t13.finterid=t4.f_114 and t13.ftypeid=10003  --仓管员
--inner join t_SubMessage t17 on t17.finterid=t4.f_115 and t17.ftypeid=10002  --倒冲
--inner join My_t_ICMOTemp t1 on t1.finterid=t5.finterid and t1.fuserid=@fuserid
--where t5.fstatus in (1,2) and (t3.fauxqtymust-t3.fauxqty)>0  --
----and t4.ferpclsid=2 
--and t17.fname<>'是'
----order by t4.fshortnumber
--
----ALTER  TABLE  icstockbill  DISABLE  TRIGGER  My_Tri_ICStockBill_In 
--
----部门+源单+是否倒冲+仓管员
--DECLARE icbom_cursor CURSOR FOR	
--select distinct t1.fdeptid,t1.fsourcetrantype,t1.fsourceinterid,t1.fisbackflush,t1.fstockmanagerid 
--from #SourceData t1 
--inner join t_icitem t2 on t1.fitemid=t2.fitemid 
--where t2.fnumber not like '7.%' --
--order by t1.fisbackflush,t1.fstockmanagerid,t1.fdeptid,t1.fsourcetrantype,t1.fsourceinterid
--
--OPEN icbom_cursor
--
--FETCH NEXT FROM icbom_cursor 
--INTO @fdeptid,@fsourcetrantype,@fsourceinterid,@fisbackflush,@fstockmanagerid
--
--WHILE @@FETCH_STATUS = 0
--BEGIN 
--	exec My_p_GetBillNo 24,'icstockbill',@Interid output, @BillNo output
--
--    if @fcount=1 set @fbegbillno=@BillNo
--		           	
--	DECLARE authors_cursor CURSOR FOR	
--
--	select t1.ffmanagerid,t1.fplanbegindate,t1.fcbitemid,t1.fitemid,t1.funitid,t1.fstockid,t1.fspid,t1.fdeptid,t1.fqtymust,t1.fqty,t1.ficmointerid,t1.ficmobillno,t1.fplanprice,t1.fplanamount,t1.fcostobjid,t1.fppbominterid,t1.fppbomentryid 
--	from #SourceData t1
--	inner join t_icitem t2 on t1.fitemid=t2.fitemid
--	where t2.fnumber not like '7.%' and t1.fdeptid=@fdeptid and t1.fsourcetrantype=@fsourcetrantype and t1.fsourceinterid=@fsourceinterid and t1.fisbackflush=@fisbackflush and t1.fstockmanagerid=@fstockmanagerid
--	order by t2.fnumber
--
--    set @entryid=1
--
--	OPEN authors_cursor
--
--	FETCH NEXT FROM authors_cursor 
--	INTO @ffmanagerid,@fplanbegindate,@fcbitemid,@fitemid,@funitid,@fstockid,@fspid,@fdeptid,@fqtymust,@fqty,@ficmointerid,@ficmobillno,@fplanprice,@fplanamount,@fcostobjid,@fppbominterid,@fppbomentryid
--
--	WHILE @@FETCH_STATUS = 0
--	BEGIN 		
--		INSERT INTO ICStockBillEntry (FInterID,FEntryID,FBrNo,FItemID,FAuxPropID,FBatchNo,FQtyMust, FQty,     FReProduceType,FCostOBJID, FCostObjGroupID,FUnitID ,FAuxQtyMust,Fauxqty,FSecCoefficient,FSecQty,FAuxPlanPrice,FPlanAmount, Fauxprice,Famount,FBomInterID,Fnote,FKFDate,FKFPeriod,FPeriodDate,FSCStockID,FDCSPID,FOperSN,FOperID,FSNListID,FSourceBillNo,FSourceTranType,FSourceInterId, FSourceEntryID, FICMOBillNo, FICMOInterID, FPPBomEntryID, FInStockID) 
--		VALUES (                      @Interid,@EntryId,'0',  @fitemid,0,        '',      @fqtymust,@fqty   , 1059,          @fcostobjid,0,              @FUnitID,@fqtymust , @fqty,  0,              0,      @fplanprice,  @fplanamount,0,        0,      0,          '',   Null,   0,        Null,       @fstockid, @fspid, 0,      0,      0,        @ficmobillno, 85,             @ficmointerid,  @fppbomentryid, @ficmobillno,@ficmointerid,@fppbomentryid,0) 
--
--		set @entryid=@entryid+1
--		set @fcount=@fcount+1
--
--		FETCH NEXT FROM authors_cursor 
--		INTO @ffmanagerid,@fplanbegindate,@fcbitemid,@fitemid,@funitid,@fstockid,@fspid,@fdeptid,@fqtymust,@fqty,@ficmointerid,@ficmobillno,@fplanprice,@fplanamount,@fcostobjid,@fppbominterid,@fppbomentryid
--	END
--
--	CLOSE authors_cursor
--	DEALLOCATE authors_cursor
--
--	if @fsourcetrantype=81
--		select @fsourcebillno=fbillno,@FCustBillNo=fheadselfs0144 from seorder where finterid=@fsourceinterid
--	else
--		select @fsourcebillno=fbillno from pporder where finterid=@fsourceinterid
--	--select finterid,fname,* from t_submessage where ftypeid=471
--	INSERT INTO ICStockBill(FHeadSelfB0433,/*FHeadSelfB0433, FHeadSelfB0435, FHeadSelfB0437,*/ FInterID,FBillNo,FBrNo,FTranType,FCancellation,FStatus,FUpStockWhenSave,FVchInterID,FROB,    FHookStatus,Fdate, FDeptID, Fuse,FCheckDate,FSManagerID, FFManagerID,  FBillerID,   FAcctID,FMultiCheckLevel1,FMultiCheckDate1,FMultiCheckLevel2,FMultiCheckDate2,FMultiCheckLevel3,FMultiCheckDate3,FMultiCheckLevel4,FMultiCheckDate4,FMultiCheckLevel5,FMultiCheckDate5,FMultiCheckLevel6,FMultiCheckDate6,FPurposeID,FWBINTERID,FSelTranType,FBackFlushed) 
--	VALUES (		        @fidentify,    /*@FCustBillNo,   @fplanbegindate,@fsourcebillno,*/ @InterId,@BillNo,'0',  24,       0,            0,      @UpStockWhenSave,0,          1,       0,          @fdate,@fdeptid,'',  Null,      0 ,          @ffmanagerid, @fuserid,    0,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,12000,0,85,1)
--	 
--	exec My_p_UpdateBillRelateData @InterId --更新关联数
--	--exec My_p_UpdateBillRelateData_24_26 24,@InterId --更新计划投料单数量
--
--	UPDATE ICStockBill SET FUUID=NEWID() WHERE FInterID=@InterId
--	
--	INSERT INTO t_Log (FDate,FUserID,FFunctionID,FStatement,FDescription,FMachineName,FIPAddress) VALUES (getdate(),@UserId,'K010001',3,'编号为'+@BillNo+'的单据保存成功','KSW118','192.168.0.159')
--	set @fendbillno=@BillNo
--	FETCH NEXT FROM icbom_cursor 
--    INTO @fdeptid,@fsourcetrantype,@fsourceinterid,@fisbackflush,@fstockmanagerid
--END
--
--CLOSE icbom_cursor
--DEALLOCATE icbom_cursor
--
--
--
----更新任务单的领料状态 
--/*
--update m2 set FHeadSelfJ0173=(case when m1.fqty=0 then 40011 when (m1.fqty>0 and m1.fqtymust>m1.fqty) then 40012 when m1.fqtymust<=m1.fqty then 40013 end) 
--from
--(
--	select t1.ficmointerid,isnull(sum(t1.fqtymust),0) fqtymust,isnull(sum(t2.fqty),0) fqty
--	from PPBomEntry t1
--	left join 
--	(
--		select t1.ficmointerid,t1.fppbomentryid,sum(t1.fqty) fqty
--		from icstockbill t0 
--		inner join icstockbillentry t1 on t0.finterid=t1.finterid
--		inner join 
--		(	  select distinct t1.FICMOInterID 
--			  from icstockbillentry t1
--			  inner join icstockbill t2 on t1.finterid=t2.finterid
--			  where t2.fbillno>=@fbegbillno and t2.fbillno<=@fendbillno and t2.ftrantype=24
--		) t2 on t1.ficmointerid=t2.ficmointerid
--		where t0.ftrantype=24 
--		group by t1.ficmointerid,t1.fppbomentryid
--	) t2 on t1.ficmointerid=t2.ficmointerid and t1.fentryid=t2.fppbomentryid
--	group by t1.ficmointerid
--) m1 inner join icmo m2 on m1.ficmointerid=m2.finterid
--*/
----ALTER  TABLE  icstockbill  ENABLE  TRIGGER  My_Tri_ICStockBill_In 
--
----select * from #SourceData
--
--
----虚仓出库--	
--
----部门+源单+是否倒冲+仓管员
--DECLARE icbom_cursor CURSOR FOR	
--select distinct t1.fdeptid,t1.fsourcetrantype,t1.fsourceinterid,t1.fisbackflush,t1.fstockmanagerid 
--from #SourceData t1 
--inner join t_icitem t2 on t1.fitemid=t2.fitemid 
--where t2.fnumber like '7.%' --
--order by t1.fisbackflush,t1.fstockmanagerid,t1.fdeptid,t1.fsourcetrantype,t1.fsourceinterid
--
--OPEN icbom_cursor
--
--FETCH NEXT FROM icbom_cursor 
--INTO @fdeptid,@fsourcetrantype,@fsourceinterid,@fisbackflush,@fstockmanagerid
--
--WHILE @@FETCH_STATUS = 0
--BEGIN 
--	exec My_p_GetBillNo 26,'zpstockbill',@Interid output, @BillNo output
--		           	
--	DECLARE authors_cursor CURSOR FOR	
--	--select t1.ffmanagerid,t1.fplanbegindate,t1.fcbitemid,t1.fitemid,t1.funitid,t1.fstockid,t1.fspid,t1.fdeptid,t1.fqtymust,t1.fqty,t1.ficmointerid,t1.ficmobillno,t1.fplanprice,t1.fplanamount,t1.fcostobjid,t1.fppbominterid,t1.fppbomentryid 
--
--	select t1.ffmanagerid,t1.fitemid,t1.funitid,t1.fstockid FDCStockID,t1.fdeptid,t1.fqtymust fqtymust,t1.fqty fqty,t1.ficmointerid,t1.ficmobillno,t1.fppbomentryid
--	from #SourceData t1
--	inner join t_icitem t2 on t1.fitemid=t2.fitemid
--	where t2.fnumber like '7.%' and t1.fdeptid=@fdeptid and t1.fsourcetrantype=@fsourcetrantype and t1.fsourceinterid=@fsourceinterid and t1.fisbackflush=@fisbackflush and t1.fstockmanagerid=@fstockmanagerid
--	order by t2.fnumber
--
--    set @entryid=1
--
--	OPEN authors_cursor
--
--	FETCH NEXT FROM authors_cursor 
--	INTO @ffmanagerid,@fitemid,@funitid,@FDCStockID,@fdeptid,@fqtymust,@fqty,@ficmointerid,@ficmobillno,@fppbomentryid
--
--	WHILE @@FETCH_STATUS = 0
--	BEGIN 		
--		INSERT INTO ZPStockBillEntry (FDCStockID, FInterID,FEntryID,FBrNo,FItemID, FBatchNo,FQty,     FUnitID ,Fauxqty,Fnote,FKFDate,FSourceBillNo, FSourceTranType, FSourceInterId,  FSourceEntryID ) 
--		VALUES (                      @FDCStockID,@Interid,@EntryId,'0',  @fitemid,'',      @fqty   , @FUnitID,@fqty,  '',   Null,   @ficmobillno,  85,              @ficmointerid,   @fppbomentryid) 
--
--		set @entryid=@entryid+1
--		set @fcount=@fcount+1
--
--		FETCH NEXT FROM authors_cursor 
--		INTO @ffmanagerid,@fitemid,@funitid,@FDCStockID,@fdeptid,@fqtymust,@fqty,@ficmointerid,@ficmobillno,@fppbomentryid
--	END
--
--	CLOSE authors_cursor
--	DEALLOCATE authors_cursor
--
--	INSERT INTO ZpStockBill(FHeadSelfZOU34,FInterID,FBillNo,FBrNo,FTranType,FCancellation,FStatus,FUpStockWhenSave,FROB,Fdate, FDeptID, FCheckDate,FSManagerID, FFManagerID,  FBillerID,   FSelTranType) 
--	VALUES (		        @fidentify,    @InterId,@BillNo,'0',  26,       0,            0,      @UpStockWhenSave,1,   @fdate,@fdeptid,Null,      0 ,          @ffmanagerid, @fuserid,    0)
--	 
--	--exec My_p_UpdateBillRelateData @InterId --更新关联数
--	--exec My_p_UpdateBillRelateData_24_26 24,@InterId --更新计划投料单数量
--	
--	--更新投料单的选单数量 
--	update t1 set fqty=t1.fqty+isnull(t2.fqty,0),fauxqty=t1.fauxqty+isnull(t2.fqty,0)
--	from PPBOMEntry t1 --
--	inner join 
--	(
--		select t1.FSourceInterId,t1.fsourceentryid,t1.fitemid,sum(t1.fqty) fqty
--		from ZPStockBill t0 --
--		inner join ZPStockBillEntry t1 on t0.finterid=t1.finterid  --
--		inner join icmo t3 on t3.finterid=t1.FSourceInterId
--		where t0.finterid=@InterId and t0.ftrantype=26 and t1.fsourcetrantype=85
--		group by t1.FSourceInterId,t1.fsourceentryid,t1.fitemid
--	) t2 on t1.ficmointerid=t2.FSourceInterId and t1.FEntryID=t2.fsourceentryid and t1.fitemid=t2.fitemid
--
--	INSERT INTO t_Log (FDate,FUserID,FFunctionID,FStatement,FDescription,FMachineName,FIPAddress) VALUES (getdate(),@UserId,'K010001',3,'编号为'+@BillNo+'的单据保存成功','KSW118','192.168.0.159')
--
--	FETCH NEXT FROM icbom_cursor 
--    INTO @fdeptid,@fsourcetrantype,@fsourceinterid,@fisbackflush,@fstockmanagerid
--END
--
--CLOSE icbom_cursor
--DEALLOCATE icbom_cursor
--
----select * from #SourceData
--
--drop table #SourceData
--
--set nocount off
--
--go


----倒冲物料批量生成调拨单--由生产计划单批量生成--全部手工领
----My_P_GenerateBackFlushOutStock41 16394,'',''
--IF EXISTS (select * from sysobjects where name='My_P_GenerateBackFlushOutStock41' and xtype='p')  drop  procedure My_P_GenerateBackFlushOutStock41
--
--go
--
--create procedure  [dbo].My_P_GenerateBackFlushOutStock41(@fuserid int,@fbegbillno varchar(30) output,@fendbillno varchar(30) output,@fidentify int output)  --
--
--as
--set nocount on
--
----declare @ficmointerid int,@finbillno varchar(30),@ftype int set @ficmointerid=293576--select * from My_t_ICMOTemp
--
--declare @ficmointerid int,@fcostobjid int,@FDIOFInFanager int,@FDIOFOutSanager int
--declare @fcheck_fail int,@fppbominterid int,@FDIOFInSanager int,@FDIOFOutFanager int
--declare @fsrccommitfield_prevalue decimal(28,13),@fininterid int
--declare @fsrccommitfield_endvalue decimal(28,13),@UpStockWhenSave int,@fspid int,@fempid int,@fdeptid int,@fppbomentryid int
--declare @foutinterid int,@fpqty int,@xx_FItemIDOld int,@fxxitemid int,@InterId int,@CostObjGroupID int
--declare @fplanamount decimal (24,2),@fstockid int,@fcbitemid int,@frob int,@fisbackflush int
--declare @fsourceInterid int,@fsourceEntryid int,@fsourceBillNo varchar (100),@FCustBillNo varchar(30)
--declare @ficmobillno varchar(20),@UserId int,@fqtymust int,@s varchar(5000),@fstockmanagerid int
--
--declare @fplanprice decimal(18,4),@fitemid int,@funitid int,@entryid int,@fqty int
--declare @FInterID int,@BillNo varchar (20),@StockId int,@StockNumber varchar (20)
--DECLARE @TmpID INT ,@fperqty int,@fsourceqty int,@iLength int,@iFind bit,@finqty int
--declare @fprojectval  varchar(200),@FDateFormat  varchar(200),@fcount int,@fplanbegindate datetime
--declare @FDCStockID int,@FSCStockID int,@FDCSPID int,@fscspid int,@FVersion int
--declare @famount decimal (18,2),@fpitemid int,@fdate datetime,@fserial int,@FStockManagerName varchar(30)
--declare @foutbillinterid int,@foutbillentryid int,@FSrcMpsPlanOrderInterid int,@fmpsqty int,@fsourceplanbegindate datetime
--declare @findex int,@fsrcplanorderinterid int,@flag int,@FVarSrcPlanOrderInterid int
--declare @iCurrentRecord int,@k int,@fxishu int,@forderinterid int,@forderentryid int
--declare @forderqty int,@foutqty int,@iMaxRecord int,@fsourcetrantype int,@ffmanagerid int
--
--select @fidentify=isnull(max(fid),0)+1 from my_t_identify
--insert into my_t_identify(fid,fuserid,fdate,FTrantypeID) values(@fidentify,@fuserid,getdate(),41)
--
--select @fdate=replace(convert(varchar(10),getdate(),111),'/','-'),@fcount=1,@fbegbillno='',@fendbillno=''
----select fnumber,fname,* from t_emp where fname like '莫%'
--
----select fitemid,fname,* from t_department  175	装配车间        176	包装车间
----select fitemid,fname,* from t_stock       16479	装配车间仓  16480	包装车间仓
--
--select @UpStockWhenSave=fvalue from T_SYSTEMPROFILE where  fkey='UPSTOCKWHENSAVE'
--
--select t5.finterid ficmointerid,t5.fitemid fcbitemid,
--(t3.fauxqtymust-t3.fseltranslateauxqty) fqtymust,(t3.fauxqtymust-t3.fseltranslateauxqty )fqty, 
--t2.finterid fppbominterid,t3.fentryid fppbomentryid,t5.fworkshop fdeptid,isnull(t4.fdefaultloc,0) FSCStockID, --调出仓库 	
--t5.FCostObjID,t4.ferpclsid,0 fplanprice,0 fplanamount,t5.fbillno ficmobillno,t3.funitid,
--case when t7.fitemid in (175,171817) then 16479	--装配车间仓
--	 when t7.fitemid=176 then 16480 else 16480 --包装车间仓
--end FDCStockID,--调入仓库
--t3.fitemid,(case when t5.forderinterid<>0 then t5.forderinterid else t5.FPPOrderInterID end) fsourceinterid,t5.fsourceentryid,
--(case when t5.forderinterid<>0 then 81 else 87 end) fsourcetrantype,t17.finterid fisbackflush,
--t13.finterid fstockmanagerid,isnull((select top 1 fitemid from t_emp where fname=t13.fname),25326) ffmanagerid,t5.FPlanCommitDate fplanbegindate
--into #SourceData
--from 
--(
--	select sum(t6.fqty) fqty,t6.ficmointerid 
--	from my_t_scheduledetail t6 --和任务单是一对多的关系
--	inner join My_t_ScheduleDetailTemp t1 on t1.finterid=t6.finterid 
--	where t1.fuserid=@fuserid
--	group by t6.ficmointerid
--) t6
--inner join icmo t5 on t6.ficmointerid=t5.finterid
--inner join ppbom t2 on t5.finterid=t2.ficmointerid
--inner join ppbomentry t3 on t2.finterid=t3.finterid
--inner join t_icitem t4 on t3.fitemid=t4.fitemid
--inner join t_icitem t8 on t5.fitemid=t8.fitemid
--inner join t_SubMessage t13 on t13.finterid=t4.f_114 and t13.ftypeid=10003  --仓管员
--inner join t_SubMessage t17 on t17.finterid=t4.f_115 and t17.ftypeid=10002  --倒冲
--inner join My_t_ScheduleDetailTemp t1 on t1.finterid=t5.finterid and t1.fuserid=@fuserid
--inner join t_department t7 on t7.fitemid=t5.fworkshop
--where t5.fstatus in (1,2) and (t3.fauxqtymust-t3.fseltranslateauxqty)>0  --
----and t4.ferpclsid=2 
--and t17.fname='是'
----order by t4.fshortnumber
--
--
----仓管员
--DECLARE icbom_cursor CURSOR FOR	
--select distinct t1.fstockmanagerid --t1.fdeptid,t1.fsourcetrantype,t1.fsourceinterid,t1.fisbackflush,
--from #SourceData t1 
--inner join t_icitem t2 on t1.fitemid=t2.fitemid --where fnumber like '01.%' and fnumber not like '01.01.%'  --屏蔽掉产成品,半成品/原材料/委外件都自动生成领料单
--order by t1.fstockmanagerid --,t1.fdeptid,t1.fsourcetrantype,t1.fsourceinteridt1.fisbackflush,
--
--OPEN icbom_cursor
--
--FETCH NEXT FROM icbom_cursor 
--INTO @fstockmanagerid --@fdeptid,@fsourcetrantype,@fsourceinterid,@fisbackflush,
--
--WHILE @@FETCH_STATUS = 0
--BEGIN 
--	exec My_p_GetBillNo 41,'icstockbill',@Interid output, @BillNo output
--
--    if @fcount=1 set @fbegbillno=@BillNo
--		           	
--	DECLARE authors_cursor CURSOR FOR	
--
--	select t1.ffmanagerid,t1.fplanbegindate,t1.fcbitemid,t1.fitemid,t1.funitid,t1.FSCStockID,t1.FDCStockID,t1.fdeptid,t1.fqtymust,t1.fqty,t1.ficmointerid,t1.ficmobillno,t1.fplanprice,t1.fplanamount,t1.fcostobjid,t1.fppbominterid,t1.fppbomentryid 
--	from #SourceData t1
--	inner join t_icitem t2 on t1.fitemid=t2.fitemid
--	where t1.fstockmanagerid=@fstockmanagerid  --t1.fdeptid=@fdeptid and t1.fsourcetrantype=@fsourcetrantype and t1.fsourceinterid=@fsourceinterid and t1.fisbackflush=@fisbackflush and 
--	order by t2.fnumber
--
--    set @entryid=1
--
--	OPEN authors_cursor
--
--	FETCH NEXT FROM authors_cursor 
--	INTO @ffmanagerid,@fplanbegindate,@fcbitemid,@fitemid,@funitid,@FSCStockID,@FDCStockID,@fdeptid,@fqtymust,@fqty,@ficmointerid,@ficmobillno,@fplanprice,@fplanamount,@fcostobjid,@fppbominterid,@fppbomentryid
--
--	WHILE @@FETCH_STATUS = 0
--	BEGIN 		
--		INSERT INTO ICStockBillEntry (FInterID,FEntryID,FBrNo,FItemID,FAuxPropID,FBatchNo,FQtyMust, FQty,     FReProduceType,FCostOBJID, FCostObjGroupID,FUnitID ,FAuxQtyMust,Fauxqty,FSecCoefficient,FSecQty,FAuxPlanPrice,FPlanAmount, Fauxprice,Famount,FBomInterID,Fnote,FKFDate,FKFPeriod,FPeriodDate,FSCStockID, FDCStockID, FOperSN,FOperID,FSNListID,FSourceBillNo,FSourceTranType,FSourceInterId, FSourceEntryID, FICMOBillNo, FICMOInterID, FPPBomEntryID, FInStockID) 
--		VALUES (                      @Interid,@EntryId,'0',  @fitemid,0,        '',      @fqtymust,@fqty   , 1059,          @fcostobjid,0,              @FUnitID,@fqtymust , @fqty,  0,              0,      @fplanprice,  @fplanamount,0,        0,      0,          '',   Null,   0,        Null,       @FSCStockID,@FDCStockID,0,      0,      0,        @ficmobillno, 85,             @ficmointerid,  @fppbomentryid, @ficmobillno,@ficmointerid,@fppbomentryid,0) 
--
--		set @entryid=@entryid+1
--		set @fcount=@fcount+1
--
--		FETCH NEXT FROM authors_cursor 
--		INTO @ffmanagerid,@fplanbegindate,@fcbitemid,@fitemid,@funitid,@FSCStockID,@FDCStockID,@fdeptid,@fqtymust,@fqty,@ficmointerid,@ficmobillno,@fplanprice,@fplanamount,@fcostobjid,@fppbominterid,@fppbomentryid
--	END
--
--	CLOSE authors_cursor
--	DEALLOCATE authors_cursor
--
--	if @fsourcetrantype=81
--		select @fsourcebillno=fbillno,@FCustBillNo=fheadselfs0144 from seorder where finterid=@fsourceinterid
--	else
--		select @fsourcebillno=fbillno from pporder where finterid=@fsourceinterid
--
--	INSERT INTO ICStockBill(fheadselfd0133,fheadselfd0132, FInterID,FBillNo,FBrNo,FTranType,FCancellation,FStatus,FUpStockWhenSave,FVchInterID,FROB,    FHookStatus,Fdate, FDeptID, Fuse,FCheckDate,FSManagerID, FFManagerID,  FBillerID,   FAcctID,FMultiCheckLevel1,FMultiCheckDate1,FMultiCheckLevel2,FMultiCheckDate2,FMultiCheckLevel3,FMultiCheckDate3,FMultiCheckLevel4,FMultiCheckDate4,FMultiCheckLevel5,FMultiCheckDate5,FMultiCheckLevel6,FMultiCheckDate6,freftype,FWBINTERID,FSelTranType,FBackFlushed) 
--	VALUES (		        40102,         @fidentify,     @InterId,@BillNo,'0',  41,       0,            0,      @UpStockWhenSave,0,          1,       0,          @fdate,@fdeptid,'',  Null,      @ffmanagerid,0,            @fuserid,    0,      Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,40102,0,85,1)
--	 
--	exec My_p_UpdateBillRelateData @InterId --更新关联数
--	--exec My_p_UpdateBillRelateData_24_26 24,@InterId --更新计划投料单数量
--
--	UPDATE ICStockBill SET FUUID=NEWID() WHERE FInterID=@InterId
--	
--	INSERT INTO t_Log (FDate,FUserID,FFunctionID,FStatement,FDescription,FMachineName,FIPAddress) VALUES (getdate(),@UserId,'K010001',3,'编号为'+@BillNo+'的单据保存成功','KSW118','192.168.0.159')
--	set @fendbillno=@BillNo
--	FETCH NEXT FROM icbom_cursor 
--    INTO @fstockmanagerid --@fdeptid,@fsourcetrantype,@fsourceinterid,@fisbackflush,
--END
--
--CLOSE icbom_cursor
--DEALLOCATE icbom_cursor
--
----select * from #SourceData
--
--drop table #SourceData
--
--
--set nocount off
--
--go

--*****
--出入库更新关联数据(单独调用，因为K3本身的GUI会回写相关逻辑，所以不能写在触发器中)

--exec My_p_UpdateBillRelateData 25168

IF EXISTS (select * from sysobjects where name='My_p_UpdateBillRelateData' and xtype='p')  drop  procedure My_p_UpdateBillRelateData

go

create procedure My_p_UpdateBillRelateData (@Interid int)
as

set nocount on 

declare @ftrantype int

select @ftrantype=ftrantype from icstockbill where finterid=@Interid

EXEC p_UpdateBillRelateData @ftrantype,@InterId   --必须放在前面执行，否则会循环触发

declare @fcheck_fail int
declare @fsrccommitfield_prevalue decimal(28,13)
declare @fsrccommitfield_endvalue decimal(28,13)
declare @maxorder int 
declare @beAllowed INT 

if @ftrantype=24 
begin
	/*
	SELECT @beAllowed=CAST(FValue AS INT) from t_SystemProfile Where FCategory='IC' and FKey='StrictToPPBOM'
	IF @beAllowed=1 
	BEGIN 
		IF EXISTS(SELECT * FROM ICStockBillEntry WHERE FInterID=@InterId AND FICMOInterID=0)
			RAISERROR('严格按投料单发料，不允许增加分录！',18,18)

		IF EXISTS(SELECT u1.FICMOInterID
		FROM PPBOMEntry u1 INNER JOIN ICStockBillEntry u2 ON u1.FICMOInterID=u2.FICMOInterID and u1.FEntryID=u2.FPPBOMEntryID
		WHERE u2.FInterID=@InterId AND u1.FItemID<>u2.FItemID)
			RAISERROR('严格按投料单发料，不允许修改分录！',18,18)

		IF EXISTS(SELECT t1.FICMOInterID
		FROM PPBOMEntry t1,
		(
			SELECT FInterID,FItemID,FICMOInterID,FPPBOMEntryID,sum(FQty) as FQty FROM ICStockBillEntry
			WHERE FInterID=@InterId Group by FInterID,FItemID,FICMOInterID,FPPBOMEntryID
		) t2
		WHERE t1.FICMOInterID=t2.FICMOInterID
		AND t1.FItemID=t2.FItemID
		AND t1.FEntryID=t2.FPPBOMEntryID
		AND t1.FMaterielType<>376 
		AND (t1.FQtyMust+t1.FQtySupply)<(t1.FQty+t2.FQty))
			RAISERROR('严格按投料单发料，不允许超过关联的生产投料单数量。',18,18)
	END
	*/

	update src set @fsrccommitfield_prevalue=src.fqty,
	@fsrccommitfield_endvalue=@fsrccommitfield_prevalue+(case src.fmaterieltype when 376 then dest.fqty*cast(-1 as float) else dest.fqty end),
	@fcheck_fail=(case when (@fsrccommitfield_endvalue>=src.fdiscardqty) then @fcheck_fail else -1 end),
	src.fqty=@fsrccommitfield_endvalue,src.fauxqty=@fsrccommitfield_endvalue/cast(t1.fcoefficient as float)
	from ppbomentry src 
	inner join ppbom srchead on src.ficmointerid=srchead.ficmointerid
	inner join 
	(
		select u1.ficmointerid as fsourceinterid,u1.fppbomentryid,u1.fitemid,sum(u1.fqty) as fqty
		from  icstockbillentry u1 
		inner join t_icitem u2 on u1.fitemid=u2.fitemid
		where u1.finterid=@InterId 
		and u1.ficmointerid> 0 
		group by u1.ficmointerid,u1.fppbomentryid,u1.fitemid
	) dest on dest.fsourceinterid = src.ficmointerid and dest.fitemid = src.fitemid	and src.fentryid = dest.fppbomentryid
	inner join t_measureunit t1 on src.funitid=t1.fitemid

	/*
	SELECT u2.FICMOInterID,u2.FPPBOMEntryID,u2.FItemID,SUM(ISNULL(u2.FQty,0)) AS FStockQty 
	into #DataC43530FFCA6A4C56B7B91696D4DAEB78 
	FROM ICStockBillEntry u2     
	WHERE  u2.FSourceTrantype>0 and u2.FInterID= @InterId
	GROUP BY u2.FICMOInterID,u2.FPPBOMEntryID,u2.FItemID

	IF (select count(*) from #DataC43530FFCA6A4C56B7B91696D4DAEB78 ) >0 
	begin
		UPDATE u1 SET
		u1.FStockQty=ISNULL(u1.FStockQty,0)+ISNULL((CASE WHEN u1.FMaterielType=376 THEN ISNULL(m2.FStockQty,0)*cast(-1 as float) ELSE ISNULL(m2.FStockQty,0) END),0),
		u1.FAuxStockQty=ISNULL(u1.FAuxStockQty,0)+ISNULL(ROUND((CASE WHEN u1.FMaterielType=376 THEN ISNULL(cast(m2.FStockQty as float),0)*cast(-1 as float) 
		ELSE ISNULL(cast(m2.FStockQty as float),0) END)/cast(t2.FCoEfficient as float),t1.FQtyDecimal),0),
		u1.FWIPQty=ISNULL(u1.FWIPQty,0)+ISNULL((CASE WHEN u1.FMaterielType=371 THEN ISNULL(m2.FStockQty,0) ELSE 0 END),0),
		u1.FWIPAuxQty=ISNULL(u1.FWIPAuxQty,0)+ISNULL(ROUND((CASE WHEN u1.FMaterielType=371 
		THEN ISNULL(cast(m2.FStockQty as float),0) else 0 END)/cast(t2.FCoEfficient as float),t1.FQtyDecimal),0)
		FROM PPBOMEntry u1 
		INNER JOIN #DataC43530FFCA6A4C56B7B91696D4DAEB78 m2 ON u1.FItemID=m2.FItemID AND u1.FEntryID=m2.FPPBOMEntryID AND u1.FICMOInterID=m2.FICMOinterID 
		INNER JOIN t_ICItem t1 ON m2.FItemID=t1.FItemID 
		INNER JOIN t_MeasureUnit t2 ON u1.FUnitID=t2.FMeasureUnitID 
		INNER JOIN ICStockBill t3 ON t3.FInterID=@InterId
		WHERE (u1.FMaterielType = 371 OR u1.FMaterielType = 376)  --普通件/返还件 
	end

	select Distinct FICMOInterID, 0 as FStatus 	into #ICMOC43530FFCA6A4C56B7B91696D4DAEB78 from #DataC43530FFCA6A4C56B7B91696D4DAEB78

	Update Temp001 set FSTATUS=(case when ROUND(m1.FAuxStockQty,t1.FQtyDecimal)>=ROUND(m1.FAuxInLowLimitQty,t1.FQtyDecimal)
	then 0 else 1 end) 
	FROM #ICMOC43530FFCA6A4C56B7B91696D4DAEB78 Temp001 
	join ICMO m1  on m1.Finterid=Temp001.FICMOInterid 
	INNER JOIN t_ICItem t1 ON m1.FItemID=t1.FItemID 

	Update Temp001 set FSTATUS=FStatus + isnull(t1.FCount,0)  
	FROM #ICMOC43530FFCA6A4C56B7B91696D4DAEB78 Temp001  
	Left JOin 
	(
		select count(*) as FCount,u1.FICMOinterid 
		FROM  PPBOMENtry u1 
		join #ICMOC43530FFCA6A4C56B7B91696D4DAEB78 Temp  on u1.FICMOinterid=Temp.FICMOInterid 
		INNER JOIN t_ICItem t1 ON u1.FItemID=t1.FItemID 
		where u1.FMaterielType=371 and ROUND(u1.FAuxStockQty,t1.FQtyDecimal)<ROUND(u1.FAuxQtyMust,t1.FQtyDecimal)
		group by u1.FICMOinterid 
	) t1 on temp001.ficmointerid=t1.ficmointerid 

	DECLARE @StartDate AS DateTime

	SELECT @StartDate=FStartDate 
	FROM T_PeriodDate 
	WHERE FYear=(SELECT TOP 1 ISNULL(FValue,0) FROM t_SystemProfile WHERE FKey ='CurrentYear' AND FCategory='IC')
	AND FPeriod=(SELECT TOP 1 ISNULL(FValue,0) FROM t_SystemProfile WHERE FKey ='CurrentPeriod' AND FCategory='IC')

	Update m1
	SET FStatus=(CASE WHEN Temp001.FStatus=0 THEN 3 ELSE (CASE WHEN FCloseDate>=@StartDate THEN 1 ELSE m1.FStatus END) END),
	FCloseDate=(CASE WHEN Temp001.FStatus=0 THEN Convert(varchar(10) ,Getdate(),121) ELSE (CASE WHEN FCloseDate>=@StartDate THEN  Null ELSE m1.FCloseDate END) END),
	FCheckerID=(CASE WHEN Temp001.FStatus=0 THEN 16394 ELSE (CASE WHEN FCloseDate>=@StartDate THEN  Null ELSE m1.FCheckerID END) END),FMrpClosed=(CASE WHEN Temp001.FStatus=0 THEN 1 ELSE (CASE WHEN FCloseDate>=@StartDate THEN 0 ELSE m1.FMrpClosed END) END),FHandworkClose=(CASE WHEN Temp001.FStatus=0 THEN FHandworkClose ELSE 0 END)
	From ICMO m1 
	join #ICMOC43530FFCA6A4C56B7B91696D4DAEB78 Temp001 on m1.FINterID=Temp001.FICMOInterID 

	Update T1 Set T1.FBackFlushed=1 
	From SHWorkBillEntry T1,ICStockBill T2 
	where T2.FInterID=@InterId And T1.FWBInterID=T2.FWBInterID 
	--And (Select count(FInterID) from ICStockBill where FWBInterID=T2.FWBInterID)=1 

	drop table #DataC43530FFCA6A4C56B7B91696D4DAEB78
	drop table #ICMOC43530FFCA6A4C56B7B91696D4DAEB78

	--更新库存
	update t2 set fqty=t2.fqty+t1.fqty  
	From  
	(  
	  select t2.fitemid,t2.FSCStockID,SUM(ROUND(-1*t2.fqty,t3.FQtyDecimal)) fqty  
	  from icstockbill t1  
	  inner join icstockbillentry t2 on t1.finterid=t2.finterid  
	  inner join t_icitem t3 on t2.fitemid=t3.fitemid  
	  where t1.finterid=@InterId  
	  group by t2.fitemid,t2.FSCStockID  
	) t1 inner join icinventory t2 on t1.fitemid=t2.fitemid and t1.FSCStockID=t2.fstockid 
	*/
end


if @ftrantype=41
begin
	update src set @fsrccommitfield_prevalue=src.fseltranslateqty,
	@fsrccommitfield_endvalue=@fsrccommitfield_prevalue+(case src.fmaterieltype when 376 then dest.fqty*cast(-1 as float) else dest.fqty end),
	@fcheck_fail=(case when (@fsrccommitfield_endvalue>=src.fdiscardqty) then @fcheck_fail else -1 end),
	src.fseltranslateqty=@fsrccommitfield_endvalue,src.fseltranslateauxqty=@fsrccommitfield_endvalue/cast(t1.fcoefficient as float)
	from ppbomentry src 
	inner join ppbom srchead on src.ficmointerid=srchead.ficmointerid
	inner join 
	(
		select u1.ficmointerid as fsourceinterid,u1.fppbomentryid,u1.fitemid,sum(u1.fqty) as fqty
		from  icstockbillentry u1 
		inner join t_icitem u2 on u1.fitemid=u2.fitemid
		where u1.finterid=@InterId 
		and u1.ficmointerid> 0 
		group by u1.ficmointerid,u1.fppbomentryid,u1.fitemid
	) dest on dest.fsourceinterid = src.ficmointerid and dest.fitemid = src.fitemid	and src.fentryid = dest.fppbomentryid
	inner join t_measureunit t1 on src.funitid=t1.fitemid

	/*
	SELECT u2.FSourceinterid,u2.FsourceEntryID,u2.FItemID,SUM(ISNULL(u2.FQty,0)) AS FStockQty 
	into #Data6A82AA895BE44E78A7B45ACD31312122 
	FROM ICStockBillEntry u2     
	WHERE  (u2.FSourceTrantype=85 or u2.FSourceTrantype=571) and u2.FInterID= @InterId
	GROUP BY u2.FSourceinterid,u2.FsourceEntryID,u2.FItemID

	IF (select count(*) from #Data6A82AA895BE44E78A7B45ACD31312122 ) >0 
	begin
		UPDATE u1 SET
		u1.FTransLateQty=ISNULL(u1.FTransLateQty,0)+ISNULL(m2.FStockQty,0) ,  --领出去了也就不用调拨了
		u1.FTransLateAuxQty=ISNULL(u1.FTransLateAuxQty,0)+ 
		Round(ISNULL(cast(m2.FStockQty as float),0) / cast(t2.FCoEfficient as float),t1.FQtyDecimal) 
		FROM PPBOMEntry u1 
		INNER JOIN #Data6A82AA895BE44E78A7B45ACD31312122 m2 ON u1.FItemID=m2.FItemID AND u1.FEntryID=m2.FsourceEntryID AND u1.FICMOInterID=m2.FSourceinterid 
		INNER JOIN t_ICItem t1 ON m2.FItemID=t1.FItemID 
		INNER JOIN t_MeasureUnit t2 ON u1.FUnitID=t2.FMeasureUnitID 
		WHERE (u1.FMaterielType = 371 )  --普通件/返还件 
	end

	UPDATE ICStockBillEntry SET FAuxprice=FAuxPriceRef,FAmount=FAmtRef  
	FROM ICStockBillEntry u1 
	INNER JOIN ICStockBill v1 ON u1.FInterID=v1.FInterID  AND v1.FTranType=41 AND v1.FInterID= @InterId 
	WHERE (v1.FRefType<>12562 or v1.FRefType is null) 
	
	drop table #Data6A82AA895BE44E78A7B45ACD31312122

	--更新调出仓库仓库存
	update t2 set fqty=t2.fqty+t1.fqty  
	From  
	(  
	  select t2.fitemid,t2.FSCStockID,SUM(ROUND(-1*t2.fqty,t3.FQtyDecimal)) fqty  
	  from icstockbill t1  
	  inner join icstockbillentry t2 on t1.finterid=t2.finterid  
	  inner join t_icitem t3 on t2.fitemid=t3.fitemid  
	  where t1.finterid=@InterId  
	  group by t2.fitemid,t2.FSCStockID  
	) t1 inner join icinventory t2 on t1.fitemid=t2.fitemid and t1.FSCStockID=t2.fstockid 

	--调入仓库有库存记录的
	update t2 set fqty=t2.fqty+t1.fqty  
	From  
	(  
	  select t2.fitemid,t2.FDCStockID,SUM(ROUND(1*t2.fqty,t3.FQtyDecimal)) fqty  
	  from icstockbill t1  
	  inner join icstockbillentry t2 on t1.finterid=t2.finterid  
	  inner join t_icitem t3 on t2.fitemid=t3.fitemid  
	  where t1.finterid=@InterId  
	  group by t2.fitemid,t2.FDCStockID  
	) t1 inner join icinventory t2 on t1.fitemid=t2.fitemid and t1.FDCStockID=t2.fstockid 

	--调入仓没有库存记录的--select * from ICInventory
	INSERT INTO ICInventory(FBrNo,FItemID,   FBatchNo,FAuxPropID,FStockID,     FStockPlaceID,FKFPeriod,FKFDate,FQty,   FSecQty)  
	select                  '',   t1.fitemid,''      ,0,         t1.FDCStockID,0,            0,        '',     t1.fqty,0
	From  
	(  
	  select t2.fitemid,t2.FDCStockID,SUM(ROUND(1*t2.fqty,t3.FQtyDecimal)) fqty  
	  from icstockbill t1  
	  inner join icstockbillentry t2 on t1.finterid=t2.finterid  
	  inner join t_icitem t3 on t2.fitemid=t3.fitemid  
	  where t1.finterid=@InterId  
	  group by t2.fitemid,t2.FDCStockID  
	) t1 left join icinventory t2 on t1.fitemid=t2.fitemid and t1.FDCStockID=t2.fstockid
	where t2.fitemid is null 

	*/
end

set nocount off

go


--*****
--虚仓出入库可由投料单生成，所以设置虚仓出入库表结构与常规出入库表结构相同
IF EXISTS (select * from sysobjects where name='ZPStockBillEntry' and xtype='u') and not EXISTS (select t1.id
from sysobjects t1 
inner join syscolumns t2 on t1.id=t2.id
where t1.name='ZPStockBillEntry' and t1.xtype='u' and t2.name='FICMOBillNo')
begin
	alter table ZPStockBillEntry add FICMOBillNo varchar(100)
	alter table ZPStockBillEntry add FICMOInterID int
	alter table ZPStockBillEntry add FPPBomEntryID int
end

go

IF EXISTS (select * from sysobjects where name='ppbomentry' and xtype='u') and not EXISTS (select t1.id
from sysobjects t1 
inner join syscolumns t2 on t1.id=t2.id
where t1.name='ppbomentry' and t1.xtype='u' and t2.name='folditemid')
begin
	alter table ppbomentry add folditemid int
end

go

--批量生成领料单/虚仓出库单----由生产计划单或任务单批量生成--在前台过度一下--*****
--My_P_GenerateOutStock24_26 16394,'','',0
IF EXISTS (select * from sysobjects where name='My_P_GenerateOutStock24_26' and xtype='p')  drop  procedure My_P_GenerateOutStock24_26

go

create procedure  [dbo].My_P_GenerateOutStock24_26(@fuserid int,@fbegbillno varchar(30) output,@fendbillno varchar(30) output,@fidentify int output)  --

as
set nocount on

--declare @fuserid int,@fbegbillno varchar(30),@fendbillno varchar(30),@fidentify int select @fuserid=16394,@fbegbillno='',@fendbillno='',@fidentify=0

declare @ficmointerid int,@fcostobjid int,@FDIOFInFanager int,@FDIOFOutSanager int
declare @fcheck_fail int,@fppbominterid int,@FDIOFInSanager int,@FDIOFOutFanager int
declare @fsrccommitfield_prevalue decimal(28,13),@fininterid int,@fsupplyid int
declare @fsrccommitfield_endvalue decimal(28,13),@UpStockWhenSave int,@fspid int,@fempid int,@fdeptid int,@fppbomentryid int
declare @foutinterid int,@fpqty decimal(24,4),@xx_FItemIDOld int,@fxxitemid int,@InterId int,@CostObjGroupID int
declare @fplanamount decimal (24,2),@fstockid int,@fcbitemid int,@frob int,@fisbackflush int
declare @fsourceInterid int,@fsourceEntryid int,@fsourceBillNo varchar (100),@FCustBillNo varchar(30)
declare @ficmobillno varchar(20),@UserId int,@fqtymust decimal(24,4),@s varchar(5000),@fstockmanagerid int
declare @FSourceSeBillNo varchar(20),@FSourcePOBillNo varchar(20),@forderbillno varchar(20)
declare @fplanprice decimal(18,4),@fitemid int,@funitid int,@entryid int,@fqty decimal(24,4)
declare @FInterID int,@BillNo varchar (20),@StockId int,@StockNumber varchar (20)
DECLARE @TmpID INT ,@fperqty decimal(24,4),@fsourceqty decimal(24,4),@iLength int,@iFind bit,@finqty decimal(24,4)
declare @fprojectval  varchar(200),@FDateFormat  varchar(200),@fcount int,@fplanbegindate datetime
declare @FDCStockID int,@FSCStockID int,@FDCSPID int,@fscspid int,@FVersion int
declare @famount decimal (18,2),@fpitemid int,@fdate datetime,@fserial int,@FStockManagerName varchar(30)
declare @foutbillinterid int,@foutbillentryid int,@FSrcMpsPlanOrderInterid int,@fmpsqty decimal(24,4),@fsourceplanbegindate datetime
declare @findex int,@fsrcplanorderinterid int,@flag int,@FVarSrcPlanOrderInterid int
declare @iCurrentRecord int,@k int,@fxishu int,@forderinterid int,@forderentryid int
declare @forderqty decimal(24,4),@foutqty decimal(24,4),@iMaxRecord int,@fsourcetrantype int,@ffmanagerid int

select @fidentify=isnull(max(fid),0)+1 from my_t_identify
insert into my_t_identify(fid,fuserid,fdate,FTrantypeID) values(@fidentify,@fuserid,getdate(),24)

select @fdate=replace(convert(varchar(10),getdate(),111),'/','-'),@fcount=1,@fbegbillno='',@fendbillno=''
--select fnumber,fname,* from t_emp where fname like '莫%'

select @UpStockWhenSave=fvalue from T_SYSTEMPROFILE where  fkey='UPSTOCKWHENSAVE'

/*
select t5.finterid ficmointerid,t5.fitemid fcbitemid,
(t3.fauxqtymust-t3.fauxqty) fqtymust,--(t3.fauxqtymust-t3.fauxqty )fqty, 
(case when ((t6.fqty*t3.fauxqtyscrap*(1+t3.fscrap/100))>=(t3.fauxqtymust-t3.fauxqty) /*or (t6.fqty>=(t5.fqty-t5.fcommitqty))*/) then (t3.fauxqtymust-t3.fauxqty) else (t6.fqty*t3.fauxqtyscrap*(1+t3.fscrap/100)) end) fqty, 
t2.finterid fppbominterid,t3.fentryid fppbomentryid,t5.fworkshop fdeptid,isnull(t4.fdefaultloc,0) fstockid,
t5.FCostObjID,t4.ferpclsid,0 fplanprice,0 fplanamount,t5.fbillno ficmobillno,t3.funitid,isnull(t4.fspid,0) fspid,
t3.fitemid,
--(case when t5.forderinterid<>0 then t5.forderinterid else t5.FPPOrderInterID end) fsourceinterid,
isnull(t5.forderinterid,0) fsourceinterid,--预测订单不按订单打印，只按部门打印
t5.fsourceentryid,
(case when t5.forderinterid<>0 then 81 else 87 end) fsourcetrantype,t17.finterid fisbackflush,
t13.finterid fstockmanagerid,isnull((select top 1 fitemid from t_emp where fname=t13.fname),25326) ffmanagerid,t5.FPlanCommitDate fplanbegindate
into #SourceData
from 
(
	select sum(t6.fqty) fqty,t6.ficmointerid 
	from my_t_scheduledetail t6 --和任务单是一对多的关系
	inner join My_t_ScheduleDetailTemp t1 on t1.finterid=t6.finterid 
	where t1.fuserid=@fuserid
	group by t6.ficmointerid
) t6 inner join icmo t5 on t6.ficmointerid=t5.finterid
inner join ppbom t2 on t5.finterid=t2.ficmointerid
inner join ppbomentry t3 on t2.finterid=t3.finterid
inner join t_icitem t4 on t3.fitemid=t4.fitemid
inner join t_icitem t8 on t5.fitemid=t8.fitemid
inner join t_SubMessage t13 on t13.finterid=t4.f_114 and t13.ftypeid=10004  --仓管员
inner join t_SubMessage t17 on t17.finterid=t4.f_115 and t17.ftypeid=10003  --倒冲
where t5.fstatus in (1,2) and (t3.fauxqtymust-t3.fauxqty)>0  --
--and t4.ferpclsid=2 
and t17.fname<>'是'
--order by t4.fshortnumber
*/

select isnull(t5.FHeadSelfJ0180,0) fsupplyid,t5.FHeadSelfJ0176 FSourcePOBillNo,t5.FHeadSelfJ0177 FSourceSeBillNo,t5.finterid ficmointerid,
t5.fitemid fcbitemid,(t3.fqtymust-t3.fqty) fqtymust,t6.fqty, 
t2.finterid fppbominterid,t3.fentryid fppbomentryid,t5.fworkshop fdeptid,isnull(t4.fdefaultloc,0) fstockid,
t5.FCostObjID,t4.ferpclsid,0 fplanprice,0 fplanamount,t5.fbillno ficmobillno,t3.funitid,
isnull(t4.fspid,0) fspid,t3.fitemid,isnull(t1.fbillno,'') forderbillno,
--(case when t5.forderinterid<>0 then t5.forderinterid else t5.FPPOrderInterID end) fsourceinterid,
(case when isnull(t5.forderinterid,0)=0 then t5.finterid else t5.forderinterid end) fsourceinterid,--
(case when isnull(t5.forderinterid,0)<>0 then 81 else 85 end) fsourcetrantype,isnull(t17.finterid,0) fisbackflush,
isnull(t13.finterid,0) fstockmanagerid,isnull(t13.fname,'') fstockmanagername,
isnull((select top 1 fitemid from t_emp where fname=t13.fname),25326) ffmanagerid,t5.FPlanCommitDate fplanbegindate
into #SourceData
from My_t_ICStockBill24Temp t6 
inner join icmo t5 on t6.ficmointerid=t5.finterid
inner join ppbom t2 on t5.finterid=t2.ficmointerid
inner join ppbomentry t3 on t2.finterid=t3.finterid and t6.FPPBomEntryID=t3.fentryid
inner join t_icitem t4 on t3.fitemid=t4.fitemid
inner join t_icitem t8 on t5.fitemid=t8.fitemid
left join t_SubMessage t13 on t13.finterid=t4.f_114 and t13.ftypeid=10003  --仓管员
left join t_SubMessage t17 on t17.finterid=t4.f_115 and t17.ftypeid=10002  --倒冲
left join seorder t1 on t1.finterid=t5.forderinterid
where t6.fuserid=@fuserid and t5.fstatus in (1,2) and (t3.fauxqtymust-t3.fauxqty)>0  --
--and t4.ferpclsid=2 
and isnull(t17.fname,'否')<>'是'
--order by t4.fshortnumber

--领料--	
--ALTER  TABLE  icstockbill  DISABLE  TRIGGER  My_Tri_ICStockBill_In 

--部门+源单+是否倒冲+仓管员+仓库
DECLARE icbom_cursor CURSOR FOR	
select distinct t1.fsupplyid,t1.fdeptid,t1.fsourcetrantype,t1.fsourceinterid,t1.fisbackflush,t1.fstockmanagerid,t1.fstockmanagername,t1.fstockid
from #SourceData t1 
inner join t_icitem t2 on t1.fitemid=t2.fitemid 
inner join t_stock t3 on t2.fdefaultloc=t3.fitemid
where t3.ftypeid<>503 --非代管仓
order by t1.fisbackflush,t1.fstockid,t1.fstockmanagerid,t1.fdeptid,t1.fsupplyid,t1.fsourcetrantype,t1.fsourceinterid

OPEN icbom_cursor

FETCH NEXT FROM icbom_cursor 
INTO @fsupplyid,@fdeptid,@fsourcetrantype,@fsourceinterid,@fisbackflush,@fstockmanagerid,@fstockmanagername,@fstockid

WHILE @@FETCH_STATUS = 0
BEGIN 
	exec My_p_GetBillNo 24,'icstockbill',@Interid output, @BillNo output

    if @fcount=1 set @fbegbillno=@BillNo
		           	
	DECLARE authors_cursor CURSOR FOR	

	select t1.forderbillno,t1.FSourcePOBillNo,t1.FSourceSeBillNo,t1.ffmanagerid,t1.fplanbegindate,
	t1.fcbitemid,t1.fitemid,t1.funitid,t1.fstockid,t1.fspid,t1.fdeptid,t1.fqtymust,t1.fqty,t1.ficmointerid,
	t1.ficmobillno,t1.fplanprice,t1.fplanamount,t1.fcostobjid,t1.fppbominterid,t1.fppbomentryid 
	from #SourceData t1
	inner join t_icitem t2 on t1.fitemid=t2.fitemid
	inner join t_stock t3 on t2.fdefaultloc=t3.fitemid
	where t3.ftypeid<>503 --非代管仓
	and t1.fsupplyid=@fsupplyid and t1.fdeptid=@fdeptid and t1.fsourcetrantype=@fsourcetrantype 
	and t1.fsourceinterid=@fsourceinterid and t1.fisbackflush=@fisbackflush 
	and t1.fstockmanagerid=@fstockmanagerid and t1.fstockid=@fstockid
	order by t2.fnumber

    set @entryid=1

	OPEN authors_cursor

	FETCH NEXT FROM authors_cursor 
	INTO @forderbillno,@FSourcePOBillNo,@FSourceSeBillNo,@ffmanagerid,@fplanbegindate,@fcbitemid,@fitemid,@funitid,@fstockid,@fspid,@fdeptid,@fqtymust,@fqty,@ficmointerid,@ficmobillno,@fplanprice,@fplanamount,@fcostobjid,@fppbominterid,@fppbomentryid

	WHILE @@FETCH_STATUS = 0
	BEGIN 		
		INSERT INTO ICStockBillEntry (fentryselfb0448,   FInterID,FEntryID,FBrNo,FItemID,FAuxPropID,FBatchNo,FQtyMust, FQty,     FReProduceType,FCostOBJID, FCostObjGroupID,FUnitID ,FAuxQtyMust,Fauxqty,FSecCoefficient,FSecQty,FAuxPlanPrice,FPlanAmount, Fauxprice,Famount,FBomInterID,Fnote,FKFDate,FKFPeriod,FPeriodDate,FSCStockID,FDCSPID,FOperSN,FOperID,FSNListID,FSourceBillNo,FSourceTranType,FSourceInterId, FSourceEntryID, FICMOBillNo, FICMOInterID, FPPBomEntryID, FInStockID) 
		VALUES (                      @fstockmanagername,@Interid,@EntryId,'0',  @fitemid,0,        '',      @fqtymust,@fqty   , 1059,          @fcostobjid,0,              @FUnitID,@fqtymust , @fqty,  0,              0,      @fplanprice,  @fplanamount,0,        0,      0,          '',   Null,   0,        Null,       @fstockid, @fspid, 0,      0,      0,        @ficmobillno, 85,             @ficmointerid,  @fppbomentryid, @ficmobillno,@ficmointerid,@fppbomentryid,0) 

		set @entryid=@entryid+1
		set @fcount=@fcount+1

		FETCH NEXT FROM authors_cursor 
		INTO @forderbillno,@FSourcePOBillNo,@FSourceSeBillNo,@ffmanagerid,@fplanbegindate,@fcbitemid,@fitemid,@funitid,@fstockid,@fspid,@fdeptid,@fqtymust,@fqty,@ficmointerid,@ficmobillno,@fplanprice,@fplanamount,@fcostobjid,@fppbominterid,@fppbomentryid
	END

	CLOSE authors_cursor
	DEALLOCATE authors_cursor

	if @fsourcetrantype=81
		select @fsourcebillno=fbillno,@FCustBillNo=fheadselfs0144 from seorder where finterid=@fsourceinterid
	else
		select @fsourcebillno=fbillno from pporder where finterid=@fsourceinterid
	--select finterid,fname,* from t_submessage where ftypeid=471
	INSERT INTO ICStockBill(FHeadSelfB0446, FHeadSelfB0445,FHeadSelfB0442,FHeadSelfB0443,FHeadSelfB0436,FHeadSelfB0433,FHeadSelfB0441,   FHeadSelfB0437, FInterID,FBillNo,FBrNo,FTranType,FCancellation,FStatus,FUpStockWhenSave,FVchInterID,FROB,    FHookStatus,Fdate, FDeptID, Fuse,FCheckDate,FSManagerID, FFManagerID,  FBillerID,   FAcctID,FMultiCheckLevel1,FMultiCheckDate1,FMultiCheckLevel2,FMultiCheckDate2,FMultiCheckLevel3,FMultiCheckDate3,FMultiCheckLevel4,FMultiCheckDate4,FMultiCheckLevel5,FMultiCheckDate5,FMultiCheckLevel6,FMultiCheckDate6,FPurposeID,FWBINTERID,FSelTranType,FBackFlushed) 
	VALUES (		        @fplanbegindate,@fdate,        20977,         @fsupplyid,    @forderbillno, @fidentify,    @FSourceSeBillNo, @ficmobillno,   @InterId,@BillNo,'0',  24,       0,            0,      @UpStockWhenSave,0,          1,       0,          @fdate,@fdeptid,'',  Null,      0 ,          @ffmanagerid, @fuserid,    0,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,12000,0,85,1)
	 
	--exec My_p_UpdateBillRelateData @InterId --更新关联数  已经直接在触发器My_Tri_ICStockBill_In中写明
	--exec My_p_UpdateBillRelateData_24_26 24,@InterId --更新计划投料单数量

	UPDATE ICStockBill SET FUUID=NEWID() WHERE FInterID=@InterId
	
	INSERT INTO t_Log (FDate,FUserID,FFunctionID,FStatement,FDescription,FMachineName,FIPAddress) VALUES (getdate(),@UserId,'K010001',3,'编号为'+@BillNo+'的单据保存成功','KSW118','192.168.0.159')

	set @fendbillno=@BillNo

	FETCH NEXT FROM icbom_cursor 
    INTO @fsupplyid,@fdeptid,@fsourcetrantype,@fsourceinterid,@fisbackflush,@fstockmanagerid,@fstockmanagername,@fstockid
END

CLOSE icbom_cursor
DEALLOCATE icbom_cursor



--更新任务单的领料状态 
/*
update m2 set FHeadSelfJ0173=(case when m1.fqty=0 then 40011 when (m1.fqty>0 and m1.fqtymust>m1.fqty) then 40012 when m1.fqtymust<=m1.fqty then 40013 end) 
from
(
	select t1.ficmointerid,isnull(sum(t1.fqtymust),0) fqtymust,isnull(sum(t2.fqty),0) fqty
	from PPBomEntry t1
	left join 
	(
		select t1.ficmointerid,t1.fppbomentryid,sum(t1.fqty) fqty
		from icstockbill t0 
		inner join icstockbillentry t1 on t0.finterid=t1.finterid
		inner join 
		(	  select distinct t1.FICMOInterID 
			  from icstockbillentry t1
			  inner join icstockbill t2 on t1.finterid=t2.finterid
			  where t2.fbillno>=@fbegbillno and t2.fbillno<=@fendbillno and t2.ftrantype=24
		) t2 on t1.ficmointerid=t2.ficmointerid
		where t0.ftrantype=24 
		group by t1.ficmointerid,t1.fppbomentryid
	) t2 on t1.ficmointerid=t2.ficmointerid and t1.fentryid=t2.fppbomentryid
	group by t1.ficmointerid
) m1 inner join icmo m2 on m1.ficmointerid=m2.finterid
*/
--ALTER  TABLE  icstockbill  ENABLE  TRIGGER  My_Tri_ICStockBill_In 

--select * from #SourceData


--虚仓出库--	

--部门+源单+是否倒冲+仓管员
DECLARE icbom_cursor CURSOR FOR	
select distinct t1.fsupplyid,t1.fdeptid,t1.fsourcetrantype,t1.fsourceinterid,t1.fisbackflush,t1.fstockmanagerid,t1.fstockmanagername
from #SourceData t1 
inner join t_icitem t2 on t1.fitemid=t2.fitemid 
inner join t_stock t3 on t2.fdefaultloc=t3.fitemid
where t3.ftypeid=503 --代管仓
order by t1.fisbackflush,t1.fstockmanagerid,t1.fdeptid,t1.fsupplyid,t1.fsourcetrantype,t1.fsourceinterid

OPEN icbom_cursor

FETCH NEXT FROM icbom_cursor 
INTO @fsupplyid,@fdeptid,@fsourcetrantype,@fsourceinterid,@fisbackflush,@fstockmanagerid,@fstockmanagername

WHILE @@FETCH_STATUS = 0
BEGIN 
	exec My_p_GetBillNo 26,'zpstockbill',@Interid output, @BillNo output
		           	
	DECLARE authors_cursor CURSOR FOR	
	--select t1.ffmanagerid,t1.fplanbegindate,t1.fcbitemid,t1.fitemid,t1.funitid,t1.fstockid,t1.fspid,t1.fdeptid,t1.fqtymust,t1.fqty,t1.ficmointerid,t1.ficmobillno,t1.fplanprice,t1.fplanamount,t1.fcostobjid,t1.fppbominterid,t1.fppbomentryid 

	select t1.forderbillno,t1.FSourcePOBillNo,t1.FSourceSeBillNo,t1.ffmanagerid,t1.fitemid,t1.funitid,
	t1.fstockid FDCStockID,t1.fdeptid,t1.fqtymust fqtymust,t1.fqty fqty,t1.ficmointerid,t1.ficmobillno,
	t1.fppbomentryid
	from #SourceData t1
	inner join t_icitem t2 on t1.fitemid=t2.fitemid
	inner join t_stock t3 on t2.fdefaultloc=t3.fitemid
	where t3.ftypeid=503 --代管仓
	and t1.fsupplyid=@fsupplyid and t1.fdeptid=@fdeptid and t1.fsourcetrantype=@fsourcetrantype and t1.fsourceinterid=@fsourceinterid 
	and t1.fisbackflush=@fisbackflush and t1.fstockmanagerid=@fstockmanagerid
	order by t2.fnumber

    set @entryid=1

	OPEN authors_cursor

	FETCH NEXT FROM authors_cursor 
	INTO @forderbillno,@FSourcePOBillNo,@FSourceSeBillNo,@ffmanagerid,@fitemid,@funitid,@FDCStockID,@fdeptid,@fqtymust,@fqty,@ficmointerid,@ficmobillno,@fppbomentryid

	WHILE @@FETCH_STATUS = 0
	BEGIN 		
		INSERT INTO ZPStockBillEntry (fentryselfzou33,   FDCStockID, FInterID,FEntryID,FBrNo,FItemID, FBatchNo,FQty,     FUnitID ,Fauxqty,Fnote,FKFDate,FSourceBillNo, FSourceTranType, FSourceInterId,  FSourceEntryID,FEntrySelfZOU32,  FEntrySelfZOU30,  FEntrySelfZOU31 ) 
		VALUES (                      @fstockmanagername,@FDCStockID,@Interid,@EntryId,'0',  @fitemid,'',      @fqty   , @FUnitID,@fqty,  '',   Null,   @ficmobillno,  85,              @ficmointerid,   @fppbomentryid,@FICMOBillNo,     @FICMOInterID,    @FPPBomEntryID) 

		set @entryid=@entryid+1
		set @fcount=@fcount+1

		FETCH NEXT FROM authors_cursor 
		INTO @forderbillno,@FSourcePOBillNo,@FSourceSeBillNo,@ffmanagerid,@fitemid,@funitid,@FDCStockID,@fdeptid,@fqtymust,@fqty,@ficmointerid,@ficmobillno,@fppbomentryid
	END

	CLOSE authors_cursor
	DEALLOCATE authors_cursor

	INSERT INTO ZpStockBill(FSupplyID, FHeadSelfZOU41, FHeadSelfZOU35,FHeadSelfZOU36,  FHeadSelfZOU39,FHeadSelfZOU34,FInterID,FBillNo,FBrNo,FTranType,FCancellation,FStatus,FUpStockWhenSave,FROB,Fdate, FDeptID, FCheckDate,FSManagerID, FFManagerID,  FBillerID,   FSelTranType) 
	VALUES (		        @FSupplyID,@fdate,         @forderbillno, @FSourceSeBillNo,40062,         @fidentify,    @InterId,@BillNo,'0',  26,       0,            0,      @UpStockWhenSave,1,   @fdate,@fdeptid,Null,      0 ,          @ffmanagerid, @fuserid,    0)
	 
	--exec My_p_UpdateBillRelateData @InterId --更新关联数
	--exec My_p_UpdateBillRelateData_24_26 24,@InterId --更新计划投料单数量
	
--	--更新投料单的选单数量--触发器已经回写 
--	update t1 set fqty=t1.fqty+isnull(t2.fqty,0),fauxqty=t1.fauxqty+isnull(t2.fqty,0)
--	from PPBOMEntry t1 --
--	inner join 
--	(
--		select t1.FSourceInterId,t1.fsourceentryid,t1.fitemid,sum(t1.fqty) fqty
--		from ZPStockBill t0 --
--		inner join ZPStockBillEntry t1 on t0.finterid=t1.finterid  --
--		inner join icmo t3 on t3.finterid=t1.FSourceInterId
--		where t0.finterid=@InterId and t0.ftrantype=26 and t1.fsourcetrantype=85
--		group by t1.FSourceInterId,t1.fsourceentryid,t1.fitemid
--	) t2 on t1.ficmointerid=t2.FSourceInterId and t1.FEntryID=t2.fsourceentryid and t1.fitemid=t2.fitemid

	INSERT INTO t_Log (FDate,FUserID,FFunctionID,FStatement,FDescription,FMachineName,FIPAddress) VALUES (getdate(),@UserId,'K010001',3,'编号为'+@BillNo+'的单据保存成功','KSW118','192.168.0.159')

	FETCH NEXT FROM icbom_cursor 
    INTO @fsupplyid,@fdeptid,@fsourcetrantype,@fsourceinterid,@fisbackflush,@fstockmanagerid,@fstockmanagername
END

CLOSE icbom_cursor
DEALLOCATE icbom_cursor

--select * from #SourceData

drop table #SourceData

set nocount off

go

--领料单打印

--My_P_PrintICStock_24 16394,'SOUT001670'

IF EXISTS (select * from sysobjects where name='My_P_PrintICStock_24' and xtype='p')  drop  procedure My_P_PrintICStock_24

go

create procedure  [dbo].My_P_PrintICStock_24(@fuserid int,@fsourcebillno varchar(20))  --

as
set nocount on

declare @fusername varchar(20)

select @fusername=fname from t_user where fuserid=@fuserid

create table #data(FIndex int IDENTITY,fdeptid int,frob int,finterid int,fentryid int,FTranType int,fshortnumber varchar(30),
fqty decimal(24,4),fbillno varchar(30),fitemid int,fdate datetime,fnumber varchar(30),fstockid int,fparentnumber varchar(30),)

insert into #data(fparentnumber,fstockid,     fnumber,   fshortnumber,   finterid ,  fentryid ,  fitemid,   fqty)
select            t3.fnumber,   t2.fscstockid,t3.fnumber,t3.fshortnumber,t1.finterid,t2.fentryid,t2.fitemid,t2.fqty
from icstockbill t1
inner join icstockbillentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid  --套件
where t1.fbillno=@fsourcebillno and t3.fnumber like '1.02.%' 
union all                                                                
select            t3.fnumber,   t4.fdefaultloc,'----'+t4.fnumber,'----'+t4.fshortnumber,t1.finterid,t2.fentryid,t4.fitemid,t2.fqty*(case when isnull(t4.F_116,0)=0 then 1 else t4.F_116 end)/*单位用量*/ fqty
from icstockbill t1
inner join icstockbillentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid  --套件
inner join t_icitem t4 on Charindex(t3.fshortnumber,t4.fnumber)>0  --t3.fshortnumber=substring(t4.fnumber,6,6) --子件
where t1.fbillno=@fsourcebillno and t3.fnumber like '1.02.%' and t4.fnumber like '6.%'
union all
select            t3.fnumber,   t2.fscstockid,t3.fnumber,t3.fshortnumber,t1.finterid,t2.fentryid,t2.fitemid,t2.fqty
from icstockbill t1
inner join icstockbillentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid  --
where t1.fbillno=@fsourcebillno and t3.fnumber not like '1.02.%' 

select t10.fdate 制单日期,t4.fname 制单人,isnull(t1.fname,'') 发料人,isnull(t2.fname,'') 领料人,isnull(t10.FHeadSelfB0433,0) 标识码,
Null 单据类型,isnull(t0.fbillno,'') 任务单号,isnull(t0.finterid,0) 任务单内码,isnull(t9.FPPBomEntryID,0) 投料单分录号,t8.fitemid 生产车间内码,t8.fname 生产车间,
(case when t0.fstatus=0 then '计划' when t0.fstatus in (1,2) then '下达' when t0.fstatus=5 then '确认' when t0.fstatus=3 then '结案' end) 状态,
Null 订单编号,Null 客户订单号,Null 计划开工日期,
Null 下单日期,t10.fbillno 单据编号,t9.finterid 单据内码,t9.fentryid 分录号,null 客户,t12.fparentnumber 父项代码,
isnull(t7.fshortnumber,'') 产品短代码,isnull(t7.fnumber,'') 产品编码,isnull(t7.FName,'') 产品名称, isnull(t7.fmodel,'') 产品规格型号,isnull(t7.fitemid,0) 产品内码,
0 订单数,Null 工厂交期,Null 包材交期,Null 工厂备注,
Null 整单包装说明,Null 产品包装说明,Null 订单备注,isnull(t13.fname,'') 仓管员,t15.fitemid 仓库内码,t15.fname 仓库,isnull(t14.fname,'') 物料类别,
isnull(t0.fcostobjid,0) 成本对象内码,t12.fshortnumber 物料短代码,t12.fnumber 物料编码,t11.FName 物料名称, isnull(t11.fmodel,'') 物料规格型号,isnull(t11.fitemid,0) 物料内码,
t3.fitemid 单位内码,t3.fname 单位,cast(t9.fqty as decimal(24,2)) 应发数,cast(t9.fqty as decimal(24,2)) 已发数,0 未发数,
(case when Charindex('-',t10.fbillno)>0 then 0 else cast(isnull(t16.fqty,0) as decimal(24,2)) end) 即时库存,
isnull(t17.fname,'否') 倒冲,(case when t11.ferpclsid=1 then '外购' when t11.ferpclsid=2 then '自制'  end) 物料属性
into #temp
from #data t12
inner join icstockbillentry t9 on t12.finterid=t9.finterid and t12.fentryid=t9.fentryid
inner join icstockbill t10 on t10.finterid=t9.finterid
left join icmo t0 on t9.ficmointerid=t0.finterid
left join t_User t4 on t10.fbillerid=t4.fuserid and t4.fuserid<>0  
left join t_User t5 on t0.fconfirmerid=t5.fuserid and t5.fuserid<>0  
left join t_User t6 on t0.fconveyerid=t6.fuserid and t6.fuserid<>0  
left join t_icitem t7 on t0.fitemid=t7.fitemid 
inner join t_department t8 on t8.fitemid=t10.fdeptid
inner join t_icitem t11 on t11.fitemid=t12.fitemid
inner join t_measureunit t3 on t3.fitemid=t11.funitid
left join t_SubMessage t13 on t13.finterid=t11.f_114 and t13.ftypeid=10003
left join t_SubMessage t14 on t14.finterid=t11.ftypeid and t14.ftypeid=504
inner join t_stock t15 on t15.fitemid=t12.fstockid
left join 
(
	select fitemid,fstockid,sum(fqty) fqty 
	from 
	(
		select fitemid,fstockid,fqty from icinventory 
		union all 
		select t1.fitemid,t1.fstockid,t1.fqty from poinventory t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid where t1.fitemid<>20355 and t2.fnumber like '6.%'
	) t1
	group by fitemid,fstockid
) t16 on t16.fitemid=t12.fitemid and t16.fstockid=t12.fstockid
left join t_SubMessage t17 on t17.finterid=t11.f_115 and t17.ftypeid=10002
left join t_emp t1 on t1.fitemid=t10.ffmanagerid
left join t_emp t2 on t2.fitemid=t10.fsmanagerid

select 物料编码,getdate() 打印时间,@fusername 打印人,制单日期,制单人,生产车间, 
单据编号,'' 客户订单号,'' 订单编号,计划开工日期,发料人,领料人,物料短代码,物料名称,物料规格型号, 
仓库,即时库存,sum(应发数) 应发数,标识码,单位  
from #temp
group by 父项代码,物料编码,制单日期,制单人,生产车间,单据编号,--订单编号,客户订单号,
计划开工日期,发料人, 
领料人,物料短代码,物料名称,物料规格型号,仓库,即时库存,标识码,单位  
order by 父项代码,物料编码

drop table #data
drop table #temp

set nocount off

go


--*****



--update t1 set fstatus=0,fcheckerid=0 from zpstockbill t1 where fbillno in ('zin000452','zout000740')
--update t1 set fstatus=1,fcheckerid=16394,fcheckdate='2013-03-31' from zpstockbill t1 where fbillno in ('zin000452','zout000740')
--delete t1 from zpstockbill t1 where fbillno in ('zin000452','zout000740')

--*****
--批量生成虚仓入库单/虚仓出库单----塑胶子件盘盈盘亏

----My_P_GenerateZPOutStock26_6_ByInv 
IF EXISTS (select * from sysobjects where name='My_P_GenerateZPOutStock26_6_ByInv' and xtype='p')  drop  procedure My_P_GenerateZPOutStock26_6_ByInv

go

create procedure  [dbo].My_P_GenerateZPOutStock26_6_ByInv

as
set nocount on
--

declare @fuserid int,@fsourceinterid int,@fchecktype int,@Interid int  select @fuserid=16394,@fsourceinterid=0,@fchecktype=0,@Interid =0

declare @ficmointerid int,@fcostobjid int,@FDIOFInFanager int,@FDIOFOutSanager int,@fbatchno varchar(50)
declare @fcheck_fail int,@fppbominterid int,@FDIOFInSanager int,@FDIOFOutFanager int
declare @fsrccommitfield_prevalue decimal(28,13),@fininterid int,@frob int,@fidentify int
declare @fsrccommitfield_endvalue decimal(28,13),@UpStockWhenSave int,@fspid int,@fempid int,@fdeptid int,@fppbomentryid int
declare @foutinterid int,@fpqty decimal(24,4),@xx_FItemIDOld int,@fxxitemid int,@CostObjGroupID int
declare @fplanamount decimal (24,2),@fstockid int,@fcbitemid int,@fisbackflush int,@fidentify24 int
declare @fsourceEntryid int,@fsourceBillNo varchar (100),@FCustBillNo varchar(30)
declare @ficmobillno varchar(20),@UserId int,@fqtymust decimal(24,4),@s varchar(5000),@fstockmanagerid int

declare @fplanprice decimal(18,4),@fitemid int,@funitid int,@entryid int,@fqty decimal(24,4)
declare @BillNo varchar (20),@StockId int,@StockNumber varchar (20)
DECLARE @TmpID INT ,@fperqty decimal(24,4),@fsourceqty decimal(24,4),@iLength int,@iFind bit,@finqty decimal(24,4)
declare @fprojectval  varchar(200),@FDateFormat  varchar(200),@fcount int,@fplanbegindate datetime
declare @FDCStockID int,@FSCStockID int,@FDCSPID int,@fscspid int,@FVersion int
declare @famount decimal (18,2),@fpitemid int,@fdate datetime,@fserial int,@FStockManagerName varchar(30)
declare @foutbillinterid int,@foutbillentryid int,@FSrcMpsPlanOrderInterid int,@fmpsqty decimal(24,4),@fsourceplanbegindate datetime
declare @findex int,@fsrcplanorderinterid int,@flag int,@FVarSrcPlanOrderInterid int
declare @iCurrentRecord int,@k int,@fxishu int,@forderinterid int,@forderentryid int
declare @forderqty decimal(24,4),@foutqty decimal(24,4),@iMaxRecord int,@fsourcetrantype int,@ffmanagerid int

select @fdate='2013-03-31',@fcount=1

--select fnumber,fname,* from t_emp where fname like '莫%'
--update t1 set 实盘数=t1.实盘数+1088 from sheet1$ t1 where t1.代码 like '%060043%'

create table #data(fdeptid int,frob int,finterid int,fentryid int,FTranType int,
fqty decimal(24,4),fbillno varchar(30),fitemid int,fdate datetime,fstockid int,fbatchno varchar(50))

--其它出库单/销售出库/盘盈入库/盘亏毁损/其它入库/外购入库 fdcstockid  领料单 fscstockid   40	盘盈入库  43	盘亏毁损
insert into #data(fbatchno,   fstockid,   fdeptid,   frob ,  finterid ,  fentryid ,  ftrantype ,  fqty,               fbillno,   fitemid,   fdate)
select            t1.fbatchno,t1.fstockid,134,       1,      0,          0,          0,           t2.实盘数-t1.fqty,'',        t4.fitemid,'2013-03-31'
from sheet1$ t2
inner join t_icitem t4 on t4.fnumber=t2.代码
inner join poinventory t1 on t4.fitemid=t1.fitemid
where t4.fnumber like '6.%' and t1.fstockid=18073 and t1.fbatchno='999' and t2.实盘数<>t1.fqty --and t4.fshortnumber='600351'
union all 
select            '999',18073,134,       1,      0,          0,          0,           t2.实盘数,'',        t4.fitemid,'2013-03-31'
from sheet1$ t2
inner join t_icitem t4 on t4.fnumber=t2.代码
left join poinventory t1 on t4.fitemid=t1.fitemid
where t4.fnumber like '6.%' and t1.fitemid is null and t2.实盘数>0 --and t4.fshortnumber='600351' 
union all 
select            t1.fbatchno,t1.fstockid,134,       1,      0,          0,          0,           0-t1.fqty,'',        t4.fitemid,'2013-03-31'
from poinventory t1
inner join t_icitem t4 on t4.fitemid=t1.fitemid
left join sheet1$ t2 on t4.fnumber=t2.代码
where t4.fnumber like '6.%' and t1.fstockid=18073 and t1.fbatchno='999' and t2.代码 is null and t1.fqty<>0 --and t4.fshortnumber='600351'
union all 
select            t1.fbatchno,t1.fstockid,134,       1,      0,          0,          0,           0-t1.fqty,'',        t4.fitemid,'2013-03-31'
from sheet1$ t2
inner join t_icitem t4 on t4.fnumber=t2.代码
inner join poinventory t1 on t4.fitemid=t1.fitemid
where t4.fnumber like '6.%' and t1.fstockid=18073 and t1.fbatchno<>'999' and t1.fqty<0
--and isnull(t4.F_116,0)>0
union all 
select            t1.fbatchno,t1.fstockid,134,       1,      0,          0,          0,           0-t1.fqty,'',        t4.fitemid,'2013-03-31'
from sheet1$ t2
inner join t_icitem t4 on t4.fnumber=t2.代码
inner join poinventory t1 on t4.fitemid=t1.fitemid
where t4.fnumber like '6.%' and t1.fstockid<>18073 and t1.fqty<0--and t1.fbatchno='999'
--and isnull(t4.F_116,0)>0

set @s=''

--if @fchecktype=0 --反审核--------------------------------- 
--begin
--	if exists( select 1
--	from zpstockbillentry t2 
--	inner join zpstockbill t3 on t2.finterid=t3.finterid
--	inner join #data t1 on t1.ftrantype=t2.fsourcetrantype and t1.finterid=t2.fsourceinterid and t1.fentryid=t2.fsourceentryid
--	where t3.ftrantype in (26,6) and t3.fstatus>0)
--	begin
--		select @s=@s+','+m1.finfo from
--		(
--			select distinct ('[虚仓单]'+t3.fbillno+',') finfo
--			from zpstockbillentry t2 
--			inner join zpstockbill t3 on t2.finterid=t3.finterid
--			inner join #data t1 on t1.ftrantype=t2.fsourcetrantype and t1.finterid=t2.fsourceinterid and t1.fentryid=t2.fsourceentryid
--			where t3.ftrantype in (26,6) and t3.fstatus>0
--		) m1
--
--		set @s='有以下关联单据已经审核['+@s+']!'
--
--		RAISERROR(@s,18,18)
--	end
--
--	delete t3
--	from zpstockbillentry t2 
--	inner join zpstockbill t3 on t2.finterid=t3.finterid
--	inner join #data t1 on t1.ftrantype=t2.fsourcetrantype and t1.finterid=t2.fsourceinterid and t1.fentryid=t2.fsourceentryid
--	where t3.ftrantype in (26,6) 			
--
--	return --反审核触发的时候将数据删除就OK
--end

select @UpStockWhenSave=fvalue from T_SYSTEMPROFILE where  fkey='UPSTOCKWHENSAVE'

--select * from t_stock
--16478	来料不良品仓
--16572 作业不良品仓
--16572	作业不良品仓
--18073	塑胶子件仓
--20355	子件来料不良品仓
--20652 子件作业不良品仓

select t3.fbatchno,t3.frob,0 ficmointerid,0 fcbitemid,t3.fqty fqtymust,t3.fqty, 
0 fppbominterid,0 fppbomentryid,isnull(t3.fdeptid,0) fdeptid,
t3.fstockid FSCStockID, --调出仓库 	--如果母件退回到不良品仓，则子件也相应出/入到不良品子件仓
55 FCostObjID,t4.ferpclsid,0 fplanprice,0 fplanamount,cast('' as varchar(20)) ficmobillno,t4.funitid,
t3.fstockid FDCStockID,--调入仓库
t3.fitemid,t3.finterid fsourceinterid,t3.fentryid fsourceentryid,t3.fbillno fsourcebillno,
t3.ftrantype fsourcetrantype,t17.finterid fisbackflush,--40019  是  40016  否
isnull(t13.finterid,0) fstockmanagerid,isnull((select top 1 fitemid from t_emp where fname=t13.fname),25326) ffmanagerid,t3.fdate fplanbegindate
into #SourceData
from #data t3 
inner join t_icitem t4 on t3.fitemid=t4.fitemid
left join t_SubMessage t13 on t13.finterid=t4.f_114 and t13.ftypeid=10003  --仓管员
left join t_SubMessage t17 on t17.finterid=t4.f_115 and t17.ftypeid=10002  --倒冲  
left join t_department t7 on t7.fitemid=t3.fdeptid

--where t5.fstatus in (1,2) and (t3.fauxqtymust-t3.fseltranslateauxqty)>0  --
--and t4.ferpclsid=2 
--and t17.fname='是'
--order by t4.fshortnumber


--虚仓入库--	

--仓管员
DECLARE icbom_cursor CURSOR FOR	
select top 1 t1.fstockmanagerid 
from #SourceData t1 
inner join t_icitem t2 on t1.fitemid=t2.fitemid 
where --t1.fsourcetrantype in (1,10) and 
t1.fqty>0
order by t1.fstockmanagerid

OPEN icbom_cursor

FETCH NEXT FROM icbom_cursor 
INTO @fstockmanagerid

WHILE @@FETCH_STATUS = 0
BEGIN 
	exec My_p_GetBillNo 6,'zpstockbill',@Interid output, @BillNo output
		           	
	DECLARE authors_cursor CURSOR FOR	

	select t1.fbatchno,t1.frob,t1.fsourcebillno,t1.fsourceinterid,t1.FSourceEntryID,t1.fsourcetrantype,t1.ffmanagerid,
	t1.fitemid,t1.funitid,t1.FSCStockID FDCStockID,t1.fdeptid,t1.frob*t1.fqtymust fqtymust,t1.frob*t1.fqty fqty
	from #SourceData t1
	inner join t_icitem t2 on t1.fitemid=t2.fitemid
	where t1.fstockmanagerid=@fstockmanagerid and t1.fqty>0
	order by t2.fnumber

    set @entryid=1

	OPEN authors_cursor

	FETCH NEXT FROM authors_cursor 
	INTO @fbatchno,@frob,@fsourcebillno,@fsourceinterid,@FSourceEntryID,@fsourcetrantype,@ffmanagerid,@fitemid,@funitid,@FDCStockID,@fdeptid,@fqtymust,@fqty

	WHILE @@FETCH_STATUS = 0
	BEGIN 		
		INSERT INTO ZPStockBillEntry (FDCStockID, FInterID,FEntryID,FBrNo,FItemID, FBatchNo,   FQty,     FUnitID ,Fauxqty,Fnote,FKFDate,FSourceBillNo, FSourceTranType, FSourceInterId,  FSourceEntryID ) 
		VALUES (                      @FDCStockID,@Interid,@EntryId,'0',  @fitemid,@fbatchno,  @fqty   , @FUnitID,@fqty,  '',   Null,   @FSourceBillNo,@FSourceTranType,@FSourceInterId, @FSourceEntryID) 

		set @entryid=@entryid+1
		set @fcount=@fcount+1

--		if exists(select 1 from poinventory where fstockid=18073 and fitemid=@fitemid and fbatchno='999')
--		begin
--			update t1 set fqty=t1.fqty+@fqty from poinventory t1 where t1.fstockid=18073 and t1.fitemid=@fitemid and fbatchno='999'
--		end
--		else
--		begin  
--			INSERT INTO POInventory(FBrNo,FItemID, FBatchNo,   FAuxPropID,FStockID,FStockPlaceID,FKFPeriod,FKFDate,FQty, FSecQty)
--			SELECT                  '0',  @FItemID,'999',      0,         18073,   0,            0,        '',     @FQty,0
--		end

		FETCH NEXT FROM authors_cursor 
		INTO @fbatchno,@frob,@fsourcebillno,@fsourceinterid,@FSourceEntryID,@fsourcetrantype,@ffmanagerid,@fitemid,@funitid,@FDCStockID,@fdeptid,@fqtymust,@fqty
	END

	CLOSE authors_cursor
	DEALLOCATE authors_cursor

	INSERT INTO ZpStockBill(FHeadSelfZOU34,FInterID,FBillNo,FBrNo,FTranType,FCancellation,FStatus,FUpStockWhenSave,FROB,    Fdate, FDeptID, FCheckDate,FSManagerID, FFManagerID,  FBillerID,   FSelTranType,FCheckerID) 
	VALUES (		        @fidentify,    @InterId,@BillNo,'0',  6,        0,            0,      @UpStockWhenSave,@frob,   @fdate,@fdeptid,null,      0 ,          @ffmanagerid, @fuserid,    0,           0)
	 
	update t1 set fstatus=1,FCheckDate=@fdate,FCheckerID=@fuserid from ZpStockBill t1 where finterid=@InterId

	--exec My_p_UpdateBillRelateData @InterId --更新关联数
	--exec My_p_UpdateBillRelateData_24_26 24,@InterId --更新计划投料单数量
	
	INSERT INTO t_Log (FDate,FUserID,FFunctionID,FStatement,FDescription,FMachineName,FIPAddress) VALUES (getdate(),@UserId,'K010001',3,'编号为'+@BillNo+'的单据保存成功','KSW118','192.168.0.159')

	FETCH NEXT FROM icbom_cursor 
    INTO @fstockmanagerid
END

CLOSE icbom_cursor
DEALLOCATE icbom_cursor

--虚仓出库--	

--仓管员
DECLARE icbom_cursor CURSOR FOR	
select distinct t1.fstockmanagerid 
from #SourceData t1 
inner join t_icitem t2 on t1.fitemid=t2.fitemid 
where --t1.fsourcetrantype in (24,29) and --and t2.fnumber like '7.%'  --客供
t1.fqty<0
order by t1.fstockmanagerid

OPEN icbom_cursor

FETCH NEXT FROM icbom_cursor 
INTO @fstockmanagerid

WHILE @@FETCH_STATUS = 0
BEGIN 
	exec My_p_GetBillNo 26,'zpstockbill',@Interid output, @BillNo output
		           	
	DECLARE authors_cursor CURSOR FOR	

	select t1.fbatchno,t1.frob,t1.fsourcebillno,t1.fsourceinterid,t1.FSourceEntryID,t1.fsourcetrantype,t1.ffmanagerid,
	t1.fitemid,t1.funitid,t1.FSCStockID FDCStockID,t1.fdeptid,t1.frob*t1.fqtymust fqtymust,-1*t1.frob*t1.fqty fqty
	from #SourceData t1
	inner join t_icitem t2 on t1.fitemid=t2.fitemid
	where t1.fstockmanagerid=@fstockmanagerid and t1.fqty<0
	order by t2.fnumber

    set @entryid=1

	OPEN authors_cursor

	FETCH NEXT FROM authors_cursor 
	INTO @fbatchno,@frob,@fsourcebillno,@fsourceinterid,@FSourceEntryID,@fsourcetrantype,@ffmanagerid,@fitemid,@funitid,@FDCStockID,@fdeptid,@fqtymust,@fqty

	WHILE @@FETCH_STATUS = 0
	BEGIN 		
		INSERT INTO ZPStockBillEntry (FDCStockID, FInterID,FEntryID,FBrNo,FItemID, FBatchNo,   FQty,     FUnitID ,Fauxqty,Fnote,FKFDate,FSourceBillNo, FSourceTranType, FSourceInterId,  FSourceEntryID ) 
		VALUES (                      @FDCStockID,@Interid,@EntryId,'0',  @fitemid,@fbatchno,  @fqty   , @FUnitID,@fqty,  '',   Null,   @FSourceBillNo,@FSourceTranType,@FSourceInterId, @FSourceEntryID) 

		set @entryid=@entryid+1
		set @fcount=@fcount+1

--		if exists(select 1 from poinventory where fstockid=18073 and fitemid=@fitemid and fbatchno='999')
--		begin
--			update t1 set fqty=t1.fqty-@fqty from poinventory t1 where t1.fstockid=18073 and t1.fitemid=@fitemid and fbatchno='999'
--		end
--		else
--		begin  
--			INSERT INTO POInventory(FBrNo,FItemID, FBatchNo,   FAuxPropID,FStockID,FStockPlaceID,FKFPeriod,FKFDate,FQty,  FSecQty)
--			SELECT                  '0',  @FItemID,'999',      0,         18073,   0,            0,        '',     -@FQty,0
--		end

		FETCH NEXT FROM authors_cursor 
		INTO @fbatchno,@frob,@fsourcebillno,@fsourceinterid,@FSourceEntryID,@fsourcetrantype,@ffmanagerid,@fitemid,@funitid,@FDCStockID,@fdeptid,@fqtymust,@fqty
	END

	CLOSE authors_cursor
	DEALLOCATE authors_cursor

	INSERT INTO ZpStockBill(FHeadSelfZOU34,FInterID,FBillNo,FBrNo,FTranType,FCancellation,FStatus,FUpStockWhenSave,FROB,    Fdate, FDeptID, FCheckDate,FSManagerID, FFManagerID,  FBillerID,   FSelTranType,FCheckerID) 
	VALUES (		        @fidentify,    @InterId,@BillNo,'0',  26,       0,            0,      @UpStockWhenSave,@frob,   @fdate,@fdeptid,null,      0 ,          @ffmanagerid, @fuserid,    0,           0)
	 
	update t1 set fstatus=1,FCheckDate=@fdate,FCheckerID=@fuserid from ZpStockBill t1 where finterid=@InterId
 
	--exec My_p_UpdateBillRelateData @InterId --更新关联数
	--exec My_p_UpdateBillRelateData_24_26 24,@InterId --更新计划投料单数量
	
	INSERT INTO t_Log (FDate,FUserID,FFunctionID,FStatement,FDescription,FMachineName,FIPAddress) VALUES (getdate(),@UserId,'K010001',3,'编号为'+@BillNo+'的单据保存成功','KSW118','192.168.0.159')

	FETCH NEXT FROM icbom_cursor 
    INTO @fstockmanagerid
END

CLOSE icbom_cursor
DEALLOCATE icbom_cursor

--select * from #SourceData

drop table #SourceData
drop table #Data

set nocount off

go




--*****
--批量生成虚仓入库单/虚仓出库单----塑胶子件

--My_P_GenerateZPOutStock26_6 16394,4810,1,0
IF EXISTS (select * from sysobjects where name='My_P_GenerateZPOutStock26_6' and xtype='p')  drop  procedure My_P_GenerateZPOutStock26_6

go

create procedure  [dbo].My_P_GenerateZPOutStock26_6(@fuserid int,@fsourceinterid int,@fchecktype int,@Interid int output)  --

as
set nocount on

declare @ficmointerid int,@fcostobjid int,@FDIOFInFanager int,@FDIOFOutSanager int
declare @fcheck_fail int,@fppbominterid int,@FDIOFInSanager int,@FDIOFOutFanager int
declare @fsrccommitfield_prevalue decimal(28,13),@fininterid int,@frob int,@fidentify int
declare @fsrccommitfield_endvalue decimal(28,13),@UpStockWhenSave int,@fspid int,@fempid int,@fdeptid int,@fppbomentryid int
declare @foutinterid int,@fpqty decimal(24,4),@xx_FItemIDOld int,@fxxitemid int,@CostObjGroupID int
declare @fplanamount decimal (24,2),@fstockid int,@fcbitemid int,@fisbackflush int,@fidentify24 int
declare @fsourceEntryid int,@fsourceBillNo varchar (100),@FCustBillNo varchar(30)
declare @ficmobillno varchar(20),@UserId int,@fqtymust decimal(24,4),@s varchar(5000),@fstockmanagerid int

declare @fplanprice decimal(18,4),@fitemid int,@funitid int,@entryid int,@fqty decimal(24,4)
declare @BillNo varchar (20),@StockId int,@StockNumber varchar (20)
DECLARE @TmpID INT ,@fperqty decimal(24,4),@fsourceqty decimal(24,4),@iLength int,@iFind bit,@finqty decimal(24,4)
declare @fprojectval  varchar(200),@FDateFormat  varchar(200),@fcount int,@fplanbegindate datetime
declare @FDCStockID int,@FSCStockID int,@FDCSPID int,@fscspid int,@FVersion int
declare @famount decimal (18,2),@fpitemid int,@fdate datetime,@fserial int,@FStockManagerName varchar(30)
declare @foutbillinterid int,@foutbillentryid int,@FSrcMpsPlanOrderInterid int,@fmpsqty decimal(24,4),@fsourceplanbegindate datetime
declare @findex int,@fsrcplanorderinterid int,@flag int,@FVarSrcPlanOrderInterid int
declare @iCurrentRecord int,@k int,@fxishu int,@forderinterid int,@forderentryid int
declare @forderqty decimal(24,4),@foutqty decimal(24,4),@iMaxRecord int,@fsourcetrantype int,@ffmanagerid int

select @fdate=replace(convert(varchar(10),getdate(),111),'/','-'),@fcount=1
--select fnumber,fname,* from t_emp where fname like '莫%'

create table #data(fdeptid int,frob int,finterid int,fentryid int,FTranType int,
fqty decimal(24,4),fbillno varchar(30),fitemid int,fdate datetime,fstockid int)

--其它出库单/销售出库/盘盈入库/盘亏毁损/其它入库/外购入库 fdcstockid  领料单 fscstockid   40	盘盈入库  43	盘亏毁损
insert into #data(fstockid,                                                  fdeptid,   frob ,  finterid ,  fentryid ,  ftrantype ,  fqty,                                                                              fbillno,   fitemid,   fdate)
select (case when t1.ftrantype=24 then t2.fscstockid else t2.fdcstockid end),t1.fdeptid,t1.frob,t1.finterid,t2.fentryid,t1.FTranType,t2.fqty*(case when isnull(t4.F_116,0)=0 then 1 else t4.F_116 end)/*单位用量*/ fqty,t1.fbillno,t4.fitemid,t1.fdate
from icstockbill t1
inner join icstockbillentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid  --套件
inner join t_icitem t4 on Charindex(t3.fshortnumber,t4.fnumber)>0  --t3.fshortnumber=substring(t4.fnumber,6,6) --子件
where t1.finterid=@fsourceinterid and t3.fnumber like '1.02.%' and t4.fnumber like '6.%'
--and isnull(t4.F_116,0)>0

set @s=''

if @fchecktype=0 --反审核--------------------------------- 
begin
	if exists( select 1
	from zpstockbillentry t2 
	inner join zpstockbill t3 on t2.finterid=t3.finterid
	inner join #data t1 on t1.ftrantype=t2.fsourcetrantype and t1.finterid=t2.fsourceinterid and t1.fentryid=t2.fsourceentryid
	where t3.ftrantype in (26,6) and t3.fstatus>0)
	begin
		select @s=@s+','+m1.finfo from
		(
			select distinct ('[虚仓单]'+t3.fbillno+',') finfo
			from zpstockbillentry t2 
			inner join zpstockbill t3 on t2.finterid=t3.finterid
			inner join #data t1 on t1.ftrantype=t2.fsourcetrantype and t1.finterid=t2.fsourceinterid and t1.fentryid=t2.fsourceentryid
			where t3.ftrantype in (26,6) and t3.fstatus>0
		) m1

		set @s='有以下关联单据已经审核['+@s+']!'

		RAISERROR(@s,18,18)
	end

	delete t3
	from zpstockbillentry t2 
	inner join zpstockbill t3 on t2.finterid=t3.finterid
	inner join #data t1 on t1.ftrantype=t2.fsourcetrantype and t1.finterid=t2.fsourceinterid and t1.fentryid=t2.fsourceentryid
	where t3.ftrantype in (26,6) 			

	return --反审核触发的时候将数据删除就OK
end

select @UpStockWhenSave=fvalue from T_SYSTEMPROFILE where  fkey='UPSTOCKWHENSAVE'

--select * from t_stock
--16478	来料不良品仓
--16572 作业不良品仓
--16572	作业不良品仓
--18073	塑胶子件仓
--20355	子件来料不良品仓
--20652 子件作业不良品仓

select t3.frob,0 ficmointerid,0 fcbitemid,t3.fqty fqtymust,t3.fqty, 
0 fppbominterid,0 fppbomentryid,isnull(t3.fdeptid,0) fdeptid,
(case when t3.fstockid=16478 then 20355 when t3.fstockid=16572 then 20652 else 18073 end) FSCStockID, --调出仓库 	--如果母件退回到不良品仓，则子件也相应出/入到不良品子件仓
55 FCostObjID,t4.ferpclsid,0 fplanprice,0 fplanamount,cast('' as varchar(20)) ficmobillno,t4.funitid,
(case when t3.fstockid=16478 then 20355 when t3.fstockid=16572 then 20652 else 18073 end) FDCStockID,--调入仓库
t3.fitemid,t3.finterid fsourceinterid,t3.fentryid fsourceentryid,t3.fbillno fsourcebillno,
t3.ftrantype fsourcetrantype,t17.finterid fisbackflush,--40019  是  40016  否
isnull(t13.finterid,0) fstockmanagerid,isnull((select top 1 fitemid from t_emp where fname=t13.fname),25326) ffmanagerid,t3.fdate fplanbegindate
into #SourceData
from #data t3 
inner join t_icitem t4 on t3.fitemid=t4.fitemid
left join t_SubMessage t13 on t13.finterid=t4.f_114 and t13.ftypeid=10003  --仓管员
left join t_SubMessage t17 on t17.finterid=t4.f_115 and t17.ftypeid=10002  --倒冲  
left join t_department t7 on t7.fitemid=t3.fdeptid
--where t5.fstatus in (1,2) and (t3.fauxqtymust-t3.fseltranslateauxqty)>0  --
--and t4.ferpclsid=2 
--and t17.fname='是'
--order by t4.fshortnumber


--虚仓入库--	

--仓管员
DECLARE icbom_cursor CURSOR FOR	
select top 1 t1.fstockmanagerid 
from #SourceData t1 
inner join t_icitem t2 on t1.fitemid=t2.fitemid 
where t1.fsourcetrantype in (1,10)
order by t1.fstockmanagerid

OPEN icbom_cursor

FETCH NEXT FROM icbom_cursor 
INTO @fstockmanagerid

WHILE @@FETCH_STATUS = 0
BEGIN 
	exec My_p_GetBillNo 6,'zpstockbill',@Interid output, @BillNo output
		           	
	DECLARE authors_cursor CURSOR FOR	

	select t1.frob,t1.fsourcebillno,t1.fsourceinterid,t1.FSourceEntryID,t1.fsourcetrantype,t1.ffmanagerid,
	t1.fitemid,t1.funitid,t1.FSCStockID FDCStockID,t1.fdeptid,t1.fqtymust,t1.fqty--不能用t1.frob*t1.fqty ，因为母件如果是红字，则数量已经是负数
	from #SourceData t1
	inner join t_icitem t2 on t1.fitemid=t2.fitemid
	where t1.fsourcetrantype in (1,10) and t1.fstockmanagerid=@fstockmanagerid  --and t2.fnumber like '7.%'  --客供 
	order by t2.fnumber

    set @entryid=1

	OPEN authors_cursor

	FETCH NEXT FROM authors_cursor 
	INTO @frob,@fsourcebillno,@fsourceinterid,@FSourceEntryID,@fsourcetrantype,@ffmanagerid,@fitemid,@funitid,@FDCStockID,@fdeptid,@fqtymust,@fqty

	WHILE @@FETCH_STATUS = 0
	BEGIN 		
		INSERT INTO ZPStockBillEntry (FDCStockID, FInterID,FEntryID,FBrNo,FItemID, FBatchNo,   FQty,     FUnitID ,Fauxqty,Fnote,FKFDate,FSourceBillNo, FSourceTranType, FSourceInterId,  FSourceEntryID ) 
		VALUES (                      @FDCStockID,@Interid,@EntryId,'0',  @fitemid,'999',      @fqty   , @FUnitID,@fqty,  '',   Null,   @FSourceBillNo,@FSourceTranType,@FSourceInterId, @FSourceEntryID) 

		set @entryid=@entryid+1
		set @fcount=@fcount+1

--		if exists(select 1 from poinventory where fstockid=18073 and fitemid=@fitemid and fbatchno='999')
--		begin
--			update t1 set fqty=t1.fqty+@fqty from poinventory t1 where t1.fstockid=18073 and t1.fitemid=@fitemid and fbatchno='999'
--		end
--		else
--		begin  
--			INSERT INTO POInventory(FBrNo,FItemID, FBatchNo,   FAuxPropID,FStockID,FStockPlaceID,FKFPeriod,FKFDate,FQty, FSecQty)
--			SELECT                  '0',  @FItemID,'999',      0,         18073,   0,            0,        '',     @FQty,0
--		end

		FETCH NEXT FROM authors_cursor 
		INTO @frob,@fsourcebillno,@fsourceinterid,@FSourceEntryID,@fsourcetrantype,@ffmanagerid,@fitemid,@funitid,@FDCStockID,@fdeptid,@fqtymust,@fqty
	END

	CLOSE authors_cursor
	DEALLOCATE authors_cursor

	INSERT INTO ZpStockBill(FHeadSelfZOU34,FInterID,FBillNo,FBrNo,FTranType,FCancellation,FStatus,FUpStockWhenSave,FROB,    Fdate, FDeptID, FCheckDate,FSManagerID, FFManagerID,  FBillerID,   FSelTranType,FCheckerID) 
	VALUES (		        @fidentify,    @InterId,@BillNo,'0',  6,        0,            0,      @UpStockWhenSave,@frob,   @fdate,@fdeptid,null,      0 ,          @ffmanagerid, @fuserid,    0,           0)
	 
	--update t1 set fstatus=1,FCheckDate=@fdate,FCheckerID=@fuserid from ZpStockBill t1 where finterid=@InterId

	--exec My_p_UpdateBillRelateData @InterId --更新关联数
	--exec My_p_UpdateBillRelateData_24_26 24,@InterId --更新计划投料单数量
	
	INSERT INTO t_Log (FDate,FUserID,FFunctionID,FStatement,FDescription,FMachineName,FIPAddress) VALUES (getdate(),@UserId,'K010001',3,'编号为'+@BillNo+'的单据保存成功','KSW118','192.168.0.159')

	FETCH NEXT FROM icbom_cursor 
    INTO @fstockmanagerid
END

CLOSE icbom_cursor
DEALLOCATE icbom_cursor

--虚仓出库--	

--仓管员
DECLARE icbom_cursor CURSOR FOR	
select distinct t1.fstockmanagerid 
from #SourceData t1 
inner join t_icitem t2 on t1.fitemid=t2.fitemid 
where t1.fsourcetrantype in (24,29) --and t2.fnumber like '7.%'  --客供
order by t1.fstockmanagerid

OPEN icbom_cursor

FETCH NEXT FROM icbom_cursor 
INTO @fstockmanagerid

WHILE @@FETCH_STATUS = 0
BEGIN 
	exec My_p_GetBillNo 26,'zpstockbill',@Interid output, @BillNo output
		           	
	DECLARE authors_cursor CURSOR FOR	

	select t1.frob,t1.fsourcebillno,t1.fsourceinterid,t1.FSourceEntryID,t1.fsourcetrantype,t1.ffmanagerid,
	t1.fitemid,t1.funitid,t1.FSCStockID FDCStockID,t1.fdeptid,t1.fqtymust,t1.fqty
	from #SourceData t1
	inner join t_icitem t2 on t1.fitemid=t2.fitemid
	where t1.fsourcetrantype in (24,29) and t1.fstockmanagerid=@fstockmanagerid  --and t2.fnumber like '7.%'  --客供 
	order by t2.fnumber

    set @entryid=1

	OPEN authors_cursor

	FETCH NEXT FROM authors_cursor 
	INTO @frob,@fsourcebillno,@fsourceinterid,@FSourceEntryID,@fsourcetrantype,@ffmanagerid,@fitemid,@funitid,@FDCStockID,@fdeptid,@fqtymust,@fqty

	WHILE @@FETCH_STATUS = 0
	BEGIN 		
		INSERT INTO ZPStockBillEntry (FDCStockID, FInterID,FEntryID,FBrNo,FItemID, FBatchNo,   FQty,     FUnitID ,Fauxqty,Fnote,FKFDate,FSourceBillNo, FSourceTranType, FSourceInterId,  FSourceEntryID ) 
		VALUES (                      @FDCStockID,@Interid,@EntryId,'0',  @fitemid,'999',      @fqty   , @FUnitID,@fqty,  '',   Null,   @FSourceBillNo,@FSourceTranType,@FSourceInterId, @FSourceEntryID) 

		set @entryid=@entryid+1
		set @fcount=@fcount+1

--		if exists(select 1 from poinventory where fstockid=18073 and fitemid=@fitemid and fbatchno='999')
--		begin
--			update t1 set fqty=t1.fqty-@fqty from poinventory t1 where t1.fstockid=18073 and t1.fitemid=@fitemid and fbatchno='999'
--		end
--		else
--		begin  
--			INSERT INTO POInventory(FBrNo,FItemID, FBatchNo,   FAuxPropID,FStockID,FStockPlaceID,FKFPeriod,FKFDate,FQty,  FSecQty)
--			SELECT                  '0',  @FItemID,'999',      0,         18073,   0,            0,        '',     -@FQty,0
--		end

		FETCH NEXT FROM authors_cursor 
		INTO @frob,@fsourcebillno,@fsourceinterid,@FSourceEntryID,@fsourcetrantype,@ffmanagerid,@fitemid,@funitid,@FDCStockID,@fdeptid,@fqtymust,@fqty
	END

	CLOSE authors_cursor
	DEALLOCATE authors_cursor

	INSERT INTO ZpStockBill(FHeadSelfZOU34,FInterID,FBillNo,FBrNo,FTranType,FCancellation,FStatus,FUpStockWhenSave,FROB,    Fdate, FDeptID, FCheckDate,FSManagerID, FFManagerID,  FBillerID,   FSelTranType,FCheckerID) 
	VALUES (		        @fidentify,    @InterId,@BillNo,'0',  26,       0,            0,      @UpStockWhenSave,@frob,   @fdate,@fdeptid,null,      0 ,          @ffmanagerid, @fuserid,    0,           0)
	 
	--update t1 set fstatus=1,FCheckDate=@fdate,FCheckerID=@fuserid from ZpStockBill t1 where finterid=@InterId

	--exec My_p_UpdateBillRelateData @InterId --更新关联数
	--exec My_p_UpdateBillRelateData_24_26 24,@InterId --更新计划投料单数量
	
	INSERT INTO t_Log (FDate,FUserID,FFunctionID,FStatement,FDescription,FMachineName,FIPAddress) VALUES (getdate(),@UserId,'K010001',3,'编号为'+@BillNo+'的单据保存成功','KSW118','192.168.0.159')

	FETCH NEXT FROM icbom_cursor 
    INTO @fstockmanagerid
END

CLOSE icbom_cursor
DEALLOCATE icbom_cursor

--select * from #SourceData

drop table #SourceData


set nocount off

go

--批量生成其它出库单--由其它出库申请单生成--*****
--My_P_GenerateOutStock29 16394,1351,1,0
IF EXISTS (select * from sysobjects where name='My_P_GenerateOutStock29' and xtype='p')  drop  procedure My_P_GenerateOutStock29

go

create procedure  [dbo].My_P_GenerateOutStock29(@fuserid int,@frequestinterid int,@fchecktype int,@fidentify int)  --  @fchecktype =0 反审核 1 审核

as
set nocount on

--declare @ficmointerid int,@finbillno varchar(30),@ftype int set @ficmointerid=293576--select * from My_t_ICMOTemp

declare @ficmointerid int,@fcostobjid int,@FDIOFInFanager int,@FDIOFOutSanager int
declare @fcheck_fail int,@fppbominterid int,@FDIOFInSanager int,@FDIOFOutFanager int
declare @fsrccommitfield_prevalue decimal(28,13),@fininterid int,@frob int
declare @fsrccommitfield_endvalue decimal(28,13),@UpStockWhenSave int,@fspid int,@fempid int,@fdeptid int,@fppbomentryid int
declare @foutinterid int,@fpqty decimal(24,4),@xx_FItemIDOld int,@fxxitemid int,@InterId int,@CostObjGroupID int
declare @fplanamount decimal (24,2),@fstockid int,@fcbitemid int,@fisbackflush int,@fidentify24 int
declare @fsourceInterid int,@fsourceEntryid int,@fsourceBillNo varchar (100),@FCustBillNo varchar(30)
declare @ficmobillno varchar(20),@UserId int,@fqtymust decimal(24,4),@s varchar(5000),@fstockmanagerid int

declare @fplanprice decimal(18,4),@fitemid int,@funitid int,@entryid int,@fqty decimal(24,4)
declare @FInterID int,@BillNo varchar (20),@StockId int,@StockNumber varchar (20)
DECLARE @TmpID INT ,@fperqty decimal(24,4),@fsourceqty decimal(24,4),@iLength int,@iFind bit,@finqty decimal(24,4)
declare @fprojectval  varchar(200),@FDateFormat  varchar(200),@fcount int,@fplanbegindate datetime
declare @FDCStockID int,@FSCStockID int,@FDCSPID int,@fscspid int,@FVersion int
declare @famount decimal (18,2),@fpitemid int,@fdate datetime,@fserial int,@FStockManagerName varchar(30)
declare @foutbillinterid int,@foutbillentryid int,@FSrcMpsPlanOrderInterid int,@fmpsqty decimal(24,4),@fsourceplanbegindate datetime
declare @findex int,@fsrcplanorderinterid int,@flag int,@FVarSrcPlanOrderInterid int
declare @iCurrentRecord int,@k int,@fxishu int,@forderinterid int,@forderentryid int
declare @forderqty decimal(24,4),@foutqty decimal(24,4),@iMaxRecord int,@fsourcetrantype int,@ffmanagerid int


select @fdate=replace(convert(varchar(10),getdate(),111),'/','-'),@fcount=1
--select fnumber,fname,* from t_emp where fname like '莫%'

create table #data(fdeptid int,frob int,finterid int,fentryid int,ftrantype int,
fqty decimal(24,4),fbillno varchar(30),fitemid int,fdate datetime)

insert into #data(fdeptid,frob ,finterid ,fentryid ,ftrantype ,fqty,fbillno,fitemid,fdate)
select t1.fdeptid,1,t1.fid,t2.fentryid,200000003,t2.fqty,t1.fbillno,t2.fitemid,t1.fdate
from t_OtherOutRequest t1
inner join t_OtherOutRequestEntry t2 on t1.fid=t2.fid
inner join t_icitem t9 on t9.fitemid=t2.fitemid
where t1.fid=@frequestinterid and isnull(t1.FChecker,0)>0 and t9.fnumber not like '1.02.%'  --非套件

insert into #data(fdeptid,frob ,finterid ,fentryid ,ftrantype ,fqty,fbillno,fitemid,fdate)
select t1.fdeptid,1,t1.fid,t2.fentryid,200000003,t2.fqty*t5.fqty,t1.fbillno,t6.fitemid,t1.fdate
from t_OtherOutRequest t1
inner join t_OtherOutRequestEntry t2 on t1.fid=t2.fid
inner join t_icitem t9 on t9.fitemid=t2.fitemid
inner join icbom t14 on t14.fitemid=t9.fitemid
inner join icbomchild t5 on t5.finterid=t14.finterid
inner join t_icitem t6 on t6.fitemid=t5.fitemid
where t1.fid=@frequestinterid and isnull(t1.FChecker,0)>0 and t9.fnumber like '1.02.%'  --套件


set @s=''

--if @fchecktype=0 --反审核--判断关联单据是否已经审核--已经放在其它出库申请表的触发器中判断----------------------------- ------------------------------- 
--begin
--	if exists( select 1
--	from icstockbillentry t2 
--	inner join icstockbill t3 on t2.finterid=t3.finterid
--	inner join #data t1 on t1.ftrantype=t2.fsourcetrantype and t1.finterid=t2.fsourceinterid and t1.fentryid=t2.fsourceentryid
--	where t3.ftrantype in (29) and t3.fstatus>0)
--	begin
--		select @s=@s+','+m1.finfo from
--		(
--			select (t3.fbillno+',') finfo
--			from icstockbillentry t2 
--			inner join icstockbill t3 on t2.finterid=t3.finterid
--			inner join #data t1 on t1.ftrantype=t2.fsourcetrantype and t1.finterid=t2.fsourceinterid and t1.fentryid=t2.fsourceentryid
--			where t3.ftrantype in (29) and t3.fstatus>0
--		) m1
--
--		set @s='有以下关联单据已经审核['+@s+']!'
--
--		RAISERROR(@s,18,18)
--	end
--	else
--	begin
--		delete t3
--		from icstockbillentry t2 
--		inner join icstockbill t3 on t2.finterid=t3.finterid
--		inner join #data t1 on t1.ftrantype=t2.fsourcetrantype and t1.finterid=t2.fsourceinterid and t1.fentryid=t2.fsourceentryid
--		where t3.ftrantype in (29) 		
--	end
--
--	return --反审核触发的时候将数据删除就OK
--end


--if @fchecktype=1 --审核--判断是否已经生成，避免重复生成------------------------------- 
--begin
--	if exists( select 1
--	from icstockbillentry t2 
--	inner join icstockbill t3 on t2.finterid=t3.finterid
--	inner join #data t1 on t1.ftrantype=t2.fsourcetrantype and t1.finterid=t2.fsourceinterid and t1.fentryid=t2.fsourceentryid
--	where t3.ftrantype in (29))
--	begin
--		select @s=@s+','+m1.finfo from
--		(
--			select distinct (t3.fbillno+',') finfo
--			from icstockbillentry t2 
--			inner join icstockbill t3 on t2.finterid=t3.finterid
--			inner join #data t1 on t1.ftrantype=t2.fsourcetrantype and t1.finterid=t2.fsourceinterid and t1.fentryid=t2.fsourceentryid
--			where t3.ftrantype in (29)
--		) m1
--
--		set @s='已经有以下关联单据['+@s+']!'
--
--		RAISERROR(@s,18,18)
--	end
--end

select @UpStockWhenSave=fvalue from T_SYSTEMPROFILE where  fkey='UPSTOCKWHENSAVE'

select t3.frob,0 ficmointerid,0 fcbitemid,t3.fqty fqtymust,t3.fqty, 
0 fppbominterid,0 fppbomentryid,t3.fdeptid,0 FSCStockID, -- 	
0 FCostObjID,t4.ferpclsid,0 fplanprice,0 fplanamount,cast('' as varchar(20)) ficmobillno,t4.funitid,
isnull(t4.fdefaultloc,0) FDCStockID,--发料仓库
t3.fitemid,t3.finterid fsourceinterid,t3.fentryid fsourceentryid,t3.fbillno fsourcebillno,
t3.ftrantype fsourcetrantype,t17.finterid fisbackflush,--40019  是  40016  否
isnull(t13.finterid,0) fstockmanagerid,isnull((select top 1 fitemid from t_emp where fname=t13.fname),25326) ffmanagerid,t3.fdate fplanbegindate
into #SourceData
from #data t3 
inner join t_icitem t4 on t3.fitemid=t4.fitemid
left join t_SubMessage t13 on t13.finterid=t4.f_114 and t13.ftypeid=10003  --仓管员
left join t_SubMessage t17 on t17.finterid=t4.f_115 and t17.ftypeid=10002  --倒冲  
inner join t_department t7 on t7.fitemid=t3.fdeptid
--where t5.fstatus in (1,2) and (t3.fauxqtymust-t3.fseltranslateauxqty)>0  --
--and t4.ferpclsid=2 
--and t17.fname='是'
--order by t4.fshortnumber

--其它出库单/销售出库 fdcstockid  领料单 fscstockid   其它入库/外购入库 fdcstockid

--其它出库--	

--仓管员
DECLARE icbom_cursor CURSOR FOR	
select distinct t1.fstockmanagerid
from #SourceData t1 
inner join t_icitem t2 on t1.fitemid=t2.fitemid --where fnumber like '01.%' and fnumber not like '01.01.%'  --屏蔽掉产成品,半成品/原材料/委外件都自动生成领料单
order by t1.fstockmanagerid

OPEN icbom_cursor

FETCH NEXT FROM icbom_cursor 
INTO @fstockmanagerid

WHILE @@FETCH_STATUS = 0
BEGIN 
	exec My_p_GetBillNo 29,'icstockbill',@Interid output, @BillNo output
		           	
	DECLARE authors_cursor CURSOR FOR	

	select t1.frob,t1.fsourcebillno,t1.fsourceinterid,t1.FSourceEntryID,t1.fsourcetrantype,t1.ffmanagerid,t1.fplanbegindate,t1.fcbitemid,t1.fitemid,t1.funitid,
	t1.FSCStockID,t1.FDCStockID,t1.fdeptid,t1.frob*t1.fqtymust fqtymust,t1.frob*t1.fqty fqty,t1.ficmointerid,t1.ficmobillno,t1.fplanprice,t1.fplanamount,t1.fcostobjid,t1.fppbominterid,t1.fppbomentryid 
	from #SourceData t1
	inner join t_icitem t2 on t1.fitemid=t2.fitemid
	where t1.fstockmanagerid=@fstockmanagerid  
	order by t2.fnumber

    set @entryid=1

	OPEN authors_cursor

	FETCH NEXT FROM authors_cursor 
	INTO @frob,@fsourcebillno,@fsourceinterid,@FSourceEntryID,@fsourcetrantype,@ffmanagerid,@fplanbegindate,@fcbitemid,@fitemid,@funitid,@FSCStockID,@FDCStockID,@fdeptid,@fqtymust,@fqty,@ficmointerid,@ficmobillno,@fplanprice,@fplanamount,@fcostobjid,@fppbominterid,@fppbomentryid

	WHILE @@FETCH_STATUS = 0
	BEGIN 		
		INSERT INTO ICStockBillEntry (FInterID,FEntryID,FBrNo,FItemID,FAuxPropID,FBatchNo,FQtyMust, FQty,     FReProduceType,FCostOBJID, FCostObjGroupID,FUnitID ,FAuxQtyMust,Fauxqty,FSecCoefficient,FSecQty,FAuxPlanPrice,FPlanAmount, Fauxprice,Famount,FBomInterID,Fnote,FKFDate,FKFPeriod,FPeriodDate,FSCStockID, FDCStockID, FDCSPID,FOperSN,FOperID,FSNListID,FSourceBillNo, FSourceTranType, FSourceInterId,  FSourceEntryID, FICMOBillNo, FICMOInterID, FPPBomEntryID, FInStockID) 
		VALUES (                      @Interid,@EntryId,'0',  @fitemid,0,        '',      @fqtymust,@fqty   , 1059,          @fcostobjid,0,              @FUnitID,@fqtymust , @fqty,  0,              0,      @fplanprice,  @fplanamount,0,        0,      0,          '',   Null,   0,        Null,       @FSCStockID,@FDCStockID,0,      0,      0,      0,        @FSourceBillNo,@FSourceTranType,@FSourceInterId, @FSourceEntryID,'',          0,            0,             0) 

		set @entryid=@entryid+1
		set @fcount=@fcount+1

		FETCH NEXT FROM authors_cursor 
		INTO @frob,@fsourcebillno,@fsourceinterid,@FSourceEntryID,@fsourcetrantype,@ffmanagerid,@fplanbegindate,@fcbitemid,@fitemid,@funitid,@FSCStockID,@FDCStockID,@fdeptid,@fqtymust,@fqty,@ficmointerid,@ficmobillno,@fplanprice,@fplanamount,@fcostobjid,@fppbominterid,@fppbomentryid
	END

	CLOSE authors_cursor
	DEALLOCATE authors_cursor

	INSERT INTO ICStockBill(FHeadSelfB0936,/*FHeadSelfB0433,FHeadSelfB0435, FHeadSelfB0437,*/ FInterID,FBillNo,FBrNo,FTranType,FCancellation,FStatus,FUpStockWhenSave,FVchInterID,FROB,    FHookStatus,Fdate, FDeptID, Fuse,FCheckDate,FFManagerID, FSManagerID,  FBillerID,   FAcctID,FMultiCheckLevel1,FMultiCheckDate1,FMultiCheckLevel2,FMultiCheckDate2,FMultiCheckLevel3,FMultiCheckDate3,FMultiCheckLevel4,FMultiCheckDate4,FMultiCheckLevel5,FMultiCheckDate5,FMultiCheckLevel6,FMultiCheckDate6,FPurposeID,FWBINTERID,FSelTranType,FBackFlushed) 
	VALUES (		        @fidentify,    /*@FCustBillNo,  @fplanbegindate,@fsourcebillno,*/ @InterId,@BillNo,'0',  29,       0,            0,      @UpStockWhenSave,0,          @frob,   0,          @fdate,@fdeptid,'',  Null,      0 ,          @ffmanagerid, @fuserid,    0,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,0,0,0,1)
	 
	--exec My_p_UpdateBillRelateData @InterId --更新关联数
	--exec My_p_UpdateBillRelateData_24_26 24,@InterId --更新计划投料单数量

	UPDATE ICStockBill SET FUUID=NEWID() WHERE FInterID=@InterId
	
	INSERT INTO t_Log (FDate,FUserID,FFunctionID,FStatement,FDescription,FMachineName,FIPAddress) VALUES (getdate(),@UserId,'K010001',3,'编号为'+@BillNo+'的单据保存成功','KSW118','192.168.0.159')

	FETCH NEXT FROM icbom_cursor 
    INTO @fstockmanagerid
END

CLOSE icbom_cursor
DEALLOCATE icbom_cursor

--select * from #SourceData

drop table #SourceData

set nocount off

go


--无单价查询--My_P_CBCostCalCheckPrice 2015,10

IF EXISTS (select * from sysobjects where name='My_P_CBCostCalCheckPrice' and xtype='p')  drop  procedure My_P_CBCostCalCheckPrice
go

create procedure [dbo].My_P_CBCostCalCheckPrice (@fyear int,@fperiod int)  

as
set nocount on

select t4.fitemid,(case when t5.fcyid=1000 then t5.fprice*t1.fexchangerate else t5.fprice end) fprice
into #temp --
from (select fitemid,max(fentryid) fentryid from (select t1.fitemid,t1.fentryid from t_supplyentry t1 inner join (select fitemid,max(FQuoteTime) FQuoteTime from t_SupplyEntry group by fitemid) t2 on t1.fitemid=t2.fitemid and t1.FQuoteTime=t2.FQuoteTime) t1 group by fitemid) t4 
inner join t_supplyentry t5 on t4.fitemid=t5.fitemid and t4.fentryid=t5.fentryid
inner join t_currency t1 on t1.fcurrencyid=t5.fcyid

insert into #temp(fitemid,fprice)
select            fitemid,fprice
from
(
	select t1.fitemid,max(t1.fprice) fprice
	from icstockbillentry t1
	inner join 
	(
		select t2.fitemid,max(t1.finterid) finterid
		from icstockbill t1
		inner join icstockbillentry t2 on t1.finterid=t2.finterid
		inner join t_icitem t3 on t2.fitemid=t3.fitemid 
		where t1.ftrantype in (1,2,10,29) and t2.fprice>0 and left(t3.fnumber,1) not in (select fitemtype from v_myitemtype where ftype=0)
		and t3.fnumber not like '6.%'
		group by t2.fitemid
	) t2 on t1.finterid=t2.finterid
	group by t1.fitemid
) t1 where t1.fitemid not in (select fitemid from #temp)

--自制
select distinct t11.fitemid,t11.fnumber,t11.fname into #data  -- drop table #data drop table #data2 drop table #temp
from icstockbillentry t2  
inner join icstockbill t3 on t2.finterid=t3.finterid  
inner join t_icitem t11 on t11.fitemid=t2.fitemid   
where year(t3.fdate)=@fyear and month(t3.fdate)=@fperiod and t11.ferpclsid=2

--无单价的外购件
select distinct t2.fnumber 编码,t2.fname 名称,isnull(t2.fmodel,'') 规格型号
--select distinct t3.fnumber,t3.fname,t3.fmodel  --涉及到的成品
--insert into #NotComplete select distinct 1,t2.fitemid
--insert into #NotComplete select distinct 2,t3.fitemid
--select distinct t3.fnumber,t3.fname,t3.fmodel,t2.fnumber,t2.fname,isnull(t2.fmodel,'')
from
(
-- 	select t3.fitemid
-- 	--select distinct t3.fnumber
-- 	from #data2 t1
-- 	left join t_supplyentry t2 on t1.fitemid=t2.fitemid
-- 	inner join t_icitem t3 on t3.fitemid=t1.fitemid
-- 	where t2.fitemid is null
-- 	union all
	select t3.fitemid fchilditemid,t1.fitemid
	--select distinct t6.fnumber
	from #data t1
	inner join icbom t2 on t1.fitemid=t2.fitemid --and t2.fstatus>0
	inner join icbomchild t3 on t2.finterid=t3.finterid
	left join #temp t5 on t5.fitemid=t3.fitemid
	inner join t_icitem t6 on t6.fitemid=t3.fitemid
	inner join t_icitem t7 on t7.fitemid=t1.fitemid  --父项
	where t6.ferpclsid in (1,5)
	and isnull(t5.fprice,0)=0 
	union all
	select t6.fitemid fchilditemid,t1.fitemid
	--select distinct t6.fnumber
	from t_icitem t1
	inner join icbom t2 on t1.fitemid=t2.fitemid --and t2.fstatus>0
	inner join icbomchild t3 on t2.finterid=t3.finterid
	left join #temp t5 on t5.fitemid=t3.fitemid
	inner join t_icitem t6 on t6.fitemid=t3.fitemid
	where left(t6.fnumber,1) not in ('3','4','5') 
	and t1.fitemid in (select fitemid from #data) and t6.ferpclsid in (1,5) and t5.fitemid is null
	union all
	select t8.fitemid fchilditemid,t1.fitemid
	--select distinct t8.fnumber
	from t_icitem t1
	inner join icbom t2 on t1.fitemid=t2.fitemid --and t2.fstatus>0 --成品
	inner join icbomchild t3 on t2.finterid=t3.finterid  --半成品
	inner join icbom t11 on t11.fitemid=t3.fitemid  --半成品
	inner join icbomchild t12 on t11.finterid=t12.finterid  --半成品子项
	left join #temp t5 on t5.fitemid=t12.fitemid
	inner join t_icitem t6 on t6.fitemid=t3.fitemid --半成品
	inner join t_icitem t7 on t7.fitemid=t2.fitemid --成品
	inner join t_icitem t8 on t8.fitemid=t12.fitemid --半成品子项
	where left(t6.fnumber,1) in ('3','4') 
	and t1.fitemid in (select fitemid from #data) and t8.ferpclsid in (1,5) and t5.fitemid is null
	union all
	select t8.fitemid fchilditemid,t1.fitemid
	--select distinct t8.fnumber
	from t_icitem t1
	inner join icbom t2 on t1.fitemid=t2.fitemid --and t2.fstatus>0 --成品
	inner join icbomchild t3 on t2.finterid=t3.finterid  --半成品
	inner join icbom t11 on t11.fitemid=t3.fitemid  --半成品
	inner join icbomchild t12 on t11.finterid=t12.finterid  --半成品子项
	left join #temp t5 on t5.fitemid=t12.fitemid
	inner join t_icitem t6 on t6.fitemid=t3.fitemid --半成品
	inner join t_icitem t7 on t7.fitemid=t2.fitemid --成品
	inner join t_icitem t8 on t8.fitemid=t12.fitemid --半成品子项
	where left(t6.fnumber,1) in ('5') and t8.fname not like '回收件%' --and t1.ferpclsid=2
	and t1.fitemid in (select fitemid from #data) and t8.ferpclsid in (1,5) and t5.fitemid is null
	union all
	select t8.fitemid fchilditemid,t1.fitemid
	--select distinct t8.fnumber
	from t_icitem t1
	inner join icbom t2 on t1.fitemid=t2.fitemid --and t2.fstatus>0 --成品
	inner join icbomchild t3 on t2.finterid=t3.finterid  --半成品
	inner join icbom t11 on t11.fitemid=t3.fitemid  --半成品
	inner join (
	-- 			select distinct t1.fitemid,(select top 1 fitemid from t_icitem where fparentid=t1.fparentid and fname like '%拆盒%' ) fchiheitemid
	-- 			from t_icitem t1
	-- 			inner join icbomchild t2 on t1.fitemid=t2.fitemid
	-- 			where t1.fnumber like '5.%' and t1.fname not like '%拆盒%'
		select distinct t1.fitemid,
		(
			select top 1 m4.fitemid 
			from t_icitem m1 
			inner join icbomchild m2 on m1.fitemid=m2.fitemid
			inner join icbom m3 on m2.finterid=m3.finterid
			inner join t_icitem m4 on m3.fitemid=m4.fitemid
			where m4.fnumber like '5.%' and m4.fname like '%拆盒%' and m1.fitemid=t5.fitemid 
		) fchiheitemid
		from t_icitem t1
		inner join icbomchild t2 on t1.fitemid=t2.fitemid
		inner join icbom t3 on t1.fitemid=t3.fitemid
		inner join icbomchild t4 on t4.finterid=t3.finterid
		inner join t_icitem t5 on t5.fitemid=t4.fitemid
		where t1.fnumber like '5.%' and t1.fname not like '%拆盒%' and t5.fnumber like '1.02.%'
	) t12 on t11.fitemid=t12.fitemid --半成品同级回收壳
	inner join t_icitem t6 on t6.fitemid=t3.fitemid --半成品
	inner join t_icitem t7 on t7.fitemid=t2.fitemid --成品
	inner join t_icitem t8 on t8.fitemid=t12.fchiheitemid --半成品同级回收壳
	left join #temp t5 on t5.fitemid=t8.fitemid
	where left(t6.fnumber,1) in ('5') --and t1.ferpclsid=2
	and t1.fitemid in (select fitemid from #data) and t8.ferpclsid in (1,5) and t5.fitemid is null
) t1 inner join t_icitem t2 on t1.fchilditemid=t2.fitemid
inner join t_icitem t3 on t1.fitemid=t3.fitemid
where t2.fnumber not like '2.05%' and t2.fnumber not like '2.06%' and t2.fnumber not like '2.07%'
and t2.fname not like '%客户%彩盒%' and t2.fdefaultloc<>16483  --
order by t2.fnumber


drop table #data drop table #temp

set nocount off

go

--其它出库申请单审核触发器--

IF EXISTS (select * from sysobjects where name='My_Tri_OtherOutRequest'  and xtype='TR')  drop  TRIGGER My_Tri_OtherOutRequest
go

create trigger [dbo].My_Tri_OtherOutRequest 
            ON [dbo].t_OtherOutRequest
for update
AS
BEGIN
	set nocount on
	DECLARE	@FID  int,
			@FTranType int,
			@fstatus INT,@FChecker int
	declare @s varchar(200),@fbillno varchar(30),@FMyInterID int ,@frob int,@fidentify int

	SELECT @FID=FID,@FChecker=isnull(FChecker,0),@s='' FROM INSERTED

--	if update(FChecker) and @FChecker=0 --审核放在前台
--	begin
--		RAISERROR('不允许反审核!',18,18)
--		set @fidentify=0
--		--select @fidentify=isnull(max(fid),0)+1 from my_t_identify
--		--insert into my_t_identify(fid,fuserid,fdate,FTrantypeID) values(@fidentify,@FChecker,getdate(),200000008)
--		exec My_P_GenerateOutStock29 @FChecker,@FID,@FChecker,@fidentify 
--	end

	if update(FChecker) and @FChecker=0  --反审核--------------------------------- 
	begin
		if exists( select 1
		from icstockbillentry t2 
		inner join icstockbill t3 on t2.finterid=t3.finterid
		inner join t_OtherOutRequestEntry t1 on 200000003=t2.fsourcetrantype and t1.fid=t2.fsourceinterid and t1.fentryid=t2.fsourceentryid
		where t1.fid=@FID and t3.ftrantype in (29))
		begin
			select @s=@s+','+m1.finfo from
			(
				select (t3.fbillno+',') finfo
				from icstockbillentry t2 
				inner join icstockbill t3 on t2.finterid=t3.finterid
				inner join t_OtherOutRequestEntry t1 on 200000003=t2.fsourcetrantype and t1.fid=t2.fsourceinterid and t1.fentryid=t2.fsourceentryid
				where t1.fid=@FID and t3.ftrantype in (29)
			) m1

			set @s='已经有以下关联单据['+@s+']!'

			RAISERROR(@s,18,18)
		end
	end
END

go

--*****
--批量生成倒冲物料调拨单/非倒冲物料领料单/倒冲物料领料单/虚仓出库单--由生产领料/退料申请单生成
--My_P_GenerateOutStock41_24_26 16394,10997,1,11  --select * from t_BOSBackOrOutStock where fbillno like '%9997'
IF EXISTS (select * from sysobjects where name='My_P_GenerateOutStock41_24_26' and xtype='p')  drop  procedure My_P_GenerateOutStock41_24_26

go

create procedure  [dbo].My_P_GenerateOutStock41_24_26(@fuserid int,@frequestinterid int,@fchecktype int,@fidentify int)  --@fchecktype =0 反审核 1 审核

as
set nocount on

--declare @fuserid int,@frequestinterid int,@ftype int,@fchecktype int,@fidentify int  select @fuserid=16394,@frequestinterid=1558,@ftype=0,@fchecktype=1,@fidentify=-1 --select * from My_t_ICMOTemp

declare @ficmointerid int,@fcostobjid int,@FDIOFInFanager int,@FDIOFOutSanager int
declare @fcheck_fail int,@fppbominterid int,@FDIOFInSanager int,@FDIOFOutFanager int
declare @fsrccommitfield_prevalue decimal(28,13),@fininterid int,@frob int
declare @fsrccommitfield_endvalue decimal(28,13),@UpStockWhenSave int,@fspid int,@fempid int,@fdeptid int,@fppbomentryid int
declare @foutinterid int,@fpqty decimal(24,4),@xx_FItemIDOld int,@fxxitemid int,@InterId int,@CostObjGroupID int
declare @fplanamount decimal (24,2),@fstockid int,@fcbitemid int,@fisbackflush int,@fidentify24 int
declare @fsourceInterid int,@fsourceEntryid int,@fsourceBillNo varchar (100),@FCustBillNo varchar(30)
declare @ficmobillno varchar(20),@UserId int,@fqtymust decimal(24,4),@s varchar(5000),@fstockmanagerid int
declare @FSourcePOBillNo varchar(20),@FSourceSeBillNo varchar(20),@forderbillno varchar(20)
declare @fplanprice decimal(18,4),@fitemid int,@funitid int,@entryid int,@fqty decimal(24,4)
declare @FInterID int,@BillNo varchar (20),@StockId int,@StockNumber varchar (20),@fdefaultloc int
DECLARE @TmpID INT ,@fperqty decimal(24,4),@fsourceqty decimal(24,4),@iLength int,@iFind bit,@finqty decimal(24,4)
declare @fprojectval  varchar(200),@FDateFormat  varchar(200),@fcount int,@fplanbegindate datetime
declare @FDCStockID int,@FSCStockID int,@FDCSPID int,@fscspid int,@FVersion int
declare @famount decimal (18,2),@fpitemid int,@fdate datetime,@fserial int,@FStockManagerName varchar(30)
declare @foutbillinterid int,@foutbillentryid int,@FSrcMpsPlanOrderInterid int,@fmpsqty decimal(24,4),@fsourceplanbegindate datetime
declare @findex int,@fsrcplanorderinterid int,@flag int,@FVarSrcPlanOrderInterid int
declare @iCurrentRecord int,@k int,@fxishu int,@forderinterid int,@forderentryid int
declare @forderqty decimal(24,4),@foutqty decimal(24,4),@iMaxRecord int,@fsourcetrantype int,@ffmanagerid int


select @fdate=replace(convert(varchar(10),getdate(),111),'/','-'),@fcount=1
--select fnumber,fname,* from t_emp where fname like '莫%'

create table #data(fdeptid int,frob int,finterid int,fentryid int,ftrantype int,
fqty decimal(24,4),fbillno varchar(30),fitemid int,fdate datetime,ficmointerid int default 0,
fppbominterid int default 0,fppbomentryid int default 0,forderinterid int default 0)

insert into #data(fppbominterid,           fppbomentryid,        ficmointerid,            forderinterid,   fdeptid,   frob ,finterid ,fentryid ,  ftrantype ,fqty,      fbillno,   fitemid,   fdate)
select            isnull(t3.finterid,0),   isnull(t3.fentryid,0),t4.finterid ficmointerid,t4.forderinterid,t1.fdeptid,1,    t1.fid,   t2.fentryid,200000014, t2.foutqty,t1.fbillno,t2.fitemid,t1.fdate
from t_BOSBackOrOutStock t1
inner join t_BOSBackOrOutStockEntry t2 on t1.fid=t2.fid
left join ppbomentry t3 on t3.finterid=t2.fid_src and t3.fentryid=t2.fentryid_src
left join icmo t4 on t3.ficmointerid=t4.finterid
inner join t_icitem t9 on t9.fitemid=t2.fitemid
where t1.fid=@frequestinterid and t2.foutqty>0 and isnull(t1.FChecker,0)>0
and t9.fnumber not like '1.02.%'  --非套件

insert into #data(fppbominterid,           fppbomentryid,        ficmointerid,            forderinterid,   fdeptid,   frob ,finterid ,fentryid ,  ftrantype ,fqty,              fbillno,   fitemid,   fdate)
select            isnull(t3.finterid,0),   isnull(t3.fentryid,0),t4.finterid ficmointerid,t4.forderinterid,t1.fdeptid,1,    t1.fid,   t2.fentryid,200000014, t2.foutqty*t5.fqty,t1.fbillno,t6.fitemid,t1.fdate
from t_BOSBackOrOutStock t1
inner join t_BOSBackOrOutStockEntry t2 on t1.fid=t2.fid
left join ppbomentry t3 on t3.finterid=t2.fid_src and t3.fentryid=t2.fentryid_src
left join icmo t4 on t3.ficmointerid=t4.finterid
inner join t_icitem t9 on t9.fitemid=t2.fitemid
inner join icbom t14 on t14.fitemid=t9.fitemid
inner join icbomchild t5 on t5.finterid=t14.finterid
inner join t_icitem t6 on t6.fitemid=t5.fitemid
where t1.fid=@frequestinterid and t2.foutqty>0 and isnull(t1.FChecker,0)>0
and t9.fnumber like '1.02.%'  --套件

insert into #data(fppbominterid,           fppbomentryid,        ficmointerid,            forderinterid,   fdeptid,   frob ,finterid ,fentryid ,  ftrantype ,fqty,      fbillno,   fitemid,   fdate)
select            isnull(t3.finterid,0),   isnull(t3.fentryid,0),t4.finterid ficmointerid,t4.forderinterid,t1.fdeptid,-1,   t1.fid,   t2.fentryid,200000014,t2.fbackqty,t1.fbillno,t2.fitemid,t1.fdate
from t_BOSBackOrOutStock t1
inner join t_BOSBackOrOutStockEntry t2 on t1.fid=t2.fid
left join ppbomentry t3 on t3.finterid=t2.fid_src and t3.fentryid=t2.fentryid_src
left join icmo t4 on t3.ficmointerid=t4.finterid
inner join t_icitem t9 on t9.fitemid=t2.fitemid
where t1.fid=@frequestinterid and t2.fbackqty>0 and isnull(t1.FChecker,0)>0
and t9.fnumber not like '1.02.%'  --非套件

insert into #data(fppbominterid,           fppbomentryid,        ficmointerid,            forderinterid,   fdeptid,   frob ,finterid ,fentryid ,  ftrantype ,fqty,              fbillno,   fitemid,   fdate)
select            isnull(t3.finterid,0),   isnull(t3.fentryid,0),t4.finterid ficmointerid,t4.forderinterid,t1.fdeptid,-1,   t1.fid,   t2.fentryid,200000014,t2.fbackqty*t5.fqty,t1.fbillno,t6.fitemid,t1.fdate
from t_BOSBackOrOutStock t1
inner join t_BOSBackOrOutStockEntry t2 on t1.fid=t2.fid
left join ppbomentry t3 on t3.finterid=t2.fid_src and t3.fentryid=t2.fentryid_src
left join icmo t4 on t3.ficmointerid=t4.finterid
inner join t_icitem t9 on t9.fitemid=t2.fitemid
inner join icbom t14 on t14.fitemid=t9.fitemid
inner join icbomchild t5 on t5.finterid=t14.finterid
inner join t_icitem t6 on t6.fitemid=t5.fitemid
where t1.fid=@frequestinterid and t2.fbackqty>0 and isnull(t1.FChecker,0)>0
and t9.fnumber like '1.02.%'  --套件

set @s=''

--if @fchecktype=1 --审核--判断是否已经生成，避免重复生成------------------------------- 
--begin
--	if exists( select 1
--	from icstockbillentry t2 
--	inner join icstockbill t3 on t2.finterid=t3.finterid
--	inner join #data t1 on t1.ftrantype=t2.fsourcetrantype and t1.finterid=t2.fsourceinterid and t1.fentryid=t2.fsourceentryid
--	where t3.ftrantype in (24,41))
--	begin
--		select @s=@s+','+m1.finfo from
--		(
--			select distinct ((case when t3.ftrantype=24 then '[领料单]' else '[调拨单]' end)+t3.fbillno+',') finfo
--			from icstockbillentry t2 
--			inner join icstockbill t3 on t2.finterid=t3.finterid
--			inner join #data t1 on t1.ftrantype=t2.fsourcetrantype and t1.finterid=t2.fsourceinterid and t1.fentryid=t2.fsourceentryid
--			where t3.ftrantype in (24,41) 
--		) m1
--
--		set @s='已经有以下关联单据['+@s+']!'
--
--		RAISERROR(@s,18,18)
--	end
--
--	if exists( select 1
--	from zpstockbillentry t2 
--	inner join zpstockbill t3 on t2.finterid=t3.finterid
--	inner join #data t1 on t1.ftrantype=t2.fsourcetrantype and t1.finterid=t2.fsourceinterid and t1.fentryid=t2.fsourceentryid
--	where t3.ftrantype in (26))
--	begin
--		select @s=@s+','+m1.finfo from
--		(
--			select distinct ('[虚仓出库单]'+t3.fbillno+',') finfo
--			from zpstockbillentry t2 
--			inner join zpstockbill t3 on t2.finterid=t3.finterid
--			inner join #data t1 on t1.ftrantype=t2.fsourcetrantype and t1.finterid=t2.fsourceinterid and t1.fentryid=t2.fsourceentryid
--			where t3.ftrantype in (26)
--		) m1
--
--		set @s='已经有以下关联单据['+@s+']!'
--
--		RAISERROR(@s,18,18)
--	end
--end

--if @fchecktype=0 --反审核--判断关联单据是否已经审核--已经放在补料退料表的触发器中判断----------------------------- 
--begin
--	if exists( select 1
--	from icstockbillentry t2 
--	inner join icstockbill t3 on t2.finterid=t3.finterid
--	inner join #data t1 on t1.ftrantype=t2.fsourcetrantype and t1.finterid=t2.fsourceinterid and t1.fentryid=t2.fsourceentryid
--	where t3.ftrantype in (24,41) and t3.fstatus>0)
--	begin
--		select @s=@s+','+m1.finfo from
--		(
--			select distinct ((case when t3.ftrantype=24 then '[领料单]' else '[调拨单]' end)+t3.fbillno+',') finfo
--			from icstockbillentry t2 
--			inner join icstockbill t3 on t2.finterid=t3.finterid
--			inner join #data t1 on t1.ftrantype=t2.fsourcetrantype and t1.finterid=t2.fsourceinterid and t1.fentryid=t2.fsourceentryid
--			where t3.ftrantype in (24,41) and t3.fstatus>0
--		) m1
--
--		set @s='有以下关联单据已经审核['+@s+']!'
--
--		RAISERROR(@s,18,18)
--	end
--
--	if exists( select 1
--	from zpstockbillentry t2 
--	inner join zpstockbill t3 on t2.finterid=t3.finterid
--	inner join #data t1 on t1.ftrantype=t2.fsourcetrantype and t1.finterid=t2.fsourceinterid and t1.fentryid=t2.fsourceentryid
--	where t3.ftrantype in (26) and t3.fstatus>0)
--	begin
--		select @s=@s+','+m1.finfo from
--		(
--			select distinct ('[虚仓出库单]'+t3.fbillno+',') finfo
--			from zpstockbillentry t2 
--			inner join zpstockbill t3 on t2.finterid=t3.finterid
--			inner join #data t1 on t1.ftrantype=t2.fsourcetrantype and t1.finterid=t2.fsourceinterid and t1.fentryid=t2.fsourceentryid
--			where t3.ftrantype in (26) and t3.fstatus>0
--		) m1
--
--		set @s='有以下关联单据已经审核['+@s+']!'
--
--		RAISERROR(@s,18,18)
--	end
--
--	delete t3
--	from zpstockbillentry t2 
--	inner join zpstockbill t3 on t2.finterid=t3.finterid
--	inner join #data t1 on t1.ftrantype=t2.fsourcetrantype and t1.finterid=t2.fsourceinterid and t1.fentryid=t2.fsourceentryid
--	where t3.ftrantype in (26) 	
--
--	delete t3
--	from icstockbillentry t2 
--	inner join icstockbill t3 on t2.finterid=t3.finterid
--	inner join #data t1 on t1.ftrantype=t2.fsourcetrantype and t1.finterid=t2.fsourceinterid and t1.fentryid=t2.fsourceentryid
--	where t3.ftrantype in (24,41) 		
--
--	return --反审核触发的时候将数据删除就OK
--end

select @UpStockWhenSave=fvalue from T_SYSTEMPROFILE where  fkey='UPSTOCKWHENSAVE'

select isnull(t2.fheadselfs0143,'') FSourcePoBillNo,isnull(t2.fheadselfs0144,'') FSourceSeBillNo,
isnull(t2.fbillno,'') forderbillno,isnull(t4.fdefaultloc,0) fdefaultloc,t3.frob,isnull(t3.ficmointerid,0) ficmointerid,
isnull(t1.fitemid,0) fcbitemid,t3.fqty fqtymust,t3.fqty, 
isnull(t3.fppbominterid,0) fppbominterid,isnull(t3.fppbomentryid,0) fppbomentryid,t3.fdeptid,isnull(t4.fdefaultloc,0) FSCStockID, --调出仓库 	
isnull(t1.FCostObjID,55) FCostObjID,t4.ferpclsid,0 fplanprice,0 fplanamount,isnull(t1.fbillno,'') ficmobillno,t4.funitid,
case when t7.fitemid in (175,171817) then 16479	--装配车间仓
	 when t7.fitemid=176 then 16480 else 16480 --包装车间仓
end FDCStockID,--调入仓库
t3.fitemid,isnull(t3.finterid,0) fsourceinterid,isnull(t3.fentryid,0) fsourceentryid,isnull(t3.fbillno,'') fsourcebillno,
isnull(t3.ftrantype,0) fsourcetrantype,isnull(t17.finterid,40020) fisbackflush,--40019  是  40020  否  select * from t_submestype select * from t_submessage where ftypeid=10002
isnull(t13.finterid,0) fstockmanagerid,isnull((select top 1 fitemid from t_emp where fname=t13.fname),25326) ffmanagerid,t3.fdate fplanbegindate
into #SourceData
from #data t3 
inner join t_icitem t4 on t3.fitemid=t4.fitemid
left join t_SubMessage t13 on t13.finterid=t4.f_114 and t13.ftypeid=10003  --仓管员
left join t_SubMessage t17 on t17.finterid=t4.F_115 and t17.ftypeid=10002  --倒冲  
inner join t_department t7 on t7.fitemid=t3.fdeptid
left join icmo t1 on t1.finterid=t3.ficmointerid
left join seorder t2 on t2.finterid=t3.forderinterid


--where t5.fstatus in (1,2) and (t3.fauxqtymust-t3.fseltranslateauxqty)>0  --
--and t4.ferpclsid=2 
--and t17.fname='是'
--order by t4.fshortnumber

--倒冲调拨单
DECLARE icbom_cursor CURSOR FOR	
select distinct t1.frob,t1.fstockmanagerid,t1.fisbackflush,t1.fdefaultloc
from #SourceData t1 
inner join t_icitem t2 on t1.fitemid=t2.fitemid --
inner join t_stock t3 on t3.fitemid=t1.FDCStockID
where t1.fisbackflush=40019--只处理倒冲的
and t3.ftypeid<>503 --代管仓
order by t1.frob,t1.fstockmanagerid,t1.fisbackflush

OPEN icbom_cursor

FETCH NEXT FROM icbom_cursor 
INTO @frob,@fstockmanagerid,@fisbackflush,@fdefaultloc

WHILE @@FETCH_STATUS = 0
BEGIN 
	exec My_p_GetBillNo 41,'icstockbill',@Interid output, @BillNo output

    --if @fcount=1 set @fbegbillno=@BillNo
		           	
	DECLARE authors_cursor CURSOR FOR	

	select isnull(t1.fsourcebillno,'') fsourcebillno,isnull(t1.fsourceinterid,0) fsourceinterid,
	isnull(t1.FSourceEntryID,0) FSourceEntryID,isnull(t1.fsourcetrantype,0) fsourcetrantype,t1.ffmanagerid,t1.fplanbegindate,t1.fcbitemid,t1.fitemid,t1.funitid,
	(case when t1.frob=1 then t1.FSCStockID else t1.FDCStockID end) FSCStockID,(case when t1.frob=1 then t1.FDCStockID else t1.FSCStockID end) FDCStockID,--如果是领料申请单，则从原材料仓调拨到车间仓，如果是退料申请单，则从车间仓调拨到原材料仓
	t1.fdeptid,t1.fqtymust,t1.fqty,t1.ficmointerid,t1.ficmobillno,t1.fplanprice,t1.fplanamount,t1.fcostobjid,t1.fppbominterid,t1.fppbomentryid 
	from #SourceData t1
	inner join t_icitem t2 on t1.fitemid=t2.fitemid
	inner join t_stock t3 on t3.fitemid=t1.FDCStockID
	where t1.fstockmanagerid=@fstockmanagerid and t1.fisbackflush=@fisbackflush and t1.frob=@frob
	and t1.fdefaultloc=@fdefaultloc and t3.ftypeid<>503 --代管仓
	order by t2.fnumber

    set @entryid=1

	OPEN authors_cursor

	FETCH NEXT FROM authors_cursor 
	INTO @fsourcebillno,@fsourceinterid,@FSourceEntryID,@fsourcetrantype,@ffmanagerid,@fplanbegindate,@fcbitemid,@fitemid,@funitid,@FSCStockID,@FDCStockID,@fdeptid,@fqtymust,@fqty,@ficmointerid,@ficmobillno,@fplanprice,@fplanamount,@fcostobjid,@fppbominterid,@fppbomentryid

	WHILE @@FETCH_STATUS = 0
	BEGIN 		
		INSERT INTO ICStockBillEntry (FInterID,FEntryID,FBrNo,FItemID,FAuxPropID,FBatchNo,FQtyMust, FQty,     FReProduceType,FCostOBJID, FCostObjGroupID,FUnitID ,FAuxQtyMust,Fauxqty,FSecCoefficient,FSecQty,FAuxPlanPrice,FPlanAmount, Fauxprice,Famount,FBomInterID,Fnote,FKFDate,FKFPeriod,FPeriodDate,FSCStockID, FDCStockID, FOperSN,FOperID,FSNListID,FSourceBillNo,  FSourceTranType, FSourceInterId, FSourceEntryID,  FICMOBillNo, FICMOInterID, FPPBomEntryID, FInStockID) 
		VALUES (                      @Interid,@EntryId,'0',  @fitemid,0,        '',      @fqtymust,@fqty   , 1059,          @fcostobjid,0,              @FUnitID,@fqtymust , @fqty,  0,              0,      @fplanprice,  @fplanamount,0,        0,      0,          '',   Null,   0,        Null,       @FSCStockID,@FDCStockID,0,      0,      0,        @FSourceBillNo, @FSourceTranType,@FSourceInterId,@FSourceEntryID, @ficmobillno,@ficmointerid,@fppbomentryid,0) 

		set @entryid=@entryid+1
		set @fcount=@fcount+1

		FETCH NEXT FROM authors_cursor 
		INTO @fsourcebillno,@fsourceinterid,@FSourceEntryID,@fsourcetrantype,@ffmanagerid,@fplanbegindate,@fcbitemid,@fitemid,@funitid,@FSCStockID,@FDCStockID,@fdeptid,@fqtymust,@fqty,@ficmointerid,@ficmobillno,@fplanprice,@fplanamount,@fcostobjid,@fppbominterid,@fppbomentryid
	END

	CLOSE authors_cursor
	DEALLOCATE authors_cursor

	INSERT INTO ICStockBill(fheadselfd0132,FInterID,FBillNo,FBrNo,FTranType,FCancellation,FStatus,FUpStockWhenSave,FVchInterID,FROB,    FHookStatus,Fdate, FDeptID, Fuse,FCheckDate,FSManagerID, FFManagerID,  FBillerID,   FAcctID,FMultiCheckLevel1,FMultiCheckDate1,FMultiCheckLevel2,FMultiCheckDate2,FMultiCheckLevel3,FMultiCheckDate3,FMultiCheckLevel4,FMultiCheckDate4,FMultiCheckLevel5,FMultiCheckDate5,FMultiCheckLevel6,FMultiCheckDate6,freftype,FWBINTERID,FSelTranType,FBackFlushed) 
	VALUES (		        @fidentify,    @InterId,@BillNo,'0',  41,       0,            0,      @UpStockWhenSave,0,          1,       0,          @fdate,@fdeptid,'',  Null,      @ffmanagerid,0,            @fuserid,    0,      Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,12561,0,@fsourcetrantype,1)
	 
	--exec My_p_UpdateBillRelateData @InterId --更新关联数
	--exec My_p_UpdateBillRelateData_24_26 24,@InterId --更新计划投料单数量

	UPDATE ICStockBill SET FUUID=NEWID() WHERE FInterID=@InterId
	
	INSERT INTO t_Log (FDate,FUserID,FFunctionID,FStatement,FDescription,FMachineName,FIPAddress) VALUES (getdate(),@UserId,'K010001',3,'编号为'+@BillNo+'的单据保存成功','KSW118','192.168.0.159')

	FETCH NEXT FROM icbom_cursor 
    INTO @frob,@fstockmanagerid ,@fisbackflush,@fdefaultloc
END

CLOSE icbom_cursor
DEALLOCATE icbom_cursor

declare @FPurposeID int

--领料--	

--是否倒冲+仓管员
DECLARE icbom_cursor CURSOR FOR	
select distinct t1.frob,t1.fstockmanagerid,t1.fisbackflush,
(case when t1.fisbackflush=40019 then Null --如果是倒冲物料，则不填标识码
	  when t1.fisbackflush=40020 then @fidentify --如果是非倒冲物料，则填标识码
end) fidentify41,
(case when t1.fisbackflush=40019 then 12000 --如果是倒冲物料，40107	生产补料/退料(倒冲)
	  when t1.fisbackflush=40020 then 12000 --如果是非倒冲物料，40106	生产补料/退料(常规)
end) FPurposeID,t1.fdefaultloc
from #SourceData t1 
inner join t_icitem t2 on t1.fitemid=t2.fitemid 
inner join t_stock t3 on t3.fitemid=t1.FSCStockID
where t3.ftypeid<>503 --代管仓
order by t1.frob,t1.fstockmanagerid,t1.fisbackflush

OPEN icbom_cursor

FETCH NEXT FROM icbom_cursor 
INTO @frob,@fstockmanagerid,@fisbackflush,@fidentify24,@FPurposeID,@fdefaultloc

WHILE @@FETCH_STATUS = 0
BEGIN 
	exec My_p_GetBillNo 24,'icstockbill',@Interid output, @BillNo output
		           	
	DECLARE authors_cursor CURSOR FOR	

	select t1.forderbillno,t1.FSourcePOBillNo,t1.FSourceSeBillNo,t1.frob,isnull(t1.fsourcebillno,'') fsourcebillno,
	isnull(t1.fsourceinterid,0) fsourceinterid,isnull(t1.FSourceEntryID,0) FSourceEntryID,
	isnull(t1.fsourcetrantype,0) fsourcetrantype,t1.ffmanagerid,t1.fplanbegindate,
	t1.fcbitemid,t1.fitemid,t1.funitid,
	(case when @fisbackflush=40019 then t1.FDCStockID --如果是倒冲物料，则退回车间仓或是从车间仓领出
		  when @fisbackflush=40020 then t1.FSCStockID --如果是非倒冲物料，则退回原材料仓或是从原材料仓领出
	end) FSCStockID,t1.FDCStockID,
	t1.fdeptid,t1.frob*t1.fqtymust fqtymust,t1.frob*t1.fqty fqty,isnull(t1.ficmointerid,0) ficmointerid,
	isnull(t1.ficmobillno,'') ficmobillno,t1.fplanprice,t1.fplanamount,t1.fcostobjid,
	isnull(t1.fppbominterid,0) fppbominterid,isnull(t1.fppbomentryid,0) fppbomentryid
	from #SourceData t1
	inner join t_icitem t2 on t1.fitemid=t2.fitemid
	inner join t_stock t3 on t3.fitemid=t1.FSCStockID
	where t1.fstockmanagerid=@fstockmanagerid and t1.fisbackflush=@fisbackflush and t3.ftypeid<>503 --代管仓
	and (t1.frob=1 or (t1.frob=-1 and t1.fisbackflush=40020 /*倒冲退料不先退回车间仓，因为此时成品一定还没有入库，也就没有对应倒冲领料单*/))
	and t1.frob=@frob and t1.fdefaultloc=@fdefaultloc
	order by t2.fnumber

    set @entryid=1

	OPEN authors_cursor

	FETCH NEXT FROM authors_cursor 
	INTO @forderbillno,@FSourcePOBillNo,@FSourceSeBillNo,@frob,@fsourcebillno,@fsourceinterid,@FSourceEntryID,@fsourcetrantype,@ffmanagerid,@fplanbegindate,@fcbitemid,@fitemid,@funitid,@FSCStockID,@FDCStockID,@fdeptid,@fqtymust,@fqty,@ficmointerid,@ficmobillno,@fplanprice,@fplanamount,@fcostobjid,@fppbominterid,@fppbomentryid

	WHILE @@FETCH_STATUS = 0
	BEGIN 
		if @fisbackflush=40020 or (@fisbackflush=40019 and not exists(select 1 from icbomchild where fitemid=@fitemid))--如果是倒冲物料,且又不在BOM里面的才生成倒冲领料单
		begin	
			INSERT INTO ICStockBillEntry (FInterID,FEntryID,FBrNo,FItemID,FAuxPropID,FBatchNo,FQtyMust, FQty,     FReProduceType,FCostOBJID, FCostObjGroupID,FUnitID ,FAuxQtyMust,Fauxqty,FSecCoefficient,FSecQty,FAuxPlanPrice,FPlanAmount, Fauxprice,Famount,FBomInterID,Fnote,FKFDate,FKFPeriod,FPeriodDate,FSCStockID, FDCSPID,FOperSN,FOperID,FSNListID,FSourceBillNo, FSourceTranType, FSourceInterId,  FSourceEntryID, FICMOBillNo, FICMOInterID, FPPBomEntryID, FInStockID) 
			VALUES (                      @Interid,@EntryId,'0',  @fitemid,0,        '',      @fqtymust,@fqty   , 1059,          @fcostobjid,0,              @FUnitID,@fqtymust , @fqty,  0,              0,      @fplanprice,  @fplanamount,0,        0,      0,          '',   Null,   0,        Null,       @FSCStockID,0,      0,      0,      0,        @FSourceBillNo,@FSourceTranType,@FSourceInterId, @FSourceEntryID,@ficmobillno,@ficmointerid,@fppbomentryid,0) 

			set @entryid=@entryid+1
			set @fcount=@fcount+1
		end 

		FETCH NEXT FROM authors_cursor 
		INTO @forderbillno,@FSourcePOBillNo,@FSourceSeBillNo,@frob,@fsourcebillno,@fsourceinterid,@FSourceEntryID,@fsourcetrantype,@ffmanagerid,@fplanbegindate,@fcbitemid,@fitemid,@funitid,@FSCStockID,@FDCStockID,@fdeptid,@fqtymust,@fqty,@ficmointerid,@ficmobillno,@fplanprice,@fplanamount,@fcostobjid,@fppbominterid,@fppbomentryid
	END

	CLOSE authors_cursor
	DEALLOCATE authors_cursor

	INSERT INTO ICStockBill(FHeadSelfB0445,FHeadSelfB0442,FHeadSelfB0436,FHeadSelfB0433,FHeadSelfB0441,   FHeadSelfB0437, FInterID,FBillNo,FBrNo,FTranType,FCancellation,FStatus,FUpStockWhenSave,FVchInterID,FROB,    FHookStatus,Fdate, FDeptID, Fuse,FCheckDate,FSManagerID, FFManagerID,  FBillerID,   FAcctID,FMultiCheckLevel1,FMultiCheckDate1,FMultiCheckLevel2,FMultiCheckDate2,FMultiCheckLevel3,FMultiCheckDate3,FMultiCheckLevel4,FMultiCheckDate4,FMultiCheckLevel5,FMultiCheckDate5,FMultiCheckLevel6,FMultiCheckDate6,FPurposeID,FWBINTERID,FSelTranType,FBackFlushed) 
	VALUES (		        @fdate,        20978,         @forderbillno, @fidentify24,  @FSourceSeBillNo, @ficmobillno,   @InterId,@BillNo,'0',  24,       0,            0,      @UpStockWhenSave,0,          @frob,   0,          @fdate,@fdeptid,'',  Null,      0 ,          @ffmanagerid, @fuserid,    0,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,@FPurposeID,0,85,1)
	 
	--exec My_p_UpdateBillRelateData @InterId --更新关联数  已经在触发器My_Tri_ICStockBill_In中直接写明
	--exec My_p_UpdateBillRelateData_24_26 24,@InterId --更新计划投料单数量

	UPDATE ICStockBill SET FUUID=NEWID() WHERE FInterID=@InterId
	
	INSERT INTO t_Log (FDate,FUserID,FFunctionID,FStatement,FDescription,FMachineName,FIPAddress) VALUES (getdate(),@UserId,'K010001',3,'编号为'+@BillNo+'的单据保存成功','KSW118','192.168.0.159')

	FETCH NEXT FROM icbom_cursor 
    INTO @frob,@fstockmanagerid,@fisbackflush,@fidentify24,@FPurposeID,@fdefaultloc
END

CLOSE icbom_cursor
DEALLOCATE icbom_cursor

--虚仓出库--	

--仓管员
DECLARE icbom_cursor CURSOR FOR	
select distinct t1.frob,t1.fstockmanagerid 
from #SourceData t1 
inner join t_icitem t2 on t1.fitemid=t2.fitemid 
inner join t_stock t3 on t3.fitemid=t1.FSCStockID
where t3.ftypeid=503 --代管仓
order by t1.frob,t1.fstockmanagerid

OPEN icbom_cursor

FETCH NEXT FROM icbom_cursor 
INTO @frob,@fstockmanagerid

WHILE @@FETCH_STATUS = 0
BEGIN 
	exec My_p_GetBillNo 26,'zpstockbill',@Interid output, @BillNo output
		           	
	DECLARE authors_cursor CURSOR FOR	

	select isnull(t1.forderbillno,'') forderbillno,t1.FSourcePOBillNo,
	t1.FSourceSeBillNo,t1.frob,isnull(t1.fsourcebillno,'') fsourcebillno,
	isnull(t1.fsourceinterid,0) fsourceinterid,isnull(t1.FSourceEntryID,0) FSourceEntryID,
	isnull(t1.fsourcetrantype,0) fsourcetrantype,t1.ffmanagerid,
	t1.fitemid,t1.funitid,t1.FSCStockID FDCStockID,t1.fdeptid,t1.frob*t1.fqtymust fqtymust,
	t1.frob*t1.fqty fqty,isnull(t1.ficmointerid,0) ficmointerid,isnull(t1.ficmobillno,'') ficmobillno,
	isnull(t1.fppbominterid,0) fppbominterid,isnull(t1.fppbomentryid,0) fppbomentryid
	from #SourceData t1
	inner join t_icitem t2 on t1.fitemid=t2.fitemid
	inner join t_stock t3 on t3.fitemid=t1.FSCStockID
	where t1.fstockmanagerid=@fstockmanagerid  and t3.ftypeid=503 --代管仓 
	and t1.frob=@frob
	order by t2.fnumber

    set @entryid=1

	OPEN authors_cursor

	FETCH NEXT FROM authors_cursor 
	INTO @forderbillno,@FSourcePOBillNo,@FSourceSeBillNo,@frob,@fsourcebillno,@fsourceinterid,@FSourceEntryID,@fsourcetrantype,@ffmanagerid,@fitemid,@funitid,@FDCStockID,@fdeptid,@fqtymust,@fqty,@ficmointerid,@ficmobillno,@fppbominterid,@fppbomentryid

	WHILE @@FETCH_STATUS = 0
	BEGIN 		
		INSERT INTO ZPStockBillEntry (FDCStockID, FInterID,FEntryID,FBrNo,FItemID, FBatchNo,FQty,     FUnitID ,Fauxqty,Fnote,FKFDate,FSourceBillNo, FSourceTranType, FSourceInterId,  FSourceEntryID, FEntrySelfZOU30,FEntrySelfZOU32, FEntrySelfZOU31 ) 
		VALUES (                      @FDCStockID,@Interid,@EntryId,'0',  @fitemid,'',      @fqty   , @FUnitID,@fqty,  '',   Null,   @FSourceBillNo,@FSourceTranType,@FSourceInterId, @FSourceEntryID,@ficmointerid,  @ficmobillno,    @fppbomentryid) 

		set @entryid=@entryid+1
		set @fcount=@fcount+1

		FETCH NEXT FROM authors_cursor 
		INTO @forderbillno,@FSourcePOBillNo,@FSourceSeBillNo,@frob,@fsourcebillno,@fsourceinterid,@FSourceEntryID,@fsourcetrantype,@ffmanagerid,@fitemid,@funitid,@FDCStockID,@fdeptid,@fqtymust,@fqty,@ficmointerid,@ficmobillno,@fppbominterid,@fppbomentryid
	END

	CLOSE authors_cursor
	DEALLOCATE authors_cursor

	INSERT INTO ZpStockBill(FHeadSelfZOU35,FHeadSelfZOU36,  FHeadSelfZOU39,FHeadSelfZOU34,FInterID,FBillNo,FBrNo,FTranType,FCancellation,FStatus,FUpStockWhenSave,FROB,    Fdate, FDeptID, FCheckDate,FSManagerID, FFManagerID,  FBillerID,   FSelTranType) 
	VALUES (		        @forderbillno, @FSourceSeBillNo,40062,         @fidentify,    @InterId,@BillNo,'0',  26,       0,            0,      @UpStockWhenSave,@frob,   @fdate,@fdeptid,Null,      0 ,          @ffmanagerid, @fuserid,    0)
	 
	--exec My_p_UpdateBillRelateData @InterId --更新关联数  --已经在触发器My_Tri_ZPStockBill中直接写明
	--exec My_p_UpdateBillRelateData_24_26 24,@InterId --更新计划投料单数量
	
	INSERT INTO t_Log (FDate,FUserID,FFunctionID,FStatement,FDescription,FMachineName,FIPAddress) VALUES (getdate(),@UserId,'K010001',3,'编号为'+@BillNo+'的单据保存成功','KSW118','192.168.0.159')

	FETCH NEXT FROM icbom_cursor 
    INTO @frob,@fstockmanagerid
END

CLOSE icbom_cursor
DEALLOCATE icbom_cursor

--select * from #SourceData

drop table #SourceData

set nocount off

go

--*****--
IF not EXISTS (select * from sysobjects where name='My_t_ICStockBillTemp' and xtype='u')  --drop  Table My_t_ICStockBillTemp
begin
	create table My_t_ICStockBillTemp(findex int,fuserid int,finterid int,fitemid int,
	fentryid int,FQty decimal(24,4),fbatchno varchar(50),FSourceInterId int, FSourceEntryID int,fstockid int) 
end

go



--批量填充批号--
--My_P_GenerateOutStock24 16394,'','',0
IF EXISTS (select * from sysobjects where name='My_P_FillBatchNoOutStock24' and xtype='p')  drop  procedure My_P_FillBatchNoOutStock24

go

create procedure  [dbo].My_P_FillBatchNoOutStock24(@fuserid int,@finterid int)  --前台单据肯定没保存，因为进行批次管理的物料都要输入批号--不一定，用开发的功能就已经先保存

as
set nocount on

--declare @fuserid int,@finterid int  select @fuserid=16394,@finterid=66986

declare @fsourceinterid int,@fsourceentryid int,@fitemid int,@fbatchno varchar(100),@fstockid int,@fqty decimal(28,4)
declare @ftempstockid int,@ftempbatchno varchar(100),@ftempqty decimal(28,4),@findex int

create table #data(findex int default -1,FQty decimal(24,4),fbatchno varchar(50),
FSourceInterId int,FSourceEntryID int,fstockid int,fitemid int,ftype int) 

--未审核的领料单
insert into #data(ftype,fitemid,fbatchno,fstockid,fqty)
select 0,t2.fitemid,t2.fbatchno,t3.fitemid fstockid,sum(t2.fqty) fqty  
from icstockbill t1  
inner join icstockbillentry t2 on t1.finterid=t2.finterid  
inner join t_stock t3 on t2.fscstockid=t3.fitemid
inner join t_icitem t4 on t4.fitemid=t2.fitemid  
where t1.finterid<>@finterid and t2.fitemid in (select fitemid from My_t_ICStockBillTemp where fuserid=@fuserid) 
and t1.ftrantype=24 and (isnull(t1.FMultiCheckLevel1,0)<=0 or t1.fstatus=0) and t4.FBatchManager=1  
group by t2.fitemid,t2.fbatchno,t3.fitemid
 

--该单已选的--虽然没有保存,也要计入
insert into #data(ftype,findex,fitemid,fbatchno,fstockid,fqty)
select 1,t1.findex,t1.fitemid,t1.fbatchno,t1.fstockid,t1.fqty  
from My_t_ICStockBillTemp t1 
inner join t_icitem t4 on t4.fitemid=t1.fitemid  
where fuserid=@fuserid and isnull(t1.fbatchno,'')<>'' and t4.FBatchManager=1   
order by t1.findex

DECLARE icbom_cursor CURSOR FOR	
select t1.findex,t1.fitemid,t1.fbatchno,t1.fstockid,t1.fqty  
from My_t_ICStockBillTemp t1 
inner join t_icitem t4 on t4.fitemid=t1.fitemid 
where t1.fuserid=@fuserid and isnull(t1.fbatchno,'')='' --有输入过批号的就不再计算了
and t4.FBatchManager=1    
order by t1.findex

OPEN icbom_cursor

FETCH NEXT FROM icbom_cursor 
INTO @findex,@fitemid,@fbatchno,@fstockid,@fqty  

WHILE @@FETCH_STATUS = 0
BEGIN 
	--set @IFNoCount=0 

	WHILE @fqty > 0 --and @IFNoCount=0
	BEGIN 
		select @ftempstockid=0,@ftempbatchno='',@ftempqty=0

		select top 1 @ftempbatchno=t1.fbatchno,@ftempstockid=t1.fstockid,@ftempqty=t1.fqty
		from icinventory t1  
		inner join t_stock t2 on t1.fstockid=t2.fitemid  
		inner join t_icitem t4 on t1.fitemid=t4.fitemid  
		Left Join  
		(  
			select t1.fitemid,t1.fbatchno,t1.fstockid,sum(t1.fqty) fqty  --已分配
			from #data t1 
			where t1.fitemid=@fitemid
			group by t1.fitemid,t1.fbatchno,t1.fstockid  
		) t3 on t3.fitemid=t1.fitemid and t1.fstockid=t3.fstockid and t1.fbatchno=t3.fbatchno 
		where t1.fitemid=@fitemid and t1.fqty>isnull(t3.fqty,0) --大于已分配数量的库存
		and t2.fname not like '%不良%' and t2.fname not like '%报废%'
		order by (case when charindex('车间',t2.fname)>0 then 1 else 2 end),t1.fbatchno --车间仓优选选择
	
		if @ftempqty=0
		begin
			insert into #data(ftype,findex,fitemid,fbatchno,fstockid,fqty) --无库存可发
			select 2,@findex,@fitemid,'',0,0 

			set @fqty=0  --@IFNoCount=1
		end
		else
		begin
			if @ftempqty>@fqty
			begin
				set @ftempqty=@fqty
				set @fqty=0
			end
			else
			begin
				set @fqty=@fqty-@ftempqty
			end

			insert into #data(ftype,findex,fitemid,fbatchno,fstockid,fqty)
			select 2,@findex,@fitemid,@ftempbatchno,@ftempstockid,@ftempqty  
		end
	END

	FETCH NEXT FROM icbom_cursor 
	INTO @findex,@fitemid,@fbatchno,@fstockid,@fqty  
END

CLOSE icbom_cursor
DEALLOCATE icbom_cursor

delete from My_t_ICStockBillTemp where fuserid=@fuserid

--#data.ftype 0 非此单据数据  1、此单据数据  2、自动分配后的数据

insert into My_t_ICStockBillTemp(fuserid,fitemid,fstockid,fqty,fbatchno,findex)
select @fuserid,t1.fitemid,t1.fstockid,t1.fqty,t1.fbatchno,t1.findex
from #data t1 where ftype=2 order by t1.findex

drop table #data  --select * from #data  --select * from My_t_ICStockBillTemp

set nocount off

go

--补料/退料申请单审核触发器--

IF EXISTS (select * from sysobjects where name='My_Tri_BOSBackOrOutStock'  and xtype='TR')  drop  TRIGGER My_Tri_BOSBackOrOutStock
go

create trigger [dbo].My_Tri_BOSBackOrOutStock 
            ON [dbo].t_BOSBackOrOutStock
for update
AS
BEGIN
	set nocount on
	DECLARE	@FID  int,
			@FTranType int,
			@fstatus INT,@FChecker int
	declare @s varchar(200),@fbillno varchar(30),@FMyInterID int ,@frob int,@fidentify int

	SELECT @FID=FID,@FChecker=isnull(FChecker,0),@s='' FROM INSERTED

	if exists(select 1
				from t_BOSBackOrOutStockEntry t1 
				inner join inserted t7 on t1.fid=t7.fid
				inner join t_icitem t2 on t1.fitemid=t2.fitemid 
				left join icbom t11 on t11.fitemid=t1.fitemid and t11.fusestatus=1072
				where t2.fnumber like '1.02.%' and t11.fitemid is null)
	begin
		select @s=@s+','+m1.fnumber from
		(
			select distinct t2.fnumber
			from t_BOSBackOrOutStockEntry t1 
			inner join inserted t7 on t1.fid=t7.fid
			inner join t_icitem t2 on t1.fitemid=t2.fitemid 
			left join icbom t11 on t11.fitemid=t1.fitemid and t11.fusestatus=1072
			where t2.fnumber like '1.02.%' and t11.fitemid is null
		) m1

		set @s='以下物料无BOM或者BOM未使用['+@s+']'
		RAISERROR(@s,18,18)
	end

--	if update(FChecker) and @FChecker=0 --审核放在前台
--	begin
--		RAISERROR('不允许反审核!',18,18)
--		set @fidentify=0
--		--select @fidentify=isnull(max(fid),0)+1 from my_t_identify
--		--insert into my_t_identify(fid,fuserid,fdate,FTrantypeID) values(@fidentify,@FChecker,getdate(),200000008)
--		exec My_P_GenerateOutStock29 @FChecker,@FID,@FChecker,@fidentify 
--	end

	if update(FChecker) and @FChecker=0  --反审核--------------------------------- 
	begin
		if exists( select 1
		from icstockbillentry t2 
		inner join icstockbill t3 on t2.finterid=t3.finterid
		inner join t_BOSBackOrOutStockEntry t1 on 200000014=t2.fsourcetrantype and t1.fid=t2.fsourceinterid and t1.fentryid=t2.fsourceentryid
		where t1.fid=@FID and t3.ftrantype in (24,41))
		begin
			select @s=@s+','+m1.finfo from
			(
				select distinct ((case when t3.ftrantype=24 then '[领料单]' else '[调拨单]' end)+t3.fbillno+',') finfo
				from icstockbillentry t2 
				inner join icstockbill t3 on t2.finterid=t3.finterid
				inner join t_BOSBackOrOutStockEntry t1 on 200000014=t2.fsourcetrantype and t1.fid=t2.fsourceinterid and t1.fentryid=t2.fsourceentryid
				where t1.fid=@FID and t3.ftrantype in (24,41)
			) m1

			set @s='已经有以下关联单据['+@s+']!'

			RAISERROR(@s,18,18)
		end

		if exists( select 1
		from zpstockbillentry t2 
		inner join zpstockbill t3 on t2.finterid=t3.finterid
		inner join t_BOSBackOrOutStockEntry t1 on 200000014=t2.fsourcetrantype and t1.fid=t2.fsourceinterid and t1.fentryid=t2.fsourceentryid
		where t1.fid=@FID and t3.ftrantype in (26))
		begin
			select @s=@s+','+m1.finfo from
			(
				select distinct ('[虚仓出库单]'+t3.fbillno+',') finfo
				from zpstockbillentry t2 
				inner join zpstockbill t3 on t2.finterid=t3.finterid
				inner join t_BOSBackOrOutStockEntry t1 on 200000014=t2.fsourcetrantype and t1.fid=t2.fsourceinterid and t1.fentryid=t2.fsourceentryid
				where t1.fid=@FID and t3.ftrantype in (26)
			) m1

			set @s='已经有以下关联单据['+@s+']!'

			RAISERROR(@s,18,18)
		end
	end
	
	set nocount off
END

go

--生产领料申请单审核触发器--

IF EXISTS (select * from sysobjects where name='My_Tri_OutStockRequest'  and xtype='TR')  drop  TRIGGER My_Tri_OutStockRequest
go

create trigger [dbo].My_Tri_OutStockRequest 
            ON [dbo].t_BOSOutRequest
for update
AS
BEGIN
	set nocount on
	DECLARE	@FID  int,
			@FTranType int,
			@fstatus INT,@FChecker int
	declare @s varchar(200),@fbillno varchar(30),@FMyInterID int ,@frob int,@fidentify int

	SELECT @FID=FID,@FChecker=isnull(FChecker,0) FROM INSERTED

--	if update(FChecker) and @FChecker=0 --审核放在前台
--	begin
--		RAISERROR('不允许反审核!',18,18)
--		set @fidentify=0
--		--select @fidentify=isnull(max(fid),0)+1 from my_t_identify
--		--insert into my_t_identify(fid,fuserid,fdate,FTrantypeID) values(@fidentify,@FChecker,getdate(),200000008)
--		exec My_P_GenerateOutStock41_24_26 @FChecker,@FID,0,@FChecker,@fidentify -- 0 领料申请 1 退料申请
--	end
END

go


--生产退料申请单审核触发器--

IF EXISTS (select * from sysobjects where name='My_Tri_BackRequest'  and xtype='TR')  drop  TRIGGER My_Tri_BackRequest
go

create trigger [dbo].My_Tri_BackRequest 
            ON [dbo].t_BOSBackRequest
for update
AS
BEGIN
	set nocount on
	DECLARE	@FID  int,
			@FTranType int,
			@fstatus INT,@FChecker int
	declare @s varchar(200),@fbillno varchar(30),@FMyInterID int ,@frob int,@fidentify int

	SELECT @FID=FID,@FChecker=isnull(FChecker,0) FROM INSERTED

--	if update(FChecker) and @FChecker=0 --审核放在前台
--	begin
--		RAISERROR('不允许反审核!',18,18)
--		set @fidentify=0
--		--select @fidentify=isnull(max(fid),0)+1 from my_t_identify
--		--insert into my_t_identify(fid,fuserid,fdate,FTrantypeID) values(@fidentify,@FChecker,getdate(),200000008)
--		exec My_P_GenerateOutStock41_24_26 @FChecker,@FID,1,@FChecker,@fidentify -- 0 领料申请 1 退料申请
--	end
END

go
--select * from t_department

--自动倒冲--My_P_DirectInAndOut 'cin012797',0  --*****
IF EXISTS (select * from sysobjects where name='My_P_DirectInAndOut' and xtype='p')  drop  procedure My_P_DirectInAndOut

go

create procedure  [dbo].My_P_DirectInAndOut(@finbillno varchar(30),@ftype int)  --1 表示审核时触发 0 表示反审核时触发

as
set nocount on

--declare @ficmointerid int,@finbillno varchar(30),@ftype int set @ficmointerid=293576

declare @ficmointerid int,@fcostobjid int,@FDIOFInFanager int,@FDIOFOutSanager int
declare @fcheck_fail int,@fppbominterid int,@FDIOFInSanager int,@FDIOFOutFanager int
declare @fsrccommitfield_prevalue decimal(28,13),@fuserid int,@fininterid int,@fisbackflush int
declare @fsrccommitfield_endvalue decimal(28,13),@UpStockWhenSave int,@fspid int,@fempid int,@fdeptid int,@fppbomentryid int
declare @foutinterid int,@fpqty int,@xx_FItemIDOld int,@fxxitemid int,@InterId int,@CostObjGroupID int
declare @fplanamount decimal (24,2),@fstockid int,@fcbitemid int,@frob int,@fstockmanagerid int
declare @fsourceInterid int,@fsourceEntryid int,@fsourceBillNo varchar (100),@FCustBillNo varchar(30)
declare @ficmobillno varchar(20),@UserId int,@fqtymust int,@s varchar(5000),@fcount int,@fplanbegindate datetime

declare @fplanprice decimal(18,4),@fitemid int,@funitid int,@entryid int,@fqty int,@fendbillno varchar(30),@fbegbillno varchar(30)
declare @FInterID int,@BillNo varchar (20),@StockId int,@StockNumber varchar (20)
DECLARE @TmpID INT ,@fperqty int,@fsourceqty int,@iLength int,@iFind bit,@finqty int
declare @fprojectval  varchar(200),@FDateFormat  varchar(200)
declare @FDCStockID int,@FSCStockID int,@FDCSPID int,@fscspid int,@FVersion int
declare @famount decimal (18,2),@fpitemid int,@fdate datetime,@fserial int
declare @foutbillinterid int,@foutbillentryid int,@FSrcMpsPlanOrderInterid int,@fmpsqty int,@fsourceplanbegindate datetime
declare @findex int,@fsrcplanorderinterid int,@flag int,@FVarSrcPlanOrderInterid int
declare @iCurrentRecord int,@k int,@fxishu int,@forderinterid int,@forderentryid int
declare @forderqty int,@foutqty int,@iMaxRecord int,@fsourcetrantype int,@ffmanagerid int

select top 1 @fininterid=finterid from icstockbill where fbillno=@finbillno

if @ftype=0 --反审核--------------------------------- 
begin
	--FHeadSelfB0436 源入库单号*/

	if exists( select 1
	from icstockbillentry t2 
	inner join icstockbill t3 on t2.finterid=t3.finterid
	where t3.ftrantype=24 and t3.fstatus>0 and t3.FHeadSelfB0434=@finbillno/*生产领料*/)  --都是倒冲
	begin
		RAISERROR('该产品入库单关联的生产领料单据已经审核，无法反审核!',18,18)
	end
	else
	begin
		select top 1 @FInterID=t3.FInterID from icstockbill t3 where t3.ftrantype=24 and t3.FHeadSelfB0434=@finbillno --一张入库单，只有一张关联领料单

		update src set @fsrccommitfield_prevalue=src.fqty,
			 @fsrccommitfield_endvalue=@fsrccommitfield_prevalue-(case src.fmaterieltype when 376 then dest.fqty*cast(-1 as float) else dest.fqty end),
			 @fcheck_fail=(case when (@fsrccommitfield_endvalue>=src.fdiscardqty) then @fcheck_fail else -1 end),
			 src.fqty=@fsrccommitfield_endvalue,
			 src.fauxqty=@fsrccommitfield_endvalue/cast(t1.fcoefficient as float)
		from ppbomentry src 
			 inner join ppbom srchead on src.ficmointerid=srchead.ficmointerid
			 inner join 
			 (
				select u1.ficmointerid as fsourceinterid,u1.fppbomentryid,u1.fitemid,sum(u1.fqty) as fqty
				from  icstockbillentry u1 
				inner join icstockbill u3 on u3.finterid=u1.finterid
				inner join t_icitem u2 on u1.fitemid=u2.fitemid
				where u3.FHeadSelfB0434=@finbillno and u1.ficmointerid> 0 
				group by u1.ficmointerid,u1.fppbomentryid,u1.fitemid
			 ) dest on dest.fsourceinterid = src.ficmointerid and dest.fitemid = src.fitemid	and src.fentryid = dest.fppbomentryid
			 inner join t_measureunit t1 on src.funitid=t1.fitemid

		delete t3 from icstockbill t3 where t3.ftrantype=24 and t3.FHeadSelfB0434=@finbillno
	end

	return --反审核触发的时候将数据删除就OK
end

--select fnumber,fname,* from t_emp where fname like '莫%'
select @FDIOFInFanager=25326,@FDIOFOutSanager=25326,@frob=frob,@CostObjGroupID=0,
@FDIOFInSanager=25326,@FDIOFOutFanager=25326,@fuserid=fbillerid,@fdate=fdate 
from icstockbill where fbillno=@finbillno 

set @fcount=1
select @UpStockWhenSave=fvalue from T_SYSTEMPROFILE where  fkey='UPSTOCKWHENSAVE'

--领料--	FHeadSelfB0436 领料源入库单号-----------------
--ALTER  TABLE  icstockbill  DISABLE  TRIGGER  My_Tri_ICStockBill_In 

select t5.finterid ficmointerid,t5.fitemid fcbitemid,
(t3.fauxqtymust-t3.fauxqty) fqtymust,--红蓝字直接在这里处理
--t6.finqty*t3.fauxqtyscrap fqty,--如果是红字，则t6.fauxqty已经是负数
(case when ((t6.fqty*t3.fauxqtyscrap*(1+t3.fscrap/100))>=(t3.fauxqtymust-t3.fauxqty) or (t5.fqty<=t5.fcommitqty)) then (t3.fauxqtymust-t3.fauxqty) else (t6.fqty*t3.fauxqtyscrap*(1+t3.fscrap/100)) end) fqty, 
t2.finterid fppbominterid,
t3.fentryid fppbomentryid,t5.fworkshop fdeptid,
case when t9.fitemid in (175,171817) then 16479	--装配车间仓
	 when t9.fitemid=176 then 16480 else 16480 --包装车间仓
end fstockid,t5.FCostObjID,t4.ferpclsid,0 fplanprice,
0 fplanamount,t5.fbillno ficmobillno,t3.funitid,isnull(t4.fspid,0) fspid,t3.fitemid,(case when t5.forderinterid<>0 then t5.forderinterid else t5.FPPOrderInterID end) fsourceinterid,t5.fsourceentryid,
(case when t5.forderinterid<>0 then 81 else 85 end) fsourcetrantype,t17.finterid fisbackflush,
isnull(t13.finterid,0) fstockmanagerid,isnull((select top 1 fitemid from t_emp where fname=t13.fname),25326) ffmanagerid,t5.FPlanCommitDate fplanbegindate
into #SourceData
from icmo t5 
inner join icstockbillentry t6 on t6.ficmointerid=t5.finterid
inner join icstockbill t1 on t1.finterid=t6.finterid and t1.ftrantype=2
inner join ppbom t2 on t5.finterid=t2.ficmointerid
inner join ppbomentry t3 on t2.finterid=t3.finterid
inner join t_icitem t4 on t3.fitemid=t4.fitemid
inner join t_icitem t8 on t5.fitemid=t8.fitemid
left join t_SubMessage t13 on t13.finterid=t4.f_114 and t13.ftypeid=10003  --仓管员
left join t_SubMessage t17 on t17.finterid=t4.f_115 and t17.ftypeid=10002
--left join t_emp t7 on t7.fname=t13.fname
inner join t_department t9 on t9.fitemid=t5.fworkshop
where t1.fbillno=@finbillno and (t3.fauxqtymust-t3.fauxqty)>0  --
--and t4.ferpclsid=2 
and isnull(t17.fname,'否')='是'
order by t4.fshortnumber

DECLARE icbom_cursor CURSOR FOR	
select distinct fdeptid from #SourceData t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid --where fnumber like '01.%' and fnumber not like '01.01.%'  --屏蔽掉产成品,半成品/原材料/委外件都自动生成领料单

OPEN icbom_cursor

FETCH NEXT FROM icbom_cursor 
INTO @fdeptid

WHILE @@FETCH_STATUS = 0
BEGIN 
	exec My_p_GetBillNo 24,'icstockbill',@Interid output, @BillNo output
    if @fcount=1 set @fbegbillno=@BillNo
               	
	DECLARE authors_cursor CURSOR FOR	

	select t1.ffmanagerid,t1.fplanbegindate,t1.fsourceinterid,t1.fsourcetrantype,t1.fcbitemid,t1.fitemid,t1.funitid,t1.fstockid,t1.fspid,t1.fdeptid,t1.fqtymust,t1.fqty,t1.ficmointerid,t1.ficmobillno,t1.fplanprice,t1.fplanamount,t1.fcostobjid,t1.fppbominterid,t1.fppbomentryid 
	from #SourceData t1
	inner join t_icitem t2 on t1.fitemid=t2.fitemid
	where t1.fdeptid=@fdeptid
	order by t2.fnumber

    set @entryid=1

	OPEN authors_cursor

	FETCH NEXT FROM authors_cursor 
	INTO @ffmanagerid,@fplanbegindate,@fsourceinterid,@fsourcetrantype,@fcbitemid,@fitemid,@funitid,@fstockid,@fspid,@fdeptid,@fqtymust,@fqty,@ficmointerid,@ficmobillno,@fplanprice,@fplanamount,@fcostobjid,@fppbominterid,@fppbomentryid

	WHILE @@FETCH_STATUS = 0
	BEGIN 		
		INSERT INTO ICStockBillEntry (FInterID,FEntryID,FBrNo,FItemID,FAuxPropID,FBatchNo,FQtyMust, FQty,     FReProduceType,FCostOBJID, FCostObjGroupID,FUnitID ,FAuxQtyMust,Fauxqty,FSecCoefficient,FSecQty,FAuxPlanPrice,FPlanAmount, Fauxprice,Famount,FBomInterID,Fnote,    FKFDate,FKFPeriod,FPeriodDate,FSCStockID,FDCSPID,FOperSN,FOperID,FSNListID,FSourceBillNo,FSourceTranType,FSourceInterId, FSourceEntryID, FICMOBillNo, FICMOInterID, FPPBomEntryID, FInStockID) 
		VALUES (                      @Interid,@EntryId,'0',  @fitemid,0,        '',      @fqtymust,@fqty   , 1059,          @fcostobjid,@CostObjGroupID,@FUnitID,@fqtymust , @fqty,  0,              0,      @fplanprice,  @fplanamount,0,        0,      0,          '倒冲',   Null,   0,        Null,       @fstockid, @fspid, 0,      0,      0,        @ficmobillno, 85,             @ficmointerid,  @fppbomentryid, @ficmobillno,@ficmointerid,@fppbomentryid,0) 

		set @entryid=@entryid+1
		set @fcount=@fcount+1

		FETCH NEXT FROM authors_cursor 
		INTO @ffmanagerid,@fplanbegindate,@fsourceinterid,@fsourcetrantype,@fcbitemid,@fitemid,@funitid,@fstockid,@fspid,@fdeptid,@fqtymust,@fqty,@ficmointerid,@ficmobillno,@fplanprice,@fplanamount,@fcostobjid,@fppbominterid,@fppbomentryid
	END

	CLOSE authors_cursor
	DEALLOCATE authors_cursor

	if @fsourcetrantype=81
		select @fsourcebillno=fbillno,@FCustBillNo=fheadselfs0144 from seorder where finterid=@fsourceinterid
	else
		select @fsourcebillno=fbillno from pporder where finterid=@fsourceinterid

	INSERT INTO ICStockBill(FHeadSelfB0445,FHeadSelfB0442,/*FHeadSelfB0433,FHeadSelfB0435, FHeadSelfB0437, FHeadSelfB0436,*/FInterID,FBillNo,FBrNo,FTranType,FCancellation,FStatus,FUpStockWhenSave,FVchInterID,FROB,    FHookStatus,Fdate, FDeptID, Fuse,FCheckDate,FSManagerID,      FFManagerID,     FBillerID,   FAcctID,FMultiCheckLevel1,FMultiCheckDate1,FMultiCheckLevel2,FMultiCheckDate2,FMultiCheckLevel3,FMultiCheckDate3,FMultiCheckLevel4,FMultiCheckDate4,FMultiCheckLevel5,FMultiCheckDate5,FMultiCheckLevel6,FMultiCheckDate6,FPurposeID,FWBINTERID,FSelTranType,FBackFlushed) 
	VALUES (		        @fdate,        20977,         /*@FCustBillNo,  @fplanbegindate,@fsourcebillno, @finbillno,   */ @InterId,@BillNo,'0',  24,       0,            0,      @UpStockWhenSave,0,          @frob,   0,          @fdate,@fdeptid,'',  Null,      0,                @ffmanagerid,    @fuserid,    0,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,40105,0,85,1)
	 
	exec My_p_UpdateBillRelateData @InterId --更新关联数
	--exec My_p_UpdateBillRelateData_24_26 24,@InterId --更新计划投料单数量

	UPDATE ICStockBill SET FUUID=NEWID() WHERE FInterID=@InterId
	
	INSERT INTO t_Log (FDate,FUserID,FFunctionID,FStatement,FDescription,FMachineName,FIPAddress) VALUES (getdate(),@UserId,'K010001',3,'编号为'+@BillNo+'的单据保存成功','KSW118','192.168.0.159')
	
	FETCH NEXT FROM icbom_cursor 
    INTO @fdeptid
END

CLOSE icbom_cursor
DEALLOCATE icbom_cursor

set @fendbillno=@BillNo

--更新任务单的领料状态 
/*
update m2 set FHeadSelfJ0173=(case when m1.fqty=0 then 40011 when (m1.fqty>0 and m1.fqtymust>m1.fqty) then 40012 when m1.fqtymust<=m1.fqty then 40013 end) 
from
(
	select t1.ficmointerid,isnull(sum(t1.fqtymust),0) fqtymust,isnull(sum(t2.fqty),0) fqty
	from PPBomEntry t1
	left join 
	(
		select t1.ficmointerid,t1.fppbomentryid,sum(t1.fqty) fqty
		from icstockbill t0 
		inner join icstockbillentry t1 on t0.finterid=t1.finterid
		inner join 
		(	  select distinct t1.FICMOInterID 
			  from icstockbillentry t1
			  inner join icstockbill t2 on t1.finterid=t2.finterid
			  where t2.fbillno>=@fbegbillno and t2.fbillno<=@fendbillno and t2.ftrantype=24
		) t2 on t1.ficmointerid=t2.ficmointerid
		where t0.ftrantype=24 
		group by t1.ficmointerid,t1.fppbomentryid
	) t2 on t1.ficmointerid=t2.ficmointerid and t1.fentryid=t2.fppbomentryid
	group by t1.ficmointerid
) m1 inner join icmo m2 on m1.ficmointerid=m2.finterid
*/
--ALTER  TABLE  icstockbill  ENABLE  TRIGGER  My_Tri_ICStockBill_In 
--select * from #SourceData

drop table #SourceData
/*
set @s=''

if exists (select 1
		   from t_icitem t1 
		   inner join icinventory t2 on t1.fitemid=t2.fitemid 
           inner join t_stock t3 on t2.fstockid=t3.fitemid where t2.fqty<0) and exists(select 1 from t_SystemProfile where FCategory='IC' and fkey='FIsPassWhenNotEnough' and fvalue='0')--库存不足是否允许通过
begin
	select @s=@s+','+m1.fnumber from
	(
		select t1.fnumber,0 FBillQty,t2.fqty FCurInvQty 
		from t_icitem t1 
		inner join icinventory t2 on t1.fitemid=t2.fitemid 
		inner join t_stock t3 on t2.fstockid=t3.fitemid where t2.fqty<0
	) m1

	set @s='有以下物料库存不足['+@s+']!'

	RAISERROR(@s,18,18)
end
*/

set nocount off

go


--IF EXISTS (select * from sysobjects where name='My_p_GeneratePOPriceBatch' and xtype='p')  drop  procedure My_p_GeneratePOPriceBatch

--go


--create procedure [dbo].My_p_GeneratePOPriceBatch
----with encryption 
--as
--SET NOCOUNT ON

--declare @fplanprice decimal(18,4),@fitemid int,@fpitemid int,@funitid int,@entryid int,@fqty int
--declare @BillNo varchar (20),@FStockId int,@StockNumber varchar (20),@InterID int 
--DECLARE @TmpID INT ,@fsupplyid int,@fcurrencyid int,@FMyPoInStockInterId int,@fuserid int
--declare @fsupplyno varchar(20),@forderdate datetime,@FValueAddRate decimal(28, 2)
--declare @iLength int,@FPrice decimal(28, 5),@foldprice  decimal(28, 5),@FAmount decimal(20, 2),@fsubid int
--declare @FTaxPrice decimal(28, 5),@FTaxAmount decimal(20, 2),@SupplyId int,@FAllStdAmount decimal(24,2)
--declare @fprojectval  varchar(200),@fspid int,@fempid int,@fdeptid int,@fprice1 decimal(24,2),@fprice2 decimal(24,2),@fprice3 decimal(24,2)
--declare @sDateFormat  varchar(200),@fdate datetime,@fcustid int,@fquobillno varchar(50)
--declare @fsourceNumber varchar(200),@fpSourceNumber varchar(200),@fpXxSourceNumber varchar(200)
--declare @fXxOldSourceNumber varchar(200),@empid int,@fmanagerid int
--declare @FDCStockID int,@xx_FItemIDOld int,@fxxitemid int,@fstdpackprice decimal(24,4)
--declare @FDCSPID int,@forderinterid int,@forderentryid int,@fpoitemtype varchar(50)
--declare @fsourceInterid int,@fsourceEntryid int,@fsourceBillNo varchar (100)
--declare @fyear int,@fperiod int,@FMangerID int,@FExchangeRate decimal(28,10)
--declare @fresultbillno varchar (800),@fnote varchar(500),@fempshortname varchar(40)
--declare @ftempbillno varchar(50),@fremark varchar(500),@fcess decimal(24,2),@fpackprice decimal(24,4)
--declare @fallamount decimal(24,2),@fordertype varchar(50),@FTaxAmt decimal(24,2),@fnudepackprice decimal(24,4)
--declare @fexportdistrict varchar(50),@fpricetype varchar(50),@FBillTypeID int,@FGrossExchangerate decimal(24,4)
--declare @foldprice1 decimal(24,4),@foldprice2 decimal(24,4),@foldprice3 decimal(24,4)

--select @fuserid=16394,@fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期

--set @fresultbillno=''

--select @FGrossExchangerate=t1.fvalue from t_SystemProfile t1 where t1.FCategory='IC' and t1.FKey='FGrossExchangerate'

----26301	中山鑫威打印耗材有限公司

----drop table #data  select * from #data  drop table #sellprice  select * from #sellprice --select * from t_supplier

--exec GetICMaxNum 'MyPOPriceChange', @InterID output

--select @FBillTypeID=fbillid from ICBillNo where fbillname='MyPOPriceChange'

--Update t_BillCodeRule Set FReChar = FReChar Where FBillTypeID =@FBillTypeID

--SET @TmpID = (SELECT FID FROM t_BillCodeRule WITH(READUNCOMMITTED) WHERE fbilltypeid=@FBillTypeID and fprojectid=3)

--update t_billcoderule set fprojectval = fprojectval+1,flength=case when (flength-len(fprojectval)) >= 0 then flength else len(fprojectval) end where FID =  @TmpID 
--Update ICBillNo Set FCurNo = (select top 1 isnull(fprojectval,1) from t_billcoderule where fprojectid = 3 and fbilltypeid =@FBillTypeID) where fbillid = @FBillTypeID
   
----长度和目前编码
--select @fprojectval=(fprojectval-1),@iLength=flength from t_BillCodeRule where fprojectid = 3 and fbilltypeid = @FBillTypeID
  
---- 前缀
--select @BillNo=fprojectval+left('0000000000',@iLength-(len(@fprojectval)))+@fprojectval from t_BillCodeRule where fprojectid = 1 and fbilltypeid = @FBillTypeID  --@iLength

--set @entryid=1

--DECLARE icbom_cursor CURSOR FOR	
----select * from t_item where fitemclassid=3010
--select t7.funitid,t12.fsupid,t12.fitemid,t12.fprice foldprice,
--t12.fprice-(case when t15.fitemid=27591 then 0.3 when t15.fitemid=27592 then 0.15 when t15.fitemid=27593 then 0.1 end) fprice,
--t12.fcyid
--from t_SupplyEntry t12  
--inner join t_icitem t7 on t12.fitemid=t7.fitemid and t12.FSupID=t7.fsource 
--left join t_item t15 on t15.fitemclassid=3010 and t15.fitemid=t7.F_119
--where not exists(select 1 from t_BOSSuitBill where fproductid=t12.fitemid)
--and t7.fsource=26301 
--order by t7.fnumber



--select t3.funitid,t1.fsupid,t3.fitemid,t1.fprice foldprice,1.1*t1.fprice fprice,t1.fcyid
--			from t_SupplyEntry t1
--			inner join t_icitem t2 on t1.fitemid=t2.fitemid
--			inner join t_icitem t3 on isnull(t3.F_128,0)<>40087 and t2.fitemid=t3.F_129 and t2.fitemid<>t3.fitemid
--			where t3.fitemid<>0
--			and left(t2.fnumber,4) in ('a.01','p.01','j.01','x.01','y.01')
--			and left(t3.fnumber,4) in ('a.04','p.04','j.04','x.04','y.04')  --STARINK

--		union all
--		select t1.fsubid,t1.fitemid,t1.funitid,
--		       max(fprice1)-max(isnull(fcolorfee,0))+max(isnull(fboxfee,0)) fprice1,
--		       max(fprice2)-max(isnull(fcolorfee,0))+max(isnull(fboxfee,0)) fprice2,
--		       max(fprice3)-max(isnull(fcolorfee,0))+max(isnull(fboxfee,0)) fprice3
--		from
--		(
--select t3.funitid,t1.fsupid,t3.fitemid,t1.fprice foldprice,
--cast(isnull(t1.fprice,0) as decimal(24,4))-cast(isnull(t16.f_102,0) as decimal(24,2))+cast(isnull(t18.f_102,0) as decimal(24,2)) fprice,t1.fcyid,
--			select t1.finterid fsubid,t3.fitemid,t3.funitid,cast(isnull(t16.f_102,0) as decimal(24,2)) fcolorfee,cast(isnull(t18.f_102,0) as decimal(24,2)) fboxfee,
--			(case when t1.fbegqty=1 then t1.fprice else 0 end) fprice1,
--			(case when t1.fbegqty<>1 and t1.fendqty<>9999999 then t1.fprice else 0 end) fprice2,
--			(case when t1.fendqty=9999999 then t1.fprice else 0 end) fprice3
--			from t_SupplyEntry t1
--			inner join t_icitem t2 on t1.fitemid=t2.fitemid
--			inner join t_icitem t3 on isnull(t3.F_128,0)<>40087 and t2.fitemid=t3.F_129 and t2.fitemid<>t3.fitemid
--			left join t_item_3013 t16 on t16.f_101=t3.F_119 and Charindex('彩盒',t16.fname)>0
--			left join t_item_3013 t18 on t18.f_101=t3.F_119 and Charindex('白盒',t18.fname)>0
--			where t3.fitemid<>0
--			and left(t2.fnumber,4) in ('a.01','p.01','j.01','x.01','y.01')
--			and left(t3.fnumber,4) in ('a.02','p.02','j.02','x.02','y.02')  --白盒
--			union all
--			select t1.finterid fsubid,t3.fitemid,t3.funitid,cast(isnull(t16.f_102,0) as decimal(24,2)) fcolorfee,cast(isnull(t18.f_102,0) as decimal(24,2)) fboxfee,
--			(case when t1.fbegqty=1 then t1.fprice else 0 end) fprice1,
--			(case when t1.fbegqty<>1 and t1.fendqty<>9999999 then t1.fprice else 0 end) fprice2,
--			(case when t1.fendqty=9999999 then t1.fprice else 0 end) fprice3
--			from t_SupplyEntry t1
--			inner join t_icitem t2 on t1.fitemid=t2.fitemid
--			inner join t_icitem t3 on isnull(t3.F_128,0)<>40087 and t2.fitemid=t3.F_129 and t2.fitemid<>t3.fitemid
--			left join t_item_3013 t16 on t16.f_101=t3.F_119 and Charindex('彩盒',t16.fname)>0
--			left join t_item_3013 t18 on t18.f_101=t3.F_119 and Charindex('咖啡盒',t18.fname)>0
--			where t3.fitemid<>0
--			and left(t2.fnumber,4) in ('a.01','p.01','j.01','x.01','y.01')
--			and left(t3.fnumber,4) in ('a.03','p.03','j.03','x.03','y.03')  --咖啡盒
--		) t1 group by t1.fsubid,t1.fitemid,t1.funitid
--		union all
--		select t1.fsubid,t1.fitemid,t1.funitid,max(fprice1) fprice1,max(fprice2) fprice2,max(fprice3) fprice3
--		from
--		(
--			select 31 fsubid,t3.fitemid,t3.funitid,case when t1.fbegqty=1 then t1.fprice else 0 end fprice1,
--			case when t1.fbegqty<>1 and t1.fendqty<>9999999 then t1.fprice else 0 end fprice2,
--			case when t1.fendqty=9999999 then t1.fprice else 0 end fprice3
--			from IcPrcPlyEntry t1
--			inner join t_icitem t2 on t1.fitemid=t2.fitemid
--			inner join t_icitem t3 on isnull(t3.F_128,0)<>40087 and t2.fitemid=t3.F_129 and t2.fitemid<>t3.fitemid
--			where t3.fitemid<>0 and t1.frelatedid=20011
--			and left(t2.fnumber,4) in ('a.01','p.01','j.01','x.01','y.01')
--			and left(t3.fnumber,4) in ('v.b.')  --个性化产品
--		) t1 group by t1.fsubid,t1.fitemid,t1.funitid
--		union all
--		select t1.fsubid,t1.fitemid,t1.funitid,max(fprice1) fprice1,max(fprice2) fprice2,max(fprice3) fprice3
--		from
--		(
--			select 31 fsubid,t1.fitemid,t1.funitid,t1.fprice fprice1,t1.fprice fprice2,t1.fprice fprice3
--			from seorderentry t1
--			inner join seorder t3 on t1.finterid=t3.finterid
--			inner join 
--			(
--				select t2.fitemid,max(t2.fentryid) fentryid,isnull(max(t1.finterid),0) finterid --该客户物料的最新单据
--				from seorder t1
--				inner join seorderentry t2 on t1.finterid=t2.finterid
--				inner join t_icitem t3 on t2.fitemid=t3.fitemid
--				where t1.fstatus>0 and left(t3.fnumber,4) in ('v.b.')  --个性化产品
--				and isnull(t3.F_128,0)=40087 
--				group by t2.fitemid
--			) t2 on t1.finterid=t2.finterid and t1.fitemid=t2.fitemid and t1.fentryid=t2.fentryid
--		) t1 group by t1.fsubid,t1.fitemid,t1.funitid

--OPEN icbom_cursor

--FETCH NEXT FROM icbom_cursor 
--INTO @funitid,@fsupplyid,@fitemid,@foldprice,@fprice,@fcurrencyid

--WHILE @@FETCH_STATUS = 0
--BEGIN 
--	insert into MyPOPriceChangeEntry (finterid,fentryid,funitid, fsupplyid, fitemid, fstarqty,fendqty,foldprice, fprice, foldtaxprice,ftaxprice,fnote)
--	values                           (@InterId,@entryid,@funitid,@fsupplyid,@fitemid,0,       0,      @foldprice,@fprice,0,           0,        '')

--	set @entryid=@entryid+1

--	FETCH NEXT FROM icbom_cursor 
--    INTO @funitid,@fsupplyid,@fitemid,@foldprice,@fprice,@fcurrencyid
--END

--CLOSE icbom_cursor
--DEALLOCATE icbom_cursor

--INSERT INTO MyPOPriceChange(fcurrencyid, finterid,fnote,fbillno,fbillerid,FStatus,Fdate)              
--values	(					@fcurrencyid,@InterId,'',   @BillNo,@fuserid, 0,      @fdate)

--set nocount off

--go

--出入库表触发器--新增、更新--&&&&&
IF EXISTS (select * from sysobjects where name='My_Tri_ICStockBill_In'  and xtype='TR')  drop  TRIGGER My_Tri_ICStockBill_In
go

Create TRIGGER My_Tri_ICStockBill_In
            ON ICStockBill
for insert,update

AS
BEGIN
	SET NOCOUNT ON
	declare @iMaxIndex int,@FInterID int, @FMyInterID int ,@s varchar(2000),@fcurrencyid int,@FVchInterID int
	declare @fbillno varchar(30),@ftrantype int ,@frob int,@fdate datetime,@ftoday datetime,@fstatus int,@FHeadSelfB0433 int
	
	select top 1 @frob=frob,@ftrantype=ftrantype,@fcurrencyid=fcurrencyid,@s='',@fstatus=fstatus,@FVchInterID=isnull(FVchInterID,0),
	@fbillno=fbillno,@FInterID=FInterID,@fdate=fdate,@ftoday=replace(convert(varchar(10),getdate(),111),'/','-'),
	@FHeadSelfB0433=isnull(FHeadSelfB0433,0) from INSERTED 
--		
--	IF @ftrantype=1    
--	BEGIN
--		if exists (select 1 from icstockbillentry t1 inner join INSERTED t2 on t1.finterid=t2.finterid 
--				   inner join poorderentry t3 on t3.finterid=t1.forderinterid and t3.fentryid=t1.forderentryid 
--				   where t3.fauxprice=0 and t2.fdate>='2014-04-16')
--		begin
--			RAISERROR('采购单价为0的分录不能生成外购入库单!',18,18)
--		end
--	end

	if exists(	select 1
				from icstockbill t1
				inner join icstockbillentry t2 on t1.finterid=t2.finterid
				inner join t_icitem t3 on t2.fitemid=t3.fitemid  --套件
				where t1.finterid=@FInterID and t3.fnumber like '1.02.%'  and t1.fdate>='2014-01-01'
				) 
				and exists (select * from t_SystemProfile where FCategory='IC' and fkey='FIsPlasticManage' and fvalue='1')
	begin
		RAISERROR('套件不允许出入库!',18,18)
	end

	IF @ftrantype=24 and @FVchInterID=0 and not update(FVchInterID)    
	BEGIN
		if exists (select 1 from icstockbillentry t1 inner join INSERTED t2 on t1.finterid=t2.finterid 
		where isnull(t1.fsourcetrantype,0)=85 and isnull(t1.fsourcebillno,'')='' )
		begin
			update t1 set fsourcebillno=t4.fbillno,ficmobillno=t4.fbillno
			from icstockbillentry t1 
			inner join INSERTED t2 on t1.finterid=t2.finterid 
			inner join icmo t4 on t4.finterid=t1.fsourceinterid
			where isnull(t1.fsourcetrantype,0)=85 and isnull(t1.fsourcebillno,'')=''
		end

		if exists (select 1 from icstockbillentry t1 inner join INSERTED t2 on t1.finterid=t2.finterid 
		where isnull(t1.fsourceinterid,0)=0 and t2.fdate>'2016-09-01')
		begin
			RAISERROR('生产领料必须关联单据生成!',18,18)
		end

		if exists (select 1 from icstockbillentry t1 inner join INSERTED t2 on t1.finterid=t2.finterid 
		where isnull(t1.ficmointerid,0)=0 and t2.fdate>='2016-09-07')
		begin
			RAISERROR('生产领料必须关联任务单生成!',18,18)
		end

		if exists (select 1 from icstockbillentry t1 inner join INSERTED t2 on t1.finterid=t2.finterid 
		where cast(t1.fqty as decimal(24,2))>cast(t1.fqtymust as decimal(24,2)) and t2.fdate>'2013-03-05' and t1.fqty>0)
		begin
			RAISERROR('实发数不能大于申请数!',18,18)
		end

		--if @fstatus=0 and @FHeadSelfB0433=0 --
		--begin
		--	if exists(
		--		select 1
		--		from
		--		(
		--			select t1.fitemid,t1.FSCStockID fstockid,t1.fbatchno,sum(t1.fqty) fqty
		--			from ICStockBill t0 --
		--			inner join ICStockBillEntry t1 on t0.finterid=t1.finterid  --
		--			inner join 
		--			(	  
		--				select distinct t1.fitemid
		--				from ICStockBillEntry t1--
		--				inner join inserted t2 on t1.finterid=t2.finterid
		--				where t1.fsourcetrantype in (85) --t1.finterid=@FInterID
		--			) t2 on t1.fitemid=t2.fitemid
		--			where t0.ftrantype=24 --and t1.fsourcetrantype in (85)  --,200000014
		--			and t0.fstatus=0 and t0.frob=1  --蓝字未审核的领料单
		--			group by t1.fitemid,t1.FSCStockID,t1.fbatchno
		--		) t1 left join icinventory t2 on t1.fitemid=t2.fitemid and t1.fstockid=t2.fstockid and t1.fbatchno=t2.fbatchno
		--		where t1.fqty>isnull(t2.fqty,0)
		--	)
		--	begin
		--		select @s=@s+','+m1.fnumber from
		--		(
		--			select '['+t3.fshortnumber+']'+'['+t4.fname+']'+'['+isnull(t1.fbatchno,'')+']'+'['+cast(t1.fqty as varchar(50))+']'+'库存['+cast(isnull(t2.fqty,0) as varchar(50))+']' fnumber
		--			from
		--			(
		--				select t1.fitemid,t1.FSCStockID fstockid,t1.fbatchno,cast(sum(t1.fqty) as decimal(24,2)) fqty
		--				from ICStockBill t0 --
		--				inner join ICStockBillEntry t1 on t0.finterid=t1.finterid  --
		--				inner join 
		--				(	  
		--					select distinct t1.fitemid
		--					from ICStockBillEntry t1--
		--					inner join inserted t2 on t1.finterid=t2.finterid
		--					where t1.fsourcetrantype in (85) -- t1.finterid=@FInterID
		--				) t2 on t1.fitemid=t2.fitemid
		--				where t0.ftrantype=24 --and t1.fsourcetrantype in (85)  --,200000014
		--				and t0.fstatus=0 and t0.frob=1
		--				group by t1.fitemid,t1.FSCStockID,t1.fbatchno
		--			) t1 left join icinventory t2 on t1.fitemid=t2.fitemid and t1.fstockid=t2.fstockid and t1.fbatchno=t2.fbatchno
		--			inner join t_icitem t3 on t3.fitemid=t1.fitemid
		--			inner join t_stock t4 on t4.fitemid=t1.fstockid
		--			where t1.fqty>isnull(t2.fqty,0)
		--		) m1

		--		set @s='以下物料库存不够['+@s+']'   --
		--		RAISERROR(@s,18,18)
		--	end
		--end

		--if exists(
		--	select 1
		--	from PPBOMEntry t1 --
		--	inner join 
		--	(
		--		select t1.ficmointerid,t1.fppbomentryid,t1.fitemid,sum(t1.fqty) fqty
		--		from ICStockBill t0 --
		--		inner join ICStockBillEntry t1 on t0.finterid=t1.finterid  --
		--		inner join 
		--		(	  
		--			select distinct t1.ficmointerid,t1.fitemid 
		--			from ICStockBillEntry t1--
		--			inner join inserted t2 on t1.finterid=t2.finterid
		--			where t1.fsourcetrantype in (85) --t1.finterid=@FInterID
		--		) t2 on t1.ficmointerid=t2.ficmointerid and t1.fitemid=t2.fitemid
		--		inner join icmo t3 on t3.finterid=t1.ficmointerid
		--		where t0.ftrantype=24 and t1.fsourcetrantype in (85)  --200000014
		--		group by t1.ficmointerid,t1.fppbomentryid,t1.fitemid
		--	) t2 on t1.ficmointerid=t2.ficmointerid and t1.FEntryID=t2.fppbomentryid and t1.fitemid=t2.fitemid
		--	where t1.fqtymust<t2.fqty
		--)
		--begin
		--	select @s=@s+','+m1.fnumber from
		--	(
		--		select '['+t3.fshortnumber+']'+'['+cast(t2.fqty as varchar(50))+']'+'应发['+cast(cast(t1.fqtymust as decimal(24,2)) as varchar(50))+']' fnumber
		--		from PPBOMEntry t1 --
		--		inner join 
		--		(
		--			select t1.ficmointerid,t1.fppbomentryid,t1.fitemid,cast(sum(t1.fqty) as decimal(24,2)) fqty
		--			from ICStockBill t0 --
		--			inner join ICStockBillEntry t1 on t0.finterid=t1.finterid  --
		--			inner join 
		--			(	  
		--				select distinct t1.ficmointerid,t1.fitemid  
		--				from ICStockBillEntry t1--
		--				inner join inserted t2 on t1.finterid=t2.finterid
		--				where t1.fsourcetrantype in (85) --t1.finterid=@FInterID
		--			) t2 on t1.ficmointerid=t2.ficmointerid and t1.fitemid=t2.fitemid
		--			inner join icmo t3 on t3.finterid=t1.ficmointerid
		--			where t0.ftrantype=24 and t1.fsourcetrantype in (85)  --200000014
		--			group by t1.ficmointerid,t1.fppbomentryid,t1.fitemid
		--		) t2 on t1.ficmointerid=t2.ficmointerid and t1.FEntryID=t2.fppbomentryid and t1.fitemid=t2.fitemid
		--		inner join t_icitem t3 on t3.fitemid=t1.fitemid
		--		where t1.fqtymust<t2.fqty
		--	) m1

		--	set @s='以下物料超过应发数['+@s+']'   --
		--	RAISERROR(@s,18,18)
		--end

		--更新投料单选单数量--虚仓的在虚仓触发器中考虑--不会出现一个物料又有虚仓又有实仓--有可能出现先调用了此触发器，K3又回写了，会造成double回写的错误
		update t1 set fqty=isnull(t2.fqty,0),fauxqty=isnull(t2.fqty,0)  --与My_P_GenerateOutStock24的写法不一样
		from PPBOMEntry t1 --
		inner join 
		(
			select t1.ficmointerid,t1.fppbomentryid,t1.fitemid,sum(t1.fqty) fqty
			from ICStockBill t0 --
			inner join ICStockBillEntry t1 on t0.finterid=t1.finterid  --
			inner join 
			(	  
				select distinct t1.ficmointerid 
				from ICStockBillEntry t1--
				inner join inserted t2 on t1.finterid=t2.finterid
				--where t1.finterid=@FInterID
			) t2 on t1.ficmointerid=t2.ficmointerid
			inner join icmo t3 on t3.finterid=t1.ficmointerid
			where t0.ftrantype=24 and t1.fsourcetrantype in (85,200000014)
			group by t1.ficmointerid,t1.fppbomentryid,t1.fitemid
		) t2 on t1.ficmointerid=t2.ficmointerid and t1.FEntryID=t2.fppbomentryid and t1.fitemid=t2.fitemid

--		--exec My_p_UpdateBillRelateData_24_26 24,@FInterID
--
--		--更新任务单的领料状态 
--		/*
--		update m2 set FHeadSelfJ0173=(case when fallcount=fallnocount then 40011 when (FPartCount>0 or fallcount>fallnocount) then 40012 when fallcount=FAllYesCount then 40013 end) 
--		from
--		(
--			select t1.ficmointerid,
--			(select count(finterid) from PPBomEntry where ficmointerid=t1.ficmointerid) FAllCount,
--			(select count(finterid) from PPBomEntry where ficmointerid=t1.ficmointerid and fqty=0) FAllNoCount,
--			(select count(finterid) from PPBomEntry where ficmointerid=t1.ficmointerid and FQtyMust>FQty and fqty>0) FPartCount,
--			(select count(finterid) from PPBomEntry where ficmointerid=t1.ficmointerid and FQtyMust<=FQty) FAllYesCount
--			from (select distinct t1.FICMOInterID from icstockbillentry t1
--				  inner join INSERTED t3 on t3.finterid=t1.finterid) t1
--		) m1 inner join icmo m2 on m1.ficmointerid=m2.finterid
--		*/
--
--		/*
--		update m2 set FHeadSelfJ0173=(case when m1.fqty=0 then 40011 when (m1.fqty>0 and m1.fqtymust>m1.fqty) then 40012 when m1.fqtymust<=m1.fqty then 40013 end) 
--		from
--		(
--			select t1.ficmointerid,isnull(sum(t1.fqtymust),0) fqtymust,isnull(sum(t2.fqty),0) fqty
--			from PPBomEntry t1
--			left join 
--			(
--				select t1.ficmointerid,t1.fppbomentryid,sum(t1.fqty) fqty
--				from icstockbill t0 
--				inner join icstockbillentry t1 on t0.finterid=t1.finterid
--				inner join 
--				(	  select distinct t1.FICMOInterID 
--					  from icstockbillentry t1
--					  inner join INSERTED t2 on t1.finterid=t2.finterid
--					  --where t1.finterid=@finterid 
--				) t2 on t1.ficmointerid=t2.ficmointerid
--				where t0.ftrantype=24 
--				group by t1.ficmointerid,t1.fppbomentryid
--			) t2 on t1.ficmointerid=t2.ficmointerid and t1.fentryid=t2.fppbomentryid
--			group by t1.ficmointerid
--		) m1 inner join icmo m2 on m1.ficmointerid=m2.finterid
--		*/
	end
--
--	/*
--	IF @ftrantype=41  --更新任务单的调拨状态   
--	BEGIN
--		update m2 set FHeadSelfJ0175=(case when m1.fqty=0 then 40011 when (m1.fqty>0 and m1.fqtymust>m1.fqty) then 40012 when m1.fqtymust<=m1.fqty then 40013 end) 
--		from
--		(
--			select t1.ficmointerid,sum(t1.fqtymust) fqtymust,sum(t2.fqty) fqty
--			from PPBomEntry t1
--			left join 
--			(
--				select t1.ficmointerid,t1.fppbomentryid,sum(t1.fqty) fqty
--				from icstockbill t0 
--				inner join icstockbillentry t1 on t0.finterid=t1.finterid
--				inner join 
--				(	  select distinct t1.FICMOInterID 
--					  from icstockbillentry t1
--					  inner join INSERTED t3 on t3.finterid=t1.finterid
--				) t2 on t1.ficmointerid=t2.ficmointerid
--				where t0.ftrantype=41 
--				group by t1.ficmointerid,t1.fppbomentryid
--			) t2 on t1.ficmointerid=t2.ficmointerid and t1.fentryid=t2.fppbomentryid
--			group by t1.ficmointerid
--		) m1 inner join icmo m2 on m1.ficmointerid=m2.finterid
--	end
--	*/
--
--	--/*

	IF @ftrantype=21  --销售出库   
	BEGIN
		--纯PCS数
		update x set x.FEntrySelfB0160=x.FQty*isnull(y.fqty,1)
		from icstockbillentry x left join 
				(
					select c.fitemid,isnull(sum(isnull(b.fqty,1)),1)  as fqty
					from icbom a inner join icbomchild b on a.finterid=b.finterid
									 inner join t_icitem c on a.fitemid=c.fitemid
									 inner join t_icitem d on b.fitemid=d.fitemid
				where left(d.fnumber,1) in ('3','4','5','7','8')
					group by c.fitemid
				) y on x.fitemid=y.fitemid
		inner join icstockbill t1 on t1.finterid=x.finterid
		where x.finterid=@finterid --and t1.fdate>='2016-05-03'

		update t8 set fentryselfb0161=t5.fentryselfs0176
		from seorderentry t5 
		inner join seorder t6 on t6.finterid=t5.finterid 
		inner join icstockbillentry t8 on t8.forderinterid=t5.finterid and t8.forderentryid=t5.fentryid and t8.fitemid=t5.fitemid 
		inner join inserted t9 on t9.finterid=t8.finterid
		where t9.ftrantype=21
	end

	IF @ftrantype=2  --产品入库   
	BEGIN
		if exists (select 1 from icstockbillentry t1 inner join INSERTED t2 on t1.finterid=t2.finterid 
		where isnull(t1.fsourceinterid,0)=0 and t2.fdate>'2013-03-01')
		begin
			RAISERROR('产品入库必须关联单据生成!',18,18)
		end

		if exists (select 1 from icstockbillentry t1 inner join INSERTED t2 on t1.finterid=t2.finterid 
		where t1.fqty>t1.fqtymust and t2.fdate>'2013-03-05' and t1.fqty>0)
		begin
			RAISERROR('实收数不能大于应收数!',18,18)
		end

		--纯PCS数
		update x set x.FEntrySelfA0238=x.FQty*isnull(y.fqty,1)
		from icstockbillentry x left join 
				(
					select c.fitemid,isnull(sum(isnull(b.fqty,1)),1)  as fqty
					from icbom a inner join icbomchild b on a.finterid=b.finterid
									 inner join t_icitem c on a.fitemid=c.fitemid
									 inner join t_icitem d on b.fitemid=d.fitemid
				where left(d.fnumber,1) in ('3','4','5','7','8')
					group by c.fitemid
				) y on x.fitemid=y.fitemid
		inner join icstockbill t1 on t1.finterid=x.finterid
		where x.finterid=@finterid --and t1.fdate>='2016-05-03'

		update x set x.FEntrySelfA0239=isnull(t2.fheadselfj0183,0)
		from icstockbillentry x 
		left join icmo t2 on x.ficmointerid=t2.finterid
		inner join icstockbill t1 on t1.finterid=x.finterid
		where x.finterid=@finterid and t1.fdate>='2017-03-01'

		update t2 set fnote=isnull(t2.fnote,'')+'//返工' --+(case when Charindex('返工',isnull(t2.fnote,''))<=0 then +'//返工' else '' end))
		from icstockbillentry t2 
		inner join inserted t3 on t2.finterid=t3.finterid
		inner join t_icitem t4 on t4.fitemid=t2.fitemid
		inner join icmo t1 on t1.finterid=t2.ficmointerid
		where t3.fdate>='2017-03-01' and t1.fworktypeid=56 and isnull(t2.fnote,'') not like '%//返工'

--and t3.ftrantype =cast(@fbilltype as int)
--and isnull(t3.FVchInterID,0)=0 

--
--		update src set src.fqtyfinish=isnull(dest.fqty,0),
--			 src.fauxqtyfinish=isnull(dest.fqty,0)/cast(t1.fcoefficient as float)
--		from icmo src left join 
--		(
--			select u1.fsourceinterid as fsourceinterid,u1.fitemid,sum(u1.FQtyFinish) as fqty
--			from
--			(
--				select t2.FSourceInterId
--				from inserted t1
--				inner join icstockbillentry t2 on t1.finterid=t2.finterid
--				group by t2.FSourceInterId
--			) t1 inner join ICMORptEntry u1 on t1.FSourceInterId=u1.fsourceinterid
--			group by u1.fsourceinterid,u1.fitemid
--		) dest on dest.fsourceinterid = src.finterid and dest.fitemid = src.fitemid
--		inner join t_measureunit t1 on src.funitid=t1.fitemid
	end
--	--*/
end

go

--出入库单审核触发器--塑胶子件--外调--

IF EXISTS (select * from sysobjects where name='My_Tri_ICStockBill_UP'  and xtype='TR')  drop  TRIGGER My_Tri_ICStockBill_UP
go

create trigger [dbo].[My_Tri_ICStockBill_UP] 
            ON [dbo].[ICStockBill]
for update
AS
BEGIN
	set nocount on
	DECLARE	@FInterID  int,
			@FTranType int,@FMultiCheckLevel1 int,
			@fstatus INT,@fcheckerid int
	declare @s varchar(2000),@fbillno varchar(30),@FMyInterID int ,@frob int

	SELECT @fstatus=fstatus,@FInterID=FInterID,@fcheckerid=isnull(fcheckerid,0),@FTranType=FTranType,
	@s='',@fbillno=fbillno,@frob=frob,@FMultiCheckLevel1=isnull(FMultiCheckLevel1,0) FROM INSERTED

	if @FTranType in (1,10,24,29,40,43)
	begin
--		if exists(	select 1
--					from icstockbill t1
--					inner join icstockbillentry t2 on t1.finterid=t2.finterid
--					inner join t_icitem t3 on t2.fitemid=t3.fitemid  --套件
--					inner join t_icitem t4 on Charindex(t3.fshortnumber,t4.fnumber)>0  --t3.fshortnumber=substring(t4.fnumber,6,6) --子件
--					where t1.finterid=@FInterID and t3.fnumber like '1.02.%' and t4.fnumber like '6.%'
--					--and isnull(t4.F_116,0)>0
--					) 
--					and update(fstatus)  
--					and exists (select * from t_SystemProfile where FCategory='IC' and fkey='FIsPlasticManage' and fvalue='1')
--		begin
--			exec My_P_GenerateZPOutStock26_6 @fcheckerid,@FInterID,@fstatus,0
--		end

		if update(FMultiCheckLevel1) and @FMultiCheckLevel1=1 and @FTranType=24
		begin
			update t1 set FHeadSelfB0444=convert(varchar(50),getdate(),121) 
			from icstockbill t1 
			inner join inserted t2 on t1.finterid=t2.finterid
			where isnull(t1.FHeadSelfB0444,'')=''
		end

		if update(FMultiCheckLevel1) and @FMultiCheckLevel1=0 and @FTranType=24
		begin
			update t1 set FHeadSelfB0444=''
			from icstockbill t1 
			inner join inserted t2 on t1.finterid=t2.finterid
		end

	end

	if @ftrantype=1 and update(fstatus)   
	begin
		if @frob=-1 --红字外购入库无源单用采购最新价格更新
		begin
			update t1 set fentryselfa0154=t11.ftaxprice,fentryselfa0155=cast(t11.ftaxprice*t1.fqty as decimal(24,2)),
						  fprice=t11.fprice,fauxprice=t11.fprice,famount=cast(t11.fprice*t1.fqty as decimal(24,2))
			from ICStockBillEntry t1--
			inner join inserted t2 on t1.finterid=t2.finterid
			inner join t_SupplyEntry t11 on t1.fitemid=t11.fitemid and t2.fsupplyid=t11.fsupid
			inner join t_icitem t3 on t3.fitemid=t1.fitemid
			inner join 
			(
				select fitemid,max(fentryid) fentryid 
				from (select t1.fitemid,t1.fentryid from t_supplyentry t1 inner join (select fitemid,max(FQuoteTime) FQuoteTime from t_SupplyEntry group by fitemid) t2 on t1.fitemid=t2.fitemid and t1.FQuoteTime=t2.FQuoteTime) t1 
				group by fitemid
			) t12 on t11.fitemid=t12.fitemid and t11.fentryid=t12.fentryid 
			where t2.frob=-1 and isnull(t1.fsourceinterid,0)=0 and t3.fnumber not like '6.%'
			and isnull(t2.FVchInterID,0)=0 and t2.fdate>='2014-04-01' and t2.ftrantype=1
		end

		--子件回写入库数量--一审是业务级审核，就会更新fstatus
		update t5 set finstockqty=t5.finstockqty+(case when @fstatus=1 then 1 else -1 end)*t1.fqty
		from 
		(
			select t1.fsourceinterid,t1.fsourceentryid,t1.fsourcetrantype,sum(t1.fqty) fqty
			from ICStockBillEntry t1--
			inner join inserted t2 on t1.finterid=t2.finterid
			group by t1.fsourceinterid,t1.fsourceentryid,t1.fsourcetrantype
		) t1 inner join poinstockentry t3 on t1.fsourceinterid=t3.finterid and t1.fsourceentryid=t3.fentryid and t1.fsourcetrantype=72
		inner join poinstock t4 on t3.finterid=t4.finterid
		inner join t_bosPlasticPoInStockEntry t5 on t5.fid=t3.fsourceinterid and t5.fentryid=t3.fsourceentryid and t3.fsourcetrantype=200000022
		inner join t_bosPlasticPoInStock t6 on t6.fid=t5.fid

		update t6 set fguid=newid()
		from ICStockBillEntry t1--
		inner join inserted t2 on t1.finterid=t2.finterid
		inner join poinstockentry t3 on t1.fsourceinterid=t3.finterid and t1.fsourceentryid=t3.fentryid and t1.fsourcetrantype=72
		inner join poinstock t4 on t3.finterid=t4.finterid
		inner join t_bosPlasticPoInStockEntry t5 on t5.fid=t3.fsourceinterid and t5.fentryid=t3.fsourceentryid and t3.fsourcetrantype=200000022
		inner join t_bosPlasticPoInStock t6 on t6.fid=t5.fid

		--外调品回写生产任务单的入库数和实作数
		if exists(  select 1
					from ICStockBillEntry t1--
					inner join poorderentry t2 on t1.forderinterid=t2.finterid and t1.FOrderEntryID=t2.fentryid and t2.fsourcetrantype=81 
					inner join seorderentry t3 on t2.fsourceinterid=t3.finterid and t2.fsourceentryid=t3.fentryid
					inner join inserted t4 on t1.finterid=t4.finterid 
					where isnull(t3.FEntrySelfS0175,0) in (40091)) --40089	自产自包,40090	外调自包,40091	外调外包
		begin
			update t1 set fstockqty=t1.fstockqty+(case when @fstatus=1 then 1 else -1 end)*t2.fqty,
			fauxstockqty=t1.fauxstockqty+(case when @fstatus=1 then 1 else -1 end)*t2.fqty,
			fcommitqty=t1.fcommitqty+(case when @fstatus=1 then 1 else -1 end)*t2.fqty,	
			fauxcommitqty=t1.fauxcommitqty+(case when @fstatus=1 then 1 else -1 end)*t2.fqty
			from icmo t1 
			inner join 
			(	  
				select t2.fsourceinterid,t2.fsourceentryid,sum(t1.fqty) fqty 
				from ICStockBillEntry t1--
				inner join poorderentry t2 on t1.forderinterid=t2.finterid and t1.FOrderEntryID=t2.fentryid and t2.fsourcetrantype=81 
				inner join seorderentry t3 on t2.fsourceinterid=t3.finterid and t2.fsourceentryid=t3.fentryid
				inner join inserted t4 on t1.finterid=t4.finterid
				where isnull(t3.FEntrySelfS0175,0) in (40090,40091)
				group by t2.fsourceinterid,t2.fsourceentryid --按销售订单分录汇总
			) t2 on t1.forderinterid=t2.fsourceinterid and t1.fsourceentryid=t2.fsourceentryid
		end
	end

	if update(fstatus) and @fstatus=1 and @ftrantype=2 
	begin
		set @s=''
		select @s=t1.fname from inserted t3	inner join t_Item_3008 t1 on t1.fitemid=t3.fheadselfa0229

		if @s<>''
		begin
			update t1 set fheadselfj0181=isnull(t1.fheadselfj0181,'')+','+@s
			from icmo t1
			inner join 
			(
				select t1.ficmointerid
				from inserted t3
				inner join icstockbillentry t1 on t1.finterid=t3.finterid
				group by t1.ficmointerid
			) t2 on t1.finterid=t2.ficmointerid
			where Charindex(@s,isnull(t1.fheadselfj0181,''))<=0
		end

--			if (@fstatus=0 or @fstatus=1) and exists (select 1 from ppbomentry t1 
--														inner join ppbom t12 on t1.finterid=t12.finterid
--														inner join t_icitem t13 on t13.fitemid=t1.fitemid
--														inner join icmo t6 on t6.finterid=t12.FICMOInterID 
--														inner join icstockbillentry t112 on t6.finterid=t112.ficmointerid 
--														inner join icstockbill t113 on t112.finterid=t113.finterid
--														inner join t_SubMessage t17 on t17.finterid=t13.f_115 and t17.ftypeid=10003
--														where t113.fbillno=@fbillno and t17.fname='是' and t113.frob=1) and exists (select * from t_SystemProfile where FCategory='IC' and fkey='FIsBackFlush' and fvalue='1')
--			begin
--				exec my_p_DirectInAndOut @fbillno,@fstatus
--			end

	end

	/*
	IF @ftrantype=24  --计划投料单已领数量   
	BEGIN
		if update(fcheckerid) and @fcheckerid>0  --审核
		begin
			exec My_p_UpdateBillRelateData_24_26 24,@FInterID
		end

		if update(fcheckerid) and @fcheckerid<=0  --反审核
		begin --更新计划投料单已关联数
			update t1 set fcommitqty=t1.fcommitqty-isnull(t2.fqty,0),FNoOutStockQty=t1.FNoOutStockQty+isnull(t2.fqty,0)
			from t_BOSPlanChangeStockEntry t1 --
			inner join 
			(
				select t2.forderinterid,t2.fsourceentryid,t1.fitemid,sum(t1.fqty) fqty
				from ICStockBillEntry t1 
				inner join icmo t2 on t1.ficmointerid=t2.finterid
				where t1.finterid=@finterid and t2.forderinterid<>0
				group by t2.forderinterid,t2.fsourceentryid,t1.fitemid
			) t2 on t1.FID_SRC=t2.forderinterid and t1.FEntryID_SRC=t2.fsourceentryid and t1.fitemid=t2.fitemid
		end
	end
	*/
END

go


IF EXISTS (select * from sysobjects where name='My_Seorder_Update'  and xtype='TR')  drop  TRIGGER My_Seorder_Update
go

create trigger [dbo].[My_Seorder_Update] on [dbo].[SEOrder]
for insert,update
as
set nocount on

declare @fstatus int,@finterid int
select @finterid=finterid from inserted

update m2 set FEntrySelfS0170=m2.fqty-isnull(m2.FEntrySelfS0169,0),FEntrySelfS0168=m2.fqty-m2.fordercommitqty
from seorderentry m2 
inner join seorder m3 on m2.finterid=m3.finterid
where m3.finterid=@finterid

go

IF EXISTS (select * from sysobjects where name='v_My_RecAndSend' and xtype='v')  drop  view v_My_RecAndSend

go

create view v_My_RecAndSend 

as

select '' 本工序,'' 物料编码,'' 物料名称,'' 条码

go

IF EXISTS (select * from sysobjects where name='v_My_Assemble' and xtype='v')  drop  view v_My_Assemble

go

create view v_My_Assemble 

as

select '' 工序,'' 销售订单号,'' 子项编码,'' 子项名称,'' 子项条码

go

IF EXISTS (select * from sysobjects where name='v_My_t_Barcode' and xtype='v')  drop  view v_My_t_Barcode

go

create view v_My_t_Barcode 

as

select '' 源单编号,'' 物料编码,'' 名称,'' 规格型号,'' 条码

go

--  --0 成品 1 半成品  2 常规物料 3 包材  4 芯片 --select * from v_MyItemType
IF EXISTS (select * from sysobjects where name='v_MyItemType' and xtype='v')  drop  view v_MyItemType

go

create view v_MyItemType 

as

select 0 ftype,'A' fitemtype,'成品' ftypename 
union all
select 0 ftype,'P' fitemtype,'成品' ftypename 
union all
select 0 ftype,'Q' fitemtype,'成品' ftypename 
union all
select 0 ftype,'R' fitemtype,'成品' ftypename 
union all
select 0 ftype,'J' fitemtype,'成品' ftypename 
union all
select 0 ftype,'X' fitemtype,'成品' ftypename 
union all
select 0 ftype,'Y' fitemtype,'成品' ftypename 
union all
select 0 ftype,'V' fitemtype,'成品' ftypename 
union all
select 0 ftype,'M' fitemtype,'色带' ftypename 

union all
select 1 ftype,'3' fitemtype,'半成品' ftypename 
union all
select 1 ftype,'4' fitemtype,'半成品' ftypename 
union all
select 1 ftype,'5' fitemtype,'半成品' ftypename 
union all
select 1 ftype,'7' fitemtype,'半成品' ftypename 
union all
select 1 ftype,'8' fitemtype,'半成品' ftypename 

union all
select 3 ftype,'2' fitemtype,'包材' ftypename 

union all
select 4 ftype,'1.01.0010' fitemtype,'芯片' ftypename 

union all
select 10 ftype,'A.01' fitemtype,'傲威中性' ftypename 
union all
select 10 ftype,'P.01' fitemtype,'傲威中性' ftypename 
union all
select 10 ftype,'J.01' fitemtype,'傲威中性' ftypename 
union all
select 10 ftype,'X.01' fitemtype,'傲威中性' ftypename 
union all
select 10 ftype,'Y.01' fitemtype,'傲威中性' ftypename 


go



IF EXISTS (select * from sysobjects where name='My_P_GenerateICMOBillNo' and xtype='p')  drop  procedure My_P_GenerateICMOBillNo

go

create procedure  [dbo].My_P_GenerateICMOBillNo(@finterid int)

as

BEGIN
	SET NOCOUNT ON
	declare @FMultiCheckLevel1 int,@fdate varchar(20),@fsourcetrantype int
	declare @fstatus int,@strPre varchar(50),@fcount varchar(20),@fcount2 varchar(20),@fbillno varchar(30)
	declare @fsrccommitfield_prevalue decimal(24,2),@fsrccommitfield_endvalue decimal(24,2)
	declare @fworkshop int,@fnextbillno varchar(50),@forderbillno varchar(50),@forderinterid int
	declare @fcheckdate datetime,@fitemid int

	select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期

	select top 1 @fstatus=t1.fstatus,@fworkshop=t1.fworkshop,@fcheckdate=t1.fcheckdate,
	@forderbillno=isnull(t2.fbillno,''),@forderinterid=t1.forderinterid,@fbillno=t1.fbillno,@fitemid=t1.fitemid,
	@strPre=(case when t1.fworkshop=171817 then 'ZP' when t1.fworkshop=175 then 'ZP' when t1.fworkshop=176 then 'BZ' else 'QT' end) +left(@fdate,4) +substring(@fdate,6, 2)
	from icmo t1 left join seorder t2 on t1.forderinterid=t2.finterid where t1.finterid=@finterid

	--select fitemid,fname,* from t_department 175	装配车间 176	包装车间

	
	if @fcheckdate>='2013-03-08' and @fworkshop in (175,171817)
	begin
		if left(@fbillno,4)='WORK' --下达时生成任务单号
		begin
			if @fworkshop=176 --BZ201303002-1  ZP201303002
			begin
				if exists(select 1 from icmo where forderinterid=@forderinterid and fbillno like 'BZ%')--存在则用已经有的,不存在则加1--一份订单不同的任务单可能在不同的月份下达
					select @fcount=cast((isnull(cast(substring(fbillno,9,3) as int),0)) as varchar(20)) from icmo where forderinterid=@forderinterid and fbillno like 'BZ%' and len(fbillno)>=11 --@strPre+'%'   --单据编号至少11位  --and fbillno like 'BZ%'--
				else
					select @fcount=cast((isnull(cast(max(substring(fbillno,9,3)) as int),0)+1) as varchar(20)) from icmo where fbillno like @strPre+'%' and len(fbillno)>=11  --单据编号至少11位
				
				select @fcount2=cast((isnull(cast(max(substring(fbillno,13,3)) as int),0)+1) as varchar(20)) from icmo where forderinterid=@forderinterid and fbillno like 'BZ%' and len(fbillno)>=11 --@strPre+Left('000', 3 - Len(@fcount))+'%' and len(fbillno)>=11  --单据编号至少11位

				select @fnextbillno=@strPre+Left('000', 3 - Len(@fcount))+ @fcount+'-'+Left('000', 3 - Len(@fcount2))+ @fcount2 
			end
			else
			begin
				select @fcount=cast((isnull(cast(max(substring(fbillno,9,3)) as int),0)+1) as varchar(20)) from icmo where fbillno like @strPre+'%' and len(fbillno)>=11  --单据编号至少11位
				select @fnextbillno=@strPre+Left('000', 3 - Len(@fcount)) + @fcount 
			end

			update t1 set fbillno=@fnextbillno
			from icmo t1 
			left join icstockbillentry t3 on t3.ficmointerid=t1.finterid
			where t1.finterid=@finterid and t1.fbillno not like @strPre+'%'  --已经是这个格式了就不变了
			and t3.finterid is null
		end
	end

	update t1 set FGMPBatchNo=t1.fbillno
	from icmo t1 
	inner join t_icitem t3 on t1.fitemid=t3.fitemid
	where t1.finterid=@finterid and left(t3.fnumber,1) in ('3','4') and t3.FBatchManager=1

	set nocount off
end

go

--刷新BOM标准装箱资料
IF EXISTS (select * from sysobjects where name='My_P_ReFlashItemByICBOM' and xtype='p')  drop  procedure My_P_ReFlashItemByICBOM

go

create procedure  [dbo].My_P_ReFlashItemByICBOM

as
set nocount on
begin
	--套装
	update t12 set F_126=40019,F_127=0
	from
	(
		select fitemid from
		(
			select t1.fitemid,t1.fnumber,t1.fname
			from t_icitem t1
			inner join icbom t2 on t1.fitemid=t2.fitemid
			inner join icbomchild t3 on t2.finterid=t3.finterid
			inner join t_icitem t4 on t3.fitemid=t4.fitemid
			where t1.fname not like '%禁用%' and t1.fdeleted=0 
			and left(t1.fnumber,1) in ('v') and left(t4.fnumber,1) in ('3','4','5','7','8')
		) t1 group by t1.fitemid
		having count(1)>1
	) t1 inner join t_ICItemCustom t12 on t1.fitemid=t12.fitemid
	inner join t_icitem t3 on t3.fitemid=t1.fitemid

	----物料分类--先更新成其它
	--update t6 set ftypeid= 40127
	--from t_icitem t3 
	--inner join icbom t1 on t1.fitemid=t3.fitemid
	--inner join t_ICItemBase t6 on t6.fitemid=t3.fitemid
	--where  left(t3.fnumber,1) in ('v')

	--物料分类--再按照条件更新
	update t6 set ftypeid=case when left(t5.fnumber,1)='3' then 40122 when left(t5.fnumber,1)='4' then 40123 when left(t5.fnumber,1)='5' then 40124
									when left(t5.fnumber,1)='7' then 40125 when left(t5.fnumber,1)='8' then 40126 end
	from t_icitem t3 
	inner join icbom t1 on t1.fitemid=t3.fitemid
	inner join icbomchild t2 on t1.finterid=t2.finterid
	inner join t_icitem t5 on t5.fitemid=t2.fitemid and left(t5.fnumber,1) in ('3','4','5','7','8')
	inner join t_ICItemBase t6 on t6.fitemid=t3.fitemid
	where  left(t3.fnumber,1) in ('a','p','j','x','y','v')

	--海关产品分类
	update t6 set F_108=t5.F_108
	from t_icitem t3 
	inner join icbom t1 on t1.fitemid=t3.fitemid
	inner join icbomchild t2 on t1.finterid=t2.finterid
	inner join t_icitem t5 on t5.fitemid=t2.fitemid and left(t5.fnumber,1) in ('3','4','5','7','8')
	inner join t_ICItemCustom t6 on t6.fitemid=t3.fitemid
	where left(t3.fnumber,1) in ('a','p','j','x','y','v') and isnull(t5.F_108,0)<>0

	--先更新成配件
	update t6 set F_108=412
	from t_icitem t3 
	inner join icbom t1 on t1.fitemid=t3.fitemid
	inner join t_ICItemCustom t6 on t6.fitemid=t3.fitemid
	where left(t3.fnumber,1) in ('r')

	update t6 set F_108=t5.F_108
	from t_icitem t3 
	inner join icbom t1 on t1.fitemid=t3.fitemid
	inner join icbomchild t2 on t1.finterid=t2.finterid
	inner join t_icitem t5 on t5.fitemid=t2.fitemid 
	inner join t_ICItemCustom t6 on t6.fitemid=t3.fitemid
	where left(t3.fnumber,1) in ('r') and isnull(t5.F_108,0)<>0

	update t12 set fname=t12.fname+'-鼓架'
	from t_icitem t3 
	inner join icbom t1 on t1.fitemid=t3.fitemid
	inner join icbomchild t2 on t1.finterid=t2.finterid
	inner join t_icitem t5 on t5.fitemid=t2.fitemid 
	inner join t_ICItemCore t6 on t6.fitemid=t3.fitemid
	inner join t_item t16 on t16.fitemid=t5.F_108 and t16.fitemclassid=3003
	inner join t_item t12 on t12.fitemid=t3.fitemid
	--inner join t_baseproperty t15 on t15.fitemid=t3.fitemid
	where left(t3.fnumber,1) in ('a','p','j','x','y','v') and isnull(t5.F_108,0)<>0 and t16.fname like '鼓架' and t12.fname not like '%鼓架%'
	and left(t5.fnumber,1) in ('3','4','5','7','8')
	--and isnull(t12.FChkUserID,0)<>0 --选择性加这个条件

	update t6 set fname=t6.fname+'-鼓架'
	from t_icitem t3 
	inner join icbom t1 on t1.fitemid=t3.fitemid
	inner join icbomchild t2 on t1.finterid=t2.finterid
	inner join t_icitem t5 on t5.fitemid=t2.fitemid 
	inner join t_ICItemCore t6 on t6.fitemid=t3.fitemid
	inner join t_item t16 on t16.fitemid=t5.F_108 and t16.fitemclassid=3003
	inner join t_item t12 on t12.fitemid=t3.fitemid
	--inner join t_baseproperty t15 on t15.fitemid=t3.fitemid
	where left(t3.fnumber,1) in ('a','p','j','x','y','v') and isnull(t5.F_108,0)<>0 and t16.fname like '鼓架' and t6.fname not like '%鼓架%'
	and left(t5.fnumber,1) in ('3','4','5','7','8')
	--and isnull(t12.FChkUserID,0)<>0 --选择性加这个条件

	update t12 set fname=t12.fname+'-粉筒'
	from t_icitem t3 
	inner join icbom t1 on t1.fitemid=t3.fitemid
	inner join icbomchild t2 on t1.finterid=t2.finterid
	inner join t_icitem t5 on t5.fitemid=t2.fitemid 
	inner join t_ICItemCore t6 on t6.fitemid=t3.fitemid
	inner join t_item t16 on t16.fitemid=t5.F_108 and t16.fitemclassid=3003
	inner join t_item t12 on t12.fitemid=t3.fitemid
	--inner join t_baseproperty t15 on t15.fitemid=t3.fitemid
	where left(t3.fnumber,1) in ('a','p','j','x','y','v') and isnull(t5.F_108,0)<>0 and t16.fname like '粉筒' and t12.fname not like '%粉筒%'
	and left(t5.fnumber,1) in ('3','4','5','7','8')
	--and isnull(t12.FChkUserID,0)<>0 --选择性加这个条件

	update t6 set fname=t6.fname+'-粉筒'
	from t_icitem t3 
	inner join icbom t1 on t1.fitemid=t3.fitemid
	inner join icbomchild t2 on t1.finterid=t2.finterid
	inner join t_icitem t5 on t5.fitemid=t2.fitemid 
	inner join t_ICItemCore t6 on t6.fitemid=t3.fitemid
	inner join t_item t16 on t16.fitemid=t5.F_108 and t16.fitemclassid=3003
	inner join t_item t12 on t12.fitemid=t3.fitemid
	--inner join t_baseproperty t15 on t15.fitemid=t3.fitemid
	where left(t3.fnumber,1) in ('a','p','j','x','y','v') and isnull(t5.F_108,0)<>0 and t16.fname like '粉筒' and t6.fname not like '%粉筒%'
	and left(t5.fnumber,1) in ('3','4','5','7','8')
	--and isnull(t12.FChkUserID,0)<>0 --选择性加这个条件

	--主供应商--物料
	update t9 set F_117=25952 
	from icbom t1
	inner join t_icitem t3 on t1.fitemid=t3.fitemid
	inner join icbomchild t5 on t1.finterid=t5.finterid
	inner join t_icitem t6 on t5.fitemid=t6.fitemid
	inner join t_ICItemCustom t9 on t9.fitemid=t1.fitemid
	where left(t6.fnumber,1) in ('3','4','5')
		
	update t9 set F_117=t7.fsupid 
	from icbom t1
	inner join t_icitem t3 on t1.fitemid=t3.fitemid
	inner join icbomchild t5 on t1.finterid=t5.finterid
	inner join t_icitem t6 on t5.fitemid=t6.fitemid
	inner join t_supplyentry t7 on t7.fitemid=t6.fitemid
	inner join (select fitemid,max(fentryid) fentryid from t_supplyentry group by fitemid) t8 on t7.fitemid=t8.fitemid and t7.fentryid=t8.fentryid
	inner join t_ICItemCustom t9 on t9.fitemid=t1.fitemid
	where left(t6.fnumber,1) in ('7','8')	
	
	--产品分级
	update t9 set F_136=t2.fitemid
	from icbom t1
	inner join t_icitem t3 on t1.fitemid=t3.fitemid
	inner join icbomchild t5 on t1.finterid=t5.finterid
	inner join t_icitem t6 on t5.fitemid=t6.fitemid
	inner join t_ICItemCustom t9 on t9.fitemid=t1.fitemid
	inner join t_Item_3018 t2 on t2.fitemid=177686 
	where left(t6.fnumber,1) in ('7','8') and left(t3.fnumber,1) not in ('R')	

	--标准装箱数
	update t7 set F_110=round(cast(cast(1 as decimal(24,4))/t3.fqty as decimal(24,4)),0)
	from t_icitem t2
	inner join icbom t1 on t1.fitemid=t2.fitemid
	inner join icbomchild t3 on t1.finterid=t3.finterid
	inner join t_icitem t4 on t3.fitemid=t4.fitemid
	inner join t_measureunit t5 on t5.fitemid=t4.funitid
	inner join t_ICItemCustom AS t7 ON t2.FItemID = t7.FItemID
	where t4.fnumber like '2.01.%' and left(t2.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0)
	
	--单个净重=除掉彩盒、除掉纸箱的重量 
	update t4 set FNetWeight=t1.FNetWeight
	from  t_icitem t2
	inner join
	(
		select t2.fitemid,sum(t4.FNetWeight*t3.fqty) FNetWeight --单个
		from t_icitem t2
		inner join icbom t1 on t1.fitemid=t2.fitemid
		inner join icbomchild t3 on t1.finterid=t3.finterid
		inner join t_icitem t4 on t3.fitemid=t4.fitemid
		inner join t_measureunit t5 on t5.fitemid=t4.funitid
		where left(t2.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0)
		and left(t4.fnumber,4) not in ('2.01','2.02','2.03','2.04') 
		--and t2.fshortnumber='A00001'
		and t4.FNetWeight<>0
		group by t2.fitemid
	) t1 on t1.fitemid=t2.fitemid
	inner join t_ICItemCustom AS t7 ON t2.FItemID = t7.FItemID
	inner join t_ICItemDesign AS t4 ON t2.FItemID = t4.FItemID	
	
	--整箱净重(KG)	 -- 整箱净重=单个净重×装箱数
	update t7 set F_112=t2.FNetWeight*t2.F_110
	from t_icitem t2
	inner join t_ICItemCustom AS t7 ON t2.FItemID = t7.FItemID
	inner join t_ICItemDesign AS t4 ON t2.FItemID = t4.FItemID		
	inner join icbom t1 on t1.fitemid=t2.fitemid
	where left(t2.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0)
				
	--单个毛重=除掉纸箱的重量
	update t4 set FGrossWeight=t1.FNoBoxWeight
	from  t_icitem t2
	inner join
	(
		select t2.fitemid,sum((case when left(t4.fnumber,4) not in ('2.01') then t4.FNetWeight else 0 end)*t3.fqty) FNoBoxWeight, --单个
					sum((case when left(t4.fnumber,4) in ('2.01') then t4.FNetWeight else 0 end)) FBoxWeight --一个纸箱的重量
		from t_icitem t2
		inner join icbom t1 on t1.fitemid=t2.fitemid
		inner join icbomchild t3 on t1.finterid=t3.finterid
		inner join t_icitem t4 on t3.fitemid=t4.fitemid
		inner join t_measureunit t5 on t5.fitemid=t4.funitid
		where left(t2.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0)
		and t4.FNetWeight<>0 
		--and t2.fshortnumber='A00001'
		group by t2.fitemid
	) t1 on t1.fitemid=t2.fitemid
	inner join t_ICItemCustom AS t7 ON t2.FItemID = t7.FItemID
	inner join t_ICItemDesign AS t4 ON t2.FItemID = t4.FItemID
	
	--整箱毛重(KG)	     --整箱毛重=单个毛重*装箱数+单个纸箱重量
	update t7 set F_119=t2.FGrossWeight*t2.F_110+t1.FBoxWeight
	from  t_icitem t2
	inner join
	(
		select t2.fitemid,sum((case when left(t4.fnumber,4) not in ('2.01') then t4.FNetWeight else 0 end)*t3.fqty) FNoBoxWeight, --单个
					sum((case when left(t4.fnumber,4) in ('2.01') then t4.FNetWeight else 0 end)) FBoxWeight --一个纸箱的重量
		from t_icitem t2
		inner join icbom t1 on t1.fitemid=t2.fitemid
		inner join icbomchild t3 on t1.finterid=t3.finterid
		inner join t_icitem t4 on t3.fitemid=t4.fitemid
		inner join t_measureunit t5 on t5.fitemid=t4.funitid
		where left(t2.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0)
		and t4.FNetWeight<>0 
		--and t2.fshortnumber='A00001'
		group by t2.fitemid
	) t1 on t1.fitemid=t2.fitemid
	inner join t_ICItemCustom AS t7 ON t2.FItemID = t7.FItemID
	inner join t_ICItemDesign AS t4 ON t2.FItemID = t4.FItemID	

	--标准外盒尺寸(MM)	     
	update t7 set F_111=substring(t4.fmodel,1,dbo.My_F_Charindex(t4.fmodel,'mm',1)-1)  
	from t_icitem t2
	inner join icbom t1 on t1.fitemid=t2.fitemid
	inner join icbomchild t3 on t1.finterid=t3.finterid
	inner join t_icitem t4 on t3.fitemid=t4.fitemid
	inner join t_measureunit t5 on t5.fitemid=t4.funitid
	inner join t_ICItemCustom AS t7 ON t2.FItemID = t7.FItemID
	where left(t2.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0)
	and left(t4.fnumber,4) in ('2.02','2.03','2.04') and t4.fmodel like '%*%*%mm%'
	
	select t7.fnumber, --先计算盒子体积
	cast(1*
	cast(cast(left(t7.F_111,CHARINDEX('*',t7.F_111)-1) as decimal(24,4))/10 as decimal(24,4))*
	cast(cast(substring(t7.F_111,CHARINDEX('*',t7.F_111)+1,charindex('*',t7.F_111,charindex('*',t7.F_111)+1)-CHARINDEX('*',t7.F_111)-1) as decimal(24,4))/10 as decimal(24,4))*
	cast(cast(substring(t7.F_111,charindex('*',t7.F_111,charindex('*',t7.F_111)+1)+1,len(t7.F_111)-charindex('*',t7.F_111,charindex('*',t7.F_111)+1)) as decimal(24,4))/10 as decimal(24,4)) as decimal(24,4)) 体积
	into #data
	from t_icitem t7
	inner join icbom t1 on t1.fitemid=t7.fitemid
	where left(t7.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0)
	and t7.F_111 like '%*%*%' and t7.F_111 not like '%0*0*0%'

	--外盒尺寸类别	  --按体积所属范围更新 大、中、小         
	update t7 set F_103= (case when t1.体积<=8000 then 395 when t1.体积>8000 and t1.体积<=13000 then 394 when t1.体积>13000 then 393 end)           
	from #data t1
	inner join t_icitem t2 on t1.fnumber=t2.fnumber
	inner join t_ICItemCustom AS t7 ON t2.FItemID = t7.FItemID
	
	select t2.fnumber,t2.fname,t2.fmodel,
	t4.fnumber fchildnumber,t4.fname fchildname,t4.fmodel fchildmodel,
	substring(t4.fmodel,1,dbo.My_F_Charindex(t4.fmodel,'cm',1)-1) fsize,t3.fqty
	into #bata
	from t_icitem t2
	inner join icbom t1 on t1.fitemid=t2.fitemid
	inner join icbomchild t3 on t1.finterid=t3.finterid
	inner join t_icitem t4 on t3.fitemid=t4.fitemid
	inner join t_measureunit t5 on t5.fitemid=t4.funitid
	where left(t2.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0)
	and t4.fnumber like '2.01.%' and t4.fmodel like '%*%*%cm%'
	
	select t1.fnumber,cast(cast(cast(substring(t1.fsize,1,dbo.My_F_CharIndex(t1.fsize,'*',1)-1) as decimal(24,4))*10 as int) as varchar)+'*'+
	cast(cast(cast(substring(t1.fsize,dbo.My_F_CharIndex(t1.fsize,'*',1)+1,(dbo.My_F_CharIndex(t1.fsize,'*',2)-dbo.My_F_CharIndex(t1.fsize,'*',1)-1)) as decimal(24,4))*10 as int) as varchar)+'*'+
	cast(cast(cast(substring(t1.fsize,dbo.My_F_CharIndex(t1.fsize,'*',2)+1,len(t1.fsize)-(dbo.My_F_CharIndex(t1.fsize,'*',2)-1))  as decimal(24,4))*10 as int) as varchar) fsize ,
	cast(cast(cast(substring(t1.fsize,1,dbo.My_F_CharIndex(t1.fsize,'*',1)-1) as decimal(24,4))*10 as int) as varchar) flength,
	cast(cast(cast(substring(t1.fsize,dbo.My_F_CharIndex(t1.fsize,'*',1)+1,(dbo.My_F_CharIndex(t1.fsize,'*',2)-dbo.My_F_CharIndex(t1.fsize,'*',1)-1)) as decimal(24,4))*10 as int) as varchar) fwidth,
	cast(cast(cast(substring(t1.fsize,dbo.My_F_CharIndex(t1.fsize,'*',2)+1,len(t1.fsize)-(dbo.My_F_CharIndex(t1.fsize,'*',2)-1))  as decimal(24,4))*10 as int) as varchar) fheight 
	into #size
	from #bata t1
	inner join t_icitem t4 on t1.fnumber=t4.fnumber

	--select * from #size

	--标准外箱尺寸(MM)	     
	update t7 set F_109=t1.fsize
	from #size t1
	inner join t_icitem t4 on t1.fnumber=t4.fnumber
	inner join t_ICItemCustom AS t7 ON t4.FItemID = t7.FItemID
	inner join t_ICItemDesign t2 on t2.fitemid=t4.fitemid

	update t2 set FLength=t1.FLength, FWidth=t1.FWidth, FHeight=t1.FHeight
	from #size t1
	inner join t_icitem t4 on t1.fnumber=t4.fnumber
	inner join t_ICItemCustom AS t7 ON t4.FItemID = t7.FItemID
	inner join t_ICItemDesign t2 on t2.fitemid=t4.fitemid	
	
	--update t6 set flastmoddate=getdate()
	--from t_icitem t1 
	--inner join icbom t2 on t1.fitemid=t2.fitemid
	--inner join t_baseproperty t6 on t6.fitemid=t1.fitemid

	drop table #data	
	drop table #bata
	drop table #size

	--盒子标准费
	update t7 set F_138=cast((case when left(t4.fnumber,4) in ('2.02') then (select f_103 from t_Item_3012 where f_102=t2.F_103 and f_101=25955) --彩盒
									when left(t4.fnumber,4) in ('2.03') then (select f_103 from t_Item_3012 where f_102=t2.F_103 and f_101=25953) --咖啡盒
									when left(t4.fnumber,4) in ('2.04') then (select f_103 from t_Item_3012 where f_102=t2.F_103 and f_101=25954) --白盒
								end) as decimal(24,2))
	from t_icitem t2
	inner join icbom t1 on t1.fitemid=t2.fitemid
	inner join icbomchild t3 on t1.finterid=t3.finterid
	inner join t_icitem t4 on t3.fitemid=t4.fitemid
	inner join t_ICItemCustom AS t7 ON t2.FItemID = t7.FItemID
	where left(t2.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0)
	and left(t4.fnumber,4) in ('2.02','2.03','2.04') 

	----修改日期
	--update t9 set flastmoddate=getdate()
	--from icbom t1
	--inner join t_icitem t3 on t1.fitemid=t3.fitemid
	--inner join t_baseproperty t9 on t9.fitemid=t1.fitemid

end 

set nocount off

go
	

--BOM触发器--
IF EXISTS (select * from sysobjects where name='My_tri_ICBom'  and xtype='TR')  drop  TRIGGER My_tri_ICBom
go

create trigger [My_tri_ICBom] on [dbo].[ICBOM]
for insert,update
as
set nocount on

declare @fstatus int,@finterid int,@fcheckerid int,@s varchar(2000),@fitemid int
select @finterid=finterid,@fcheckerid=isnull(fcheckerid,0),@fstatus=fstatus,@s='' from inserted
select top 1 @FInterID=finterid,@fitemid=fitemid from INSERTED 

if exists (select 1
		   from icbom t1
		   where t1.finterid<>@FInterID and t1.fitemid=@fitemid
)
begin
	select @s='产品重复!'
	--ROLLBACK TRAN
	RAISERROR(@s,18,18)
end

go

--BOM触发器--
IF EXISTS (select * from sysobjects where name='My_tri_ICBom_Update'  and xtype='TR')  drop  TRIGGER My_tri_ICBom_Update
go

create trigger [dbo].[My_tri_ICBom_Update] on [dbo].[ICBOM]
for update
as
set nocount on

declare @fstatus int,@finterid int,@fcheckerid int,@s varchar(2000),@fitemid int
declare @FBaseItemID int,@fnumber varchar(50),@fisproduct bit,@fbannumber varchar(50),@fxinnumber varchar(50)
select @finterid=finterid,@fcheckerid=isnull(fcheckerid,0),@fstatus=fstatus,@s='',@fbannumber='',@fxinnumber='' from inserted

select top 1 @FInterID=finterid,@fitemid=fitemid from INSERTED 

select top 1 @fnumber=fnumber,@FBaseItemID=0,
@fisproduct=(case when left(fnumber,1) in ('A','P','J','X','Y','V') then 1 else 0 end)
from t_icitem where fitemid=@fitemid

if update(fcheckerid) and @fcheckerid>0
--if @fstatus>0 --and update(fstatus)  --奇怪，如果写成 [if @fstatus>0 and update(fstatus)]，会过一段时间就触发不了
begin
	--update t3 set FGrossWeight=0,FNetWeight=0
	--from t_icitem t2
	--left join icbom t1 on t1.fitemid=t2.fitemid
	--inner join t_ICItemCustom AS t7 ON t2.FItemID = t7.FItemID
	--inner join t_ICItemDesign t3 on t3.fitemid=t2.fitemid
	--where left(t2.fnumber,1) in ('A','P','J','X','Y','V')
	--and t1.fitemid is null

	--update t7 set F_109='0*0*0',F_111='0*0*0',F_110=0,F_112=0,F_119=0,F_103=0,F_117=0
	--from t_icitem t2
	--left join icbom t1 on t1.fitemid=t2.fitemid
	--inner join t_ICItemCustom AS t7 ON t2.FItemID = t7.FItemID
	--inner join t_ICItemDesign t3 on t3.fitemid=t2.fitemid
	--where left(t2.fnumber,1) in ('A','P','J','X','Y','V')
	--and t1.fitemid is null

-- 	if exists(select 1
-- 				from t_icitem t2 
-- 				inner join inserted t11 on t11.fitemid=t2.fitemid --and t11.fusestatus=1072
-- 				inner join icbomchild t12 on t11.finterid=t12.finterid
-- 				inner join t_icitem t9 on t9.fitemid=t12.fitemid  --
-- 				left join t_supplyentry t4 on t4.fitemid=t12.fitemid
-- 				where (t2.fname like '%拆合%' or t2.fname like '%拆盒%' or left(t9.fnumber,1) in ('7','8')) and 
-- 				t4.fitemid is null /*and t9.fplanprice=0*/)
-- 	begin
-- 		select @s=@s+','+m1.fnumber from
-- 		(
-- 			select distinct t9.fnumber
-- 			from t_icitem t2 
-- 			inner join inserted t11 on t11.fitemid=t2.fitemid --and t11.fusestatus=1072
-- 			inner join icbomchild t12 on t11.finterid=t12.finterid
-- 			inner join t_icitem t9 on t9.fitemid=t12.fitemid  --
-- 			left join t_supplyentry t4 on t4.fitemid=t12.fitemid
-- 			where (t2.fname like '%拆合%' or t2.fname like '%拆盒%' or left(t9.fnumber,1) in ('7','8')) and 
-- 			t4.fitemid is null /*and t9.fplanprice=0*/
-- 		) m1
-- 
-- 		set @s='以下物料无采购单价['+@s+']'   --套件的子件
-- 		RAISERROR(@s,18,18)
-- 	end

	if exists(
		select t2.fnumber,t2.fname,t2.fmodel,t4.fnumber,t4.fname,t4.fmodel
		from icbom t1
		inner join t_icitem t2 on t1.fitemid=t2.fitemid
		inner join icbomchild t3 on t1.finterid=t3.finterid
		inner join t_icitem t4 on t3.fitemid=t4.fitemid
		inner join inserted t5 on t5.finterid=t1.finterid
		where t4.ferpclsid in (2,5) and t4.fitemid not in (select fitemid from icbom))
	begin
		RAISERROR('有子项自制件未做BOM!',18,18)
	end

	--if left(@fnumber,1) in ('Q') 
	--begin
	--	update t2 set fpiecefee=(case when t1.fqty<=0.5 then 0.5 else 0.6 end)
	--	from inserted t3
	--	inner join t_ICItemStandard t2 on t2.fitemid=t3.fitemid
	--	inner join  
	--	(
	--		select t1.fitemid,sum(t3.fqty) fqty
	--		from t_icitem t1
	--		inner join inserted t2 on t1.fitemid=t2.fitemid
	--		inner join icbomchild t3 on t2.finterid=t3.finterid
	--		inner join t_icitem t4 on t3.fitemid=t4.fitemid
	--		where t1.fnumber like 'Q.%' and t4.fnumber like '1.01.0009.%' 
	--		group by t1.fitemid
	--	) t1 on t3.fitemid=t1.fitemid 
	--end

	--价格引擎--
	--傲威中性都是价格引擎  --是否引擎 F_126	  产品引擎 F_127	 	--是  40019	否  40020
	if left(@fnumber,4) in ('A.01','P.01','J.01','X.01','Y.01') 
	begin
		update t2 set F_126=40019,F_127=0
		from t_icitem t1
		inner join t_ICItemCustom t2 on t1.fitemid=t2.fitemid
		where t1.fitemid=@fitemid
	end
	else if left(@fnumber,1) in ('A','P','J','X','Y','V') 
	begin
		select top 1 @FBaseItemID=isnull(t2.fitemid,0),@fbannumber=isnull(t3.fshortnumber,''),@fxinnumber=isnull(t4.fshortnumber,'')
		from
		(
			select fitemid,max(fbanitemid) fbanitemid,isnull(max(fxinitemid),0) fxinitemid from
			(
				select t1.fitemid,
				case when left(t4.fnumber,1) in ('3','4','5','7','8') then t4.fitemid else 0 end fbanitemid,
				case when left(t4.fnumber,10) in ('1.01.0010.') then t4.fitemid else 0 end fxinitemid
				from t_icitem t1
				inner join icbom t2 on t1.fitemid=t2.fitemid
				inner join icbomchild t3 on t2.finterid=t3.finterid
				inner join t_icitem t4 on t3.fitemid=t4.fitemid
				where t1.fitemid=@fitemid and left(t1.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0)
				--and t1.fname not like '%禁用%' and t1.fdeleted=0 
			) t1 group by t1.fitemid
		) t1 left join
		(
			select fitemid,max(fbanitemid) fbanitemid,isnull(max(fxinitemid),0) fxinitemid from
			(
				select t1.fitemid,
				case when left(t4.fnumber,1) in ('3','4','5','7','8') then t4.fitemid else 0 end fbanitemid,
				case when left(t4.fnumber,10) in ('1.01.0010.') then t4.fitemid else 0 end fxinitemid
				from t_icitem t1
				inner join icbom t2 on t1.fitemid=t2.fitemid
				inner join icbomchild t3 on t2.finterid=t3.finterid
				inner join t_icitem t4 on t3.fitemid=t4.fitemid
				where t1.fname not like '%禁用%' and t1.fdeleted=0 
				and left(t1.fnumber,4) in ('A.01','P.01','J.01','X.01','Y.01') 
			) t1 group by t1.fitemid
		) t2 on t1.fbanitemid=t2.fbanitemid and t1.fxinitemid=t2.fxinitemid
		left join t_icitem t3 on t3.fitemid=t1.fbanitemid
		left join t_icitem t4 on t4.fitemid=t1.fxinitemid

		if left(@fnumber,1) in ('V') and @FBaseItemID=0  --个性化产品，在傲威中性中找不到，则更新为价格引擎
		begin
			update t2 set F_126=40019,F_127=0
			from t_icitem t1
			inner join t_ICItemCustom t2 on t1.fitemid=t2.fitemid
			where t1.fitemid=@fitemid
		end

		if left(@fnumber,1) not in ('V') and @FBaseItemID=0  --非个性化产品(咖啡盒、白盒、STARINK)，在傲威中性中找不到，则必须要有傲威中性
		begin
			set @s='['+@fnumber+']请先在傲威中性资料中建立该[半成品+芯片]['+@fbannumber+'-'+@fxinnumber+']组合!'
			RAISERROR(@s,18,18)
		end

		if @FBaseItemID<>0
		begin
			update t2 set F_126=40020,F_127=@FBaseItemID
			from t_icitem t1
			inner join t_ICItemCustom t2 on t1.fitemid=t2.fitemid
			where t1.fitemid=@fitemid
		end
	end


	--套装
	update t12 set F_126=40019,F_127=0,F_143=t1.fqty
	from
	(
		select fitemid,sum(t1.fqty) fqty from
		(
			select t1.fitemid,t1.fnumber,t1.fname,t3.fqty
			from t_icitem t1
			inner join icbom t2 on t1.fitemid=t2.fitemid
			inner join icbomchild t3 on t2.finterid=t3.finterid
			inner join t_icitem t4 on t3.fitemid=t4.fitemid
			where t1.fitemid=@fitemid and t1.fname not like '%禁用%' and t1.fdeleted=0 
			and left(t1.fnumber,1) in ('v') and left(t4.fnumber,1) in ('3','4','5','7','8')
		) t1 group by t1.fitemid
		having sum(t1.fqty)>1 --or count(1)>1
	) t1 inner join t_ICItemCustom t12 on t1.fitemid=t12.fitemid
	inner join t_icitem t3 on t3.fitemid=t1.fitemid

	--外盒[规格型号]格式检查
	if exists(select 1
			from t_icitem t2
			inner join inserted t1 on t1.fitemid=t2.fitemid
			inner join icbomchild t3 on t1.finterid=t3.finterid
			inner join t_icitem t4 on t3.fitemid=t4.fitemid
			inner join t_measureunit t5 on t5.fitemid=t4.funitid
			inner join t_ICItemCustom AS t7 ON t2.FItemID = t7.FItemID
			where left(t2.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0)
			and left(t4.fnumber,4) in ('2.02','2.03','2.04') and t4.fmodel not like '%*%*%mm%')
	begin
		select @s=@s+','+m1.fnumber from
		(
			select distinct t4.fnumber
			from t_icitem t2
			inner join inserted t1 on t1.fitemid=t2.fitemid
			inner join icbomchild t3 on t1.finterid=t3.finterid
			inner join t_icitem t4 on t3.fitemid=t4.fitemid
			inner join t_measureunit t5 on t5.fitemid=t4.funitid
			inner join t_ICItemCustom AS t7 ON t2.FItemID = t7.FItemID
			where left(t2.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0)
			and left(t4.fnumber,4) in ('2.02','2.03','2.04') and t4.fmodel not like '%*%*%mm%'
		) m1

		set @s='以下外盒[规格型号]不符合指定格式['+@s+']'   --
		RAISERROR(@s,18,18)
	end

	--外箱[规格型号]格式检查
	if exists(select 1
			from t_icitem t2
			inner join inserted t1 on t1.fitemid=t2.fitemid
			inner join icbomchild t3 on t1.finterid=t3.finterid
			inner join t_icitem t4 on t3.fitemid=t4.fitemid
			inner join t_measureunit t5 on t5.fitemid=t4.funitid
			inner join t_ICItemCustom AS t7 ON t2.FItemID = t7.FItemID
			where left(t2.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0)
			and left(t4.fnumber,4) in ('2.01') and t4.fmodel not like '%*%*%cm%')
	begin
		select @s=@s+','+m1.fnumber from
		(
			select distinct t4.fnumber
			from t_icitem t2
			inner join inserted t1 on t1.fitemid=t2.fitemid
			inner join icbomchild t3 on t1.finterid=t3.finterid
			inner join t_icitem t4 on t3.fitemid=t4.fitemid
			inner join t_measureunit t5 on t5.fitemid=t4.funitid
			inner join t_ICItemCustom AS t7 ON t2.FItemID = t7.FItemID
			where left(t2.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0)
			and left(t4.fnumber,4) in ('2.01') and t4.fmodel not like '%*%*%cm%'
		) m1

		set @s='以下外箱[规格型号]不符合指定格式['+@s+']'   --
		RAISERROR(@s,18,18)
	end

	--修改此处时，记着修改查询分析工具的对应报表
	if exists(select 1
				from t_icitem t2 
				inner join inserted t11 on t11.fitemid=t2.fitemid --and t11.fusestatus=1072
				inner join icbomchild t12 on t11.finterid=t12.finterid
				inner join t_icitem t9 on t9.fitemid=t12.fitemid  --
				left join t_supplyentry t4 on t4.fitemid=t12.fitemid
				left join t_stock t5 on t5.fitemid=t9.fdefaultloc
				where t9.ferpclsid in (1,5) and isnull(t5.fname,'') not like '%代管%' and left(t9.fnumber,4) not in ('2.05','2.06','2.07')  --and t9.fname not like '%标签%'
				and t4.fitemid is null /*and t9.fplanprice=0*/)
	begin
		select @s=@s+','+m1.fnumber from
		(
			select distinct t9.fnumber
			from t_icitem t2 
			inner join inserted t11 on t11.fitemid=t2.fitemid --and t11.fusestatus=1072
			inner join icbomchild t12 on t11.finterid=t12.finterid
			inner join t_icitem t9 on t9.fitemid=t12.fitemid  --
			left join t_supplyentry t4 on t4.fitemid=t12.fitemid
			left join t_stock t5 on t5.fitemid=t9.fdefaultloc
			where t9.ferpclsid in (1,5) and isnull(t5.fname,'') not like '%代管%' and left(t9.fnumber,4) not in ('2.05','2.06','2.07')  --and t9.fname not like '%标签%'
			and t4.fitemid is null /*and t9.fplanprice=0*/
		) m1

		set @s='以下物料无采购单价['+@s+']'   --套件的子件
		RAISERROR(@s,18,18)
	end

-- 	select finterid,fname,* from t_submessage where ftypeid=504
-- 	
-- 	40122	全新自制黑色硒鼓
-- 	40123	全新自制彩色硒鼓
-- 	40124	再生自制硒鼓
-- 	40125	外调黑色硒鼓
-- 	40126	外调彩色硒鼓
-- 	40127	其它
-- 	40128	自制碳粉
-- 	
-- 	
-- 	update t6 set ftypeid=40127
-- 	from t_icitem t3 
-- 	inner join t_ICItemBase t6 on t6.fitemid=t3.fitemid
-- 	where  left(t3.fnumber,1) in ('r')

	--物料分类--先更新成其它
	update t6 set ftypeid= 40127
	from t_icitem t3 
	inner join inserted t1 on t1.fitemid=t3.fitemid
	inner join t_ICItemBase t6 on t6.fitemid=t3.fitemid
	where  left(t3.fnumber,1) in ('v')

	--物料分类--再按照条件更新
	update t6 set ftypeid=case when left(t5.fnumber,1)='3' then 40122 when left(t5.fnumber,1)='4' then 40123 when left(t5.fnumber,1)='5' then 40124
	                             when left(t5.fnumber,1)='7' then 40125 when left(t5.fnumber,1)='8' then 40126 end
	from t_icitem t3 
	inner join inserted t1 on t1.fitemid=t3.fitemid
	inner join icbomchild t2 on t1.finterid=t2.finterid
	inner join t_icitem t5 on t5.fitemid=t2.fitemid and left(t5.fnumber,1) in ('3','4','5','7','8')
	inner join t_ICItemBase t6 on t6.fitemid=t3.fitemid
	where  left(t3.fnumber,1) in ('a','p','j','x','y','v')

	--海关产品分类
	update t6 set F_108=t5.F_108
	from t_icitem t3 
	inner join inserted t1 on t1.fitemid=t3.fitemid
	inner join icbomchild t2 on t1.finterid=t2.finterid
	inner join t_icitem t5 on t5.fitemid=t2.fitemid and left(t5.fnumber,1) in ('3','4','5','7','8')
	inner join t_ICItemCustom t6 on t6.fitemid=t3.fitemid
	where left(t3.fnumber,1) in ('a','p','j','x','y','v') and isnull(t5.F_108,0)<>0

	--先更新成配件
	update t6 set F_108=412
	from t_icitem t3 
	inner join inserted t1 on t1.fitemid=t3.fitemid
	inner join t_ICItemCustom t6 on t6.fitemid=t3.fitemid
	where left(t3.fnumber,1) in ('r')

	update t6 set F_108=t5.F_108
	from t_icitem t3 
	inner join inserted t1 on t1.fitemid=t3.fitemid
	inner join icbomchild t2 on t1.finterid=t2.finterid
	inner join t_icitem t5 on t5.fitemid=t2.fitemid 
	inner join t_ICItemCustom t6 on t6.fitemid=t3.fitemid
	where left(t3.fnumber,1) in ('r') and isnull(t5.F_108,0)<>0

	update t12 set fname=t12.fname+'-鼓架'
	from t_icitem t3 
	inner join inserted t1 on t1.fitemid=t3.fitemid
	inner join icbomchild t2 on t1.finterid=t2.finterid
	inner join t_icitem t5 on t5.fitemid=t2.fitemid 
	inner join t_ICItemCore t6 on t6.fitemid=t3.fitemid
	inner join t_item t16 on t16.fitemid=t5.F_108 and t16.fitemclassid=3003
	inner join t_item t12 on t12.fitemid=t3.fitemid
	--inner join t_baseproperty t15 on t15.fitemid=t3.fitemid
	where left(t3.fnumber,1) in ('a','p','j','x','y','v') and isnull(t5.F_108,0)<>0 and t16.fname like '鼓架' and t12.fname not like '%鼓架%'
	and left(t5.fnumber,1) in ('3','4','5','7','8')
	--and isnull(t12.FChkUserID,0)<>0 --选择性加这个条件

	update t6 set fname=t6.fname+'-鼓架'
	from t_icitem t3 
	inner join inserted t1 on t1.fitemid=t3.fitemid
	inner join icbomchild t2 on t1.finterid=t2.finterid
	inner join t_icitem t5 on t5.fitemid=t2.fitemid 
	inner join t_ICItemCore t6 on t6.fitemid=t3.fitemid
	inner join t_item t16 on t16.fitemid=t5.F_108 and t16.fitemclassid=3003
	inner join t_item t12 on t12.fitemid=t3.fitemid
	--inner join t_baseproperty t15 on t15.fitemid=t3.fitemid
	where left(t3.fnumber,1) in ('a','p','j','x','y','v') and isnull(t5.F_108,0)<>0 and t16.fname like '鼓架' and t6.fname not like '%鼓架%'
	and left(t5.fnumber,1) in ('3','4','5','7','8')
	--and isnull(t12.FChkUserID,0)<>0 --选择性加这个条件

	update t12 set fname=t12.fname+'-粉筒'
	from t_icitem t3 
	inner join inserted t1 on t1.fitemid=t3.fitemid
	inner join icbomchild t2 on t1.finterid=t2.finterid
	inner join t_icitem t5 on t5.fitemid=t2.fitemid 
	inner join t_ICItemCore t6 on t6.fitemid=t3.fitemid
	inner join t_item t16 on t16.fitemid=t5.F_108 and t16.fitemclassid=3003
	inner join t_item t12 on t12.fitemid=t3.fitemid
	--inner join t_baseproperty t15 on t15.fitemid=t3.fitemid
	where left(t3.fnumber,1) in ('a','p','j','x','y','v') and isnull(t5.F_108,0)<>0 and t16.fname like '粉筒' and t12.fname not like '%粉筒%'
	and left(t5.fnumber,1) in ('3','4','5','7','8')
	--and isnull(t12.FChkUserID,0)<>0 --选择性加这个条件

	update t6 set fname=t6.fname+'-粉筒'
	from t_icitem t3 
	inner join inserted t1 on t1.fitemid=t3.fitemid
	inner join icbomchild t2 on t1.finterid=t2.finterid
	inner join t_icitem t5 on t5.fitemid=t2.fitemid 
	inner join t_ICItemCore t6 on t6.fitemid=t3.fitemid
	inner join t_item t16 on t16.fitemid=t5.F_108 and t16.fitemclassid=3003
	inner join t_item t12 on t12.fitemid=t3.fitemid
	--inner join t_baseproperty t15 on t15.fitemid=t3.fitemid
	where left(t3.fnumber,1) in ('a','p','j','x','y','v') and isnull(t5.F_108,0)<>0 and t16.fname like '粉筒' and t6.fname not like '%粉筒%'
	and left(t5.fnumber,1) in ('3','4','5','7','8')
	--and isnull(t12.FChkUserID,0)<>0 --选择性加这个条件

	--项目经理
	update t9 set F_128=t1.fheadselfz0134 
	from inserted t1
	inner join t_icitem t3 on t1.fitemid=t3.fitemid
	inner join t_ICItemCustom t9 on t9.fitemid=t1.fitemid

	--修改日期
	update t9 set flastmoddate=getdate()
	from inserted t1
	inner join t_icitem t3 on t1.fitemid=t3.fitemid
	inner join t_baseproperty t9 on t9.fitemid=t1.fitemid

-- 	--个性化产品价格引擎
-- 	update t5 set f_127=t2.fitemid
-- 	from
-- 	(
-- 		select fitemid,fbanitemid,fxinitemid ----个性化产品
-- 		from
-- 		(
-- 			select fitemid,max(fbanitemid) fbanitemid,max(fxinitemid) fxinitemid 
-- 			from
-- 			(
-- 				select t1.fitemid,	
-- 				case when left(t4.fnumber,1) in ('3','4','5','7','8') then t4.fitemid else 0 end fbanitemid,
-- 				case when left(t4.fnumber,10) in ('1.01.0010.') then t4.fitemid else 0 end fxinitemid
-- 				from inserted t1
-- 				inner join t_icitem t2 on t1.fitemid=t2.fitemid
-- 				inner join icbomchild t3 on t1.finterid=t3.finterid
-- 				inner join t_icitem t4 on t3.fitemid=t4.fitemid
-- 				where left(t2.fnumber,4) in ('v.b.')
-- 			) t1 group by t1.fitemid
-- 		) t1 where (t1.fbanitemid+t1.fxinitemid)>0
-- 	) t1
-- 	inner join
-- 	(
-- 		select fitemid,fbanitemid,fxinitemid ------傲威中性
-- 		from
-- 		(
-- 			select fitemid,max(fbanitemid) fbanitemid,max(fxinitemid) fxinitemid 
-- 			from
-- 			(
-- 				select t1.fitemid,	
-- 				case when left(t4.fnumber,1) in ('3','4','5','7','8') then t4.fitemid else 0 end fbanitemid,
-- 				case when left(t4.fnumber,10) in ('1.01.0010.') then t4.fitemid else 0 end fxinitemid
-- 				from icbom t1
-- 				inner join t_icitem t2 on t1.fitemid=t2.fitemid
-- 				inner join icbomchild t3 on t1.finterid=t3.finterid
-- 				inner join t_icitem t4 on t3.fitemid=t4.fitemid
-- 				where left(t2.fnumber,4) in ('a.01','p.01','j.01','x.01','y.01')
-- 			) t1 group by t1.fitemid
-- 		) t1 where (t1.fbanitemid+t1.fxinitemid)>0
-- 	) t2 on t1.fbanitemid=t2.fbanitemid and t1.fxinitemid=t2.fxinitemid
-- 	inner join t_icitem t3 on t1.fitemid=t3.fitemid
-- 	inner join t_icitem t4 on t2.fitemid=t4.fitemid
-- 	inner join t_ICItemCustom t5 on t1.fitemid=t5.fitemid

	--主供应商--物料
	update t9 set F_117=25952 
	from inserted t1
	inner join t_icitem t3 on t1.fitemid=t3.fitemid
	inner join icbomchild t5 on t1.finterid=t5.finterid
	inner join t_icitem t6 on t5.fitemid=t6.fitemid
	inner join t_ICItemCustom t9 on t9.fitemid=t1.fitemid
	where left(t6.fnumber,1) in ('3','4','5')
		
	update t9 set F_117=t7.fsupid 
	from inserted t1
	inner join t_icitem t3 on t1.fitemid=t3.fitemid
	inner join icbomchild t5 on t1.finterid=t5.finterid
	inner join t_icitem t6 on t5.fitemid=t6.fitemid
	inner join t_supplyentry t7 on t7.fitemid=t6.fitemid
	inner join (select fitemid,max(fentryid) fentryid from t_supplyentry group by fitemid) t8 on t7.fitemid=t8.fitemid and t7.fentryid=t8.fentryid
	inner join t_ICItemCustom t9 on t9.fitemid=t1.fitemid
	where left(t6.fnumber,1) in ('7','8')	
	
	--产品分级
	update t9 set F_136=t6.F_136
	from inserted t1
	inner join t_icitem t3 on t1.fitemid=t3.fitemid
	inner join icbomchild t5 on t1.finterid=t5.finterid
	inner join t_icitem t6 on t5.fitemid=t6.fitemid
	inner join t_ICItemCustom t9 on t9.fitemid=t1.fitemid
	--inner join t_Item_3018 t2 on t2.fitemid=177686 
	where left(t6.fnumber,1) in ('3','4','5','7','8') and left(t3.fnumber,1) not in ('R')	

	--主供应商--销售订单
	update t2 set fentryselfs0176=25952 
	from seorder t1
	inner join seorderentry t2 on t1.finterid=t2.finterid
	inner join t_icitem t3 on t2.fitemid=t3.fitemid
	inner join inserted t4 on t3.fitemid=t4.fitemid
	inner join icbomchild t5 on t4.finterid=t5.finterid
	inner join t_icitem t6 on t5.fitemid=t6.fitemid
	left join icmo t9 on t9.forderinterid=t2.finterid and t9.fsourceentryid=t2.fentryid
	where left(t6.fnumber,1) in ('3','4','5') and isnull(t9.fitemid,0)=0  --还没有生成任务单的自制品销售订单
			
	update t2 set fentryselfs0176=t7.fsupid --t3.F_117  
	from seorder t1
	inner join seorderentry t2 on t1.finterid=t2.finterid
	inner join t_icitem t3 on t2.fitemid=t3.fitemid
	inner join inserted t4 on t3.fitemid=t4.fitemid
	inner join icbomchild t5 on t4.finterid=t5.finterid
	inner join t_icitem t6 on t5.fitemid=t6.fitemid
	inner join t_supplyentry t7 on t7.fitemid=t6.fitemid
	inner join (select fitemid,max(fentryid) fentryid from t_supplyentry group by fitemid) t8 on t7.fitemid=t8.fitemid and t7.fentryid=t8.fentryid
	left join poorderentry t9 on t9.fsourceinterid=t2.finterid and t9.fsourceentryid=t2.fentryid and t9.fsourcetrantype=81
	where left(t6.fnumber,1) in ('7','8') and isnull(t9.fitemid,0)=0	--还没有生成采购订单的外调品销售订单
	
	--交付方式
	update t2 set fentryselfs0175=40089
	from seorder t1
	inner join seorderentry t2 on t1.finterid=t2.finterid
	inner join t_icitem t3 on t2.fitemid=t3.fitemid
	inner join inserted t4 on t3.fitemid=t4.fitemid
	inner join icbomchild t5 on t4.finterid=t5.finterid
	inner join t_icitem t6 on t5.fitemid=t6.fitemid
	left join icmo t9 on t9.forderinterid=t2.finterid and t9.fsourceentryid=t2.fentryid
	where left(t6.fnumber,1) in ('3','4','5') and isnull(t9.fitemid,0)=0  --还没有生成任务单的自制品销售订单
			
	update t2 set fentryselfs0175=40090 
	from seorder t1
	inner join seorderentry t2 on t1.finterid=t2.finterid
	inner join t_icitem t3 on t2.fitemid=t3.fitemid
	inner join inserted t4 on t3.fitemid=t4.fitemid
	inner join icbomchild t5 on t4.finterid=t5.finterid
	inner join t_icitem t6 on t5.fitemid=t6.fitemid
	left join poorderentry t9 on t9.fsourceinterid=t2.finterid and t9.fsourceentryid=t2.fentryid and t9.fsourcetrantype=81
	where left(t6.fnumber,1) in ('7','8') and isnull(t9.fitemid,0)=0	--还没有生成采购订单的外调品销售订单			
			
	--标准装箱数
	update t7 set F_110=round(cast(cast(1 as decimal(24,4))/t3.fqty as decimal(24,4)),0)
	from t_icitem t2
	inner join inserted t1 on t1.fitemid=t2.fitemid
	inner join icbomchild t3 on t1.finterid=t3.finterid
	inner join t_icitem t4 on t3.fitemid=t4.fitemid
	inner join t_measureunit t5 on t5.fitemid=t4.funitid
	inner join t_ICItemCustom AS t7 ON t2.FItemID = t7.FItemID
	where t4.fnumber like '2.01.%' and left(t2.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0)
	
	--单个净重=除掉彩盒、除掉纸箱的重量 
	update t4 set FNetWeight=t1.FNetWeight
	from  t_icitem t2
	inner join
	(
		select t2.fitemid,sum(t4.FNetWeight*t3.fqty) FNetWeight --单个
		from t_icitem t2
		inner join inserted t1 on t1.fitemid=t2.fitemid
		inner join icbomchild t3 on t1.finterid=t3.finterid
		inner join t_icitem t4 on t3.fitemid=t4.fitemid
		inner join t_measureunit t5 on t5.fitemid=t4.funitid
		where left(t2.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0)
		and left(t4.fnumber,4) not in ('2.01','2.02','2.03','2.04') 
		--and t2.fshortnumber='A00001'
		and t4.FNetWeight<>0
		group by t2.fitemid
	) t1 on t1.fitemid=t2.fitemid
	inner join t_ICItemCustom AS t7 ON t2.FItemID = t7.FItemID
	inner join t_ICItemDesign AS t4 ON t2.FItemID = t4.FItemID	
	
	--整箱净重(KG)	 -- 整箱净重=单个净重×装箱数
	update t7 set F_112=t2.FNetWeight*t2.F_110
	from t_icitem t2
	inner join t_ICItemCustom AS t7 ON t2.FItemID = t7.FItemID
	inner join t_ICItemDesign AS t4 ON t2.FItemID = t4.FItemID		
	inner join inserted t1 on t1.fitemid=t2.fitemid
	where left(t2.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0)
				
	--单个毛重=除掉纸箱的重量
	update t4 set FGrossWeight=t1.FNoBoxWeight
	from  t_icitem t2
	inner join
	(
		select t2.fitemid,sum((case when left(t4.fnumber,4) not in ('2.01') then t4.FNetWeight else 0 end)*t3.fqty) FNoBoxWeight, --单个
				  sum((case when left(t4.fnumber,4) in ('2.01') then t4.FNetWeight else 0 end)) FBoxWeight --一个纸箱的重量
		from t_icitem t2
		inner join inserted t1 on t1.fitemid=t2.fitemid
		inner join icbomchild t3 on t1.finterid=t3.finterid
		inner join t_icitem t4 on t3.fitemid=t4.fitemid
		inner join t_measureunit t5 on t5.fitemid=t4.funitid
		where left(t2.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0)
		and t4.FNetWeight<>0 
		--and t2.fshortnumber='A00001'
		group by t2.fitemid
	) t1 on t1.fitemid=t2.fitemid
	inner join t_ICItemCustom AS t7 ON t2.FItemID = t7.FItemID
	inner join t_ICItemDesign AS t4 ON t2.FItemID = t4.FItemID
	
	--整箱毛重(KG)	     --整箱毛重=单个毛重*装箱数+单个纸箱重量
	update t7 set F_119=t2.FGrossWeight*t2.F_110+t1.FBoxWeight
	from  t_icitem t2
	inner join
	(
		select t2.fitemid,sum((case when left(t4.fnumber,4) not in ('2.01') then t4.FNetWeight else 0 end)*t3.fqty) FNoBoxWeight, --单个
				  sum((case when left(t4.fnumber,4) in ('2.01') then t4.FNetWeight else 0 end)) FBoxWeight --一个纸箱的重量
		from t_icitem t2
		inner join inserted t1 on t1.fitemid=t2.fitemid
		inner join icbomchild t3 on t1.finterid=t3.finterid
		inner join t_icitem t4 on t3.fitemid=t4.fitemid
		inner join t_measureunit t5 on t5.fitemid=t4.funitid
		where left(t2.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0)
		and t4.FNetWeight<>0 
		--and t2.fshortnumber='A00001'
		group by t2.fitemid
	) t1 on t1.fitemid=t2.fitemid
	inner join t_ICItemCustom AS t7 ON t2.FItemID = t7.FItemID
	inner join t_ICItemDesign AS t4 ON t2.FItemID = t4.FItemID	

	--标准外盒尺寸(MM)	     
	update t7 set F_111=substring(t4.fmodel,1,dbo.My_F_Charindex(t4.fmodel,'mm',1)-1)  
	from t_icitem t2
	inner join inserted t1 on t1.fitemid=t2.fitemid
	inner join icbomchild t3 on t1.finterid=t3.finterid
	inner join t_icitem t4 on t3.fitemid=t4.fitemid
	inner join t_measureunit t5 on t5.fitemid=t4.funitid
	inner join t_ICItemCustom AS t7 ON t2.FItemID = t7.FItemID
	where left(t2.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0)
	and left(t4.fnumber,4) in ('2.02','2.03','2.04') and t4.fmodel like '%*%*%mm%'
	
	select t7.fnumber, --先计算盒子体积
	cast(1*
	cast(cast(left(t7.F_111,CHARINDEX('*',t7.F_111)-1) as decimal(24,4))/10 as decimal(24,4))*
	cast(cast(substring(t7.F_111,CHARINDEX('*',t7.F_111)+1,charindex('*',t7.F_111,charindex('*',t7.F_111)+1)-CHARINDEX('*',t7.F_111)-1) as decimal(24,4))/10 as decimal(24,4))*
	cast(cast(substring(t7.F_111,charindex('*',t7.F_111,charindex('*',t7.F_111)+1)+1,len(t7.F_111)-charindex('*',t7.F_111,charindex('*',t7.F_111)+1)) as decimal(24,4))/10 as decimal(24,4)) as decimal(24,4)) 体积
	into #data
	from t_icitem t7
	inner join inserted t1 on t1.fitemid=t7.fitemid
	where left(t7.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0)
	and t7.F_111 like '%*%*%' and t7.F_111 not like '%0*0*0%'

	--外盒尺寸类别	  --按体积所属范围更新 大、中、小         
	update t7 set F_103= (case when t1.体积<=8000 then 395 when t1.体积>8000 and t1.体积<=13000 then 394 when t1.体积>13000 then 393 end)           
	from #data t1
	inner join t_icitem t2 on t1.fnumber=t2.fnumber
	inner join t_ICItemCustom AS t7 ON t2.FItemID = t7.FItemID
	
	select t2.fnumber,t2.fname,t2.fmodel,
	t4.fnumber fchildnumber,t4.fname fchildname,t4.fmodel fchildmodel,
	substring(t4.fmodel,1,dbo.My_F_Charindex(t4.fmodel,'cm',1)-1) fsize,t3.fqty
	into #bata
	from t_icitem t2
	inner join inserted t1 on t1.fitemid=t2.fitemid
	inner join icbomchild t3 on t1.finterid=t3.finterid
	inner join t_icitem t4 on t3.fitemid=t4.fitemid
	inner join t_measureunit t5 on t5.fitemid=t4.funitid
	where left(t2.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0)
	and t4.fnumber like '2.01.%' and t4.fmodel like '%*%*%cm%'
	
	select t1.fnumber,cast(cast(cast(substring(t1.fsize,1,dbo.My_F_CharIndex(t1.fsize,'*',1)-1) as decimal(24,4))*10 as int) as varchar)+'*'+
	cast(cast(cast(substring(t1.fsize,dbo.My_F_CharIndex(t1.fsize,'*',1)+1,(dbo.My_F_CharIndex(t1.fsize,'*',2)-dbo.My_F_CharIndex(t1.fsize,'*',1)-1)) as decimal(24,4))*10 as int) as varchar)+'*'+
	cast(cast(cast(substring(t1.fsize,dbo.My_F_CharIndex(t1.fsize,'*',2)+1,len(t1.fsize)-(dbo.My_F_CharIndex(t1.fsize,'*',2)-1))  as decimal(24,4))*10 as int) as varchar) fsize ,
	cast(cast(cast(substring(t1.fsize,1,dbo.My_F_CharIndex(t1.fsize,'*',1)-1) as decimal(24,4))*10 as int) as varchar) flength,
	cast(cast(cast(substring(t1.fsize,dbo.My_F_CharIndex(t1.fsize,'*',1)+1,(dbo.My_F_CharIndex(t1.fsize,'*',2)-dbo.My_F_CharIndex(t1.fsize,'*',1)-1)) as decimal(24,4))*10 as int) as varchar) fwidth,
	cast(cast(cast(substring(t1.fsize,dbo.My_F_CharIndex(t1.fsize,'*',2)+1,len(t1.fsize)-(dbo.My_F_CharIndex(t1.fsize,'*',2)-1))  as decimal(24,4))*10 as int) as varchar) fheight 
	into #size
	from #bata t1
	inner join t_icitem t4 on t1.fnumber=t4.fnumber

	--select * from #size

	--标准外箱尺寸(MM)	     
	update t7 set F_109=t1.fsize
	from #size t1
	inner join t_icitem t4 on t1.fnumber=t4.fnumber
	inner join t_ICItemCustom AS t7 ON t4.FItemID = t7.FItemID
	inner join t_ICItemDesign t2 on t2.fitemid=t4.fitemid

	update t2 set FLength=t1.FLength, FWidth=t1.FWidth, FHeight=t1.FHeight
	from #size t1
	inner join t_icitem t4 on t1.fnumber=t4.fnumber
	inner join t_ICItemCustom AS t7 ON t4.FItemID = t7.FItemID
	inner join t_ICItemDesign t2 on t2.fitemid=t4.fitemid	
	
	update t6 set flastmoddate=getdate()
	from t_icitem t1 
	inner join inserted t2 on t1.fitemid=t2.fitemid
	inner join t_baseproperty t6 on t6.fitemid=t1.fitemid

	----主供应商
	--update t7 set F_117=t4.F_117
	--from t_icitem t2
	--inner join inserted t1 on t1.fitemid=t2.fitemid
	--inner join icbomchild t3 on t1.finterid=t3.finterid
	--inner join t_icitem t4 on t3.fitemid=t4.fitemid
	--inner join t_ICItemCustom AS t7 ON t4.FItemID = t7.FItemID
	--where left(t4.fnumber,1) in ('7','8') 
	--and left(t2.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0)
		
	drop table #data	
	drop table #bata
	drop table #size

	--盒子标准费
	if left(@fnumber,1) in ('A','P','J','X','Y','V') 
	begin
		if not exists(	select 1  
						from t_icitem t2
						inner join inserted t1 on t1.fitemid=t2.fitemid
						inner join icbomchild t3 on t1.finterid=t3.finterid
						inner join t_icitem t4 on t3.fitemid=t4.fitemid
						--inner join t_ICItemCustom AS t7 ON t2.FItemID = t7.FItemID
						where left(t2.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0)
						and left(t4.fnumber,4) in ('2.02','2.03','2.04') )
		begin
			update t7 set F_138=0 --裸包
			from inserted t1 
			inner join t_ICItemCustom AS t7 ON t1.FItemID = t7.FItemID
		end
		else
		begin
			update t7 set F_138=cast((case when left(t4.fnumber,4) in ('2.02') then (select f_103 from t_Item_3012 where f_102=t2.F_103 and f_101=25955) --彩盒
										   when left(t4.fnumber,4) in ('2.03') then (select f_103 from t_Item_3012 where f_102=t2.F_103 and f_101=25953) --咖啡盒
										   when left(t4.fnumber,4) in ('2.04') then (select f_103 from t_Item_3012 where f_102=t2.F_103 and f_101=25954) --白盒
									  end) as decimal(24,2))
			from t_icitem t2
			inner join inserted t1 on t1.fitemid=t2.fitemid
			inner join icbomchild t3 on t1.finterid=t3.finterid
			inner join t_icitem t4 on t3.fitemid=t4.fitemid
			inner join t_ICItemCustom AS t7 ON t2.FItemID = t7.FItemID
			where left(t2.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0)
			and left(t4.fnumber,4) in ('2.02','2.03','2.04') 
		end
	end
end

set nocount off

go




--包装方式触发器--新增、更新
IF EXISTS (select * from sysobjects where name='My_Tri_t_Item_3002_In'  and xtype='TR')  drop  TRIGGER My_Tri_t_Item_3002_In
go

Create TRIGGER My_Tri_t_Item_3002_In
            ON t_Item_3002
for insert

AS
BEGIN
	SET NOCOUNT ON
	declare @fshortnumber varchar(50),@fitemid int,@fname varchar(2000),@fitemclassid INT,@fdetail int
	select top 1 @fshortnumber=substring(fnumber,5,5),@fitemid=fitemid,@fname=fname from INSERTED

	if exists (select 1 from t_Item_3002 t1 where substring(fnumber,5,5)=@fshortnumber and fitemid<>@fitemid ) 
	begin
		--create table t11(fitemid int,fitemclassid int,fdetail int,fshortnumber varchar(20),fname varchar(200))  
		--select * from t11 drop table t11  --delete from t11
		--insert into t11(fitemid,fitemclassid,fdetail,fshortnumber,fname) values (@fitemid,@fitemclassid,@fdetail,@fshortnumber,@fname)

		RAISERROR('包装方式短代码重复!',18,18)
		rollback tran
	end

	if exists (select 1 from t_Item_3002 t1 where fname=@fname and fitemid<>@fitemid ) 
	begin
		RAISERROR('包装方式名称重复!',18,18)
		rollback tran
	end

end

go

--基础资料表触发器--新增、更新
/*
IF EXISTS (select * from sysobjects where name='My_Tri_Item_In'  and xtype='TR')  drop  TRIGGER My_Tri_Item_In

Create TRIGGER My_Tri_Item_In
            ON t_Item
for insert

AS
BEGIN
	SET NOCOUNT ON
	declare @fshortnumber varchar(50),@fitemid int,@fname varchar(2000),@fitemclassid INT
	select top 1 @fshortnumber=fshortnumber,@fitemid=fitemid,@fname=fname,@fitemclassid=fitemclassid from INSERTED

	IF @fitemclassid=3002
	begin
		if exists (select 1 from t_item t1 where fitemclassid=3002 and fdetail=1 and fshortnumber=@fshortnumber and fitemid<>@fitemid ) --and len(fshortnumber)=6
		begin
			RAISERROR('包装方式短代码重复!',18,18)
			rollback tran
		end

		if exists (select 1 from t_item t1 where fitemclassid=3002 and fdetail=1 and fname=@fname and fitemid<>@fitemid ) --and len(fshortnumber)=6
		begin
			RAISERROR('包装方式名称重复!',18,18)
			rollback tran
		end
	end
end
*/
go


/*
select * from t_submestype  
select finterid,fname,* from t_submessage where ftypeid=10007
40043	常规物料
40044	包装材料

select finterid,fname,* from t_submessage where ftypeid=10003
40019	是
40016	否
*/

--暂未使用
--生成计划投料单--按物料排序--自制成品涉及到的包材、BOM物料,要分别生成
--My_p_GeneratePlanChangeStock 1851,40043,16394,0  --
IF EXISTS (select * from sysobjects where name='My_p_GeneratePlanChangeStock' and xtype='p')  drop  procedure My_p_GeneratePlanChangeStock

go

create procedure My_p_GeneratePlanChangeStock(@fsourceinterid int,@fuserid int,@ftype int,@InterID int output)

as

set nocount on

--declare @fsourceinterid int,@fuserid int,@InterID int  select @fsourceinterid=1851,@fuserid=16394,@InterID=0

declare @funitid int,@entryid int,@fqty decimal(24,2),@fsourcebillno varchar(50),@fsourceentryid int
declare @BillNo varchar (20),@fpackinterid int,@fchildqty decimal(24,2),@fbomqty decimal(24,2),@bHaveExists bit
DECLARE @TmpID INT ,@FBomInterID int,@flevel varchar(20),@fprepscrap decimal(24,4),@fprepscrapqty decimal(24,2)
declare @iLength int,@fserial varchar(20),@fstockid int,@fchilditemid int,@fhavechild bit,@fscrap decimal(24,4)
declare @fprojectval  varchar(200),@ferpclsname varchar(20),@fperqty decimal(24,2),@fpacksubid int,@fbilltype int
declare @FDateFormat  varchar(200),@fdate datetime,@s varchar(2000),@fsupplyid int,@fscrapqty decimal(24,4)
declare @FNumber varchar(200),@FChildNumber varchar(200),@FName varchar(200),@FChildName varchar(200)
declare @FUnit varchar(200),@FMachinePos varchar(200),@FNote varchar(200),@FPage varchar(200),@ffacdate datetime

select @fdate=replace(convert(varchar(10),getdate(),111),'/','-'),@fhavechild=0
declare @fitemid int,@fcontactno varchar(20),@flag int

select @fsourcebillno=fbillno,@ffacdate=null from seorder where finterid=@fsourceinterid

if exists(select 1 from icmo where forderinterid=@fsourceinterid)
begin
	delete t1
	from t_BOSPlanChangeStock t1
	inner join t_BOSPlanChangeStockEntry t2 on t1.fid=t2.fid
	where t2.FID_SRC=@fsourceinterid

	delete t2
	from t_BOSPlanChangeStockEntry t2 
	where t2.FID_SRC=@fsourceinterid

	return  --已经下了任务单就不再生成计划投料单,且把原来的计划投料单删除
end

/*
if exists (select 1 from t_BOSPlanChangeStockEntry t1 inner join t_BOSPlanChangeStock t2 on t1.fid=t2.fid 
where t1.FID_SRC=@fsourceinterid and isnull(t2.fchecker,0)<>0)
begin
	RAISERROR('关联计划投料单已经审核!',18,18)
end


if exists (select 1 from t_BOSPlanChangeStockEntry t1 inner join t_BOSPlanChangeStock t2 on t1.fid=t2.fid 
where t1.FID_SRC=@fsourceinterid and isnull(t1.fcommitqty,0)>0)
begin
	RAISERROR('关联计划投料单部分已经调拨!',18,18)
end
*/

create table #temp(ftype int,fsourcetrantype varchar(50),fsourcebillno varchar(20),
fsourceinterid int,fsourceentryid int,fitemid int,ferr varchar(1000))
--ftype 1 生产计划有未排数 2 采购申请单未关闭 3 收料计划有未排数 4 未配置半成品 5 未配置芯片 6 未做包装方案 7 未做BOM

insert into #temp(ftype,fsourcetrantype,fsourcebillno,fsourceinterid,fsourceentryid,fitemid,   ferr)
select            1,    '销售订单',     t7.fbillno,   t1.finterid,   t1.fentryid   ,t1.fitemid,'未配置半成品'
from seorderentry t1 
inner join seorder t7 on t1.finterid=t7.finterid
inner join t_icitem t2 on t1.fitemid=t2.fitemid 
--left join (select forderinterid,fsourceentryid,sum(fqty) fqty from icmo t1 group by forderinterid,fsourceentryid) t8 on t1.finterid=t8.forderinterid and t1.fentryid=t8.fsourceentryid
left join t_icitem t9 on t9.fitemid=t1.fentryselfs0164  --半成品
where t7.finterid=@fsourceinterid
and t1.fmrpclosed<>1 --行业务未关闭
and (t7.fstatus>0 or isnull(t7.FMultiCheckLevel1,0)>0) --一审或者已经审核
and (t2.fnumber like 'A.%' or t2.fnumber like 'P.%')  
and t2.ferpclsid=2 and isnull(t9.fitemid,0)=0 
and isnull(t7.FHeadSelfS0147,0) not in (40032,40033) --40032	样品订单-收费 40033	样品订单-免费
and isnull(t1.FEntrySelfS0175,0) not in (40090,40091) --40089	自产自包,40090	外调自包,40091	外调外包
--and not exists (select 1 from icmo where forderinterid=t7.finterid)

insert into #temp(ftype,fsourcetrantype,fsourcebillno,fsourceinterid,fsourceentryid,fitemid,   ferr)
select            2,    '销售订单',     t7.fbillno,   t1.finterid,   t1.fentryid   ,t1.fitemid,'未配置芯片'
from seorderentry t1 
inner join seorder t7 on t1.finterid=t7.finterid
inner join t_icitem t2 on t1.fitemid=t2.fitemid 
left join t_item t13 on t13.fitemid=t1.fentryselfs0160 and t13.fitemclassid=3006 --芯片版本  --16465  无芯片
left join t_icitem t10 on t10.fitemid=t1.fentryselfs0161  --芯片
where t7.finterid=@fsourceinterid 
and t1.fmrpclosed<>1 --行业务未关闭
and (t7.fstatus>0 or isnull(t7.FMultiCheckLevel1,0)>0) --一审或者已经审核
and (t2.fnumber like 'A.%' or t2.fnumber like 'P.%')  
and isnull(t13.fitemid,0)<>16465 and isnull(t10.fitemid,0)=0 
and isnull(t1.FEntrySelfS0175,0) not in (40090,40091) --40089	自产自包,40090	外调自包,40091	外调外包
--and isnull(t7.FHeadSelfS0147,0) not in (40032,40033) --40032	样品订单-收费 40033	样品订单-免费
--and not exists (select 1 from icmo where forderinterid=t7.finterid)

select @s='',@fbilltype=0,@fsourcebillno=fbillno from seorder where finterid=@fsourceinterid

--/*
if @fbilltype=0
begin
	if exists (select 1 from #temp t2 inner join t_icitem t4 on t4.fitemid=t2.fitemid)
	begin
		select @s=@s+','+m1.fnumber from
		(
			select distinct t4.fnumber
			from #temp t2 
			inner join t_icitem t4 on t4.fitemid=t2.fitemid
		) m1

		set @s='销售订单['+@fsourcebillno+']产品['+@s+']未配置芯片或半成品!'


		RAISERROR(@s,18,18)
	end
end
--*/

--如果已经存在，则沿用原单据ID
if exists(select 1 from t_BOSPlanChangeStockEntry t1 inner join t_BOSPlanChangeStock t2 on t1.fid=t2.fid where t2.fbilltype=@fbilltype and t1.FID_SRC=@fsourceinterid)
begin
	set @bHaveExists=1
	select top 1 @InterID=t1.fid from t_BOSPlanChangeStockEntry t1 inner join t_BOSPlanChangeStock t2 on t1.fid=t2.fid where t2.fbilltype=@fbilltype and t1.FID_SRC=@fsourceinterid

	--40019	是  40020	否
	--把没有出库的删掉重新生成，如果有出库或者行业无关闭的,则该分录的所有包材都不删除--前台判断如果已经生成则不执行，除非刷新
	delete t2
	from t_BOSPlanChangeStock t1
	inner join t_BOSPlanChangeStockEntry t2 on t1.fid=t2.fid
	where t2.FID=@InterID
--	and t2.FEntryID_SRC not in 
--	(
--		select distinct t1.FEntryID_SRC 
--		from t_BOSPlanChangeStockEntry t1 
--		where t1.fid=@InterID and (isnull(t2.folditemid,0)>0 or isnull(t1.fcommitqty,0)>0 or isnull(t1.fmrpclosed,0)=40019)
--	)
end
else
begin
	set @bHaveExists=0
	exec GetICMaxNum 't_BOSPlanChangeStock', @InterID output
end


Create Table #Mutidata     (  FIndex int IDENTITY,FEntryID INT, FBomInterid int, FItemID int null, FNeedQty decimal(28,14) default(0) null, FBOMLevel int null, 
FItemType int null, FParentID int default(0)null, FRate   decimal(28,14) default(0) null, FHistory int default(0) null, FHaveMrp smallint default(0) null, 
FLevelString varchar(300) null, FBom int, FMaterielType int  default(371) null,FOperSN Int NULL DEFAULT(0),FOperID int default(0)) 
 
Create Table #MutiParentItem(  FIndex int IDENTITY,FEntryID INT default(0), FBomInterid int, FItemID int null, FNeedQty decimal(28,14) default(0) null, FBOMLevel 
int null, FItemType int null,  FParentID int default(0)null, FRate   decimal(28,14) default(0) null, FHistory int default(0) null, FHaveMrp smallint default(0) 
null, FLevelString varchar(300) null , FBom int, FMaterielType int  default(371) null,FOperSN Int NULL DEFAULT(0),FOperID int default(0)) 

Create Table #Errors ( FIndex int IDENTITY, FType smallint default(0), FErrText nvarchar(655) )

Create Table #Data (fsourceentryid int,fscrap decimal(24,2),fscrapqty decimal(24,2),fproductid int,
fproductqty decimal(24,2),fstockid int,fsourceinterid int,
fperqty decimal(24,2),fbomqty decimal(24,2),fitemid int,fqty decimal(24,2),ftype int)

--exec GetICMaxNum 't_BOSPlanChangeStock', @InterID output

insert into #Data(fstockid,      fsourceinterid, fsourceentryid, fscrap, fscrapqty,fproductid,  fproductqty,  fperqty,fbomqty,  fitemid,   fqty,   ftype) 
select            t9.fdefaultloc,t1.finterid,    t1.fentryid,    0,      0,        t1.fitemid,  t1.fqty,      1,      t1.fqty,  t9.fitemid,t1.fqty,0         
from seorderentry t1 
inner join seorder t7 on t1.finterid=t7.finterid
inner join t_icitem t2 on t1.fitemid=t2.fitemid 
inner join t_measureunit t3 on t3.fitemid=t2.funitid
inner join t_icitem t9 on t9.fitemid=t1.fentryselfs0164  --半成品
where t1.finterid=@fsourceinterid 
and left(t2.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0)

insert into #Data(fstockid,      fsourceinterid, fsourceentryid, fscrap, fscrapqty,fproductid,  fproductqty,  fperqty,fbomqty,  fitemid,   fqty,   ftype) 
select            t9.fdefaultloc,t1.finterid,    t1.fentryid,    0,      0,        t1.fitemid,  t1.fqty,      1,      t1.fqty,  t9.fitemid,t1.fqty,0         
from seorderentry t1 
inner join seorder t7 on t1.finterid=t7.finterid
inner join t_icitem t2 on t1.fitemid=t2.fitemid 
inner join t_measureunit t3 on t3.fitemid=t2.funitid
inner join t_icitem t9 on t9.fitemid=t1.fentryselfs0161  --芯片
where t1.finterid=@fsourceinterid 
and left(t2.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0)

insert into #Data(fstockid,      fsourceinterid, fsourceentryid, fscrap,     fscrapqty,         fproductid,  fproductqty,  fperqty,  fbomqty,           fitemid,   fqty,                              ftype) 
select            t9.fdefaultloc,t1.finterid,    t1.fentryid,    t12.fscrap, t1.fqty*t12.fscrap,t1.fitemid,  t1.fqty,      t12.fqty, t1.fqty*t12.fqty,  t9.fitemid,t1.fqty*t12.fqty*(1+t12.fscrap/100),0         
from seorderentry t1 
inner join seorder t7 on t1.finterid=t7.finterid
inner join t_icitem t2 on t1.fitemid=t2.fitemid 
inner join t_measureunit t3 on t3.fitemid=t2.funitid
inner join icbom t11 on t11.fitemid=t1.fitemid and t11.fusestatus=1072
inner join icbomchild t12 on t11.finterid=t12.finterid
inner join t_icitem t9 on t9.fitemid=t12.fitemid  --非硒鼓成品的BOM物料
where t1.finterid=@fsourceinterid 
and left(t2.fnumber,1) not in (select fitemtype from v_myitemtype where ftype=0)

insert into #Data(fstockid,      fsourceinterid, fsourceentryid, fscrap, fscrapqty,fproductid,  fproductqty,  fperqty,  fbomqty,           fitemid,   ftype,fqty) 
select            t9.fdefaultloc,t1.finterid,    t1.fentryid,    0,      0,        t1.fitemid,  t1.fqty,      t12.fqty, t1.fqty*t12.fqty,  t9.fitemid,0,    (case when left(t9.fnumber,5)='2.01.' then ceiling(t1.fqty*t12.fqty*(1+0/100)) else t1.fqty*t12.fqty*(1+0/100) end)         	
from seorderentry t1 
inner join seorder t7 on t1.finterid=t7.finterid
inner join t_icitem t2 on t1.fitemid=t2.fitemid 
inner join t_measureunit t3 on t3.fitemid=t2.funitid
inner join icbom t11 on t11.fitemid=t1.fitemid 
inner join icbomchild t12 on t11.finterid=t12.finterid
inner join t_icitem t9 on t9.fitemid=t12.fitemid  --包材
where t1.finterid=@fsourceinterid  and t9.fnumber like '2.%'


/*--销售订单直接买原材料的--不放在计划投料中，因为这些是要做销售出库的，如果做在计划投料单中，则重复出库了,MRP计算时已经考虑
insert into #Data(fstockid,      fsourceinterid,fsourceentryid,fscrap,fscrapqty,fproductid,fproductqty,fperqty,fbomqty,fitemid,   fqty,   ftype) 
select            t3.FDefaultLoc,t4.finterid,   t4.fentryid,   0,     0,        t4.fitemid,t4.fqty,    1,      t4.fqty,t4.fitemid,t4.fqty,0
from seorderentry t4 
inner join seorder t5  on t5.finterid=t4.finterid
inner join t_icitem t3 on t3.fitemid=t4.fitemid
where t3.ferpclsid=1 and t5.finterid =@fsourceinterid  --可能外购成品
*/

--取得计划投料单最大ID
select @entryid=isnull(max(t1.findex),0)+1 from t_BOSPlanChangeStockEntry t1 where t1.fid=@InterID

DECLARE Seorder_Cursor2 CURSOR FOR
select isnull(t2.fdefaultloc,0) fstockid,t1.fsourceentryid,t1.fqty,t1.fproductid,t1.fbomqty,t1.fperqty,t1.fitemid,t2.funitid,t1.fscrap,t1.fbomqty*t1.fscrap/100
from #Data t1
inner join t_icitem t2 on t1.fitemid=t2.fitemid
--and t1.fsourceentryid not in --原来已经有发料的就没有删掉
--(
--	select distinct t1.FEntryID_SRC 
--	from t_BOSPlanChangeStockEntry t1 
--	where t1.fid=@InterID and (isnull(t1.folditemid,0)>0 or isnull(t1.fcommitqty,0)>0 or isnull(t1.fmrpclosed,0)=40019)
--)
order by t2.fnumber

OPEN Seorder_Cursor2

FETCH NEXT FROM Seorder_Cursor2 
INTO @FStockID,@fsourceentryid,@fqty,@fitemid,@fbomqty,@fperqty,@fchilditemid,@funitid,@fscrap,@fscrapqty

WHILE @@FETCH_STATUS = 0
BEGIN
	INSERT INTO t_BOSPlanChangeStockEntry(fsupplyid,  fproductid,fscrap, fscrapqty,  fitemid,      FID,     FIndex,  FQty, fperqty, fbomqty, funitid, FStockID, FRemark,FBillNo_SRC,   FClassID_SRC,FCommitQty,FID_SRC,        FEntryID_SRC) 
	Values(							      0,          @fitemid,  @fscrap,@fscrapqty, @fchilditemid,@InterID,@entryid,@FQty,@fperqty,@fbomqty,@funitid,@FStockID,'',     @fsourcebillno,-81,         0,         @fsourceinterid,@fsourceentryid)

	set @entryid=@entryid+1
	set @fhavechild=1

    FETCH NEXT FROM Seorder_Cursor2 
    INTO @FStockID,@fsourceentryid,@fqty,@fitemid,@fbomqty,@fperqty,@fchilditemid,@funitid,@fscrap,@fscrapqty
END

CLOSE Seorder_Cursor2
DEALLOCATE Seorder_Cursor2

if @bHaveExists=0
begin
	-- 10.4
	Update t_BillCodeRule Set FReChar = FReChar Where FBillTypeID =200000001

	SET @TmpID = (SELECT FID FROM t_BillCodeRule WITH(READUNCOMMITTED) WHERE fbilltypeid=200000001 and fprojectid=3)

	update t_billcoderule set fprojectval = fprojectval+1,flength=case when (flength-len(fprojectval)) >= 0 then flength else len(fprojectval) end where FID =  @TmpID 
	Update ICBillNo Set FCurNo = (select top 1 isnull(fprojectval,1) from t_billcoderule where fprojectid = 3 and fbilltypeid =200000001) where fbillid = 200000001
	   
	--长度和目前编码
	select @fprojectval=(fprojectval-1),@iLength=flength from t_BillCodeRule where fprojectid = 3 and fbilltypeid = 200000001
	  
	--日期
	--select fprojectval,GetDate() AS DateNow from t_BillCodeRule where fprojectid = 2 and fbilltypeid = 100
	  --  sDateFormat = tempRs.Fields(fprojectval)
	  --  sDateFormat = Format(DateValue(tempRs.Fields(DateNow)), sDateFormat)

	-- 前缀
	select @BillNo=fprojectval+left('0000000000',@iLength-(len(@fprojectval)))+@fprojectval from t_BillCodeRule where fprojectid = 1 and fbilltypeid = 200000001  --@iLength

	INSERT INTO t_BOSPlanChangeStock(fbilltype, fsebillno,      FID,     FClassTypeID,FBillNo,FDate,  FBiller, FChecker,  FNOTE) 
	Values(                          @fbilltype,@fsourcebillno, @InterID,200000001,   @BillNo,@fdate, @fuserid,0       ,  '')

	--EXEC p_UpdateBillRelateData 200000001,@interid

	--set @fresultbillno=@fresultbillno+@billno

--	declare @frunid int
--	set @frunid=0
--	select top 1 @frunid=frunid from my_t_MrpSeOrder where forderinterid=@fsourceinterid and fselect=1 and ftype=@fbilltype order by frunid desc
--
--	update t1 set frunid=@frunid from t_BOSPlanChangeStock t1 where t1.FID=@InterID
end 

update m2 set fnooutstockqty=m2.fqty-m2.FCommitQty
from t_BOSPlanChangeStockEntry m2 
inner join t_BOSPlanChangeStock m3 on m2.fid=m3.fid
where m3.fid=@InterID

delete t2 from t_BOSPlanChangeStock t2 where fid not in (select fid from t_BOSPlanChangeStockEntry)

set nocount off

GO


--投料单触发器--成本对象/未领数量
IF EXISTS (select * from sysobjects where name='My_PPBom_Update'  and xtype='TR')  drop  TRIGGER My_PPBom_Update
go

create trigger My_PPBom_Update on ppbom
for insert,update
as
set nocount on

declare @fstatus int,@finterid int
select @finterid=finterid from inserted

update m2 set FHeadSelfY0226=m1.fnote
from ppbom m2 
inner join icmo m1 on m1.finterid=m2.ficmointerid
inner join inserted m3 on m2.finterid=m3.finterid

--/*
update m2 set FEntrySelfY0257=m1.fcostobjid --FEntrySelfY0257=m2.FAuxQtyMust-m2.FAuxQty
from ppbomentry m2 
inner join inserted m3 on m2.finterid=m3.finterid
inner join icmo m1 on m1.finterid=m2.ficmointerid
--*/

go


----出入库表K3自带触发器--删除
--IF EXISTS (select * from sysobjects where name='ICStockBill_DEL'  and xtype='TR')  drop  TRIGGER ICStockBill_DEL
--go
--
--Create TRIGGER [dbo].ICStockBill_DEL
--            ON [dbo].[ICStockBill]
--FOR DELETE
--AS
--begin
--    SET NOCOUNT ON
--	declare @finterid int,@fstatus int,@ftrantype int
--    select top 1 @finterid=finterid,@fstatus=fstatus,@ftrantype=ftrantype from DELETED
--
--    IF EXISTS (SELECT 1 FROM DELETED WHERE FCheckerID <> 0)
--    BEGIN
--        ROLLBACK TRAN
--        RAISERROR('不能删除已经审核的单据!',18,18)
--    END
--    ELSE IF EXISTS (SELECT 1 FROM DELETED WHERE FCancellation = 1)
--    BEGIN
--        ROLLBACK TRAN
--        RAISERROR('不能删除已经作废的单据!',18,18)
--    END
--    ELSE
--	begin
--		/*
--		if @ftrantype=24 --更新计划投料单已关联数--放在反审核中
--		begin
--			update t1 set fcommitqty=t1.fcommitqty-isnull(t2.fqty,0),FNoOutStockQty=t1.FNoOutStockQty+isnull(t2.fqty,0)
--			from t_BOSPlanChangeStockEntry t1 --
--			inner join 
--			(
--				select t2.forderinterid,t2.fsourceentryid,t1.fitemid,sum(t1.fqty) fqty
--				from ICStockBillEntry t1 
--				inner join icmo t2 on t1.ficmointerid=t2.finterid
--				where t1.finterid=@finterid and t2.forderinterid<>0
--				group by t2.forderinterid,t2.fsourceentryid,t1.fitemid
--			) t2 on t1.FID_SRC=t2.forderinterid and t1.FEntryID_SRC=t2.fsourceentryid and t1.fitemid=t2.fitemid
--			--where isnull(t1.fmrpclosed,0)<>40019 
--		end
--
--		*/
--
----		IF @ftrantype=24  --更新任务单的领料状态   --select * from t_submessage where finterid in (40011,40012,40013)  select FHeadSelfJ0173 from icmo
----		BEGIN
----			update m2 set FHeadSelfJ0173=(case when fallcount=fallnocount then 40011 when FPartCount>0 then 40012 when fallcount=FAllYesCount then 40013 end) 
----			from
----			(
----				select t1.ficmointerid,
----				(select count(finterid) from PPBomEntry where ficmointerid=t1.ficmointerid) FAllCount,
----				(select count(finterid) from PPBomEntry where ficmointerid=t1.ficmointerid and fqty=0) FAllNoCount,
----				(select count(finterid) from PPBomEntry where ficmointerid=t1.ficmointerid and FQtyMust>FQty) FPartCount,
----				(select count(finterid) from PPBomEntry where ficmointerid=t1.ficmointerid and FQtyMust<=FQty) FAllYesCount
----				from (select distinct FICMOInterID from icstockbillentry where finterid=@FInterID) t1
----			) m1 inner join icmo m2 on m1.ficmointerid=m2.finterid
----		
----			/*
----			update m2 set FHeadSelfJ0173=(case when m1.fqty=0 then 40011 when (m1.fqty>0 and m1.fqtymust>m1.fqty) then 40012 when m1.fqtymust<=m1.fqty then 40013 end) 
----			from
----			(
----				select t1.ficmointerid,sum(t1.fqtymust) fqtymust,sum(t2.fqty) fqty
----				from PPBomEntry t1
----				left join 
----				(
----					select t1.ficmointerid,t1.fppbomentryid,sum(t1.fqty) fqty
----					from icstockbill t0 
----					inner join icstockbillentry t1 on t0.finterid=t1.finterid
----					inner join 
----					(	  select distinct t1.FICMOInterID 
----						  from icstockbillentry t1
----						  inner join deleted t3 on t3.finterid=t1.finterid
----					) t2 on t1.ficmointerid=t2.ficmointerid
----					where t0.ftrantype=24 
----					group by t1.ficmointerid,t1.fppbomentryid
----				) t2 on t1.ficmointerid=t2.ficmointerid and t1.fentryid=t2.fppbomentryid
----				group by t1.ficmointerid
----			) m1 inner join icmo m2 on m1.ficmointerid=m2.finterid
----			*/
----		end
--
--        DELETE E
--          FROM ICStockBillEntry E
--               INNER JOIN deleted D ON E.FInterID = D.FInterID
--	end
--end
--
--go


IF not EXISTS (select * from sysobjects where name='MyOrderPatchFile' and xtype='u')  --drop  Table MyOrderPatchFile
begin
	create table MyOrderPatchFile(fuserid int,finterid int,fbillno varchar(50),fdate datetime,
								  fname varchar(50),fnote varchar(500)) 
end

go

--发货通知单触发器--新增、更新

IF EXISTS (select * from sysobjects where name='My_Tri_SEOutStock'  and xtype='TR')  drop  TRIGGER My_Tri_SEOutStock
go

Create TRIGGER [dbo].My_Tri_SEOutStock ON [dbo].SEOutStock
FOR insert,UPDATE

AS
BEGIN
	SET NOCOUNT ON
	declare @FChecker int
	declare @finterid int,@s1 varchar(5000),@s2 varchar(5000)

	select top 1 @finterid=finterid from INSERTED 

	select @s1='',@s2=''

	--纯PCS数
	update x set x.FEntrySelfS0238=x.FQty*isnull(y.fqty,1)
	from SEOutStockEntry x left join 
			(
				select c.fitemid,isnull(sum(isnull(b.fqty,1)),1)  as fqty
				from icbom a inner join icbomchild b on a.finterid=b.finterid
									 inner join t_icitem c on a.fitemid=c.fitemid
									 inner join t_icitem d on b.fitemid=d.fitemid
				where left(d.fnumber,1) in ('3','4','5','7','8')
				group by c.fitemid
			) y on x.fitemid=y.fitemid
	inner join SEOutStock t1 on t1.finterid=x.finterid
	where x.finterid=@finterid --and t1.fdate>='2016-05-03'

	update t2 set fbatchno=t5.fbillno
	from inserted t1
	inner join seoutstockEntry t2 on t1.finterid=t2.finterid
	inner join seorderentry t4 on t4.finterid=t2.fsourceinterid and t4.fentryid=t2.fsourceentryid
	inner join seorder t5 on t5.finterid=t4.finterid 
	inner join t_icitem t3 on t3.fitemid=t2.fitemid
	where t3.FBatchManager=1

	/*
	select @s1=@s1+','+m1.fcustbillno,@s2=@s2+','+m1.forderbillno from
	(
		select distinct isnull(t5.fheadselfs0144,'') fcustbillno,t5.fbillno forderbillno
		from seoutstock t1
		inner join seoutstockEntry t2 on t1.finterid=t2.finterid
		inner join seorderentry t4 on t4.finterid=t2.fsourceinterid and t4.fentryid=t2.fsourceentryid
		inner join seorder t5 on t5.finterid=t4.finterid 
		where t1.finterid=@finterid
	) m1

	update t1 set fheadselfs0237=@s1,fheadselfs0244=@s2 from seoutstock t1 where finterid=@finterid
	*/
END

go


----计划投料单触发器--未调拨数/未出数
--IF EXISTS (select * from sysobjects where name='t_BOSPlanChangeStock_Update'  and xtype='TR')  drop  TRIGGER t_BOSPlanChangeStock_Update
--go
--
--create trigger t_BOSPlanChangeStock_Update on t_BOSPlanChangeStock
--after update
--as
--set nocount on
--
--declare @fstatus int,@finterid int
--select @finterid=fid from inserted
--
--update m2 set fnooutstockqty=m2.fqty-m2.FCommitQty
--from t_BOSPlanChangeStockEntry m2 
--inner join t_BOSPlanChangeStock m3 on m2.fid=m3.fid
--where m3.fid=@finterid
--
--go



IF not EXISTS (select * from sysobjects where name='MySeOrder' and xtype='u')  --drop  Table MySeOrder
begin
	create table MySeOrder(fuserid int,finterid int,fbillno varchar(50),fsebillno varchar(50),
    fpacknote varchar(500),fothernote1 varchar(500),fothernote2 varchar(500),fpaynote varchar(500),
	fcurrency varchar(20) default '',fcustid int,fsourcecyid int default 0) 
end

go

--alter table MySeOrder add fsourcecyid int default 0
--alter table MySeOrderEntry add fbgbrand varchar(50)

IF not EXISTS (select * from sysobjects where name='MySeOrderEntry' and xtype='u')  --drop  Table MySeOrderEntry
begin
	create table MySeOrderEntry(fuserid int,finterid int,
	fentryid int,fmapnumber varchar(50),fmapname varchar(300),fitemid int,
	fnudeprice decimal(24,4),fprice decimal(24,4),famount decimal(24,2),fmapitemid int default(0),
	fpackprice decimal(24,4),fqty decimal(24,2),fnote varchar(500),fsourceprice decimal(24,4),fbgbrand varchar(50)) 
end

go

IF EXISTS (select * from sysobjects where name='ICItemMapping' and xtype='u') and not EXISTS (select t1.id
from sysobjects t1 
inner join syscolumns t2 on t1.id=t2.id
where t1.name='ICItemMapping' and t1.xtype='u' and t2.name='fmapitemid')
begin
	alter table ICItemMapping add fmapitemid int default(0)

end

go



--生成塑胶子件收料申请单--按物料排序--自制成品涉及到的包材、BOM物料,要分别生成
--My_p_GeneratePlasticPoInStock 4609,16394,0,0  --select * from poorder where fbillno='xw-po1310040'
IF EXISTS (select * from sysobjects where name='My_p_GeneratePlasticPoInStock' and xtype='p')  drop  procedure My_p_GeneratePlasticPoInStock

go

create procedure My_p_GeneratePlasticPoInStock(@fsourceinterid int,@fuserid int,@ftype int,@InterID int output)

as

set nocount on

--declare @fsourceinterid int,@fuserid int,@InterID int,@ftype int  select @fsourceinterid=4609,@fuserid=16394,@InterID=0,@ftype=0

declare @funitid int,@entryid int,@fqty decimal(24,4),@fsourcebillno varchar(50),@fsourceentryid int
declare @BillNo varchar (20),@fpackinterid int,@fchildqty decimal(24,4),@fbomqty decimal(24,4),@bHaveExists bit
DECLARE @TmpID INT ,@FBomInterID int,@flevel varchar(20),@fprepscrap decimal(24,4),@fprepscrapqty decimal(24,4)
declare @iLength int,@fserial varchar(20),@fstockid int,@fchilditemid int,@fhavechild bit,@fscrap decimal(24,4)
declare @fprojectval  varchar(200),@ferpclsname varchar(20),@fperqty decimal(24,4),@fpacksubid int,@fbilltype int
declare @FDateFormat  varchar(200),@fdate datetime,@s varchar(2000),@fsupplyid int,@fscrapqty decimal(24,4)
declare @FNumber varchar(200),@FChildNumber varchar(200),@FName varchar(200),@FChildName varchar(200)
declare @FUnit varchar(200),@FMachinePos varchar(200),@FNote varchar(500),@FPage varchar(200),@ffacdate datetime
declare @fcostobjid int,@fproductqty decimal(24,4)
declare @fftaxamount decimal(24,2),@fftaxprice decimal(24,6),@ffprice decimal(24,6),@ffamount decimal(24,2)
declare @fprice decimal(24,6),@famount decimal(24,2),@ftaxprice decimal(24,6),@ftaxamount decimal(24,2)
declare @fcamount decimal(24,2),@fcprice decimal(24,6)
--declare @fcprices decimal(24,6)
select @fdate=replace(convert(varchar(10),getdate(),111),'/','-'),@fhavechild=0
declare @fitemid int,@fcontactno varchar(20),@flag int

select top 1 @fsourcebillno=t1.fbillno,@ffacdate=null 
from poorder t1 
inner join poorderentry t2 on t1.finterid=t2.finterid 
where t1.finterid=@fsourceinterid

--if exists(select 1 from icmo where forderinterid=@fsourceinterid)
--begin
--	delete t1
--	from t_BOSPlasticPoInStock t1
--	inner join t_BOSPlasticPoInStockEntry t2 on t1.fid=t2.fid
--	where t2.FID_SRC=@fsourceinterid
--
--	delete t2
--	from t_BOSPlasticPoInStockEntry t2 
--	where t2.FID_SRC=@fsourceinterid
--
--	return  --已经下了任务单就不再生成计划投料单,且把原来的计划投料单删除
--end

/*
if exists (select 1 from t_BOSPlasticPoInStockEntry t1 inner join t_BOSPlasticPoInStock t2 on t1.fid=t2.fid 
where t1.FID_SRC=@fsourceinterid and isnull(t2.fchecker,0)<>0)
begin
	RAISERROR('关联计划投料单已经审核!',18,18)
end


if exists (select 1 from t_BOSPlasticPoInStockEntry t1 inner join t_BOSPlasticPoInStock t2 on t1.fid=t2.fid 
where t1.FID_SRC=@fsourceinterid and isnull(t1.fcommitqty,0)>0)
begin
	RAISERROR('关联计划投料单部分已经调拨!',18,18)
end
*/

create table #temp(ftype int,fsourcetrantype varchar(50),fsourcebillno varchar(20),
fsourceinterid int,fsourceentryid int,fitemid int,ferr varchar(1000))
--ftype 1 生产计划有未排数 2 采购申请单未关闭 3 收料计划有未排数 4 未配置半成品 5 未配置芯片 6 未做包装方案 7 未做BOM

--insert into #temp(ftype,fsourcetrantype,fsourcebillno,fsourceinterid,fsourceentryid,fitemid,   ferr)
--select            1,    '销售订单',     t7.fbillno,   t1.finterid,   t1.fentryid   ,t1.fitemid,'未配置半成品'
--from seorderentry t1 
--inner join seorder t7 on t1.finterid=t7.finterid
--inner join t_icitem t2 on t1.fitemid=t2.fitemid 
----left join (select forderinterid,fsourceentryid,sum(fqty) fqty from icmo t1 group by forderinterid,fsourceentryid) t8 on t1.finterid=t8.forderinterid and t1.fentryid=t8.fsourceentryid
--left join t_icitem t9 on t9.fitemid=t1.fentryselfs0164  --半成品
--where t7.finterid=@fsourceinterid
--and t1.fmrpclosed<>1 --行业务未关闭
--and (t7.fstatus>0 or isnull(t7.FMultiCheckLevel1,0)>0) --一审或者已经审核
--and (t2.fnumber like 'A.%' or t2.fnumber like 'P.%')  
--and t2.ferpclsid=2 and isnull(t9.fitemid,0)=0 
----and isnull(t7.FHeadSelfS0147,0) not in (40032,40033) --40032	样品订单-收费 40033	样品订单-免费
--and isnull(t1.FEntrySelfS0175,0) not in (40090,40091) --40089	自产自包,40090	外调自包,40091	外调外包
----and not exists (select 1 from icmo where forderinterid=t7.finterid)

select @s='',@fbilltype=0,@fsourcebillno=fbillno,@fsupplyid=fsupplyid from poorder where finterid=@fsourceinterid

--
----/*
--if @fbilltype=0
--begin
--	if exists (select 1 from #temp t2 inner join t_icitem t4 on t4.fitemid=t2.fitemid)
--	begin
--		select @s=@s+','+m1.fnumber from
--		(
--			select distinct t4.fnumber
--			from #temp t2 
--			inner join t_icitem t4 on t4.fitemid=t2.fitemid
--		) m1
--
--		set @s='销售订单['+@fsourcebillno+']产品['+@s+']未配置芯片或半成品!'
--
--
--		RAISERROR(@s,18,18)
--	end
--end
----*/

--如果已经存在，则沿用原单据ID
if exists(select 1 from t_BOSPlasticPoInStockEntry t1 inner join t_BOSPlasticPoInStock t2 on t1.fid=t2.fid where t2.fbilltype=@fbilltype and t1.FID_SRC=@fsourceinterid)
begin
	set @bHaveExists=1
	select top 1 @InterID=t1.fid from t_BOSPlasticPoInStockEntry t1 inner join t_BOSPlasticPoInStock t2 on t1.fid=t2.fid where t2.fbilltype=@fbilltype and t1.FID_SRC=@fsourceinterid

	--40019	是  40020	否
	--把没有出库的删掉重新生成，如果有出库或者行业无关闭的,则该分录的所有包材都不删除--前台判断如果已经生成则不执行，除非刷新
	delete t2
	from t_BOSPlasticPoInStock t1
	inner join t_BOSPlasticPoInStockEntry t2 on t1.fid=t2.fid
	where t2.FID=@InterID
	and t2.FEntryID_SRC not in 
	(
		select distinct t1.FEntryID_SRC 
		from t_BOSPlasticPoInStockEntry t1 
		where t1.fid=@InterID and (isnull(t2.folditemid,0)>0 or isnull(t1.fcommitqty,0)>0 or isnull(t1.fmrpclosed,0)=40019)
	)
end
else
begin
	set @bHaveExists=0
	exec GetICMaxNum 't_BOSPlasticPoInStock', @InterID output
end

Create Table #Mutidata     (  FIndex int IDENTITY,FEntryID INT, FBomInterid int, FItemID int null, FNeedQty decimal(28,14) default(0) null, FBOMLevel int null, 
FItemType int null, FParentID int default(0)null, FRate   decimal(28,14) default(0) null, FHistory int default(0) null, FHaveMrp smallint default(0) null, 
FLevelString varchar(300) null, FBom int, FMaterielType int  default(371) null,FOperSN Int NULL DEFAULT(0),FOperID int default(0)) 
 
Create Table #MutiParentItem(  FIndex int IDENTITY,FEntryID INT default(0), FBomInterid int, FItemID int null, FNeedQty decimal(28,14) default(0) null, FBOMLevel 
int null, FItemType int null,  FParentID int default(0)null, FRate   decimal(28,14) default(0) null, FHistory int default(0) null, FHaveMrp smallint default(0) 
null, FLevelString varchar(300) null , FBom int, FMaterielType int  default(371) null,FOperSN Int NULL DEFAULT(0),FOperID int default(0)) 

Create Table #Errors ( FIndex int IDENTITY, FType smallint default(0), FErrText nvarchar(655) )

Create Table #Data (fsourceentryid int,fscrap decimal(24,2),fscrapqty decimal(24,4),fproductid int,
fproductqty decimal(24,4),fstockid int,fsourceinterid int,fprice decimal(24,4),
fperqty decimal(24,4),fbomqty decimal(24,4),fitemid int,fqty decimal(24,4),ftype int,FNote varchar(500))

--exec GetICMaxNum 't_BOSPlasticPoInStock', @InterID output

--insert into #Data(fstockid,      fsourceinterid, fsourceentryid, fscrap, fscrapqty,fproductid,  fproductqty,  fperqty,fbomqty,  fitemid,   fqty,   ftype) 
--select            t9.fdefaultloc,t1.finterid,    t1.fentryid,    0,      0,        t1.fitemid,  t1.fqty,      1,      t1.fqty,  t9.fitemid,t1.fqty,0         
--from seorderentry t1 
--inner join seorder t7 on t1.finterid=t7.finterid
--inner join t_icitem t2 on t1.fitemid=t2.fitemid 
--inner join t_measureunit t3 on t3.fitemid=t2.funitid
--inner join t_icitem t9 on t9.fitemid=t1.fentryselfs0164  --半成品
--where t1.finterid=@fsourceinterid 
--and left(t2.fnumber,1) in ('A','P')

insert into #Data(FNote,   fprice,   fstockid,      fsourceinterid, fsourceentryid, fscrap,     fscrapqty,         fproductid,  fproductqty,  fperqty,  fbomqty,           fitemid,   fqty,                              ftype) 
select            t1.fnote,t4.fprice,t9.fdefaultloc,t1.finterid,    t1.fentryid,    t12.fscrap, t1.fqty*t12.fscrap,t1.fitemid,  t1.fqty,      t12.fqty, t1.fqty*t12.fqty,  t9.fitemid,t1.fqty*t12.fqty*(1+t12.fscrap/100),0         
from poorderentry t1 
inner join poorder t7 on t1.finterid=t7.finterid
inner join t_icitem t2 on t1.fitemid=t2.fitemid 
inner join t_measureunit t3 on t3.fitemid=t2.funitid
inner join icbom t11 on t11.fitemid=t1.fitemid and t11.fusestatus=1072
inner join icbomchild t12 on t11.finterid=t12.finterid
inner join t_icitem t9 on t9.fitemid=t12.fitemid  --
inner join t_supplyentry t4 on t4.fsupid=t7.fsupplyid and t4.fitemid=t12.fitemid
where t1.finterid=@fsourceinterid 
and t2.fnumber like '1.02.%' and t9.fnumber like '6.%' 



/*--销售订单直接买原材料的--不放在计划投料中，因为这些是要做销售出库的，如果做在计划投料单中，则重复出库了,MRP计算时已经考虑
insert into #Data(fstockid,      fsourceinterid,fsourceentryid,fscrap,fscrapqty,fproductid,fproductqty,fperqty,fbomqty,fitemid,   fqty,   ftype) 
select            t3.FDefaultLoc,t4.finterid,   t4.fentryid,   0,     0,        t4.fitemid,t4.fqty,    1,      t4.fqty,t4.fitemid,t4.fqty,0
from seorderentry t4 
inner join seorder t5  on t5.finterid=t4.finterid
inner join t_icitem t3 on t3.fitemid=t4.fitemid
where t3.ferpclsid=1 and t5.finterid =@fsourceinterid  --可能外购成品
--select * from #Data
*/

--取得计划投料单最大ID
select @entryid=isnull(max(t1.findex),0)+1 from t_BOSPlasticPoInStockEntry t1 where t1.fid=@InterID

DECLARE Seorder_Cursor2 CURSOR FOR
select t1.FNote,t1.fprice,0 fcostobjid,t1.fproductqty,isnull(t2.fdefaultloc,0) fstockid,t1.fsourceentryid,t1.fqty,t1.fproductid,t1.fbomqty,t1.fperqty,t1.fitemid,t2.funitid,t1.fscrap,t1.fbomqty*t1.fscrap/100
from #Data t1
inner join t_icitem t2 on t1.fitemid=t2.fitemid
--inner join cbcostobj t3 on t3.fstdproductid=t1.fproductid 
and t1.fsourceentryid not in --原来已经有发料的就没有删掉
(
	select distinct t1.FEntryID_SRC 
	from t_BOSPlasticPoInStockEntry t1 
	where t1.fid=@InterID and (isnull(t1.folditemid,0)>0 or isnull(t1.fcommitqty,0)>0 or isnull(t1.fmrpclosed,0)=40019)
)
order by t1.fsourceentryid,t2.fnumber

OPEN Seorder_Cursor2

FETCH NEXT FROM Seorder_Cursor2 
INTO @FNote,@fcprice,@fcostobjid,@fproductqty,@FStockID,@fsourceentryid,@fqty,@fitemid,@fbomqty,@fperqty,@fchilditemid,@funitid,@fscrap,@fscrapqty

WHILE @@FETCH_STATUS = 0
BEGIN
    --价格库的价格,作为分配比例
	select @fcamount=sum(fqty*fprice)--,@fcprices=sum(fprice) 
	from #Data where fsourceinterid=@fsourceinterid and fsourceentryid=@fsourceentryid 

	--套件总单价
	select @ffamount=FAmount,@ffprice=fprice,@fftaxamount=fallAmount,@fftaxprice=fpricediscount 
	from poorderentry where finterid=@fsourceinterid and fentryid=@fsourceentryid

	--比例是金额的比例
	if @fqty=0
	begin
		select @fprice=0,@famount=0,@ftaxprice=0,@ftaxamount=0
	end
	else
	begin
		select @famount=@ffamount*((@fcprice*@fqty)/@fcamount),@ftaxamount=@fftaxamount*((@fcprice*@fqty)/@fcamount) --/@fperqty  --@fprice=@ffprice*(@fcprice/@fcprices)  --如果采购单价没有除于单位用量，为什么会有错？
		select @fprice=@famount/@fqty,@ftaxprice=@ftaxamount/@fqty --@famount=@fprice*@fqty
	end

	INSERT INTO t_BOSPlasticPoInStockEntry(ftaxprice, ftaxamount, fprice, famount, FCostObjID, ficmoqty,    fproductid,fscrap, fscrapqty,  fitemid,      FID,     FIndex,  FQty, fperqty, fbomqty, funitid, FStockID, FRemark,FBillNo_SRC,   FClassID_SRC,FCommitQty,FID_SRC,        FEntryID_SRC) 
	Values(				                   @ftaxprice,@ftaxamount,@fprice,@famount,@fcostobjid,@fproductqty,@fitemid,  @fscrap,@fscrapqty, @fchilditemid,@InterID,@entryid,@FQty,@fperqty,@fbomqty,@funitid,@FStockID,@FNote, @fsourcebillno,-71,         0,         @fsourceinterid,@fsourceentryid)

	set @entryid=@entryid+1
	set @fhavechild=1

    FETCH NEXT FROM Seorder_Cursor2 
    INTO @FNote,@fcprice,@fcostobjid,@fproductqty,@FStockID,@fsourceentryid,@fqty,@fitemid,@fbomqty,@fperqty,@fchilditemid,@funitid,@fscrap,@fscrapqty
END

CLOSE Seorder_Cursor2
DEALLOCATE Seorder_Cursor2

if @bHaveExists=0
begin
	-- 10.4
	Update t_BillCodeRule Set FReChar = FReChar Where FBillTypeID =200000022

	SET @TmpID = (SELECT FID FROM t_BillCodeRule WITH(READUNCOMMITTED) WHERE fbilltypeid=200000022 and fprojectid=3)

	update t_billcoderule set fprojectval = fprojectval+1,flength=case when (flength-len(fprojectval)) >= 0 then flength else len(fprojectval) end where FID =  @TmpID 
	Update ICBillNo Set FCurNo = (select top 1 isnull(fprojectval,1) from t_billcoderule where fprojectid = 3 and fbilltypeid =200000022) where fbillid = 200000022
	   
	--长度和目前编码
	select @fprojectval=(fprojectval-1),@iLength=flength from t_BillCodeRule where fprojectid = 3 and fbilltypeid = 200000022
	  
	--日期
	--select fprojectval,GetDate() AS DateNow from t_BillCodeRule where fprojectid = 2 and fbilltypeid = 100
	  --  sDateFormat = tempRs.Fields(fprojectval)
	  --  sDateFormat = Format(DateValue(tempRs.Fields(DateNow)), sDateFormat)

	-- 前缀
	select @BillNo=fprojectval+left('0000000000',@iLength-(len(@fprojectval)))+@fprojectval from t_BillCodeRule where fprojectid = 1 and fbilltypeid = 200000022  --@iLength

	INSERT INTO t_BOSPlasticPoInStock(fsupplyid, fbilltype, fpobillno,      FID,     FClassTypeID,FBillNo,FDate,  FBiller, FChecker,  FNOTE) 
	Values(                           @fsupplyid,@fbilltype,@fsourcebillno, @InterID,200000022,   @BillNo,@fdate, @fuserid,0       ,  '')

	--EXEC p_UpdateBillRelateData 200000022,@interid

	--set @fresultbillno=@fresultbillno+@billno

--	declare @frunid int
--	set @frunid=0
--	select top 1 @frunid=frunid from my_t_MrpSeOrder where forderinterid=@fsourceinterid and fselect=1 and ftype=@fbilltype order by frunid desc
--
--	update t1 set frunid=@frunid from t_BOSPlasticPoInStock t1 where t1.FID=@InterID
end 

update m2 set fnocommitqty=m2.fqty-m2.FCommitQty
from t_BOSPlasticPoInStockEntry m2 
inner join t_BOSPlasticPoInStock m3 on m2.fid=m3.fid
where m3.fid=@InterID

delete t2 from t_BOSPlasticPoInStock t2 where fid not in (select fid from t_BOSPlasticPoInStockEntry)

drop table #temp
drop table #Mutidata
drop table #MutiParentItem
drop table #Errors
drop table #Data

set nocount off


GO



--塑胶子件--未关联数

IF EXISTS (select * from sysobjects where name='my_tri_PlasticPoInStock'  and xtype='TR')  drop  TRIGGER my_tri_PlasticPoInStock

go
create trigger my_tri_PlasticPoInStock on t_BOSPlasticPoInStock
for insert,update
as
set nocount on

declare @fstatus int,@finterid int,@FChecker int
select @finterid=fid,@FChecker=isnull(FChecker,0) from inserted

update m2 set fnocommitqty=m2.fqty-m2.FCommitQty
from t_BOSPlasticPoInStockEntry m2 
inner join inserted m3 on m2.fid=m3.fid

update t7 set fstockqty=t5.fstockqty,fauxstockqty=t5.fstockqty,fcommitqty=t5.fcommitqty,fauxcommitqty=t5.fcommitqty,fentryselfp0250=t7.fqty-t5.fcommitqty,
fmrpclosed=(case when t7.fqty<=t5.fstockqty then 1 else 0 end)
from 
(
	select t5.fid_src,t5.fentryid_src,min(t5.finstockqty/t5.fperqty) fstockqty,min(t5.fcommitqty/t5.fperqty) fcommitqty
	from t_bosPlasticPoInStockEntry t5 
	inner join inserted t6 on t6.fid=t5.fid
	group by t5.fid_src,t5.fentryid_src 
) t5 inner join poorderentry t7 on t7.finterid=t5.fid_src and t7.fentryid=t5.fentryid_src 
inner join poorder t8 on t8.finterid=t7.finterid


go

IF not EXISTS (select * from sysobjects where name='MycbBillNaviga' and xtype='u')  --drop  Table MycbBillNaviga
begin
	CREATE TABLE [dbo].[MycbBillNaviga](
		[FUserID] [int] NOT NULL,
		[FBillType] [int] NOT NULL,
		[FIndex] [int] NOT NULL,
		[FBillNo] [varchar](50) COLLATE Chinese_PRC_CI_AS NULL,
	 CONSTRAINT [PK_MycbBillNaviga] PRIMARY KEY CLUSTERED 
	(
		[FUserID] ASC,
		[FBillType] ASC,
		[FIndex] ASC
	)WITH  FILLFACTOR = 90 ON [PRIMARY]
	) ON [PRIMARY]
end

go

--select dbo.My_F_Charindex('abcg,hhdef,ccc,ged',',',1)  --一定要用全称
if exists(select * from sysobjects where name like 'My_F_Charindex') drop function My_F_Charindex 

go

create  function My_F_Charindex(@Str varchar(8000),@StrSep varchar(10),@AppPos int)
returns int
begin
    declare @i int
    declare @ii int
    set @Str=rtrim(ltrim(@Str))
    set @i=1
    select @ii=charindex(@StrSep,@Str)
    if @i=@AppPos
        return @ii
    else
    while @AppPos>@i
    begin
        if charindex(@StrSep,right(@Str,len(@Str)-@ii))<>0
                select @ii=charindex(@StrSep,right(@Str,len(@Str)-@ii))+@ii
        else
                set @ii=0
        set @i=@i+1
    end

    return @ii
end

go



IF EXISTS (select * from sysobjects where name='My_p_GetAccessmaskStr' and xtype='p')  drop  procedure My_p_GetAccessmaskStr


go


create procedure My_p_GetAccessmaskStr(@Accessuse As int,@Accessmask as varchar(100) output)
as

declare @AccessuseTemp As int
set @AccessuseTemp = 0

If @Accessuse > 0 
begin
    set @AccessuseTemp = cast((Log(@Accessuse) / Log(2)) as int)
    set @AccessuseTemp = power(2 , @AccessuseTemp)
    While @AccessuseTemp <> @Accessuse
    begin
        set @Accessuse = @Accessuse - @AccessuseTemp
        set @Accessmask = @Accessmask +'/' + cast(@AccessuseTemp as varchar(50)) +'/'
        set @AccessuseTemp = cast((Log(@Accessuse) / Log(2)) as int)
        set @AccessuseTemp = power(2 , @AccessuseTemp)
    end
end

set @Accessmask = @Accessmask +'/' + cast(@AccessuseTemp as varchar(50)) +'/'
set @Accessmask=right(@Accessmask,len(@Accessmask)-1)

go

IF EXISTS (select * from sysobjects where name='My_p_IsHaveRight' and xtype='p')  drop  procedure My_p_IsHaveRight


go


--权限控制
create procedure My_p_IsHaveRight(@Objecttype As int, @Objectid As int, @Index As int, @Userid As int ,@Result as bit output)
as
declare @TempStr As varchar(50)
declare @TempLong as int, @TempAccessmask As int, @MyTempAccessmask As int


If @Userid = 16394  --administrator
begin
  	set @Result = 1
	return
End 

if exists (select * from t_group where fgroupid=1 and fuserid=@Userid)
begin
    	set @Result = 1
	return
End 

if not exists(select FAccessMask 
from t_AccessControl
where FObjectType =@Objecttype and (FObjectID =@Objectid  Or FObjectID = 0) 
and (FUserID =@Userid  or FUserID in (select fgroupid from t_Group where FUserID =@Userid )))
begin
	set @Result = 0
	return
End 
else
begin
	set @Result = 0

	DECLARE icbom_cursor CURSOR FOR	

	select FAccessMask 
	from t_AccessControl
	where FObjectType =@Objecttype and (FObjectID =@Objectid) 
	and (FUserID =@Userid  or FUserID in (select fgroupid from t_Group where FUserID =@Userid ))
		    
	OPEN icbom_cursor

	FETCH NEXT FROM icbom_cursor 
	INTO @TempAccessmask

	WHILE @@FETCH_STATUS = 0
	BEGIN 
		set @TempStr=''
		exec My_p_GetAccessmaskStr @TempAccessmask,@TempStr output
	        
		Select @MyTempAccessmask=FAccessMask  From t_ObjectAccessType
		where FObjectType =@Objecttype and FObjectID =@Objectid and findex=@Index

		if Charindex(cast(@MyTempAccessmask as varchar(50)),@TempStr)>0
		begin
			set @Result = 1

			CLOSE icbom_cursor
			DEALLOCATE icbom_cursor
			return
		End 
	
		FETCH NEXT FROM icbom_cursor 
		INTO @TempAccessmask
	end

	CLOSE icbom_cursor
	DEALLOCATE icbom_cursor
END
    

go


--过滤--------------------------


IF not EXISTS (select * from sysobjects where name='MySubject' and xtype='u')  --drop  Table MySubject
begin
	CREATE TABLE [dbo].[MySubject](
		[fuserid] [int] NOT NULL,
		[ftype] [int] NOT NULL,
		[findex] [int] NOT NULL,
		[fsubname] [varchar](50) COLLATE Chinese_PRC_CI_AS NULL,
		[fdefault] [bit] NULL,
	 CONSTRAINT [PK_MySubject] PRIMARY KEY CLUSTERED 
	(
		[fuserid] ASC,
		[ftype] ASC,
		[findex] ASC
	)WITH FILLFACTOR = 90 ON [PRIMARY]
	) ON [PRIMARY]
end 

GO

--select * from MySubject
--EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'1 默认' ,@level0type=N'SCHEMA', @level0name=N'dbo', @level1type=N'TABLE', @level1name=N'MySubject', @level2type=N'COLUMN', @level2name=N'fdefault'

----------------------------------------------------------------------------------------


IF not EXISTS (select * from sysobjects where name='MySubjectFilter' and xtype='u')  --drop  Table MySubjectFilter
begin
	CREATE TABLE [dbo].[MySubjectFilter](
		[fuserid] [int] NOT NULL,
		[ftype] [int] NOT NULL,
		[fsubid] [int] NOT NULL,
		[findex] [int] NOT NULL,
		[flogic] [int] NULL,
		[FLeftSymbol] [varchar](50) COLLATE Chinese_PRC_CI_AS NULL,
		[ffieldname] [varchar](50) COLLATE Chinese_PRC_CI_AS NULL,
		[frelation] [int] NULL,
		[fvalue] [varchar](50) COLLATE Chinese_PRC_CI_AS NULL,
		[FRightSymbol] [varchar](50) COLLATE Chinese_PRC_CI_AS NULL,
	 CONSTRAINT [PK_MSubjectFilter] PRIMARY KEY CLUSTERED 
	(
		[fuserid] ASC,
		[ftype] ASC,
		[fsubid] ASC,
		[findex] ASC
	)WITH FILLFACTOR = 90 ON [PRIMARY]
	) ON [PRIMARY]
end

GO
--EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'0 或者 1 并且' ,@level0type=N'SCHEMA', @level0name=N'dbo', @level1type=N'TABLE', @level1name=N'MySubjectFilter', @level2type=N'COLUMN', @level2name=N'flogic'

GO
--EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'0 = ; 1<> ; 2 >; 3 >=; 4<;5<=;6 like ;7 not like ;8 like ''%x'' ;9 like ''x%''' ,@level0type=N'SCHEMA', @level0name=N'dbo', @level1type=N'TABLE', @level1name=N'MySubjectFilter', @level2type=N'COLUMN', @level2name=N'frelation'

--select * from MySubjectFilter
-----------------------------------------------------------------------------


GO

IF not EXISTS (select * from sysobjects where name='MySubjectOrderBy' and xtype='u')  --drop  Table MySubjectOrderBy
begin
	CREATE TABLE [dbo].[MySubjectOrderBy](
		[fuserid] [int] NOT NULL,
		[ftype] [int] NOT NULL,
		[fsubid] [int] NOT NULL,
		[findex] [int] NOT NULL,
		[ffieldname] [varchar](50) COLLATE Chinese_PRC_CI_AS NULL,
		[forderbytype] [bit] NULL,
	 CONSTRAINT [PK_MSubjectOrderBy] PRIMARY KEY CLUSTERED 
	(
		[fuserid] ASC,
		[ftype] ASC,
		[fsubid] ASC,
		[findex] ASC
	)WITH FILLFACTOR = 90 ON [PRIMARY]
	) ON [PRIMARY]
end

--select * from MySubjectOrderBy
-----------------------------------------------------------------------------------

GO

IF not EXISTS (select * from sysobjects where name='MySubjectShow' and xtype='u')  --drop  Table MySubjectShow
begin
	CREATE TABLE [dbo].[MySubjectShow](
		[fuserid] [int] NOT NULL,
		[ftype] [int] NOT NULL,
		[fsubid] [int] NOT NULL,
		[findex] [int] NOT NULL,
		[ffieldname] [varchar](50) COLLATE Chinese_PRC_CI_AS NULL,
		[fisshow] [bit] NULL,
		[fwidth] [decimal](18, 2) NULL,
	 CONSTRAINT [PK_MySubjectShow] PRIMARY KEY CLUSTERED 
	(
		[fuserid] ASC,
		[ftype] ASC,
		[fsubid] ASC,
		[findex] ASC
	)WITH FILLFACTOR = 90 ON [PRIMARY]
	) ON [PRIMARY]
end

--select * from MySubjectShow

GO




IF not EXISTS (select * from sysobjects where name='MyICReportProfile' and xtype='u')  --drop  Table MyICReportProfile
begin
	CREATE TABLE [dbo].[MyICReportProfile](
		[FRptID] [int] NOT NULL,
		[FUserID] [int] NOT NULL,
		[FPlan] [nvarchar](50) COLLATE Chinese_PRC_CI_AS NOT NULL,
		[FKey] [varchar](50) COLLATE Chinese_PRC_CI_AS NOT NULL,
		[FValue] [varchar](3000) COLLATE Chinese_PRC_CI_AS NOT NULL,
		[FStatus] [int] NULL,
	 CONSTRAINT [pk_MyICReportProfile] PRIMARY KEY CLUSTERED 
	(
		[FRptID] ASC,
		[FUserID] ASC,
		[FPlan] ASC,
		[FKey] ASC
	) ON [PRIMARY]
	) ON [PRIMARY]
end

go

--生产计划明细表/收料计划明细表--*****
IF not EXISTS (select * from sysobjects where name='My_t_ScheduleDetail' and xtype='u')  --drop  Table My_t_ScheduleDetail
begin
	CREATE TABLE My_t_ScheduleDetail (
		fissel bit,
		fsourcetrantype int,--85 生产任务单  71 采购订单
		fbillerid int,fbilltime datetime,
		fcheckerid int,fcheckdate datetime,
		[finterid] [int] IDENTITY (1, 1) NOT NULL ,
		[fstatus] [int] default 0 NULL ,
		[fsourceinterid] [int] NULL ,
		[fsourceentryid] [int] NULL ,
		ficmointerid int,
		[fdeptid] [int] NULL ,
		[fdate] [datetime] NULL ,--计划完工日期
		[fqty] [decimal](24, 2) NULL ,
		[funitid] [int] NULL ,
		[fitemid] [int] NULL ,
		[fnote] [varchar] (500) COLLATE Chinese_PRC_CI_AS NULL ,
		CONSTRAINT [PK_My_t_ScheduleDetail] PRIMARY KEY  CLUSTERED 
		(
			[finterid]
		)  ON [PRIMARY] 
	) ON [PRIMARY]

end

go


IF not EXISTS (select * from sysobjects where name='my_t_PlanOrderRel' and xtype='u')  --drop  Table my_t_PlanOrderRel
begin
	CREATE TABLE [dbo].[my_t_PlanOrderRel](
		[finterid] [int] IDENTITY(1,1) NOT NULL,
		[fdate] [datetime] NULL,
		[fsourceinterid] [int] NULL,
		[ftargetinterid] [int] NULL,
	 CONSTRAINT [PK_my_t_PlanOrderRel] PRIMARY KEY CLUSTERED 
	(
		[finterid] 
		)  ON [PRIMARY] 
	) ON [PRIMARY]

end

go

IF EXISTS (select * from sysobjects where name='v_MyBOSPlanChangeStock' and xtype='v')  drop  view v_MyBOSPlanChangeStock

go

create view v_MyBOSPlanChangeStock 
as

select '计划投料单' 源单类型,t5.fbillno 单据编号,t6.fnumber 产品编码,t6.fname 产品名称,t6.fmodel 产品规格型号,
t3.fnumber 物料编码,t3.fname 物料名称,t3.fmodel 物料规格型号,t2.fqty 计划数,t2.fcommitqty 关联数,
(t2.fqty-isnull(t2.fcommitqty,0)) 数量
from t_BOSPlanChangeStock t1
inner join t_BOSPlanChangeStockEntry t2 on t1.fid=t2.fid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join seorderentry t4 on t4.finterid=t2.FID_SRC and t4.fentryid=t2.FEntryID_SRC
inner join seorder t5 on t5.finterid=t4.finterid
inner join t_icitem t6 on t6.fitemid=t4.fitemid

go

--*****
--领料单
IF EXISTS (select * from sysobjects where name='v_MyStockBill_24' and xtype='v')  drop  view v_MyStockBill_24

go

create view v_MyStockBill_24
as

select t10.fdate 制单日期,t4.fname 制单人,isnull(t1.fname,'') 发料人,isnull(t2.fname,'') 领料人,isnull(t10.FHeadSelfB0433,0) 标识码,
Null 单据类型,isnull(t0.fbillno,'') 任务单号,isnull(t0.finterid,0) 任务单内码,isnull(t9.FPPBomEntryID,0) 投料单分录号,t8.fitemid 生产车间内码,t8.fname 生产车间,
(case when t0.fstatus=0 then '计划' when t0.fstatus in (1,2) then '下达' when t0.fstatus=5 then '确认' when t0.fstatus=3 then '结案' end) 状态,
isnull('','') 订单编号,isnull('','') 客户订单号,isnull('','1900-01-01') 计划开工日期,
Null 下单日期,t10.fbillno 单据编号,t9.finterid 单据内码,t9.fentryid 分录号,'' 客户,
isnull(t7.fshortnumber,'') 产品短代码,isnull(t7.fnumber,'') 产品编码,isnull(t7.FName,'') 产品名称, isnull(t7.fmodel,'') 产品规格型号,isnull(t7.fitemid,0) 产品内码,
0 订单数,Null 工厂交期,Null 包材交期,Null 工厂备注,
Null 整单包装说明,Null 产品包装说明,Null 订单备注,isnull(t13.fname,'') 仓管员,t15.fitemid 仓库内码,t15.fname 仓库,isnull(t14.fname,'') 物料类别,
isnull(t0.fcostobjid,0) 成本对象内码,isnull(t11.fshortnumber,'') 物料短代码,isnull(t11.fnumber,'') 物料编码,isnull(t11.FName,'') 物料名称, isnull(t11.fmodel,'') 物料规格型号,isnull(t11.fitemid,0) 物料内码,
t3.fitemid 单位内码,t3.fname 单位,cast(t9.fqty as decimal(24,2)) 应发数,cast(t9.fqty as decimal(24,2)) 已发数,0 未发数,
(case when Charindex('-',t10.fbillno)>0 then 0 else cast(isnull(t16.fqty,0) as decimal(24,2)) end) 即时库存,
isnull(t17.fname,'否') 倒冲,(case when t11.ferpclsid=1 then '外购' when t11.ferpclsid=2 then '自制'  end) 物料属性
from icstockbillentry t9 
inner join icstockbill t10 on t10.finterid=t9.finterid
left join icmo t0 on t9.ficmointerid=t0.finterid
left join t_User t4 on t10.fbillerid=t4.fuserid and t4.fuserid<>0  
left join t_User t5 on t0.fconfirmerid=t5.fuserid and t5.fuserid<>0  
left join t_User t6 on t0.fconveyerid=t6.fuserid and t6.fuserid<>0  
left join t_icitem t7 on t0.fitemid=t7.fitemid 
inner join t_department t8 on t8.fitemid=t10.fdeptid
inner join t_icitem t11 on t11.fitemid=t9.fitemid
inner join t_measureunit t3 on t3.fitemid=t11.funitid
left join t_SubMessage t13 on t13.finterid=t11.f_114 and t13.ftypeid=10003
left join t_SubMessage t14 on t14.finterid=t11.ftypeid and t14.ftypeid=504
inner join t_stock t15 on t15.fitemid=t9.fscstockid
left join 
(	
	select fitemid,fstockid,sum(fqty) fqty 
	from 
	(
		select fitemid,fstockid,fqty from icinventory 
		union all 
		select t1.fitemid,t1.fstockid,t1.fqty from poinventory t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid --where t1.fitemid<>20355 and t2.fnumber like '6.%'  select * from t_stock where fitemid=20355
	) t1
	group by fitemid,fstockid
) t16 on t16.fitemid=t9.fitemid and t16.fstockid=t9.fscstockid
left join t_SubMessage t17 on t17.finterid=t11.f_115 and t17.ftypeid=10002
left join t_emp t1 on t1.fitemid=t10.ffmanagerid
left join t_emp t2 on t2.fitemid=t10.fsmanagerid

go

--select 单据编号,订单编号,计划开工日期,发料人,领料人,物料短代码,物料名称,物料规格型号,即时库存,仓库,应发数 from v_MyStockBill_24 where 单据编号='sout016513'

--*****
--虚仓出库单
IF EXISTS (select * from sysobjects where name='v_MyStockBill_26' and xtype='v')  drop  view v_MyStockBill_26

go

create view v_MyStockBill_26
as

select t10.fdate 制单日期,t4.fname 制单人,isnull(t1.fname,'') 发料人,isnull(t2.fname,'') 领料人,
Null 单据类型,isnull(t0.fbillno,'') 任务单号,isnull(t0.finterid,0) 任务单内码,isnull(t9.FEntrySelfZOU31,0) 投料单分录号,isnull(t8.fitemid,168) 生产车间内码,isnull(t8.fname,'包装1线') 生产车间,t0.fplancommitdate 计划开工日期,
(case when t0.fstatus=0 then '计划' when t0.fstatus in (1,2) then '下达' when t0.fstatus=5 then '确认' when t0.fstatus=3 then '结案' end) 状态,
'' 订单编号,Null 下单日期,t10.fbillno 单据编号,t9.finterid 单据内码,t9.fentryid 分录号,'' 客户,
isnull(t7.fshortnumber,'') 产品短代码,isnull(t7.fnumber,'') 产品编码,isnull(t7.FName,'') 产品名称, isnull(t7.fmodel,'') 产品规格型号,isnull(t7.fitemid,0) 产品内码,
0 订单数,Null 工厂交期,Null 包材交期,Null 工厂备注,'' 客户订单号,
Null 整单包装说明,Null 产品包装说明,Null 订单备注,isnull(t13.fname,'') 仓管员,t15.fitemid 仓库内码,t15.fname 仓库,isnull(t14.fname,'') 物料类别,
isnull(t0.fcostobjid,0) 成本对象内码,isnull(t11.fshortnumber,'') 物料短代码,isnull(t11.fnumber,'') 物料编码,isnull(t11.FName,'') 物料名称, isnull(t11.fmodel,'') 物料规格型号,isnull(t11.fitemid,0) 物料内码,
t3.fitemid 单位内码,t3.fname 单位,cast(t9.fqty as decimal(24,2)) 应发数,cast(t9.fqty as decimal(24,2)) 已发数,0 未发数,
(case when Charindex('-',t10.fbillno)>0 then 0 else cast(isnull(t16.fqty,0) as decimal(24,2)) end) 即时库存,
t17.fname 倒冲,(case when t11.ferpclsid=1 then '外购' when t11.ferpclsid=2 then '自制'  end) 物料属性
from zpstockbillentry t9 
inner join zpstockbill t10 on t10.finterid=t9.finterid
left join icmo t0 on t9.FEntrySelfZOU30=t0.finterid
left join t_User t4 on t10.fbillerid=t4.fuserid and t4.fuserid<>0  
left join t_User t5 on t0.fconfirmerid=t5.fuserid and t5.fuserid<>0  
left join t_User t6 on t0.fconveyerid=t6.fuserid and t6.fuserid<>0  
left join t_icitem t7 on t0.fitemid=t7.fitemid 
left join t_department t8 on t8.fitemid=t10.fdeptid
inner join t_icitem t11 on t11.fitemid=t9.fitemid
inner join t_measureunit t3 on t3.fitemid=t11.funitid
left join t_SubMessage t13 on t13.finterid=t11.f_114 and t13.ftypeid=10003
left join t_SubMessage t14 on t14.finterid=t11.ftypeid and t14.ftypeid=504
inner join t_stock t15 on t15.fitemid=t9.FDCStockID
left join poinventory t16 on t16.fitemid=t9.fitemid and t16.fstockid=t9.fdcstockid
left join t_SubMessage t17 on t17.finterid=t11.f_115 and t17.ftypeid=10002
left join t_emp t1 on t1.fitemid=t10.ffmanagerid
left join t_emp t2 on t2.fitemid=t10.fsmanagerid

go


--*****
--其他出库单
IF EXISTS (select * from sysobjects where name='v_MyStockBill_29' and xtype='v')  drop  view v_MyStockBill_29

go

create view v_MyStockBill_29
as


select t10.fdate 制单日期,t4.fname 制单人,isnull(t12.fname,'') 发料人,isnull(t2.fname,'') 领料人,
Null 单据类型,'' 任务单号,0 任务单内码,0 投料单分录号,t8.fitemid 领料部门内码,t8.fname 领料部门,Null 计划开工日期,
'' 状态,'' 订单编号,Null 下单日期,t10.fbillno 单据编号,t9.finterid 单据内码,t9.fentryid 分录号,'' 客户,
isnull(t7.fshortnumber,'') 产品短代码,isnull(t7.fnumber,'') 产品编码,isnull(t7.FName,'') 产品名称, isnull(t7.fmodel,'') 产品规格型号,isnull(t7.fitemid,0) 产品内码,
0 订单数,Null 工厂交期,Null 包材交期,Null 工厂备注,'' 客户订单号,
Null 整单包装说明,Null 产品包装说明,Null 订单备注,isnull(t13.fname,'') 仓管员,t1.fitemid 仓库内码,t1.fname 仓库,isnull(t14.fname,'') 物料类别,
isnull(t0.fcostobjid,0) 成本对象内码,isnull(t11.fshortnumber,'') 物料短代码,isnull(t11.fnumber,'') 物料编码,isnull(t11.FName,'') 物料名称, isnull(t11.fmodel,'') 物料规格型号,isnull(t11.fitemid,0) 物料内码,
t3.fitemid 单位内码,t3.fname 单位,cast(t9.fqty as decimal(24,2)) 应发数,cast(t9.fqty as decimal(24,2)) 已发数,0 未发数,
(case when Charindex('-',t10.fbillno)>0 then 0 else cast(isnull(t16.fqty,0) as decimal(24,2)) end) 即时库存,
t17.fname 倒冲,(case when t11.ferpclsid=1 then '外购' when t11.ferpclsid=2 then '自制'  end) 物料属性
from icstockbillentry t9 
inner join icstockbill t10 on t10.finterid=t9.finterid
left join icmo t0 on t9.ficmointerid=t0.finterid
left join t_User t4 on t10.fbillerid=t4.fuserid and t4.fuserid<>0  
left join t_User t5 on t0.fconfirmerid=t5.fuserid and t5.fuserid<>0  
left join t_User t6 on t0.fconveyerid=t6.fuserid and t6.fuserid<>0  
left join t_icitem t7 on t0.fitemid=t7.fitemid 
inner join t_department t8 on t8.fitemid=t10.fdeptid
inner join t_icitem t11 on t11.fitemid=t9.fitemid
inner join t_measureunit t3 on t3.fitemid=t11.funitid
left join t_SubMessage t13 on t13.finterid=t11.f_114 and t13.ftypeid=10003
left join t_SubMessage t14 on t14.finterid=t11.ftypeid and t14.ftypeid=504
inner join t_stock t1 on t1.fitemid=t9.fdcstockid
left join 
(	
	select fitemid,fstockid,sum(fqty) fqty 
	from 
	(
		select fitemid,fstockid,fqty from icinventory 
		union all 
		select t1.fitemid,t1.fstockid,t1.fqty from poinventory t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid --where t1.fitemid<>20355 and t2.fnumber like '6.%'  select * from t_stock where fitemid=20355
	) t1
	group by fitemid,fstockid
) t16 on t16.fitemid=t9.fitemid and t16.fstockid=t9.fdcstockid
left join t_SubMessage t17 on t17.finterid=t11.f_115 and t17.ftypeid=10002
left join t_emp t12 on t12.fitemid=t10.ffmanagerid
left join t_emp t2 on t2.fitemid=t10.fsmanagerid

go


--*****
--调拨单
IF EXISTS (select * from sysobjects where name='v_MyStockBill_41' and xtype='v')  drop  view v_MyStockBill_41

go

create view v_MyStockBill_41
as

select t10.fdate 制单日期,t4.fname 制单人,isnull(t12.fname,'') 发料人,isnull(t2.fname,'') 领料人,
Null 单据类型,isnull(t0.fbillno,'') 任务单号,isnull(t0.finterid,0) 任务单内码,isnull(t9.FPPBomEntryID,0) 投料单分录号,isnull(t8.fitemid,0) 生产车间内码,isnull(t8.fname,'') 生产车间,t0.fplancommitdate 计划开工日期,
(case when t0.fstatus=0 then '计划' when t0.fstatus in (1,2) then '下达' when t0.fstatus=5 then '确认' when t0.fstatus=3 then '结案' end) 状态,
'' 订单编号,Null 下单日期,t10.fbillno 单据编号,t9.finterid 单据内码,t9.fentryid 分录号,'' 客户,
isnull(t7.fshortnumber,'') 产品短代码,isnull(t7.fnumber,'') 产品编码,isnull(t7.FName,'') 产品名称, isnull(t7.fmodel,'') 产品规格型号,isnull(t7.fitemid,0) 产品内码,
0 订单数,Null 工厂交期,Null 包材交期,Null 工厂备注,'' 客户订单号,isnull(t18.fname,'') 调拨类型,
Null 整单包装说明,Null 产品包装说明,Null 订单备注,isnull(t13.fname,'') 仓管员,isnull(t14.fname,'') 物料类别,
t15.fitemid 调出仓库内码,t15.fname 调出仓库,t1.fitemid 调入仓库内码,t1.fname 调入仓库,
isnull(t0.fcostobjid,0) 成本对象内码,isnull(t11.fshortnumber,'') 物料短代码,isnull(t11.fnumber,'') 物料编码,isnull(t11.FName,'') 物料名称, isnull(t11.fmodel,'') 物料规格型号,isnull(t11.fitemid,0) 物料内码,
t3.fitemid 单位内码,t3.fname 单位,cast(t9.fqty as decimal(24,2)) 应发数,cast(t9.fqty as decimal(24,2)) 已发数,0 未发数,
(case when Charindex('-',t10.fbillno)>0 then 0 else cast(isnull(t16.fqty,0) as decimal(24,2)) end) 即时库存,
t17.fname 倒冲,(case when t11.ferpclsid=1 then '外购' when t11.ferpclsid=2 then '自制'  end) 物料属性
from icstockbillentry t9 
inner join icstockbill t10 on t10.finterid=t9.finterid
left join icmo t0 on t9.ficmointerid=t0.finterid
left join t_User t4 on t10.fbillerid=t4.fuserid and t4.fuserid<>0  
left join t_User t5 on t0.fconfirmerid=t5.fuserid and t5.fuserid<>0  
left join t_User t6 on t0.fconveyerid=t6.fuserid and t6.fuserid<>0  
left join t_icitem t7 on t0.fitemid=t7.fitemid 
left join t_department t8 on t8.fitemid=t10.fdeptid
inner join t_icitem t11 on t11.fitemid=t9.fitemid
inner join t_measureunit t3 on t3.fitemid=t11.funitid
left join t_SubMessage t13 on t13.finterid=t11.f_114 and t13.ftypeid=10003
left join t_SubMessage t14 on t14.finterid=t11.ftypeid and t14.ftypeid=504
inner join t_stock t15 on t15.fitemid=t9.fscstockid
inner join t_stock t1 on t1.fitemid=t9.fdcstockid
left join 
(	
	select fitemid,fstockid,sum(fqty) fqty 
	from 
	(
		select fitemid,fstockid,fqty from icinventory 
		union all 
		select t1.fitemid,t1.fstockid,t1.fqty from poinventory t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid --where t1.fitemid<>20355 and t2.fnumber like '6.%'  select * from t_stock where fitemid=20355
	) t1
	group by fitemid,fstockid
) t16 on t16.fitemid=t9.fitemid and t16.fstockid=t9.fscstockid
left join t_SubMessage t17 on t17.finterid=t11.f_115 and t17.ftypeid=10002
left join t_emp t12 on t12.fitemid=t10.ffmanagerid
left join t_emp t2 on t2.fitemid=t10.fsmanagerid
left join t_SubMessage t18 on t18.finterid=t10.fheadselfd0133 and t18.ftypeid=10009

go


IF EXISTS (select * from sysobjects where name='v_MyPPBomChangeStock' and xtype='v')  drop  view v_MyPPBomChangeStock

go

create view v_MyPPBomChangeStock 
as

select '半成品日计划投料单' 源单类型,t1.fbillno 单据编号,t6.fnumber 产品编码,t6.fname 产品名称,t6.fmodel 产品规格型号,
t3.fnumber 物料编码,t3.fname 物料名称,t3.fmodel 物料规格型号,t2.fqtymust 计划数,t2.FSelTransLateQty 关联数,
(t2.fqtymust-isnull(t2.FSelTransLateQty,0)) 数量
from ppbom t1
inner join ppbomEntry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join icmo t4 on t4.finterid=t2.ficmointerid
inner join t_icitem t6 on t6.fitemid=t4.fitemid
where isnull(t4.FPPOrderInterID,0)<>0

go

--生产计划明细--*****
IF EXISTS (select * from sysobjects where name='v_MyScheduleDetail_85' and xtype='v')  drop view v_MyScheduleDetail_85

go

create view v_MyScheduleDetail_85 
as

select t0.finterid 计划单内码,t0.fsourcetrantype 源单类型内码,'任务单' 源单类型,t8.fbillno 任务单号,t8.finterid 任务单内码,
t4.fname 制单人,t0.fbilltime 制单日期,isnull(t5.fname,'') 审核人,isnull(t0.fcheckdate,Null) 审核日期,
(case when t0.fstatus=0 then '' else 'Y' end) 计划单状态,
isnull(t1.fbillno,'') 订单编号,t1.fdate 订单日期,isnull(t12.finterid,0) 订单内码,isnull(t12.fentryid,0) 订单分录号,t12.fdate 出货日期,
isnull(t2.fname,'') 客户,isnull(t2.fitemid,0) 客户内码,cast(isnull(t12.fqty,0) as decimal(24,2)) 订单数,t12.fnote 备注,
(case when t8.fstatus=0 then '计划' when t8.fstatus in (1,2) then '下达' when t8.fstatus=5 then '确认' when t8.fstatus=3 then '结案' end) 任务单状态,
isnull(t6.fname,'') 生产车间,isnull(t6.fitemid,0) 生产车间内码,
t7.fnumber 产品编码,t7.FName 产品名称,isnull(t7.fmodel,'') 规格型号,t7.fitemid 产品内码,
t12.funitid 单位内码,t3.fname 单位,
cast(t8.fqty as decimal(24,2)) 任务数,cast(t8.fcommitqty as decimal(24,2)) 汇报数,cast(t8.fstockqty as decimal(24,2)) 入库数,
cast(isnull((select sum(t1.FQtyFinish) FQtyFinish from ICMORptEntry t1 inner join ICMORpt t2 on t1.finterid=t2.finterid where t1.fsourceinterid=t8.finterid and t2.FHeadSelfJ1112=t0.fdate),0) as decimal(24,2)) 当天汇报数,
isnull((select sum(fqty) from my_t_scheduledetail where ficmointerid=t8.finterid),0) 已排数,
t8.fqty-isnull((select sum(fqty) from my_t_scheduledetail where ficmointerid=t8.finterid),0) 未排数,
t0.fdate 计划完工日期,cast(t0.fqty as decimal(24,2)) 数量,isnull(t9.FBOMNumber,'') BOM单据号,
(case when t7.ferpclsid=1 then '外购' when t7.ferpclsid=2 then '自制' when t7.ferpclsid=3 then '委外' end) 物料属性
from my_t_scheduledetail t0
inner join icmo t8 on t8.finterid=t0.ficmointerid
left join SeorderEntry t12 on t8.forderinterid=t12.finterid and t8.fsourceentryid=t12.fentryid
left join seorder t1 on t1.finterid=t12.finterid
inner join t_User t4 on t0.fbillerid=t4.fuserid and t4.fuserid<>0  
left join t_User t5 on t0.fcheckerid=t5.fuserid and t5.fuserid<>0  
inner join t_icitem t7 on t0.fitemid=t7.fitemid 
left join t_Organization t2 on t1.fcustid=t2.fitemid
inner join t_measureunit t3 on t3.fitemid=t7.funitid
left join t_department t6 on t6.fitemid=t0.fdeptid
left join icbom t9 on t9.fitemid=t0.fitemid --and t9.fusestatus=1072
where t0.fsourcetrantype=85

go


--收料计划明细--*****
IF EXISTS (select * from sysobjects where name='v_MyScheduleDetail_71' and xtype='v')  drop view v_MyScheduleDetail_71

go

create view v_MyScheduleDetail_71 
as

select t0.finterid 计划单内码,t0.fsourcetrantype 源单类型内码,'采购订单' 源单类型,
t4.fname 制单人,t0.fbilltime 制单日期,isnull(t5.fname,'') 审核人,isnull(t0.fcheckdate,Null) 审核日期,
(case when t0.fstatus=0 then '' else 'Y' end) 计划单状态,
isnull(t1.fbillno,'') 订单编号,t1.fdate 订单日期,isnull(t12.finterid,0) 订单内码,isnull(t12.fentryid,0) 订单分录号,t12.fdate 订单收料日期,
cast(isnull(t12.fqty,0) as decimal(24,2)) 订单数,t12.fnote 备注,
(case when t1.fstatus=0 then '未审核' when t1.fstatus in (1,2) then '审核' when t1.fstatus=3 then '关闭' end) 订单状态,
isnull(t6.fshortname,'') 厂商,isnull(t6.fitemid,0) 厂商内码,
t7.fnumber 产品编码,t7.FName 产品名称,isnull(t7.fmodel,'') 规格型号,t7.fitemid 产品内码,
t12.funitid 单位内码,t3.fname 单位,
cast(t12.fcommitqty as decimal(24,2)) 收料数,cast(t12.fstockqty as decimal(24,2)) 入库数,
isnull((select sum(fqty) from my_t_scheduledetail where fsourceinterid=t12.finterid and fsourceentryid=t12.fentryid),0) 已排数,
t12.fqty-isnull((select sum(fqty) from my_t_scheduledetail where fsourceinterid=t12.finterid and fsourceentryid=t12.fentryid),0) 未排数,
t0.fdate 计划收料日期,cast(t0.fqty as decimal(24,2)) 数量,
(case when t7.ferpclsid=1 then '外购' when t7.ferpclsid=2 then '自制' when t7.ferpclsid=3 then '委外' end) 物料属性
from my_t_scheduledetail t0
inner join poorderentry t12 on t12.finterid=t0.fsourceinterid and t12.fentryid=t0.fsourceentryid
inner join poorder t1 on t1.finterid=t12.finterid
inner join t_User t4 on t0.fbillerid=t4.fuserid and t4.fuserid<>0  
left join t_User t5 on t0.fcheckerid=t5.fuserid and t5.fuserid<>0  
inner join t_icitem t7 on t12.fitemid=t7.fitemid 
inner join t_measureunit t3 on t3.fitemid=t12.funitid
inner join t_supplier t6 on t6.fitemid=t1.fsupplyid
where t0.fsourcetrantype=71

go


--采购订单--*****
IF EXISTS (select * from sysobjects where name='v_MyPOOrder' and xtype='v')  drop view v_MyPOOrder

go

create view v_MyPOOrder 
as

select t4.fname 制单人,t1.fdate 制单日期,isnull(t5.fname,'') 审核人,isnull(t1.fcheckdate,Null) 审核日期,isnull(t8.fname,'') 采购订单类型,
isnull(t1.fbillno,'') 订单编号,t1.fdate 订单日期,isnull(t12.finterid,0) 订单内码,isnull(t12.fentryid,0) 订单分录号,t12.fdate 交货日期,
(case when t1.fstatus=0 then '未审核' when t1.fstatus in (1,2) then '审核' when t1.fstatus=3 then '关闭' end) 订单状态,
isnull(t2.fname,'') 业务员,isnull(t6.fshortname,'') 厂商,isnull(t6.fitemid,0) 厂商内码,
t7.fnumber 产品编码,t7.FName 产品名称,isnull(t7.fmodel,'') 规格型号,t7.fitemid 产品内码,
t12.funitid 单位内码,t3.fname 单位,
cast(isnull(t12.fqty,0) as decimal(24,2)) 订单数,cast(t12.fcommitqty as decimal(24,2)) 收料数,cast(t12.fstockqty as decimal(24,2)) 入库数,
(case when t7.ferpclsid=1 then '外购' when t7.ferpclsid=2 then '自制' when t7.ferpclsid=3 then '委外' end) 物料属性,t12.fnote 备注
from poorderentry t12 
inner join poorder t1 on t1.finterid=t12.finterid
inner join t_User t4 on t1.fbillerid=t4.fuserid and t4.fuserid<>0  
left join t_User t5 on t1.fcheckerid=t5.fuserid and t5.fuserid<>0  
inner join t_icitem t7 on t12.fitemid=t7.fitemid 
inner join t_measureunit t3 on t3.fitemid=t12.funitid
inner join t_supplier t6 on t6.fitemid=t1.fsupplyid
left join t_submessage t8 on t8.finterid=t1.fheadselfp0237 and t8.ftypeid=10008
left join t_emp t2 on t2.fitemid=t1.FEmpID


go


--select * from my_t_scheduledetail  delete from my_t_scheduledetail update t1 set fdeptid=176 from my_t_scheduledetail t1
--
--IF EXISTS (select * from sysobjects where name='v_MyScheduleDetail_81' and xtype='v')  drop view v_MyScheduleDetail_81
--
--go
--
--create view v_MyScheduleDetail_81 
--as
--
--select '销售订单' 源单类型,t1.fbillno 订单编号,t0.finterid 单据内码,t0.fsourcetrantype 源单类型内码,
--t1.fdate 下单日期, t4.fname 制单人,isnull(t5.fname,'') 审核人,isnull(t1.fcheckdate,Null) 审核日期,
----(case when t0.fstatus=0 then '' else 'Y' end) 状态,
--(case when isnull(t8.finterid,0)=0 and isnull(t11.finterid,0)=0 then '' else 'Y' end) 状态,
----(case when t0.fstatus=0 then '计划' when t0.fstatus=1 then '确认' when t0.fstatus=2 then '关闭' end) 状态,
--t0.forderinterid 订单内码,t0.forderentryid 订单分录号,t0.fdate 计划开工日期,
--'' 交货方式,'' 结算方式,isnull(t6.fname,'') 生产车间,isnull(t6.fitemid,0) 生产车间内码,
--isnull(t2.fname,'') 客户,isnull(t2.fitemid,0) 客户内码,
--isnull(t7.fnumber,'') 产品编码,isnull(t7.FName,'') 产品名称, isnull(t7.fmodel,'') 规格型号,
--isnull(t7.fitemid,0) 产品内码,t12.funitid 单位内码,t3.fname 单位,cast(t12.fqty as decimal(24,2)) 订单数,
--isnull(t12.FEntrySelfS0158,0) 已排产,isnull(t12.FEntrySelfS0159,0) 可排产,
--(select sum(fqty) from my_t_scheduledetail where forderinterid=t0.forderinterid and forderentryid=t0.forderentryid and fdeptid=t0.fdeptid and fsourcetrantype=t0.fsourcetrantype) 该线已排产,
--cast(t0.fqty as decimal(24,2)) 数量,t12.fnote 备注,isnull(t9.FBOMNumber,'') BOM单据号,
--(case when t7.ferpclsid=1 then '外购' when t7.ferpclsid=2 then '自制' when t7.ferpclsid=3 then '委外' end) 物料属性
--from my_t_scheduledetail t0
--inner join SeorderEntry t12 on t0.forderinterid=t12.finterid and t0.forderentryid=t12.fentryid
--inner join seorder t1 on t1.finterid=t12.finterid
--left join t_User t4 on t0.fbillerid=t4.fuserid and t4.fuserid<>0  
--left join t_User t5 on t0.fcheckerid=t5.fuserid and t5.fuserid<>0  
--inner join t_icitem t7 on t12.fitemid=t7.fitemid 
--left join t_Organization t2 on t1.fcustid=t2.fitemid
--inner join t_measureunit t3 on t3.fitemid=t12.funitid
--inner join t_department t6 on t6.fitemid=t0.fdeptid
--left join icmo t8 on t8.FHeadSelfJ0174=t0.finterid
--left join icbom t9 on t9.fitemid=t0.fitemid and t9.fusestatus=1072
----left join t_BosDirectInOutEntry t10 on t10.fsourceinterid=t0.finterid
--left join icstockbillentry t11 on t11.fsourceinterid=t0.finterid
--where t0.fsourcetrantype=81
--
--go
--
--
--
--IF EXISTS (select * from sysobjects where name='v_MyScheduleDetail_87' and xtype='v')  drop view v_MyScheduleDetail_87
--
--go
--
--create view v_MyScheduleDetail_87 
--as
--
--select '预测订单' 源单类型,t1.fbillno 订单编号,t0.finterid 单据内码,t0.fsourcetrantype 源单类型内码,
--t1.fdate 下单日期, t4.fname 制单人,isnull(t5.fname,'') 审核人,isnull(t1.fcheckdate,Null) 审核日期,
----(case when t0.fstatus=0 then '' else 'Y' end) 状态,
--(case when isnull(t8.finterid,0)=0 and isnull(t11.finterid,0)=0 then '' else 'Y' end) 状态,
----(case when t0.fstatus=0 then '计划' when t0.fstatus=1 then '确认' when t0.fstatus=2 then '关闭' end) 状态,
--t0.forderinterid 订单内码,t0.forderentryid 订单分录号,t0.fdate 计划开工日期,
--'' 交货方式,'' 结算方式,
--isnull(t6.fname,'') 生产车间,isnull(t6.fitemid,0) 生产车间内码,
--isnull(t2.fname,'') 客户,isnull(t2.fitemid,0) 客户内码,
--isnull(t7.fnumber,'') 产品编码,isnull(t7.FName,'') 产品名称, isnull(t7.fmodel,'') 规格型号,
--isnull(t7.fitemid,0) 产品内码,t12.funitid 单位内码,t3.fname 单位,cast(t12.fqty as decimal(24,2)) 订单数,
--isnull(t12.FEntrySelfY0121,0) 已排产,isnull(t12.FEntrySelfY0122,0) 可排产,
--(select sum(fqty) from my_t_scheduledetail where forderinterid=t0.forderinterid and forderentryid=t0.forderentryid and fdeptid=t0.fdeptid and fsourcetrantype=87) 该线已排产,
--cast(t0.fqty as decimal(24,2)) 数量,t12.fnote 备注,isnull(t9.FBOMNumber,'') BOM单据号,
--(case when t7.ferpclsid=1 then '外购' when t7.ferpclsid=2 then '自制' when t7.ferpclsid=3 then '委外' end) 物料属性
--from my_t_scheduledetail t0
--inner join PPOrderEntry t12 on t0.forderinterid=t12.finterid and t0.forderentryid=t12.fentryid
--inner join pporder t1 on t1.finterid=t12.finterid
--left join t_User t4 on t0.fbillerid=t4.fuserid and t4.fuserid<>0  
--left join t_User t5 on t0.fcheckerid=t5.fuserid and t5.fuserid<>0  
--inner join t_icitem t7 on t12.fitemid=t7.fitemid 
--left join t_Organization t2 on t12.fcustid=t2.fitemid
--inner join t_measureunit t3 on t3.fitemid=t12.funitid
--inner join t_department t6 on t6.fitemid=t0.fdeptid
--left join icmo t8 on t8.FHeadSelfJ0174=t0.finterid
--left join icbom t9 on t9.fitemid=t0.fitemid and t9.fusestatus=1072
----left join t_BosDirectInOutEntry t10 on t10.fsourceinterid=t0.finterid
--left join icstockbillentry t11 on t11.fsourceinterid=t0.finterid
--where t0.fsourcetrantype=87
--
--go

--
--IF EXISTS (select * from sysobjects where name='v_MyScheduleDetail' and xtype='v')  drop  view v_MyScheduleDetail
--
--go
--
--create view v_MyScheduleDetail
--as
--
--select * from v_MyScheduleDetail_81
--union all 
--select * from v_MyScheduleDetail_87
--
--go


IF not EXISTS (select * from sysobjects where name='my_t_ReplaceExpLabel' and xtype='u')  --drop  Table my_t_ReplaceExpLabel
begin
	CREATE TABLE [dbo].my_t_ReplaceExpLabel(
		fuserid int,ficmointerid int)

end

go
--
----替换特殊标签-----------------------------++++++++++++++++++++++++++++++++
--IF EXISTS (select * from sysobjects where name='My_P_ReplaceExpLabel' and xtype='p')  drop  procedure My_P_ReplaceExpLabel
--
--go
--
--create procedure [dbo].My_P_ReplaceExpLabel(@fuserid int)
--
--as
--
----declare @fuserid int select @fuserid=16405
--declare @fplanprice decimal(18,4),@fitemid int,@fpitemid int,@funitid int,@entryid int,@fqty int
--declare @InterID int,@BillNo varchar (20),@FStockId int,@StockNumber varchar (20)
--DECLARE @TmpID INT ,@fsupplyid int,@fcurrencyid int,@FMyPoInStockInterId int
--declare @fsupplyno varchar(20),@forderdate datetime,@FValueAddRate decimal(28, 2)
--declare @iLength int,@FPrice decimal(28, 5),@FAmount decimal(20, 2),@FExchangeRate decimal(28, 10)
--declare @FTaxPrice decimal(28, 5),@FTaxAmount decimal(20, 2),@SupplyId int
--declare @fprojectval  varchar(200),@fspid int,@fempid int,@fdeptid int
--declare @FDateFormat  varchar(200),@fdate datetime,@forginterid int,@ficmointerid int
--declare @fsourceNumber varchar(200),@fpSourceNumber varchar(200),@fpXxSourceNumber varchar(200)
--declare @fXxOldSourceNumber varchar(200),@empid int,@fsourcetrantype int
--declare @FDCStockID int,@xx_FItemIDOld int,@fxxitemid int,@FOrgPPOInterID int
--declare @FDCSPID int,@forderinterid int,@forderentryid int,@fppbominterid int,@fpacksubid int
--declare @fsourceInterid int,@fsourceEntryid int,@fsourceBillNo varchar (100)
--declare @fyear int,@fperiod int,@FMangerID int,@fmoqty decimal(24,2),@FSendItemDate datetime
--declare @fresultbillno varchar (800),@FQtyScrap decimal(24,2),@FBomInputQty decimal(24,2),@fqtymust decimal(24,2)
--declare @ftempbillno varchar(50),@fcostobjid int,@fplancommitdate datetime,@fsourceid int
--declare @fplanorderinterid int,@fbominterid int,@forgsaleinterid int,@forgentryid int,@fscrap decimal(24,4)
----AIS20041229163526   AIS20080129143619
----declare @fbout varchar(10),@fcommitdate datetime
--
--select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期
--set @forderdate=@fdate  --'2009-06-15' --下单日期
----set @fcommitdate='2009-07-21' --到货日期
--set @fresultbillno=''
--
--
----set @fbout='204'
--
--DECLARE authors_cursor CURSOR FOR	
--
--select t5.fqty fmoqty,t1.ficmointerid,t8.finterid fppbominterid,t7.fid fpacksubid
--from my_t_ReplaceExpLabel t1 
--inner join icmo t5 on t5.finterid=t1.ficmointerid
--inner join t_icitem t2 on t5.fitemid=t2.fitemid 
--inner join t_measureunit t3 on t3.fitemid=t2.funitid
----inner join icbom t4 on t2.fitemid=t4.fitemid
--inner join seorderentry t6 on t6.finterid=t5.forderinterid and t5.fsourceentryid=t6.fentryid
--inner join seorder t9 on t9.finterid=t6.finterid
--inner join t_BOSPackSub t7 on t7.fbillno=t6.fentryselfs0167
--inner join ppbom t8 on t8.ficmointerid=t5.finterid
--where t1.fuserid=@fuserid and t9.fdate>='2011-10-08'
--order by t5.fbillno
--
--set @entryid=1
--
--OPEN authors_cursor
--
--FETCH NEXT FROM authors_cursor 
--INTO @fmoqty,@ficmointerid,@fppbominterid,@fpacksubid
--
--WHILE @@FETCH_STATUS = 0
--BEGIN 
--	set @fscrap=0
--
--	--取损耗率
--	select top 1 @fscrap=t2.fscrap,@fstockid=fstockid,@FSendItemDate=FSendItemDate
--	from ppbomentry t2 
--    inner join t_icitem t3 on t2.fitemid=t3.fitemid
--    where t2.finterid=@fppbominterid and t3.fnumber like '2.01.01.%'
--
--	--删除标签
--	delete t2 
--	from ppbomentry t2 
--    inner join t_icitem t3 on t2.fitemid=t3.fitemid
--    where t2.finterid=@fppbominterid and t3.fnumber like '2.01.01.%'
--
--	--重设分录ID
--	set @entryid=1
--	DECLARE authorsentry_cursor CURSOR FOR	
--	select t1.fentryid from ppbomentry t1 where t1.finterid=@fppbominterid order by t1.fentryid
--
--	OPEN authorsentry_cursor
--
--	FETCH NEXT FROM authorsentry_cursor 
--	INTO @fsourceentryid
--
--	WHILE @@FETCH_STATUS = 0
--	BEGIN 
--		update ppbomentry set fentryid=@entryid where finterid=@fppbominterid and fentryid=@fsourceentryid
--
--		set @entryid=@entryid+1
--
--		FETCH NEXT FROM authorsentry_cursor 
--		INTO @fsourceentryid
--	END
--
--	CLOSE authorsentry_cursor
--	DEALLOCATE authorsentry_cursor
--
--	--新增包材
--	DECLARE authorsentry_cursor CURSOR FOR	
--	select t2.fitemid,t2.fqty FQtyScrap,@fmoqty*t2.fqty FBomInputQty,(@fmoqty*t2.fqty*(1+@fscrap/100)) fqtymust,t2.funitid 
--	from t_BOSPackSub t1 inner join t_BOSPackSubEntry t2 on t1.fid=t2.fid where t1.fid=@fpacksubid
--
--	OPEN authorsentry_cursor
--
--	FETCH NEXT FROM authorsentry_cursor 
--	INTO @fitemid,@FQtyScrap,@FBomInputQty,@fqtymust,@funitid
--
--	WHILE @@FETCH_STATUS = 0
--	BEGIN 
--		--print @fitemid
--		--icmo fstatus 5 确认 0 计划 1,2 下达 3 结案  fmrp 11061 mps产生 1052 手工录入 11077 mrp产生 
--		--ppbomentry fqtyscrp 单位用量  FScrap 损耗率
--		Insert Into PPBOMEntry (FICMOinterID,   FBrNo,FInterID,      FEntryID,FItemID, FUnitID, FAuxQtyMust,FAuxQty,FMachinePos,FBomInputAuxQty,FauxQtyLoss,FSequenceID,FStockID, FNote,FSourceEntryID,FAuxQtyScrap,FScrap,  FSendItemDate,  FAuxQtyPick,  FSPID,FOperID,FOperSN,FMaterielType,FBackFlush,FMarshalType,FBOMInterID,FBatchNO )
--		Values (                @ficmointerid,'0',    @fppbominterid,@entryid,@fitemid,@funitid,@fqtymust,  0,      '',         @FBomInputQty,  0,          '',         @fstockid,'',   0,             @FQtyScrap,  @fscrap, @FSendItemDate, @FBomInputQty,0,    0,      0,      371,          1059,      385,         0,          '')
--
--		set @entryid=@entryid+1
--
--		FETCH NEXT FROM authorsentry_cursor 
--		INTO @fitemid,@FQtyScrap,@FBomInputQty,@fqtymust,@funitid
--	END
--
--	CLOSE authorsentry_cursor
--	DEALLOCATE authorsentry_cursor
--
--	EXEC prc_SHUpdateBillDoubleQty 88,@fppbominterid
--
--	FETCH NEXT FROM authors_cursor 
--	INTO @fmoqty,@ficmointerid,@fppbominterid,@fpacksubid
--END
--
--CLOSE authors_cursor
--DEALLOCATE authors_cursor
--
--set nocount off
--GO

--
----替换特殊标签(任务单确认的时候)-----------------------------++++++++++++++++++++++++++++++++
--IF EXISTS (select * from sysobjects where name='My_P_ReplaceExpLabelByICMO' and xtype='p')  drop  procedure My_P_ReplaceExpLabelByICMO
--
--go
--
--create procedure [dbo].My_P_ReplaceExpLabelByICMO(@finterid int)
--
--as
--
----declare @fuserid int select @fuserid=16405
--declare @fplanprice decimal(18,4),@fitemid int,@fpitemid int,@funitid int,@entryid int,@fqty int
--declare @InterID int,@BillNo varchar (20),@FStockId int,@StockNumber varchar (20)
--DECLARE @TmpID INT ,@fsupplyid int,@fcurrencyid int,@FMyPoInStockInterId int
--declare @fsupplyno varchar(20),@forderdate datetime,@FValueAddRate decimal(28, 2)
--declare @iLength int,@FPrice decimal(28, 5),@FAmount decimal(20, 2),@FExchangeRate decimal(28, 10)
--declare @FTaxPrice decimal(28, 5),@FTaxAmount decimal(20, 2),@SupplyId int
--declare @fprojectval  varchar(200),@fspid int,@fempid int,@fdeptid int
--declare @FDateFormat  varchar(200),@fdate datetime,@forginterid int,@ficmointerid int
--declare @fsourceNumber varchar(200),@fpSourceNumber varchar(200),@fpXxSourceNumber varchar(200)
--declare @fXxOldSourceNumber varchar(200),@empid int,@fsourcetrantype int
--declare @FDCStockID int,@xx_FItemIDOld int,@fxxitemid int,@FOrgPPOInterID int
--declare @FDCSPID int,@forderinterid int,@forderentryid int,@fppbominterid int,@fpacksubid int
--declare @fsourceInterid int,@fsourceEntryid int,@fsourceBillNo varchar (100)
--declare @fyear int,@fperiod int,@FMangerID int,@fmoqty decimal(24,2),@FSendItemDate datetime
--declare @fresultbillno varchar (800),@FQtyScrap decimal(24,2),@FBomInputQty decimal(24,2),@fqtymust decimal(24,2)
--declare @ftempbillno varchar(50),@fcostobjid int,@fplancommitdate datetime,@fsourceid int
--declare @fplanorderinterid int,@fbominterid int,@forgsaleinterid int,@forgentryid int,@fscrap decimal(24,4)
----AIS20041229163526   AIS20080129143619
----declare @fbout varchar(10),@fcommitdate datetime
--
--select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期
--set @forderdate=@fdate  --'2009-06-15' --下单日期
----set @fcommitdate='2009-07-21' --到货日期
--set @fresultbillno=''
--
--
----set @fbout='204'
--
--DECLARE authors_cursor CURSOR FOR	
--
--select t5.fqty fmoqty,t5.finterid,t8.finterid fppbominterid,t7.fid fpacksubid
--from icmo t5 
--inner join t_icitem t2 on t5.fitemid=t2.fitemid 
--inner join t_measureunit t3 on t3.fitemid=t2.funitid
----inner join icbom t4 on t2.fitemid=t4.fitemid
--inner join seorderentry t6 on t6.finterid=t5.forderinterid and t5.fsourceentryid=t6.fentryid
--inner join seorder t9 on t9.finterid=t6.finterid
--inner join t_BOSPackSub t7 on t7.fbillno=t6.fentryselfs0167
--inner join ppbom t8 on t8.ficmointerid=t5.finterid
--where t5.finterid=@finterid and t9.fdate>='2011-10-08'
--order by t5.fbillno
--
--set @entryid=1
--
--OPEN authors_cursor
--
--FETCH NEXT FROM authors_cursor 
--INTO @fmoqty,@ficmointerid,@fppbominterid,@fpacksubid
--
--WHILE @@FETCH_STATUS = 0
--BEGIN 
--	set @fscrap=0
--
--	--取损耗率
--	select top 1 @fscrap=t2.fscrap,@fstockid=fstockid,@FSendItemDate=FSendItemDate
--	from ppbomentry t2 
--    inner join t_icitem t3 on t2.fitemid=t3.fitemid
--    where t2.finterid=@fppbominterid and t3.fnumber like '2.01.01.%'
--
--	--删除标签
--	delete t2 
--	from ppbomentry t2 
--    inner join t_icitem t3 on t2.fitemid=t3.fitemid
--    where t2.finterid=@fppbominterid and t3.fnumber like '2.01.01.%'
--
--	--重设分录ID
--	set @entryid=1
--	DECLARE authorsentry_cursor CURSOR FOR	
--	select t1.fentryid from ppbomentry t1 where t1.finterid=@fppbominterid order by t1.fentryid
--
--	OPEN authorsentry_cursor
--
--	FETCH NEXT FROM authorsentry_cursor 
--	INTO @fsourceentryid
--
--	WHILE @@FETCH_STATUS = 0
--	BEGIN 
--		update ppbomentry set fentryid=@entryid where finterid=@fppbominterid and fentryid=@fsourceentryid
--
--		set @entryid=@entryid+1
--
--		FETCH NEXT FROM authorsentry_cursor 
--		INTO @fsourceentryid
--	END
--
--	CLOSE authorsentry_cursor
--	DEALLOCATE authorsentry_cursor
--
--	--新增包材
--	DECLARE authorsentry_cursor CURSOR FOR	
--	select t2.fitemid,t2.fqty FQtyScrap,@fmoqty*t2.fqty FBomInputQty,(@fmoqty*t2.fqty*(1+@fscrap/100)) fqtymust,t2.funitid 
--	from t_BOSPackSub t1 inner join t_BOSPackSubEntry t2 on t1.fid=t2.fid where t1.fid=@fpacksubid
--
--	OPEN authorsentry_cursor
--
--	FETCH NEXT FROM authorsentry_cursor 
--	INTO @fitemid,@FQtyScrap,@FBomInputQty,@fqtymust,@funitid
--
--	WHILE @@FETCH_STATUS = 0
--	BEGIN 
--		--print @fitemid
--		--icmo fstatus 5 确认 0 计划 1 下达 3 结案  fmrp 11061 mps产生 1052 手工录入 11077 mrp产生 
--		--ppbomentry fqtyscrp 单位用量  FScrap 损耗率
--		Insert Into PPBOMEntry (FICMOinterID,   FBrNo,FInterID,      FEntryID,FItemID, FUnitID, FAuxQtyMust,FAuxQty,FMachinePos,FBomInputAuxQty,FauxQtyLoss,FSequenceID,FStockID, FNote,FSourceEntryID,FAuxQtyScrap,FScrap,  FSendItemDate,  FAuxQtyPick,  FSPID,FOperID,FOperSN,FMaterielType,FBackFlush,FMarshalType,FBOMInterID,FBatchNO )
--		Values (                @ficmointerid,'0',    @fppbominterid,@entryid,@fitemid,@funitid,@fqtymust,  0,      '',         @FBomInputQty,  0,          '',         @fstockid,'',   0,             @FQtyScrap,  @fscrap, @FSendItemDate, @FBomInputQty,0,    0,      0,      371,          1059,      385,         0,          '')
--
--		set @entryid=@entryid+1
--
--		FETCH NEXT FROM authorsentry_cursor 
--		INTO @fitemid,@FQtyScrap,@FBomInputQty,@fqtymust,@funitid
--	END
--
--	CLOSE authorsentry_cursor
--	DEALLOCATE authorsentry_cursor
--
--	EXEC prc_SHUpdateBillDoubleQty 88,@fppbominterid
--
--	FETCH NEXT FROM authors_cursor 
--	INTO @fmoqty,@ficmointerid,@fppbominterid,@fpacksubid
--END
--
--CLOSE authors_cursor
--DEALLOCATE authors_cursor
--
--set nocount off
--GO

--


--生产汇报单触发器--更新--%%%%%
IF EXISTS (select * from sysobjects where name='My_Tri_ICMORpt_UP'  and xtype='TR')  drop  TRIGGER My_Tri_ICMORpt_UP
go

Create TRIGGER My_Tri_ICMORpt_UP ON [dbo].ICMORpt
FOR update

AS
BEGIN
	SET NOCOUNT ON

	declare @finterid int,@FMultiCheckLevel1 int,@fdate varchar(20),@fsourcetrantype int
	declare @fstatus int,@strPre varchar(50),@fcount varchar(20),@fcount2 varchar(20),@fbillno varchar(30)
	declare @fsrccommitfield_prevalue decimal(24,2),@fsrccommitfield_endvalue decimal(24,2)
	declare @fworkshop int,@fnextbillno varchar(50),@forderbillno varchar(50),@forderinterid int
	declare @fcheckdate datetime,@fitemid int

	select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期

	select top 1 @finterid=t1.finterid,@fstatus=t1.fstatus from inserted t1 

	if update(fstatus) and @fstatus=1
	begin
		update t1 set FHeadSelfJ1113=convert(varchar(50),getdate(),121) 
		from icmorpt t1 
		inner join inserted t2 on t1.finterid=t2.finterid
		where isnull(t1.FHeadSelfJ1113,'')=''
	end

	if update(fstatus) and @fstatus=0
	begin
		update t1 set FHeadSelfJ1113=''
		from icmorpt t1 
		inner join inserted t2 on t1.finterid=t2.finterid
	end

	set nocount off
end

go


--生产任务单触发器--更新--%%%%%--
IF EXISTS (select * from sysobjects where name='My_Tri_ICMO_UP'  and xtype='TR')  drop  TRIGGER My_Tri_ICMO_UP
go

Create TRIGGER My_Tri_ICMO_UP ON [dbo].ICMO
FOR update

AS
BEGIN
	SET NOCOUNT ON
	declare @finterid int,@FMultiCheckLevel1 int,@fdate varchar(20),@fsourcetrantype int
	declare @fstatus int,@strPre varchar(50),@fcount varchar(20),@fcount2 varchar(20),@fbillno varchar(30)
	declare @fsrccommitfield_prevalue decimal(24,2),@fsrccommitfield_endvalue decimal(24,2)
	declare @fworkshop int,@fnextbillno varchar(50),@forderbillno varchar(50),@forderinterid int
	declare @fcheckdate datetime,@fitemid int

	select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期

	select top 1 @finterid=t1.finterid,@fstatus=t1.fstatus,@fworkshop=t1.fworkshop,@fcheckdate=t1.fcheckdate,
	@forderbillno=isnull(t2.fbillno,''),@forderinterid=t1.forderinterid,@fbillno=t1.fbillno,@fitemid=t1.fitemid,
	@strPre=(case when t1.fworkshop=171817 then 'ZP' when t1.fworkshop=175 then 'ZP' when t1.fworkshop=176 then 'BZ' else 'QT' end) +left(@fdate,4) +substring(@fdate,6, 2)
	from inserted t1 left join seorder t2 on t1.forderinterid=t2.finterid

	--select fitemid,fname,* from t_department 175	装配车间 176	包装车间

	if @fstatus<>3 and exists(select 1 from t_bosfreezerequestentry t1 inner join t_bosfreezerequest t2 on t1.fid=t2.fid and t1.fitemid=@fitemid ) --and isnull(t2.FChecker,0)>0
		       and not exists(select 1 from icstockbill t1 inner join icstockbillentry t2 on t1.finterid=t2.finterid and t1.ftrantype=2 and t2.ficmointerid=@finterid)  --如果已经关联产品入库单，则说明是在下了任务单之后才冻结的
	begin
		RAISERROR('该物料已经生产冻结!',18,18)  --select * from t_submessage where ftypeid=10015 and fname like '%冻结%'
	end
	
	if update(fstatus) and @fstatus=1 and @fcheckdate>='2013-03-08' and @fworkshop in (175,171817)
	begin
		if left(@fbillno,4)='WORK' --下达时生成任务单号
		begin
			--if @fworkshop=176 --BZ201303002-1  ZP201303002
			--begin
			--	if exists(select 1 from icmo where forderinterid=@forderinterid and fbillno like 'BZ%')--存在则用已经有的,不存在则加1--一份订单不同的任务单可能在不同的月份下达
			--		select @fcount=cast((isnull(cast(substring(fbillno,9,3) as int),0)) as varchar(20)) from icmo where forderinterid=@forderinterid and fbillno like 'BZ%' and len(fbillno)>=11 --@strPre+'%'   --单据编号至少11位  --and fbillno like 'BZ%'--
			--	else
			--		select @fcount=cast((isnull(cast(max(substring(fbillno,9,3)) as int),0)+1) as varchar(20)) from icmo where fbillno like @strPre+'%' and len(fbillno)>=11  --单据编号至少11位
				
			--	select @fcount2=cast((isnull(cast(max(substring(fbillno,13,3)) as int),0)+1) as varchar(20)) from icmo where forderinterid=@forderinterid and fbillno like 'BZ%' and len(fbillno)>=11 --@strPre+Left('000', 3 - Len(@fcount))+'%' and len(fbillno)>=11  --单据编号至少11位

			--	select @fnextbillno=@strPre+Left('000', 3 - Len(@fcount))+ @fcount+'-'+Left('000', 3 - Len(@fcount2))+ @fcount2 
			--end
			--else
			--begin
			--	select @fcount=cast((isnull(cast(max(substring(fbillno,9,3)) as int),0)+1) as varchar(20)) from icmo where fbillno like @strPre+'%' and len(fbillno)>=11  --单据编号至少11位
			--	select @fnextbillno=@strPre+Left('000', 3 - Len(@fcount)) + @fcount 
			--end

			--update t1 set fbillno=@fnextbillno
			--from icmo t1 
			--inner join inserted t2 on t1.finterid=t2.finterid 
			--left join icstockbillentry t3 on t3.ficmointerid=t1.finterid
			--where t1.fbillno not like @strPre+'%'  --已经是这个格式了就不变了
			--and t3.finterid is null

			exec My_P_GenerateICMOBillNo @finterid
		end
	end

	if update(fstatus) and @fstatus=1 
	begin
		update t1 set FGMPBatchNo=t1.fbillno
		from icmo t1 
		inner join inserted t2 on t1.finterid=t2.finterid 
		inner join t_icitem t3 on t1.fitemid=t3.fitemid
		where left(t3.fnumber,1) in ('3','4') and t3.FBatchManager=1
	end

	--if update(fstatus) and @fstatus=5 and (@fworkshop=175 or @fworkshop=171817)
	--begin
	--	insert into my_t_scheduledetail (fdeptid,fbillerid, fsourcetrantype,ficmointerid,funitid,fitemid,fnote,fqty,fdate)
	--	select t1.fworkshop,t1.fconfirmerid,t1.ftrantype,t2.finterid,t2.funitid,t2.fitemid,'',t2.fqty,
	--	(case when t2.fplancommitdate<@fdate then @fdate when datediff(day,getdate(),t2.fplancommitdate)>30 then DATEADD(day,30,getdate()) else t2.fplancommitdate end)	
	--	from inserted t1
	--	inner join icmo t2 on t1.finterid=t2.finterid
	--	inner join t_icitem t3 on t2.fitemid=t3.fitemid
	--	where not exists (select 1 from my_t_scheduledetail m1 where m1.ficmointerid=t2.finterid and m1.fsourcetrantype=85)
	--	--and isnull(t2.fsourceinterid,0)<>0
	--end

--	if update(fstatus) and @fstatus=5  --确认的时候替换特殊标签
--	begin
--		exec My_P_ReplaceExpLabelByICMO @finterid
--	end
--
--	if update(fcommitqty)  --
--	begin
--		update t1 set fqtyfinish=t1.fcommitqty,fauxqtyfinish=t1.fcommitqty 
--		from icmo t1 
--		inner join inserted t2 on t1.finterid=t2.finterid
--		inner join t_icitem t3 on t1.fitemid=t3.fitemid
--		where t3.fshortnumber not like '6%'
--	end

	set nocount off
end

go


--生产任务单触发器--更新--%%%%%
IF EXISTS (select * from sysobjects where name='My_Tri_ICMO'  and xtype='TR')  drop  TRIGGER My_Tri_ICMO
go

Create TRIGGER My_Tri_ICMO ON [dbo].ICMO
FOR update,insert

AS
BEGIN
	SET NOCOUNT ON
	declare @finterid int,@FMultiCheckLevel1 int,@fdate varchar(20),@fsourcetrantype int
	declare @fstatus int,@strPre varchar(50),@fcount varchar(20),@fcount2 varchar(20),@fbillno varchar(30)
	declare @fsrccommitfield_prevalue decimal(24,2),@fsrccommitfield_endvalue decimal(24,2)
	declare @fworkshop int,@fnextbillno varchar(50),@forderbillno varchar(50),@forderinterid int
	declare @fcheckdate datetime

	select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期

	select top 1 @finterid=t1.finterid,@fstatus=t1.fstatus,@fworkshop=t1.fworkshop,@fcheckdate=t1.fcheckdate,
	@forderbillno=isnull(t2.fbillno,''),@forderinterid=t1.forderinterid,@fbillno=t1.fbillno,
	@strPre=(case when t1.fworkshop=171817 then 'ZP' when t1.fworkshop=175 then 'ZP' when t1.fworkshop=176 then 'BZ' else 'QT' end) +left(@fdate,4) +substring(@fdate,6, 2)
	from inserted t1 left join seorder t2 on t1.forderinterid=t2.finterid

	--如果是先下采购订单再下任务单则在此生效
	update t4 set fheadselfj0180=t6.FSupplyID
	from seorder t1
	inner join seorderentry t2 on t1.finterid=t2.finterid
	inner join t_icitem t3 on t2.fitemid=t3.fitemid
	inner join icmo t4 on t4.forderinterid=t2.finterid and t4.fsourceentryid=t2.fentryid
	inner join poorderentry t5 on t5.fsourceinterid=t2.finterid and t5.fsourceentryid=t2.fentryid and t5.fsourcetrantype=81
	inner join inserted t6 on t4.finterid=t6.finterid
	where isnull(t2.fentryselfs0175,0) in (40090,40091) --select * from t_submessage where finterid in (40090,40091)

	update t1 set FEntrySelfY0121=isnull(t2.fqty,0),FEntrySelfY0122=t1.fqty-isnull(t2.fqty,0)  --
	from pporderentry t1 --
	inner join 
	(
		select t1.FPPOrderInterID,t1.fsourceentryid,t1.fitemid,sum(t1.fqty) fqty
		from icmo t1 
		inner join 
		(	  
			select distinct t1.FPPOrderInterID 
			from icmo t1--
			inner join inserted t2 on t1.finterid=t2.finterid
			--where t1.finterid=@FInterID
		) t2 on t1.FPPOrderInterID=t2.FPPOrderInterID
		group by t1.FPPOrderInterID,t1.fsourceentryid,t1.fitemid
	) t2 on t1.finterid=t2.FPPOrderInterID and t1.FEntryID=t2.fsourceentryid and t1.fitemid=t2.fitemid

	--纯PCS数
	update x set x.FHeadSelfJ0183=x.FQty*isnull(y.fqty,1)
	from icmo x 
	left join 
	(
		select c.fitemid,isnull(sum(isnull(b.fqty,1)),1)  as fqty
		from icbom a inner 
		join icbomchild b on a.finterid=b.finterid					
		inner join t_icitem c on a.fitemid=c.fitemid
		inner join t_icitem d on b.fitemid=d.fitemid
		where left(d.fnumber,1) in ('3','4','5','7','8')
		group by c.fitemid
	) y on x.fitemid=y.fitemid
	where x.finterid=@finterid --and t1.fdate>='2016-05-03'

	update t1 set FHeadSelfJ0178=t1.fqty*isnull(y.fqty,1)-isnull(t1.fqtyfinish,0)*isnull(y.fqty,1) ,
	FHeadSelfJ0179=t1.fqty*isnull(y.fqty,1)-isnull(t1.fstockqty,0)*isnull(y.fqty,1),
	FHeadSelfJ0184=t1.fcommitqty*isnull(y.fqty,1),
	FHeadSelfJ0185=t1.fqty*isnull(y.fqty,1)-t1.fcommitqty*isnull(y.fqty,1)
	from icmo t1 
	inner join inserted t2 on t1.finterid=t2.finterid
	left join 
	(
		select c.fitemid,isnull(sum(isnull(b.fqty,1)),1)  as fqty
		from icbom a inner 
		join icbomchild b on a.finterid=b.finterid					
		inner join t_icitem c on a.fitemid=c.fitemid
		inner join t_icitem d on b.fitemid=d.fitemid
		where left(d.fnumber,1) in ('3','4','5','7','8')
		group by c.fitemid
	) y on t1.fitemid=y.fitemid

	set nocount off
end

go

--从傲威/超威导入生成终端客户
--My_p_GenerateFinalCust 123,'xyz','acainew heel',0
IF EXISTS (select * from sysobjects where name='My_p_GenerateFinalCust' and xtype='p')  drop  procedure My_p_GenerateFinalCust

go

create procedure [dbo].My_p_GenerateFinalCust(@fcompanyid int,@fcustguid varchar(100),@fcustname varchar(200),@fitemid int output)
with encryption 
as
SET NOCOUNT ON

if not exists(select * from t_item_3007 where F_101=@fcustguid)
begin
	declare @ParentCusttNo varchar(50)
	declare @CustNo varchar(50),@FullCustNo varchar(50)
	declare @ParentCustId int,@ParentCustLevel int
	declare @ParentCustName varchar(200)
	declare @DealInfo varchar(100)

	set @DealInfo =''

	if @fcompanyid=123
		set @ParentCusttNo='B'

	if not exists (select * from t_item where fitemclassid=3007 and fdetail=0 and fnumber=@ParentCusttNo)
	begin
		set @DealInfo='未找到上级组:'+@ParentCusttNo+' !终端客户:'+@fcustname+'导入未成功!;'
		goto ErrDeal
	end
	else
	begin
		select @ParentCustName=fname from t_item where fitemclassid=3007 and fdetail=0 and fnumber=@ParentCusttNo
	end

	select @CustNo=isnull(left('000000',(len('000000')-len((max(cast(fshortnumber as int))+1))))+CAST((max(cast(fshortnumber as int))+1) as varchar(10)),'000000') from t_item where fitemclassid=3007 and fnumber like @ParentCusttNo+'.%'

	set @FullCustNo=@ParentCusttNo+'.'+@CustNo

	select @ParentCustId=FItemID,@ParentCustLevel=FLevel from t_Item where FItemClassID = 3007 And FNumber = @ParentCusttNo
		
	INSERT INTO t_Item (FItemClassID,FParentID,	    FLevel,			    FName,      FNumber,    FShortNumber,  FFullNumber,    FDetail,UUID,   ffullname) 
		VALUES         (3007,        @ParentCustId, @ParentCustLevel+1, @FCustName, @FullCustNo,@CustNo, 	   @FullCustNo,    1,      newid(),@ParentCustName+'_'+@FCustName)
	
	select @fitemid=fitemid from t_item where FItemClassID = 3007 and fshortnumber=@CustNo

	INSERT INTO t_item_3007 (F_101,     FNumber,     FName,     FItemID) 
					 VALUES (@fcustguid,@FullCustNo, @FCustName,@fitemid)

	--Insert Into t_ItemRight (FTypeID,FUserID,FItemID)  select fitemclassid,fuserid,@DeptId from t_useritemclassright where (( FUserItemClassRight &  8)=8) and fitemclassid=2 and fuserid<>@UserId
	
	INSERT INTO t_Log (FDate,    FUserID,FFunctionID,FStatement,FDescription,FMachineName,FIPAddress) 
			   VALUES (getdate(),16394,  'A00701',5,'新建核算项目:'+@FullCustNo+' 核算项目类别:终端客户','KSW103','192.168.0.89')
	
	Insert Into t_BaseProperty(FTypeID,  FItemID,  FCreateDate,       FCreateUser, FLastModDate, FLastModUser, FDeleteDate, FDeleteUser)
			Values(	   3,      @fitemid, getdate(),'administrator',   Null, Null, Null, Null)
end
else
begin
	select @fitemid=fitemid from t_item_3007 where F_101=@fcustguid
	update t1 set fname=@FCustName from t_item_3007 t1 where F_101=@fcustguid
	update t1 set fname=@FCustName from t_item t1 inner join t_item_3007 t2 on t1.fitemid=t2.fitemid where t2.F_101=@fcustguid
end

ErrDeal:

set nocount off

go


--销售发票触发器--
IF EXISTS (select * from sysobjects where name='My_Tri_ICSale'  and xtype='TR')  drop  TRIGGER My_Tri_ICSale
go

Create TRIGGER My_Tri_ICSale ON [dbo].ICSale
FOR insert,update

AS
BEGIN
	SET NOCOUNT ON

	declare @finterid int,@fbillno varchar(50),@FMultiCheckLevel1 int,@fdate datetime,@fstatus int,@s varchar(800)
	declare @POInStockBillNo varchar(40),@fsourceinterid int

	select top 1 @fstatus=fstatus,@fbillno=fbillno,@finterid=finterid,@FMultiCheckLevel1=isnull(FMultiCheckLevel1,0),
	@fdate=replace(convert(varchar(10),FMultiCheckDate1,111),'/','-'),@s=''
	from inserted

	--纯PCS数
	update x set x.FEntrySelfI0462=x.FQty*isnull(y.fqty,1)
	from icsaleentry x left join 
			(
				select c.fitemid,isnull(sum(isnull(b.fqty,1)),1)  as fqty
				from icbom a inner join icbomchild b on a.finterid=b.finterid
									inner join t_icitem c on a.fitemid=c.fitemid
									inner join t_icitem d on b.fitemid=d.fitemid
			where left(d.fnumber,1) in ('3','4','5','7','8')
				group by c.fitemid
			) y on x.fitemid=y.fitemid
	inner join icsale t1 on t1.finterid=x.finterid
	where x.finterid=@finterid --and t1.fdate>='2016-05-03'

	update t2 set FEntrySelfI0459=isnull(y.fheadselfs0143,'')/*源采购订单号*/,FEntrySelfI0458=isnull(y.fheadselfs0144,'')/*源销售订单号*/
	from seorderentry x 
	inner join seorder y on x.finterid=y.finterid
	inner join icsaleentry t2 on t2.forderinterid=x.finterid and t2.forderentryid=x.fentryid
	inner join inserted t3 on t2.finterid=t3.finterid

	update t2 set FEntrySelfI0460=isnull(y.fheadselfb0157,''),/*源销售发票号*/FEntrySelfI0461=isnull(y.fheadselfb0156,'')/*源采购发票号*/
	from icstockbillentry x 
	inner join icstockbill y on x.finterid=y.finterid and y.ftrantype=21
	inner join icsaleentry t2 on t2.fsourceinterid=x.finterid and t2.fsourceentryid=x.fentryid
	inner join inserted t3 on t2.finterid=t3.finterid

	if exists (select 1 from icsaleentry t8 
	inner join inserted t9 on t9.finterid=t8.finterid 
	where t9.fdate>='2016-09-01' and t8.ftaxprice=0 and t9.fcustid=206811)
	begin
			RAISERROR('单价不能为0',18,18)
	end

	set nocount off
end

go


--modify at 2016-08-03
--从傲威/超威导入生成销售订单
--My_p_GenerateSeorder 123,16394,0
IF EXISTS (select * from sysobjects where name='My_p_GenerateSeorder' and xtype='p')  drop  procedure My_p_GenerateSeorder

go

create procedure [dbo].My_p_GenerateSeorder (@fcompanyid int,@fuserid int ,@InterID int output)
--with encryption 
as
SET NOCOUNT ON

--declare @fcompanyid int,@fuserid int ,@InterID int select @fcompanyid=123,@fuserid=16394,@InterID=0

declare @fplanprice decimal(18,4),@fitemid int,@fpitemid int,@funitid int,@entryid int,@fqty int
declare @BillNo varchar (20),@FStockId int,@StockNumber varchar (20),@fmapnumber varchar(50),@fmapname varchar(50)
DECLARE @TmpID INT ,@fsupplyid int,@fcurrencyid int,@FMyPoInStockInterId int,@fsebillno varchar(50)
declare @fsupplyno varchar(20),@forderdate datetime,@FValueAddRate decimal(28, 2),@FPackRequire varchar(500)
declare @iLength int,@FPrice decimal(28, 6),@FAmount decimal(20, 2),@fcommitdate datetime
declare @FTaxPrice decimal(28, 6),@FTaxAmount decimal(20, 2),@SupplyId int,@FAllStdAmount decimal(24,2)
declare @fprojectval  varchar(200),@fspid int,@fempid int,@fdeptid int,@forderbillno varchar(50)
declare @FDateFormat  varchar(200),@fdate datetime,@fcustid int,@fquobillno varchar(50)
declare @fsourceNumber varchar(200),@fpSourceNumber varchar(200),@fpXxSourceNumber varchar(200)
declare @fXxOldSourceNumber varchar(200),@empid int,@fmanagerid int,@fmapitemid int
declare @FDCStockID int,@xx_FItemIDOld int,@fxxitemid int,@fstdpackprice decimal(24,6),@fsourceprice decimal(24,6)
declare @FDCSPID int,@forderinterid int,@forderentryid int,@fpoitemtype varchar(50)
declare @fsourceInterid int,@fsourceEntryid int,@fsourceBillNo varchar (100),@fothernote1 varchar(800)
declare @fyear int,@fperiod int,@FMangerID int,@FExchangeRate decimal(28,10),@fothernote2 varchar(800)
declare @fresultbillno varchar (800),@fnote varchar(500),@fempshortname varchar(40)
declare @ftempbillno varchar(50),@fremark varchar(500),@fcess decimal(24,2),@fpackprice decimal(24,6)
declare @fallamount decimal(24,2),@fordertype varchar(50),@FTaxAmt decimal(24,2),@fnudepackprice decimal(24,6)
declare @fexportdistrict varchar(50),@fpricetype varchar(50),@finalcustid int,@fsourcecyid int
declare @foldprice1 decimal(24,4),@foldprice2 decimal(24,4),@foldprice3 decimal(24,4)
declare @FChipID int,@FChipVerID int,@FPackSubID int,@FChildItemID int,@fbgbrand varchar(50)

select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期
select @forderdate=@fdate,@fcommitdate=@fdate  --'2009-06-15' --下单日期
--set @fcommitdate='2009-07-15' --到货日期

set @fresultbillno=''
--set @fempid=19784  --select fname,* from t_emp where fname like '%%'
--set @fdeptid=19781

declare @fyearmonth varchar(50),@fbillcount int,@fpacknote varchar(2000)

set @FPackRequire=''
set @fyear=year(@fdate)
set @fperiod=month(@fdate)

--set @fuserid=16454  
set @fresultbillno=''
set @FMangerID=0 --19787
--set @fbout='204'

select @fcustid=fitemid,@fempid=femployee from t_Organization where fitemid=@fcompanyid

DECLARE icbom_cursor CURSOR FOR	

select top 1 isnull(t1.fsourcecyid,0) fsourcecyid,t1.fbillno,isnull(t1.fcustid,0) finalcustid,@fcustid fsupplyid,@fempid fempid,
isnull(t4.fcurrencyid,1000) fcurrencyid,isnull(t1.fothernote1,'') fothernote1,
isnull(t1.fothernote2,'') fothernote2,
211 fmanagerid,22358 fdeptid,t1.fsebillno,t1.fpacknote --整单包装说明
from myseorder t1
inner join myseorderentry t3 on t1.finterid=t3.finterid
inner join t_icitem t2 on t3.fitemid=t2.fitemid
left join t_currency t4 on t1.fcurrency=t4.fnumber
where t1.fuserid=@fuserid --and t2.fnumber not like '6.05.%'

--select * from t_currency
--select fshortnumber,fname,fitemid from t_supplier where fshortnumber in ('d63','b11','d61','d64')
--select * from my_t_MrpResultDetail
--select top 100 *  from icmrpresult  select * from t_emp where fname like '%'

OPEN icbom_cursor

FETCH NEXT FROM icbom_cursor 
INTO @fsourcecyid,@forderbillno,@finalcustid,@fsupplyid,@fempid,@FCurrencyID,@fothernote1,@fothernote2,@fmanagerid,@fdeptid,@fsebillno,@fpacknote

WHILE @@FETCH_STATUS = 0
BEGIN 
	select @fexchangerate=fexchangerate from t_currency where fcurrencyid=@fcurrencyid 

	exec GetICMaxNum 'Seorder', @InterID output

	-- 10.4
	Update t_BillCodeRule Set FReChar = FReChar Where FBillTypeID =81

	SET @TmpID = (SELECT FID FROM t_BillCodeRule WITH(READUNCOMMITTED) WHERE fbilltypeid=81 and fprojectid=3)

	update t_billcoderule set fprojectval = fprojectval+1,flength=case when (flength-len(fprojectval)) >= 0 then flength else len(fprojectval) end where FID =  @TmpID 
	Update ICBillNo Set FCurNo = (select top 1 isnull(fprojectval,1) from t_billcoderule where fprojectid = 3 and fbilltypeid =81) where fbillid = 81
	   
	--长度和目前编码
	select @fprojectval=(fprojectval-1),@iLength=flength from t_BillCodeRule where fprojectid = 3 and fbilltypeid = 81
	  
	-- 前缀
	select @BillNo=fprojectval+left('0000000000',@iLength-(len(@fprojectval)))+@fprojectval from t_BillCodeRule where fprojectid = 1 and fbilltypeid = 81  --@iLength
    
	--自定义单据编号
	declare @fstrdate varchar(20),@fpre varchar(20),@fcount varchar(50)
	select @fstrdate=replace(convert(varchar(10),getdate(),111),'/','-')
	select @fpre='XW' + substring(@fstrdate, 3, 2) + substring(@fstrdate, 6, 2)
	select @fcount=cast((isnull(cast(max(substring(fbillno,7,3)) as int),0)+1) as varchar(20)) from seorder where fbillno like @fpre+'%' and len(fbillno)=9
	select @BillNo=@fpre+Left('000', 3 - Len(@fcount)) + @fcount

	--select t1.fitemid,t1.fsupplyno,t1.fsupplyid,t1.FExchangeRate,t1.FValueAddRate,t1.funitid,t1.fqty,t1.fprice,t1.famount,t1.ftaxprice,t1.ftaxamount from #mydate t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid where t2.ferpclsid=1 and t1.fsupplyid=@fsupplyid and t1.FCurrencyID=@FCurrencyID order by t2.fhelpcode

	/*
	订单类型
	40001	01	正常销售订单
	40002	02	特价销售订单
	*/

	DECLARE authors_cursor CURSOR FOR	
	select t1.fmapitemid 对应内码,t1.fmapnumber 对应编码,t1.fmapname 对应名称,t1.fitemid 产品内码,
	isnull(t1.fsourceprice,0) 源单价,t1.fnudeprice 裸包单价,t2.funitid 单位内码,t1.fqty 数量,
	(case when @FCurrencyID=1 then 17.00 else 0.00 end) 税率,--人民币的改成17
	isnull(t1.fpackprice,0) 包装单价,t1.fnote 备注,isnull(t1.fbgbrand,'') 报关品牌
	from myseorderentry t1
	inner join t_icitem t2 on t1.fitemid=t2.fitemid
	where t1.fuserid=@fuserid --and t2.fnumber not like '6.05.%'
	order by t1.fentryid

    set @entryid=1

	OPEN authors_cursor

	FETCH NEXT FROM authors_cursor 
	INTO @fmapitemid,@fmapnumber,@fmapname,@fitemid,@fsourceprice,@fnudepackprice,@funitid,@fqty,@fcess,@fpackprice,@fnote,@fbgbrand

	WHILE @@FETCH_STATUS = 0
	BEGIN 
		if not exists(select 1 from ICItemMapping where fitemid=@fitemid and fid=4 and fcompanyid=@fcompanyid and fpropertyid=1)
		begin
			insert into ICItemMapping(fmapitemid, fid,fitemid,fpropertyid,fcompanyid, fmapnumber, fmapname)
			values(					  @fmapitemid,4, @fitemid,1,          @fcompanyid,@fmapnumber,@fmapname)
		end
		else
		begin
			update ICItemMapping set fmapitemid=@fmapitemid,fmapnumber=@fmapnumber,fmapname=@fmapname where fitemid=@fitemid and fid=4 and fcompanyid=@fcompanyid and fpropertyid=1
		end

		select @FChipID=0,@FChipVerID=0,@FPackSubID=0,@FChildItemID=0

		if isnull(@finalcustid,0)>0
		begin
			select top 1 @FChipID=isnull(t2.fentryselfs0161,0),@FChipVerID=isnull(t2.fentryselfs0160,0),@FPackSubID=isnull(t2.fentryselfs0158,0),@FChildItemID=isnull(t2.fentryselfs0164,0)
			from seorder t1
			inner join seorderentry t2 on t1.finterid=t2.finterid
			inner join t_icitem t9 on t9.fitemid=t2.fentryselfs0164 and t9.fdeleted=0  --半成品
			inner join t_item t13 on t13.fitemid=t2.fentryselfs0160 and t13.fitemclassid=3006 and t13.fdeleted=0 --芯片版本  --16465  无芯片
			inner join t_icitem t10 on t10.fitemid=t2.fentryselfs0161 and t10.fdeleted=0 --芯片
			inner join t_item t19 on t19.fitemclassid=3002 and t19.fitemid=t2.fentryselfs0158 and t19.fdeleted=0  --包装方式
			where t1.FHEADSELFS0145=@finalcustid and t2.fitemid=@FItemId and t1.fstatus>0 
			order by t1.finterid desc
		end

		select @ftaxprice=@fnudepackprice+@fpackprice
		select @fprice=@ftaxprice/(1+@fcess/100),@famount=@fprice*@fqty
		select @fallamount=@ftaxprice*@fqty
		select @FAllStdAmount=@fallamount*@FExchangeRate
		select @FTaxAmt=@famount*(@fcess/100)  --销项税额 --fentryselfs0163 裸包单价 --fentryselfs0169 实际裸包单价 fentryselfs0168 价格类别 fentryselfs0164 包装单价 fentryselfs0165 标准包装单价

		INSERT INTO SEOrderEntry (FEntrySelfS0177,fentryselfs0161,fentryselfs0160,fentryselfs0158,fentryselfs0164,fentryselfs0173,fentryselfs0170,FInterID,FEntryID,FBrNo,FMapNumber, FMapName, FItemID, fnote, FAuxPropID,FQty, FUnitID, Fauxqty,FSecCoefficient,FSecQty,Fauxprice,ftaxprice, FAuxTaxPrice,     Famount, FCess,          FTaxRate,FUniDiscount,FTaxAmount,FAuxPriceDiscount, FTaxAmt,          FAllAmount,               FTranLeadTime,FInForecast,FDate, FBomInterID,FCostObjectID,FAdviceConsignDate,FATPDeduct,FLockFlag,FSourceBillNo,FSourceTranType,FSourceInterId,FSourceEntryID,FContractBillNo,FContractInterID,FContractEntryID,FAuxQtyInvoice,FSecInvoiceQty,FQtyInvoice,FSecCommitInstall,FCommitInstall,FAuxCommitInstall,FAllStdAmount,   FMrpLockFlag,FHaveMrp,FReceiveAmountFor_Commit) 
		VALUES (                  @fbgbrand,      @FChipID,       @FChipVerID,    @FPackSubID,    @FChildItemID,  @fsourceprice,  @fqty,          @InterId,@EntryId,'0',  @fmapnumber,@fmapname,@FItemId,@fnote,0,         @fqty,@funitid,@fqty,  0              ,0,      @fprice,  @ftaxprice,@ftaxprice/*117*/,@famount,@FCess/*17*/,   0,       0,           0,         @ftaxprice/*117*/, @FTaxAmt/*204*/,  @FAllAmount/*1404*/,      '0',          0,          @fdate,0,          '0',          @fcommitdate,      0,         0,        '',           0,              0,             0,             '',             0,               0,               0,             0,             0,          0,                0,             0,                @FAllStdAmount,  0,           0,       0) 

		set @entryid=@entryid+1

		FETCH NEXT FROM authors_cursor 
		Into @fmapitemid,@fmapnumber,@fmapname,@fitemid,@fsourceprice,@fnudepackprice,@funitid,@fqty,@fcess,@fpackprice,@fnote,@fbgbrand
	END

	CLOSE authors_cursor
	DEALLOCATE authors_cursor

	--FHeadSelfS0147 订单类型,FHeadSelfS0142 验货需求,FHeadSelfS0143 验货方式,FHeadSelfS0144 备损率
	INSERT INTO SEOrder(FHEADSELFS0148,FHEADSELFS0153,FHEADSELFS0145,FHEADSELFS0142,fheadselfs0143,fheadselfs0141,fheadselfs0144,FInterID,FBillNo,FBrNo,FTranType,FCancellation,FStatus,FDiscountType,Fdate, FCustID,   FSaleStyle,FFetchStyle,FCurrencyID, FFetchAdd,FCheckDate,FMangerID,      FDeptID, FEmpID, FBillerID,FSettleID,FExchangeRate,  FMultiCheckLevel1,FMultiCheckDate1,FMultiCheckLevel2,FMultiCheckDate2,FMultiCheckLevel3,FMultiCheckDate3,FMultiCheckLevel4,FMultiCheckDate4,FMultiCheckLevel5,FMultiCheckDate5,FMultiCheckLevel6,FMultiCheckDate6,FPOOrdBillNo,FRelateBrID,FTransitAheadTime,FImport,FSelTranType,FBrID,FSettleDate, FExplanation,FAreaPS,FManageType) 
	VALUES (            '1900-01-01',  @fsourcecyid,  @finalcustid,  @fothernote1, @forderbillno, @fpacknote,    @fsebillno,    @InterId,@BillNo,'0',  81,       0,            0,      0,            @fdate,@fsupplyid,101,       '1004',     @FCurrencyID,'',       Null,      @fmanagerid,    @FDeptID,@FEmpID,@fuserid, 0,        @fexchangerate, Null,             Null,            Null,             Null,            Null,             Null,            Null,             Null,            Null,             Null,            Null,             Null,            '',          0,          '0',              0,      0,           0,    @fcommitdate,'',          20302,  0)

	update t2 set 
	fprice=t2.FTaxPrice/(1+t2.fcess/100),--单价与折扣率没关系
	FAuxPrice=t2.FTaxPrice/(1+t2.fcess/100),
	famount=cast(t2.fqty*t2.FTaxPrice*(1-t2.FTaxRate/100)/(1+t2.fcess/100) as decimal(28,2)),--不是等于单价×数量
	fpricediscount=t2.FTaxPrice*(1-t2.FTaxRate/100),--实际含税单价
	fauxpricediscount=t2.FTaxPrice*(1-t2.FTaxRate/100),
	ftaxamount=cast(t2.fqty*t2.FTaxPrice*t2.FTaxRate/100 as decimal(28,2)),--折扣额
	FTaxAmt=cast(t2.fqty*t2.FTaxPrice*(1-t2.FTaxRate/100)/(1+t2.fcess/100)*(t2.fcess/100) as decimal(28,2)) --税额
	from seorder t3
	inner join seorderentry t2 on t3.finterid=t2.finterid
	where t3.finterid=@interid

	update t2 set fallAmount=cast((t2.FTaxAmt+t2.famount) as decimal(28,2))
	from seorder t3
	inner join seorderentry t2 on t3.finterid=t2.finterid
	where t3.finterid=@interid

	update t2 set FAllStdAmount=cast(t2.fallAmount*t3.fexchangerate as decimal(28,2))  --单独更新  --价税合计！！！！！！！！！！！！！！！！！！
	from seorder t3
	inner join seorderentry t2 on t3.finterid=t2.finterid
	where t3.finterid=@interid

    EXEC p_UpdateBillRelateData 81,@interid  --通过非Aux来更新Aux,非AUX为基本单位

	set @fresultbillno=@fresultbillno+@billno

	FETCH NEXT FROM icbom_cursor 
    INTO @fsourcecyid,@forderbillno,@finalcustid,@fsupplyid,@fempid,@FCurrencyID,@fothernote1,@fothernote2,@fmanagerid,@fdeptid,@fsebillno,@fpacknote
END

CLOSE icbom_cursor
DEALLOCATE icbom_cursor

set nocount off

GO



--导入生成MPS-----------------------------++++++++++++++++++++++++++++++++
/*
IF EXISTS (select * from sysobjects where name='My_p_GenerateMps' and xtype='p')  drop  procedure My_p_GenerateMps

create procedure My_p_GenerateMps (@iUserID int,@fbegBillNo varchar(40) output,@fEndBillNo varchar(40) output)
with encryption
as
declare @forderinterid int ,@forderentryid int,@fdeptid int,@fitemid int
declare @fqty int,@fdate datetime,@InterID int,@fprojectval varchar(100)
declare @BillNo varchar(50),@TmpID int,@RunID int,@funitid int,@fbominterid int,@iLength int
declare @i int,@forginterid int,@FOrgSaleInterID int,@FOrgPPOInterID int,@fsourcetrantype int

ALTER TABLE ICMRPResult DISABLE Trigger ICMrpResult_Del

update u1
set u1.FChildren = (case when u1.FChildren > v1.FPLSum then u1.FChildren - v1.FPLSum else 0 end)
from SEOrder u1
inner join 
(select u1.FInterID,Count(v1.FInterID) as FPLSum
from SEOrder u1
inner join ICMrpResult v1 on u1.FInterID = v1.FOrgSaleInterID
where v1.FInterID = 0
group by u1.FInterID) v1 on u1.FInterID = v1.FInterID

set @i=1


DECLARE icbom_cursor CURSOR FOR	

/*
select min(t1.finterid) forginterid,t1.forderinterid,t1.forderentryid,t1.fitemid,t1.fdate,sum(t1.fqty) fqty,t1.fdeptid,t2.funitid,t4.finterid fbominterid
from My_t_ScheduleDetail t1 
inner join t_icitem t2 on t1.fitemid=t2.fitemid 
inner join t_measureunit t3 on t3.fitemid=t2.funitid
left join icbom t4 on t2.fitemid=t4.fitemid and t4.fusestatus=1072
where t1.fissel=1
group by t1.forderinterid,t1.forderentryid,t1.fitemid,t1.fdate,t1.fdeptid,t2.funitid,t4.finterid
order by t1.fdeptid,min(t1.finterid)
*/

select t1.fsourcetrantype,t1.finterid,t1.forderinterid,t1.forderentryid,t1.fitemid,t1.fdate,t1.fqty,t1.fdeptid,t2.funitid,t4.finterid fbominterid
from My_t_ScheduleDetail t1 
inner join t_icitem t2 on t1.fitemid=t2.fitemid 
inner join t_measureunit t3 on t3.fitemid=t2.funitid
left join icbom t4 on t2.fitemid=t4.fitemid and t4.fusestatus=1072
where t1.fissel=1
order by t1.fdeptid,t2.fnumber,t1.finterid

--select top 100 *  from MySchedulingDetail t1 where t1.fissel=1

OPEN icbom_cursor

FETCH NEXT FROM icbom_cursor 
INTO @fsourcetrantype,@forginterid,@forderinterid,@forderentryid,@fitemid,@fdate,@fqty,@fdeptid,@funitid,@fbominterid

WHILE @@FETCH_STATUS = 0
BEGIN 
	if @fsourcetrantype=81
		select @FOrgSaleInterID =@forderinterid,@FOrgPPOInterID=0
	else
		select @FOrgSaleInterID =0,@FOrgPPOInterID=@forderinterid

	exec GetICMaxNum 'ICMrpResult', @InterID output

	-- 10.4
	Update t_BillCodeRule Set FReChar = FReChar Where FBillTypeID =500

	SET @TmpID = (SELECT FID FROM t_BillCodeRule WITH(READUNCOMMITTED) WHERE fbilltypeid=500 and fprojectid=3)

	update t_billcoderule set fprojectval = fprojectval+1,flength=case when (flength-len(fprojectval)) >= 0 then flength else len(fprojectval) end where FID =  @TmpID 
	Update ICBillNo Set FCurNo = (select top 1 isnull(fprojectval,1) from t_billcoderule where fprojectid = 3 and fbilltypeid =500) where fbillid = 500
	   
	--长度和目前编码
	select @fprojectval=(fprojectval-1),@iLength=flength from t_BillCodeRule where fprojectid = 3 and fbilltypeid = 500
	  
	--日期
	--select fprojectval,GetDate() AS DateNow from t_BillCodeRule where fprojectid = 2 and fbilltypeid = 100
	  --  sDateFormat = tempRs.Fields(fprojectval)
	  --  sDateFormat = Format(DateValue(tempRs.Fields(DateNow)), sDateFormat)

	-- 前缀
	select @BillNo=fprojectval+left('0000000000',@iLength-(len(@fprojectval)))+@fprojectval from t_BillCodeRule where fprojectid = 1 and fbilltypeid = 500  --@iLength

	--update ICBillNo set FCurNo=FCurNo+1 where FBillID=100
	--select @BillNo=FPreLetter+CAST(FCurNo as varchar(10)) from ICBillNo where FBillID= 100
               	
    if @i=1 
		set @fbegBillNo=@BillNo

	INSERT INTO 
	ICMrpResult(FHeadSelfJ0541,FInterID,FBillNo,FBrNo,FTranType,FCancellation,Fstatus,FMrpClosed,FItemID, FUseUnitID,FAuxNoBatchQty,FNeedDate,FAuxNeedQty,FPlanBeginDate,FAuxPlanQty,FItemType,FPlanEndDate,FSourceID,FWorktypeID,FAuxPutInQty,FAuxHaveOrderQty,FOrgSaleInterID,  FOrgPPOInterID, FOrgEntyrID,   FCheckDate,FSrcSaleInterID,FSrcPPOInterID,FSrcPPBomInterID,FSrcPlanOrderInterID,FSrcICMOInterID,FSrcReICMOInterID,FBom,        FMRPDate,FRunID,FType,FSupplyID,FUnitID, FCloseType,FMrpLockFlag) 
	VALUES     (@forginterid,  @InterID,@BillNo,'0',  500,      0,            0,      0,         @fitemid,@funitid,  0,             @fdate,   0,          @fdate,        @fqty,      11011,    @fdate,      @fdeptid, 55,         @fqty,       0,               @FOrgSaleInterID, @FOrgPPOInterID,@forderentryid,Null,      0,              0,             0,               0,                   0,              0,                @fbominterid,@fdate,  0,     0,    0,        @funitid,0,         0          )

	ALTER TABLE ICMRPResult DISABLE Trigger Update_ICMrpResult

	UPDATE T1 SET T1.FUnitID=T3.FUnitID
				 ,T1.FAuxPlanQty=ROUND(T1.FAuxPlanQty,T3.FQtyDecimal)         
				 ,T1.FAuxPutInQty=ROUND(T1.FAuxPutInQty,T3.FQtyDecimal)
				 ,T1.FAuxNoBatchQty=ROUND(T1.FAuxNoBatchQty,T3.FQtyDecimal)
				 ,T1.FAuxNeedQty=ROUND(T1.FAuxNeedQty,T3.FQtyDecimal)
				 ,T1.FAuxHaveOrderQty=ROUND(T1.FAuxHaveOrderQty,T3.FQtyDecimal)
				 ,T1.FAuxReleasedQty=0
				 ,T1.FPlanQty=ROUND(CAST(T1.FAuxPlanQty AS FLOAT)*T2.FCoefficient,T3.FQtyDecimal)         
				 ,T1.FPutInQty=ROUND(CAST(T1.FAuxPutInQty AS FLOAT)*T2.FCoefficient,T3.FQtyDecimal)
				 ,T1.FNoBatchQty=ROUND(CAST(T1.FAuxNoBatchQty AS FLOAT)*T2.FCoefficient,T3.FQtyDecimal)
				 ,T1.FNeedQty=ROUND(CAST(T1.FAuxNeedQty AS FLOAT)*T2.FCoefficient,T3.FQtyDecimal)
				 ,T1.FHaveOrderQty=ROUND(CAST(T1.FAuxHaveOrderQty AS FLOAT)*T2.FCoefficient,T3.FQtyDecimal)
				 ,T1.FReleasedQty=0
				 ,FPlanOrderNo=FBillNo                                                     
	FROM ICMRPResult T1                                                                    
	INNER JOIN T_Measureunit T2 ON T1.FUseUnitID=T2.FMeasureUnitID                          
	INNER JOIN T_ICItem T3 ON T1.FItemID =T3.FItemID                                        
	WHERE FInterID=@InterID

	UPDATE ICMRPResult SET FPlanOrderNo=FBillNo,FPlanOrderInterID=@InterID
	WHERE FInterID=@InterID


	ALTER TABLE ICMRPResult ENABLE Trigger ALL

	    
	SET @RunID=ISNULL((SELECT MAX(FInterID) FROM ICMRPInfo WHERE FType=0),0)
	UPDATE ICMRPResult SET FRunID=@RunID,FType=1 WHERE FInterID=@InterID

	/*
	insert into my_t_PlanOrderRel(fdate,fsourceinterid,ftargetinterid)
	select getdate(),finterid ,@InterID 
	from My_t_ScheduleDetail
	where forderinterid=@forderinterid and forderentryid=@forderentryid and fitemid=@fitemid 
	and fdate=@fdate and fdeptid=@fdeptid
	order by finterid
	*/

	--select * from my_t_PlanOrderRel	

	--Update ICMrpResult Set FStatus=1,FCheckerID=16394,FCheckDate='2008-04-15' Where  FInterID=@InterID
    set @i=@i+1

	FETCH NEXT FROM icbom_cursor 
    INTO @fsourcetrantype,@forginterid,@forderinterid,@forderentryid,@fitemid,@fdate,@fqty,@fdeptid,@funitid,@fbominterid

END

set @fendBillNo=@BillNo

CLOSE icbom_cursor
DEALLOCATE icbom_cursor

*/

GO

--select * from icbillno

IF EXISTS (select * from sysobjects where name='My_p_AddBillNo' and xtype='p')  drop  procedure My_p_AddBillNo
go

create procedure My_p_AddBillNo( 
@fbilltypeid int output, @ftablename varchar(50), 
@fpreletter varchar(10)
) 

as


declare @fid int
declare @flength int, @fsufletter varchar(10)
set @flength = 6
set @fsufletter = ''

--fid 5000开始  
--fbillid 5000000开始
--declare @fid int, @fbilltypeid int

if exists (select fbillid from ICBillNo where fbillname = @ftablename)
begin
	select @fbilltypeid = fbillid from ICBillNo where fbillname = @ftablename
	return
end
if exists(select fid from t_billcoderule where fid > 5000)
	select @fid = max(fid) + 1 from t_billcoderule
else
	select @fid = 5001

if exists(select fbillid from ICBillNo where fbillid > 5000000 and fbillid<200000000)
	select @fbilltypeid = max(fbillid) + 1 from ICBillNo where fbillid > 5000000 and fbillid<200000000
else
	select @fbilltypeid = 50000001
--select @fid, @fbilltypeid

SET IDENTITY_INSERT dbo.t_billcoderule ON
insert into t_billcoderule(fid,  fbilltypeid,  fclassindex, fprojectid, fprojectval, fformatindex, flength,  faddchar, frechar, fbilltype) 
values                    (@fid, @fbilltypeid, 1,           3,          '1',         1,            @flength, '',       '',      @fbilltypeid)
set @fid = @fid + 1
insert into t_billcoderule(fid,  fbilltypeid,  fclassindex, fprojectid, fprojectval, fformatindex, flength,  faddchar, frechar, fbilltype) 
values                    (@fid, @fbilltypeid, 1,           1,          @fpreletter, 1,            @flength, '',       '',      @fbilltypeid)
SET IDENTITY_INSERT dbo.t_billcoderule OFF

insert into ICBillNo(fbillid, fbillname, fpreletter, fsufletter, fcurno, 
fbillname_cht, fbillname_en, fformat, fpos, fcanalterbillno,
fcheckaftersave, fusebillcoderule, fdesc) 
values(@fbilltypeid, @ftablename, @fpreletter, @fsufletter, 0, 
@ftablename, @ftablename, '0000000000', @fbilltypeid, 0, 0, 1, @fpreletter + '+0000001')

go


IF EXISTS (select * from sysobjects where name='My_Tri_POOrder_Del'  and xtype='TR')  drop  TRIGGER My_Tri_POOrder_Del
go

Create TRIGGER My_Tri_POOrder_Del ON [dbo].[POOrder]
FOR DELETE
AS
    SET NOCOUNT ON
    
	--采购余数
	update t1 set FEntrySelfS0168=t1.FEntrySelfS0168+t1.fqty
	from seorderentry t1 --
	inner join 
	(
		select t1.fsourceinterid,t1.fsourceentryid,t1.fitemid,sum(t1.fqty) fqty
		from deleted t0 --
		inner join poorderEntry t1 on t0.finterid=t1.finterid  --
		where t1.fsourcetrantype=81
		group by t1.fsourceinterid,t1.fsourceentryid,t1.fitemid
	) t2 on t1.finterid=t2.fsourceinterid and t1.FEntryID=t2.fsourceentryid --and t1.fitemid=t2.fitemid	
	inner join t_icitem t3 on t3.fitemid=t1.fitemid

	update t1 set fordercommitqty=t1.fqty-t1.fordercommitqty
	from seorderentry t1 --
	inner join 
	(
		select t1.fsourceinterid,t1.fsourceentryid,t1.fitemid,sum(t1.fqty) fqty
		from deleted t0 --
		inner join poorderEntry t1 on t0.finterid=t1.finterid  --
		where t1.fsourcetrantype=81
		group by t1.fsourceinterid,t1.fsourceentryid,t1.fitemid
	) t2 on t1.finterid=t2.fsourceinterid and t1.FEntryID=t2.fsourceentryid --and t1.fitemid=t2.fitemid	
	inner join t_icitem t3 on t3.fitemid=t1.fitemid
	where left(t3.fnumber,1) not in ('M')

	set nocount off
GO


IF EXISTS (select * from sysobjects where name='My_Tri_POOrder_UP'  and xtype='TR')  drop  TRIGGER My_Tri_POOrder_UP
go

Create TRIGGER My_Tri_POOrder_UP ON [dbo].[POOrder]
FOR UPDATE

AS
BEGIN
	SET NOCOUNT ON
	declare @iMaxIndex int,@fplancommitdate datetime
	declare @FInterID int ,@fentryid int 
	declare @FMyInterID int ,@FSupplyID int,@FMultiCheckLevel1 int
	declare @fcurrencyid int,@fqty decimal(24,4),@fitemid int,@funitid int
	declare @fbillno varchar(30),@fsourceinterid int,@fsourceentryid int	
	declare @ftrantype int ,@FBillerID int,@FCheckerID int,@fdate datetime
	declare @fstatus int,@s varchar(800),@fplandate datetime,@fplanqty decimal(24,4)

	select top 1 @s='',@FSupplyID=FSupplyID,@fstatus=isnull(fstatus,0),@FBillerID=FBillerID,
	@fdate=replace(convert(varchar(10),getdate(),111),'/','-'),@FMultiCheckLevel1=isnull(FMultiCheckLevel1,0),
	@FCheckerID=FCheckerID,@fcurrencyid=fcurrencyid,@fbillno=fbillno,@FInterID=FInterID from INSERTED 

--	if @fstatus=0 and update(fstatus)  --反审核
--	begin
--		--不删除--防止排好的又要重排
--		delete t5
--		from inserted t1
--		inner join poorderentry t2 on t1.finterid=t2.finterid
--		inner join my_t_mrpresultdetail t5 on t5.fsourceinterid=t2.finterid and t5.fsourceentryid=t2.fentryid
--	end

	if @fstatus=0 and update(fstatus)  --反审核
	begin
		if exists(	select 1
					from inserted t1
					inner join poorderentry t2 on t1.finterid=t2.finterid
					inner join t_icitem t3 on t2.fitemid=t3.fitemid  --套件
					inner join t_BOSPlasticPoInStockEntry t4 on t4.FID_SRC=t2.finterid 
					where t3.fnumber like '1.02.%' 
					) 
		   and exists (select * from t_SystemProfile where FCategory='IC' and fkey='FIsPlasticManage' and fvalue='1')
		begin
				set @s='已经有关联塑胶收料申请单！'
				RAISERROR(@s,18,18)
		end
		
		----采购余数
		--update t1 set fordercommitqty=t1.fqty-t1.fordercommitqty,FEntrySelfS0168=t1.FEntrySelfS0168+t1.fqty
		--from seorderentry t1 --
		--inner join 
		--(
		--	select t1.fsourceinterid,t1.fsourceentryid,t1.fitemid,sum(t1.fqty) fqty
		--	from inserted t0 --
		--	inner join poorderEntry t1 on t0.finterid=t1.finterid  --
		--	where t1.fsourcetrantype=81
		--	group by t1.fsourceinterid,t1.fsourceentryid,t1.fitemid
		--) t2 on t1.finterid=t2.fsourceinterid and t1.FEntryID=t2.fsourceentryid --and t1.fitemid=t2.fitemid		
	end

	if (@fstatus=1 and update(fstatus)) or (@FMultiCheckLevel1>0 and update(FMultiCheckLevel1))  --审核
	begin
	    ----采购余数
		--update t1 set fordercommitqty=t1.fqty+t1.fordercommitqty,FEntrySelfS0168=t1.FEntrySelfS0168-t1.fqty
		--from seorderentry t1 --
		--inner join 
		--(
		--	select t1.fsourceinterid,t1.fsourceentryid,t1.fitemid,sum(t1.fqty) fqty
		--	from inserted t0 --
		--	inner join poorderEntry t1 on t0.finterid=t1.finterid  --
		--	where t1.fsourcetrantype=81
		--	group by t1.fsourceinterid,t1.fsourceentryid,t1.fitemid
		--) t2 on t1.finterid=t2.fsourceinterid and t1.FEntryID=t2.fsourceentryid --and t1.fitemid=t2.fitemid
		
		if exists(	select 1
					from inserted t1
					inner join poorderentry t2 on t1.finterid=t2.finterid
					inner join t_icitem t3 on t2.fitemid=t3.fitemid  --套件
					where t3.fnumber like '1.02.%' 
			 )  and exists (select * from t_SystemProfile where FCategory='IC' and fkey='FIsPlasticManage' and fvalue='1')
		begin
			if exists(select 1
						from poorderentry t1 
						inner join inserted t7 on t1.finterid=t7.finterid
						inner join t_icitem t2 on t1.fitemid=t2.fitemid 
						left join icbom t11 on t11.fitemid=t1.fitemid and t11.fusestatus=1072
						where t2.fnumber like '1.02.%' and t11.fitemid is null)
			begin
				select @s=@s+','+m1.fnumber from
				(
					select distinct t2.fnumber
					from poorderentry t1 
					inner join inserted t7 on t1.finterid=t7.finterid
					inner join t_icitem t2 on t1.fitemid=t2.fitemid 
					left join icbom t11 on t11.fitemid=t1.fitemid and t11.fusestatus=1072
					where t2.fnumber like '1.02.%' and t11.fitemid is null
				) m1

				set @s='以下物料无BOM或者BOM未使用['+@s+']'
				RAISERROR(@s,18,18)
			end

			if exists(select 1
						from poorderentry t1 
						inner join inserted t7 on t1.finterid=t7.finterid
						inner join t_icitem t2 on t1.fitemid=t2.fitemid 
						inner join icbom t11 on t11.fitemid=t1.fitemid and t11.fusestatus=1072
						inner join icbomchild t12 on t11.finterid=t12.finterid
						inner join t_icitem t9 on t9.fitemid=t12.fitemid  --
						left join t_supplyentry t4 on t4.fsupid=t7.fsupplyid and t4.fitemid=t12.fitemid
						where t2.fnumber like '1.02.%'  and t9.fnumber like '6.%' and t4.fitemid is null and t2.fnumber not like 'v.e.%')
			begin
				select @s=@s+','+m1.fnumber from
				(
					select distinct t9.fnumber
					from poorderentry t1 
					inner join inserted t7 on t1.finterid=t7.finterid
					inner join t_icitem t2 on t1.fitemid=t2.fitemid 
					inner join icbom t11 on t11.fitemid=t1.fitemid and t11.fusestatus=1072
					inner join icbomchild t12 on t11.finterid=t12.finterid
					inner join t_icitem t9 on t9.fitemid=t12.fitemid  --
					left join t_supplyentry t4 on t4.fsupid=t7.fsupplyid and t4.fitemid=t12.fitemid
					where t2.fnumber like '1.02.%'  and t9.fnumber like '6.%' and t4.fitemid is null
				) m1

				set @s='以下物料无采购单价['+@s+']'   --套件的子件
				RAISERROR(@s,18,18)
			end
		end
	end

	if @fstatus=1 and update(fstatus)  --审核
	begin
		exec My_p_GeneratePlasticPoInStock @FInterID,@fcheckerid,0,0

		insert into my_t_scheduledetail (fbillerid, fsourcetrantype, fsourceinterid, fsourceentryid, funitid, fitemid, fnote,fqty,fdate)
		select t1.FBillerID,t1.ftrantype,t2.finterid,t2.fentryid,t2.funitid,t2.fitemid,'',t2.fqty,
		(case when t2.fdate<@fdate then @fdate when datediff(day,getdate(),t2.fdate)>30 then DATEADD(day,30,getdate()) else t2.fdate end)	
		from inserted t1
		inner join poorderentry t2 on t1.finterid=t2.finterid
		inner join t_icitem t3 on t2.fitemid=t3.fitemid
		where not exists (select 1 from my_t_scheduledetail m1 where m1.fsourceinterid=t2.finterid and m1.fsourceentryid=t2.fentryid and m1.fsourcetrantype=71)
		and t3.fnumber not like '1.02.%'
		and t3.fnumber not like '6.%'
		--and isnull(t2.fsourceinterid,0)<>0

		--外调品更新生产任务单的供应商资料--如果是先下任务单再下采购订单在此起作用

		--update t4 set fheadselfj0180=t6.FSupplyID
		--from seorder t1
		--inner join seorderentry t2 on t1.finterid=t2.finterid
		--inner join t_icitem t3 on t2.fitemid=t3.fitemid
		--inner join icmo t4 on t4.forderinterid=t2.finterid and t4.fsourceentryid=t2.fentryid
		--inner join poorderentry t5 on t5.fsourceinterid=t2.finterid and t5.fsourceentryid=t2.fentryid and t5.fsourcetrantype=81
		--inner join inserted t6 on t5.finterid=t6.finterid
		--where isnull(t2.fentryselfs0175,0) in (40090,40091) --select * from t_submessage where finterid in (40090,40091)

		--DECLARE Seorder_Cursor CURSOR FOR
		--select t1.FBillerID,t1.ftrantype,t2.finterid,t2.fentryid,t2.funitid,t2.fitemid,t2.fqty,t2.fsourceinterid,t2.fsourceentryid,
		--(case when t2.fdate<@fdate then @fdate when datediff(day,getdate(),t2.fdate)>30 then DATEADD(day,30,getdate()) else t2.fdate end)	
		--from inserted t1
		--inner join poorderentry t2 on t1.finterid=t2.finterid
		--where not exists (select 1 from my_t_scheduledetail m1 where m1.fsourceinterid=t2.finterid and m1.fsourceentryid=t2.fentryid)
		--and isnull(t2.fsourceinterid,0)<>0

		--OPEN Seorder_Cursor

		--FETCH NEXT FROM Seorder_Cursor 
		--INTO @FBillerID,@ftrantype,@finterid,@fentryid,@funitid,@fitemid,@fqty,@fsourceinterid,@fsourceentryid,@fplancommitdate

		--WHILE @@FETCH_STATUS = 0
		--BEGIN
		--	set @fplandate=null
		--	--select datediff(day,getdate(),'2013-06-01'),DATEADD(day, 30, getdate())
		--	DECLARE SeorderEntry_Cursor CURSOR FOR
		--	select (case when t5.fneeddate<@fdate then @fdate when datediff(day,getdate(),t5.fneeddate)>30 then DATEADD(day,30,getdate()) else t5.fneeddate end) fneeddate,t5.fneedqty
		--	from porequestentry t3  
		--	inner join porequest t4 on t3.finterid=t4.finterid
		--	inner join my_t_mrpresultdetail t5 on t4.fheadselfp0127=t5.frunid and t5.fneedqty>0 and t5.fitemid=t3.fitemid
		--	where t3.finterid=@fsourceinterid and t3.fentryid=@fsourceentryid
		--	order by t5.fneeddate

		--	OPEN SeorderEntry_Cursor

		--	FETCH NEXT FROM SeorderEntry_Cursor 
		--	INTO @fplandate,@fplanqty

		--	WHILE @@FETCH_STATUS = 0 and @fqty>0  --
		--	BEGIN
		--		if @fplanqty>=@fqty  --
		--		begin
		--			set @fplanqty=@fqty
		--			set @fqty=0
		--		end
		--		else
		--		begin
		--			set @fqty=@fqty-@fplanqty
		--		end	
				
		--		insert into my_t_scheduledetail (fbillerid, fsourcetrantype, fsourceinterid, fsourceentryid, funitid, fitemid, fdate,     fqty,     fnote)
		--				select					 @FBillerID,@ftrantype,      @finterid,      @fentryid,      @funitid,@fitemid,@fplandate,@fplanqty,''	
			
		--		FETCH NEXT FROM SeorderEntry_Cursor 
		--		INTO @fplandate,@fplanqty
		--	end

		--	if @fqty>0 
		--	begin
		--		set @fplandate=isnull(@fplandate,@fplancommitdate)

		--		if exists(select 1 from my_t_scheduledetail where fsourceinterid=@finterid and fsourceentryid=@fentryid and fdate=@fplandate)
		--		begin
		--			update t1 set fqty=t1.fqty+@fqty from my_t_scheduledetail t1 where fsourceinterid=@finterid and fsourceentryid=@fentryid and fdate=@fplandate
		--		end
		--		else
		--		begin
		--			insert into my_t_scheduledetail (fbillerid, fsourcetrantype, fsourceinterid, fsourceentryid, funitid, fitemid, fdate,     fqty, fnote)
		--					select					 @FBillerID,@ftrantype,      @finterid,      @fentryid,      @funitid,@fitemid,@fplandate,@fqty,''				
		--		end
		--	end

		--	CLOSE SeorderEntry_Cursor
		--	DEALLOCATE SeorderEntry_Cursor

		--	FETCH NEXT FROM Seorder_Cursor
		--	INTO @FBillerID,@ftrantype,@finterid,@fentryid,@funitid,@fitemid,@fqty,@fsourceinterid,@fsourceentryid,@fplancommitdate
		--END

		--CLOSE Seorder_Cursor
		--DEALLOCATE Seorder_Cursor
	end
END

GO


IF EXISTS (select * from sysobjects where name='My_Tri_POOrder'  and xtype='TR')  drop  TRIGGER My_Tri_POOrder
go

Create TRIGGER My_Tri_POOrder ON [dbo].[POOrder]
FOR Insert,UPDATE

AS
BEGIN
	SET NOCOUNT ON
	declare @iMaxIndex int
	declare @FInterID int  
	declare @FMyInterID int ,@FSupplyID int
	declare @fcurrencyid int
	declare @fbillno varchar(30)
	declare @ftrantype int ,@FBillerID int,@FCheckerID int
	declare @fstatus int,@s varchar(3000)

	select top 1 @s='',@FSupplyID=FSupplyID,@fstatus=isnull(fstatus,0),@FBillerID=FBillerID,@FCheckerID=FCheckerID,
	@fcurrencyid=fcurrencyid,@fbillno=fbillno,@FInterID=FInterID from INSERTED 

	update m2 set FEntrySelfP0250=m2.fqty-m2.FCommitQty
	from poorderentry m2 
	inner join inserted m3 on m2.finterid=m3.finterid

	--采购余数
	update t1 set FEntrySelfS0168=t1.fqty-isnull(t2.fqty,0)
	from seorderentry t1 --
	inner join 
	(
		select t1.fsourceinterid,t1.fsourceentryid,t1.fitemid,sum(t1.fqty) fqty
		from poorder t0 --
		inner join poorderEntry t1 on t0.finterid=t1.finterid  --
		inner join 
		(	  
			select distinct t1.fsourceinterid,t1.fsourceentryid 
			from poorderentry t1--
			inner join inserted t2 on t1.finterid=t2.finterid
			where t1.fsourcetrantype=81
		) t2 on t1.fsourceinterid=t2.fsourceinterid and t1.fsourceentryid=t2.fsourceentryid
		where t1.fsourcetrantype=81
		group by t1.fsourceinterid,t1.fsourceentryid,t1.fitemid
	) t2 on t1.finterid=t2.fsourceinterid and t1.FEntryID=t2.fsourceentryid --and t1.fitemid=t2.fitemid
	inner join t_icitem t3 on t1.fitemid=t3.fitemid

	update t1 set FOrderCommitQty=isnull(t2.fqty,0)
	from seorderentry t1 --
	inner join 
	(
		select t1.fsourceinterid,t1.fsourceentryid,t1.fitemid,sum(t1.fqty) fqty
		from poorder t0 --
		inner join poorderEntry t1 on t0.finterid=t1.finterid  --
		inner join 
		(	  
			select distinct t1.fsourceinterid,t1.fsourceentryid 
			from poorderentry t1--
			inner join inserted t2 on t1.finterid=t2.finterid
			where t1.fsourcetrantype=81
		) t2 on t1.fsourceinterid=t2.fsourceinterid and t1.fsourceentryid=t2.fsourceentryid
		where t1.fsourcetrantype=81
		group by t1.fsourceinterid,t1.fsourceentryid,t1.fitemid
	) t2 on t1.finterid=t2.fsourceinterid and t1.FEntryID=t2.fsourceentryid --and t1.fitemid=t2.fitemid
	inner join t_icitem t3 on t1.fitemid=t3.fitemid
	where left(t3.fnumber,1) not in ('M')
		
	update t2 set fmrpclosed=40019
	from t_BOSPlasticPoInStock t1
	inner join t_BOSPlasticPoInStockEntry t2 on t1.fid=t2.fid
	inner join t_icitem t3 on t2.fitemid=t3.fitemid
	inner join poorderentry t7 on t7.finterid=t2.fid_src and t7.fentryid=t2.fentryid_src 
	inner join inserted t4 on t4.finterid=t7.finterid
	where t7.FMrpClosed=1 

--	if exists(	select 1
--				from seorder t1
--				inner join seorderentry t2 on t1.finterid=t2.finterid
--				inner join t_icitem t3 on t2.fitemid=t3.fitemid
--				left join icmo t4 on t4.forderinterid=t2.finterid and t4.fsourceentryid=t2.fentryid
--				inner join poorderentry t5 on t5.fsourceinterid=t2.finterid and t5.fsourceentryid=t2.fentryid and t5.fsourcetrantype=81
--				inner join inserted t6 on t5.finterid=t6.finterid
--				where t4.finterid is null and isnull(t2.fentryselfs0175,0) in (40090,40091)
--				and isnull(t1.FHeadSelfS0147,0) not in (40032,40033) --40032	样品订单-收费 40033	样品订单-免费
--				) --select * from t_submessage where finterid in (40090,40091)
--	
--	begin
--		select @s=@s+','+m1.fshortnumber from
--		(
--			select t3.fshortnumber
--			from seorder t1
--			inner join seorderentry t2 on t1.finterid=t2.finterid
--			inner join t_icitem t3 on t2.fitemid=t3.fitemid
--			left join icmo t4 on t4.forderinterid=t2.finterid and t4.fsourceentryid=t2.fentryid
--			inner join poorderentry t5 on t5.fsourceinterid=t2.finterid and t5.fsourceentryid=t2.fentryid and t5.fsourcetrantype=81
--			inner join inserted t6 on t5.finterid=t6.finterid
--			where t4.finterid is null and isnull(t2.fentryselfs0175,0) in (40090,40091)
--			and isnull(t1.FHeadSelfS0147,0) not in (40032,40033) --40032	样品订单-收费 40033	样品订单-免费) --select * from t_submessage where finterid in (40090,40091)
--		) m1
--
--		set @s='以下外调品还未生成生产任务单['+@s+']'
--		RAISERROR(@s,18,18)
--	end

	------------------------------------------------------------------------------------------
	if exists(select 1  
				from poorderentry t1 
				inner join inserted t7 on t1.finterid=t7.finterid
				inner join t_icitem t2 on t1.fitemid=t2.fitemid 
				inner join t_supplyentry t4 on t4.fsupid=t7.fsupplyid and t4.fitemid=t2.fitemid
				where t1.ftaxprice>t4.ftaxprice and t1.ftaxprice>0 and t7.fdate>='2015-01-02') and @fstatus=0
	begin
		select @s=@s+','+m1.fnumber from
		(
			select distinct t2.fnumber
			from poorderentry t1 
			inner join inserted t7 on t1.finterid=t7.finterid
			inner join t_icitem t2 on t1.fitemid=t2.fitemid 
			inner join t_supplyentry t4 on t4.fsupid=t7.fsupplyid and t4.fitemid=t2.fitemid
			where t1.ftaxprice>t4.ftaxprice and t1.ftaxprice>0 and t7.fdate>='2015-01-02'
		) m1

		set @s='以下物料采购单价大于价格库单价['+@s+']'
		RAISERROR(@s,18,18)
	end

	--------------------------------------------------------------------------------------------
	if exists(select 1  
				from poorderentry t1 
				inner join inserted t7 on t1.finterid=t7.finterid
				inner join t_icitem t2 on t1.fitemid=t2.fitemid 
				left join t_supplyentry t4 on t4.fsupid=t7.fsupplyid and t4.fitemid=t2.fitemid
				where t4.fitemid is null and t7.fdate>='2015-01-02' and t1.fprice>0 and t2.fnumber not like 'v.e%')
	begin
		select @s=@s+','+m1.fnumber from
		(
			select distinct t2.fnumber
			from poorderentry t1 
			inner join inserted t7 on t1.finterid=t7.finterid
			inner join t_icitem t2 on t1.fitemid=t2.fitemid 
			left join t_supplyentry t4 on t4.fsupid=t7.fsupplyid and t4.fitemid=t2.fitemid
			where t4.fitemid is null and t7.fdate>='2015-01-02' and t1.fprice>0 
		) m1

		set @s='以下物料无采购单价['+@s+']'
		RAISERROR(@s,18,18)
	end

	------------------------------------------------------------------------------------------

	------------------------------------------------------------------------------------------
		
	if @fstatus=0
	begin
		set @FSupplyID=@FSupplyID
		/*
		update t13 set fentryselfp0247=t4.fsource  --更新主供应商信息
		from poorderentry t13 
		inner join INSERTED t16 on t16.finterid=t13.finterid 
		inner join t_icitem t4 on t4.fitemid=t13.fitemid
		where t16.fbillno=@fbillno and (isnull(t13.fentryselfp0247,0)=0) and (isnull(t4.fsource,0)<>0)
		*/

		--/*

		--最新供应商
		update t1 set fentryselfp0252=isnull(t3.fshortname,'')
		from poorderentry t1
		inner join 
		(	
			select t3.fsupplyid,t1.ftaxprice,t1.fitemid  --该物料的最新单据的供应商
			from poorderentry t1
			inner join 
			(
				select t2.fitemid,isnull(max(t1.finterid),0) finterid --该物料的最新单据
				from poorder t1
				inner join poorderentry t2 on t1.finterid=t2.finterid
				where t1.finterid<@finterid and t1.fstatus>0
				group by t2.fitemid
			) t2 on t1.finterid=t2.finterid and t1.fitemid=t2.fitemid
			inner join poorder t3 on t3.finterid=t1.finterid
		) t2 on t1.fitemid=t2.fitemid
		inner join t_supplier t3 on t3.fitemid=t2.fsupplyid
		where t1.finterid=@finterid 

		update t13 set --fentryselfp0249=isnull(t1.ftaxprice,0), --采购最小单价  --放在前台了
		fentryselfp0251=isnull(t2.fdate,null)  --最新报价日期
		from poorderentry t13 
		inner join INSERTED t16 on t16.finterid=t13.finterid 
		inner join t_icitem t4 on t4.fitemid=t13.fitemid
		--left join 
		--(
		--	select t4.fitemid,isnull(min(t4.ftaxprice),0) ftaxprice 
		--	FROM  t_SupplyEntry t4 
		--	inner  JOIN t_ICItem t7 ON t4.fitemid=t7.FItemID AND t7.FItemID<>0 
		--	inner  JOIN t_supplier t3 ON t3.fitemid=t4.fsupid AND t3.FItemID<>0 
		--	--where t4.FUsed=1 
		--	group by t4.fitemid
		--) t1 on t13.fitemid=t1.fitemid
		left join 
		(
			select t4.fitemid,max(t4.FQuoteTime) fdate
			FROM  t_SupplyEntry t4 
			inner  JOIN t_ICItem t7 ON t4.fitemid=t7.FItemID AND t7.FItemID<>0 
			inner  JOIN t_supplier t3 ON t3.fitemid=t4.fsupid AND t3.FItemID<>0 
			where t4.fsupid=@FSupplyID --and t4.FUsed=1 
			group by t4.fitemid
		) t2 on t13.fitemid=t2.fitemid --and t16.fsupplyid=
		--where t16.fbillno=@fbillno --and (isnull(t13.fentryselfp0247,0)=0) and (isnull(t4.fsource,0)<>0)
		--*/

		--主供应商变更原因
		/*
		if exists (select 1
		from poorderentry t3 
		inner join t_icitem t4 on t4.fitemid=t3.fitemid
		where t3.finterid=@FInterID and (isnull(t4.fsource,0)<>@FSupplyID) and (isnull(t4.fsource,0)<>0) and isnull(t3.fentryselfp0249,'')=''
		)
		begin
			select @s=@s+','+m1.fshortnumber from
			(
				select t4.fshortnumber
				from INSERTED t1
				inner join poorderentry t2 on t1.finterid=t2.finterid
				inner join t_icitem t4 on t4.fitemid=t2.fitemid
				where t2.finterid=@FInterID and (isnull(t4.fsource,0)<>@FSupplyID) and (isnull(t2.fentryselfp0249,'')='') and (isnull(t4.fsource,0)<>0)
			) m1

			set @s='以下物料所选供应商与主供应商不一致,请在[说明]栏中注明原因['+@s+']'
			RAISERROR(@s,18,18)
		end
		*/
	end
END

GO


--销售价格联络变更
IF not EXISTS (select * from sysobjects where name='MySEPriceChange' and xtype='u') --drop Table MySEPriceChange 
begin
CREATE TABLE MySEPriceChange(
	finterid int not null,
	fbillno varchar(50) not null,
	fdate datetime not null,
	fcheckdate datetime ,
	fsubid int,
	fbillerid int not null,
	fmodifierID int,
	fmodifytime datetime,FCurrencyID int default(1000),
	fbilltime datetime,
	fchecktime datetime,
	fcheckerid int,
	fstatus int default(0),--3 关闭--业务执行完毕
	fnote varchar(500),
	fsourcebillno varchar(20)
	CONSTRAINT [PK_MySEPriceChange] PRIMARY KEY CLUSTERED 
	(
		[finterid] ASC
	)WITH  FILLFACTOR = 90 ON [PRIMARY]
) ON [PRIMARY]
end

go



IF not EXISTS (select t1.id
from sysobjects t1 
inner join syscolumns t2 on t1.id=t2.id
where t1.name='IcPrcPlyEntry' and t1.xtype='u' and t2.name='fpiecefee')
begin
	alter table IcPrcPlyEntry add fmaterialfee decimal(24,4) default(0)--材料
	alter table IcPrcPlyEntry add fpiecefee decimal(24,4) default(0)--人工
	alter table IcPrcPlyEntry add ffinancefee decimal(24,4) default(0)--制造
	alter table IcPrcPlyEntry add fstdprice decimal(24,4) default(0)--标准成本
end

go


IF not EXISTS (select * from sysobjects where name='My_t_SEPriceChangeEntryTemp' and xtype='u')  --drop Table My_t_SEPriceChangeEntryTemp
begin
CREATE TABLE My_t_SEPriceChangeEntryTemp(
	fuserid int,
	FIndex int IDENTITY,
	fprice decimal(24,4) default(0),--现-实际单价
	fmaterialfee decimal(24,4) default(0), --现-材料
	fpiecefee decimal(24,4) default(0), --现-人工
	ffinancefee decimal(24,4) default(0), --现-费用 = 三大费用 + 制造费用
	ftargetprofit decimal(24,4) default 0,  --目标利润率
	flowestprofit decimal(24,4) default 0,  --最低利润率
	fbacktax decimal(24,4) default 0,  --怔退税率差
	ftax decimal(24,4) default 0,  --所得税率
	fprograde varchar(30) default '',--产品分级
	FItemID int NOT NULL,
	fcalxs decimal(24,4) default 0,  --结算系数
	fmakefee decimal(24,4) default 0,  --制造费用
	fthreefee decimal(24,4) default 0,  --三大费用
	FStdPackFee decimal(24,4) default 0,  --标准包装价
) 
end

go


--
IF not EXISTS (select * from sysobjects where name='MySEPriceChangeEntry' and xtype='u')  --drop Table MySEPriceChangeEntry
begin
CREATE TABLE MySEPriceChangeEntry(
	FInterID int NOT NULL,
	FEntryID int NOT NULL,
	fsupplyid int default 0,fsupprice decimal(24,4) default(0),--主供应商采购单价

	fprice decimal(24,4) default(0),--现-实际单价
	foldprice decimal(24,4) default(0),--原-实际单价

	fstdprice decimal(24,4) default(0),--现-标准成本
	foldstdprice decimal(24,4) default(0),--原-标准成本

	fmaterialfee decimal(24,4) default(0), --现-材料
	foldmaterialfee decimal(24,4) default(0), --原-材料

	fpiecefee decimal(24,4) default(0), --现-人工
	foldpiecefee decimal(24,4) default(0), --原-人工

	ffinancefee decimal(24,4) default(0), --现-费用 = 三大费用 + 制造费用
	foldfinancefee decimal(24,4) default(0), --原-费用 

	ftargetprofit decimal(24,4) default 0,  --目标利润率
	foldtargetprofit decimal(24,4) default 0,

	flowestprofit decimal(24,4) default 0,  --最低利润率
	foldlowestprofit decimal(24,4) default 0,

	fbacktax decimal(24,4) default 0,  --怔退税率差
	foldbacktax decimal(24,4) default 0,

	ftax decimal(24,4) default 0,  --所得税率
	foldtax decimal(24,4) default 0,

	foldprograde varchar(30) default '',fprograde varchar(30) default '',--产品分级

	fboxsize varchar(50),
	fcoffeefee decimal(24,4),fcolorfee decimal(24,4),fwhitefee decimal(24,4),
	
	fstarqty decimal(24,2),
	fendqty decimal(24,2),
	fpochangebillno varchar(20),
	foldprice1 decimal(24,4) default(0),--
	fprice1 decimal(24,4) default(0),--
	foldprice2 decimal(24,4) default(0),--
	fprice2 decimal(24,4) default(0),--
	foldprice3 decimal(24,4) default(0),--
	fprice3 decimal(24,4) default(0),--
	FItemID int NOT NULL,
	FUnitID int default(0),
	FNote varchar(500) NULL,
	CONSTRAINT [PK_MySEPriceChangeEntry] PRIMARY KEY CLUSTERED 
	(
		FInterID ASC,
		FEntryID ASC
	) ON [PRIMARY]
) ON [PRIMARY]
end

go


IF EXISTS (select * from sysobjects where name='MySEPriceChangeEntry' and xtype='u') and not EXISTS (select t1.id
from sysobjects t1 
inner join syscolumns t2 on t1.id=t2.id
where t1.name='MySEPriceChangeEntry' and t1.xtype='u' and t2.name='fcalxs')
begin
	alter table MySEPriceChangeEntry add fcalxs decimal(24,4) default 0  --结算系数
	alter table MySEPriceChangeEntry add fmakefee decimal(24,4) default 0  --制造费用
	alter table MySEPriceChangeEntry add fthreefee decimal(24,4) default 0  --三大费用
	alter table MySEPriceChangeEntry add FStdPackFee decimal(24,4) default 0  --标准包装价
end


go

IF EXISTS (select * from sysobjects where name='MySEPriceChangeEntry' and xtype='u') and not EXISTS (select t1.id
from sysobjects t1 
inner join syscolumns t2 on t1.id=t2.id
where t1.name='MySEPriceChangeEntry' and t1.xtype='u' and t2.name='fcalprice')
begin
	alter table MySEPriceChangeEntry add fcalprice decimal(24,4) default 0  --计算单价
end


go

IF EXISTS (select * from sysobjects where name='MySEPriceChangeEntry' and xtype='u') and not EXISTS (select t1.id
from sysobjects t1 
inner join syscolumns t2 on t1.id=t2.id
where t1.name='MySEPriceChangeEntry' and t1.xtype='u' and t2.name='foldtargetprofit')
begin
	alter table MySEPriceChangeEntry add foldtargetprofit decimal(24,4) default 0
	alter table MySEPriceChangeEntry add foldlowestprofit decimal(24,4) default 0
	alter table MySEPriceChangeEntry add foldbacktax decimal(24,4) default 0

	alter table MySEPriceChangeEntry add ftargetprofit decimal(24,4) default 0
	alter table MySEPriceChangeEntry add flowestprofit decimal(24,4) default 0
	alter table MySEPriceChangeEntry add fbacktax decimal(24,4) default 0

	alter table MySEPriceChangeEntry add ftax decimal(24,4) default 0  --所得税率
	alter table MySEPriceChangeEntry add foldtax decimal(24,4) default 0

	alter table MySEPriceChangeEntry add foldprograde varchar(30) default ''
	alter table MySEPriceChangeEntry add fprograde varchar(30) default ''
end


go



IF EXISTS (select * from sysobjects where name='v_MySEPriceChange' and xtype='v')  drop  view v_MySEPriceChange

go

create view v_MySEPriceChange 
as

select t1.fbillno 单据编号,t1.finterid 单据内码,t1.fdate 制单日期, t4.fname 制单人,isnull(t2.fname,'') 币别,
(case when t1.fstatus=0 then '' when t1.fstatus=1 then 'Y' end) 审核,isnull(t5.fname,'') 审核人,
isnull(t1.fcheckdate,Null) 审核日期,'' 价格方案,t1.fnote 备注,isnull(t1.fsourcebillno,'') 源单编号
from MySEPriceChange t1   
inner join t_User t4 on t1.fbillerid=t4.fuserid and t4.fuserid<>0  
left join t_User t5 on t1.fcheckerid=t5.fuserid and t5.fuserid<>0  
--left join vwIcPrcPly t2 on t2.finterid=t1.fsubid
left join t_currency t2 on t2.fcurrencyid=t1.fcurrencyid

go

--也用作导入到傲威
IF EXISTS (select * from sysobjects where name='v_MySEPriceChangeDetail' and xtype='v')  drop  view v_MySEPriceChangeDetail

go

create view v_MySEPriceChangeDetail 
as

select t1.fbillno 单据编号,t1.finterid 单据内码,t1.fdate 制单日期, t4.fname 制单人,
isnull(t12.fnumber,'') 币别编码,--isnull(t12.fname,'') 币别,
t1.fbillno 源单编号,isnull(t12.fnumber,'') 币别,--导入用  
(case when t1.fstatus=0 then '' when t1.fstatus=1 then 'Y' end) 审核,
isnull(t5.fname,'') 审核人,isnull(t1.fcheckdate,Null) 审核日期,
--t7.fnumber 厂商编码,
isnull(t8.fshortname,'') 主供应商,
isnull(t7.fitemid,0) 厂商内码,isnull(t7.fshortname,'') 厂商名称,
t3.fnumber 物料编码,t3.fname 名称,t3.fitemid 物料内码,
t3.fmodel 规格型号,isnull(t3.f_105,'') 描述,isnull(t3.f_106,'') 适用机型,'' 系列,
t3.funitid 单位内码,t6.fname 单位,isnull(t2.fsupprice,0) 采购单价, 

--t2.fstarqty 起始数量,t2.fendqty 截止数量,
--t2.foldprice1 [old-Low],t2.fprice1 Low,  --[old-Low]为前台关键字段，勿随意改动
--t2.foldprice2 [old-Medium],t2.fprice2 Medium,
--t2.foldprice3 [old-Large],t2.fprice3 Large,

isnull(t2.foldmaterialfee,0) [old-材料成本],isnull(t2.fmaterialfee,0) [材料成本],
isnull(t2.foldfinancefee,0) [old-费用成本],isnull(t2.ffinancefee,0) [费用成本],
isnull(t2.foldlowestprofit,0) [old-底线利润率],isnull(t2.flowestprofit,0) [底线利润率],
isnull(t2.foldtargetprofit,0) [old-目标利润率],isnull(t2.ftargetprofit,0) [目标利润率],
isnull(t2.foldbacktax,0) [old-怔退税率差],isnull(t2.fbacktax,0) [怔退税率差],
isnull(t2.foldtax,0) [old-所得税率],isnull(t2.ftax,0) [所得税率],
isnull(t2.foldprograde,'') [old-产品分级],isnull(t2.fprograde,'') [产品分级],
isnull(t2.foldprice,0) [old-单价],t2.fprice 单价,--

isnull(t2.fcalxs,0) 结算系数,
isnull(t2.fmakefee,0) 制造费用,
isnull(t2.fthreefee,0) 三大费用,
isnull(t2.FStdPackFee,0) 标准包装价,
isnull(t2.fcalprice,0) 计算单价,0 利润率,

(case when t1.fstatus>0 then t2.foldpiecefee else isnull(t11.fpiecefee,0) end) [old-人工],--如果单据已经审核，则读取表的人工，否则读取上一次报价的人工
t2.fpiecefee [人工],--触发器中判断如果为0则读取基础资料的人工--人工按产品的难易度来分,制造非则是平均分摊 --(case when t1.fstatus>0 then t2.fpiecefee else isnull(t3.FPieceRate,0) end) [人工],--如果单据已经审核，则读取表的人工，否则读取基础资料的人工
(case when t1.fstatus>0 then t2.foldfinancefee else isnull(t11.ffinancefee,0) end) [old-制造费],
t2.ffinancefee 制造费,--(case when t1.fstatus>0 then t2.ffinancefee else isnull(t3.FStdFixFeeRate,0) end) 制造费,
(case when t1.fstatus>0 then t2.foldmaterialfee else isnull(t11.fmaterialfee,0) end) [old-材料费],
t2.fmaterialfee 材料费,--(case when t1.fstatus>0 then t2.fmaterialfee else isnull(t3.fplanprice,0) end) 材料费,--最新材料费用BOM展开
--(case when t1.fstatus>0 then t2.foldprice else isnull(t11.fprice,0) end) [old-单价],t2.fprice 单价,--
--(case when t1.fstatus>0 then t2.foldusdprice else isnull(t11.fusdprice,0) end) [old-美金单价],t2.fusdprice 美金单价,
(case when t1.fstatus>0 then t2.fboxsize else isnull(t13.fname,'') end) 外盒尺寸,--如果单据已经审核，则读取表的数据，否则读取基础资料的数据
(case when t1.fstatus>0 then t2.fcoffeefee else isnull((select f_103 from t_Item_3012 where f_102=t13.fitemid and f_101=25953),0) end) 咖啡盒,--
(case when t1.fstatus>0 then t2.fwhitefee else isnull((select f_103 from t_Item_3012 where f_102=t13.fitemid and f_101=25954),0) end) 白盒,
(case when t1.fstatus>0 then t2.fcolorfee else isnull((select f_103 from t_Item_3012 where f_102=t13.fitemid and f_101=25955),0) end) 彩盒,
t2.fnote 备注--,''采购联络单号,''采购联络日期
from MySEPriceChange t1   
inner join MySEPriceChangeEntry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_User t4 on t1.fbillerid=t4.fuserid and t4.fuserid<>0  
left join t_User t5 on t1.fcheckerid=t5.fuserid and t5.fuserid<>0  
inner join t_measureunit t6 on t6.fitemid=t3.funitid
left join t_supplier t7 on t7.fitemid=t2.fsupplyid
left join t_supplier t8 on t8.fitemid=t3.F_117 --t3.fsource
--left join t_SupplyEntry t9 on t9.fsupid=t3.F_117 and t9.fitemid=t3.fitemid
left join t_item t10 on t10.fitemclassid=3005 and t3.F_107=t10.fitemid 
left join IcPrcPlyEntry t11 on t11.fitemid=t2.fitemid and t11.finterid=2 and t1.fcurrencyid=t11.FCuryID --and t11.frelatedid=20011  --人民币和美金都要传
left join t_currency t12 on t12.fcurrencyid=t1.fcurrencyid
left join t_item t13 on t13.fitemid=t3.F_103 and t13.fitemclassid=3004  --外盒尺寸

go

--标准售价模拟计算--
--My_p_SePriceCal 16394,'A',0

IF EXISTS (select * from sysobjects where name='My_p_SePriceCal' and xtype='p')  drop  procedure My_p_SePriceCal

go

create procedure [dbo].My_p_SePriceCal (@fuserid int,@fnumberlike varchar(20),@ftype int)-- @ftype 0 查询分析工具 1 VB前台

as

SET NOCOUNT ON

--declare @fuserid int,@fnumberlike varchar(20),@ftype int select @fuserid=16394,@fnumberlike='%',@ftype=0
declare @FUSDExchangerate decimal(24,4),@FMakeDivPiece decimal(24,4)
declare @FThreeDivPiece decimal(24,4), @FTax decimal(24,4), @FBackTax decimal(24,4)
declare @FStdPackPiece decimal(24,4)

select @FUSDExchangerate=fvalue from T_SYSTEMPROFILE where fkey='FUSDExchangerate'
select @FMakeDivPiece=fvalue from T_SYSTEMPROFILE where fkey='FMakeDivPiece'
select @FThreeDivPiece=fvalue from T_SYSTEMPROFILE where fkey='FThreeDivPiece'
select @FTax=fvalue from T_SYSTEMPROFILE where fkey='FTax'
select @FBackTax=fvalue from T_SYSTEMPROFILE where fkey='FBackTax'
select @FStdPackPiece=fvalue from T_SYSTEMPROFILE where fkey='FStdPackPiece'

create table #data(
	FIndex int IDENTITY,
	fcalprice1000 decimal(24,4) default(0),--计算出来的参考价格--美金
	fcalprice1 decimal(24,4) default(0),--计算出来的参考价格--人民币
	fprice1000 decimal(24,4) default(0),--现-实际单价--美金
	fprice1 decimal(24,4) default(0),--现-实际单价--人民币
	fprofit1 decimal(24,4) default 0,  --现-实际利润率--人民币
	fprofit1000 decimal(24,4) default 0,  --现-实际利润率--美金
	fmaterialfee decimal(24,4) default(0), --现-材料
	fpiecefee decimal(24,4) default(0), --现-人工
	ffinancefee decimal(24,4) default(0), --现-费用 = 三大费用 + 制造费用
	ftargetprofit decimal(24,4) default 0,  --目标利润率
	flowestprofit decimal(24,4) default 0,  --最低利润率
	fbacktax decimal(24,4) default 0,  --怔退税率差
	ftax decimal(24,4) default 0,  --所得税率
	fprograde varchar(30) default '',--产品分级
	FItemID int NOT NULL,
	fbanitemid int, --半成品
	fxinitemid int,--芯片
	fcalxs decimal(24,4) default 0,  --结算系数
	fmakefee decimal(24,4) default 0,  --制造费用
	fthreefee decimal(24,4) default 0,  --三大费用
	FStdPackFee decimal(24,4) default 0,  --标准包装价
) 

if @ftype=0
begin
	insert into #data (fitemid)
	select t3.fitemid  
	from t_icitem t3 inner join icbom t1 on t1.fitemid=t3.fitemid
	where (isnull(t3.f_126,0)=40019 or left(t3.fnumber,1) in ('R','Q')) and t3.fnumber like @fnumberlike+'%'--是价格引擎的 
	and t3.fname not like '%禁用%' and t3.fdeleted=0 
	and t1.fstatus>0

	insert into #data (fitemid)
	select t3.fitemid  
	from t_icitem t3 inner join t_item t1 on t1.fitemid=t3.fitemid
	where left(t3.fnumber,1) in ('M') and t3.fnumber like @fnumberlike+'%'--是价格引擎的 
	and t3.fname not like '%禁用%' and t3.fdeleted=0 
	and isnull(t1.FChkUserID,0)>0
end
else
begin
	insert into #data (fitemid)
	select fitemid from My_t_ICItemTemp where fuserid=@fuserid
end

--现有标准销售价格--美金
update t11 set fprice1000=t2.fprice
from #data t11
inner join IcPrcPlyEntry t2 on t2.fitemid=t11.fitemid and t2.frelatedid=20011  

--现有标准销售价格--通用售价(人民币)
update t11 set fprice1=t2.fprice
from #data t11
inner join IcPrcPlyEntry t2 on t2.fitemid=t11.fitemid and t2.frelatedid=20012  

--select * from t_submessage where ftypeid=501 and finterid=20011

--采购单价
select t4.fitemid,(case when t5.fcyid=1000 then t5.fprice*t1.fexchangerate else t5.fprice end) fprice
into #temp --
from (select fitemid,max(fentryid) fentryid from (select t1.fitemid,t1.fentryid from t_supplyentry t1 inner join (select fitemid,max(FQuoteTime) FQuoteTime from t_SupplyEntry group by fitemid) t2 on t1.fitemid=t2.fitemid and t1.FQuoteTime=t2.FQuoteTime) t1 group by fitemid) t4 
inner join t_supplyentry t5 on t4.fitemid=t5.fitemid and t4.fentryid=t5.fentryid
inner join t_currency t1 on t1.fcurrencyid=t5.fcyid

insert into #temp(fitemid,fprice)
select            fitemid,fprice
from
(
	select t1.fitemid,max(t1.fprice) fprice
	from icstockbillentry t1
	inner join 
	(
		select t2.fitemid,max(t1.finterid) finterid
		from icstockbill t1
		inner join icstockbillentry t2 on t1.finterid=t2.finterid
		inner join t_icitem t3 on t2.fitemid=t3.fitemid 
		where t1.ftrantype in (1,2,10,29) and t2.fprice>0 and left(t3.fnumber,1) not in (select fitemtype from v_myitemtype where ftype=0)
		and t3.fnumber not like '6.%' and t1.fstatus>0
		group by t2.fitemid
	) t2 on t1.finterid=t2.finterid
	group by t1.fitemid
) t1 where t1.fitemid not in (select fitemid from #temp)

--人工=半成品+包装
update t3 set fpiecefee=isnull(t1.FPiece,0)+isnull(t2.FPieceRate,0.35)
from #data t3
inner join t_icitem t2 on t2.fitemid=t3.fitemid
left join  
(
	select fitemid,sum(FPiece) FPiece
	from
	(
		select t1.fitemid,isnull(t4.FPieceRate,0)*t3.fqty FPiece
		from t_icitem t1
		inner join icbom t2 on t1.fitemid=t2.fitemid
		inner join icbomchild t3 on t2.finterid=t3.finterid
		inner join t_icitem t4 on t3.fitemid=t4.fitemid
		where t1.fitemid in (select fitemid from #data)
		and isnull(t1.f_126,0)=40019 --and t1.fname not like '%禁用%' and t2.fstatus>0 and t1.fdeleted=0
		and left(t4.fnumber,1) in ('3','4','5')
	) t1 group by t1.fitemid
) t1 on t3.fitemid=t1.fitemid 

--半成品、芯片
update t3 set fbanitemid=isnull(t1.fbanitemid,0),fxinitemid=t1.fxinitemid
from #data t3
inner join 
(
	select fitemid,max(fbanitemid) fbanitemid,max(fxinitemid) fxinitemid,isnull(sum(fbanqty),0) fbanqty
	from
	(
		select t1.fitemid,
		case when left(t4.fnumber,1) in ('3','4','5','7','8') then t4.fitemid else 0 end fbanitemid,
		case when left(t4.fnumber,1) in ('3','4','5','7','8') then 1 else 0 end fbanqty,
		case when left(t4.fnumber,10) in ('1.01.0010.') then t4.fitemid else 0 end fxinitemid
		from t_icitem t1
		inner join icbom t2 on t1.fitemid=t2.fitemid
		inner join icbomchild t3 on t2.finterid=t3.finterid
		inner join t_icitem t4 on t3.fitemid=t4.fitemid
		inner join #data t5 on t5.fitemid=t1.fitemid
	) t1 group by t1.fitemid
) t1 on t3.fitemid=t1.fitemid

--制造费用
update t1 set fmakefee= isnull(t1.fpiecefee,0)*isnull(@FMakeDivPiece,0)
from #data t1

--三大费用
update t1 set fthreefee= isnull(t1.fpiecefee,0)*isnull(@FThreeDivPiece,0)
from #data t1

--费用 = 三大费用 + 制造费用 + 人工
update t1 set ffinancefee= isnull(t1.fthreefee,0)+isnull(t1.fmakefee,0)+isnull(t1.fpiecefee,0)
from #data t1

--其它
update t1 set FStdPackFee= isnull(t3.F_138,0),-- 标准包装价
fcalxs=0.95,--(case when Charindex('高配',t3.fname,1)>0 then 0.93 else 0.95 end), -- 结算系数
fprograde=isnull(t4.fnumber,''), --产品分级
ftargetprofit=isnull(t4.F_101,0),  --目标利润率
flowestprofit=isnull(t4.F_102,0)   --最低利润率
from #data t1
inner join t_icitem t3 on t1.fitemid=t3.fitemid
left join t_Item_3018 t4 on t3.F_136=t4.fitemid

--所得税率
update t1 set FTax= isnull(@FTax,0)
from #data t1

--怔退税率差
update t1 set fbacktax= isnull(@fbacktax,0)
from #data t1

--材料成本
update t4 set fmaterialfee=t2.fprice
--select t3.fnumber 产品编码,t3.fname 产品名称,t3.fmodel 产品规格型号,t2.fprice 单位成本
from t_ICItemMaterial t1
inner join 
(
	select t1.fitemid,sum(fprice) fprice
	from
	(
		--外购成品--色带
		SELECT t2.fitemid,(1*isnull(t5.fprice,0)) fprice
		from t_icitem t2  --成品
		left join #temp t5 on t5.fitemid=t2.fitemid
		--left join icbom t7 on t7.fitemid=t2.fitemid --and t7.fstatus>0--成品
		where --t7.fitemid is null and --没有BOM--
		t2.fitemid in (select fitemid from #data) and left(t2.fnumber,1) in ('M')
		--and t2.fshortnumber='D10054'
		union all
		select t2.fitemid,(t3.fqty*t5.fprice) fprice
		from t_icitem t1
		inner join icbom t2 on t1.fitemid=t2.fitemid --and t2.fstatus>0
		inner join icbomchild t3 on t2.finterid=t3.finterid
		inner join #temp t5 on t5.fitemid=t3.fitemid
		inner join t_icitem t6 on t6.fitemid=t3.fitemid
		where left(t6.fnumber,1) not in ('3','4','5') --and t1.ferpclsid=2 
		and t1.fitemid in (select fitemid from #data) and left(t1.fnumber,1) in ('A', 'J', 'P', 'Q', 'R', 'V', 'X', 'Y')
		and t6.fdefaultloc<>16483  --
		union all
		select t2.fitemid,(t3.fqty*t12.fqty*t5.fprice) fprice
		from t_icitem t1
		inner join icbom t2 on t1.fitemid=t2.fitemid --and t2.fstatus>0 --成品
		inner join icbomchild t3 on t2.finterid=t3.finterid  --半成品
		inner join icbom t11 on t11.fitemid=t3.fitemid  --半成品
		inner join icbomchild t12 on t11.finterid=t12.finterid  --半成品子项
		inner join #temp t5 on t5.fitemid=t12.fitemid
		inner join t_icitem t6 on t6.fitemid=t3.fitemid --半成品
		inner join t_icitem t7 on t7.fitemid=t2.fitemid --成品
		inner join t_icitem t8 on t8.fitemid=t12.fitemid --半成品子项
		where left(t6.fnumber,1) in ('3','4') --and t1.ferpclsid=2
		and t1.fitemid in (select fitemid from #data) and left(t1.fnumber,1) in ('A', 'J', 'P', 'Q', 'R', 'V', 'X', 'Y')
		union all
		select t2.fitemid,(t3.fqty*t12.fqty*t5.fprice) fprice
		from t_icitem t1
		inner join icbom t2 on t1.fitemid=t2.fitemid --and t2.fstatus>0 --成品
		inner join icbomchild t3 on t2.finterid=t3.finterid  --半成品
		inner join icbom t11 on t11.fitemid=t3.fitemid  --半成品
		inner join icbomchild t12 on t11.finterid=t12.finterid  --半成品子项
		inner join #temp t5 on t5.fitemid=t12.fitemid
		inner join t_icitem t6 on t6.fitemid=t3.fitemid --半成品
		inner join t_icitem t7 on t7.fitemid=t2.fitemid --成品
		inner join t_icitem t8 on t8.fitemid=t12.fitemid --半成品子项
		where left(t6.fnumber,1) in ('5') and t8.fname not like '回收件%' --and t1.ferpclsid=2
		and t1.fitemid in (select fitemid from #data) and left(t1.fnumber,1) in ('A', 'J', 'P', 'Q', 'R', 'V', 'X', 'Y')
		union all
		select t2.fitemid,(t3.fqty*t5.fprice) fprice
		from t_icitem t1
		inner join icbom t2 on t1.fitemid=t2.fitemid --and t2.fstatus>0 --成品
		inner join icbomchild t3 on t2.finterid=t3.finterid  --半成品
		inner join icbom t11 on t11.fitemid=t3.fitemid  --半成品
		inner join (
-- 			select distinct t1.fitemid,(select top 1 fitemid from t_icitem where fparentid=t1.fparentid and fname like '%拆盒%' ) fchiheitemid
-- 			from t_icitem t1
-- 			inner join icbomchild t2 on t1.fitemid=t2.fitemid
-- 			where t1.fnumber like '5.%' and t1.fname not like '%拆盒%'
			select distinct t1.fitemid,
			(
				select top 1 m4.fitemid 
				from t_icitem m1 
				inner join icbomchild m2 on m1.fitemid=m2.fitemid
				inner join icbom m3 on m2.finterid=m3.finterid
				inner join t_icitem m4 on m3.fitemid=m4.fitemid
				where m4.fnumber like '5.%' and m4.fname like '%拆盒%' and m1.fitemid=t5.fitemid 
			) fchiheitemid
			from t_icitem t1
			inner join icbomchild t2 on t1.fitemid=t2.fitemid
			inner join icbom t3 on t1.fitemid=t3.fitemid
			inner join icbomchild t4 on t4.finterid=t3.finterid
			inner join t_icitem t5 on t5.fitemid=t4.fitemid
			where t1.fnumber like '5.%' and t1.fname not like '%拆盒%' and t5.fnumber like '1.02.%'
		) t12 on t11.fitemid=t12.fitemid --半成品同级回收壳
		inner join t_icitem t6 on t6.fitemid=t3.fitemid --半成品
		inner join t_icitem t7 on t7.fitemid=t2.fitemid --成品
		inner join t_icitem t8 on t8.fitemid=t12.fchiheitemid --半成品同级回收壳
		inner join #temp t5 on t5.fitemid=t8.fitemid
		where left(t6.fnumber,1) in ('5') --and t1.ferpclsid=2
		and t1.fitemid in (select fitemid from #data) and left(t1.fnumber,1) in ('A', 'J', 'P', 'Q', 'R', 'V', 'X', 'Y')
	) t1 group by t1.fitemid
) t2 on t1.fitemid=t2.fitemid
inner join t_icitem t3 on t3.fitemid=t1.fitemid
inner join #data t4 on t4.fitemid=t1.fitemid 
                
--If iCurrencyID = 1000 
--begin
	update t1 set fcalprice1000= ((FMaterialFee + FPieceFee + FMakefee + FThreefee) / (1 - FTargetProfit / (1 - FTax) - FBackTax * (1 + 0.12))) / @FUSDExchangerate
	from #data t1

	update t1 set fcalprice1000=(fcalprice1000 - FStdPackFee) / FCalxs + FStdPackFee
	from #data t1

	update t1 set fprofit1000=(1-(FMaterialFee + FPieceFee + FMakefee + FThreefee)/((fprice1000-FStdPackFee)*FCalxs+FStdPackFee)/@FUSDExchangerate-FBackTax*(1+0.12))*(1-FTax)
	from #data t1 where fprice1000<>0 
--end

--If iCurrencyID = 1 
--begin
	update t1 set fcalprice1= ((FMaterialFee * (1 - 0.17 * 0.12) + FPieceFee + FMakefee + FThreefee) / (1 - FTargetProfit / (1 - FTax) - 0.17 * 0.12)) * 1.17
	from #data t1

	update t1 set fcalprice1=((fcalprice1 / 1.17 - FStdPackFee * @FUSDExchangerate) / FCalxs + FStdPackFee * @FUSDExchangerate) * 1.17
	from #data t1

	update t1 set fprofit1=(1-((FMaterialFee + FPieceFee + FMakefee + FThreefee)-FMaterialFee*0.17*0.12)/((fprice1/1.17-FStdPackFee*@FUSDExchangerate)*FCalxs+FStdPackFee*@FUSDExchangerate)-0.17*0.12)*(1-FTax)
	from #data t1 where fprice1<>0
--End 

select --isnull(t12.fnumber,'') 币别,--导入用  
t3.fnumber 物料编码,t3.fname 名称,t3.fmodel 规格型号,isnull(t3.f_105,'') 描述,isnull(t3.f_106,'') 适用机型,
isnull(t1.fnumber,'') 半成品编码,isnull(t1.fname,'')+'/////'+isnull(t1.fmodel,'')+'/////'+isnull(t1.f_105,'') 半成品信息,
isnull(t11.fnumber,'') 芯片编码,isnull(t11.fname,'')+'/////'+isnull(t11.fmodel,'')+'/////'+isnull(t11.f_105,'') 芯片信息,
t6.fname 单位,
isnull(t2.fmaterialfee,0) [材料成本],
t2.fpiecefee [人工],
isnull(t2.fmakefee,0) 制造费用,
isnull(t2.fthreefee,0) 三大费用,
isnull(t2.ffinancefee,0) [费用成本],
isnull(t2.fprograde,'') [产品分级],
isnull(t2.flowestprofit,0) [底线利润率],
isnull(t2.ftargetprofit,0) [目标利润率],
isnull(t2.fbacktax,0) [怔退税率差],
isnull(t2.ftax,0) [所得税率],
isnull(t2.fcalxs,0) 结算系数,
isnull(t13.fname,'')  外盒尺寸,
isnull(t2.FStdPackFee,0) 标准包装价,
isnull(t2.fcalprice1000,0) [计算单价(USD)],
t2.fprice1000 [执行单价(USD)],
t2.fprofit1000 [执行利润率(USD)],
isnull(t2.fcalprice1,0) [计算单价(RMB)],
t2.fprice1 [执行单价(RMB)],
t2.fprofit1 [执行利润率(RMB)]
from #data t2 
inner join t_icitem t3 on t2.fitemid=t3.fitemid 
inner join t_measureunit t6 on t6.fitemid=t3.funitid
left join t_item t10 on t10.fitemclassid=3005 and t3.F_107=t10.fitemid 
left join t_item t13 on t13.fitemid=t3.F_103 and t13.fitemclassid=3004  --外盒尺寸
left join t_icitem t1 on t1.fitemid=t2.fbanitemid
left join t_icitem t11 on t11.fitemid=t2.fxinitemid
order by t3.fnumber

drop table #temp  
drop table #data  --drop table #sale1000  --drop table #sale1

set nocount off

go

--销售价格查询
--exec My_p_GetSEPricePolicy 2,' 1=1 and 产品名称 like ''%%'''

IF EXISTS (select * from sysobjects where name='My_p_GetSEPricePolicy' and xtype='p')  drop  procedure My_p_GetSEPricePolicy

go

create procedure [dbo].My_p_GetSEPricePolicy(@fsubid int,@filtersql varchar(500))  

as

set nocount on

--declare @fsubid int,@filtersql varchar(500) select @fsubid=2,@filtersql=' 产品编码 like ''%%'' '

declare @fbegqty1 int,@fendqty1 int,@fbegqty2 int,@fendqty2 int,@fbegqty3 int,@fendqty3 int 
declare @fwhere varchar(50)

--select @fbegqty1=fbegqty1,@fendqty1=fendqty1,@fbegqty2=fbegqty2,@fendqty2=fendqty2,@fbegqty3=fbegqty3,@fendqty3=fendqty3 from my_t_PricePolicy where fsubid=@fsubid


declare @fstrbegqty1 varchar(50),@fstrendqty1 varchar(50)
declare @fstrbegqty2 varchar(50),@fstrendqty2 varchar(50)
declare @fstrbegqty3 varchar(50),@fstrendqty3 varchar(50)

select @fstrbegqty1=cast(@fbegqty1 as varchar(50)),@fstrendqty1=cast(@fendqty1 as varchar(50))
select @fstrbegqty2=cast(@fbegqty2 as varchar(50)),@fstrendqty2=cast(@fendqty2 as varchar(50))
select @fstrbegqty3=cast(@fbegqty3 as varchar(50)),@fstrendqty3=cast(@fendqty3 as varchar(50))

declare @fpricetitle1 varchar(20),@fpricetitle2 varchar(20),@fpricetitle3 varchar(20)

select @fpricetitle1=''--='[Below-'+@fstrendqty1+']' --Below在前台作为关键字,勿随意改动
select @fpricetitle2=''--='['+@fstrbegqty2+'-'+@fstrendqty2+']'
select @fpricetitle3=''--='['+@fstrbegqty3+'-Above]'

declare @fsql varchar(5000)  set @fsql=''

set @fsql='select * from (select cast(0 as bit) 选择,t3.fitemid 产品内码,funitid 单位内码,t3.fnumber 产品编码,t3.fname 产品名称,t3.fmodel 规格型号,t3.fdescription 描述,t3.fcompatibility 适用机型,t3.farea 适用区域,
t3.fprice 单价,/*t3.fusdprice [单价(USD)],*/t3.fsedate 销售单价联络日期,t3.fsupname 主供应商,t3.fpoprice 主供应商采购单价,t3.fpodate 采购单价联络日期,
t3.fboxsize [标准外箱尺寸(mm)],t3.fcoloursize [标准外盒尺寸(mm)],t3.fstandardqty 标准装箱数,t3.FNetWeight [整箱净重(kg)]
from
(
	select t3.fboxsize,t3.fcoloursize,t3.fstandardqty,t3.FNetWeight,t3.fsedate,t3.fpodate,t3.fpoprice,t3.fsupname,
	t3.fitemid,t3.funitid,t3.fnumber,t3.fname,t3.fmodel,t3.fcompatibility,t3.fdescription,t3.farea,max(t3.fprice) fprice,max(t3.fusdprice) fusdprice --,
	from 
	(
		select t3.F_109 fboxsize,t3.F_111 fcoloursize,cast(t3.F_110 as int) fstandardqty,cast(t3.F_112 as decimal(24,2)) FNetWeight,
		t2.fbegdate fsedate,t5.FQuoteTime fpodate,isnull(cast(t5.fprice as decimal(24,2)),0) fpoprice,isnull(t4.fshortname,'''') fsupname,
		t3.fitemid,t3.funitid,t3.fnumber,t3.fname,
		t3.fmodel,isnull(t3.F_106,'''') fcompatibility,isnull(t3.F_105,'''') fdescription,isnull(t3.F_107,'''') farea,
		isnull(cast(t2.fprice as decimal(24,2)),0) fprice,isnull(cast(t2.fusdprice as decimal(24,2)),0) fusdprice
		from IcPrcPly t1
		inner join IcPrcPlyEntry t2 on t1.finterid=t2.finterid and t2.frelatedid=20011
		inner join t_icitem t3 on t2.fitemid=t3.fitemid
		left join t_supplier t4 on t4.fitemid=t3.f_117
		left join t_SupplyEntry t5 on t5.fitemid=t3.fitemid and t5.fsupid=t3.f_117
		where t1.finterid='+cast(@fsubid as varchar(20))+' 
		and t2.FChecked=1 and t3.fdeleted=0
	) t3 group by t3.fboxsize,t3.fcoloursize,t3.fstandardqty,t3.FNetWeight,t3.fsedate,t3.fpodate,t3.fpoprice,t3.fsupname,t3.fnumber,t3.fname,t3.fmodel,t3.fcompatibility,t3.fdescription,t3.farea,t3.fitemid,t3.funitid
) t3 where not (fprice=0) 
) m1 where '+ @filtersql + ' order by 产品编码'

--print @fsql
--order by REVERSE(substring(REVERSE(产品编码),CHARINDEX(''.'',REVERSE(产品编码))+1,len(产品编码)-CHARINDEX(''.'',REVERSE(产品编码)))),产品名称,规格型号

execute (@fsql)

set nocount off

go



--My_p_GetProductStdCost 'P.01.046.P00046'

IF EXISTS (select * from sysobjects where name='My_p_GetProductStdCost' and xtype='p')  drop  procedure My_p_GetProductStdCost

go

create procedure [dbo].My_p_GetProductStdCost(@ItemNumber varchar(30))  

as

set nocount on

----0取当期加权平均出库价
--select distinct t2.fitemid,max(t2.fprice) as fprice
--into #t_supplyentry
--from icstockbill t1
--inner join icstockbillentry t2 on t1.finterid=t2.finterid
--inner join t_icitem t3 on t2.fitemid=t3.fitemid
--where left(fnumber,1) in ('1','2') and t1.ftrantype=24 and t2.fprice<>0 and  year(t1.fdate)=(select fvalue from t_systemprofile where fcategory='ic' and fkey='currentyear') and month(t1.fdate)=(select fvalue from t_systemprofile where fcategory='ic' and fkey='currentperiod') 
--group by t2.fitemid

--1先找采购单价
select t1.fitemid,max(t1.fprice) fprice into #t_supplyentry
from t_supplyentry t1 where t1.fprice<>0 and fcyid=1 --and t1.fitemid not in (select fitemid from #t_supplyentry)
group by t1.fitemid

----采购单价里无价格的再找当期采购订单
--insert into #t_supplyentry
--select t2.fitemid,
--max((case when fcurrencyid='1' then t2.fprice else  t2.fprice*cast(t1.fexchangerate as decimal(24,8)) end)) as fprice
--from poorder t1
--inner join poorderentry t2 on t1.finterid=t2.finterid
--where 
----year(t1.fdate)=(select fvalue from t_systemprofile where fcategory='ic' and fkey='currentyear') and month(t1.fdate)=(select fvalue from t_systemprofile where fcategory='ic' and fkey='currentperiod')and 
--t2.fitemid not in(select fitemid from #t_supplyentry)
--group by t2.fitemid

----当月采购订单无单价的取期初单价
--insert into #t_supplyentry
--select * from 
--(select fitemid,sum(fbegbal)/sum(fbegqty) as fprice from icbal where fyear=(select fvalue from t_systemprofile where fcategory='ic' and fkey='currentyear') and fperiod=(select fvalue from t_systemprofile where fcategory='ic' and fkey='currentperiod') and fbegqty<>0 group by fitemid ) a
--where fitemid not in(select fitemid from #t_supplyentry)

----如果都取不到的，取以前期间外购入库单单价
--insert into #t_supplyentry
--select t2.fitemid,max(t2.fprice) from icstockbill t1
--inner join icstockbillentry t2 on t1.finterid=t2.finterid
--where t1.ftrantype=1 and t2.fitemid not in(select fitemid from #t_supplyentry)
--group by t2.fitemid

--declare @ItemNumber varchar(30)
--set @ItemNumber='P.01.046.P00046%'--'@@ItemNumber@@%'  -- 

--有半成品的才取--标配->标配  高配->高配
select * 
into #source
from
(
	select distinct /*成品+半成品可能重复*/ t4.fitemid,t4.fnumber,t4.fname,t4.fmodel,t2.fitemid findex/*半成品内码作为标识*/,-1 fentryid,t2.fitemid fchilditemid,
	isnull(t2.fnumber,'') fchilditemnumber,isnull(t2.fname,'') fchilditemname,isnull(t2.fmodel,'') fchilditemmodel,
	isnull(t5.fname,'') funit,1 fqty
	from icbomchild t6 
	inner join icbom t7 on t6.finterid=t7.finterid  --成品
	inner join t_icitem t4 on t7.fitemid=t4.fitemid --成品
	inner join t_icitem t3 on t6.fitemid=t3.fitemid --点零半成品
	inner join 
	(
		select left(t2.fnumber,9) fnumber,max(t1.fitemid) fitemid,count(1) fcount
		from icbom t1
		inner join t_icitem t2 on t1.fitemid=t2.fitemid
		where left(t2.fnumber,1) in (select fitemtype from v_myitemtype where ftype=1) and t2.fname like '%高配%'
		group by left(t2.fnumber,9)
	) t8 on left(t3.fnumber,9)=t8.fnumber
	inner join t_icitem t2 on t2.fitemid=t8.fitemid and t2.fname like '%高配%' --半成品
	inner join t_measureunit t5 on t5.fitemid=t2.funitid
	WHERE left(t4.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0) and t4.fname like '%高配%' AND t4.fnumber like @ItemNumber  ----AND t4.fnumber like 'A.04.047.A10127' --
	union all
	select distinct /*成品+半成品可能重复*/ t4.fitemid,t4.fnumber,t4.fname,t4.fmodel,t2.fitemid findex/*半成品内码作为标识*/,-1 fentryid,t2.fitemid fchilditemid,
	isnull(t2.fnumber,'') fchilditemnumber,isnull(t2.fname,'') fchilditemname,isnull(t2.fmodel,'') fchilditemmodel,
	isnull(t5.fname,'') funit,1 fqty
	from icbomchild t6 
	inner join icbom t7 on t6.finterid=t7.finterid  --成品
	inner join t_icitem t4 on t7.fitemid=t4.fitemid --成品
	inner join t_icitem t3 on t6.fitemid=t3.fitemid --点零半成品
	inner join 
	(
		select left(t2.fnumber,9) fnumber,max(t1.fitemid) fitemid,count(1) fcount
		from icbom t1
		inner join t_icitem t2 on t1.fitemid=t2.fitemid
		where left(t2.fnumber,1) in (select fitemtype from v_myitemtype where ftype=1) and t2.fname like '%标配%'
		group by left(t2.fnumber,9)
	) t8 on left(t3.fnumber,9)=t8.fnumber
	inner join t_icitem t2 on t2.fitemid=t8.fitemid and t2.fname like '%标配%' --半成品
	inner join t_measureunit t5 on t5.fitemid=t2.funitid
	WHERE left(t4.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0) and t4.fname like '%标配%' AND t4.fnumber like @ItemNumber  ----AND t4.fnumber like 'A.04.047.A10127' --
) t1 order by fnumber

select * 
into #data
from
(
	select * from #source
	union all
	select distinct /*成品+半成品可能重复*/ t4.fitemid,t4.fnumber,t4.fname,t4.fmodel,t2.fitemid findex/*半成品内码作为标识*/,-1 fentryid,t2.fitemid fchilditemid,
	isnull(t2.fnumber,'') fchilditemnumber,isnull(t2.fname,'') fchilditemname,isnull(t2.fmodel,'') fchilditemmodel,
	isnull(t5.fname,'') funit,1 fqty
	from icbomchild t6 
	inner join icbom t7 on t6.finterid=t7.finterid  --成品
	inner join t_icitem t4 on t7.fitemid=t4.fitemid --成品
	inner join t_icitem t3 on t6.fitemid=t3.fitemid --点零半成品
	inner join 
	(
		select left(t2.fnumber,9) fnumber,max(t1.fitemid) fitemid,count(1) fcount
		from icbom t1
		inner join t_icitem t2 on t1.fitemid=t2.fitemid
		where left(t2.fnumber,1) in (select fitemtype from v_myitemtype where ftype=1)  
		group by left(t2.fnumber,9)
	) t8 on left(t3.fnumber,9)=t8.fnumber
	inner join t_icitem t2 on t2.fitemid=t8.fitemid  --半成品
	inner join t_measureunit t5 on t5.fitemid=t2.funitid
	WHERE left(t4.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0) AND t4.fnumber like @ItemNumber  ----AND t4.fnumber like 'A.04.047.A10127' --
	and not exists (select 1 from #source where fitemid=t7.fitemid)
) t1 order by fnumber

select identity(int,1,1) as fid,t1.*,cast(isnull(t2.fprice,0) as decimal(24,4)) fprice,
cast(t1.fqty*isnull(t2.fprice,0) as decimal(24,2)) famount,
cast(0 as decimal(24,2)) fchildamount,cast(0 as decimal(24,2)) fchipamount,
cast(0 as decimal(24,2)) fpackamount,cast(0 as decimal(24,2)) fallamount
into #temp
from
(
	--半成品
	select fitemid,fnumber,fname,fmodel,findex/*半成品的内码*/,-1 fentryid,0 fchilditemid/**/,fchilditemnumber,fchilditemname,fchilditemmodel,funit,fqty
	from #data
	union all
	--半成品的子项
	select t6.fitemid,t6.fnumber,t6.fname,t6.fmodel,t6.findex/*半成品的内码*/,t2.fentryid,t2.fitemid fchilditemid,
	isnull(t4.fnumber,'') fchilditemnumber,isnull(t4.fname,'') fchilditemname,isnull(t4.fmodel,'') fchilditemmodel,
	isnull(t5.fname,'') funit,t2.fqty 
	from #data t6 
	inner join icbom t1 on t6.fchilditemid=t1.fitemid --半成品
	inner join icbomchild t2 on t1.finterid=t2.finterid  --子项
	inner join t_icitem t4 on t2.fitemid=t4.fitemid --子项
	inner join t_measureunit t5 on t5.fitemid=t2.funitid
	union all
	--芯片
	select t6.fitemid,t6.fnumber,t6.fname,t6.fmodel,9999998 findex,t2.fentryid,t2.fitemid fchilditemid,
	isnull(t4.fnumber,'') fchilditemnumber,isnull(t4.fname,'') fchilditemname,
	isnull(t4.fmodel,'') fchilditemmodel,isnull(t5.fname,'') funit,1 fqty
	from #data t6
	inner join (select t1.fproductid,max(t1.fid) fid from t_BOSChipMapping t1 group by t1.fproductid) t1 on t6.fitemid=t1.fproductid
	inner join (select max(fitemid) fitemid,fid,max(fentryid) fentryid from t_BOSChipMappingEntry group by fid) t2 on t1.fid=t2.fid
	inner join t_icitem t4 on t2.fitemid=t4.fitemid
	inner join t_measureunit t5 on t5.fitemid=t4.funitid
	union all
	--包材
	select t6.fitemid,t6.fnumber,t6.fname,t6.fmodel,9999999 findex,t2.fentryid,t2.fitemid fchilditemid,
	isnull(t4.fnumber,'') fchilditemnumber,isnull(t4.fname,'') fchilditemname,
	isnull(t4.fmodel,'') fchilditemmodel,isnull(t5.fname,'') funit,t2.fqty
	from #data t6
	inner join (select t1.fproductid,max(t1.fid) fid from t_BOSPackSub t1 group by t1.fproductid) t1 on t6.fitemid=t1.fproductid
	inner join t_BOSPackSubEntry t2 on t1.fid=t2.fid
	inner join t_icitem t4 on t2.fitemid=t4.fitemid
	inner join t_measureunit t5 on t5.fitemid=t4.funitid
) t1 left join #t_supplyentry t2 on t1.fchilditemid=t2.fitemid
order by fnumber,findex/*半成品和半成品的子项都是半成品内码，所以会排在一起*/,fentryid

--半成品单价--去掉包材、芯片、第一行的半成品
update t1 set fprice=(select sum(isnull(famount,0)) from #temp where fitemid=t1.fitemid and fentryid<>-1 and findex<>9999999 and findex<>9999998)
from #temp t1 
inner join (select fitemid,max(fid) fid	from #temp where fentryid=-1 group by fitemid/*成品内码*/) t2 on t1.fid=t2.fid

update t1 set famount=1*t1.fprice
from #temp t1 
inner join (select fitemid,max(fid) fid	from #temp where fentryid=-1 group by fitemid) t2 on t1.fid=t2.fid

--汇总行(最后一行)的半成品金额
update t1 set fchildamount=(select isnull(famount,0) from #temp where fitemid=t1.fitemid and fentryid=-1)
from #temp t1 
inner join (select fitemid,max(fid) fid	from #temp group by fitemid) t2 on t1.fid=t2.fid

--汇总行(最后一行)的包材金额
update t1 set fpackamount=isnull((select sum(isnull(famount,0)) from #temp where fitemid=t1.fitemid and findex=9999999),0)
from #temp t1 
inner join (select fitemid,max(fid) fid	from #temp group by fitemid) t2 on t1.fid=t2.fid

--汇总行(最后一行)的芯片金额--
update t1 set fchipamount=isnull((select isnull(famount,0) from #temp where fitemid=t1.fitemid and findex=9999998),0)
from #temp t1 
inner join (select fitemid,max(fid) fid	from #temp group by fitemid) t2 on t1.fid=t2.fid

--汇总行(最后一行)成品单价
update t1 set fallamount=fpackamount+fchildamount+fchipamount
from #temp t1
inner join (select fitemid,max(fid) fid from #temp group by fitemid) t2 on t1.fid=t2.fid

delete t1
from #temp t1
where fid not in (select max(fid) fid from #temp group by fitemid) 

--select fid,fnumber 产品编码,fname 产品名称,fmodel 产品规格,
--fchilditemnumber 物料编码,fchilditemname 物料名称,fchilditemmodel 物料规格,
--funit 单位,fqty 单位用量,fprice 单价,famount 金额,fchildamount 半成品金额,
--fpackamount 包装金额,fchipamount 芯片金额,fallamount 总金额,*
--FROM #temp order by fid

insert into #StdCost(fitemid,fprice)
select fitemid,fallamount-fpackamount from #temp

drop table #data
drop table #temp
drop table #t_supplyentry
drop table #source

set nocount off

go

--
--销售价格联络变更触发器--
IF EXISTS (select * from sysobjects where name='My_Tri_MySEPriceChange_In'  and xtype='TR')  drop  TRIGGER My_Tri_MySEPriceChange_In
go

Create TRIGGER My_Tri_MySEPriceChange_In
            ON [dbo].[MySEPriceChange]
FOR Insert,UPDATE

AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
	declare @iMaxIndex int,@fnumber varchar(30)
	declare @FInterID int ,@fcheckerid int
	declare @FMyInterID int ,@FSupplyId int,@fsupprice decimal(24,4)
	declare @fcurrencyid int,@FPType int,@fstartqty int,@fendqty int,@fnote varchar(500)
	declare @fbillno varchar(30),@fitemid int,@fprice decimal(24,4),@ftempprice decimal(24,4)
	declare @ftrantype int ,@funitid int,@fstdprice decimal(24,4),@fusdprice decimal(24,4)
	declare @fstatus int,@fsubid int,@foldprice1 decimal(24,4),@foldprice2 decimal(24,4),@foldprice3 decimal(24,4)
	declare @fdate datetime,@freasonid int,@FUSDExchangerate decimal(24,4),@FStandardMakeFee decimal(24,4)
	declare @fuserid int ,@s varchar(500)
	select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期

	declare @findex int,@fmaterialfee decimal(24,4),@fpiecefee decimal(24,4),@ffinancefee decimal(24,4)
	declare @fbegqty1 int,@fendqty1 int,@fbegqty2 int,@fendqty2 int,@fbegqty3 int,@fendqty3 int

    -- Insert statements for trigger here
	--select @iMaxIndex=isnull(max(findex)+1,1) from MY_T_NETCONTROL where fuserid=1 and fbilltype=-1
    create table #StdCost(fitemid int,fprice decimal(24,4))

	set @FUSDExchangerate=6.2
	select @FUSDExchangerate=fvalue FROM t_SystemProfile t1 WHERE fkey='FUSDExchangerate' and FCategory='IC'
	set @FStandardMakeFee=2
	select @FStandardMakeFee=fvalue FROM t_SystemProfile t1 WHERE fkey='FStandardMakeFee' and FCategory='IC'

	select top 1 @s='',@fsubid=fsubid,@fcheckerid=isnull(fcheckerid,0),@fbillno=fbillno,@FInterID=finterid,@fuserid=fbillerid from INSERTED 
	
	select @fbegqty1=0,@fendqty1=0,@fbegqty2=0,@fendqty2=0,@fbegqty3=0,@fendqty3=0 --from my_t_PricePolicy where fsubid=@fsubid

	/*
	if exists(	select 1
				from inserted t1
				inner join MySEPriceChangeEntry t2 on t1.finterid=t2.finterid
				inner join t_icitem t3 on t2.fitemid=t3.fitemid  --
				where isnull(t2.fmaterialfee,0)=0
				) 
	begin
			set @s='材料成本不能为0！'
			RAISERROR(@s,18,18)
	end
	*/

	--DECLARE Seorder_Cursor CURSOR FOR
	--select isnull(t1.fsupprice,0) fsupprice,isnull(t1.fsupplyid,0) fsupplyid,t2.fnumber,t3.fcurrencyid,t2.fitemid,t2.funitid,
	--cast(isnull(t1.fmaterialfee,0) as decimal(24,4)) fmaterialfee,
	--cast(isnull(t1.fpiecefee,0) as decimal(24,4)) fpiecefee,
	--cast(isnull(t1.ffinancefee,0) as decimal(24,4)) ffinancefee,
	--cast(isnull(t1.fstdprice,0) as decimal(24,4)) fstdprice,cast(isnull(t1.fprice,0) as decimal(24,4)) fprice,/*cast(isnull(t1.fusdprice,0) as decimal(24,4))*/ 0 fusdprice
	--from MySEPriceChangeEntry t1
	--inner join t_icitem t2 on t1.fitemid=t2.fitemid
	--inner join MySEPriceChange t3 on t1.finterid=t3.finterid
	--where t1.finterid=@FInterID
	--order by t2.fnumber

	--OPEN Seorder_Cursor

	--FETCH NEXT FROM Seorder_Cursor 
	--INTO @fsupprice,@fsupplyid,@fnumber,@fcurrencyid,@fitemid,@funitid,@fmaterialfee,@fpiecefee,@ffinancefee,@fstdprice,@fprice,@fusdprice

	--WHILE @@FETCH_STATUS = 0
	--BEGIN
	--	if @fsupplyid=0  --默认取主供应商
	--	begin
			update t1 set fsupplyid=isnull(t2.F_117,0)
			from MySEPriceChangeEntry t1
			inner join t_icitem t2 on t1.fitemid=t2.fitemid
			where t1.finterid=@FInterID and isnull(t1.fsupplyid,0)=0 --and t1.fitemid=@fitemid	
		--end

		--if @fsupprice=0  --默认取主供应商单价
		--begin
			update t1 set fsupprice=(case when t9.fcyid=1000 then isnull(t9.fprice,0) else cast(isnull(t9.fprice,0)/@FUSDExchangerate as decimal(24,4)) end)
			from MySEPriceChangeEntry t1
			inner join t_icitem t2 on t1.fitemid=t2.fitemid
			inner join t_SupplyEntry t9 on t9.fsupid=t2.F_117 and t9.fitemid=t2.fitemid
			where t1.finterid=@FInterID --and isnull(t1.fsupprice,0)=0 --and t1.fitemid=@fitemid	
		--end

		--if @fmaterialfee=0  --默认取最新配方的单价
		--begin
		--	delete from #StdCost
		--	--exec My_p_GetProductStdCost @fnumber  --性能太慢

		--	update t1 set fmaterialfee=cast(t2.fprice/@FUSDExchangerate as decimal(24,4))
		--	from MySEPriceChangeEntry t1
		--	inner join #StdCost t2 on t1.fitemid=t2.fitemid	
		--	where t1.finterid=@FInterID and t1.fitemid=@fitemid
		--end

		--if @ffinancefee=0  --默认取系统设置的制造费
		--begin
		--	update t1 set ffinancefee=cast(@FStandardMakeFee/@FUSDExchangerate as decimal(24,4))
		--	from MySEPriceChangeEntry t1
		--	where t1.finterid=@FInterID and t1.fitemid=@fitemid
		--end

		--if @fpiecefee=0  --默认取基础资料的人工
		--begin
		--	update t1 set fpiecefee=cast(t2.FPieceRate/@FUSDExchangerate as decimal(24,4))
		--	from MySEPriceChangeEntry t1
		--	inner join t_icitem t2 on t1.fitemid=t2.fitemid
		--	where t1.finterid=@FInterID and t1.fitemid=@fitemid
		--end

	--	FETCH NEXT FROM Seorder_Cursor 
	--	INTO @fsupprice,@fsupplyid,@fnumber,@fcurrencyid,@fitemid,@funitid,@fmaterialfee,@fpiecefee,@ffinancefee,@fstdprice,@fprice,@fusdprice
	--END

	--CLOSE Seorder_Cursor
	--DEALLOCATE Seorder_Cursor

	--drop table #StdCost
	
	set nocount off
end
	
go



--销售价格联络变更--
IF EXISTS (select * from sysobjects where name='My_Tri_MySEPriceChange'  and xtype='TR')  drop  TRIGGER My_Tri_MySEPriceChange
go

Create TRIGGER [My_Tri_MySEPriceChange]
            ON [dbo].[MySEPriceChange]
FOR UPDATE

AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
	declare @iMaxIndex int,@FUSDExchangerate decimal(24,4)
	declare @FInterID int ,@fcheckerid int
	declare @FMyInterID int ,@FSupplyId int
	declare @fcurrencyid int,@FPType int,@fstartqty int,@fendqty int,@fnote varchar(500)
	declare @fbillno varchar(30),@fitemid int,@fprice decimal(24,4),@ftempprice decimal(24,4)
	declare @ftrantype int ,@funitid int,@fstdprice decimal(24,4),@fusdprice decimal(24,4)
	declare @fstatus int,@fsubid int,@foldprice1 decimal(24,4),@foldprice2 decimal(24,4),@foldprice3 decimal(24,4)
	declare @fdate datetime,@freasonid int,@findex int
	declare @fuserid int ,@s varchar(500),@frelatedid int

	declare @ftargetprofit decimal(24,4) , @flowestprofit decimal(24,4), @ftax decimal(24,4),@fprograde int, @fbacktax decimal(24,4)  --怔退税率差

	select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期

	declare @fmaterialfee decimal(24,4),@fpiecefee decimal(24,4),@ffinancefee decimal(24,4)
	declare @fbegqty1 int,@fendqty1 int,@fbegqty2 int,@fendqty2 int,@fbegqty3 int,@fendqty3 int

	set @FUSDExchangerate=6.2
	select @FUSDExchangerate=fvalue FROM t_SystemProfile t1 WHERE fkey='FUSDExchangerate' and FCategory='IC'
    -- Insert statements for trigger here
	--select @iMaxIndex=isnull(max(findex)+1,1) from MY_T_NETCONTROL where fuserid=1 and fbilltype=-1
	--select * from t_submessage where ftypeid=501   select * from t_currency 
	select top 1 @fsubid=fsubid,@fcheckerid=isnull(fcheckerid,0),@fbillno=fbillno,@FInterID=finterid,
	@fcurrencyid=fcurrencyid,@fuserid=fbillerid from INSERTED 
	
	select @fbegqty1=0,@fendqty1=0,@fbegqty2=0,@fendqty2=0,@fbegqty3=0,@fendqty3=0 --from my_t_PricePolicy where fsubid=@fsubid

	if update(fcheckerid) and @fcheckerid>0
	begin
		/*
		if exists (select 1
		from t_BOSSuitBill t1
		inner join MySEPriceChangeEntry t2 on t1.fproductid=t2.fitemid
		inner join t_icitem t4 on t4.fitemid=t2.fitemid
		where t2.finterid=@FInterID)
		begin
			set @s='套装产品不用进行价格联络!'
			RAISERROR(@s,18,18)
		end
		*/

		if @fcurrencyid =1000 set @frelatedid=20011 else set @frelatedid=20012

		select @findex=isnull(max(findex)+1,1) from IcPrcPlyEntry where finterid=@fsubid and frelatedid=@frelatedid  

		update t5 set 
		F_130=cast(isnull(t1.fmaterialfee,0) as decimal(24,4)),
		F_131=cast(isnull(t1.ffinancefee,0) as decimal(24,4)),
		F_132=isnull(t1.ftargetprofit,0),F_133=isnull(t1.flowestprofit,0),F_134=isnull(t1.fbacktax,0),F_135=isnull(t1.ftax,0),
		F_136=isnull(t4.fitemid,0)
		from MySEPriceChangeEntry t1
		inner join t_icitem t2 on t1.fitemid=t2.fitemid
		inner join MySEPriceChange t3 on t1.finterid=t3.finterid
		left join t_item t4 on t4.fnumber=t1.fprograde and t4.fitemclassid=3018
		inner join t_ICItemCustom t5 on t5.fitemid=t2.fitemid
		where t1.finterid=@FInterID

		update t2 set fbegdate=@fdate,fprice=t1.fprice 
		from MySEPriceChangeEntry t1
		inner join t_icitem t3 on t1.fitemid=t3.fitemid
		inner join IcPrcPlyEntry t2 on t1.fitemid=t2.fitemid and t2.frelatedid=@frelatedid and t2.FCuryID=@fcurrencyid and t2.finterid=@fsubid
		where t1.finterid=@FInterID
		--and exists (select 1 from IcPrcPlyEntry where fitemid=t2.fitemid and frelatedid=@frelatedid and fcurrencyid=@fcurrencyid and finterid=@fsubid) --and t1.fbegqty=1 

		create table #MyIcPrcPlyEntry(findex int identity(1,1),frelatedid int,FCuryID int,fitemid int,funitid int,fbegqty int,fendqty int,fprice decimal(24,4))

		insert into #MyIcPrcPlyEntry(FCuryID,        frelatedid,      fitemid,   funitid,   fbegqty,fendqty,fprice)
		select                       @fcurrencyid,   @frelatedid,     t3.fitemid,t3.funitid,0,      0,      cast(isnull(t1.fprice,0) as decimal(24,4)) fprice
		from MySEPriceChangeEntry t1
		inner join t_icitem t3 on t1.fitemid=t3.fitemid
		where t1.finterid=@FInterID
		and not exists (select 1 from IcPrcPlyEntry where fitemid=t3.fitemid and frelatedid=@frelatedid and FCuryID=@fcurrencyid and finterid=@fsubid ) --and t1.fbegqty=1 

		INSERT INTO IcPrcPlyEntry(frelatedid,FIndex,         FItemID, FAuxPropID,FInterID, FUnitID,  FBegQty,  FEndQty,   FCuryID,   FPriceType,FPrice,   FBegDate,    FEndDate,    FLeadTime,FNote,Fchecked,FFlagSave) 
		select                    frelatedid,@findex+findex, fitemid, 0,         @fsubid,  funitid,  FBegQty,  FEndQty,   FCuryID,   0,         FPrice,   @fdate,      '2100-01-01',0,        '',   1,       newid()
		from #MyIcPrcPlyEntry where frelatedid=@frelatedid  

		drop table #MyIcPrcPlyEntry

--		DECLARE Seorder_Cursor CURSOR FOR
--		select t3.fcurrencyid,t2.fitemid,t2.funitid,isnull(t4.fitemid,0) fprograde,
--		isnull(ftargetprofit,0) ftargetprofit,isnull(flowestprofit,0) flowestprofit,isnull(fbacktax,0) fbacktax,isnull(ftax,0) ftax,
--		cast(isnull(t1.fmaterialfee,0) as decimal(24,4)) fmaterialfee,
--		cast(isnull(t1.fpiecefee,0) as decimal(24,4)) fpiecefee,cast(isnull(t1.ffinancefee,0) as decimal(24,4)) ffinancefee,
--		cast(isnull(t1.fstdprice,0) as decimal(24,4)) fstdprice,cast(isnull(t1.fprice,0) as decimal(24,4)) fprice,/*cast(isnull(t1.fusdprice,0) as decimal(24,4))*/ 0 fusdprice
--		from MySEPriceChangeEntry t1
--		inner join t_icitem t2 on t1.fitemid=t2.fitemid
--		inner join MySEPriceChange t3 on t1.finterid=t3.finterid
--		left join t_item t4 on t4.fnumber=t1.fprograde and t4.fitemclassid=3018
--		where t1.finterid=@FInterID
--		order by t2.fnumber

--		OPEN Seorder_Cursor

--		FETCH NEXT FROM Seorder_Cursor 
--		INTO @fcurrencyid,@fitemid,@funitid,@fprograde,@ftargetprofit,@flowestprofit,@fbacktax,@ftax,@fmaterialfee,@fpiecefee,@ffinancefee,@fstdprice,@fprice,@fusdprice

--		WHILE @@FETCH_STATUS = 0
--		BEGIN
--			if @fcurrencyid =1000 set @frelatedid=20011 else set @frelatedid=20012

--			-- select * from t_itempropdesc where fitemclassid=4  --select * from t_submessage where ftypeid=501

---- 			update t2 set FPieceRate=cast(@fpiecefee*@FUSDExchangerate as decimal(24,4))
---- 			from t_ICItemStandard t2 where t2.fitemid=@fitemid

-- 			--update t2 set FPieceRate=@fpiecefee  --直接在新增物料的时候录入进去了
-- 			--from t_ICItemStandard t2 where t2.fitemid=@fitemid

--			update t2 set F_130=@fmaterialfee,F_131=@ffinancefee,F_132=@ftargetprofit,F_133=@flowestprofit,F_134=@fbacktax,F_135=@ftax,F_136=@fprograde
--			from t_ICItemCustom t2 where t2.fitemid=@fitemid

--			if exists (select 1 from IcPrcPlyEntry where fitemid=@fitemid and finterid=@fsubid and frelatedid=@frelatedid)
--			begin
---- 				update IcPrcPlyEntry set fbegdate=@fdate,fmaterialfee=@fmaterialfee where fitemid=@fitemid and finterid=@fsubid and FBegQty=@fbegqty1 and FEndQty=@fendqty1 and frelatedid=@frelatedid
---- 				update IcPrcPlyEntry set fbegdate=@fdate,fpiecefee=@fpiecefee where fitemid=@fitemid and finterid=@fsubid and FBegQty=@fbegqty2 and FEndQty=@fendqty2 and frelatedid=@frelatedid
---- 				update IcPrcPlyEntry set fbegdate=@fdate,ffinancefee=@ffinancefee where fitemid=@fitemid and finterid=@fsubid and FBegQty=@fbegqty3 and FEndQty=@fendqty3 and frelatedid=@frelatedid
---- 				update IcPrcPlyEntry set fbegdate=@fdate,fstdprice=@fstdprice where fitemid=@fitemid and finterid=@fsubid and FBegQty=@fbegqty3 and FEndQty=@fendqty3 and frelatedid=@frelatedid
--				update IcPrcPlyEntry set fbegdate=@fdate,fprice=@fprice where fitemid=@fitemid and finterid=@fsubid and FBegQty=@fbegqty3 and FEndQty=@fendqty3 and frelatedid=@frelatedid
---- 				update IcPrcPlyEntry set fbegdate=@fdate,fusdprice=@fusdprice where fitemid=@fitemid and finterid=@fsubid and FBegQty=@fbegqty3 and FEndQty=@fendqty3 and frelatedid=@frelatedid
--			end
--			else
--			begin
--				select @findex=isnull(max(findex)+1,1) from IcPrcPlyEntry where finterid=@fsubid and frelatedid=@frelatedid
				
--				INSERT INTO IcPrcPlyEntry(frelatedid,      FIndex,  FItemID,  FAuxPropID,FInterID, FUnitID,  FBegQty,  FEndQty,   FCuryID,         FPriceType,FPrice, fusdprice,  fstdprice, FBegDate,    FEndDate,    FLeadTime,FNote,Fchecked,FFlagSave) --ftargetprofit, flowestprofit, fbacktax, ftax, fprograde, fmaterialfee, fpiecefee,  ffinancefee,
--				Values(                   @frelatedid,     @findex, @fitemid, 0,         @fsubid,  @funitid, @fbegqty1,@fendqty1, @fcurrencyid,    0,         @FPrice,@fusdprice, @fstdprice,@fdate,      '2100-01-01',0,        '',   1,       newid())   --@ftargetprofit,@flowestprofit,@fbacktax,@ftax,@fprograde,@fmaterialfee,@fpiecefee, @ffinancefee,
--			end

--			FETCH NEXT FROM Seorder_Cursor 
--			INTO @fcurrencyid,@fitemid,@funitid,@fprograde,@ftargetprofit,@flowestprofit,@fbacktax,@ftax,@fmaterialfee,@fpiecefee,@ffinancefee,@fstdprice,@fprice,@fusdprice
--		END

--		CLOSE Seorder_Cursor
--		DEALLOCATE Seorder_Cursor
	end
end

go

--------------------------------------------------------------
--单据编码规则
declare @fmybilltypeid int
exec My_p_AddBillNo @fmybilltypeid output, 'MyICQuotation', 'QT'
exec My_p_AddBillNo @fmybilltypeid output, 'My_t_Mrp', 'MP'
exec My_p_AddBillNo @fmybilltypeid output, 'MyPOPriceChange', 'PC'
exec My_p_AddBillNo @fmybilltypeid output, 'MySEPriceChange', 'SC'
exec My_p_AddBillNo @fmybilltypeid output, 'MyStdCostChange', 'SCC'
exec My_p_AddBillNo @fmybilltypeid output, 'MyBomBachChange', 'BC'
exec My_p_AddBillNo @fmybilltypeid output, 'MyPackBachChange', 'PBC'
exec My_p_AddBillNo @fmybilltypeid output, 'My_t_RepAls', 'MR'
--select @fmybilltypeid 

go

--select * from icbillno
IF not EXISTS (select * from sysobjects where name='MyPackBachChangeEntry' and xtype='u') -- drop  Table MyPackBachChangeEntry

begin
CREATE TABLE [dbo].[MyPackBachChangeEntry](
	[finterid] [int] NOT NULL,
	[fentryid] [int] NOT NULL,
	[fitemid] [int] NULL,
	[folditemid] [int] NULL CONSTRAINT [DF_MyPackBachChangeEntry_folditemid]  DEFAULT ((0)),
	[fnewitemid] [int] NULL CONSTRAINT [DF_MyPackBachChangeEntry_fnewitemid]  DEFAULT ((0)),
	[fqty] [decimal](24, 4) NULL CONSTRAINT [DF_MyPackBachChangeEntry_fqty]  DEFAULT ((0)),
	fpositionno varchar(40),
	funitid int,fbrandid int,
	fstockid int,
	[fnote] [varchar](500) COLLATE Chinese_PRC_CI_AS NULL,
	[fbominterid] [int] NULL,
	[ftype] [varchar](500) COLLATE Chinese_PRC_CI_AS NULL,
	[fcontactno] [varchar](500) COLLATE Chinese_PRC_CI_AS NULL,
 CONSTRAINT [PK_MyPackBachChangeEntry] PRIMARY KEY CLUSTERED 
(
	[finterid] ASC,
	[fentryid] ASC
)WITH  FILLFACTOR = 90 ON [PRIMARY]
) ON [PRIMARY]

end

go



----------------------------------------------------------------------------

IF not EXISTS (select * from sysobjects where name='MyPackBachChange' and xtype='u') -- drop  Table MyPackBachChange
begin
CREATE TABLE [dbo].[MyPackBachChange](
	[finterid] [int] ,--IDENTITY(1,1) NOT NULL,
	fchangetype varchar(50),
	[fbillno] [varchar](50) COLLATE Chinese_PRC_CI_AS NULL,
	[fdate] [datetime] NULL,
	[fbillerid] [int] NULL,
	fishavenotify bit default((0)),
	[fcheckerid] [int] NULL CONSTRAINT [DF_MyPackBachChange_fcheckerid]  DEFAULT ((0)),
	[fcheckdate] [datetime] NULL,
	fchangerid int,
	fchangedate datetime,
	[folditemid] [int] NULL CONSTRAINT [DF_MyPackBachChange_folditemid]  DEFAULT ((0)),
	[foldqty] [decimal](24, 2) NULL CONSTRAINT [DF_MyPackBachChange_foldqty]  DEFAULT ((0)),
	[fnewitemid] [int] NULL CONSTRAINT [DF_MyPackBachChange_fnewitemid]  DEFAULT ((0)),
	[fqty] [decimal](24, 2) NULL CONSTRAINT [DF_MyPackBachChange_fqty]  DEFAULT ((0)),
	[fnote] [varchar](500) COLLATE Chinese_PRC_CI_AS NULL,
	[fstatus] [int] NULL,
	[fisautocheck] [bit] NULL CONSTRAINT [DF_MyPackBachChange_fisautocheck]  DEFAULT ((1)),
 CONSTRAINT [PK_MyPackBachChange] PRIMARY KEY CLUSTERED 
(
	[finterid] ASC
)WITH  FILLFACTOR = 90 ON [PRIMARY]
) ON [PRIMARY]

end
--select * from MyPackBachChange
go


IF EXISTS (select * from sysobjects where name='v_MyPackBachChange' and xtype='v')  drop  view v_MyPackBachChange

go

create view v_MyPackBachChange
as
select t1.fbillno 单据编号,t1.finterid 单据内码,t1.fdate 日期,t5.fname 制单人,
(case when t1.fstatus=0 then '未审核' when t1.fstatus=1 then '已审核' when t1.fstatus=2 then '已变更' end) 状态,
t1.fnote 备注--,
--t4.fnumber 父级物料,(t4.fname++'/'+isnull(t4.fmodel,'')) 父级物料名称,
--isnull(t2.fnumber,'') 原物料编码,isnull(t2.fname,'')+'/'+isnull(t2.fmodel,'') 原物料名称,
--isnull(t3.fnumber,'') 新物料编码,isnull(t3.fname,'')+'/'+isnull(t3.fmodel,'')  新物料名称,
--isnull(t12.fqty,0) 数量,t12.fnote 明细备注
from mypackbachchange t1
--inner join mypackbachchangeentry t12 on t1.finterid=t12.finterid
--left join t_icitem t2 on t12.folditemid=t2.fitemid
--left join t_icitem t3 on t12.fnewitemid=t3.fitemid
--inner join t_icitem t4 on t12.fitemid=t4.fitemid
inner join t_user t5 on t5.fuserid=t1.fbillerid

go




--包装方案批量变更

IF EXISTS (select * from sysobjects where name='my_p_PackBachChange' and xtype='p')  drop  procedure my_p_PackBachChange


go

--my_p_PackBachChange 1022,16394,''

create procedure [dbo].my_p_PackBachChange(@finterid int,@UserId int,@errorinfo varchar(500) output)
as
SET NOCOUNT ON
declare @fplanprice decimal(18,4),@fitemid int,@fpitemid int,@funitid int,@entryid int,@fqty decimal(24,4)
declare @InterID int,@BillNo varchar (20),@StockId int,@StockNumber varchar (20)
DECLARE @TmpID INT ,@ftype varchar(500), @iLength int,@fchilditemid int
declare @fprojectval  varchar(200),@sDateFormat  varchar(200)
declare @fsourceNumber varchar(200),@fpSourceNumber varchar(200),@fpXxSourceNumber varchar(200)
declare @fXxOldSourceNumber varchar(200), @FStockID int,@xx_FItemIDOld int,@fxxitemid int
declare @FDCSPID int,@fbominterid int,@folditemid int,@foldqty decimal(24,4),@foldpositionno varchar(20)
declare @fpositionno varchar(20),@fnewitemid int
declare @famount decimal (18,2),@foldentryid int
declare @fsourceInterid int,@fsourceEntryid int
declare @ftargetInterid int,@ftargetEntryid int
declare @fsourceitemid int,@ftargetitemid int
declare @fsourceshortnumber varchar(50),@ftargetshortnumber varchar(50)
declare @fsourcebillno varchar(50),@fiscanconfig int,@fbackflush int

select @fsourcebillno=fbillno from mypackbachchange where finterid=@finterid

--AIS20041229163526   AIS20080129143619

set @errorinfo=''

DECLARE icbom_cursor CURSOR FOR	
select t12.fbominterid,isnull(t2.fitemid,0) folditemid,
isnull(t3.fitemid,0) fnewitemid,
isnull(round(t12.fqty,t3.fqtydecimal),0) fqty,--数量精度以新物料为准
t12.ftype,isnull(t12.funitid,0) funitid,t1.fbillno
from mypackbachchange t1
inner join mypackbachchangeentry t12 on t1.finterid=t12.finterid
left join t_icitem t2 on t12.folditemid=t2.fitemid
left join t_icitem t3 on t12.fnewitemid=t3.fitemid
inner join t_icitem t4 on t12.fitemid=t4.fitemid
where t1.finterid=@finterid
and t12.ftype not like '%错误%'


OPEN icbom_cursor

FETCH NEXT FROM icbom_cursor 
INTO @fbominterid,@folditemid,@fnewitemid,@fqty,@ftype,@funitid,@BillNo

WHILE @@FETCH_STATUS = 0
BEGIN 
	if (Charindex('替换',@ftype)<>0) or (Charindex('更改',@ftype)<>0)
	begin
		select @funitid=funitid from t_icitem where fitemid=@fnewitemid
		update t_bospacksubentry set fitemid=@fnewitemid,fqty=@fqty,funitid=@funitid where fid=@fbominterid and fitemid=@folditemid
	end 

	if Charindex('新增',@ftype)<>0
	begin
		select @entryid=max(FIndex)+1 from t_bospacksubentry where fid=@fbominterid
		select @funitid=funitid from t_icitem where fitemid=@fnewitemid	 
		INSERT INTO t_bospacksubentry(fitemid,    FID,         FIndex,  FQty, funitid,  FRemark) 
		Values(						  @fnewitemid,@fbominterid,@entryid,@FQty,@funitid, '')
	end 

	if Charindex('删除',@ftype)<>0
	begin
		select top 1 @foldentryid=FIndex from t_bospacksubentry where fid=@fbominterid and fitemid=@folditemid
		delete from t_bospacksubentry where fid=@fbominterid and fitemid=@folditemid
		update t_bospacksubentry set FIndex=FIndex-1 where fid=@fbominterid and FIndex>@foldentryid   --重新更新分录
	end 
	
	--update t_bospacksub set FOperatorID=@UserId,FEnterTime=getdate() where finterid=@fbominterid 

	INSERT INTO t_Log (FDate,FUserID,FFunctionID,FStatement,FDescription,FMachineName,FIPAddress) VALUES (getdate(),@UserId,'K010001',3,'编号为'+@BillNo+'的单据更新成功','KSW118','192.168.0.159')

	FETCH NEXT FROM icbom_cursor 
    INTO @fbominterid,@folditemid,@fnewitemid,@fqty,@ftype,@funitid,@BillNo

END

CLOSE icbom_cursor
DEALLOCATE icbom_cursor


GO


IF not EXISTS (select * from sysobjects where name='MyBomBachChangeEntry' and xtype='u')--  drop  Table MyBomBachChangeEntry
begin

CREATE TABLE [dbo].[MyBomBachChangeEntry](
	[finterid] [int] NOT NULL,
	[fentryid] [int] NOT NULL,
	[fitemid] [int] NULL,
	[folditemid] [int] NULL CONSTRAINT [DF_MyBomBachChangeEntry_folditemid]  DEFAULT ((0)),
	[fnewitemid] [int] NULL CONSTRAINT [DF_MyBomBachChangeEntry_fnewitemid]  DEFAULT ((0)),
	[foldqty] [decimal](24, 2) NULL CONSTRAINT [DF_MyBomBachChangeEntry_foldqty]  DEFAULT ((0)),
	[fqty] [decimal](24, 4) NULL CONSTRAINT [DF_MyBomBachChangeEntry_fqty]  DEFAULT ((0)),
	[fnewqty] [decimal](24, 4) NULL CONSTRAINT [DF_MyBomBachChangeEntry_fnewqty]  DEFAULT ((0)),
	fpositionno varchar(40),
	funitid int,
	fstockid int,
	[fnote] [varchar](500) COLLATE Chinese_PRC_CI_AS NULL,
	[fbominterid] [int] NULL,fbackflush int,fiscanconfig int,
	[ftype] [varchar](500) COLLATE Chinese_PRC_CI_AS NULL,
	[fcontactno] [varchar](500) COLLATE Chinese_PRC_CI_AS NULL,
 CONSTRAINT [PK_MyBomBachChangeEntry] PRIMARY KEY CLUSTERED 
(
	[finterid] ASC,
	[fentryid] ASC
)WITH  FILLFACTOR = 90 ON [PRIMARY]
) ON [PRIMARY]

end

go


IF not EXISTS (select * from sysobjects where name='MyBomBachChange' and xtype='u')  --drop  Table MyBomBachChange
begin
CREATE TABLE [dbo].[MyBomBachChange](
	[finterid] [int] ,--IDENTITY(1,1) NOT NULL,
	fchangetype varchar(50),
	[fbillno] [varchar](50) COLLATE Chinese_PRC_CI_AS NULL,
	[fdate] [datetime] NULL,
	[fbillerid] [int] NULL,
	fishavenotify bit default((0)),
	[fcheckerid] [int] NULL CONSTRAINT [DF_MyBomBachChange_fcheckerid]  DEFAULT ((0)),
	[fcheckdate] [datetime] NULL,
	fchangerid int,
	fchangedate datetime,
	feffectdate datetime,
	[folditemid] [int] NULL CONSTRAINT [DF_MyBomBachChange_folditemid]  DEFAULT ((0)),
	[foldqty] [decimal](24, 2) NULL CONSTRAINT [DF_MyBomBachChange_foldqty]  DEFAULT ((0)),
	[fnewitemid] [int] NULL CONSTRAINT [DF_MyBomBachChange_fnewitemid]  DEFAULT ((0)),
	[fqty] [decimal](24, 2) NULL CONSTRAINT [DF_MyBomBachChange_fqty]  DEFAULT ((0)),
	[fnote] [varchar](500) COLLATE Chinese_PRC_CI_AS NULL,
	[fstatus] [int] NULL,
	[fisautocheck] [bit] NULL CONSTRAINT [DF_MyBomBachChange_fisautocheck]  DEFAULT ((1)),
 CONSTRAINT [PK_MyBomBachChange] PRIMARY KEY CLUSTERED 
(
	[finterid] ASC
)WITH  FILLFACTOR = 90 ON [PRIMARY]
) ON [PRIMARY]
end

go


IF EXISTS (select * from sysobjects where name='v_MyBomBachChange' and xtype='v')  drop  view v_MyBomBachChange

go

create view v_MyBomBachChange
as
select t1.fbillno 单据编号,t1.fdate 日期,
(case when t1.fstatus=0 then '未审核' when t1.fstatus=1 then '已审核' when t1.fstatus=2 then '已变更' end) 状态,
isnull(t1.fchangetype,'') 变更方式,t1.fnote 备注
from mybombachchange t1

go

--select * from v_MyBomBachChangeDetail

IF EXISTS (select * from sysobjects where name='v_MyBomBachChangeDetail' and xtype='v')  drop  view v_MyBomBachChangeDetail

go

create view v_MyBomBachChangeDetail
as
select t1.fbillno 单据编号,t1.fdate 日期,
(case when t1.fstatus=0 then '未审核' when t1.fstatus=1 then '已审核' when t1.fstatus=2 then '已变更' end) 状态,
isnull(t1.fchangetype,'') 变更方式,t1.fnote 备注
,t4.fnumber 父级物料,(t4.fname++'///'+isnull(t4.fmodel,'')+'///'+isnull(t4.f_105,'')) 父级物料名称,
isnull(t2.fnumber,'') 原物料编码,isnull(t2.fname,'')+'///'+isnull(t2.fmodel,'') 原物料名称,
isnull(t3.fnumber,'') 新物料编码,isnull(t3.fname,'')+'///'+isnull(t3.fmodel,'')  新物料名称,
isnull(t12.fqty,0) 数量,isnull(t12.fpositionno,'') 位置号,t12.fnote 明细备注,t12.ftype 变更类型
from mybombachchange t1
inner join mybombachchangeentry t12 on t1.finterid=t12.finterid
left join t_icitem t2 on t12.folditemid=t2.fitemid
left join t_icitem t3 on t12.fnewitemid=t3.fitemid
inner join t_icitem t4 on t12.fitemid=t4.fitemid

go


--my_p_ReFlushSuitPrice 
IF EXISTS (select * from sysobjects where name='my_p_ReFlushSuitPrice' and xtype='p')  drop  procedure my_p_ReFlushSuitPrice


go

create procedure [dbo].[my_p_ReFlushSuitPrice]
as

SET NOCOUNT ON

declare @iMaxIndex int
declare @FInterID int ,@fcheckerid int,@FTaxPrice decimal(24,5),@fprices decimal(24,5)
declare @FMyInterID int ,@FSupplyId int,@fnumber varchar(50),@fshortnumber varchar(50)
declare @fcurrencyid int,@FPType int,@fstartqty int,@fendqty int,@fnote varchar(500)
declare @fbillno varchar(30),@fitemid int,@fprice decimal(24,5),@ftempprice decimal(24,5)
declare @ftrantype int ,@funitid int
declare @fstatus int
declare @fdate datetime,@freasonid int
declare @fuserid int 

select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期


DECLARE icbom_cursor CURSOR FOR	


select isnull(t1.ftaxprice,0) ftaxprice,(case when t2.ferpclsid=1 then 1 else 0 end) fptype,
--(case when isnull(t3.fcyid,0)=0 then 1 else t3.fcyid end) fcurrency,
(case when isnull(t3.fcurrencyid,0)=0 then 1 else t3.fcurrencyid end) fcurrency,
t1.fprice,0 fstarqty,
0 fendqty,'' fnote,t1.FSupID fsupplyid,t1.fitemid,t2.funitid,t2.fnumber,t2.fshortnumber
from (select fitemid,max(fentryid) fentryid from (select t1.fitemid,t1.fentryid from t_supplyentry t1 inner join (select fitemid,max(FQuoteTime) FQuoteTime from t_SupplyEntry group by fitemid) t2 on t1.fitemid=t2.fitemid and t1.FQuoteTime=t2.FQuoteTime) t1 group by fitemid) t4 
inner join t_supplyentry t1 on t4.fitemid=t1.fitemid and t4.fentryid=t1.fentryid
inner join t_icitem t2 on t1.fitemid=t2.fitemid
inner join t_supplier t3 on t3.fitemid=t1.FSupID
inner join icbom t14 on t1.fitemid=t14.fitemid
where t2.fnumber like '1.02.%'  --and t2.fshortnumber like '060101'
order by t1.fentryid

OPEN icbom_cursor


FETCH NEXT FROM icbom_cursor 
INTO @FTaxPrice,@fptype,@fcurrencyid,@fprice,@fstartqty,@fendqty,@fnote,@FSupplyId,@fitemid,@funitid,@fnumber,@fshortnumber

WHILE @@FETCH_STATUS = 0
BEGIN 
	if left(@fnumber,5)='1.02.' 
	begin
		if exists(select 1 from t_SupplyEntry t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid where t1.FSupID=@FSupplyId and t2.fnumber like '6.%.'+@fshortnumber+'.%')
		   and exists (select 1 from icbom where fitemid=@fitemid)
		begin
			select @fprices=sum(t1.fprice) from t_SupplyEntry t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid where t1.FSupID=@FSupplyId and t2.fnumber like '6.%.'+@fshortnumber+'.%' 

			update t1 set fprice=cast(@FPrice*(t1.fprice/@fprices) as decimal(24,5))
			from t_SupplyEntry t1 
			inner join t_icitem t2 on t1.fitemid=t2.fitemid 
			where t1.FSupID=@FSupplyId and t2.fnumber like '6.%.'+@fshortnumber+'.%' 

			update t1 set FTaxPrice=t1.fprice
			from t_SupplyEntry t1 
			inner join t_icitem t2 on t1.fitemid=t2.fitemid 
			where t1.FSupID=@FSupplyId and t2.fnumber like '6.%.'+@fshortnumber+'.%' 
		end
	end

	FETCH NEXT FROM icbom_cursor 
	INTO @FTaxPrice,@fptype,@fcurrencyid,@fprice,@fstartqty,@fendqty,@fnote,@FSupplyId,@fitemid,@funitid,@fnumber,@fshortnumber
END

CLOSE icbom_cursor
DEALLOCATE icbom_cursor

--select t2.fnumber,t2.fname,t1.* from t_SupplyEntry t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid where t1.FSupID=25683 and t2.fnumber like '6.%.060101.%'


set nocount off

go


--BOM批量变更

IF EXISTS (select * from sysobjects where name='my_p_BomBachChange' and xtype='p')  drop  procedure my_p_BomBachChange


go

--my_p_BomBachChange 1035,16394,''

create procedure [dbo].[my_p_BomBachChange](@finterid int,@UserId int,@errorinfo varchar(500) output)
as
SET NOCOUNT ON
declare @fplanprice decimal(18,4),@fitemid int,@fpitemid int,@funitid int,@entryid int,@fqty decimal(24,4)
declare @InterID int,@BillNo varchar (20),@StockId int,@StockNumber varchar (20)
DECLARE @TmpID INT ,@ftype varchar(500)
declare @iLength int,@fcheckerid int
declare @fprojectval  varchar(200)
declare @sDateFormat  varchar(200)
declare @fsourceNumber varchar(200),@fpSourceNumber varchar(200),@fpXxSourceNumber varchar(200)
declare @fXxOldSourceNumber varchar(200)
declare @FStockID int,@xx_FItemIDOld int,@fxxitemid int
declare @FDCSPID int,@fbominterid int,@folditemid int,@foldqty decimal(24,4),@foldpositionno varchar(20)
declare @fpositionno varchar(20),@fnewitemid int
declare @famount decimal (18,2),@foldentryid int
declare @fsourceInterid int,@fsourceEntryid int
declare @ftargetInterid int,@ftargetEntryid int
declare @fsourceitemid int,@ftargetitemid int
declare @fsourceshortnumber varchar(50),@ftargetshortnumber varchar(50)
declare @fsourcebillno varchar(50),@fiscanconfig int,@fbackflush int

select @fsourcebillno=fbillno from mybombachchange where finterid=@finterid

--AIS20041229163526   AIS20080129143619

set @errorinfo=''

DECLARE icbom_cursor CURSOR FOR	
select isnull(t5.fcheckerid,0) fcheckerid,t12.fbominterid,isnull(t2.fitemid,0) folditemid,
isnull(t3.fitemid,0) fnewitemid,isnull(t12.fpositionno,'') fpositionno,
isnull(round(t12.fqty,t3.fqtydecimal),0) fqty,--数量精度以新物料为准
t12.ftype,isnull(t12.funitid,0) funitid,t1.fbillno,t12.fstockid,
isnull(t12.fiscanconfig,1059) fiscanconfig,isnull(t12.fbackflush,1059) fbackflush
from mybombachchange t1
inner join mybombachchangeentry t12 on t1.finterid=t12.finterid
left join t_icitem t2 on t12.folditemid=t2.fitemid
left join t_icitem t3 on t12.fnewitemid=t3.fitemid
inner join t_icitem t4 on t12.fitemid=t4.fitemid
inner join icbom t5 on t5.finterid=t12.fbominterid
where t1.finterid=@finterid
and t12.ftype not like '%错误%'
order by t4.fnumber

OPEN icbom_cursor

FETCH NEXT FROM icbom_cursor 
INTO @fcheckerid,@fbominterid,@folditemid,@fnewitemid,@fpositionno,@fqty,@ftype,@funitid,@BillNo,@FStockID,@fiscanconfig,@fbackflush

WHILE @@FETCH_STATUS = 0
BEGIN 
	if (Charindex('替换',@ftype)<>0) or (Charindex('更改',@ftype)<>0)
	begin
		update icbomchild set fbackflush=@fbackflush,fitemid=@fnewitemid,fqty=@fqty,fauxqty=@fqty,fpositionno=@fpositionno, fentryselfz0141=@BillNo,fentryselfz0140=@fiscanconfig,fstockid=@FStockID,funitid=@funitid where finterid=@fbominterid and fitemid=@folditemid
	end 

	if Charindex('新增',@ftype)<>0
	begin
		select @entryid=max(fentryid)+1 from icbomchild where finterid=@fbominterid
	 
		INSERT INTO ICBomChild(FInterID,      FEntryID,FBrNo,fpositionno,    FItemID,    FMachinePos,FNote,FAuxQty, FScrap,FOffSetDay,FUnitID, FQty, FMaterielType, FMarshalType,FBeginDay,   FEndDay,     FPercent,FItemSize,FItemSuite,FOperSN,FOperID,FBackFlush,       FStockID, FSPID,FNote1,FNote2,FAuxPropID,FNote3, fentryselfz0141, fentryselfz0140) 
		select		           @fbominterid,  @entryid,'0',  @fpositionno,   @fnewitemid,'',         '' ,  @fqty,   0,     0,         @FUnitID,@fqty,371,           385,         '1900-01-01','2100-01-01',100,     '',       '',        0,      0,      @fbackflush,      @FStockID,0,    '',    '',    0,         '',     @BillNo,         @fiscanconfig
	end 

	if Charindex('删除',@ftype)<>0
	begin
		select top 1 @foldentryid=fentryid from icbomchild where finterid=@fbominterid and fitemid=@folditemid
		delete from icbomchild where finterid=@fbominterid and fitemid=@folditemid
		update icbomchild set fentryid=fentryid-1 where finterid=@fbominterid and fentryid>@foldentryid   --重新更新分录
	end 

	Update t1 set t1.FQty=cast(t1.FAuxQty as decimal(28,15)) * cast( isnull(t3.FCoefficient,1)  + cast(isnull(t3.FScale,0) as float) as decimal(28,15) )
	from ICBOMChild  t1,t_MeasureUnit t3
	Where t3.FItemID = t1.FUnitID and t1.FInterID=@fbominterid
	
	update icbom set FOperatorID=@UserId,FEnterTime=getdate() where finterid=@fbominterid 

	if @fcheckerid>0 --如果BOM已经审核，则触发BOM的触发器
	begin
	    update icbom set fstatus=0 where finterid=@fbominterid  
		update icbom set fstatus=1 where finterid=@fbominterid 
		update icbom set fcheckerid=0 where finterid=@fbominterid  
		update icbom set fcheckerid=@fcheckerid where finterid=@fbominterid  
	end

	INSERT INTO t_Log (FDate,FUserID,FFunctionID,FStatement,FDescription,FMachineName,FIPAddress) VALUES (getdate(),@UserId,'K010001',3,'编号为'+@BillNo+'的单据更新成功','KSW118','192.168.0.159')

	FETCH NEXT FROM icbom_cursor 
    	INTO @fcheckerid,@fbominterid,@folditemid,@fnewitemid,@fpositionno,@fqty,@ftype,@funitid,@BillNo,@FStockID,@fiscanconfig,@fbackflush
END

CLOSE icbom_cursor
DEALLOCATE icbom_cursor


GO

IF not EXISTS (select * from sysobjects where name='MyBomChangeCondition' and xtype='u') -- drop  Table MyBomChangeCondition
begin
create table MyBomChangeCondition 
(
	fsourceinterid int,
	fentryid int,
	fitemid int,
	flogic varchar(20),
	fcondition varchar(20),
	finvqty decimal(24,2),
	FLeftSymbol varchar(20),
	FRightSymbol varchar(20)
)
end
go



IF not EXISTS (select * from sysobjects where name='MyPOPriceChange' and xtype='u') --drop Table MyPOPriceChange 
begin
CREATE TABLE MyPOPriceChange(
	finterid int not null,
	fbillno varchar(50) not null,
	fdate datetime not null,
	fcheckdate datetime ,
	fbillerid int not null,
	fmodifierID int,
	fmodifytime datetime,
	fbilltime datetime,FCurrencyID int default(1),
	fchecktime datetime,
	fcheckerid int,
	fstatus int default(0),--3 关闭--业务执行完毕
	fnote varchar(500),
	CONSTRAINT [PK_MyPOPriceChange] PRIMARY KEY CLUSTERED 
	(
		[finterid] ASC
	)WITH  FILLFACTOR = 90 ON [PRIMARY]
) ON [PRIMARY]
end

go

IF EXISTS (select * from sysobjects where name='MyPOPriceChange' and xtype='u') and not EXISTS (select t1.id
from sysobjects t1 
inner join syscolumns t2 on t1.id=t2.id
where t1.name='MyPOPriceChange' and t1.xtype='u' and t2.name='FCurrencyID')
begin
	alter table MyPOPriceChange add FCurrencyID int default(1)
end

go

IF not EXISTS (select * from sysobjects where name='MyPOPriceChangeEntry' and xtype='u')  --drop Table MyPOPriceChangeEntry
begin
CREATE TABLE MyPOPriceChangeEntry(
	FInterID int NOT NULL,
	FEntryID int NOT NULL,
	fsupplyid int default 0,
	fstarqty decimal(24,2),
	fendqty decimal(24,2),
	foldprice decimal(24,4) default(0),--自定义价格列
	fprice decimal(24,4) default(0),--自定义价格列
	FItemID int NOT NULL,
	FUnitID int default(0),
	FNote varchar(500) NULL,
	CONSTRAINT [PK_MyPOPriceChangeEntry] PRIMARY KEY CLUSTERED 
	(
		FInterID ASC,
		FEntryID ASC
	) ON [PRIMARY]
) ON [PRIMARY]
end

go


IF EXISTS (select * from sysobjects where name='v_MyPOPriceChange' and xtype='v')  drop  view v_MyPOPriceChange

go

create view v_MyPOPriceChange 
as

select t1.fbillno 单据编号,t1.finterid 单据内码,t1.fdate 制单日期, t4.fname 制单人,isnull(t2.fname,'') 币别,
(case when t1.fstatus=0 then '' when t1.fstatus=1 then 'Y' end) 审核,isnull(t5.fname,'') 审核人,isnull(t1.fcheckdate,Null) 审核日期,
t1.fnote 备注
from MyPOPriceChange t1   
inner join t_User t4 on t1.fbillerid=t4.fuserid and t4.fuserid<>0  
left join t_User t5 on t1.fcheckerid=t5.fuserid and t5.fuserid<>0  
left join t_currency t2 on t2.fcurrencyid=t1.fcurrencyid

go

IF EXISTS (select * from sysobjects where name='MyPOPriceChangeEntry' and xtype='u') and not EXISTS (select t1.id
from sysobjects t1 
inner join syscolumns t2 on t1.id=t2.id
where t1.name='MyPOPriceChangeEntry' and t1.xtype='u' and t2.name='FTaxPrice')
begin
	alter table MyPOPriceChangeEntry add FTaxPrice decimal(24,4) default(0)
	alter table MyPOPriceChangeEntry add FOLDTaxPrice decimal(24,4) default(0)
	alter table MyPOPriceChangeEntry add FStandardPrice decimal(24,4) default(0)
end

go

IF EXISTS (select * from sysobjects where name='v_MyPOPriceChangeDetail' and xtype='v')  drop  view v_MyPOPriceChangeDetail

go

create view v_MyPOPriceChangeDetail 
as

select t1.fbillno 单据编号,t1.finterid 单据内码,t1.fdate 制单日期, t4.fname 制单人,isnull(t10.fname,'') 币别,
(case when t1.fstatus=0 then '' when t1.fstatus=1 then 'Y' end) 审核,
isnull(t5.fname,'') 审核人,isnull(t1.fcheckdate,Null) 审核日期,
isnull(t8.fshortname,'') 主供应商,--取制造商字段内容
t7.fnumber 厂商编码,t7.fshortname 厂商名称,t7.fitemid 厂商内码,
t3.fnumber 物料编码,t3.fname 名称,t3.fitemid 物料内码,
t3.fmodel 规格型号,isnull(t3.f_105,'') 描述,isnull(t3.f_106,'') 适用机型,
t3.funitid 单位内码,t6.fname 单位,t2.fstarqty 起始数量,t2.fendqty 截止数量,isnull(t2.fstandardprice,0) 标准单价,
t2.foldprice 原单价,t2.fprice 单价,t2.foldtaxprice 原含税单价,t2.ftaxprice 含税单价,t2.fnote 备注,t9.fname 辅助单位,ISNULL(t9.FCoefficient,1)*t2.foldprice [原单价(辅助)],ISNULL(t9.FCoefficient,1)*t2.fprice [单价(辅助)]
from MyPOPriceChange t1   
inner join MyPOPriceChangeEntry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_User t4 on t1.fbillerid=t4.fuserid and t4.fuserid<>0  
left join t_User t5 on t1.fcheckerid=t5.fuserid and t5.fuserid<>0  
inner join t_measureunit t6 on t6.fitemid=t3.funitid
inner join t_supplier t7 on t7.fitemid=t2.fsupplyid
left join t_supplier t8 on t8.fitemid=t3.F_117 --t3.fsource
inner join t_measureunit t9 on t9.fitemid=t3.FOrderUnitID 
left join t_currency t10 on t10.fcurrencyid=t1.fcurrencyid

go


--采购申请单触发器--采购余数--
IF EXISTS (select * from sysobjects where name='My_tri_PORequest'  and xtype='TR')  drop  TRIGGER My_tri_PORequest
go

create trigger My_tri_PORequest on porequest
for insert,update
as
set nocount on

declare @fstatus int,@finterid int,@s varchar(500)
select @finterid=finterid,@s='',@fstatus=fstatus from inserted

update m2 set FSupplyID=0
from porequestentry m2 
inner join porequest m3 on m2.finterid=m3.finterid
inner join t_icitem m1 on m2.fitemid=m1.fitemid
where m3.finterid=@finterid 

--最新供应商
update t1 set FEntrySelfP0128=isnull(t3.fshortname,'')
from porequestentry t1
inner join 
(	
	select t3.fsupplyid,t1.ftaxprice,t1.fitemid  --该物料的最新单据的供应商
	from poorderentry t1
	inner join 
	(
		select t2.fitemid,isnull(max(t1.finterid),0) finterid --该物料的最新单据
		from poorder t1
		inner join poorderentry t2 on t1.finterid=t2.finterid
		where t1.fstatus>0
		group by t2.fitemid
	) t2 on t1.finterid=t2.finterid and t1.fitemid=t2.fitemid
	inner join poorder t3 on t3.finterid=t1.finterid
) t2 on t1.fitemid=t2.fitemid
inner join t_supplier t3 on t3.fitemid=t2.fsupplyid
where t1.finterid=@finterid 

go

IF EXISTS (select * from sysobjects where name='My_tri_PORequest_Update'  and xtype='TR')  drop  TRIGGER My_tri_PORequest_Update
go

create trigger My_tri_PORequest_Update on porequest
FOR UPDATE
AS
SET NOCOUNT ON

declare @fstatus int,@finterid int,@s varchar(500)
select @finterid=finterid,@s='',@fstatus=fstatus from inserted

IF Update(fstatus) and @fstatus=1
BEGIN
	update porequest set FHeadSelfP0126=convert(varchar(50),getdate(),20) where finterid=@finterid

	if exists(select 1 
	from t_bosfreezerequestentry t1 
	inner join t_bosfreezerequest t2 on t1.fid=t2.fid 
	inner join porequestentry t3 on t3.fitemid=t1.fitemid
	inner join inserted t4 on t4.finterid=t3.finterid 
	inner join t_icitem t5 on t3.fitemid=t5.fitemid where t3.FMRPClosed=0 and @fstatus<>3)  --where isnull(t2.FChecker,0)>0
	begin
		select @s=@s+','+m1.fnumber from
		(
			select distinct t5.fnumber
			from t_bosfreezerequestentry t1 
			inner join t_bosfreezerequest t2 on t1.fid=t2.fid 
			inner join porequestentry t3 on t3.fitemid=t1.fitemid
			inner join inserted t4 on t4.finterid=t3.finterid
			inner join t_icitem t5 on t3.fitemid=t5.fitemid where t3.FMRPClosed=0 and @fstatus<>3
		) m1

		set @s='以下物料已经采购冻结['+@s+']!'

		RAISERROR(@s,18,18)
	end
END
SET NOCOUNT OFF

go


--采购价格联络变更--
IF EXISTS (select * from sysobjects where name='My_Tri_MyPOPriceChange'  and xtype='TR')  drop  TRIGGER My_Tri_MyPOPriceChange
go

Create TRIGGER [My_Tri_MyPOPriceChange]
            ON [dbo].[MyPOPriceChange]
FOR UPDATE

AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
	declare @iMaxIndex int
	declare @FInterID int ,@fcheckerid int,@FTaxPrice decimal(24,5),@fprices decimal(24,5)
	declare @FMyInterID int ,@FSupplyId int,@fnumber varchar(50),@fshortnumber varchar(50)
	declare @fcurrencyid int,@FPType int,@fstartqty int,@fendqty int,@fnote varchar(500)
	declare @fbillno varchar(30),@fitemid int,@fprice decimal(24,5),@ftempprice decimal(24,5)
	declare @ftrantype int ,@funitid int
	declare @fstatus int,@fstandardprice decimal(24,5)
	declare @fdate datetime,@freasonid int
	declare @fuserid int 
	select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期

    -- Insert statements for trigger here
	--select @iMaxIndex=isnull(max(findex)+1,1) from MY_T_NETCONTROL where fuserid=1 and fbilltype=-1
	select top 1 @fcheckerid=isnull(fcheckerid,0),@fbillno=fbillno,@FInterID=finterid,@fuserid=fbillerid from INSERTED 

	if update(fcheckerid) and @fcheckerid>0
	begin
		DECLARE icbom_cursor CURSOR FOR	

		select isnull(t1.ftaxprice,0) ftaxprice,(case when t2.ferpclsid=1 then 1 else 0 end) fptype,
		--(case when isnull(t3.fcyid,0)=0 then 1 else t3.fcyid end) fcurrency,
		(case when isnull(t3.fcurrencyid,0)=0 then 1 else t3.fcurrencyid end) fcurrency,
		t1.fprice,t1.fstarqty,isnull(t1.fstandardprice,0) fstandardprice,
		t1.fendqty,t1.fnote,t1.fsupplyid,t1.fitemid,t2.funitid,t2.fnumber,t2.fshortnumber
		from MyPOPriceChangeEntry t1 
		inner join t_icitem t2 on t1.fitemid=t2.fitemid
		--inner join t_supplier t3 on t3.fitemid=t1.fsupplyid
		inner join MyPOPriceChange t3 on t1.finterid=t3.finterid
		where t1.finterid=@FInterID 
		order by t1.fentryid

		OPEN icbom_cursor


		FETCH NEXT FROM icbom_cursor 
		INTO @FTaxPrice,@fptype,@fcurrencyid,@fprice,@fstartqty,@fstandardprice,@fendqty,@fnote,@FSupplyId,@fitemid,@funitid,@fnumber,@fshortnumber

		WHILE @@FETCH_STATUS = 0
		BEGIN 
			exec GetICMaxNum 't_Supply',@iMaxIndex output

			if exists(select 1 from t_Supply t3 
						  where t3.fsupid=@FSupplyId and t3.fitemid=@FItemId and t3.fptype=@FPType )
			begin
				update t_Supply set FCurrencyID=@fcurrencyid where fitemid=@FItemId and FSupID=@FSupplyId
			end
			else
			begin
				INSERT INTO t_Supply (FBrNo, FItemID, FSupID,    FCurrencyID, FPOHighPrice,FPType) 
					      VALUES ('0',   @FItemId,@FSupplyId,@fcurrencyid,0,           @FPType)
			end

			/*
			set @ftempprice=0
			
			select @ftempprice=t3.fprice  
			from (  
				select m1.fitemid,max(fentryid) fentryid  
				from t_SupplyEntry m1  
				inner join t_supplier m2 on m1.FSupID=m2.fitemid  
				where m1.fsupid=@FSupplyId and m1.fitemid=@FItemId  and m1.fptype=@FPType  and m1.fcyid=@fcurrencyid  and m1.fstartqty=@FStartQty  and m1.fendqty= @FEndQty
				group by m1.fitemid  
			) t1  
			inner join t_icitem t2 on t1.fitemid=t2.fitemid  
			inner join t_SupplyEntry t3 on t3.fentryid=t1.fentryid and t1.fitemid=t3.fitemid  
			left join t_supplier t4 on t4.fitemid=t2.fsource  
			LEFT JOIN t_ICItemBase t5 ON t2.FItemID=t5.FItemID  
			where t3.fsupid=@FSupplyId and t3.fitemid=@FItemId  and t3.fptype=@FPType  and t3.fcyid=@fcurrencyid  and t3.fstartqty=@FStartQty  and t3.fendqty=@FEndQty

			if @ftempprice=0 or @ftempprice<>@fprice
			*/

			update t2 set fentryselfs0176=@FSupplyId
			from seorder t1
			inner join seorderentry t2 on t1.finterid=t2.finterid
			inner join t_icitem t3 on t2.fitemid=t3.fitemid
			inner join icbom t4 on t3.fitemid=t4.fitemid
			inner join icbomchild t5 on t4.finterid=t5.finterid
			inner join t_icitem t6 on t5.fitemid=t6.fitemid
			left join poorderentry t9 on t9.fsourceinterid=t2.finterid and t9.fsourceentryid=t2.fentryid and t9.fsourcetrantype=81
			where left(t6.fnumber,1) in ('7','8') and isnull(t9.fitemid,0)=0	--还没有生成采购订单的外调品销售订单
			and t6.fitemid=@FItemId
	
			if not exists(select 1
				from t_SupplyEntry m1  
				inner join t_supplier m2 on m1.FSupID=m2.fitemid  
				where m1.fsupid=@FSupplyId and m1.fitemid=@FItemId and m1.FStartQty=@FStartQty and m1.FEndQty=@FEndQty )  --and m1.fptype=@FPType  and m1.fcyid=@fcurrencyid  and m1.fstartqty=@FStartQty  and m1.fendqty= @FEndQty
			begin
				INSERT INTO t_SupplyEntry (fstandardprice, FBrNo,FUsed  ,FEntryID,   FSupID,     FItemID,  FUnitID,   FStartQty,   FEndQty,   FPType,   FPrice,  FTaxPrice, FCyID,        FDisCount,  FLeadTime,  FQuoteTime, FDisableDate,   FRemark,     FLastModifiedBy,FLastModifiedDate)  
						   VALUES (        @fstandardprice,'0',  1,     @iMaxIndex , @FSupplyId, @FItemId, @FUnitId , @FStartQty , @FEndQty , @FPType , @FPrice, @FTaxPrice,@fcurrencyid ,0,          0,          @fdate,    '2100-01-01',    @FNote ,     @fuserid,       @fdate) 
			end
			else
			begin
				update t3 set fstandardprice=@fstandardprice,FQuoteTime=@fdate,FRemark=@fnote,fprice=@FPrice,fstartqty=@fstartqty,fendqty=@fendqty,ftaxprice=@FTaxPrice,fcyid=@fcurrencyid,FLastModifiedBy=@fuserid,FLastModifiedDate=@fdate 
				from t_SupplyEntry t3 
				where t3.fsupid=@FSupplyId and t3.fitemid=@FItemId and t3.FStartQty=@FStartQty and t3.FEndQty=@FEndQty
			end

			--update t1 set forderprice=@FPrice from t_ICItemCore t1 where t1.fitemid=@FItemId

-- 			if left(@fnumber,5)='1.02.' 
-- 			begin
-- 				if exists(select 1 from t_SupplyEntry t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid where t1.FSupID=@FSupplyId and t2.fnumber like '6.%.'+@fshortnumber+'.%')
-- 				   and exists (select 1 from icbom where fitemid=@FItemId)
-- 				begin
-- 					select @fprices=sum(t1.fprice) from t_SupplyEntry t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid where t1.FSupID=@FSupplyId and t2.fnumber like '6.%.'+@fshortnumber+'.%' 
-- 
-- 					update t1 set fprice=cast(@FPrice*(t1.fprice/@fprices)/t12.fqty as decimal(24,5))
-- 					from t_SupplyEntry t1 
-- 					inner join icbomchild t12 on t1.fitemid=t12.fitemid
-- 					inner join icbom t13 on t12.finterid=t13.finterid
-- 					inner join t_icitem t2 on t1.fitemid=t2.fitemid 
-- 					inner join t_icitem t3 on t13.fitemid=t3.fitemid 
-- 					where t1.FSupID=@FSupplyId and t2.fnumber like '6.%.'+@fshortnumber+'.%' and t3.fshortnumber=@fshortnumber
-- 
-- 					update t1 set FTaxPrice=t1.fprice
-- 					from t_SupplyEntry t1 
-- 					inner join t_icitem t2 on t1.fitemid=t2.fitemid 
-- 					where t1.FSupID=@FSupplyId and t2.fnumber like '6.%.'+@fshortnumber+'.%' 
-- 				end
-- 			end

			FETCH NEXT FROM icbom_cursor 
			INTO @FTaxPrice,@fptype,@fcurrencyid,@fprice,@fstartqty,@fstandardprice,@fendqty,@fnote,@FSupplyId,@fitemid,@funitid,@fnumber,@fshortnumber
		END

		CLOSE icbom_cursor
		DEALLOCATE icbom_cursor
	end
end

go

--*****
IF not EXISTS (select * from sysobjects where name='Mycb_t_LocalVariable' and xtype='u')  --drop Table Mycb_t_LocalVariable
begin
	CREATE TABLE Mycb_t_LocalVariable(
	fbilltype int,
	fuserid int,
	fvalue varchar(50),
	fname varchar(50)
)

end

go


--排程明细表触发器--新增、更新
IF EXISTS (select * from sysobjects where name='My_Tri_ScheduleDetail'  and xtype='TR')  drop  TRIGGER My_Tri_ScheduleDetail
go

Create TRIGGER My_Tri_ScheduleDetail ON [dbo].my_t_scheduledetail
FOR Insert ,update

AS
BEGIN
	SET NOCOUNT ON
	declare @finterid int,@FMultiCheckLevel1 int,@fdate datetime,@fsourcetrantype int
	declare @fsrccommitfield_prevalue decimal(24,2),@fsrccommitfield_endvalue decimal(24,2)

	select top 1 @finterid=finterid,@fsourcetrantype=fsourcetrantype--,@FMultiCheckLevel1=isnull(FMultiCheckLevel1,0),
	--@fdate=replace(convert(varchar(10),FMultiCheckDate1,111),'/','-')
	from inserted

	

--	if @fsourcetrantype=81
--	begin
--		update src set @fsrccommitfield_prevalue=src.fqty,
--			 @fsrccommitfield_endvalue=@fsrccommitfield_prevalue-dest.fqty,
--			 src.FEntrySelfS0158=dest.fqty,
--			 src.FEntrySelfS0159=@fsrccommitfield_endvalue
--			 --src.fauxqty=@fsrccommitfield_endvalue/cast(t1.fcoefficient as float)
--		from seorderentry src 
--		inner join seorder srchead on src.finterid=srchead.finterid
--		inner join 
--		(
--			select u1.forderinterid,u1.forderentryid,u1.fitemid,sum(u1.fqty) as fqty
--			from  my_t_scheduledetail u1 
--			inner join t_icitem u2 on u1.fitemid=u2.fitemid
--			inner join inserted u3 on u3.forderinterid=u1.forderinterid and u3.forderentryid=u1.forderentryid and u1.fsourcetrantype=u3.fsourcetrantype
--			where u1.fsourcetrantype=81
--			group by u1.forderinterid,u1.forderentryid,u1.fitemid
--		) dest on dest.forderinterid = src.finterid and dest.forderentryid=src.fentryid and dest.fitemid = src.fitemid
--		inner join t_measureunit t1 on src.funitid=t1.fitemid
--	end
--
--	if @fsourcetrantype=87
--	begin
--		update src set @fsrccommitfield_prevalue=src.fqty,
--			 @fsrccommitfield_endvalue=@fsrccommitfield_prevalue-dest.fqty,
--			 src.FEntrySelfY0121=dest.fqty,
--			 src.FEntrySelfY0122=@fsrccommitfield_endvalue
--			 --src.fauxqty=@fsrccommitfield_endvalue/cast(t1.fcoefficient as float)
--		from pporderentry src 
--		inner join pporder srchead on src.finterid=srchead.finterid
--		inner join 
--		(
--			select u1.forderinterid,u1.forderentryid,u1.fitemid,sum(u1.fqty) as fqty
--			from  my_t_scheduledetail u1 
--			inner join t_icitem u2 on u1.fitemid=u2.fitemid
--			inner join inserted u3 on u3.forderinterid=u1.forderinterid and u3.forderentryid=u1.forderentryid and u1.fsourcetrantype=u3.fsourcetrantype
--			where u1.fsourcetrantype=87
--			group by u1.forderinterid,u1.forderentryid,u1.fitemid
--		) dest on dest.forderinterid = src.finterid and dest.forderentryid=src.fentryid and dest.fitemid = src.fitemid
--		inner join t_measureunit t1 on src.funitid=t1.fitemid
--	end

	set nocount off
end

go



--排程明细表触发器--删除
IF EXISTS (select * from sysobjects where name='My_Tri_ScheduleDetail_del'  and xtype='TR')  drop  TRIGGER My_Tri_ScheduleDetail_del
go

Create TRIGGER My_Tri_ScheduleDetail_del ON [dbo].my_t_scheduledetail
FOR delete

AS
BEGIN
	SET NOCOUNT ON
	declare @finterid int,@FMultiCheckLevel1 int,@fdate datetime,@fsourcetrantype int
	declare @fsrccommitfield_prevalue decimal(24,2),@fsrccommitfield_endvalue decimal(24,2)

	select top 1 @finterid=finterid,@fsourcetrantype=fsourcetrantype--,@FMultiCheckLevel1=isnull(FMultiCheckLevel1,0),
	--@fdate=replace(convert(varchar(10),FMultiCheckDate1,111),'/','-')
	from deleted

--	if @fsourcetrantype=81
--	begin
--		update src set @fsrccommitfield_prevalue=src.FEntrySelfS0158,
--			 @fsrccommitfield_endvalue=@fsrccommitfield_prevalue-dest.fqty,
--			 src.FEntrySelfS0158=@fsrccommitfield_endvalue,
--			 src.FEntrySelfS0159=src.fqty-@fsrccommitfield_endvalue  --这里要写，通过销售订单的触发器来回写有问题
--			 --src.fauxqty=@fsrccommitfield_endvalue/cast(t1.fcoefficient as float)
--		from seorderentry src 
--		inner join seorder srchead on src.finterid=srchead.finterid
--		inner join deleted dest on dest.forderinterid = src.finterid and dest.forderentryid=src.fentryid and dest.fitemid = src.fitemid
--		inner join t_measureunit t1 on src.funitid=t1.fitemid
--	end
--
--	if @fsourcetrantype=87
--	begin
--		update src set @fsrccommitfield_prevalue=src.FEntrySelfY0121,
--			 @fsrccommitfield_endvalue=@fsrccommitfield_prevalue-dest.fqty,
--			 src.FEntrySelfY0121=@fsrccommitfield_endvalue,
--			 src.FEntrySelfY0122=src.fqty-@fsrccommitfield_endvalue  --这里要写，通过销售订单的触发器来回写有问题
--			 --src.fauxqty=@fsrccommitfield_endvalue/cast(t1.fcoefficient as float)
--		from pporderentry src 
--		inner join pporder srchead on src.finterid=srchead.finterid
--		inner join deleted dest on dest.forderinterid = src.finterid and dest.forderentryid=src.fentryid and dest.fitemid = src.fitemid
--		inner join t_measureunit t1 on src.funitid=t1.fitemid
--	end

	set nocount off
end

go


/*
--产品入库表触发器--删除
IF EXISTS (select * from sysobjects where name='My_Tri_ICStockBill2_del'  and xtype='TR')  drop  TRIGGER My_Tri_ICStockBill2_del
go

Create TRIGGER My_Tri_ICStockBill2_del ON [dbo].ICStockBill
FOR delete

AS
BEGIN
	SET NOCOUNT ON
	declare @finterid int,@FMultiCheckLevel1 int,@fdate datetime,@fsourcetrantype int
	declare @fsrccommitfield_prevalue decimal(24,2),@fsrccommitfield_endvalue decimal(24,2)

	select top 1 @finterid=finterid,@fsourcetrantype=fsourcetrantype--,@FMultiCheckLevel1=isnull(FMultiCheckLevel1,0),
	--@fdate=replace(convert(varchar(10),FMultiCheckDate1,111),'/','-')
	from deleted

	if @fsourcetrantype=87
	begin
		update src set @fsrccommitfield_prevalue=src.FEntrySelfY0121,
			 @fsrccommitfield_endvalue=@fsrccommitfield_prevalue-dest.fqty,
			 src.FEntrySelfY0121=@fsrccommitfield_endvalue,
			 src.FEntrySelfY0122=src.fqty-@fsrccommitfield_endvalue  --这里要写，通过销售订单的触发器来回写有问题
			 --src.fauxqty=@fsrccommitfield_endvalue/cast(t1.fcoefficient as float)
		from pporderentry src 
		inner join pporder srchead on src.finterid=srchead.finterid
		inner join icmo t2 on src.finterid=t2.fpporderinterid and src.fentryid=t2.fsourceentryid
		inner join icstockbillentry t3 on t3.ficmointerid=t
		inner join deleted dest on dest.forderinterid = src.finterid and dest.forderentryid=src.fentryid and dest.fitemid = src.fitemid
		inner join t_measureunit t1 on src.funitid=t1.fitemid
	end

	set nocount off
end

*/

go

--*****
IF EXISTS (select * from sysobjects where name='v_MyICMO' and xtype='v')  drop  view v_MyICMO

go

create view v_MyICMO 
as

select 85 单据类型,t0.fbillno 单据编号,t0.finterid 单据内码,
t4.fname 制单人,t0.fcheckdate 制单日期,t8.fname 生产车间,
isnull(t5.fname,'') 确认人,isnull(t0.fconfirmdate,Null) 确认日期,
isnull(t6.fname,'') 下达人,isnull(t0.fcommitdate,Null) 下达日期,t0.fplancommitdate 计划完工日期,
(case when t0.fstatus=0 then '计划' when t0.fstatus=1 then '下达' when t0.fstatus=5 then '确认' when t0.fstatus=3 then '结案' end) 状态,
isnull(t2.fshortnumber,'') 客户编码,isnull(t1.fbillno,'') 订单编号,t1.fdate 下单日期,isnull(t12.fentryid,0) 分录号,isnull(t12.fentryid,0) 订单分录号,isnull(t2.fname,'') 客户,
isnull(t7.fshortnumber,'') 短代码,isnull(t7.fnumber,'') 产品编码,isnull(t7.FName,'') 产品名称, isnull(t7.fmodel,'') 规格型号,isnull(t7.fitemid,0) 产品内码,
t12.funitid 单位内码,t3.fname 单位,cast(isnull(t12.fqty,0) as decimal(24,2)) 订单数,cast(t0.fqty as decimal(24,2)) 计划数,cast(t0.fqty as decimal(24,2)) 任务数,
cast(t0.fqtyfinish as decimal(24,2)) 实作数,cast(t0.fqtyfinish as decimal(24,2)) 已汇报数,cast(t0.fqty-t0.fqtyfinish as decimal(24,2)) 未汇报数,cast(t0.fcommitqty as decimal(24,2)) 关联数,
isnull(cast((case when t7.ferpclsid=1 then t12.fqty else 0 end) as decimal(24,2)),0) 外购数,
isnull(t1.FHeadSelfS0148,'') 订单交期,isnull(t1.fheadselfs0144,'') 客户订单号,
--isnull(t1.fheadselfs0142,'') 包材交期,
isnull(t1.fheadselfs0143,'') 工厂备注,
isnull(t1.fheadselfs0143,'') 源采购订单号,isnull(t1.fheadselfs0144,'') 源销售订单号,
isnull(t1.fheadselfs0146,'') 整单包装说明,isnull(t12.FEntrySelfS0164,'') 产品包装说明,isnull(t12.fnote,'') 订单备注,
t9.fname 仓库,t9.fitemid 仓库内码
from icmo t0 
left join SeorderEntry t12 on t0.forderinterid=t12.finterid and t0.fsourceentryid=t12.fentryid 
left join seorder t1 on t1.finterid=t12.finterid  
inner join t_User t4 on t0.fbillerid=t4.fuserid and t4.fuserid<>0  
left join t_User t5 on t0.fconfirmerid=t5.fuserid and t5.fuserid<>0  
left join t_User t6 on t0.fconveyerid=t6.fuserid and t6.fuserid<>0  
inner join t_icitem t7 on t0.fitemid=t7.fitemid 
left join t_Organization t2 on t1.fcustid=t2.fitemid
inner join t_measureunit t3 on t3.fitemid=t7.funitid
left join t_department t8 on t8.fitemid=t0.fworkshop
inner join t_stock t9 on t9.fitemid=t7.fdefaultloc

go



IF EXISTS (select * from sysobjects where name='v_MyICMO_81' and xtype='v')  drop  view v_MyICMO_81

go

create view v_MyICMO_81 
as

select 81 单据类型,t0.fbillno 单据编号,t0.finterid 单据内码,
t4.fname 制单人,t0.fcheckdate 制单日期,t8.fname 生产车间,
isnull(t5.fname,'') 确认人,isnull(t0.fconfirmdate,Null) 确认日期,
isnull(t6.fname,'') 下达人,isnull(t0.fcommitdate,Null) 下达日期,t0.fplancommitdate 计划开工日期,
(case when t0.fstatus=0 then '计划' when t0.fstatus=1 then '下达' when t0.fstatus=5 then '确认' when t0.fstatus=3 then '结案' end) 状态,
isnull(t2.fshortnumber,'') 客户编码,t1.fbillno 订单编号,t1.fdate 下单日期,t12.fentryid 分录号,isnull(t2.fname,'') 客户,
isnull(t7.fshortnumber,'') 短代码,isnull(t7.fnumber,'') 产品编码,isnull(t7.FName,'') 产品名称, isnull(t7.fmodel,'') 规格型号,isnull(t7.fitemid,0) 产品内码,
t12.funitid 单位内码,t3.fname 单位,cast(t12.fqty as decimal(24,2)) 订单数,cast(t0.fqty as decimal(24,2)) 计划数,
cast(t0.fqtyfinish as decimal(24,2)) 实作数,cast(t0.fcommitqty as decimal(24,2)) 关联数,cast((case when t7.ferpclsid=1 then t12.fqty else 0 end) as decimal(24,2)) 外购数,
t1.FHeadSelfS0148 工厂交期,t1.fheadselfs0142 包材交期,t1.fheadselfs0143 工厂备注,t1.fheadselfs0144 客户订单号,
t1.fheadselfs0146 整单包装说明,t12.FEntrySelfS0164 产品包装说明,t12.fnote 订单备注,t9.fname 仓库,t9.fitemid 仓库内码,t12.fentryid 订单分录号
from icmo t0 
inner join SeorderEntry t12 on t0.forderinterid=t12.finterid and t0.fsourceentryid=t12.fentryid and t0.fitemid=t12.fitemid
inner join seorder t1 on t1.finterid=t12.finterid  
inner join t_User t4 on t0.fbillerid=t4.fuserid and t4.fuserid<>0  
left join t_User t5 on t0.fconfirmerid=t5.fuserid and t5.fuserid<>0  
left join t_User t6 on t0.fconveyerid=t6.fuserid and t6.fuserid<>0  
inner join t_icitem t7 on t12.fitemid=t7.fitemid 
left join t_Organization t2 on t1.fcustid=t2.fitemid
inner join t_measureunit t3 on t3.fitemid=t12.funitid
inner join t_department t8 on t8.fitemid=t0.fworkshop
inner join t_stock t9 on t9.fitemid=t7.fdefaultloc

go



IF EXISTS (select * from sysobjects where name='v_MyICMO_87' and xtype='v')  drop  view v_MyICMO_87

go

create view v_MyICMO_87 
as

select 87 单据类型,t0.fbillno 单据编号,t0.finterid 单据内码,
t4.fname 制单人,t0.fcheckdate 制单日期,t8.fname 生产车间,
isnull(t5.fname,'') 确认人,isnull(t0.fconfirmdate,Null) 确认日期,
isnull(t6.fname,'') 下达人,isnull(t0.fcommitdate,Null) 下达日期,
t0.fplancommitdate 计划开工日期,
(case when t0.fstatus=0 then '计划' when t0.fstatus in (1,2) then '下达' when t0.fstatus=5 then '确认' when t0.fstatus=3 then '结案' end) 状态,
isnull(t2.fshortnumber,'') 客户编码,t1.fbillno 订单编号,t1.fdate 下单日期,t12.fentryid 分录号,isnull(t2.fname,'') 客户,
isnull(t7.fshortnumber,'') 短代码,isnull(t7.fnumber,'') 产品编码,isnull(t7.FName,'') 产品名称, isnull(t7.fmodel,'') 规格型号,isnull(t7.fitemid,0) 产品内码,
t12.funitid 单位内码,t3.fname 单位,cast(t12.fqty as decimal(24,2)) 订单数,cast(t0.fqty as decimal(24,2)) 计划数,
t12.fnote 订单备注
from icmo t0 
inner join pporderentry t12 on t0.FPPOrderInterID=t12.finterid and t0.fsourceentryid=t12.fentryid and t0.fitemid=t12.fitemid
inner join pporder t1 on t1.finterid=t12.finterid  
inner join t_User t4 on t0.fbillerid=t4.fuserid and t4.fuserid<>0  
left join t_User t5 on t0.fconfirmerid=t5.fuserid and t5.fuserid<>0  
left join t_User t6 on t0.fconveyerid=t6.fuserid and t6.fuserid<>0  
inner join t_icitem t7 on t12.fitemid=t7.fitemid 
left join t_Organization t2 on t12.fcustid=t2.fitemid
inner join t_measureunit t3 on t3.fitemid=t12.funitid
inner join t_department t8 on t8.fitemid=t0.fworkshop

go
--
----18105	装配车间计划仓 18106	包装车间计划仓  18113	装配车间仓  18114	包装车间仓
--IF EXISTS (select * from sysobjects where name='v_MyPPBom_81' and xtype='v')  drop  view v_MyPPBom_81
--
--go
--
--create view v_MyPPBom_81 
--as
--
--select 81 单据类型,t0.fbillno 任务单号,t0.finterid 任务单内码,t9.fentryid 投料单分录号,t8.fitemid 生产车间内码,t8.fname 生产车间,t0.fplancommitdate 计划开工日期,
--(case when t0.fstatus=0 then '计划' when t0.fstatus in (1,2) then '下达' when t0.fstatus=5 then '确认' when t0.fstatus=3 then '结案' end) 状态,
--t1.fbillno 订单编号,t1.fdate 下单日期,t12.fentryid 分录号,isnull(t2.fname,'') 客户,
--isnull(t7.fshortnumber,'') 产品短代码,isnull(t7.fnumber,'') 产品编码,isnull(t7.FName,'') 产品名称, isnull(t7.fmodel,'') 产品规格型号,isnull(t7.fitemid,0) 产品内码,
--cast(t12.fqty as decimal(24,2)) 订单数,t1.FHeadSelfS0148 工厂交期,t1.fheadselfs0142 包材交期,t1.fheadselfs0143 工厂备注,t1.fheadselfs0144 客户订单号,
--t1.fheadselfs0146 整单包装说明,t12.FEntrySelfS0164 产品包装说明,t12.fnote 订单备注,t13.fname 仓管员,t15.fitemid 仓库内码,t15.fname 仓库,t14.fname 物料类别,
--t0.fcostobjid 成本对象内码,isnull(t11.fshortnumber,'') 物料短代码,isnull(t11.fnumber,'') 物料编码,isnull(t11.FName,'') 物料名称, isnull(t11.fmodel,'') 物料规格型号,isnull(t11.fitemid,0) 物料内码,
--t3.fitemid 单位内码,t3.fname 单位,cast(t9.fqtymust as decimal(24,2)) 应发数,
--cast(t9.fqty as decimal(24,2)) 已发数,cast((t9.fqtymust-t9.fqty) as decimal(24,2)) 未发数,
--cast(t9.fstockqty as decimal(24,2)) 已发数二,cast((t9.fqtymust-t9.fstockqty) as decimal(24,2)) 未发数二,
--cast(isnull(t16.fqty,0) as decimal(24,2)) 即时库存,
--cast(t9.fqtymust as decimal(24,2)) 应调拨数,cast(t9.FTransLateQty as decimal(24,2)) 已调拨数,cast((t9.fqtymust-t9.FTransLateQty) as decimal(24,2)) 未调拨数,
--t17.fname 倒冲,(case when t11.ferpclsid=1 then '外购' when t11.ferpclsid=2 then '自制'  end) 物料属性,
--(case when t17.fname='是' and left(t8.fnumber,6)= '08.11.' and left(t8.fnumber,8)= '08.11.1.' then  29025	--专利装配车间仓
--      when t17.fname='是' and left(t8.fnumber,6)= '08.11.' and left(t8.fnumber,8)<>'08.11.1.' then  29026	--专利包装车间仓
--      when t17.fname='是' and left(t8.fnumber,6)<>'08.11.' and left(t8.fnumber,8)= '08.10.1.' then  18113	--装配车间仓
--      when t17.fname='是' and left(t8.fnumber,6)<>'08.11.' and left(t8.fnumber,8)<>'08.10.1.' then  18114	--包装车间仓
--      when t17.fname='否' then t11.fdefaultloc end) 调出仓库内码--非倒冲外购件取基础资料属性的默认仓库
--from icmo t0 
--inner join SeorderEntry t12 on t0.forderinterid=t12.finterid and t0.fsourceentryid=t12.fentryid and t0.fitemid=t12.fitemid
--inner join seorder t1 on t1.finterid=t12.finterid  
--inner join t_User t4 on t0.fbillerid=t4.fuserid and t4.fuserid<>0  
--left join t_User t5 on t0.fconfirmerid=t5.fuserid and t5.fuserid<>0  
--left join t_User t6 on t0.fconveyerid=t6.fuserid and t6.fuserid<>0  
--inner join t_icitem t7 on t12.fitemid=t7.fitemid 
--left join t_Organization t2 on t1.fcustid=t2.fitemid
--inner join t_department t8 on t8.fitemid=t0.fworkshop
--inner join ppbomentry t9 on t9.ficmointerid=t0.finterid
--inner join ppbom t10 on t10.finterid=t9.finterid
--inner join t_icitem t11 on t11.fitemid=t9.fitemid
--inner join t_measureunit t3 on t3.fitemid=t11.funitid
--inner join t_SubMessage t13 on t13.finterid=t11.f_114 and t13.ftypeid=10003
--inner join t_SubMessage t14 on t14.finterid=t11.ftypeid and t14.ftypeid=504
--inner join t_stock t15 on t15.fitemid=t9.fstockid
--left join (select fitemid,fstockid,sum(fqty) fqty from icinventory group by fitemid,fstockid) t16 on t16.fitemid=t9.fitemid and t16.fstockid=t9.fstockid
--left join t_SubMessage t17 on t17.finterid=t11.f_115 and t17.ftypeid=10002
--
--
--go

--
--IF EXISTS (select * from sysobjects where name='v_MyPPBom_87' and xtype='v')  drop  view v_MyPPBom_87
--
--go
--
--create view v_MyPPBom_87 
--as
--
--select 87 单据类型,t0.fbillno 任务单号,t0.finterid 任务单内码,t9.fentryid 投料单分录号,t8.fitemid 生产车间内码,t8.fname 生产车间,t0.fplancommitdate 计划开工日期,
--(case when t0.fstatus=0 then '计划' when t0.fstatus=1 then '下达' when t0.fstatus=5 then '确认' when t0.fstatus=3 then '结案' end) 状态,
--t1.fbillno 订单编号,t1.fdate 下单日期,t12.fentryid 分录号,isnull(t2.fname,'') 客户,
--isnull(t7.fshortnumber,'') 产品短代码,isnull(t7.fnumber,'') 产品编码,isnull(t7.FName,'') 产品名称, isnull(t7.fmodel,'') 产品规格型号,isnull(t7.fitemid,0) 产品内码,
--cast(t12.fqty as decimal(24,2)) 订单数,t12.fnote 订单备注,t13.fname 仓管员,t15.fitemid 仓库内码,t15.fname 仓库,t14.fname 物料类别,
--t0.fcostobjid 成本对象内码,isnull(t11.fshortnumber,'') 物料短代码,isnull(t11.fnumber,'') 物料编码,isnull(t11.FName,'') 物料名称, isnull(t11.fmodel,'') 物料规格型号,isnull(t11.fitemid,0) 物料内码,
--t3.fitemid 单位内码,t3.fname 单位,cast(t9.fqtymust as decimal(24,2)) 应发数,
--cast(t9.fqty as decimal(24,2)) 已发数,cast((t9.fqtymust-t9.fqty) as decimal(24,2)) 未发数,
--cast(t9.fstockqty as decimal(24,2)) 已发数二,cast((t9.fqtymust-t9.fstockqty) as decimal(24,2)) 未发数二,
--cast(isnull(t16.fqty,0) as decimal(24,2)) 即时库存,
--cast(t9.fqtymust as decimal(24,2)) 应调拨数,cast(t9.FTransLateQty as decimal(24,2)) 已调拨数,cast((t9.fqtymust-t9.FTransLateQty) as decimal(24,2)) 未调拨数,
--t17.fname 倒冲,(case when t11.ferpclsid=1 then '外购' when t11.ferpclsid=2 then '自制'  end) 物料属性,
--(case when t17.fname='是' and left(t8.fnumber,6)= '08.11.' and left(t8.fnumber,8)= '08.11.1.' then  29025	--专利装配车间仓
--      when t17.fname='是' and left(t8.fnumber,6)= '08.11.' and left(t8.fnumber,8)<>'08.11.1.' then  29026	--专利包装车间仓
--      when t17.fname='是' and left(t8.fnumber,6)<>'08.11.' and left(t8.fnumber,8)= '08.10.1.' then  18113	--装配车间仓
--      when t17.fname='是' and left(t8.fnumber,6)<>'08.11.' and left(t8.fnumber,8)<>'08.10.1.' then  18114	--包装车间仓
--      when t17.fname='否' then t11.fdefaultloc end) 调出仓库内码--非倒冲外购件取基础资料属性的默认仓库
--from icmo t0 
--inner join pporderentry t12 on t0.FPPOrderInterID=t12.finterid and t0.fsourceentryid=t12.fentryid and t0.fitemid=t12.fitemid
--inner join pporder t1 on t1.finterid=t12.finterid  
--inner join t_User t4 on t0.fbillerid=t4.fuserid and t4.fuserid<>0  
--left join t_User t5 on t0.fconfirmerid=t5.fuserid and t5.fuserid<>0  
--left join t_User t6 on t0.fconveyerid=t6.fuserid and t6.fuserid<>0  
--inner join t_icitem t7 on t12.fitemid=t7.fitemid 
--left join t_Organization t2 on t12.fcustid=t2.fitemid
--inner join t_department t8 on t8.fitemid=t0.fworkshop
--inner join ppbomentry t9 on t9.ficmointerid=t0.finterid
--inner join ppbom t10 on t10.finterid=t9.finterid
--inner join t_icitem t11 on t11.fitemid=t9.fitemid
--inner join t_measureunit t3 on t3.fitemid=t11.funitid
--inner join t_SubMessage t13 on t13.finterid=t11.f_114 and t13.ftypeid=10003
--inner join t_SubMessage t14 on t14.finterid=t11.ftypeid and t14.ftypeid=504
--inner join t_stock t15 on t15.fitemid=t9.fstockid
--left join (select fitemid,fstockid,sum(fqty) fqty from icinventory group by fitemid,fstockid) t16 on t16.fitemid=t9.fitemid and t16.fstockid=t9.fstockid
--left join t_SubMessage t17 on t17.finterid=t11.f_115 and t17.ftypeid=10002
--
--go

--成品生产投料单-打印
--My_P_PPBomPackRpt 'XW1304059'
IF EXISTS (select * from sysobjects where name='My_P_PPBomPackRpt' and xtype='p')  drop  procedure My_P_PPBomPackRpt

go

create procedure My_P_PPBomPackRpt(@fbillno varchar(50))
as

set nocount on

--declare @fbillno varchar(50) set @fbillno='xw1302003'

select identity(int,1,1) as findex,*
into #t1
from
(
	select t0.fbillno 任务单号,t0.finterid 任务单内码,0 投料单内码,0 投料单分录号,getdate() 打印时间,
	isnull(t8.fitemid,0) 生产车间内码,isnull(t8.fname,'') 生产车间,t0.fplancommitdate 计划开工日期,t0.fplanfinishdate 计划完工日期,
	(case when t0.fstatus=0 then '计划' when t0.fstatus in (1,2) then '下达' when t0.fstatus=5 then '确认' when t0.fstatus=3 then '结案' end) 状态,
	isnull(t1.fbillno,'') 订单编号,t1.fdate 下单日期,t12.fentryid 订单分录号,isnull(t2.fname,'') 客户,
	isnull(t7.fshortnumber,'') 物料短代码,isnull(t7.fnumber,'') 物料编码,isnull(t7.FName,'') 物料名称, isnull(t7.fmodel,'')+'///'+isnull(t7.F_105,'') 物料规格型号,isnull(t7.fitemid,0) 物料内码,
	--isnull(t11.fshortnumber,'') 物料短代码,isnull(t11.fnumber,'') 物料编码,isnull(t11.FName,'') 物料名称, isnull(t11.fmodel,'') 物料规格型号,isnull(t11.fitemid,0) 物料内码,
	cast(t12.fqty as decimal(24,2)) 订单数,--t1.FHeadSelfS0148 工厂交期,t1.fheadselfs0142 包材交期,t1.fheadselfs0143 工厂备注,
	isnull(t1.fheadselfs0143,'') 源采购订单号,isnull(t1.fheadselfs0144,'') 源销售订单号,1 单位用量,0 损耗率,t0.fqty 任务数,t0.fcommitqty 汇报数,
	t1.FExplanation 摘要,t1.fheadselfs0141 整单包装说明,t1.fheadselfs0142 其他说明,--t12.FEntrySelfS0164 产品包装说明,
	isnull(t12.fnote,'') 订单备注,'' 仓管员,0 仓库内码,'' 仓库,'' 物料类别,t0.fcostobjid 成本对象内码,
	t3.fitemid 单位内码,t3.fname 单位,t0.fqty 应发数,t0.fcommitqty 已选数,cast((t0.fqty-t0.fcommitqty) as decimal(24,2)) 未选数,
	t0.fstockqty 已发数,cast((t0.fqty-t0.fstockqty) as decimal(24,2)) 未发数,0 即时库存,
	'否' 倒冲,(case when t7.ferpclsid=1 then '外购' when t7.ferpclsid=2 then '自制'  end) 物料属性,0 调出仓库内码,'' 备注
	from icmo t0 
	inner join SeorderEntry t12 on t0.forderinterid=t12.finterid and t0.fsourceentryid=t12.fentryid --and t0.fitemid=t12.fitemid
	inner join seorder t1 on t1.finterid=t12.finterid  
	inner join t_User t4 on t0.fbillerid=t4.fuserid and t4.fuserid<>0  
	left join t_User t5 on t0.fconfirmerid=t5.fuserid and t5.fuserid<>0  
	left join t_User t6 on t0.fconveyerid=t6.fuserid and t6.fuserid<>0  
	inner join t_icitem t7 on t0.fitemid=t7.fitemid 
	left join t_Organization t2 on t1.fcustid=t2.fitemid
	left join t_department t8 on t8.fitemid=t0.fworkshop
	inner join t_measureunit t3 on t3.fitemid=t7.funitid
	where t1.fbillno=@fbillno
	union all
	select t0.fbillno 任务单号,t0.finterid 任务单内码,0 投料单内码,-1 投料单分录号,getdate() 打印时间,
	isnull(t8.fitemid,0) 生产车间内码,isnull(t8.fname,'') 生产车间,t0.fplancommitdate 计划开工日期,t0.fplanfinishdate 计划完工日期,
	(case when t0.fstatus=0 then '计划' when t0.fstatus in (1,2) then '下达' when t0.fstatus=5 then '确认' when t0.fstatus=3 then '结案' end) 状态,
	isnull(t1.fbillno,'') 订单编号,t1.fdate 下单日期,t12.fentryid 订单分录号,isnull(t2.fname,'') 客户,
	'' 物料短代码,'' 物料编码,'' 物料名称, '' 物料规格型号,0 物料内码,
	--isnull(t11.fshortnumber,'') 物料短代码,isnull(t11.fnumber,'') 物料编码,isnull(t11.FName,'') 物料名称, isnull(t11.fmodel,'') 物料规格型号,isnull(t11.fitemid,0) 物料内码,
	0 订单数,--t1.FHeadSelfS0148 工厂交期,t1.fheadselfs0142 包材交期,t1.fheadselfs0143 工厂备注,
	isnull(t1.fheadselfs0143,'') 源采购订单号,isnull(t1.fheadselfs0144,'') 源销售订单号,0 单位用量,0 损耗率,t0.fqty 任务数,t0.fcommitqty 汇报数,
	t1.FExplanation 摘要,t1.fheadselfs0141 整单包装说明,t1.fheadselfs0142 其他说明,--t12.FEntrySelfS0164 产品包装说明,
	'' 订单备注,'' 仓管员,0 仓库内码,'' 仓库,'' 物料类别,0 成本对象内码,
	0 单位内码,'' 单位,0 应发数,0 已选数,0 未选数,
	0 已发数,0 未发数,0 即时库存,
	'否' 倒冲,'' 物料属性,0 调出仓库内码,'' 备注
	from icmo t0 
	inner join SeorderEntry t12 on t0.forderinterid=t12.finterid and t0.fsourceentryid=t12.fentryid --and t0.fitemid=t12.fitemid
	inner join seorder t1 on t1.finterid=t12.finterid  
	inner join t_User t4 on t0.fbillerid=t4.fuserid and t4.fuserid<>0  
	left join t_User t5 on t0.fconfirmerid=t5.fuserid and t5.fuserid<>0  
	left join t_User t6 on t0.fconveyerid=t6.fuserid and t6.fuserid<>0  
	inner join t_icitem t7 on t0.fitemid=t7.fitemid 
	left join t_Organization t2 on t1.fcustid=t2.fitemid
	left join t_department t8 on t8.fitemid=t0.fworkshop
	inner join t_measureunit t3 on t3.fitemid=t7.funitid
	where t1.fbillno=@fbillno
	union all
	select t0.fbillno 任务单号,t0.finterid 任务单内码,t10.finterid 投料单内码,t9.fentryid 投料单分录号,getdate() 打印时间,
	isnull(t8.fitemid,0) 生产车间内码,isnull(t8.fname,'') 生产车间,t0.fplancommitdate 计划开工日期,t0.fplanfinishdate 计划完工日期,
	(case when t0.fstatus=0 then '计划' when t0.fstatus in (1,2) then '下达' when t0.fstatus=5 then '确认' when t0.fstatus=3 then '结案' end) 状态,
	isnull(t1.fbillno,'') 订单编号,t1.fdate 下单日期,t12.fentryid 订单分录号,isnull(t2.fname,'') 客户,
	--isnull(t7.fshortnumber,'') 产品短代码,isnull(t7.fnumber,'') 产品编码,isnull(t7.FName,'') 产品名称, isnull(t7.fmodel,'') 产品规格型号,isnull(t7.fitemid,0) 产品内码,
	isnull(t11.fshortnumber,'') 物料短代码,isnull(t11.fnumber,'') 物料编码,isnull(t11.FName,'') 物料名称, isnull(t11.fmodel,'')+'///'+isnull(t11.F_105,'') 物料规格型号,isnull(t11.fitemid,0) 物料内码,
	cast(t12.fqty as decimal(24,2)) 订单数,--t1.FHeadSelfS0148 工厂交期,t1.fheadselfs0142 包材交期,t1.fheadselfs0143 工厂备注,
	isnull(t1.fheadselfs0143,'') 源采购订单号,isnull(t1.fheadselfs0144,'') 源销售订单号,t9.fauxqtyscrap 单位用量,t9.fscrap 损耗率,t0.fqty 任务数,t0.fcommitqty 汇报数,
	t1.FExplanation 摘要,t1.fheadselfs0141 整单包装说明,t1.fheadselfs0142 其他说明,--t12.FEntrySelfS0164 产品包装说明,
	isnull(t12.fnote,'') 订单备注,isnull(t13.fname,'') 仓管员,t15.fitemid 仓库内码,t15.fname 仓库,isnull(t14.fname,'') 物料类别,t0.fcostobjid 成本对象内码,
	t3.fitemid 单位内码,t3.fname 单位,cast(t9.fqtymust as decimal(24,2)) 应发数,
	cast(t9.fqty as decimal(24,2)) 已选数,cast((t9.fqtymust-t9.fqty) as decimal(24,2)) 未选数,
	cast(t9.fstockqty as decimal(24,2)) 已发数,cast((t9.fqtymust-t9.fstockqty) as decimal(24,2)) 未发数,
	cast(isnull(t16.fqty,0) as decimal(24,2)) 即时库存,
	--cast(t9.fqtymust as decimal(24,2)) 应调拨数,cast(t9.FTransLateQty as decimal(24,2)) 已调拨数,cast((t9.fqtymust-t9.FTransLateQty) as decimal(24,2)) 未调拨数,
	isnull(t17.fname,'否') 倒冲,(case when t11.ferpclsid=1 then '外购' when t11.ferpclsid=2 then '自制'  end) 物料属性,
	(case when isnull(t17.fname,'否')='是' and t8.fitemid in (175,171817) then 16479	--装配车间仓
		  when isnull(t17.fname,'否')='是' and t8.fitemid=176 then 16480 --包装车间仓
		  when isnull(t17.fname,'否')='否' then t11.fdefaultloc end) 调出仓库内码,--非倒冲外购件取基础资料属性的默认仓库
	isnull(t9.fnote,'') 备注
	from icmo t0 
	inner join SeorderEntry t12 on t0.forderinterid=t12.finterid and t0.fsourceentryid=t12.fentryid --and t0.fitemid=t12.fitemid
	inner join seorder t1 on t1.finterid=t12.finterid  
	inner join t_User t4 on t0.fbillerid=t4.fuserid and t4.fuserid<>0  
	left join t_User t5 on t0.fconfirmerid=t5.fuserid and t5.fuserid<>0  
	left join t_User t6 on t0.fconveyerid=t6.fuserid and t6.fuserid<>0  
	inner join t_icitem t7 on t0.fitemid=t7.fitemid 
	left join t_Organization t2 on t1.fcustid=t2.fitemid
	left join t_department t8 on t8.fitemid=t0.fworkshop
	inner join ppbomentry t9 on t9.ficmointerid=t0.finterid
	inner join ppbom t10 on t10.finterid=t9.finterid
	inner join t_icitem t11 on t11.fitemid=t9.fitemid
	inner join t_measureunit t3 on t3.fitemid=t11.funitid
	left join t_SubMessage t13 on t13.finterid=t11.f_114 and t13.ftypeid=10003
	left join t_SubMessage t14 on t14.finterid=t11.ftypeid and t14.ftypeid=504
	inner join t_stock t15 on t15.fitemid=t9.fstockid
	left join 
	(	
		select fitemid,fstockid,sum(fqty) fqty 
		from 
		(
			select fitemid,fstockid,fqty from icinventory 
			union all 
			select t1.fitemid,t1.fstockid,t1.fqty from poinventory t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid --where t1.fitemid<>20355 and t2.fnumber like '6.%'  select * from t_stock where fitemid=20355
		) t1
		group by fitemid,fstockid
	) t16 on t16.fitemid=t9.fitemid and t16.fstockid=t9.fstockid
	left join t_SubMessage t17 on t17.finterid=t11.f_115 and t17.ftypeid=10002
	where t1.fbillno=@fbillno
) t1 order by 订单编号,订单分录号,投料单分录号,物料编码

--delete from #t1 where findex=1

update #t1 set 投料单分录号=订单分录号 where 投料单分录号=-1

insert into #t1(任务单号,任务单内码,投料单内码,投料单分录号,打印时间,    生产车间内码,生产车间,计划开工日期,计划完工日期,状态,订单编号,下单日期,     订单分录号,客户,物料短代码,物料编码,物料名称,物料规格型号,物料内码,订单数,源采购订单号,源销售订单号,单位用量,损耗率,任务数,汇报数,摘要,整单包装说明,其他说明,订单备注,仓管员,仓库内码,仓库,物料类别,成本对象内码,单位内码,单位,应发数,已选数,未选数,已发数,未发数,即时库存,倒冲,物料属性,调出仓库内码,备注) 
values (        '',      0,         0,         0,           '1900-01-01',0,           '',      '1900-01-01','1900-01-01','',  '',      '1900-01-01', 0,         '',  '',        '小计',  '',      '',          0,       0,     '',          '',          0,       0,     0,     0,     '',  '',          '',      '',      '',    0,       '',  '',      0,           0,       '',  0,     0,     0,     0,     0,     0,       '',  '',      0,           '')

select isnull(投料单分录号,0) 投料单分录号,isnull(物料编码,'') 物料编码,isnull(物料名称,'') 物料名称,
isnull(物料规格型号,'') 物料规格型号,isnull(单位,'') 单位,isnull(单位用量,0) 单位用量,isnull(应发数,0) 应发数,
isnull(源销售订单号,'') 源销售订单号,isnull(源采购订单号,'') 源采购订单号,getdate() 打印时间,
isnull(计划完工日期,'1900-01-01') 计划完工日期,isnull(订单编号,'') 订单编号,isnull(备注,'') 备注
 from #t1 order by findex

--
--select identity(int,1,1) as findex,*
--into #t1
--from
--(
--	select t6.finterid forderinterid,t6.fentryid forderentryid,isnull(t7.FHEADSELFS0145,'') fpacknote,
--	t6.fnote+'///'+isnull(t1.fnote,'') fnote,
--	t3.fshortnumber fnumber,t3.fname,t3.fmodel,t2.FIndex fentryid,
--	t4.fshortnumber fchilditemnumber,t4.fname fchilditemname,t4.fmodel fchilditemmodel,t5.fname funit,t6.fqty forderqty,t2.fqty,t6.fqty*t2.fqty fqtymust
--	from seorderentry t6 
--	inner join seorder t7 on t6.finterid=t7.finterid
--	inner join t_BOSPackSub t1 on t1.fbillno=t6.fentryselfs0159
--	inner join t_BOSPackSubEntry t2 on t1.fid=t2.fid
--	inner join t_icitem t4 on t2.fitemid=t4.fitemid
--	inner join t_measureunit t5 on t5.fitemid=t4.funitid
--	inner join t_icitem t3 on t6.fitemid=t3.fitemid
--	WHERE t7.fbillno =@fbillno
--) t1
--order by fnumber,fentryid
----select * from #t1
--update t1 set fpacknote='',fnumber='ZZZZZZ',fname='',fmodel=''
--from #t1 t1
--inner join (select fnumber,max(findex) findex from #t1 group by fnumber) t2 on t1.fnumber=t2.fnumber
--where t1.findex=t2.findex
--
--update t1 set fnote='',fpacknote='',fnumber='',fname='',fmodel=''
--from #t1 t1
--inner join (select fnumber,min(findex) findex from #t1 group by fnumber) t2 on t1.fnumber=t2.fnumber
--where t1.findex<>t2.findex and t1.fnumber not like 'ZZZZZZ'
--
--select fpacknote 包装说明,fnumber 产品编码,fname 产品名称,fmodel 产品规格,
--fentryid 序号,fchilditemnumber 物料编码,fchilditemname 物料名称,fchilditemmodel 物料规格,funit 单位,
--forderqty 订单数,fqty 单位用量,fqtymust 应发数,fnote 备注
--FROM #t1
--

drop table #t1

set nocount off

go



--成品生产配料清单-打印
--My_P_PPBomListRpt 'XW1412147'
IF EXISTS (select * from sysobjects where name='My_P_PPBomListRpt' and xtype='p')  drop  procedure My_P_PPBomListRpt

go

create procedure My_P_PPBomListRpt(@fbillno varchar(50))
as

set nocount on

--declare @fbillno varchar(50) set @fbillno='xw1302003'

select identity(int,1,1) as findex,*
into #t1
from
(
	select cast(t12.finterid as varchar)+cast(t12.fentryid as varchar) 任务单号,
	cast(t12.finterid as varchar)+cast(t12.fentryid as varchar) 任务单内码,0 投料单内码,0 投料单分录号,getdate() 打印时间,
	isnull(t8.fitemid,0) 生产车间内码,isnull(t8.fname,'') 生产车间,t12.fdate 计划开工日期,t12.fdate 计划完工日期,
	(case when t0.fstatus=0 then '未审核' when t0.fstatus in (1) then '审核' end) 状态,
	isnull(t1.fbillno,'') 订单编号,t1.fdate 下单日期,t12.fentryid 订单分录号,isnull(t2.fname,'') 客户,
	isnull(t7.fshortnumber,'') 物料短代码,isnull(t7.fnumber,'') 物料编码,'['+isnull(t13.fname,'')+']'+isnull(t7.FName,'') 物料名称, isnull(t7.fmodel,'')+'///'+isnull(t7.F_105,'') 物料规格型号,isnull(t7.fitemid,0) 物料内码,
	--isnull(t11.fshortnumber,'') 物料短代码,isnull(t11.fnumber,'') 物料编码,isnull(t11.FName,'') 物料名称, isnull(t11.fmodel,'') 物料规格型号,isnull(t11.fitemid,0) 物料内码,
	cast(t12.fqty as decimal(24,2)) 订单数,--t1.FHeadSelfS0148 工厂交期,t1.fheadselfs0142 包材交期,t1.fheadselfs0143 工厂备注,
	isnull(t1.fheadselfs0143,'') 源采购订单号,isnull(t1.fheadselfs0144,'') 源销售订单号,1 单位用量,0 损耗率,t12.fqty 任务数,0 汇报数,
	t1.FExplanation 摘要,t1.fheadselfs0141 整单包装说明,t1.fheadselfs0142 其他说明,--t12.FEntrySelfS0164 产品包装说明,
	isnull(t12.fnote,'') 订单备注,'' 仓管员,0 仓库内码,'' 仓库,'' 物料类别,0 成本对象内码,
	t3.fitemid 单位内码,t3.fname 单位,t12.fqty 应发数,0 已选数,cast((t12.fqty-0) as decimal(24,2)) 未选数,
	0 已发数,cast((t12.fqty-0) as decimal(24,2)) 未发数,0 即时库存,
	'否' 倒冲,(case when t7.ferpclsid=1 then '外购' when t7.ferpclsid=2 then '自制'  end) 物料属性,0 调出仓库内码,'' 备注
	from SeorderEntry t12 
	inner join seorder t1 on t1.finterid=t12.finterid  
	left join icbom t0 on t12.fitemid=t0.fitemid 
	inner join t_User t4 on t0.FOperatorID=t4.fuserid and t4.fuserid<>0  
	left join t_User t5 on t0.FCheckID=t5.fuserid and t5.fuserid<>0  
	left join t_User t6 on t0.FCheckerID=t6.fuserid and t6.fuserid<>0  
	inner join t_icitem t7 on t12.fitemid=t7.fitemid 
	left join t_Organization t2 on t1.fcustid=t2.fitemid
	left join t_department t8 on t8.fitemid=t7.fsource
	left join t_measureunit t3 on t3.fitemid=t7.funitid
	left join t_submessage t13 ON t7.f_128=t13.finterid
	where t1.fbillno=@fbillno and isnull(t1.FMultiCheckLevel1,0)>0
	union all
	select cast(t12.finterid as varchar)+cast(t12.fentryid as varchar) 任务单号,
	cast(t12.finterid as varchar)+cast(t12.fentryid as varchar) 任务单内码,
	0 投料单内码,-1 投料单分录号,getdate() 打印时间,
	isnull(t8.fitemid,0) 生产车间内码,isnull(t8.fname,'') 生产车间,t12.fdate 计划开工日期,t12.fdate 计划完工日期,
	(case when t0.fstatus=0 then '未审核' when t0.fstatus in (1) then '审核' end) 状态,
	isnull(t1.fbillno,'') 订单编号,t1.fdate 下单日期,t12.fentryid 订单分录号,isnull(t2.fname,'') 客户,
	'' 物料短代码,'' 物料编码,'' 物料名称, '' 物料规格型号,0 物料内码,
	--isnull(t11.fshortnumber,'') 物料短代码,isnull(t11.fnumber,'') 物料编码,isnull(t11.FName,'') 物料名称, isnull(t11.fmodel,'') 物料规格型号,isnull(t11.fitemid,0) 物料内码,
	0 订单数,--t1.FHeadSelfS0148 工厂交期,t1.fheadselfs0142 包材交期,t1.fheadselfs0143 工厂备注,
	isnull(t1.fheadselfs0143,'') 源采购订单号,isnull(t1.fheadselfs0144,'') 源销售订单号,0 单位用量,0 损耗率,t12.fqty 任务数,0 汇报数,
	t1.FExplanation 摘要,t1.fheadselfs0141 整单包装说明,t1.fheadselfs0142 其他说明,--t12.FEntrySelfS0164 产品包装说明,
	'' 订单备注,'' 仓管员,0 仓库内码,'' 仓库,'' 物料类别,0 成本对象内码,
	0 单位内码,'' 单位,0 应发数,0 已选数,0 未选数,
	0 已发数,0 未发数,0 即时库存,
	'否' 倒冲,'' 物料属性,0 调出仓库内码,'' 备注
	from SeorderEntry t12 
	inner join seorder t1 on t1.finterid=t12.finterid  
	left join icbom t0 on t12.fitemid=t0.fitemid 
	inner join t_User t4 on t0.FOperatorID=t4.fuserid and t4.fuserid<>0  
	left join t_User t5 on t0.FCheckID=t5.fuserid and t5.fuserid<>0  
	left join t_User t6 on t0.FCheckerID=t6.fuserid and t6.fuserid<>0  
	inner join t_icitem t7 on t12.fitemid=t7.fitemid 
	left join t_Organization t2 on t1.fcustid=t2.fitemid
	left join t_department t8 on t8.fitemid=t7.fsource
	left join t_measureunit t3 on t3.fitemid=t7.funitid
	where t1.fbillno=@fbillno and isnull(t1.FMultiCheckLevel1,0)>0
	union all
	select cast(t12.finterid as varchar)+cast(t12.fentryid as varchar) 任务单号,
	cast(t12.finterid as varchar)+cast(t12.fentryid as varchar) 任务单内码,
	cast(t12.finterid as varchar)+cast(t12.fentryid as varchar) 投料单内码,
	t9.fentryid 投料单分录号,getdate() 打印时间,
	isnull(t8.fitemid,0) 生产车间内码,isnull(t8.fname,'') 生产车间,t12.fdate 计划开工日期,t12.fdate 计划完工日期,
	(case when t0.fstatus=0 then '未审核' when t0.fstatus in (1) then '审核' end) 状态,
	isnull(t1.fbillno,'') 订单编号,t1.fdate 下单日期,t12.fentryid 订单分录号,isnull(t2.fname,'') 客户,
	--isnull(t7.fshortnumber,'') 产品短代码,isnull(t7.fnumber,'') 产品编码,isnull(t7.FName,'') 产品名称, isnull(t7.fmodel,'') 产品规格型号,isnull(t7.fitemid,0) 产品内码,
	isnull(t11.fshortnumber,'') 物料短代码,isnull(t11.fnumber,'') 物料编码,isnull(t11.FName,'') 物料名称, isnull(t11.fmodel,'')+'///'+isnull(t11.F_105,'') 物料规格型号,isnull(t11.fitemid,0) 物料内码,
	cast(t12.fqty as decimal(24,2)) 订单数,--t1.FHeadSelfS0148 工厂交期,t1.fheadselfs0142 包材交期,t1.fheadselfs0143 工厂备注,
	isnull(t1.fheadselfs0143,'') 源采购订单号,isnull(t1.fheadselfs0144,'') 源销售订单号,t9.fqty 单位用量,0 损耗率,t12.fqty 任务数,0 汇报数,
	t1.FExplanation 摘要,t1.fheadselfs0141 整单包装说明,t1.fheadselfs0142 其他说明,--t12.FEntrySelfS0164 产品包装说明,
	isnull(t12.fnote,'') 订单备注,isnull(t13.fname,'') 仓管员,t15.fitemid 仓库内码,t15.fname 仓库,isnull(t14.fname,'') 物料类别,0 成本对象内码,
	t3.fitemid 单位内码,t3.fname 单位,
	--cast(t12.fqty*t9.fqty as decimal(24,2)) 应发数,
	ROUND((case when t11.FPutInteger=1 then ceiling(t12.fqty*t9.fqty) else t12.fqty*t9.fqty end),t11.FQtyDecimal) 应发数,
	0 已选数,cast(t12.fqty*t9.fqty as decimal(24,2)) 未选数,
	0 已发数,cast(t12.fqty*t9.fqty as decimal(24,2)) 未发数,
	cast(isnull(t16.fqty,0) as decimal(24,2)) 即时库存,
	--cast(t9.fqtymust as decimal(24,2)) 应调拨数,cast(t9.FTransLateQty as decimal(24,2)) 已调拨数,cast((t9.fqtymust-t9.FTransLateQty) as decimal(24,2)) 未调拨数,
	isnull(t17.fname,'否') 倒冲,(case when t11.ferpclsid=1 then '外购' when t11.ferpclsid=2 then '自制'  end) 物料属性,
	(case when isnull(t17.fname,'否')='是' and t8.fitemid in (175,171817) then 16479	--装配车间仓
		  when isnull(t17.fname,'否')='是' and t8.fitemid=176 then 16480 --包装车间仓
		  when isnull(t17.fname,'否')='否' then t11.fdefaultloc end) 调出仓库内码,--非倒冲外购件取基础资料属性的默认仓库
	'' 备注
	from SeorderEntry t12 
	inner join seorder t1 on t1.finterid=t12.finterid  
	left join icbom t0 on t12.fitemid=t0.fitemid 
	inner join t_User t4 on t0.FOperatorID=t4.fuserid and t4.fuserid<>0  
	left join t_User t5 on t0.FCheckID=t5.fuserid and t5.fuserid<>0  
	left join t_User t6 on t0.FCheckerID=t6.fuserid and t6.fuserid<>0  
	inner join t_icitem t7 on t12.fitemid=t7.fitemid 
	left join t_Organization t2 on t1.fcustid=t2.fitemid
	left join t_department t8 on t8.fitemid=t7.fsource
	left join icbomchild t9 on t9.finterid=t0.finterid
	--inner join ppbom t10 on t10.finterid=t9.finterid
	left join t_icitem t11 on t11.fitemid=t9.fitemid
	left join t_measureunit t3 on t3.fitemid=t11.funitid
	left join t_SubMessage t13 on t13.finterid=t11.f_114 and t13.ftypeid=10003
	left join t_SubMessage t14 on t14.finterid=t11.ftypeid and t14.ftypeid=504
	left join t_stock t15 on t15.fitemid=t9.fstockid
	left join 
	(	
		select fitemid,fstockid,sum(fqty) fqty 
		from 
		(
			select fitemid,fstockid,fqty from icinventory 
			union all 
			select t1.fitemid,t1.fstockid,t1.fqty from poinventory t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid --where t1.fitemid<>20355 and t2.fnumber like '6.%'  select * from t_stock where fitemid=20355
		) t1
		group by fitemid,fstockid
	) t16 on t16.fitemid=t9.fitemid and t16.fstockid=t9.fstockid
	left join t_SubMessage t17 on t17.finterid=t11.f_115 and t17.ftypeid=10002
	where t1.fbillno=@fbillno and isnull(t1.FMultiCheckLevel1,0)>0
) t1 order by 订单编号,订单分录号,投料单分录号,物料编码

--delete from #t1 where findex=1

update #t1 set 投料单分录号=订单分录号 where 投料单分录号=-1

insert into #t1(物料编码) values ('小计')

select isnull(投料单分录号,0) 投料单分录号,isnull(物料编码,'') 物料编码,isnull(物料名称,'') 物料名称,
isnull(物料规格型号,'') 物料规格型号,isnull(单位,'') 单位,isnull(单位用量,0) 单位用量,isnull(应发数,0) 应发数,
isnull(源销售订单号,'') 源销售订单号,isnull(源采购订单号,'') 源采购订单号,getdate() 打印时间,
isnull(计划完工日期,'1900-01-01') 计划完工日期,isnull(订单编号,'') 订单编号,'' 备注
 from #t1 order by findex

--
--select identity(int,1,1) as findex,*
--into #t1
--from
--(
--	select t6.finterid forderinterid,t6.fentryid forderentryid,isnull(t7.FHEADSELFS0145,'') fpacknote,
--	t6.fnote+'///'+isnull(t1.fnote,'') fnote,
--	t3.fshortnumber fnumber,t3.fname,t3.fmodel,t2.FIndex fentryid,
--	t4.fshortnumber fchilditemnumber,t4.fname fchilditemname,t4.fmodel fchilditemmodel,t5.fname funit,t6.fqty forderqty,t2.fqty,t6.fqty*t2.fqty fqtymust
--	from seorderentry t6 
--	inner join seorder t7 on t6.finterid=t7.finterid
--	inner join t_BOSPackSub t1 on t1.fbillno=t6.fentryselfs0159
--	inner join t_BOSPackSubEntry t2 on t1.fid=t2.fid
--	inner join t_icitem t4 on t2.fitemid=t4.fitemid
--	inner join t_measureunit t5 on t5.fitemid=t4.funitid
--	inner join t_icitem t3 on t6.fitemid=t3.fitemid
--	WHERE t7.fbillno =@fbillno
--) t1
--order by fnumber,fentryid
----select * from #t1
--update t1 set fpacknote='',fnumber='ZZZZZZ',fname='',fmodel=''
--from #t1 t1
--inner join (select fnumber,max(findex) findex from #t1 group by fnumber) t2 on t1.fnumber=t2.fnumber
--where t1.findex=t2.findex
--
--update t1 set fnote='',fpacknote='',fnumber='',fname='',fmodel=''
--from #t1 t1
--inner join (select fnumber,min(findex) findex from #t1 group by fnumber) t2 on t1.fnumber=t2.fnumber
--where t1.findex<>t2.findex and t1.fnumber not like 'ZZZZZZ'
--
--select fpacknote 包装说明,fnumber 产品编码,fname 产品名称,fmodel 产品规格,
--fentryid 序号,fchilditemnumber 物料编码,fchilditemname 物料名称,fchilditemmodel 物料规格,funit 单位,
--forderqty 订单数,fqty 单位用量,fqtymust 应发数,fnote 备注
--FROM #t1
--

drop table #t1

set nocount off

go

--生成或刷新投料单--塑胶件--
--My_P_AddOrEditPPBom_Plastic 16394,3232
IF EXISTS (select * from sysobjects where name='My_P_AddOrEditPPBom_Plastic' and xtype='p')  drop  procedure My_P_AddOrEditPPBom_Plastic

go

create procedure [dbo].My_P_AddOrEditPPBom_Plastic(@ficmointerid int,@FPlasticItemID int) --@fitemtype  100 全部 0 成品 1 半成品  2 常规物料 3 包材 4 半制品

as

set nocount on

declare @fplanprice decimal(18,4),@fitemid int,@fpitemid int,@funitid int,@entryid int,@fqty int
declare @InterID int,@BillNo varchar (20),@FStockId int,@StockNumber varchar (20)
DECLARE @TmpID INT ,@fsupplyid int,@fcurrencyid int,@FMyPoInStockInterId int,@fscrap decimal(24,4)
declare @fsupplyno varchar(20),@forderdate datetime,@FValueAddRate decimal(28, 2),@FSendItemDate datetime
declare @iLength int,@FPrice decimal(28, 5),@FAmount decimal(20, 2),@FExchangeRate decimal(28, 10)
declare @FTaxPrice decimal(28, 5),@FTaxAmount decimal(20, 2),@SupplyId int,@FQtyScrap decimal(24,4)
declare @fprojectval varchar(200),@fspid int,@fempid int,@fdeptid int,@fqtymust decimal(24,2)
declare @FDateFormat varchar(200),@fdate datetime,@forginterid int,@FBomInputQty decimal(24,4)
declare @fsourceNumber varchar(200),@fpSourceNumber varchar(200),@fpXxSourceNumber varchar(200)
declare @fXxOldSourceNumber varchar(200),@empid int,@fsourcetrantype int
declare @FDCStockID int,@xx_FItemIDOld int,@fxxitemid int,@FOrgPPOInterID int
declare @FDCSPID int,@forderinterid int,@forderentryid int
declare @fsourceInterid int,@fsourceEntryid int,@fsourceBillNo varchar (100)
declare @fyear int,@fperiod int,@FMangerID int,@FSourceSEBillNo varchar (100),@FSourcePOBillNo varchar (100)
declare @fresultbillno varchar (800),@FPlanFinishDate datetime,@fnote varchar(500),@ficmoqty decimal(24,4)
declare @ftempbillno varchar(50),@fcostobjid int,@fplancommitdate datetime,@fsourceid int
declare @fplanorderinterid int,@fbominterid int,@forgsaleinterid int,@forgentryid int,@fuserid int,@fitemtype int
--AIS20041229163526   AIS20080129143619
--declare @fbout varchar(10),@fcommitdate datetime

select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期
set @forderdate=@fdate  --'2009-06-15' --下单日期
--set @fcommitdate='2009-07-21' --到货日期
select @fresultbillno='',@BillNo='',@InterID=0

--set @fbout='204'

--select @fidentify=isnull(max(fid),0)+1 from my_t_identify
--insert into my_t_identify(fid,fuserid,fdate,FTrantypeID) values(@fidentify,@fuserid,getdate(),85)

create table #DataEntry(funitid int,fitemid int,FQtyScrap decimal(24,4),FBomInputQty decimal(24,4),
fscrap decimal(24,4),fqtymust decimal(24,2),fstockid int)

select @FItemId=t1.fitemid,@funitid=t1.funitid,@fqty=t1.fqty,@fcostobjid=t1.FCostObjID,@ficmoqty=t1.fqty,
@fsourceid=t1.fworkshop,@InterID=isnull(t2.finterid,0),@FSendItemDate=t1.fplancommitdate,
@fplancommitdate=fplancommitdate,@FPlanFinishDate=FPlanFinishDate,@fnote=isnull(t1.fnote,''),
@FSourcePOBillNo=t1.FHeadSelfJ0176,@FSourceSEBillNo=t1.FHeadSelfJ0177
from icmo t1
inner join ppbom t2 on t2.ficmointerid=t1.finterid
where t1.finterid=@ficmointerid

select @entryid=isnull(max(fentryid),0)+1 from ppbomentry where finterid=@InterID

insert into #DataEntry(funitid,   fitemid,   FQtyScrap,        FBomInputQty,                  fscrap,  fqtymust,                  fstockid)
select                 t6.funitid,t6.fitemid,t5.fqty FQtyScrap,@ficmoqty*t5.fqty FBomInputQty,0 fscrap,@ficmoqty*t5.fqty fqtymust,isnull(t6.fdefaultloc,0) fstockid
from t_icitem t9 
inner join icbom t4 on t4.fitemid=t9.fitemid
inner join icbomchild t5 on t5.finterid=t4.finterid
inner join t_icitem t6 on t6.fitemid=t5.fitemid
where t9.fnumber like '1.02.%' and t6.fnumber like '6.%' --如果是套件,则展开到子件
and t9.fitemid=@FPlasticItemID

DECLARE authorsentry_cursor CURSOR FOR
select t1.funitid,t1.fitemid,t1.FQtyScrap,t1.FBomInputQty,t1.fscrap,t1.fqtymust,t1.fstockid 
from #DataEntry t1 
inner join t_icitem t2 on t1.fitemid=t2.fitemid
order by t2.fnumber
	
OPEN authorsentry_cursor

FETCH NEXT FROM authorsentry_cursor 
INTO @funitid,@fitemid,@FQtyScrap,@FBomInputQty,@fscrap,@fqtymust,@fstockid

WHILE @@FETCH_STATUS = 0
BEGIN 
	--icmo fstatus 5 确认 0 计划 1,2 下达 3 结案  fmrp 11061 mps产生 1052 手工录入 11077 mrp产生 
	--ppbomentry fqtyscrp 单位用量  FScrap 损耗率
	Insert Into PPBOMEntry (FEntrySelfY0259,fentryselfy0257,FICMOinterID,   FBrNo,FInterID,FEntryID,FItemID, FUnitID, FAuxQtyMust,FAuxQty,FMachinePos,FBomInputAuxQty,FauxQtyLoss,FSequenceID,FStockID, FNote,FSourceEntryID,FAuxQtyScrap,FScrap,  FSendItemDate,  FAuxQtyPick,  FSPID,FOperID,FOperSN,FMaterielType,FBackFlush,FMarshalType,FBOMInterID,FBatchNO )
	Values (                @fitemtype,     @fcostobjid,    @ficmointerid,  '0',  @Interid,@entryid,@fitemid,@funitid,@fqtymust,  0,      '',         @FBomInputQty,  0,          '',         @fstockid,'',   0,             @FQtyScrap,  @fscrap, @FSendItemDate, @FBomInputQty,0,    0,      0,      371,          1059,      385,         0,          '')

	set @entryid=@entryid+1

	FETCH NEXT FROM authorsentry_cursor 
	INTO @funitid,@fitemid,@FQtyScrap,@FBomInputQty,@fscrap,@fqtymust,@fstockid
END

CLOSE authorsentry_cursor
DEALLOCATE authorsentry_cursor

drop table #DataEntry

set nocount off

go

--*****--select * from v_MyPPBom where 
IF EXISTS (select * from sysobjects where name='v_MyPPBom' and xtype='v')  drop  view v_MyPPBom

go

create view v_MyPPBom 
as

--select 单据类型,仓管员,任务单号,任务单内码,状态,投料单分录号,生产车间,生产车间内码,计划开工日期,订单编号,产品短代码,产品编码,产品名称,产品规格型号,产品内码,成本对象内码,仓库内码,仓库,物料类别,物料属性,物料短代码,物料编码,物料名称,物料规格型号,物料内码,单位,单位内码,应发数,已发数,未发数,未发数 数量,未发数二,cast(isnull((select sum(fqty) fqty from icinventory where fitemid=物料内码 and fstockid=调出仓库内码),0) as decimal(24,2)) 即时库存,倒冲,应调拨数,已调拨数,未调拨数,调出仓库内码 from v_MyPPBom_87
--union all
--select 单据类型,仓管员,任务单号,任务单内码,状态,投料单分录号,生产车间,生产车间内码,计划开工日期,订单编号,产品短代码,产品编码,产品名称,产品规格型号,产品内码,成本对象内码,仓库内码,仓库,物料类别,物料属性,物料短代码,物料编码,物料名称,物料规格型号,物料内码,单位,单位内码,应发数,已发数,未发数,未发数 数量,未发数二,cast(isnull((select sum(fqty) fqty from icinventory where fitemid=物料内码 and fstockid=调出仓库内码),0) as decimal(24,2)) 即时库存,倒冲,应调拨数,已调拨数,未调拨数,调出仓库内码 from v_MyPPBom_81

select t0.fbillno 任务单号,t0.finterid 任务单内码,t10.finterid 投料单内码,t9.fentryid 投料单分录号,isnull(t8.fitemid,0) 生产车间内码,
isnull(t8.fname,'') 生产车间,t0.fplancommitdate 计划开工日期,
(case when t0.fstatus=0 then '计划' when t0.fstatus in (1,2) then '下达' when t0.fstatus=5 then '确认' when t0.fstatus=3 then '结案' end) 状态,
isnull(t1.FHeadSelfS0144,'') 源销售订单号,isnull(t1.FHeadSelfS0143,'') 源采购订单号,isnull(t1.fbillno,'') 订单编号,t1.fdate 下单日期,t12.fentryid 订单分录号,isnull(t2.fname,'') 客户,
isnull(t7.fshortnumber,'') 产品短代码,isnull(t7.fnumber,'') 产品编码,isnull(t7.FName,'') 产品名称, isnull(t7.fmodel,'') 产品规格型号,isnull(t7.fitemid,0) 产品内码,
cast(t12.fqty as decimal(24,2)) 订单数,--t1.FHeadSelfS0148 工厂交期,t1.fheadselfs0142 包材交期,t1.fheadselfs0143 工厂备注,
isnull(t1.fheadselfs0144,'') 客户订单号,t9.fauxqtyscrap 单位用量,t9.fscrap 损耗率,t0.fqty 任务数,t0.fcommitqty 汇报数,
--t1.fheadselfs0146 整单包装说明,t12.FEntrySelfS0164 产品包装说明,
isnull(t12.fnote,'') 订单备注,isnull(t13.fname,'') 仓管员,t15.fitemid 仓库内码,t15.fname 仓库,isnull(t14.fname,'') 物料类别,
t0.fcostobjid 成本对象内码,isnull(t11.fshortnumber,'') 物料短代码,isnull(t11.fnumber,'') 物料编码,isnull(t11.FName,'') 物料名称, isnull(t11.fmodel,'')+'///'+isnull(t11.F_105,'') 物料规格型号,isnull(t11.fitemid,0) 物料内码,
t3.fitemid 单位内码,t3.fname 单位,t9.fnote 备注,
-- cast(isnull(t21.fqty,0) as decimal(24,2)) 已选未发,
cast(t9.fqty-t9.fstockqty as decimal(24,4)) 已选未发,
cast(t9.fqtymust as decimal(24,4)) 应发数,
cast(t9.fqty as decimal(24,4)) 已选数,cast((t9.fqtymust-t9.fqty) as decimal(24,4)) 未选数,
cast(t9.fstockqty as decimal(24,4)) 已发数,cast((t9.fqtymust-t9.fstockqty) as decimal(24,4)) 未发数,

cast(isnull(t16.fqty,0) as decimal(24,4)) 即时库存,cast(isnull(t18.fqty,0) as decimal(24,4)) 待检数,cast(isnull(t20.fqty,0) as decimal(24,4)) 在途数,
-- cast(isnull(t19.fcommonqty,0) as decimal(24,2)) 常规,cast(isnull(t19.fpatchqty,0) as decimal(24,2)) 补料,cast(isnull(t19.fbackqty,0) as decimal(24,2)) 退料,
0.00 常规,0.00 补料,0.00 退料,
'['+isnull(t30.fshortnumber,'')+']'+'['+isnull(t30.fname,'')+']' 原物料,
--cast(t9.fqtymust as decimal(24,2)) 应调拨数,cast(t9.FTransLateQty as decimal(24,2)) 已调拨数,cast((t9.fqtymust-t9.FTransLateQty) as decimal(24,2)) 未调拨数,
isnull(t17.fname,'否') 倒冲,(case when t11.ferpclsid=1 then '外购' when t11.ferpclsid=2 then '自制'  end) 物料属性,
(case when isnull(t17.fname,'否')='是' and t8.fitemid in (175,171817) then 16479	--装配车间仓
      when isnull(t17.fname,'否')='是' and t8.fitemid=176 then 16480 --包装车间仓
      when isnull(t17.fname,'否')='否' then t11.fdefaultloc end) 调出仓库内码--非倒冲外购件取基础资料属性的默认仓库
from icmo t0 
left join SeorderEntry t12 on t0.forderinterid=t12.finterid and t0.fsourceentryid=t12.fentryid --and t0.fitemid=t12.fitemid
left join seorder t1 on t1.finterid=t12.finterid  
inner join t_User t4 on t0.fbillerid=t4.fuserid and t4.fuserid<>0  
left join t_User t5 on t0.fconfirmerid=t5.fuserid and t5.fuserid<>0  
left join t_User t6 on t0.fconveyerid=t6.fuserid and t6.fuserid<>0  
inner join t_icitem t7 on t0.fitemid=t7.fitemid 
left join t_Organization t2 on t1.fcustid=t2.fitemid
left join t_department t8 on t8.fitemid=t0.fworkshop
inner join ppbomentry t9 on t9.ficmointerid=t0.finterid
inner join ppbom t10 on t10.finterid=t9.finterid
inner join t_icitem t11 on t11.fitemid=t9.fitemid
inner join t_measureunit t3 on t3.fitemid=t11.funitid
left join t_SubMessage t13 on t13.finterid=t11.f_114 and t13.ftypeid=10003
left join t_SubMessage t14 on t14.finterid=t11.ftypeid and t14.ftypeid=504
inner join t_stock t15 on t15.fitemid=t9.fstockid
left join t_icitem t30 on t30.fitemid=t9.folditemid
left join 
(	
	select fitemid,fstockid,sum(fqty) fqty 
	from 
	(
		select t1.fitemid,t1.fstockid,t1.fqty from icinventory t1 inner join t_stock t2 on t1.fstockid=t2.fitemid where t2.fname not like '%报废%' and t2.fname not like '%不良%'
		union all 
		select t1.fitemid,t1.fstockid,t1.fqty from poinventory t1 inner join t_stock t2 on t1.fstockid=t2.fitemid where t1.FStockID<>16482 and t2.fname not like '%报废%' and t2.fname not like '%不良%'
	) t1
	group by fitemid,fstockid
) t16 on t16.fitemid=t9.fitemid and t16.fstockid=t9.fstockid
left join (select fitemid,sum(fqty) fqty from poinventory where FStockID=16482 group by fitemid) t18 on t18.fitemid=t9.fitemid 
left join t_SubMessage t17 on t17.finterid=t11.f_115 and t17.ftypeid=10002
-- left join
-- (
-- 	select ficmointerid,fppbomentryid,fitemid,sum(fpatchqty) fpatchqty,sum(fbackqty) fbackqty,sum(fcommonqty) fcommonqty
-- 	from
-- 	(
-- 		select t2.ficmointerid,t2.fppbomentryid,t2.fitemid,
-- 		(case when t2.fsourcetrantype=200000014 and t2.fqty>0 then t2.fqty else 0 end) fpatchqty, /*补*/ 
-- 		(case when t2.fsourcetrantype=200000014 and t2.fqty<0 then -t2.fqty else 0 end) fbackqty, /*退*/
-- 		(case when t2.fsourcetrantype=85 then t2.fqty end) fcommonqty /*常规*/
-- 		from icstockbill t1
-- 		inner join icstockbillentry t2 on t1.finterid=t2.finterid
-- 		where t1.ftrantype=24 
-- 		union 
-- 		select t2.FEntrySelfZOU30 ficmointerid,t2.FEntrySelfZOU31 fppbomentryid,t2.fitemid,
-- 		(case when t2.fsourcetrantype=200000014 and t2.fqty>0 then t2.fqty else 0 end) fpatchqty, /*补*/ 
-- 		(case when t2.fsourcetrantype=200000014 and t2.fqty<0 then -t2.fqty else 0 end) fbackqty, /*退*/
-- 		(case when t2.fsourcetrantype=85 then t2.fqty end) fcommonqty /*常规*/
-- 		from zpstockbill t1
-- 		inner join zpstockbillentry t2 on t1.finterid=t2.finterid
-- 		where t1.ftrantype=26
-- 	) m1 group by ficmointerid,fppbomentryid,fitemid
-- ) t19 on t19.ficmointerid=t9.ficmointerid and t19.fppbomentryid=t9.fentryid
left join
(
	select fitemid,sum(fqty) fqty
	from
	(
		select t2.fitemid,(t2.fqty-t2.fcommitqty) fqty
		from poorderentry t2  
		inner join poorder t1 on t1.finterid=t2.finterid
		inner join t_icitem t3 on t2.fitemid=t3.fitemid
		inner join t_department t4 on t1.fdeptid=t4.fitemid
		where t2.fmrpclosed<>1 and t1.fstatus<>3  --采购订单收料完毕就关闭，但不一定已经入库
		and t3.ferpclsid in (1) and (t2.fqty-t2.fcommitqty)>0
		union all
		select t2.fitemid,t2.fqty-t2.fcommitqty fqty --在途--(采购申请单--未关闭--未关联数)
		from porequest t1
		inner join porequestentry t2 on t1.finterid=t2.finterid
		inner join t_icitem t3 on t2.fitemid=t3.fitemid
		inner join t_department t4 on t1.fdeptid=t4.fitemid
		where t1.fstatus<>3 and isnull(t2.fmrpclosed,0)<>1
		and t3.ferpclsid in (1)	and (t2.fqty-t2.fcommitqty)>0 
--		union all
--		select t2.fitemid,t2.fqty --预计入库(未审核的外购入库单)
--		from icstockbill t1
--		inner join icstockbillentry t2 on t1.finterid=t2.finterid
--		inner join t_icitem t3 on t2.fitemid=t3.fitemid
--		inner join t_department t4 on t1.fdeptid=t4.fitemid
--		where t1.fstatus=0 and t2.FSourceTranType=72 
		union all
		--在途--塑胶子件-塑胶子件收料申请单--子件在途=子件收料申请单未关联数+未审核的收料通知单
		select t2.fitemid,(t2.fqty-t2.fcommitqty) fqty
		from t_BOSPlasticPoInStock t1
		inner join t_BOSPlasticPoInStockEntry t2 on t1.fid=t2.fid
		inner join t_icitem t3 on t2.fitemid=t3.fitemid
		inner join poorderentry t7 on t7.finterid=t2.fid_src and t7.fentryid=t2.fentryid_src 
		where t7.FMrpClosed<>1 
		and isnull(t2.fmrpclosed,0)<>40019 --and t1.fstatus>0 
		and (t2.fqty-t2.fcommitqty)>0
		union all
		select t2.fitemid,t2.fqty-t2.fcommitqty-t2.fbackqty --在途(收料通知单--未审核--未关联数)
		from poinstock t1
		inner join poinstockentry t2 on t1.finterid=t2.finterid
		inner join t_icitem t3 on t2.fitemid=t3.fitemid
		inner join t_department t4 on t1.fdeptid=t4.fitemid
		where t1.fstatus=0 --已经审核的才纳入????
		and t2.fqty>(t2.fcommitqty+t2.fbackqty)
		union all  
		select t2.fitemid,t2.fqty-isnull(t2.fstockqty,0)  --预计入库(生成任务单--未结案--未入库数)
		from icmo t2 
		inner join t_icitem t3 on t2.fitemid=t3.fitemid
		inner join t_department t4 on t2.fworkshop=t4.fitemid
		where t2.fstatus<>3 and (t2.fqty-isnull(t2.fstockqty,0))>0 and t2.FCancellation=0
	) m1 group by fitemid
) t20 on t20.fitemid=t9.fitemid 
-- left join
-- (
-- 	select t2.fitemid,sum(t2.fqty) fqty
-- 	from icstockbill t1
-- 	inner join icstockbillentry t2 on t1.finterid=t2.finterid
-- 	where t1.ftrantype=24 and t1.frob=1 and t1.fstatus=0
-- 	group by t2.fitemid
-- ) t21 on t21.fitemid=t9.fitemid 

go



--*****通过生产计划取得
--My_p_GetPPBom 16394 ,1
IF EXISTS (select * from sysobjects where name='My_p_GetPPBom' and xtype='p')  drop  procedure My_p_GetPPBom

go

create procedure My_p_GetPPBom (@fuserid int,@ftype int)  --@ftype 1 汇总 2 明细
as

set nocount on 

declare @fdate datetime
select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期

--任务数与滚动计划数的平衡关系:任务数-当天以前的汇报数=当天和当天以后的计划数
--生产日期是当天而当天领料的情况可能是插单或者欠料

select t1.finterid ficmointerid,isnull(t3.FQtyFinish,0) FQtyFinish,
t1.fqty-isnull(t3.FQtyFinish,0)-isnull(t2.fplanqty,0) fdifqty
into #source
from icmo t1
left join 
(
	select t1.fsourceinterid,sum(t1.FQtyFinish) FQtyFinish 
	from ICMORptEntry t1 
	inner join ICMORpt t2 on t1.finterid=t2.finterid
	where t2.fheadselfj1112<@fdate
	group by t1.fsourceinterid
) t3 on t1.finterid=t3.fsourceinterid
left join 
(
	select ficmointerid,sum(fqty) fplanqty 
	from my_t_scheduledetail 
	where fsourcetrantype=85 and fdate>=@fdate
	group by ficmointerid
) t2 on t1.finterid=t2.ficmointerid  
where t1.fqty>isnull(t1.fstockqty,0) and t1.fstatus in (1,2) --未工的生产任务单
--and t1.fqty<>(isnull(t2.fplanqty,0)+isnull(t3.FQtyFinish,0))

if @ftype=1
begin
	select cast(1 as bit) 选择,生产车间,生产车间内码,
	(case when 订单编号='' then 任务单号 else 订单编号 end) 订单编号,仓管员,物料类别,
	物料短代码,物料编码,物料名称,物料规格型号,物料内码,仓库,仓库内码,单位,单位内码,
	sum(应发数) 应发数,sum(未选数) 未选数,
	cast(sum(t2.fsumplanqty*t1.单位用量*(1+t1.损耗率/100)) as decimal(24,4)) 计划数,
	cast(sum(isnull(t3.fdifqty,0)*t1.单位用量*(1+t1.损耗率/100)) as decimal(24,4)) 未排数,
	cast(sum(isnull(t3.FQtyFinish,0)*t1.单位用量*(1+t1.损耗率/100)) as decimal(24,4)) 本日之前汇报数,
	cast(sum((t2.fsumplanqty+isnull(t3.fdifqty,0)+isnull(t3.FQtyFinish,0))*t1.单位用量*(1+t1.损耗率/100)) as decimal(24,4)) 选单应发数,
	sum(已选数) 已选数,
	cast(sum((t2.fsumplanqty+isnull(t3.fdifqty,0)+isnull(t3.FQtyFinish,0))*t1.单位用量*(1+t1.损耗率/100)-t1.已选数) as decimal(24,4)) 数量,即时库存,倒冲
	from v_MyPPBom t1
	inner join 
	(
		select t3.ficmointerid,sum(t3.fqty) fsumplanqty /*选中的计划数*/
		from my_t_scheduledetail t3 
		inner join 
		(
			select t3.ficmointerid,max(t3.fdate) fdate
			from my_t_scheduledetail t3 
			inner join My_t_ScheduleDetailTemp t2 on t2.finterid=t3.finterid
			where t2.fuserid=@fuserid
			group by t3.ficmointerid
		) t2 on t3.ficmointerid=t2.ficmointerid and t3.fdate<=t2.fdate  --领料和模拟时，任务单关联的计划单的日期为[今天～截止]日期
		where t3.fdate>=@fdate  --前台已经控制只能选当天或当天以后的计划
		group by t3.ficmointerid
	) t2 on t1.任务单内码=t2.ficmointerid
	left join #source t3 on t1.任务单内码=t3.ficmointerid
	where --未发数>0 and 
	状态='下达'
	group by 生产车间,生产车间内码,
	(case when 订单编号='' then 任务单号 else 订单编号 end),--有关联订单则按订单汇总，否则按任务单汇总
	仓管员,物料类别,
	物料短代码,物料编码,物料名称,物料规格型号,物料内码,仓库,仓库内码,单位,单位内码,即时库存,倒冲
	order by 生产车间,(case when 订单编号='' then 任务单号 else 订单编号 end),物料编码
end

if @ftype=2
begin
	select cast(1 as bit) 选择,生产车间,生产车间内码,
	(case when 订单编号='' then 任务单号 else 订单编号 end) 订单编号,
	任务单号,任务单内码,投料单分录号,仓管员,物料类别,
	物料短代码,物料编码,物料名称,物料规格型号,物料内码,仓库,仓库内码,单位,单位内码,
	应发数,已选数,未选数,0.00 数量,即时库存,倒冲
	from v_MyPPBom t1
	inner join 
	(
		select t3.ficmointerid,sum(t3.fqty) fsumplanqty /*选中的计划数*/
		from my_t_scheduledetail t3 
		inner join 
		(
			select t3.ficmointerid,max(t3.fdate) fdate
			from my_t_scheduledetail t3 
			inner join My_t_ScheduleDetailTemp t2 on t2.finterid=t3.finterid
			where t2.fuserid=@fuserid
			group by t3.ficmointerid
		) t2 on t3.ficmointerid=t2.ficmointerid and t3.fdate<=t2.fdate  --领料和模拟时，任务单关联的计划单的日期为[今天～截止]日期
		where t3.fdate>=@fdate  --前台已经控制只能选当天或当天以后的计划
		group by t3.ficmointerid
	) t2 on t1.任务单内码=t2.ficmointerid
	left join #source t3 on t1.任务单内码=t3.ficmointerid
	where --未发数>0 and 
	状态='下达'
	order by 生产车间,(case when 订单编号='' then 任务单号 else 订单编号 end),物料编码
end

drop table #source

set nocount off

go


--暂未使用------------------------------------
--*****--select * from v_MyPPBom where 
IF EXISTS (select * from sysobjects where name='My_p_vPPBom' and xtype='p')  drop  procedure My_p_vPPBom

go

create procedure My_p_vPPBom (@fuserid int)
as

--select 单据类型,仓管员,任务单号,任务单内码,状态,投料单分录号,生产车间,生产车间内码,计划开工日期,订单编号,产品短代码,产品编码,产品名称,产品规格型号,产品内码,成本对象内码,仓库内码,仓库,物料类别,物料属性,物料短代码,物料编码,物料名称,物料规格型号,物料内码,单位,单位内码,应发数,已发数,未发数,未发数 数量,未发数二,cast(isnull((select sum(fqty) fqty from icinventory where fitemid=物料内码 and fstockid=调出仓库内码),0) as decimal(24,2)) 即时库存,倒冲,应调拨数,已调拨数,未调拨数,调出仓库内码 from v_MyPPBom_87
--union all
--select 单据类型,仓管员,任务单号,任务单内码,状态,投料单分录号,生产车间,生产车间内码,计划开工日期,订单编号,产品短代码,产品编码,产品名称,产品规格型号,产品内码,成本对象内码,仓库内码,仓库,物料类别,物料属性,物料短代码,物料编码,物料名称,物料规格型号,物料内码,单位,单位内码,应发数,已发数,未发数,未发数 数量,未发数二,cast(isnull((select sum(fqty) fqty from icinventory where fitemid=物料内码 and fstockid=调出仓库内码),0) as decimal(24,2)) 即时库存,倒冲,应调拨数,已调拨数,未调拨数,调出仓库内码 from v_MyPPBom_81

set nocount on

select distinct fitemid into #data from ppbomentry where ficmointerid in (select finterid from my_t_icmotemp where fuserid=@fuserid)

select fitemid,fstockid,sum(fqty) fqty into #t16
from 
(
	select t1.fitemid,t1.fstockid,t1.fqty from icinventory t1 inner join t_stock t2 on t1.fstockid=t2.fitemid 
	where t1.fitemid in (select fitemid from #data) and t2.fname not like '%报废%' and t2.fname not like '%不良%'
	union all 
	select t1.fitemid,t1.fstockid,t1.fqty from poinventory t1 inner join t_stock t2 on t1.fstockid=t2.fitemid 
	where t1.fitemid in (select fitemid from #data) and t1.FStockID<>16482 and t2.fname not like '%报废%' and t2.fname not like '%不良%'
) t1
group by fitemid,fstockid

select ficmointerid,fppbomentryid,fitemid,sum(fpatchqty) fpatchqty,sum(fbackqty) fbackqty,sum(fcommonqty) fcommonqty into #t19
from
(
	select t2.ficmointerid,t2.fppbomentryid,t2.fitemid,
	(case when t2.fsourcetrantype=200000014 and t2.fqty>0 then t2.fqty else 0 end) fpatchqty, /*补*/ 
	(case when t2.fsourcetrantype=200000014 and t2.fqty<0 then -t2.fqty else 0 end) fbackqty, /*退*/
	(case when t2.fsourcetrantype=85 then t2.fqty end) fcommonqty /*常规*/
	from icstockbill t1
	inner join icstockbillentry t2 on t1.finterid=t2.finterid
	where t2.ficmointerid in (select finterid from my_t_icmotemp where fuserid=@fuserid) and t1.ftrantype=24 --and t2.fitemid in (select fitemid from #data)  
	union 
	select t2.FEntrySelfZOU30 ficmointerid,t2.FEntrySelfZOU31 fppbomentryid,t2.fitemid,
	(case when t2.fsourcetrantype=200000014 and t2.fqty>0 then t2.fqty else 0 end) fpatchqty, /*补*/ 
	(case when t2.fsourcetrantype=200000014 and t2.fqty<0 then -t2.fqty else 0 end) fbackqty, /*退*/
	(case when t2.fsourcetrantype=85 then t2.fqty end) fcommonqty /*常规*/
	from zpstockbill t1
	inner join zpstockbillentry t2 on t1.finterid=t2.finterid
	where t2.FEntrySelfZOU30 in (select finterid from my_t_icmotemp where fuserid=@fuserid) and t1.ftrantype=26 --and t2.fitemid in (select fitemid from #data) 
) m1 group by ficmointerid,fppbomentryid,fitemid

select fitemid,sum(fqty) fqty into #t20
from
(
	select t2.fitemid,(t2.fqty-t2.fcommitqty) fqty
	from poorderentry t2  
	inner join poorder t1 on t1.finterid=t2.finterid
	inner join t_icitem t3 on t2.fitemid=t3.fitemid
	inner join t_department t4 on t1.fdeptid=t4.fitemid
	where t2.fmrpclosed<>1 and t1.fstatus<>3  --采购订单收料完毕就关闭，但不一定已经入库
	and t3.ferpclsid in (1) and (t2.fqty-t2.fcommitqty)>0 and t2.fitemid in (select fitemid from #data) 
	union all
	select t2.fitemid,t2.fqty-t2.fcommitqty fqty --在途--(采购申请单--未关闭--未关联数)
	from porequest t1
	inner join porequestentry t2 on t1.finterid=t2.finterid
	inner join t_icitem t3 on t2.fitemid=t3.fitemid
	inner join t_department t4 on t1.fdeptid=t4.fitemid
	where t1.fstatus<>3 and isnull(t2.fmrpclosed,0)<>1
	and t3.ferpclsid in (1)	and (t2.fqty-t2.fcommitqty)>0 and t2.fitemid in (select fitemid from #data) 
--		union all
--		select t2.fitemid,t2.fqty --预计入库(未审核的外购入库单)
--		from icstockbill t1
--		inner join icstockbillentry t2 on t1.finterid=t2.finterid
--		inner join t_icitem t3 on t2.fitemid=t3.fitemid
--		inner join t_department t4 on t1.fdeptid=t4.fitemid
--		where t1.fstatus=0 and t2.FSourceTranType=72 
	union all
	--在途--塑胶子件-塑胶子件收料申请单--子件在途=子件收料申请单未关联数+未审核的收料通知单
	select t2.fitemid,(t2.fqty-t2.fcommitqty) fqty
	from t_BOSPlasticPoInStock t1
	inner join t_BOSPlasticPoInStockEntry t2 on t1.fid=t2.fid
	inner join t_icitem t3 on t2.fitemid=t3.fitemid
	inner join poorderentry t7 on t7.finterid=t2.fid_src and t7.fentryid=t2.fentryid_src 
	where t7.FMrpClosed<>1 
	and isnull(t2.fmrpclosed,0)<>40019 --and t1.fstatus>0 
	and (t2.fqty-t2.fcommitqty)>0 and t2.fitemid in (select fitemid from #data) 
	union all
	select t2.fitemid,t2.fqty-t2.fcommitqty-t2.fbackqty --在途(收料通知单--未审核--未关联数)
	from poinstock t1
	inner join poinstockentry t2 on t1.finterid=t2.finterid
	inner join t_icitem t3 on t2.fitemid=t3.fitemid
	inner join t_department t4 on t1.fdeptid=t4.fitemid
	where t1.fstatus=0 --已经审核的才纳入????
	and t2.fqty>(t2.fcommitqty+t2.fbackqty) and t2.fitemid in (select fitemid from #data) 
	union all  
	select t2.fitemid,t2.fqty-isnull(t2.fstockqty,0)  --预计入库(生成任务单--未结案--未入库数)
	from icmo t2 
	inner join t_icitem t3 on t2.fitemid=t3.fitemid
	inner join t_department t4 on t2.fworkshop=t4.fitemid
	where t2.fstatus<>3 and (t2.fqty-isnull(t2.fstockqty,0))>0 and t2.FCancellation=0 and t2.fitemid in (select fitemid from #data) 
) m1 group by fitemid

select t2.fitemid,sum(t2.fqty) fqty into #t21
from icstockbill t1
inner join icstockbillentry t2 on t1.finterid=t2.finterid
where t2.fitemid in (select fitemid from #data) and t1.ftrantype=24 and t1.frob=1 and t1.fstatus=0
group by t2.fitemid

select t0.fbillno 任务单号,t0.finterid 任务单内码,t10.finterid 投料单内码,t9.fentryid 投料单分录号,isnull(t8.fitemid,0) 生产车间内码,
isnull(t8.fname,'') 生产车间,t0.fplancommitdate 计划开工日期,
(case when t0.fstatus=0 then '计划' when t0.fstatus in (1,2) then '下达' when t0.fstatus=5 then '确认' when t0.fstatus=3 then '结案' end) 状态,
isnull(t1.FHeadSelfS0144,'') 源销售订单号,isnull(t1.FHeadSelfS0143,'') 源采购订单号,isnull(t1.fbillno,'') 订单编号,t1.fdate 下单日期,t12.fentryid 订单分录号,isnull(t2.fname,'') 客户,
isnull(t7.fshortnumber,'') 产品短代码,isnull(t7.fnumber,'') 产品编码,isnull(t7.FName,'') 产品名称, isnull(t7.fmodel,'') 产品规格型号,isnull(t7.fitemid,0) 产品内码,
cast(t12.fqty as decimal(24,2)) 订单数,--t1.FHeadSelfS0148 工厂交期,t1.fheadselfs0142 包材交期,t1.fheadselfs0143 工厂备注,
isnull(t1.fheadselfs0144,'') 客户订单号,t9.fauxqtyscrap 单位用量,t9.fscrap 损耗率,t0.fqty 任务数,t0.fcommitqty 汇报数,
--t1.fheadselfs0146 整单包装说明,t12.FEntrySelfS0164 产品包装说明,
isnull(t12.fnote,'') 订单备注,isnull(t13.fname,'') 仓管员,t15.fitemid 仓库内码,t15.fname 仓库,isnull(t14.fname,'') 物料类别,
t0.fcostobjid 成本对象内码,isnull(t11.fshortnumber,'') 物料短代码,isnull(t11.fnumber,'') 物料编码,isnull(t11.FName,'') 物料名称, isnull(t11.fmodel,'')+'///'+isnull(t11.F_105,'') 物料规格型号,isnull(t11.fitemid,0) 物料内码,
t3.fitemid 单位内码,t3.fname 单位,cast(isnull(t21.fqty,0) as decimal(24,2)) 已选未发,cast(t9.fqtymust as decimal(24,2)) 应发数,
cast(t9.fqty as decimal(24,2)) 已选数,cast((t9.fqtymust-t9.fqty) as decimal(24,2)) 未选数,
cast(t9.fstockqty as decimal(24,2)) 已发数,cast((t9.fqtymust-t9.fstockqty) as decimal(24,2)) 未发数,
cast(isnull(t16.fqty,0) as decimal(24,2)) 即时库存,cast(isnull(t18.fqty,0) as decimal(24,2)) 待检数,cast(isnull(t20.fqty,0) as decimal(24,2)) 在途数,
cast(isnull(t19.fcommonqty,0) as decimal(24,2)) 常规,cast(isnull(t19.fpatchqty,0) as decimal(24,2)) 补料,
cast(isnull(t19.fbackqty,0) as decimal(24,2)) 退料,'['+isnull(t30.fshortnumber,'')+']'+'['+isnull(t30.fname,'')+']' 原物料,
--cast(t9.fqtymust as decimal(24,2)) 应调拨数,cast(t9.FTransLateQty as decimal(24,2)) 已调拨数,cast((t9.fqtymust-t9.FTransLateQty) as decimal(24,2)) 未调拨数,
isnull(t17.fname,'否') 倒冲,(case when t11.ferpclsid=1 then '外购' when t11.ferpclsid=2 then '自制'  end) 物料属性,
(case when isnull(t17.fname,'否')='是' and t8.fitemid in (175,171817) then 16479	--装配车间仓
      when isnull(t17.fname,'否')='是' and t8.fitemid=176 then 16480 --包装车间仓
      when isnull(t17.fname,'否')='否' then t11.fdefaultloc end) 调出仓库内码--非倒冲外购件取基础资料属性的默认仓库
from icmo t0 
left join SeorderEntry t12 on t0.forderinterid=t12.finterid and t0.fsourceentryid=t12.fentryid --and t0.fitemid=t12.fitemid
left join seorder t1 on t1.finterid=t12.finterid  
inner join t_User t4 on t0.fbillerid=t4.fuserid and t4.fuserid<>0  
left join t_User t5 on t0.fconfirmerid=t5.fuserid and t5.fuserid<>0  
left join t_User t6 on t0.fconveyerid=t6.fuserid and t6.fuserid<>0  
inner join t_icitem t7 on t0.fitemid=t7.fitemid 
left join t_Organization t2 on t1.fcustid=t2.fitemid
left join t_department t8 on t8.fitemid=t0.fworkshop
inner join ppbomentry t9 on t9.ficmointerid=t0.finterid
inner join ppbom t10 on t10.finterid=t9.finterid
inner join t_icitem t11 on t11.fitemid=t9.fitemid
inner join t_measureunit t3 on t3.fitemid=t11.funitid
left join t_SubMessage t13 on t13.finterid=t11.f_114 and t13.ftypeid=10003
left join t_SubMessage t14 on t14.finterid=t11.ftypeid and t14.ftypeid=504
inner join t_stock t15 on t15.fitemid=t9.fstockid
left join t_icitem t30 on t30.fitemid=t9.folditemid
left join #t16 t16 on t16.fitemid=t9.fitemid and t16.fstockid=t9.fstockid
left join (select fitemid,sum(fqty) fqty from poinventory where FStockID=16482 group by fitemid) t18 on t18.fitemid=t9.fitemid 
left join t_SubMessage t17 on t17.finterid=t11.f_115 and t17.ftypeid=10002
left join #t19 t19 on t19.ficmointerid=t9.ficmointerid and t19.fppbomentryid=t9.fentryid
left join #t20 t20 on t20.fitemid=t9.fitemid 
left join #t21 t21 on t21.fitemid=t9.fitemid 
where t0.finterid in (select finterid from my_t_icmotemp where fuserid=@fuserid)

drop table #t16 
drop table #t19 
drop table #t20 
drop table #t21 
drop table #data 

set nocount off

go

--*****通过任务单取得--
--My_p_GetPPBomByICMO 16394 ,3
IF EXISTS (select * from sysobjects where name='My_p_GetPPBomByICMO' and xtype='p')  drop  procedure My_p_GetPPBomByICMO

go

create procedure My_p_GetPPBomByICMO(@fuserid int,@ftype int)  --@ftype 1 汇总 2 明细  3 投料单维护
as

set nocount on 
--declare @fuserid int,@ftype int select @fuserid=16394,@ftype=3
declare @fdate datetime
select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期


if @ftype=1  --领料--汇总
begin
	select cast(1 as bit) 选择,生产车间,生产车间内码,
	(case when 订单编号='' then 任务单号 else 订单编号 end) 订单编号,仓管员,物料类别,
	物料短代码,物料编码,物料名称,物料规格型号,物料内码,仓库,仓库内码,单位,单位内码,
	sum(应发数) 应发数,sum(未选数) 未选数,
	0 计划数,0 未排数,0 本日之前汇报数,0 选单应发数,
	sum(已选数) 已选数,
	cast(sum(应发数)-sum(已选数) as decimal(24,2)) 数量,即时库存,min(已选未发) 已选未发,倒冲
	from v_MyPPBom t1
	inner join my_t_icmotemp t2 on t1.任务单内码=t2.finterid and t2.fuserid=@fuserid
	where --未发数>0 and 
	状态='下达'
	group by 生产车间,生产车间内码,
	(case when 订单编号='' then 任务单号 else 订单编号 end),--有关联订单则按订单汇总，否则按任务单汇总
	仓管员,物料类别,
	物料短代码,物料编码,物料名称,物料规格型号,物料内码,仓库,仓库内码,单位,单位内码,即时库存,倒冲
	order by 生产车间,
	(case when 订单编号='' then 任务单号 else 订单编号 end),
	物料编码
end

if @ftype=2  --领料--明细
begin
	select cast(1 as bit) 选择,生产车间,生产车间内码,
	(case when 订单编号='' then 任务单号 else 订单编号 end) 订单编号,
	任务单号,任务单内码,投料单分录号,仓管员,物料类别,
	物料短代码,物料编码,物料名称,物料规格型号,物料内码,仓库,仓库内码,单位,单位内码,
	应发数,已选数,未选数,0.00 数量,即时库存,倒冲
	from v_MyPPBom t1
	inner join my_t_icmotemp t2 on t1.任务单内码=t2.finterid and t2.fuserid=@fuserid
	where --未发数>0 and 
	状态='下达'
	order by 生产车间,
	(case when 订单编号='' then 任务单号 else 订单编号 end),
	物料编码
end

if @ftype=3 --投料单批量维护
begin
	select 生产车间,订单编号,任务单号,产品编码,产品名称,产品规格型号,任务单内码,仓库内码,仓库内码 
	原仓库内码,投料单内码,投料单分录号,仓管员,单位内码,物料类别,物料短代码,物料编码,物料名称,物料规格型号,物料内码,物料内码 
	原物料内码,原物料,产品内码,仓库,单位,单位用量,损耗率,应发数,已发数,未发数,已选数,常规,补料,退料,未选数,未选数 数量,即时库存,待检数,在途数,倒冲,0 标识,备注 
	into #source 
	from v_myppbom t1 
	inner join my_t_icmotemp t2 on t1.任务单内码=t2.finterid and t2.fuserid=@fuserid
	order by 生产车间,订单编号,任务单号,产品编码,仓库,投料单分录号 

	update t1 set 标识=1 
	from #source t1 
	inner join 
	(
		select 任务单内码,min(投料单分录号) 投料单分录号 
		from #source where 
		物料编码 like '6.%' 
		group by 任务单内码
	) t2 on t1.任务单内码=t2.任务单内码 and t1.投料单分录号=t2.投料单分录号 

	select * from #source 

	drop table #source
end

if @ftype=4
begin
	select 生产车间,订单编号,任务单号,产品编码,产品名称,产品规格型号,任务单内码,仓库内码,仓库内码 
	原仓库内码,投料单内码,投料单分录号,仓管员,单位内码,物料类别,物料短代码,物料编码,物料名称,物料规格型号,物料内码,物料内码 
	原物料内码,产品内码,仓库,单位,单位用量,损耗率,应发数,已发数,未发数,已选数,常规,补料,退料,未选数,未选数 数量,即时库存,待检数,在途数,倒冲,0 标识 
	into #data 
	from v_myppbom t1 
	inner join My_t_PPBomTemp t2 on t1.投料单内码=t2.finterid and t1.投料单分录号=t2.fentryid and t2.fuserid=@fuserid
	order by 生产车间,订单编号,任务单号,产品编码,仓库,投料单分录号 

	update t1 set 标识=1 
	from #data t1 
	inner join 
	(
		select 任务单内码,min(投料单分录号) 投料单分录号 
		from #data where 
		物料编码 like '6.%' 
		group by 任务单内码
	) t2 on t1.任务单内码=t2.任务单内码 and t1.投料单分录号=t2.投料单分录号 

	select * from #data 

	drop table #data
end

set nocount off

go

--My_p_GetICMO 16394 
IF EXISTS (select * from sysobjects where name='My_p_GetICMO' and xtype='p')  drop  procedure My_p_GetICMO

go

create procedure My_p_GetICMO (@fuserid int)  
as

set nocount on 

declare @fdate datetime
select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期

--任务数与滚动计划数的平衡关系:任务数-当天以前的汇报数=当天和当天以后的计划数
--生产日期是当天而当天领料的情况可能是插单或者欠料


select t1.finterid ficmointerid,isnull(t3.FQtyFinish,0) FQtyFinish,
t1.fqty-isnull(t3.FQtyFinish,0)-isnull(t2.fplanqty,0) fdifqty
into #source
from icmo t1
left join 
(
	select t1.fsourceinterid,sum(t1.FQtyFinish) FQtyFinish 
	from ICMORptEntry t1 
	inner join ICMORpt t2 on t1.finterid=t2.finterid
	where t2.fheadselfj1112<@fdate
	group by t1.fsourceinterid
) t3 on t1.finterid=t3.fsourceinterid
left join 
(
	select ficmointerid,sum(fqty) fplanqty 
	from my_t_scheduledetail 
	where fsourcetrantype=85 and fdate>=@fdate
	group by ficmointerid
) t2 on t1.finterid=t2.ficmointerid  
where t1.fqty>isnull(t1.fstockqty,0) and t1.fstatus in (1,2) --未工的生产任务单
--and t1.fqty<>(isnull(t2.fplanqty,0)+isnull(t3.FQtyFinish,0))

select cast(1 as bit) 选择,订单编号,单据编号 任务单号,单据内码 任务单内码,产品编码,产品名称,规格型号,产品内码,
       仓库内码,单位,单位内码,订单数,外购数,任务数,任务数-已汇报数 本次汇报数,关联数 已入库数,
       任务数-关联数 本次入库数,客户订单号,
cast(t2.fsumplanqty as decimal(24,2)) 计划数,
cast(isnull(t3.fdifqty,0) as decimal(24,2)) 未排数,
cast(isnull(t3.FQtyFinish,0) as decimal(24,2)) 本日之前汇报数,
cast((t2.fsumplanqty+isnull(t3.fdifqty,0)+isnull(t3.FQtyFinish,0)) as decimal(24,4)) 选单应汇报数,
已汇报数,
cast((t2.fsumplanqty+isnull(t3.fdifqty,0)+isnull(t3.FQtyFinish,0))-t1.已汇报数 as decimal(24,4)) 数量
from v_MyICMO t1
inner join 
(
	select t3.ficmointerid,sum(t3.fqty) fsumplanqty /*选中的计划数--前台已经控制只能选当天或当天以后的计划*/
	from my_t_scheduledetail t3 
	inner join My_t_ScheduleDetailTemp t2 on t2.finterid=t3.finterid
	where t2.fuserid=@fuserid and t3.fdate>=@fdate
	group by t3.ficmointerid
) t2 on t1.单据内码=t2.ficmointerid
left join #source t3 on t1.单据内码=t3.ficmointerid
where ((任务数-已汇报数)>0 or (任务数-关联数)>0)and 
状态='下达'
order by 订单编号,订单分录号,产品编码


drop table #source

set nocount off

go

IF EXISTS (select * from sysobjects where name='v_MyPPOrder' and xtype='v')  drop  view v_MyPPOrder

go

create view v_MyPPOrder 
as

select 87 单据类型,t1.fbillno 单据编号,t1.finterid 单据内码,t1.fdate 制单日期, t4.fname 制单人,
(case when isnull(t1.FCancellation,0)=0 then '' else 'Y' end) 作废,
(case when isnull(t1.FMultiCheckLevel1,0)=0 then '' else 'Y' end) 一级审核,
(case when t1.fstatus=0 then '' else 'Y' end) 审核,
isnull(t5.fname,'') 审核人,isnull(t1.fcheckdate,Null) 审核日期,
'' 交货方式,'' 结算方式,
t12.fentryid 分录号,isnull(t2.fname,'') 客户,isnull(t2.fitemid,0) 客户内码,isnull(t2.faddress ,'') 地址,
isnull(t2.fcontact,'') 联系人,isnull(t2.fphone,'') 电话,isnull(t2.ffax,'') 传真,
isnull(t7.fnumber,'') 产品编码,isnull(t7.FName,'') 产品名称, isnull(t7.fmodel,'') 规格型号,isnull(t7.fitemid,0) 产品内码,
t12.funitid 单位内码,t3.fname 单位,cast(t12.fqty as decimal(24,2)) 订单数,
cast(isnull(t12.FEntrySelfY0121,0) as decimal(24,2)) 已排数,
cast(isnull(t12.FEntrySelfY0122,0) as decimal(24,2)) 可排数,0 单价,0 金额,t12.fnote 备注,
(case when t12.fmrpclosed=1 then 'Y' else '' end) 行业务关闭,'99.' 品牌编码,'' 包装方案,
(case when t7.ferpclsid=1 then '外购' when t7.ferpclsid=2 then '自制' else '其它' end) 物料属性,isnull(t6.FBOMNumber,'') BOM编号
from pporder t1   
inner join t_User t4 on t1.fbillerid=t4.fuserid and t4.fuserid<>0  
left join t_User t5 on t1.fcheckerid=t5.fuserid and t5.fuserid<>0  
inner join pporderentry t12 on t1.finterid=t12.finterid  
inner join t_icitem t7 on t12.fitemid=t7.fitemid 
left join t_Organization t2 on t12.fcustid=t2.fitemid
inner join t_measureunit t3 on t3.fitemid=t12.funitid
--LEFT OUTER JOIN t_SubMessage t8 ON t1.FFetchStyle = t8.FInterID   AND t8.FInterID <>0 
--LEFT OUTER JOIN t_Settle t14 ON t1.FSettleID = t14.FItemID   AND t14.FItemID <>0 
--inner join t_currency t17 on t17.fcurrencyid=t1.fcurrencyid
left join icbom t6 on t6.fitemid=t12.fitemid and t6.fusestatus=1072

go



IF EXISTS (select * from sysobjects where name='v_MySeOrder' and xtype='v')  drop  view v_MySeOrder

go

create view v_MySeOrder 
as

select 81 单据类型,t1.fbillno 单据编号,(case when isnull(t1.FMultiCheckLevel1,0)=0 then '' else 'Y' end) 一级审核,
(case when isnull(t1.FCancellation,0)=0 then '' else 'Y' end) 作废,isnull(t16.fname,'') 主供应商,isnull(t18.fname,'') 订单类型,
--t1.FHeadSelfS0157 客供包材,t1.FHeadSelfS0153 整单工厂交期,t1.FHeadSelfS0155 整单计划开工日期,t1.FHeadSelfS0156 整单计划完工日期,
t1.finterid 单据内码,t1.fdate 制单日期, t4.fname 制单人,(case when t1.fstatus=0 then '' else 'Y' end) 审核,
isnull(t5.fname,'') 审核人,isnull(t1.fcheckdate,Null) 审核日期,isnull(t8.fname,'') 交货方式,t1.FHeadSelfS0143 源采购订单号,
isnull(t15.fname,'') 交付方式,isnull(t14.fname,'') 结算方式,t12.fentryid 分录号,isnull(t2.fname,'') 客户,isnull(t2.fitemid,0) 客户内码,
isnull(t2.faddress ,'') 地址,isnull(t2.fcontact,'') 联系人,isnull(t2.fphone,'') 电话,isnull(t2.ffax,'') 传真,
isnull(t7.fitemid,0) 产品内码,isnull(t7.fnumber,'') 产品编码,isnull(t7.FName,'') 产品名称,isnull(t7.F_105,'')+'///'+ isnull(t7.fmodel,'') 规格型号,
isnull(t10.fitemid,0) 芯片内码,isnull(t10.fnumber,'') 芯片编码,isnull(t10.FName,'') 芯片名称,isnull(t10.F_105,'')+'///'+ isnull(t10.fmodel,'') 芯片规格型号,
isnull(t11.fitemid,0) 半成品内码,isnull(t11.fnumber,'') 半成品编码,isnull(t11.FName,'') 半成品名称,isnull(t11.F_105,'')+'///'+ isnull(t11.fmodel,'') 半成品规格型号,
isnull(t13.fitemid,0) 芯片版本内码,isnull(t13.fnumber,'') 芯片版本编码,isnull(t13.FName,'') 芯片版本名称,
t12.funitid 单位内码,t3.fname 单位,cast(t12.fqty as decimal(24,2)) 订单数,
cast(isnull(t12.FEntrySelfS0169,0) as decimal(24,2)) 已排数,
cast(isnull(t12.FEntrySelfS0170,0) as decimal(24,2)) 可排数,t12.fprice 单价,t12.famount 金额,t12.fnote 备注,
'' 产品包装说明,isnull(t12.fentryselfs0159,'') 包装方案,'' 品牌编码,
(case when t12.fmrpclosed=1 then 'Y' else '' end) 行业务关闭,
(case when t7.ferpclsid=1 then '外购' when t7.ferpclsid=2 then '自制' else '其它' end) 物料属性,
isnull(t6.FBOMNumber,'') BOM编号,(case when t6.fusestatus=1072 then 'Y' else '' end) BOM使用状态
from seorder t1   
inner join t_User t4 on t1.fbillerid=t4.fuserid and t4.fuserid<>0  
left join t_User t5 on t1.fcheckerid=t5.fuserid and t5.fuserid<>0  
inner join SeorderEntry t12 on t1.finterid=t12.finterid  
inner join t_icitem t7 on t12.fitemid=t7.fitemid 
left join t_Organization t2 on t1.fcustid=t2.fitemid
inner join t_measureunit t3 on t3.fitemid=t12.funitid
LEFT OUTER JOIN t_SubMessage t8 ON t1.FFetchStyle = t8.FInterID AND t8.FInterID <>0 
LEFT OUTER JOIN t_Settle t14 ON t1.FSettleID = t14.FItemID AND t14.FItemID <>0 
inner join t_currency t17 on t17.fcurrencyid=t1.fcurrencyid
left join icbom t6 on t6.fitemid=t12.fitemid --and t6.fusestatus=1072
left join t_item t9 on t9.fitemclassid=3002 and t9.fitemid=t12.fentryselfs0158
left join t_icitem t10 on t10.fitemid=t12.fentryselfs0161  --芯片
left join t_icitem t11 on t11.fitemid=t12.fentryselfs0164  --半成品
left join t_item t13 on t13.fitemid=t12.fentryselfs0160  --芯片版本
left join t_submessage t15 on t12.fentryselfs0175=t15.finterid
left join t_supplier t16 on t16.fitemid=t7.F_117 --t3.fsource
left join t_submessage t18 on t18.finterid=t1.fheadselfs0147 and t18.ftypeid=10007

go


IF not EXISTS (select * from sysobjects where name='mycb_t_gridwidth' and xtype='u')  --drop  Table mycb_t_gridwidth
begin
	create table mycb_t_gridwidth 
	(
		fsheet int,fuserid int,fbilltype int,findex int,fwidth int,ftitle varchar(50),ftype int --0 叙事薄 1 编辑
)
end

go


IF EXISTS (select * from sysobjects where name='v_MySchedule' and xtype='v')  drop  view v_MySchedule

go

create view v_MySchedule 
as

select 单据类型,单据编号,作废,一级审核,审核,单据内码,分录号,客户,产品内码,产品编码,产品名称,规格型号,单位,订单数,已排数,可排数,单位内码,可排数 数量,备注,行业务关闭,物料属性,BOM编号,品牌编码,包装方案 from v_MySeOrder
union all
select 单据类型,单据编号,作废,一级审核,审核,单据内码,分录号,客户,产品内码,产品编码,产品名称,规格型号,单位,订单数,已排数,可排数,单位内码,可排数 数量,备注,行业务关闭,物料属性,BOM编号,品牌编码,包装方案 from v_MyPPOrder

go


IF EXISTS (select * from sysobjects where name='My_p_CheckInv' and xtype='p')  drop  procedure My_p_CheckInv

go

create procedure My_p_CheckInv (@Interid int)
as

set nocount on 

declare @ftrantype int

select @ftrantype=ftrantype from icstockbill where finterid=@Interid

CREATE TABLE #TempSumQty(fitemid int,fstockid int,fqty decimal(24,2))

if @ftrantype=24
begin
	insert into #TempSumQty(fitemid,fstockid,fqty)
	select t2.fitemid,t2.FSCStockID,SUM(ROUND(-1*t2.fqty,t3.FQtyDecimal)) fqty
	from icstockbill t1
	inner join icstockbillentry t2 on t1.finterid=t2.finterid
	inner join t_icitem t3 on t2.fitemid=t3.fitemid
	where t1.finterid=@InterId
	group by t2.fitemid,t2.FSCStockID
end
else if @ftrantype=41
begin
	insert into #TempSumQty(fitemid,fstockid,fqty)
	select t2.fitemid,t2.FSCStockID,SUM(ROUND(-1*t2.fqty,t3.FQtyDecimal)) fqty
	from icstockbill t1
	inner join icstockbillentry t2 on t1.finterid=t2.finterid
	inner join t_icitem t3 on t2.fitemid=t3.fitemid
	where t1.finterid=@InterId
	group by t2.fitemid,t2.FSCStockID
end

SELECT u1.FItemID,u1.fstockid,SUM(ROUND(u1.FQty,t1.FQtyDecimal)) AS FQty
INTO #TempSumInv 
FROM ICInventory u1 
INNER JOIN t_ICItemBase t1 ON u1.FItemID = t1.FItemID 
INNER JOIN #TempSumQty t2 ON u1.FItemID = t2.FItemID and u1.fstockid=t2.fstockid
GROUP BY u1.FItemID,u1.fstockid

SELECT t4.fname FStockName,t3.FName,t3.FNumber,-1*t1.FQty AS FBillQty,ISNULL(t2.FQty,0) AS FCurInvQty
FROM #TempSumQty t1 
INNER JOIN t_ICItem t3 ON t1.FItemID=t3.FItemID
LEFT OUTER JOIN #TempSumInv t2 ON t1.FItemID=t2.FItemID and t1.fstockid=t2.fstockid
inner join t_stock t4 on t4.fitemid=t1.fstockid
WHERE (ISNULL(t1.FQty,0)+ISNULL(t2.FQty,0))<=0 
order by t3.fnumber

DROP TABLE #TempSumQty
DROP TABLE #TempSumInv

set nocount off

go

IF not EXISTS (select * from sysobjects where name='My_t_SEScheduleTemp' and xtype='u')  --drop  Table My_t_SEScheduleTemp
begin
	create table My_t_SEScheduleTemp(fuserid int,findex int,fcustbillno varchar(50),
	fbillno varchar(50),fdate varchar(50),fcustno varchar(30),ffacdate varchar(20),
	fpackdate varchar(50),fonlinedate varchar(50),fqty int,ffetchstyle varchar(30),ffacnote varchar(200)) 
end

go



--*****--
--订单进度跟踪表
--exec My_p_GetSESchedule 16394,' where 1=1 and 生产订单号 like ''%%''','全部','全部','全部','全部'

IF EXISTS (select * from sysobjects where name='My_p_GetSESchedule' and xtype='p')  drop  procedure My_p_GetSESchedule

go

create procedure My_p_GetSESchedule (@fuserid int,@filtersql varchar(800),@fmoflag varchar(10),@finflag varchar(10),@foutflag varchar(10),@fcloseflag varchar(10))
as

set nocount on 

--declare @fuserid int,@filtersql varchar(500),@fpoflag varchar(10),@finflag varchar(10),@foutflag varchar(10),@fcloseflag varchar(10) select @fuserid=16394,@filtersql=' where 1=1 and PI号 like ''%%''',@fpoflag='全部',@finflag='全部',@foutflag='未出',@fcloseflag='未关'

--seorder.FHeadSelfS0148 订单交期 和 seorder.FHeadSelfS0154 计划开工日期
create table #seorder (fseinterid int,fqty decimal(24,2) default 0,fqtys decimal(24,0) default 0,fdate datetime,
					   fisfinishconfig bit default 1,fisfinishpacksub bit default 1,fmrpclosed int)  --销售
create table #icmo (fseinterid int,fmoqty decimal(24,2),fqtyfinish decimal(24,2),fplanbegindate datetime,
				    fplancommitdate datetime,factbegindate datetime,fmoclosedqty decimal(24,2) default 0)  --任务
create table #poorder (fseinterid int,fpointerid int,fpoqty decimal(24,2))
create table #poinstock (fseinterid int,fpointerid int,fpoinstockqty decimal(24,2))
create table #icstockbill1 (fseinterid int,fpointerid int,finstockqty decimal(24,2))
create table #icstockbill2 (fseinterid int,finstockqty decimal(24,2))   --产品入库
create table #seoutstock (fseinterid int,fseoutstockqty decimal(24,2))  --发货
create table #icstockbill21 (fseinterid int,foutstockqty decimal(24,2)) --出库

create table #data(fseinterid int,fplancommitdate datetime,fplanbegindate datetime,factbegindate datetime,
fsellqty decimal(24,2),fpointerid int,fmoqty decimal(24,2),fqtyfinish decimal(24,2),fmoclosedqty decimal(24,2) default 0, /*结案数量*/
fpoinstockqty decimal(24,2),finstockqty decimal(24,2),fseoutstockqty decimal(24,2),foutstockqty decimal(24,2))

create table #cust(fitemid int)

If @FUserid = 16394 or exists (select * from t_group where fgroupid=1 and fuserid=@FUserid) --administrator
   or exists (Select t2.fname,t1.FUserID,t1.FType,t1.FClassID,t1.FAccess 
				  from t_DataTypeRight t1
				  inner  join t_user t2 on t1.fuserid=t2.fuserid
				  where t1.FType=1 and t1.FClassID=1 and t1.FAccess=24 and t1.fuserid=@fuserid)
begin
  	insert into #cust(fitemid) select fitemid from t_Organization
end
else
begin
	insert into #cust(fitemid)
	Select t1.fitemid--,t1.FViewAccess   
	From   
	(   
	select t1.FItemID,min(t1.FParentIDX) as FParentIDX   
	,(case when max(substring(t1.FdataAccessDelete,t0.FaccessUUID/8+1,1) & power(2,7-(t0.FaccessUUID+7)%8))>0 then 1 else 0 end) as FDeleteAccess   
	,(case when max(substring(t1.FDataAccessEdit,t0.FaccessUUID/8+1,1) & power(2,7-(t0.FaccessUUID+7)%8))>0 then 1 else 0 end ) as  FEditAccess   
	,(case when max(substring(t1.FDataAccessView,t0.FaccessUUID/8+1,1) & power(2,7-(t0.FaccessUUID+7)%8))>0 then 1 else 0 end) as FViewAccess   
	from t_user t0 
		inner join Access_t_Organization t1 on t0.FuserID=@fuserid    
	group by t1.FItemID   
	) t1 inner join t_Item t2 on t1.FItemID=t2.FItemID and t2.FItemClassID=1   
	Where t1.FItemID > 0 And t1.FViewAccess = 1 
End 

insert into #seorder(fseinterid, fqty,                   fdate,        fmrpclosed)  --销售订单
select               t2.finterid,sum(t2.FEntrySelfS0188),min(t2.fdate),min(t2.fmrpclosed) 
from seorder t1  
inner join seorderentry t2 on t1.finterid=t2.finterid
inner join t_icitem t4 on t4.fitemid=t2.fitemid
inner join t_Organization t5 on t1.fcustid=t5.fitemid 
where --t5.fname like '%'+@fcustname+'%' and t1.fbillno like '%'+@fsebillno+'%' and
t1.fcustid in (select fitemid from #cust) 
--and t4.fnumber not like 'H.%' and t4.fnumber not like 'K.%' and t4.fnumber not like 'M.%' and t4.fnumber not like 'N.%'
and (t1.fstatus>0 or isnull(t1.FMultiCheckLevel1,0)>0) and t1.finterid in (select distinct finterid from seorderentry where fmrpclosed=0) --and t1.fstatus<>3 
and t1.FCancellation=0
and exists (select 1 from icmo where forderinterid=t2.finterid and fsourceentryid=t2.fentryid)  --下了生产任务单才给交期
group by t2.finterid

--select * from seorder where fbillno='xw1506133'
--select * from #seorder where fseinterid=5496



--update t2 set fisfinishconfig=0
--from
--(
--	select distinct t2.finterid
--	from seorder t1  
--	inner join seorderentry t2 on t1.finterid=t2.finterid
--	inner join t_icitem t4 on t4.fitemid=t2.fitemid
--	left join t_icitem t9 on t9.fitemid=t2.fentryselfs0164  --半成品
--	left join t_icitem t10 on t10.fitemid=t2.fentryselfs0161  --芯片
--	left join t_item t13 on t13.fitemid=t2.fentryselfs0160 and t13.fitemclassid=3006 --芯片版本  --16465  无芯片
--	where (left(t4.fnumber,1) in ('A','P') and t4.ferpclsid=2 and isnull(t9.fitemid,0)=0) 
--	or (isnull(t13.fitemid,0)<>16465 and isnull(t10.fitemid,0)=0)
--) t1 inner join #seorder t2 on t1.finterid=t2.fseinterid

--update t2 set fisfinishpacksub=0
--from
--(
--	select distinct t2.finterid
--	from seorder t1  
--	inner join seorderentry t2 on t1.finterid=t2.finterid
--	inner join t_icitem t4 on t4.fitemid=t2.fitemid
--	inner join t_item t9 on t9.fitemclassid=3002 and t9.fitemid=t2.fentryselfs0158
--	left join t_BOSPackSub t11 on t11.fproductid=t2.fitemid and t11.fbrandid=t2.fentryselfs0158  --包装方式
--	where t9.fname not like '%裸包%' and isnull(t11.fid,0)=0
--) t1 inner join #seorder t2 on t1.finterid=t2.fseinterid

select t1.finterid,sum(fcount1) fcount1,sum(fcount2) fcount2 into #sedata
from
(
	select t1.finterid,
	(case when t4.ferpclsid=1 then 1 else 0 end) fcount1,
	(case when t4.ferpclsid<>1 then 1 else 0 end) fcount2 
	from seorder t1
	inner join #seorder t2 on t1.finterid=t2.fseinterid
	inner join seorderentry t3 on t3.finterid=t1.finterid
	inner join t_icitem t4 on t3.fitemid=t4.fitemid
) t1
group by t1.finterid

/*
insert into #poorder(fseinterid,fpointerid,fpoqty)  --销售订单->采购订单
select t1.fsourceinterid,t1.finterid,sum(t1.fqty)
from poorderentry t1
inner join poorder t2 on t1.finterid=t2.finterid
inner join #seorder t3 on t3.fseinterid=t1.fsourceinterid
group by t1.fsourceinterid,t1.finterid

insert into #poinstock(fseinterid,fpointerid,fpoinstockqty)  --销售订单->采购订单->收料通知
select t3.fseinterid,t3.fpointerid,sum(t1.fqty)
from poinstockentry t1
inner join poinstock t2 on t1.finterid=t2.finterid
inner join #poorder t3 on t3.fpointerid=t1.fsourceinterid
group by t3.fseinterid,t3.fpointerid

insert into #icstockbill1(fseinterid,fpointerid,finstockqty)  --销售订单->采购订单->收料通知->外购入库/虚仓入库
select t3.fseinterid,t3.fpointerid,sum(t3.fqty)
from
(
	select t3.fseinterid,t3.fpointerid,t1.fqty  --外购入库
	from icstockbillentry t1
	inner join icstockbill t2 on t1.finterid=t2.finterid
	inner join poinstockentry t4 on t4.finterid=t1.fsourceinterid and t4.fentryid=t1.fsourceentryid and t4.fitemid=t1.fitemid
	inner join poinstock t5 on t4.finterid=t5.finterid
	inner join #poorder t3 on t3.fpointerid=t4.fsourceinterid
	where t2.ftrantype=1
	union all
	select t3.fseinterid,t3.fpointerid,t1.fqty  --虚仓入库
	from zpstockbillentry t1
	inner join zpstockbill t2 on t1.finterid=t2.finterid
	inner join poinstockentry t4 on t4.finterid=t1.fsourceinterid and t4.fentryid=t1.fsourceentryid and t4.fitemid=t1.fitemid
	inner join poinstock t5 on t4.finterid=t5.finterid
	inner join #poorder t3 on t3.fpointerid=t4.fsourceinterid
	where t2.ftrantype=6
) t3
group by t3.fseinterid,t3.fpointerid
*/

insert into #icmo(fseinterid,   fmoclosedqty,fmoqty,      fqtyfinish,        fplanbegindate,      fplancommitdate,     factbegindate)  --销售订单->任务单
select            t3.fseinterid,sum(case when t2.fstatus=3 then t2.fqty-t2.fstockqty else 0 end),
											  sum(t2.FHeadSelfJ0183),sum(t2.FQtyFinish),min(t5.fminplandate),min(t5.fmaxplandate),min(t4.fminrptdate)
from seorderentry t1
inner join icmo t2 on t1.finterid=t2.FOrderInterID and t1.fentryid=t2.FSourceEntryID and t1.fitemid=t2.fitemid
inner join #seorder t3 on t3.fseinterid=t1.finterid
left join 
(
	select t1.fsourceinterid,min(t2.fheadselfj1112) fminrptdate
	from ICMORptEntry t1 
	inner join ICMORpt t2 on t1.finterid=t2.finterid
	group by t1.fsourceinterid
) t4 on t2.finterid=t4.fsourceinterid
left join 
(
	select t1.ficmointerid,min(t1.fdate) fminplandate,max(t1.fdate) fmaxplandate
	from my_t_scheduledetail t1 
	where isnull(t1.ficmointerid,0)<>0
	group by t1.ficmointerid
) t5 on t2.finterid=t5.ficmointerid
group by t3.fseinterid


insert into #icstockbill2(fseinterid,finstockqty)  --销售订单->任务单->产品入库
select t3.fseinterid,sum(t4.FEntrySelfA0238)
from seorderentry t1
inner join icmo t2 on t1.finterid=t2.FOrderInterID and t1.fentryid=t2.FSourceEntryID and t1.fitemid=t2.fitemid
inner join #seorder t3 on t3.fseinterid=t1.finterid
inner join icstockbillentry t4 on t4.ficmointerid=t2.finterid
inner join icstockbill t5 on t5.finterid=t4.finterid
where t5.ftrantype=2
group by t3.fseinterid

insert into #seoutstock(fseinterid,fseoutstockqty)  --销售订单->发货通知
select t3.fseinterid,sum(t1.FEntrySelfS0238)
from seoutstockentry t1
inner join seoutstock t2 on t1.finterid=t2.finterid
inner join #seorder t3 on t3.fseinterid=t1.fsourceinterid
group by t3.fseinterid

insert into #icstockbill21(fseinterid,foutstockqty)  --销售订单->发货通知->销售出库/其它出库/虚仓出库
select t3.fseinterid,sum(t3.fqty)
from
(
	select t3.fseinterid,t1.FEntrySelfB0160 fqty  --销售出库
	from icstockbillentry t1
	inner join icstockbill t2 on t1.finterid=t2.finterid
	inner join seoutstockentry t5 on t5.finterid=t1.fsourceinterid and t5.fentryid=t1.fsourceentryid and t5.fitemid=t1.fitemid
	inner join seoutstock t6 on t5.finterid=t6.finterid
	inner join #seorder t3 on t3.fseinterid=t5.fsourceinterid
	where t2.ftrantype in (21)
	union all
	select t3.fseinterid,t1.fqty  --其它出库
	from icstockbillentry t1
	inner join icstockbill t2 on t1.finterid=t2.finterid
	inner join seoutstockentry t5 on t5.finterid=t1.fsourceinterid and t5.fentryid=t1.fsourceentryid and t5.fitemid=t1.fitemid
	inner join seoutstock t6 on t5.finterid=t6.finterid
	inner join #seorder t3 on t3.fseinterid=t5.fsourceinterid
	where t2.ftrantype in (29)
	union all
	select t3.fseinterid,t1.fqty  --虚仓出库
	from zpstockbillentry t1
	inner join zpstockbill t2 on t1.finterid=t2.finterid
	inner join seoutstockentry t5 on t5.finterid=t1.fsourceinterid and t5.fentryid=t1.fsourceentryid and t5.fitemid=t1.fitemid
	inner join seoutstock t6 on t5.finterid=t6.finterid
	inner join #seorder t3 on t3.fseinterid=t5.fsourceinterid
	where t2.ftrantype in (26)
) t3
group by t3.fseinterid


insert into #data(fseinterid,fmoqty,fpoinstockqty,finstockqty,fseoutstockqty,foutstockqty)
select            fseinterid,0     ,0,            0,          0,             0
from #seorder t1

/*

update t1 set fpoinstockqty=t2.fpoinstockqty
from #data t1 
inner join #poinstock t2 on t1.fseinterid=t2.fseinterid and t1.fpointerid=t2.fpointerid 

update t1 set finstockqty=t2.finstockqty
from #data t1 
inner join #icstockbill1 t2 on t1.fseinterid=t2.fseinterid and t1.fpointerid=t2.fpointerid 
*/

update t1 set fmoqty=t2.fmoqty,fqtyfinish=t2.fqtyfinish,fplanbegindate=t2.fplanbegindate,
fplancommitdate=t2.fplancommitdate,factbegindate=t2.factbegindate,fmoclosedqty=t2.fmoclosedqty  --生产任务
from #data t1 
inner join #icmo t2 on t1.fseinterid=t2.fseinterid 


/*

update t1 set fpoinstockqty=t2.fpoinstockqty
from #data t1 
inner join #poinstock t2 on t1.fseinterid=t2.fseinterid and t1.fpointerid=t2.fpointerid 

update t1 set finstockqty=t2.finstockqty
from #data t1 
inner join #icstockbill1 t2 on t1.fseinterid=t2.fseinterid and t1.fpointerid=t2.fpointerid 
*/

update t1 set finstockqty=t2.finstockqty  --产品入库
from #data t1 
inner join #icstockbill2 t2 on t1.fseinterid=t2.fseinterid 

update t1 set fseoutstockqty=t2.fseoutstockqty  --发货通知
from #data t1 
inner join #seoutstock t2 on t1.fseinterid=t2.fseinterid 

update t1 set foutstockqty=t2.foutstockqty   --销售出库
from #data t1 
inner join #icstockbill21 t2 on t1.fseinterid=t2.fseinterid 

update t1 set fsellqty=t2.fqty   --销售订单
from #data t1 
inner join #seorder t2 on t1.fseinterid=t2.fseinterid 


if @fmoflag='已下'  --表示全部都已下--删除掉部分或者全部未下的
begin
	delete from #seorder where fseinterid in 
	(
		select t1.fseinterid 
		from #seorder t1 
		left join #data t2 on t1.fseinterid=t2.fseinterid 
		group by t1.fseinterid 
		having min(t1.fqty)>sum(isnull(t2.fmoqty,0))
	)
end 

if @fmoflag='未下'  --表示部分或者全部未下--删除掉已经全部下了的
begin
	delete from #seorder where fseinterid in 
	(
		select t1.fseinterid 
		from #seorder t1 
		left join #data t2 on t1.fseinterid=t2.fseinterid 
		group by t1.fseinterid 
		having min(t1.fqty)<=sum(isnull(t2.fmoqty,0))
	)
end 

if @finflag='已入'  --表示全部都已入--删除掉部分或者全部未入的
begin
	delete from #seorder where fseinterid in 
	(
		select t1.fseinterid 
		from #seorder t1 
		left join #data t2 on t1.fseinterid=t2.fseinterid 
		group by t1.fseinterid 
		having min(t1.fqty)>sum(isnull(t2.finstockqty,0))
	)
end 

if @finflag='未入'  --表示部分或者全部未入--删除掉已经全部入了的
begin
	delete from #seorder where fseinterid in 
	(
		select t1.fseinterid 
		from #seorder t1 
		left join #data t2 on t1.fseinterid=t2.fseinterid 
		group by t1.fseinterid 
		having min(t1.fqty)<=sum(isnull(t2.finstockqty,0))
	)
end 


if @fcloseflag='已关'  --删掉未关闭的
begin
	delete from #seorder where fseinterid in 
	(
		select t1.fseinterid 
		from #seorder t1 
		left join #data t2 on t1.fseinterid=t2.fseinterid 
		inner join seorder t3 on t3.finterid=t1.fseinterid
		where t3.fstatus<>3
	)
end 

if @fcloseflag='未关'  --删掉已关闭的且整单都已经行业务关闭
begin
	delete from #seorder where fseinterid in 
	(
		select t1.fseinterid 
		from #seorder t1 
		left join #data t2 on t1.fseinterid=t2.fseinterid 
		inner join seorder t3 on t3.finterid=t1.fseinterid
		where t3.fstatus=3 and t1.fmrpclosed=1
	)
end 

if @foutflag='已出'  --表示全部都已出--删除掉部分或者全部未出的
begin
	delete from #seorder where fseinterid in 
	(
		select t1.fseinterid 
		from #seorder t1 
		left join #data t2 on t1.fseinterid=t2.fseinterid 
		group by t1.fseinterid 
		having min(t1.fqty)>max(isnull(t2.foutstockqty,0))
	)
end 

if @foutflag='未出'  --表示部分或者全部未出--删除掉已经全部出了的
begin
	delete from #seorder where fseinterid in 
	(
		select t1.fseinterid 
		from #seorder t1 
		left join #data t2 on t1.fseinterid=t2.fseinterid 
		group by t1.fseinterid 
		having min(t1.fqty)<=max(isnull(t2.foutstockqty,0))
	)
end 

declare @fsql varchar(5000) --都有装箱单字样，写在后面

set @fsql=' select * from (
select t1.FHeadSelfS0144 源销售订单号,t1.FHeadSelfS0143 源采购订单号,t1.fbillno 生产订单号,t1.fdate 下单日期,t5.fshortnumber 客户编码,t5.fname 客户名称,
case when t14.fcount1>0 and t14.fcount2=0 then ''WG'' 
     when t14.fcount1=0 and t14.fcount2>0 then ''ZZ'' 
     when t14.fcount1>0 and t14.fcount2>0 then ''ZZWG'' 
end 单据类型, t9.fname 部门,t7.fisfinishconfig 产品配置,t7.fisfinishpacksub 包装方案,--t7.fqtys 订单总数,
t7.fqty 订单数,
--t1.FHeadSelfS0152 工厂包材,t1.FHeadSelfS0142 客供包材,t1.FHeadSelfS0149 上线日期,t1.FHeadSelfS0150 装配完工日期,
isnull(t1.FHeadSelfS0148,''1900-01-01'') 订单交期,isnull(t1.FHeadSelfS0148,''1900-01-01'') 订单交期_OLD,
t1.FHeadSelfS0154 计划开工日期,t1.FHeadSelfS0154 计划开工日期_OLD,
t2.fplancommitdate 计划完工日期,t2.factbegindate 实际开工日期,isnull(t1.FHeadSelfS0149,'''') 工厂备注,isnull(t1.FHeadSelfS0157,'''') 其它备注,
--t3.fbillno PO单号,t3.fdate PO下单日期,isnull(t13.fname,'''') 采购员,isnull(t4.fshortname,'''') 供应商,isnull(t2.fpoqty,0) 采购数,isnull(t3.FHEADSELFP0244,'''') 包装说明,
t6.fname 业务员,--isnull(t1886.fname,'''') 验货说明,
--isnull(t10.fponote,'''') 采购备注,isnull(fpoinstockqty,0) 收料数,
isnull(t2.fmoqty,0) 任务数,isnull(t2.fmoclosedqty,0) 结案数,isnull(t2.fqtyfinish,0) 汇报数,isnull(t2.finstockqty,0) 入库数,(isnull(t2.fmoqty,0)-isnull(t2.finstockqty,0)) 未入库数,
isnull(fseoutstockqty,0) 发货通知数,isnull(foutstockqty,0) 出库数,
--isnull(t10.fplanoutdate,'''') 计划出货日期,isnull(t10.foutplace,'''') 发货地点,isnull(t10.fshipnote,'''') 船务备注,isnull(t1890.fname,'''') 出口国家, 
isnull(t8.fname,'''') 运输方式,(case when t15.fseinterid is null then '''' else ''Y'' end) MRP
--isnull(t10.fzxdpath,'''') 装箱单内码,(case when isnull(t10.fzxdpath,'''')<>'''' then ''Y'' else '''' end) 装箱单  
from seorder t1 
inner join #seorder t7 on t7.fseinterid=t1.finterid 
left join #data t2 on t1.finterid=t2.fseinterid  
--left join poorder t3 on t3.finterid=t2.fpointerid 
inner join t_Organization t5 on t1.fcustid=t5.fitemid 
inner join t_emp t6 on t1.FEmpID=t6.fitemid
inner join t_department t9 on t9.fitemid=t1.fdeptid
--left join t_supplier t4 on t4.fitemid=t3.fsupplyid
--LEFT OUTER JOIN t_Item t1890 ON   t1.FHeadSelfS0146 = t1890.FItemID  AND t1890.FItemID<>0 
LEFT OUTER JOIN t_SubMessage t8 ON t1.FFetchStyle = t8.FInterID   AND t8.FInterID <>0 
--LEFT OUTER JOIN t_SubMessage t1886 ON t1.FHeadSelfS0142 = t1886.FInterID  AND t1886.FInterID<>0 
--left join My_t_SESchedule t10 on t10.fseinterid=t2.fseinterid and t10.fpointerid=t2.fpointerid
inner join #cust t12 on t1.fcustid=t12.fitemid 
--left join t_user t13 on t13.fuserid=t3.fbillerid 
left join #sedata t14 on t14.finterid=t1.finterid
left join (select distinct forderinterid fseinterid from my_t_MrpSeOrder where fselect=1) t15 on t15.fseinterid=t1.finterid
) m1 ' +@filtersql +''


--print @fsql

execute (@fsql)


drop table #seorder
drop table #sedata
drop table #poorder
drop table #poinstock
drop table #icstockbill1
drop table #seoutstock
drop table #icstockbill21
drop table #cust
drop table #data
drop table #icmo

drop table #icstockbill2


set nocount off

go


IF EXISTS (select * from sysobjects where name='v_MySEScheduleFilter' and xtype='v')  drop  view v_MySEScheduleFilter

go

create view v_MySEScheduleFilter --这里用到的字段必须和My_p_GetSESchedule一样
as

select '' 客户编码,'' 客户名称,'' 源销售订单号,'' 源采购订单号,'' 业务员,'' 生产订单号,'' 下单日期, '' 订单交期,'' 入库数

go


--标准成本变更联络
IF not EXISTS (select * from sysobjects where name='MyStdCostChange' and xtype='u') --drop Table MyStdCostChange 
begin
CREATE TABLE MyStdCostChange(
	finterid int not null,
	fbillno varchar(50) not null,
	fdate datetime not null,
	fcheckdate datetime ,
	fsubid int,ftrantype varchar(50),
	fbillerid int not null,
	fmodifierID int,
	fmodifytime datetime,
	fbilltime datetime,
	fchecktime datetime,
	fcheckerid int,
	fstatus int default(0),--3 关闭--业务执行完毕
	fnote varchar(500),
	CONSTRAINT [PK_MyStdCostChange] PRIMARY KEY CLUSTERED 
	(
		[finterid] ASC
	)WITH  FILLFACTOR = 90 ON [PRIMARY]
) ON [PRIMARY]
end

go


IF not EXISTS (select * from sysobjects where name='MyStdCostChangeEntry' and xtype='u')  --drop Table MyStdCostChangeEntry
begin
CREATE TABLE MyStdCostChangeEntry(
	FInterID int NOT NULL,
	FEntryID int NOT NULL,

	FManHour1 int,FManHour2 int,--标准工时

	fpiecefee1 decimal(24,4) default(0), --人工
	fpiecefee2 decimal(24,4) default(0), --人工

	ffinancefee1 decimal(24,4) default(0), --制造 
	ffinancefee2 decimal(24,4) default(0), --制造 

	fchangetype varchar(200),--变更类型
	FItemID int NOT NULL,
	FUnitID int default(0),
	FNote varchar(500) NULL,
	CONSTRAINT [PK_MyStdCostChangeEntry] PRIMARY KEY CLUSTERED 
	(
		FInterID ASC,
		FEntryID ASC
	) ON [PRIMARY]
) ON [PRIMARY]
end

go


IF EXISTS (select * from sysobjects where name='v_MyStdCostChange' and xtype='v')  drop  view v_MyStdCostChange

go

create view v_MyStdCostChange 
as

select t1.fbillno 单据编号,isnull(t1.ftrantype,'') 单据类型,t1.finterid 单据内码,t1.fdate 制单日期, t4.fname 制单人,
(case when t1.fstatus=0 then '' when t1.fstatus=1 then 'Y' end) 审核,isnull(t5.fname,'') 审核人,
isnull(t1.fcheckdate,Null) 审核日期,t1.fnote 备注
from MyStdCostChange t1   
inner join t_User t4 on t1.fbillerid=t4.fuserid and t4.fuserid<>0  
left join t_User t5 on t1.fcheckerid=t5.fuserid and t5.fuserid<>0  


go


IF EXISTS (select * from sysobjects where name='v_MyStdCostChangeDetail' and xtype='v')  drop  view v_MyStdCostChangeDetail

go

create view v_MyStdCostChangeDetail 
as

select t1.fbillno 单据编号,t1.finterid 单据内码,t1.fdate 制单日期, t4.fname 制单人,
(case when t1.fstatus=0 then '' when t1.fstatus=1 then 'Y' end) 审核,
isnull(t5.fname,'') 审核人,isnull(t1.fcheckdate,Null) 审核日期,
--t7.fnumber 厂商编码,t7.fname 厂商名称,t7.fitemid 厂商内码,
isnull(t3.fnumber,'') 物料编码,t2.fitemid 物料内码,isnull(t3.fname,'') 名称,isnull(t3.fmodel,'') 规格型号,
isnull(t3.f_111,'') 描述,isnull(t3.f_104,'') 适用区域,isnull(t3.f_103,'') 适用机型, isnull(t10.fname,'') 系列,
(case when t1.fstatus>0 then t2.FManHour1 else isnull(t3.FStandardManHour,0) end) [old-标准工时(H)],t2.FManHour2 [标准工时(H)],
(case when t1.fstatus>0 then t2.fpiecefee1 else isnull(t3.FPieceRate,0) end) [old-人工],t2.fpiecefee2 [人工],
(case when t1.fstatus>0 then t2.ffinancefee1 else isnull(t3.FStdFixFeeRate,0) end) [old-制造费],t2.ffinancefee2 [制造费],
t3.funitid 单位内码,t6.fname 单位,t2.fnote 备注,t2.fchangetype 变更类型
from MyStdCostChange t1   
inner join MyStdCostChangeEntry t2 on t1.finterid=t2.finterid
left join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_User t4 on t1.fbillerid=t4.fuserid and t4.fuserid<>0  
left join t_User t5 on t1.fcheckerid=t5.fuserid and t5.fuserid<>0  
left join t_measureunit t6 on t6.fitemid=t3.funitid
left join t_supplier t7 on t7.fitemid=t3.fsource
left join t_item t10 on t10.fitemclassid=3005 and t3.F_107=t10.fitemid

go


--标准成本联络变更--暂未使用
IF EXISTS (select * from sysobjects where name='My_Tri_MyStdCostChange'  and xtype='TR')  drop  TRIGGER My_Tri_MyStdCostChange
go

Create TRIGGER My_Tri_MyStdCostChange ON [dbo].MyStdCostChange
FOR UPDATE

AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
	declare @iMaxIndex int,@fname2 varchar(500),@fmodel2 varchar(500),@fdescription2 varchar(500),@FCompatArea2 varchar(500),@FCompatModel2 varchar(500),@FNetWeight2 decimal(24,2),@FLength2 decimal(24,2),@FWidth2 decimal(24,2),@FHeight2 decimal(24,2)
	declare @FBoxSize1 varchar(50),@FBoxSize2 varchar(50),@FColourSize1 varchar(50),@FColourSize2 varchar(50),@FStandardQty1 int,@FStandardQty2 int
	declare @FInterID int ,@fcheckerid int,@fsource int,@FManHour1 decimal(24,4),@FManHour2 decimal(24,4)
	declare @FMyInterID int ,@FSupplyId int,@fusername varchar(30),@funitid int,@fnumber varchar(30)
	declare @fcurrencyid int,@FPType int,@fstartqty int,@fendqty int,@fnote varchar(500)
	declare @fbillno varchar(30),@fitemid int,@fprice decimal(24,4),@ftempprice decimal(24,4)
	declare @fpiecefee1 decimal(24,4),@fpiecefee2 decimal(24,4),@ffinancefee1 decimal(24,4),@ffinancefee2 decimal(24,4)
	declare @fstatus int,@fsubid int,@foldprice1 decimal(24,4),@foldprice2 decimal(24,4),@foldprice3 decimal(24,4)
	declare @fdate datetime,@freasonid int,@FShortNumber varchar(20),@FParentNumber varchar(20)
	declare @fuserid int ,@ftrantype varchar(50),@FParentID int
	select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期

	declare @findex int,@fprice1 decimal(24,4),@fprice2 decimal(24,4),@fprice3 decimal(24,4)
	declare @fbegqty1 int,@fendqty1 int,@fbegqty2 int,@fendqty2 int,@fbegqty3 int,@fendqty3 int


    -- Insert statements for trigger here
	--select @iMaxIndex=isnull(max(findex)+1,1) from MY_T_NETCONTROL where fuserid=1 and fbilltype=-1

	select top 1 @ftrantype=ftrantype,@fcheckerid=isnull(fcheckerid,0),@fbillno=fbillno,@FInterID=finterid,@fuserid=fbillerid from INSERTED 
	
	--select @fbegqty1=fbegqty1,@fendqty1=fendqty1,@fbegqty2=fbegqty2,@fendqty2=fendqty2,@fbegqty3=fbegqty3,@fendqty3=fendqty3 from my_t_PricePolicy where fsubid=@fsubid

	if update(fcheckerid) and @fcheckerid>0
	begin
		select @fusername=fname from t_user where fuserid=@fcheckerid

		--先取得最新的信息
		update t1 set FManHour1=t2.FStandardManHour,fpiecefee1=t2.FPieceRate,ffinancefee1=t2.FStdFixFeeRate
		from MyStdCostChangeEntry t1
		inner join t_icitem t2 on t1.fitemid=t2.fitemid
		where t1.finterid=@FInterID

		DECLARE Seorder_Cursor CURSOR FOR
		select t1.fitemid,t1.FManHour2,t1.fpiecefee2,t1.ffinancefee2
		from MyStdCostChangeEntry t1
		where t1.finterid=@FInterID

		OPEN Seorder_Cursor

		FETCH NEXT FROM Seorder_Cursor 
		INTO @fitemid,@FManHour2,@fpiecefee2,@ffinancefee2

		WHILE @@FETCH_STATUS = 0
		BEGIN
			if @ftrantype='修改'
			begin
				update t_ICItemStandard set FStandardManHour=@FManHour2,FPieceRate=@fpiecefee2,FStdFixFeeRate=@ffinancefee2 where fitemid=@fitemid
				update t_BaseProperty set FLastModDate=getdate(), FLastModUser=@fusername where fitemid=@fitemid
			end
			else
			begin
				select @FShortNumber=REVERSE(left(REVERSE(@fnumber),CHARINDEX('.',REVERSE(@fnumber))-1))
				select @FParentNumber=REVERSE(right(REVERSE(@fnumber),len(@fnumber)-CHARINDEX('.',REVERSE(@fnumber))))

				select @FParentID=fitemid from t_item where fnumber=@FParentNumber and fdetail=0 and fitemclassid=4

				/*
				INSERT INTO t_Item (FItemClassID,FParentID, FLevel,FName,   FNumber, FShortNumber,  FFullNumber,FDetail,UUID,     FDeleted) VALUES (
								   (4,           @FParentID,4,     @fname2, @fnumber,@FShortNumber, @fnumber,   1,      newid() , 0

				INSERT INTO t_Log (FDate,    FUserID,      FFunctionID,FStatement,FDescription,                                  FMachineName,FIPAddress) 
				VALUES 		      (getdate(),@fcheckerid,  'A00701',   5,         '新建核算项目:'+@fnumber+' 核算项目类别:物料','KSW103',    '192.168.0.89')
				
				select @fitemid=FItemID,@ffullname=ffullname from t_Item where fdetail=1 and fitemclassid=4 and fnumber=@fnumber
		
				INSERT INTO t_ICItem (FHelpCode,FModel,   FAuxClassID,FErpClsID,FTypeID,FUnitGroupID,FUnitID,FOrderUnitID,FSaleUnitID,FProductUnitID,FStoreUnitID,FSecUnitID,FSecCoefficient,  FDefaultLoc,FSPID,FSource,FQtyDecimal,FLowLimit,FHighLimit,FSecInv,FUseState,FIsEquipment,FEquipmentNum,FIsSparePart,FFullName,  FApproveNo,FAlias,FOrderRector,FPOHighPrice,FPOHghPrcMnyType,FWWHghPrc,FWWHghPrcMnyType,FSOLowPrc,FSOLowPrcMnyType,FIsSale,FProfitRate,FOrderPrice,FSalePrice,FIsSpecialTax,FISKFPeriod,FKFPeriod,FStockTime,FBatchManager,FBookPlan,FBeforeExpire,FCheckCycUnit,FOIHighLimit,FOILowLimit,FSOHighLimit,FSOLowLimit,FInHighLimit,FInLowLimit,FTrack,FPlanPrice,FPriceDecimal,FAcctID,FSaleAcctID,FCostAcctID,FAPAcctID,FAdminAcctID,FGoodSpec,FTaxRate,FCostProject,FIsSNManage,FNote,F_102,          F_103,          F_104,f_115, f_114, F_107,F_108,F_109,F_110,F_111, F_112,F_113,FPlanTrategy,FOrderTrategy,FFixLeadTime,FLeadTime,FTotalTQQ,FOrderInterVal,FQtyMin,FQtyMax,FBatchAppendQty,FOrderPoint,FBatFixEconomy,FBatChangeEconomy,FRequirePoint,FPlanPoint,FDefaultRoutingID,FDefaultWorkTypeID,FProductPrincipal,FPlanner,FPutInteger,FDailyConsume,FMRPCon,FMRPOrder,FChartNumber,FIsKeyItem,FGrossWeight,FNetWeight,  FMaund,FLength, FWidth, FHeight,  FSize,FCubicMeasure,FStandardCost,FStandardManHour,FStdPayRate,FChgFeeRate,FStdFixFeeRate,FOutMachFee,FPieceRate,FInspectionLevel,FProChkMde,FWWChkMde,FSOChkMde,FWthDrwChkMde,FStkChkMde,FOtherChkMde,FStkChkPrd,FStkChkAlrm,FInspectionProject,FIdentifier,FVersion,FNameEn,FModelEn,FHSNumber,FFirstUnit,FSecondUnit,FImpostTaxRate,FConsumeTaxRate,FFirstUnitRate,FSecondUnitRate,FIsManage,FManageType,FLenDecimal,FCubageDecimal,FWeightDecimal,FIsCharSourceItem,FShortNumber, FNumber, FName, FParentID, FItemID) 
				              VALUES (NULL,     @fmodel2, 0,          1,        0,       130,        131,    131,         131,        131,           131,         0,         0,                0,          0,    0,      0,          0,        0,         0,      341,      0,            NULL,        0,           @ffullname, NULL,      NULL,  0,           0,           1,               0,        1,               0,        1,               0,      0,          0,          0,         0,            0,          0,        0,         1,            0,        0,            0,            0,           0,          0,           0,          0,           0,          80,    0,         4,            1016,   1125,       1126,       0,        0,           0,        17,      0,           0,          NULL, @FCompatModel2, @fdescription2, 0,    13627, 0,     NULL, NULL, NULL, 40062, 0,    0,    0,    321,         331,          0,           1,        0,        0,             1,      10000,  1,              0,          0,             1,                1,            1,         0,                0,                 0,                0,       0,          0,            1,      0,        NULL,        0,         0,           @FNetWeight2,0,     @FLength,@FWidth,@FHeight, 0,    0,            0,            0,               0,          0,          0,             0,          0,         352,             352,       352,      352,      352,          352,       352,         9999,      0,          0,                 0,          NULL,    NULL,   NULL,    0,        NULL,      NULL,       0,             0,              0,             0,              0,        0,          2,          4,             2,             0,                @FShortNumber,@FNumber,@FName,@FParentID,@FItemID
					   --select top 1 NULL,     @fmodel2, 0,          1,        0,      FUnitGroupID,FUnitID,FOrderUnitID,FSaleUnitID,FProductUnitID,FStoreUnitID,0,         0,                0,          0,    0,      0,          0,        0,         0,      341,      0,            NULL,        0,           @ffullname, NULL,      NULL,  0,           0,           1,               0,        1,               0,        1,               0,      0,          0,          0,         0,            0,          0,        0,         FBatchManager,0,        0,            0,            0,           0,          0,           0,          0,           0,          80,    0,         FPriceDecimal,FAcctID,FSaleAcctID,FCostAcctID,0,        0,           0,        FTaxRate,0,           0,          NULL, @FCompatModel2, @fdescription2, 0,    f_115, f_114, NULL, NULL, @FCompatArea2, F_110, 0,     0,    0,    321,         331,          0,           1,        0,        0,             1,      10000,  1,              0,          0,             1,                1,            1,         0,                0,                 0,                0,       0,          0,            1,      0,        NULL,        0,         0,           @FNetWeight2,0,     @FLength,@FWidth,@FHeight, 0,    0,            0,            0,               0,          0,          0,             0,          0,         352,             352,       352,      352,      352,          352,       352,         9999,      0,          0,                 0,          NULL,    NULL,   NULL,    0,        NULL,      NULL,       0,             0,              0,             0,              0,        0,          2,          4,             2,             0,                @FShortNumber,@FNumber,@FName,@FParentID,@FItemID

				Insert Into t_BaseProperty(FTypeID, FItemID,  FCreateDate, FCreateUser, FLastModDate, FLastModUser, FDeleteDate, FDeleteUser)
							        Values(4,       @fitemid, getdate(),   @fusername,  Null,         Null,         Null,        Null)
				*/
			end

			FETCH NEXT FROM Seorder_Cursor 
			INTO @fitemid,@FManHour2,@fpiecefee2,@ffinancefee2
		END

		CLOSE Seorder_Cursor
		DEALLOCATE Seorder_Cursor

	end
end

go


--物料
IF not EXISTS (select * from sysobjects where name='MyICItem' and xtype='u') --drop Table MyICItem 
begin
CREATE TABLE MyICItem(fuserid int,
	fshortnumber varchar(50) null,fnumber varchar(50) null,
	fitemid int,fname varchar(500)
) ON [PRIMARY]
end

go



--物料信息变更联络
IF not EXISTS (select * from sysobjects where name='MyICItemChange' and xtype='u') --drop Table MyICItemChange 
begin
CREATE TABLE MyICItemChange(
	finterid int not null,
	fbillno varchar(50) not null,
	fdate datetime not null,
	fcheckdate datetime ,
	fsubid int,ftrantype varchar(50),
	fbillerid int not null,
	fmodifierID int,
	fmodifytime datetime,
	fbilltime datetime,
	fchecktime datetime,
	fcheckerid int,
	fstatus int default(0),--3 关闭--业务执行完毕
	fnote varchar(500),
	CONSTRAINT [PK_MyICItemChange] PRIMARY KEY CLUSTERED 
	(
		[finterid] ASC
	)WITH  FILLFACTOR = 90 ON [PRIMARY]
) ON [PRIMARY]
end

go


IF not EXISTS (select * from sysobjects where name='MyICItemChangeEntry' and xtype='u')  --drop Table MyICItemChangeEntry
begin
CREATE TABLE MyICItemChangeEntry(
	FInterID int NOT NULL,
	FEntryID int NOT NULL,
	FColourSize1 varchar(50),FColourSize2 varchar(50),FBoxSize1 varchar(50),FBoxSize2 varchar(50),
	FStandardQty1 int,FStandardQty2 int,
	fsupplyid int default 0,
	fnumber1 varchar(50),fnumber2 varchar(50),
	fname1 varchar(500),fname2 varchar(500),  
	fmodel1 varchar(500),fmodel2 varchar(500),--
	fdescription1 varchar(500),fdescription2 varchar(500),--描述
	FCompatArea1 varchar(500),FCompatArea2 varchar(500),--适用区域
	FCompatModel1 varchar(500),FCompatModel2 varchar(500),--适用机型
	FNetWeight1 int,FNetWeight2 int,FLength1 int,FLength2 int,FWidth1 int,FWidth2 int,FHeight1 int,FHeight2 int,
	fsourceid1 int,fsourceid2 int,
	fprintbrandid1 int,	fprintbrandid2 int,--打印机品牌
	fordertype1 int,fordertype2 int,--采购类别
	funitid1 int,funitid2 int,
	FLowRate1 decimal(24,2),FLowRate2 decimal(24,2),
	FMediumRate1 decimal(24,2),FMediumRate2 decimal(24,2),
	FLargeRate1 decimal(24,2),FLargeRate2 decimal(24,2),
	fchangetype varchar(200),--变更类型
	FItemID int NOT NULL,
	FUnitID int default(0),
	FNote varchar(500) NULL,
	CONSTRAINT [PK_MyICItemChangeEntry] PRIMARY KEY CLUSTERED 
	(
		FInterID ASC,
		FEntryID ASC
	) ON [PRIMARY]
) ON [PRIMARY]
end

go



--物料--导入到诚华--  --select * from v_MyICItemToChengHua where 短代码='VE00266' and 修改日期>='2015-05-01' and 修改日期<='2015-05-18'
IF EXISTS (select * from sysobjects where name='v_MyICItemToChengHua' and xtype='v')  drop  view v_MyICItemToChengHua

go

create view v_MyICItemToChengHua 

as

select --如果加了TOP，以下结果是不一样的，因为是先排序了
-- select * FROM v_MyICItemToChengHua t1 WHERE 修改日期 >='2015-04-06' and 修改日期 <='2015-04-08' and 审核人<>'' order by 长代码
-- select * FROM v_MyICItemToChengHua t1 WHERE 修改日期 >='2015-04-06' and 修改日期 <='2015-04-08' and 审核人<>'' --order by 长代码
t1.fshortnumber 短代码,t1.fnumber 长代码,t1.fname 产品名称,t3.ffullname 全称,t1.fmodel 规格型号,
isnull(t1.f_105,'') 描述,isnull(t1.f_106,'') 适用机型,isnull(t1.F_107,'') 适用区域,
(case when isnull(t1.F_109,'')='' then '0*0*0' else t1.F_109 end) [标准外箱尺寸(mm)],
(case when isnull(t1.F_111,'')='' then '0*0*0' else t1.F_111 end) [标准外盒尺寸(mm)],
cast(isnull(t1.F_112,0) as decimal(24,2)) [整箱净重(kg)],cast(isnull(t1.F_119,0) as decimal(24,2)) [整箱毛重(kg)],isnull(t1.F_110,0) 标准装箱数,
(case when isnull(t1.F_120,'')='' then '0*0*0' else t1.F_120 end) [裸包标准外箱尺寸(mm)],
isnull(t1.F_122,0) [裸包整箱净重(kg)],isnull(t1.F_123,0) [裸包整箱毛重(kg)],isnull(t1.F_121,0) 裸包标准装箱数,
(case when isnull(t13.fname,'')='' then '小' else t13.fname end) 外盒尺寸,isnull(t14.fname,'') 打印机品牌,isnull(t8.fshortname,'') 主供应商,
(case when t1.fdeleted=1 then 'Y' else '' end) 禁用,t9.fname 单位,isnull(t5.fname,'') 物料分类,
(case when t1.F_126=40019 then 'Y' else '' end) 是否引擎,(case when t1.F_126=40019 then '' else isnull(t7.fnumber,'') end) 引用引擎,
replace(convert(varchar(10),isnull(t2.flastmoddate,t2.fcreatedate),111),'/','-') 修改日期,isnull(t4.fname,'') 审核人--,
--t2.fcreatedate 创建时间,t2.fcreateuser 创建人,t2.flastmoddate 最后修改时间,t2.flastmoduser 最后修改人,t2.fdeletedate 禁用时间,t2.fdeleteuser 禁用人
from t_icitem t1
inner join t_baseproperty t2 on t1.fitemid=t2.fitemid
left join t_item t13 on t13.fitemid=t1.F_103 and t13.fitemclassid=3004  --外盒尺寸  --select * from t_item where fitemclassid=3004
left join t_SubMessage t14 on t14.finterid=t1.F_102  --打印机品牌
inner join t_item t3 on t3.fitemid=t1.fitemid
left join t_user t4 on t4.fuserid=t3.FChkUserID and t4.fuserid<>0
left join t_supplier t8 on t8.fitemid=t1.F_117 --t3.fsource
inner join t_measureunit t9 on t9.FItemID=t1.funitid
left join t_submessage t5 on t5.finterid=t1.ftypeid
left join t_icitem t7 on t7.fitemid=t1.F_127
where left(t1.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0)
and left(t1.fnumber,4) in('V.E.')
--and left(t1.fnumber,1) in ('V')
--and replace(convert(varchar(10),isnull(t2.flastmoddate,t2.fcreatedate),111),'/','-')>='********'
--and replace(convert(varchar(10),isnull(t2.flastmoddate,t2.fcreatedate),111),'/','-')<='########'
--order by t1.fnumber
--order by isnull(t2.flastmoddate,t2.fcreatedate)

go

--select * from v_MyICItem where 长代码 like 'V.B.%vb10186%' and 修改日期>='2016-01-30' and 修改日期<='2016-01-30'
--物料--导入到傲威--  
IF EXISTS (select * from sysobjects where name='v_MyICItem' and xtype='v')  drop  view v_MyICItem

go

create view v_MyICItem 

as

select t1.fshortnumber 短代码,t1.fnumber 长代码,t1.fname 产品名称,t3.ffullname 全称,t1.fmodel 规格型号,
isnull(t1.f_105,'') 描述,isnull(t1.f_106,'') 适用机型,isnull(t1.F_107,'') 适用区域,
(case when isnull(t1.F_109,'')='' then '0*0*0' else t1.F_109 end) [标准外箱尺寸(mm)],
(case when isnull(t1.F_111,'')='' then '0*0*0' else t1.F_111 end) [标准外盒尺寸(mm)],
cast(isnull(t1.F_112,0) as decimal(24,2)) [整箱净重(kg)],cast(isnull(t1.F_119,0) as decimal(24,2)) [整箱毛重(kg)],isnull(t1.F_110,0) 标准装箱数,
(case when isnull(t1.F_120,'')='' then '0*0*0' else t1.F_120 end) [裸包标准外箱尺寸(mm)],
isnull(t1.F_122,0) [裸包整箱净重(kg)],isnull(t1.F_123,0) [裸包整箱毛重(kg)],isnull(t1.F_121,0) 裸包标准装箱数,
(case when isnull(t13.fname,'')='' then '小' else t13.fname end) 外盒尺寸,isnull(t14.fname,'') 打印机品牌,isnull(t8.fshortname,'') 主供应商,
(case when t1.fdeleted=1 then 'Y' else '' end) 禁用,t9.fname 单位,isnull(t5.fname,'') 物料分类,
(case when t1.F_126=40019 then 'Y' else '' end) 是否引擎,(case when t1.F_126=40019 then '' else isnull(t7.fnumber,'') end) 引用引擎,
replace(convert(varchar(10),isnull(t2.flastmoddate,t2.fcreatedate),111),'/','-') 修改日期,isnull(t4.fname,'') 审核人,
isnull(t6.fname,'') 海关产品分类,isnull(t1.F_143,1) 纯PCS系数 --,
--t2.fcreatedate 创建时间,t2.fcreateuser 创建人,t2.flastmoddate 最后修改时间,t2.flastmoduser 最后修改人,t2.fdeletedate 禁用时间,t2.fdeleteuser 禁用人
from t_icitem t1
inner join (select fitemid,max(fcreatedate) fcreatedate,max(flastmoddate) flastmoddate from t_baseproperty group by fitemid) t2 on t1.fitemid=t2.fitemid
left join t_item t13 on t13.fitemid=t1.F_103 and t13.fitemclassid=3004  --外盒尺寸  --select * from t_item where fitemclassid=3004
left join t_SubMessage t14 on t14.finterid=t1.F_102  --打印机品牌
inner join t_item t3 on t3.fitemid=t1.fitemid
left join t_user t4 on t4.fuserid=t3.FChkUserID and t4.fuserid<>0
left join t_supplier t8 on t8.fitemid=t1.F_117 --t3.fsource
inner join t_measureunit t9 on t9.FItemID=t1.funitid
left join t_submessage t5 on t5.finterid=t1.ftypeid
left join t_icitem t7 on t7.fitemid=t1.F_127
left join t_item t6 on t6.fitemid=t1.F_108 and t6.fitemclassid=3003
where left(t1.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0)
and left(t1.fnumber,4) not in('V.E.') --'V.A.','V.C.','V.D.',
--and left(t1.fnumber,1) in ('V')
--and replace(convert(varchar(10),isnull(t2.flastmoddate,t2.fcreatedate),111),'/','-')>='********'
--and replace(convert(varchar(10),isnull(t2.flastmoddate,t2.fcreatedate),111),'/','-')<='########'
--order by t1.fnumber
--order by isnull(t2.flastmoddate,t2.fcreatedate)

go


--BOM--导入到傲威-- --select * from v_MyICBOM where 

IF EXISTS (select * from sysobjects where name='v_MyICBOM' and xtype='v')  drop  view v_MyICBOM

go

create view v_MyICBOM 
as

select t2.fshortnumber 产品编码,--t2.fname 产品名称,isnull(t2.F_105,'')+'///'+isnull(t2.fmodel,'') 产品规格型号,
t3.fshortnumber 子项编码,t3.fname 子项名称,isnull(t3.F_105,'')+'///'+isnull(t3.fmodel,'') 子项规格型号,t4.fqty 子项用量
from icbom t1
inner join t_icitem t2 on t1.fitemid=t2.fitemid
inner join icbomchild t4 on t1.finterid=t4.finterid 
inner join t_icitem t3 on t3.fitemid=t4.fitemid
where left(t2.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0) and t1.fstatus>0
and left(t2.fnumber,4) not in('V.A.','V.C.','V.D.','V.E.')
--and left(t3.fnumber,1) not in('3','4','5','7','8')
and t3.fnumber like '2.%'

go


IF EXISTS (select * from sysobjects where name='v_MyICItemChange' and xtype='v')  drop  view v_MyICItemChange

go

create view v_MyICItemChange 
as

select t1.fbillno 单据编号,isnull(t1.ftrantype,'') 单据类型,t1.finterid 单据内码,t1.fdate 制单日期, t4.fname 制单人,
(case when t1.fstatus=0 then '' when t1.fstatus=1 then 'Y' end) 审核,isnull(t5.fname,'') 审核人,
isnull(t1.fcheckdate,Null) 审核日期,t1.fnote 备注
from MyICItemChange t1   
inner join t_User t4 on t1.fbillerid=t4.fuserid and t4.fuserid<>0  
left join t_User t5 on t1.fcheckerid=t5.fuserid and t5.fuserid<>0  


go


IF EXISTS (select * from sysobjects where name='v_MyICItemChangeDetail' and xtype='v')  drop  view v_MyICItemChangeDetail

go

create view v_MyICItemChangeDetail 
as

select t1.fbillno 单据编号,t1.finterid 单据内码,t1.fdate 制单日期, t4.fname 制单人,
(case when t1.fstatus=0 then '' when t1.fstatus=1 then 'Y' end) 审核,
isnull(t5.fname,'') 审核人,isnull(t1.fcheckdate,Null) 审核日期,
--t7.fnumber 厂商编码,t7.fname 厂商名称,t7.fitemid 厂商内码,
isnull(t2.fnumber2,'') 物料编码,t2.fitemid 物料内码,
(case when t1.fstatus>0 then t2.fname1 else isnull(t3.fname,'') end) [old-名称],t2.fname2 名称,
(case when t1.fstatus>0 then t2.fmodel1 else isnull(t3.fmodel,'') end) [old-规格型号],t2.fmodel2 规格型号,
--(case when t1.fstatus>0 then t2.fdescription1 else isnull(t3.f_103,'') end) [old-描述],t2.fdescription2 描述,
(case when t1.fstatus>0 then t2.fcompatarea1 else isnull(t3.f_104,'')end) [old-适用区域],t2.fcompatarea2 适用区域,
(case when t1.fstatus>0 then t2.fcompatmodel1 else isnull(t3.f_103,'')end) [old-适用机型],t2.fcompatmodel2 适用机型,

--(case when t1.fstatus>0 then t2.fcoloursize1 else isnull(t3.f_116,'') end) [old-标准外盒尺寸(mm)],t2.fcoloursize2 [标准外盒尺寸(mm)],
--(case when t1.fstatus>0 then t2.fboxsize1 else isnull(t3.f_115,'')end) [old-标准外箱尺寸(mm)],t2.fboxsize2 [标准外箱尺寸(mm)],
--(case when t1.fstatus>0 then t2.fstandardqty1 else isnull(t3.f_117,0)end) [old-标准装箱数],t2.fstandardqty2 [标准装箱数],

(case when t1.fstatus>0 then t2.FNetWeight1 else isnull(t3.FNetWeight,0) end) [old-整箱净重(kg)],t2.FNetWeight2 [整箱净重(kg)],
(case when t1.fstatus>0 then t2.FLength1 else isnull(t3.FLength,0) end) [old-长度(mm)],t2.FLength2 [长度(mm)],
(case when t1.fstatus>0 then t2.FWidth1 else isnull(t3.FWidth,0) end) [old-宽度(mm)],t2.FWidth2 [宽度(mm)],
(case when t1.fstatus>0 then t2.FHeight1 else isnull(t3.FHeight,0) end) [old-高度(mm)],t2.FHeight2 [高度(mm)],
--(case when t1.fstatus>0 then t2.flowrate1 else isnull(t3.f_111,0) end) [old-策略L(%)],t2.flowrate2 [策略L(%)],
--(case when t1.fstatus>0 then t2.fmediumrate1 else isnull(t3.f_112,0) end) [old-策略M(%)],t2.fmediumrate2 [策略M(%)],
--(case when t1.fstatus>0 then t2.flargerate1 else isnull(t3.f_113,0) end) [old-策略H(%)],t2.flargerate2 [策略H(%)],
(case when t1.fstatus>0 then isnull(t8.fshortname,'') else isnull(t7.fshortname,'') end) [old-来源],isnull(t9.fshortname,'') 来源,
t3.funitid 单位内码,t6.fname 单位,t2.fnote 备注,t2.fchangetype 变更类型
from MyICItemChange t1   
inner join MyICItemChangeEntry t2 on t1.finterid=t2.finterid
left join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_User t4 on t1.fbillerid=t4.fuserid and t4.fuserid<>0  
left join t_User t5 on t1.fcheckerid=t5.fuserid and t5.fuserid<>0  
left join t_measureunit t6 on t6.fitemid=t3.funitid
left join t_supplier t7 on t7.fitemid=t3.fsource
left join t_supplier t8 on t8.fitemid=t2.fsourceid1
left join t_supplier t9 on t9.fitemid=t2.fsourceid2

go


--物料信息联络变更
IF EXISTS (select * from sysobjects where name='My_Tri_MyICItemChange'  and xtype='TR')  drop  TRIGGER My_Tri_MyICItemChange
go

Create TRIGGER My_Tri_MyICItemChange ON [dbo].MyICItemChange
FOR UPDATE

AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON
	declare @iMaxIndex int,@fname2 varchar(500),@fmodel2 varchar(500),@fdescription2 varchar(500),@FCompatArea2 varchar(500),@FCompatModel2 varchar(500),@FNetWeight2 decimal(24,2),@FLength2 decimal(24,2),@FWidth2 decimal(24,2),@FHeight2 decimal(24,2)
	declare @FBoxSize1 varchar(50),@FBoxSize2 varchar(50),@FColourSize1 varchar(50),@FColourSize2 varchar(50),@FStandardQty1 int,@FStandardQty2 int
	declare @FInterID int ,@fcheckerid int,@fsource int
	declare @FMyInterID int ,@FSupplyId int,@fusername varchar(30)
	declare @fcurrencyid int,@FPType int,@fstartqty int,@fendqty int,@fnote varchar(500)
	declare @fbillno varchar(30),@fitemid int,@fprice decimal(24,4),@ftempprice decimal(24,4)
	declare @funitid int,@fnumber varchar(30)
	declare @fstatus int,@fsubid int,@foldprice1 decimal(24,4),@foldprice2 decimal(24,4),@foldprice3 decimal(24,4)
	declare @fdate datetime,@freasonid int,@FShortNumber varchar(20),@FParentNumber varchar(20)
	declare @fuserid int ,@ftrantype varchar(50),@FParentID int
	select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期

	declare @findex int,@fprice1 decimal(24,4),@fprice2 decimal(24,4),@fprice3 decimal(24,4)
	declare @fbegqty1 int,@fendqty1 int,@fbegqty2 int,@fendqty2 int,@fbegqty3 int,@fendqty3 int


    -- Insert statements for trigger here
	--select @iMaxIndex=isnull(max(findex)+1,1) from MY_T_NETCONTROL where fuserid=1 and fbilltype=-1

	select top 1 @ftrantype=ftrantype,@fcheckerid=isnull(fcheckerid,0),@fbillno=fbillno,@FInterID=finterid,@fuserid=fbillerid from INSERTED 
	
	--select @fbegqty1=fbegqty1,@fendqty1=fendqty1,@fbegqty2=fbegqty2,@fendqty2=fendqty2,@fbegqty3=fbegqty3,@fendqty3=fendqty3 from my_t_PricePolicy where fsubid=@fsubid

	if update(fcheckerid) and @fcheckerid>0
	begin
		select @fusername=fname from t_user where fuserid=@fcheckerid

		update t1 set fsourceid1=t2.fsource,fname1=t2.fname,fmodel1=t2.fmodel--,fdescription1=t2.f_103,FCompatArea1=t2.f_109,FCompatModel1=t2.f_102,FNetWeight1=t2.F_118,FColourSize1=t2.F_116,FBoxSize1=t2.F_115,FStandardQty1=t2.F_117
		from MyICItemChangeEntry t1
		inner join t_icitem t2 on t1.fitemid=t2.fitemid
		where t1.finterid=@FInterID

		DECLARE Seorder_Cursor CURSOR FOR
		select t1.fnumber2,t1.fsourceid2,t1.fitemid,t1.fname2,t1.fmodel2,t1.fdescription2,t1.FCompatArea2,t1.FCompatModel2,t1.FNetWeight2,t1.FColourSize2,t1.FBoxSize2,t1.FStandardQty2
		from MyICItemChangeEntry t1
		where t1.finterid=@FInterID
		order by t1.fnumber2

		OPEN Seorder_Cursor

		FETCH NEXT FROM Seorder_Cursor 
		INTO @fnumber,@fsource,@fitemid,@fname2,@fmodel2,@fdescription2,@FCompatArea2,@FCompatModel2,@FNetWeight2,@FColourSize2,@FBoxSize2,@FStandardQty2

		WHILE @@FETCH_STATUS = 0
		BEGIN
			if @ftrantype='修改'
			begin
				update t_ICItemBase set fsource=@fsource where fitemid=@fitemid
				--update t_ICItemCustom set f_103=@fdescription2,f_109=@FCompatArea2,f_102=@FCompatModel2,F_118=@FNetWeight2,F_116=@FColourSize2,F_115=@FBoxSize2,F_117=@FStandardQty2 where fitemid=@fitemid
				update t_icitem set fname=@fname2,fmodel=@fmodel2--,FNetWeight=@FNetWeight2,FLength=@FLength2,FWidth=@FWidth2,FHeight=@FHeight2 
				where fitemid=@fitemid
				update t_item set fname=@fname2 where fitemid=@fitemid
				update t_BaseProperty set FLastModDate=getdate(), FLastModUser=@fusername where fitemid=@fitemid
			end
			else
			begin
				select @FShortNumber=REVERSE(left(REVERSE(@fnumber),CHARINDEX('.',REVERSE(@fnumber))-1))
				select @FParentNumber=REVERSE(right(REVERSE(@fnumber),len(@fnumber)-CHARINDEX('.',REVERSE(@fnumber))))

				select @FParentID=fitemid from t_item where fnumber=@FParentNumber and fdetail=0 and fitemclassid=4

				/*
				INSERT INTO t_Item (FItemClassID,FParentID, FLevel,FName,   FNumber, FShortNumber,  FFullNumber,FDetail,UUID,     FDeleted) VALUES (
								   (4,           @FParentID,4,     @fname2, @fnumber,@FShortNumber, @fnumber,   1,      newid() , 0

				INSERT INTO t_Log (FDate,    FUserID,      FFunctionID,FStatement,FDescription,                                  FMachineName,FIPAddress) 
				VALUES 		      (getdate(),@fcheckerid,  'A00701',   5,         '新建核算项目:'+@fnumber+' 核算项目类别:物料','KSW103',    '192.168.0.89')
				
				select @fitemid=FItemID,@ffullname=ffullname from t_Item where fdetail=1 and fitemclassid=4 and fnumber=@fnumber
		
				INSERT INTO t_ICItem (FHelpCode,FModel,   FAuxClassID,FErpClsID,FTypeID,FUnitGroupID,FUnitID,FOrderUnitID,FSaleUnitID,FProductUnitID,FStoreUnitID,FSecUnitID,FSecCoefficient,  FDefaultLoc,FSPID,FSource,FQtyDecimal,FLowLimit,FHighLimit,FSecInv,FUseState,FIsEquipment,FEquipmentNum,FIsSparePart,FFullName,  FApproveNo,FAlias,FOrderRector,FPOHighPrice,FPOHghPrcMnyType,FWWHghPrc,FWWHghPrcMnyType,FSOLowPrc,FSOLowPrcMnyType,FIsSale,FProfitRate,FOrderPrice,FSalePrice,FIsSpecialTax,FISKFPeriod,FKFPeriod,FStockTime,FBatchManager,FBookPlan,FBeforeExpire,FCheckCycUnit,FOIHighLimit,FOILowLimit,FSOHighLimit,FSOLowLimit,FInHighLimit,FInLowLimit,FTrack,FPlanPrice,FPriceDecimal,FAcctID,FSaleAcctID,FCostAcctID,FAPAcctID,FAdminAcctID,FGoodSpec,FTaxRate,FCostProject,FIsSNManage,FNote,F_102,          F_103,          F_104,f_115, f_114, F_107,F_108,F_109,F_110,F_111, F_112,F_113,FPlanTrategy,FOrderTrategy,FFixLeadTime,FLeadTime,FTotalTQQ,FOrderInterVal,FQtyMin,FQtyMax,FBatchAppendQty,FOrderPoint,FBatFixEconomy,FBatChangeEconomy,FRequirePoint,FPlanPoint,FDefaultRoutingID,FDefaultWorkTypeID,FProductPrincipal,FPlanner,FPutInteger,FDailyConsume,FMRPCon,FMRPOrder,FChartNumber,FIsKeyItem,FGrossWeight,FNetWeight,  FMaund,FLength, FWidth, FHeight,  FSize,FCubicMeasure,FStandardCost,FStandardManHour,FStdPayRate,FChgFeeRate,FStdFixFeeRate,FOutMachFee,FPieceRate,FInspectionLevel,FProChkMde,FWWChkMde,FSOChkMde,FWthDrwChkMde,FStkChkMde,FOtherChkMde,FStkChkPrd,FStkChkAlrm,FInspectionProject,FIdentifier,FVersion,FNameEn,FModelEn,FHSNumber,FFirstUnit,FSecondUnit,FImpostTaxRate,FConsumeTaxRate,FFirstUnitRate,FSecondUnitRate,FIsManage,FManageType,FLenDecimal,FCubageDecimal,FWeightDecimal,FIsCharSourceItem,FShortNumber, FNumber, FName, FParentID, FItemID) 
				              VALUES (NULL,     @fmodel2, 0,          1,        0,       130,        131,    131,         131,        131,           131,         0,         0,                0,          0,    0,      0,          0,        0,         0,      341,      0,            NULL,        0,           @ffullname, NULL,      NULL,  0,           0,           1,               0,        1,               0,        1,               0,      0,          0,          0,         0,            0,          0,        0,         1,            0,        0,            0,            0,           0,          0,           0,          0,           0,          80,    0,         4,            1016,   1125,       1126,       0,        0,           0,        17,      0,           0,          NULL, @FCompatModel2, @fdescription2, 0,    13627, 0,     NULL, NULL, NULL, 40062, 0,    0,    0,    321,         331,          0,           1,        0,        0,             1,      10000,  1,              0,          0,             1,                1,            1,         0,                0,                 0,                0,       0,          0,            1,      0,        NULL,        0,         0,           @FNetWeight2,0,     @FLength,@FWidth,@FHeight, 0,    0,            0,            0,               0,          0,          0,             0,          0,         352,             352,       352,      352,      352,          352,       352,         9999,      0,          0,                 0,          NULL,    NULL,   NULL,    0,        NULL,      NULL,       0,             0,              0,             0,              0,        0,          2,          4,             2,             0,                @FShortNumber,@FNumber,@FName,@FParentID,@FItemID
					   --select top 1 NULL,     @fmodel2, 0,          1,        0,      FUnitGroupID,FUnitID,FOrderUnitID,FSaleUnitID,FProductUnitID,FStoreUnitID,0,         0,                0,          0,    0,      0,          0,        0,         0,      341,      0,            NULL,        0,           @ffullname, NULL,      NULL,  0,           0,           1,               0,        1,               0,        1,               0,      0,          0,          0,         0,            0,          0,        0,         FBatchManager,0,        0,            0,            0,           0,          0,           0,          0,           0,          80,    0,         FPriceDecimal,FAcctID,FSaleAcctID,FCostAcctID,0,        0,           0,        FTaxRate,0,           0,          NULL, @FCompatModel2, @fdescription2, 0,    f_115, f_114, NULL, NULL, @FCompatArea2, F_110, 0,     0,    0,    321,         331,          0,           1,        0,        0,             1,      10000,  1,              0,          0,             1,                1,            1,         0,                0,                 0,                0,       0,          0,            1,      0,        NULL,        0,         0,           @FNetWeight2,0,     @FLength,@FWidth,@FHeight, 0,    0,            0,            0,               0,          0,          0,             0,          0,         352,             352,       352,      352,      352,          352,       352,         9999,      0,          0,                 0,          NULL,    NULL,   NULL,    0,        NULL,      NULL,       0,             0,              0,             0,              0,        0,          2,          4,             2,             0,                @FShortNumber,@FNumber,@FName,@FParentID,@FItemID

				Insert Into t_BaseProperty(FTypeID, FItemID,  FCreateDate, FCreateUser, FLastModDate, FLastModUser, FDeleteDate, FDeleteUser)
							        Values(4,       @fitemid, getdate(),   @fusername,  Null,         Null,         Null,        Null)
				*/
			end

			FETCH NEXT FROM Seorder_Cursor 
			INTO @fnumber,@fsource,@fitemid,@fname2,@fmodel2,@fdescription2,@FCompatArea2,@FCompatModel2,@FNetWeight2,@FColourSize2,@FBoxSize2,@FStandardQty2
		END

		CLOSE Seorder_Cursor
		DEALLOCATE Seorder_Cursor

	end
end

go



--生成产品入库--*****
--My_p_GenerateICStockBill_2 16394, 1
IF EXISTS (select * from sysobjects where name='My_p_GenerateICStockBill_2' and xtype='p')  drop  procedure My_p_GenerateICStockBill_2

go


create procedure [dbo].My_p_GenerateICStockBill_2 (@fuserid int,@fdate datetime,@flineid int,@fidentify int output)

as
SET NOCOUNT ON

--declare @fbout varchar(20),@iuserid int ,@frunid int,@fcommitdate datetime  select @fbout='215',@iuserid=16482,@frunid=2155,@fcommitdate='2010-06-17'

declare @fplanprice decimal(18,4),@fitemid int,@fpitemid int,@funitid int,@entryid int,@fqty int
declare @FStockId int,@StockNumber varchar (20),@BillNo varchar(20),@ficmobillno varchar(20),@InterID int
DECLARE @TmpID INT ,@fsupplyid int,@fcurrencyid int,@FMyPoInStockInterId int,@frob int
declare @fsupplyno varchar(20),@forderdate datetime,@FValueAddRate decimal(28, 2),@fsourceinterid int
declare @iLength int,@FPrice decimal(28, 5),@FAmount decimal(20, 2),@FExchangeRate decimal(28, 10)
declare @FTaxPrice decimal(28, 5),@FTaxAmount decimal(20, 2),@SupplyId int,@fqtymust decimal(24,2)
declare @fprojectval  varchar(200),@fspid int,@fempid int,@fdeptid int,@fplanamount decimal(20, 2),@UpStockWhenSave int
declare @sDateFormat  varchar(200)--,@fdate datetime,
declare @ficmointerid int,@forderbillno varchar(20)
declare @fsourceNumber varchar(200),@fpSourceNumber varchar(200),@fpXxSourceNumber varchar(200)
declare @fXxOldSourceNumber varchar(200),@empid int,@fcostobjid int,@fintype int
declare @FDCStockID int,@xx_FItemIDOld int,@fxxitemid int,@fppbominterid int
declare @FDCSPID int,@forderinterid int,@forderentryid int,@fppbomentryid int
declare @fsourceEntryid int,@fsourceBillNo varchar (100),@FDIOFInFanager int,@FDIOFInSanager int
declare @fyear int,@fperiod int,@FMangerID int,@fcustid int,@fbatchno varchar(50)
declare @fresultbillno varchar (800),@fsebillno varchar(50),@fbillerid int	, @maxorder int 
declare @ftempbillno varchar(50),@fremark varchar(500),@fpoitemtype varchar(50)
declare @fcheck_fail int,@fsrccommitfield_prevalue decimal(28,13),@fsrccommitfield_endvalue decimal(28,13)

--select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')
select @FDIOFInFanager=16394,@FDIOFInSanager=16394
select @UpStockWhenSave=fvalue from T_SYSTEMPROFILE where  fkey='UPSTOCKWHENSAVE'

--select * from t_submessage where ftypeid=10009 and fname like '%半成品%'
--40041		半成品入库单
--40042		产成品入库单

select (case when isnull(t2.forderinterid,0)=0 then 40041 else 40042 end) fintype,
isnull(t4.fbillno,'') forderbillno,t1.finqty fqty,t2.finterid ficmointerid, t2.fitemid, t2.fcostobjid, 0 fplanprice, 
0 fplanamount, t2.fbillno ficmobillno, 
t8.funitid, isnull(t8.fspid,0) fspid, t2.fworkshop fdeptid, t2.fauxcommitqty fcommitqty, t2.fauxqty-t2.fauxcommitqty fqtymust,
t8.fdefaultloc fstockid, 0 fppbominterid, 0 fppbomentryid,
(case when t8.FBatchManager=1 then isnull(t2.FGMPBatchNo,'') else '' end) fbatchno
into #SourceData ---
from icmo t2 
inner join my_t_icmotemp t1 on t1.finterid=t2.finterid 
left join seorderentry t3 on t2.forderinterid=t3.finterid and t3.fentryid=t2.fsourceentryid
left join seorder t4 on t4.finterid=t3.finterid
inner join t_icitem t8 on t2.fitemid=t8.fitemid --
where t1.fuserid=@fuserid --and t2.fstatus=1 --and (t2.fauxqty-t2.fauxcommitqty)>0  --
and t1.finqty>0
order by t8.fshortnumber

select @fidentify=isnull(max(fid),0)+1 from my_t_identify
insert into my_t_identify(fid,fuserid,fdate,FTrantypeID) values(@fidentify,@fuserid,getdate(),2)

declare @beAllowed INT 

DECLARE icstockbillentry_cursor CURSOR FOR	

select distinct fdeptid from #SourceData t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid --where t2.ferpclsid=2 --and fnumber like '01.%' and fnumber not like '01.01.%'

OPEN icstockbillentry_cursor

FETCH NEXT FROM icstockbillentry_cursor 
INTO @fdeptid

WHILE @@FETCH_STATUS = 0
BEGIN 
	exec My_p_GetBillNo 2,'icstockbill',@Interid output, @BillNo output
               	
	DECLARE authors_cursor CURSOR FOR	
	select t1.fintype,t1.forderbillno,t1.fitemid, t1.funitid, t1.fstockid, t1.fspid, t1.fdeptid, t1.fqtymust,t1.fqty, t1.ficmointerid, t1.ficmobillno, t1.fplanprice, t1.fplanamount, t1.fcostobjid, t1.fppbominterid, t1.fppbomentryid,t1.fbatchno from #SourceData t1 inner join t_icitem t2 on t1.fitemid = t2.fitemid where fdeptid=@fdeptid --and t2.ferpclsid = 2

    	set @entryid=1

	OPEN authors_cursor

	FETCH NEXT FROM authors_cursor 
	INTO @fintype,@forderbillno,@fitemid,@funitid,@fstockid,@fspid,@fdeptid,@fqtymust,@fqty,@ficmointerid,@ficmobillno,@fplanprice,@fplanamount,@fcostobjid,@fppbominterid,@fppbomentryid,@fbatchno

	WHILE @@FETCH_STATUS = 0
	BEGIN 
		INSERT INTO ICStockBillEntry ( FInterID,FEntryID,FBrNo,FItemID,FAuxPropID,FBatchNo, FQtyMust,   FQty, FUnitID, FAuxQtyMust,Fauxqty,FSecCoefficient,FSecQty,FAuxPlanPrice,FPlanAmount, Fauxprice,Famount,Fnote,FKFDate,FKFPeriod,FPeriodDate,FDCStockID,FDCSPID,FSNListID,FSourceBillNo,FSourceTranType,FSourceInterId,FSourceEntryID,FICMOBillNo, FICMOInterID, FPPBomEntryID) 
		VALUES (                       @InterId,@EntryId,'0',  @fitemid,0,        @fbatchno,1*@fqtymust,@fqty,@funitid,1*@fqtymust,@fqty,  0,              0,      @fplanprice,  @fplanamount,0,        0,      '',   Null,   0,        Null,       @fstockid, @fspid, 0,        @ficmobillno, 85,             @ficmointerid, 0,             @ficmobillno,@ficmointerid,0) 

		set @entryid=@entryid+1

		FETCH NEXT FROM authors_cursor 
		INTO @fintype,@forderbillno,@fitemid,@funitid,@fstockid,@fspid,@fdeptid,@fqtymust,@fqty,@ficmointerid,@ficmobillno,@fplanprice,@fplanamount,@fcostobjid,@fppbominterid,@fppbomentryid,@fbatchno
	END

	CLOSE authors_cursor
	DEALLOCATE authors_cursor

	EXEC p_UpdateBillRelateData 2,@InterId

	INSERT INTO ICStockBill(fheadselfa0229,fheadselfa0231,/*fheadselfa0228,*/fheadselfa0228,FInterID,FBillNo,FBrNo,FTranType,FCancellation,FStatus,FUpStockWhenSave,FVchInterID,FROB,FHookStatus,Fdate, FDeptID,FCheckDate,FFManagerID,    FSManagerID,      FBillerID, FMultiCheckLevel1,FMultiCheckDate1,FMultiCheckLevel2,FMultiCheckDate2,FMultiCheckLevel3,FMultiCheckDate3,FMultiCheckLevel4,FMultiCheckDate4,FMultiCheckLevel5,FMultiCheckDate5,FMultiCheckLevel6,FMultiCheckDate6,FSelTranType) 
	VALUES (                @flineid,      @fintype,      /*@forderbillno, */@fidentify,    @InterId,@BillNo,'0',  2,        0,            0,      @UpStockWhenSave,0,          1,   0,          @fdate,@fdeptid,Null,     @FDIOFInFanager,@FDIOFInSanager,  @FUserId,  Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,85)

	UPDATE ICStockBill SET FUUID=NEWID() WHERE FInterID=@InterId

	update src set @fsrccommitfield_prevalue=src.fcommitqty,
	     @fsrccommitfield_endvalue=@fsrccommitfield_prevalue+dest.fqty,
	     @fcheck_fail=(case when (1=1) then @fcheck_fail else -1 end),
	     src.fcommitqty=@fsrccommitfield_endvalue,
	     src.fauxcommitqty=@fsrccommitfield_endvalue/cast(t1.fcoefficient as float)
	from icmo src inner join 
	(select u1.fsourceinterid as fsourceinterid,u1.fsourceentryid,u1.fitemid,sum(u1.fqty) as fqty
	from  icstockbillentry u1 
	where u1.finterid=@InterId
	group by u1.fsourceinterid,u1.fsourceentryid,u1.fitemid) dest 
	on dest.fsourceinterid = src.finterid
	and dest.fitemid = src.fitemid
	inner join t_measureunit t1 on src.funitid=t1.fitemid
	       
	update src set @fsrccommitfield_prevalue=src.fqty,
		 @fsrccommitfield_endvalue=@fsrccommitfield_prevalue+dest.fqty,
		 @fcheck_fail=case isnull(@maxorder,0) when 1 then 0 else (case when (1=1) then @fcheck_fail else -1 end) end,
		 src.fqty=@fsrccommitfield_endvalue,
		 src.fauxqty=@fsrccommitfield_endvalue/cast(t1.fcoefficient as float)
	 from ppbomentry src 
		 inner join ppbom srchead on src.ficmointerid=srchead.ficmointerid
		 inner join 
	 (select u1.ficmointerid as fsourceinterid,u1.fppbomentryid,u1.fitemid,sum(u1.fqty) as fqty
	 from  icstockbillentry u1 
	 where u1.finterid=@InterId
	 group by u1.ficmointerid,u1.fppbomentryid,u1.fitemid) dest 
	 on dest.fsourceinterid = src.ficmointerid
	 and dest.fitemid = src.fitemid
	 and src.fentryid = dest.fppbomentryid
	 inner join t_measureunit t1 on src.funitid=t1.fitemid where src.fmaterieltype in (372,373,374)

	INSERT INTO t_Log (FDate,FUserID,FFunctionID,FStatement,FDescription,FMachineName,FIPAddress) VALUES (getdate(),@FUserId,'K010000',3,'编号为'+@BillNo+'的单据保存成功','KSW118','192.168.0.159')        		

	FETCH NEXT FROM icstockbillentry_cursor 
    INTO @fdeptid
END

CLOSE icstockbillentry_cursor
DEALLOCATE icstockbillentry_cursor

drop table #SourceData

set nocount off

go


--生成收料通知单--*****
--exec My_p_GeneratePOInStock 16394,0

IF EXISTS (select * from sysobjects where name='My_p_GeneratePOInStock' and xtype='p')  drop  procedure My_p_GeneratePOInStock

go

create procedure [dbo].My_p_GeneratePOInStock (@fuserid int ,@fidentify int output)
--with encryption 
as
SET NOCOUNT ON

--declare @fbout varchar(20),@iuserid int ,@frunid int,@fcommitdate datetime  select @fbout='215',@iuserid=16482,@frunid=2155,@fcommitdate='2010-06-17'

declare @fplanprice decimal(18,4),@fitemid int,@fpitemid int,@funitid int,@entryid int,@fqty int,@InterID int
declare @BillNo varchar (20),@FStockId int,@StockNumber varchar (20),@FSEOrderType int,@FPOOrderType int
DECLARE @TmpID INT ,@fsupplyid int,@fcurrencyid int,@FMyPoInStockInterId int,@fbatchno varchar(50)
declare @fsupplyno varchar(20),@forderdate datetime,@FValueAddRate decimal(28, 2)
declare @iLength int,@FPrice decimal(28, 5),@FAmount decimal(20, 2),@FSEOutStockBillNo varchar(40)
declare @FTaxPrice decimal(28, 5),@FTaxAmount decimal(20, 2),@SupplyId int,@FAllStdAmount decimal(24,2)
declare @fprojectval  varchar(200),@fspid int,@fempid int,@fdeptid int,@FSEOrderBillNo varchar(50)
declare @sDateFormat  varchar(200),@fdate datetime,@fcustid int,@fquobillno varchar(50),@fnumber varchar(50)
declare @fsourceNumber varchar(200),@fpSourceNumber varchar(200),@fpXxSourceNumber varchar(200)
declare @fXxOldSourceNumber varchar(200),@empid int,@fmanagerid int
declare @FDCStockID int,@xx_FItemIDOld int,@fxxitemid int,@fstdpackprice decimal(24,4)
declare @FDCSPID int,@forderinterid int,@forderentryid int,@fpoitemtype varchar(50)
declare @fsourceInterid int,@fsourceEntryid int,@fsourceBillNo varchar (100),@ftoday datetime
declare @fyear int,@fperiod int,@FMangerID int,@FExchangeRate decimal(28,10)
declare @fresultbillno varchar (800),@fnote varchar(500),@fempshortname varchar(40)
declare @ftempbillno varchar(50),@fremark varchar(500),@fcess decimal(24,2),@fpackprice decimal(24,4)
declare @fallamount decimal(24,2),@fordertype varchar(50),@FTaxAmt decimal(24,2),@fnudepackprice decimal(24,4)
declare @fexportdistrict varchar(50),@fpricetype varchar(50),@fpointerid int
declare @foldprice1 decimal(24,4),@foldprice2 decimal(24,4),@foldprice3 decimal(24,4),@FUpStockWhenSave int
declare @beAllowed INT 
declare @MaterialReturnDirect INT 
Declare @Num INT  SET @Num=0 
declare @fcheck_fail int
declare @fsrccommitfield_prevalue decimal(28,13)
declare @fsrccommitfield_endvalue decimal(28,13)
declare @maxorder int 

select @FUpStockWhenSave=fvalue from t_systemprofile where fkey = 'UpStockWhenSave'
select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')
select @FManagerID=0, @FDeptID=0,@FEmpID=0

select @fidentify=isnull(max(fid),0)+1 from my_t_identify
insert into my_t_identify(fid,fuserid,fdate,FTrantypeID) values(@fidentify,@fuserid,getdate(),71)

select @fuserid fbillerid,t1.fsupplyid,t1.finterid,t4.fentryid,t7.fitemid,t7.funitid,
t4.fprice,cast(t4.fprice*t2.freceiveqty as decimal(24,2)) famount,t2.freceiveqty fqty,t1.fbillno
into #data
from POOrder t1 
inner JOIN poorderentry t4 ON t1.finterid=t4.finterid 
inner JOIN t_ICItem t7 ON t4.fitemid=t7.FItemID AND t7.FItemID<>0 
inner JOIN t_supplier t3 ON t3.fitemid=t1.FSupplyID AND t3.FItemID<>0 
inner join My_t_POOrderTemp t2 on t2.finterid=t4.finterid and t2.fentryid=t4.fentryid
where t2.fuserid=@fuserid and t1.fstatus in (1,2) and t4.fmrpclosed=0 and t4.fqty>t4.fcommitqty
and t2.freceiveqty>0

DECLARE icbom_cursor CURSOR FOR	

select distinct fbillerid,fsupplyid from #data

OPEN icbom_cursor

FETCH NEXT FROM icbom_cursor 
INTO @fuserid,@fsupplyid

WHILE @@FETCH_STATUS = 0
BEGIN 
	exec GetICMaxNum 'POInStock', @InterID output

	-- 10.4
	Update t_BillCodeRule Set FReChar = FReChar Where FBillTypeID =72

	SET @TmpID = (SELECT FID FROM t_BillCodeRule WITH(READUNCOMMITTED) WHERE fbilltypeid=72 and fprojectid=3)

	update t_billcoderule set fprojectval = fprojectval+1,flength=case when (flength-len(fprojectval)) >= 0 then flength else len(fprojectval) end where FID =  @TmpID 
	Update ICBillNo Set FCurNo = (select top 1 isnull(fprojectval,1) from t_billcoderule where fprojectid = 3 and fbilltypeid =72) where fbillid = 72
	   
	--长度和目前编码
	select @fprojectval=(fprojectval-1),@iLength=flength from t_BillCodeRule where fprojectid = 3 and fbilltypeid = 72
	  
	-- 前缀
	select @BillNo=fprojectval+left('0000000000',@iLength-(len(@fprojectval)))+@fprojectval from t_BillCodeRule where fprojectid = 1 and fbilltypeid = 72  --@iLength
    
	DECLARE authors_cursor CURSOR FOR	

	select t8.fitemid,t8.funitid,t8.fqty,t8.fprice,t8.famount,t8.finterid,t8.fentryid,'' fbatchno,t8.fbillno
	from #data t8
	where t8.fsupplyid=@fsupplyid
	order by t8.finterid,t8.fentryid

    	set @entryid=1

	OPEN authors_cursor

	FETCH NEXT FROM authors_cursor 
	INTO @fitemid,@funitid,@fqty,@fprice,@famount,@fsourceinterid,@fsourceentryid,@fbatchno,@fsourcebillno

	WHILE @@FETCH_STATUS = 0
	begin
		set @FStockID=16482 --16482	待检仓

		INSERT INTO POInstockEntry (FInterID,FEntryID,FBrNo,FMapNumber,FMapName,FItemID,FAuxPropID,FBatchNo,FQty, FUnitID, Fauxqty,FSecCoefficient,FSecQty,Fauxprice,Famount, Fnote,FAuxQtyPass,FKFDate,FKFPeriod,FPeriodDate,FStockID, FDCSPID,FSourceBillNo, FSourceTranType,FSourceInterId, FSourceEntryID, FContractBillNo,FContractInterID,FContractEntryID,FOrderBillNo, FOrderInterID,  FOrderEntryID ) 
							VALUES (@InterID,@entryid,'0',  '',        '',      @fitemid,0,        '',      @fqty,@funitid,@fqty,   0,             0,      @fprice,  @famount,'',   @fqty,      Null,   0,        Null,       @FStockID,0,      @FSourceBillNo,71,             @FSourceInterId,@FSourceEntryID,'',             0,               0,              @FSourceBillNo,@FSourceInterId,@FSourceEntryID)

		set @entryid=@entryid+1

		FETCH NEXT FROM authors_cursor 
		INTO @fitemid,@funitid,@fqty,@fprice,@famount,@fsourceinterid,@fsourceentryid,@fbatchno,@fsourcebillno
	END

	CLOSE authors_cursor
	DEALLOCATE authors_cursor

	INSERT INTO POInstock(fheadselfp0341,FCheckerID,FInterID,FBillNo,FBrNo,FTranType,FCancellation,FStatus,FUpStockWhenSave,Fdate, FSupplyID, FCheckDate,FFManagerID, FDeptID, FEmpID, FBillerID,FCurrencyID,FExchangeRate,FPOStyle,FRelateBrID,FMultiCheckLevel1,FMultiCheckDate1,FMultiCheckLevel2,FMultiCheckDate2,FMultiCheckLevel3,FMultiCheckDate3,FMultiCheckLevel4,FMultiCheckDate4,FMultiCheckLevel5,FMultiCheckDate5,FMultiCheckLevel6,FMultiCheckDate6,FSelTranType,FFetchAdd,FExplanation,FAreaPS,FManageType) 
				  VALUES (@fidentify,    @fuserid,  @InterId,@BillNo,'0',   72,      0,            1,      1,               @fdate,@FSupplyID,@fdate,    @FManagerID, @FDeptID,@FEmpID,@fuserid, 1,          1,            252,     0,          Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,                                                                                                                                                      71,          '',      '',           20302,  0)

	EXEC p_UpdateBillRelateData 72,@InterId

	SELECT @beAllowed=CAST(FValue AS INT) from t_SystemProfile Where FCategory='IC' and FKey='CQtyLargerPOQty'
	SELECT @MaterialReturnDirect=CAST(FValue AS INT) from t_SystemProfile Where FCategory='IC' and FKey='MaterialReturnDirect'
	IF @beAllowed<>1 
	BEGIN 
		IF EXISTS(SELECT * FROM POInstockEntry
				  WHERE FInterID=@InterId AND FSourceInterID=0 )
			RAISERROR('采购系统严格控制执行数量，不允许增加分录!',18,18)

		IF EXISTS(SELECT u1.FInterID
				  FROM POOrderEntry u1 INNER JOIN POInstockEntry u2 ON u1.FInterID=u2.FSourceInterID and u1.FEntryID=u2.FSourceEntryID
				  LEFT JOIN t_ICItem t4 ON t4.FItemID=u1.FItemID
				  WHERE  t4.FErpClsID<>5 AND u2.FInterID=@InterId
						  AND   u1.FItemID<>u2.FItemID)
			RAISERROR('采购系统严格控制执行数量，不允许修改关联分录！',18,18)

		IF EXISTS(SELECT t1.FInterID
				  FROM POOrderEntry t1,
					  (SELECT FInterID,FItemID,FSourceInterID,FSourceEntryID,sum(FQty) as FQty FROM POInstockEntry
					   WHERE FInterID=@InterId AND IsNull(FOrderInterID,0)>0 Group by FInterID,FItemID,FSourceInterID,FSourceEntryID) t2
				  WHERE t1.FInterID=t2.FSourceInterID
					  AND t1.FItemID=t2.FItemID
					  AND t1.FEntryID=t2.FSourceEntryID
					  AND (t1.FQty<(t1.FCommitQty+t2.FQty
						   ) OR (t1.FCommitQty+t2.FQty)<0))
			RAISERROR('采购系统严格控制执行数量，不允许超过关联的采购订单数量并且采购订单关联数量不能为负。',18,18)
	END

	update src set @fsrccommitfield_prevalue=src.fcommitqty,
		 @fsrccommitfield_endvalue=@fsrccommitfield_prevalue+dest.fqty,
		 @fcheck_fail=case isnull(@maxorder,0) when 1 then 0 else (case when ((src.fqty > @fsrccommitfield_prevalue and isnull(srcHead.fstatus, 0)>0) or (src.fqty <= @fsrccommitfield_prevalue and isnull(srcHead.fstatus, 0) in (1,2)) or (src.fqty > @fsrccommitfield_endvalue and isnull(srcHead.fstatus, 0)>0)) then @fcheck_fail else -1 end) end,
		 src.fcommitqty=@fsrccommitfield_endvalue,
		 src.fauxcommitqty=@fsrccommitfield_endvalue/cast(t1.fcoefficient as float)
	 from poorderentry src 
		 inner join poorder srchead on src.finterid=srchead.finterid
		 inner join 
	 (select u1.fsourceinterid as fsourceinterid,u1.fsourceentryid,u1.fitemid,sum(u1.fqty) as fqty
	 from  poinstockentry u1 
	 where u1.finterid=@InterId
	 group by u1.fsourceinterid,u1.fsourceentryid,u1.fitemid) dest 
	 on dest.fsourceinterid = src.finterid
	 and dest.fitemid = src.fitemid
	 and src.fentryid = dest.fsourceentryid
	 inner join t_measureunit t1 on src.funitid=t1.fitemid

	if (isnull(@fcheck_fail,0)=-1) 
	   raiserror('可能的原因是：
	 1、所选单据已被其他单据关联
	 2、所选单据已被反审核
	 3、当前单据和所选单据的关联数量超过了所选单据的数量
	 4、所选单据已经关闭',18,18)
	else
	if exists (select 1 from poorder src right join  (select u1.fsourceinterid as fsourceinterid,u1.fsourceentryid,u1.fitemid,sum(u1.fqty) as fqty
	from  poinstockentry u1 
	where u1.finterid=@InterId
	group by u1.fsourceinterid,u1.fsourceentryid,u1.fitemid) dest on dest.fsourceinterid = src.finterid where dest.fsourceinterid>0 and src.finterid is null)
	raiserror('所选单据已被删除',18,18)

	Update t
	Set t.FStatus =Case When (SELECT COUNT(1) FROM POOrderEntry WHERE (FCommitQty>0 OR ISNULL(FMRPClosed,0)=1) AND FInterID IN(@FSourceInterId))=0 Then 1 When EXISTS(SELECT 1 FROM POOrderEntry te WHERE ISNULL(te.FMRPAutoClosed,1)=1 AND te.FCommitQty<FQty AND te.FInterID IN(@FSourceInterId)) Then 2 Else 3 End
	,t.FClosed =Case When EXISTS(SELECT 1 FROM POOrderEntry te WHERE ISNULL(te.FMRPAutoClosed,1)=1 AND te.FCommitQty<FQty AND te.FInterID IN(@FSourceInterId)) Then 0 Else 1 End
	From POOrder t
	WHERE t.FInterID IN(@FSourceInterId)

	update src set @fsrccommitfield_prevalue=src.fseccommitqty,
		 @fsrccommitfield_endvalue=@fsrccommitfield_prevalue+dest.fsecqty,
		 @fcheck_fail=case isnull(@maxorder,0) when 1 then 0 else (case when (1=1) then @fcheck_fail else -1 end) end,
		 src.fseccommitqty=@fsrccommitfield_endvalue
	from poorderentry src 
		 inner join poorder srchead on src.finterid=srchead.finterid
		 inner join 
	(select u1.fsourceinterid as fsourceinterid,u1.fsourceentryid,u1.fitemid,sum(u1.fsecqty) as fsecqty
	from  poinstockentry u1 
	where u1.finterid=@InterId
	group by u1.fsourceinterid,u1.fsourceentryid,u1.fitemid) dest 
	on dest.fsourceinterid = src.finterid
	and dest.fitemid = src.fitemid
	and src.fentryid = dest.fsourceentryid

	IF EXISTS (SELECT 1 FROM ICBillRelations_Sale WHERE FBillType = 72 AND FBillID=@InterId)
	BEGIN
		UPDATE t1 SET t1.FChildren=t1.FChildren+1
		FROM POOrder t1 INNER JOIN POOrderEntry t2 ON     t1.FInterID=t2.FInterID
		INNER JOIN ICBillRelations_Sale t3 ON t3.FMultiEntryID=t2.FEntryID AND t3.FMultiInterID=t2.FInterID
		WHERE t3.FBillType=72 AND t3.FBillID=@InterId
	END
	ELSE
	BEGIN
		UPDATE t3 SET t3.FChildren=t3.FChildren+1
		FROM POInstock t1 INNER JOIN POInstockEntry     t2 ON t1.FInterID=t2.FInterID
		INNER JOIN POOrder t3 ON t3.FTranType=t2.FSourceTranType AND t3.FInterID=t2.FSourceInterID
		WHERE t1.FTranType=72 AND t1.FInterID=@InterId AND t2.FSourceInterID>0
	END

	if @FUpStockWhenSave=1
	begin
		CREATE TABLE #TempBill
		(FBrNo VARCHAR(10) NOT NULL DEFAULT(''),
		 FInterID INT NOT NULL DEFAULT(0),
		 FEntryID INT NOT NULL DEFAULT(0),
		 FTranType INT NOT NULL DEFAULT(0),
		 FItemID INT NOT NULL DEFAULT(0),
		 FBatchNo NVARCHAR(255) NOT NULL DEFAULT(''),
		 FAuxPropID INT NOT NULL DEFAULT(0),
		 FStockID INT NOT NULL DEFAULT(0),
		 FStockPlaceID INT NOT NULL DEFAULT(0),
		 FKFPeriod INT NOT NULL DEFAULT(0),
		 FKFDate VARCHAR(20) NOT NULL DEFAULT(''),
		 FQty DECIMAL(28,10) NOT NULL DEFAULT(0),
		 FSecQty DECIMAL(28,10) NOT NULL DEFAULT(0)
		)

		INSERT INTO #TempBill(FBrNo,FInterID,FEntryID,FTranType,FItemID,FBatchNo,FAuxPropID,FStockID,FStockPlaceID,FKFPeriod,FKFDate,FQty,FSecQty)
		SELECT '',u1.FInterID,u1.FEntryID,72 AS FTranType,u1.FItemID,ISNULL(u1.FBatchNo,'') AS FBatchNo,
			   u1.FAuxPropID,ISNULL(u1.FStockID,0) AS FStockID,ISNULL(u1.FDCSPID,0) AS FDCSPID,ISNULL(u1.FKFPeriod,0) AS FKFPeriod,
			   LEFT(ISNULL(CONVERT(VARCHAR(20),u1.FKFdate ,120),''),10) AS FKFDate,
		1*u1.FQty AS FQty,1*u1.FSecQty AS FSecQty
		FROM POInstockEntry u1 INNER JOIN t_Stock t1 ON u1.FStockID=t1.FItemID
		WHERE u1.FInterID=@InterId AND t1.FTypeID=503

		UPDATE t1
		SET t1.FQty=round(t1.FQty,i.FQtyDecimal)+round(u1.FQty,i.FQtyDecimal),
		t1.FSecQty=round(t1.FSecQty,i.FQtyDecimal)+round(u1.FSecQty,i.FQtyDecimal)
		FROM POInventory t1 INNER JOIN
		(SELECT FItemID,FBatchNo,FAuxPropID,FStockID,FStockPlaceID,FKFPeriod,FKFDate
				,SUM(FQty) AS FQty,SUM(FSecQty) AS FSecQty
		 FROM #TempBill
		 GROUP BY FItemID,FBatchNo,FAuxPropID,FStockID,FStockPlaceID,FKFPeriod,FKFDate
		) u1
		ON t1.FItemID=u1.FItemID AND t1.FBatchNo=u1.FBatchNo AND t1.FAuxPropID=u1.FAuxPropID
		   AND t1.FStockID=u1.FStockID AND t1.FStockPlaceID=u1.FStockPlaceID 
		   AND t1.FKFPeriod=u1.FKFPeriod AND t1.FKFDate=u1.FKFDate
		 inner join t_ICItem i on u1.fitemid=i.fitemid 

		DELETE u1
		FROM POInventory t1 INNER JOIN #TempBill u1
		ON t1.FItemID=u1.FItemID AND t1.FBatchNo=u1.FBatchNo AND t1.FAuxPropID=u1.FAuxPropID
		   AND t1.FStockID=u1.FStockID AND t1.FStockPlaceID=u1.FStockPlaceID 
		   AND t1.FKFPeriod=u1.FKFPeriod AND t1.FKFDate=u1.FKFDate

		INSERT INTO POInventory(FBrNo,FItemID,FBatchNo,FAuxPropID,FStockID,FStockPlaceID,FKFPeriod,FKFDate,FQty,FSecQty)
		SELECT '',FItemID,FBatchNo,FAuxPropID,FStockID,FStockPlaceID,FKFPeriod,FKFDate,
			   SUM(FQty) AS FQty,SUM(FSecQty) AS FSecQty
		FROM #TempBill
		GROUP BY FItemID,FBatchNo,FAuxPropID,FStockID,FStockPlaceID,FKFPeriod,FKFDate

		UPDATE t1
		SET t1.FStockTypeID = t2.FTypeID
		FROM POInventory t1 INNER JOIN
		t_Stock t2 ON t1.FStockID = t2.FItemID
		INNER JOIN #TempBill t3 
		ON t1.FStockID = t3.FStockID 
		AND t1.FItemID = t3.FItemID 
		AND t1.FBatchNo = t3.FBatchNo 
		AND t1.FAuxPropID = t3.FAuxPropID 
		AND t1.FStockPlaceID = t3.FStockPlaceID 
		AND t1.FKFPeriod = t3.FKFPeriod 
		AND t1.FKFDate = t3.FKFDate 

		DROP TABLE #TempBill

		Update u1 SET FAuxQtyPass=FAuxQty  FROM POInStockEntry u1,t_ICItem t4  WHERE u1.FInterID=@InterId AND u1.FItemID=t4.FItemID  AND t4.FInspectionLevel=352  
		Update u1 SET FAuxQtyPass=0  FROM POInStockEntry u1,t_ICItem t4  WHERE u1.FInterID=@InterId AND u1.FItemID=t4.FItemID  AND t4.FInspectionLevel<>352 
	end

	INSERT INTO t_Log (FDate,FUserID,FFunctionID,FStatement,FDescription,FMachineName,FIPAddress) VALUES (getdate(),16394,'K000201',3,'编号为'+@BillNo+'的单据保存成功','RICHWEN','192.168.1.188')

	--set @fresultbillno=@fresultbillno+@billno

	FETCH NEXT FROM icbom_cursor 
    INTO @fuserid,@fsupplyid
END

CLOSE icbom_cursor
DEALLOCATE icbom_cursor

set nocount off

GO

--生成产品汇报--*****
--My_p_GenerateICMORpt 16394,0
IF EXISTS (select * from sysobjects where name='My_p_GenerateICMORpt' and xtype='p')  drop  procedure My_p_GenerateICMORpt

go

create procedure [dbo].My_p_GenerateICMORpt (@fuserid int,@factdate datetime,@flineid int,@fidentify int output)

as
SET NOCOUNT ON

--declare @fbout varchar(20),@iuserid int ,@frunid int,@fcommitdate datetime  select @fbout='215',@iuserid=16482,@frunid=2155,@fcommitdate='2010-06-17'

declare @fplanprice decimal(18,4),@fitemid int,@fpitemid int,@funitid int,@entryid int,@fqty int
declare @FStockId int,@StockNumber varchar (20),@BillNo varchar(20),@ficmobillno varchar(20),@InterID int
DECLARE @TmpID INT ,@fsupplyid int,@fcurrencyid int,@FMyPoInStockInterId int,@frob int
declare @fsupplyno varchar(20),@forderdate datetime,@FValueAddRate decimal(28, 2)
declare @iLength int,@FPrice decimal(28, 5),@FAmount decimal(20, 2),@FExchangeRate decimal(28, 10)
declare @FTaxPrice decimal(28, 5),@FTaxAmount decimal(20, 2),@SupplyId int,@fqtymust decimal(24,2)
declare @fprojectval  varchar(200),@fspid int,@fempid int,@fdeptid int,@fplanamount decimal(20, 2),@UpStockWhenSave int
declare @sDateFormat  varchar(200),@fdate datetime,@ficmointerid int
declare @fsourceNumber varchar(200),@fpSourceNumber varchar(200),@fpXxSourceNumber varchar(200)
declare @fXxOldSourceNumber varchar(200),@empid int,@fcostobjid int,@forderbillno varchar(30)
declare @FDCStockID int,@xx_FItemIDOld int,@fxxitemid int,@fppbominterid int
declare @FDCSPID int,@forderinterid int,@forderentryid int,@fppbomentryid int
declare @fsourceEntryid int,@fsourceBillNo varchar (100),@FDIOFInFanager int,@FDIOFInSanager int
declare @fyear int,@fperiod int,@FMangerID int,@fcustid int,@fbatchno varchar(50)
declare @fresultbillno varchar (800),@fsebillno varchar(50),@fbillerid int,@fsourceinterid int
declare @ftempbillno varchar(50),@fremark varchar(500),@fpoitemtype varchar(50)
declare @fcheck_fail int,@fsrccommitfield_prevalue decimal(28,13),@fsrccommitfield_endvalue decimal(28,13)
declare @lngNoInterIDCount int,@lngCurInterID int, @lngIt int,@lngFInterID int,@lngFEntryID int,@lngFIcmoRptInterID int

select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')
select @FDIOFInFanager=16394,@FDIOFInSanager=16394
select @UpStockWhenSave=fvalue from T_SYSTEMPROFILE where  fkey='UPSTOCKWHENSAVE'

select @fidentify=isnull(max(fid),0)+1 from my_t_identify
insert into my_t_identify(fid,fuserid,fdate,FTrantypeID) values(@fidentify,@fuserid,getdate(),551)

select isnull(t4.fbillno,'') forderbillno,t1.frptqty fqty,t2.finterid ficmointerid, t2.fitemid, t2.fcostobjid, 0 fplanprice, 
0 fplanamount, t2.fbillno ficmobillno, 
t8.funitid, isnull(t8.fspid,0) fspid, t2.fworkshop fdeptid, t2.fauxqtyfinish fcommitqty, t2.fauxqty-t2.fauxqtyfinish fqtymust,
t8.fdefaultloc fstockid, 0 fppbominterid, 0 fppbomentryid,isnull(t2.FGMPBatchNo,'') fbatchno
into #SourceData ---
from icmo t2 
inner join my_t_icmotemp t1 on t1.finterid=t2.finterid 
left join seorderentry t3 on t2.forderinterid=t3.finterid and t3.fentryid=t2.fsourceentryid
left join seorder t4 on t4.finterid=t3.finterid
inner join t_icitem t8 on t2.fitemid=t8.fitemid --
where t1.fuserid=@fuserid --and t2.fstatus=1 --and (t2.fauxqty-t2.fauxcommitqty)>0  --
and t1.frptqty>0

order by t8.fshortnumber

declare @beAllowed INT 

DECLARE icstockbillentry_cursor CURSOR FOR	

select distinct fdeptid from #SourceData t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid --where t2.ferpclsid=2 --and fnumber like '01.%' and fnumber not like '01.01.%'

OPEN icstockbillentry_cursor

FETCH NEXT FROM icstockbillentry_cursor 
INTO @fdeptid

WHILE @@FETCH_STATUS = 0
BEGIN 
	exec GetICMaxNum 'ICMO', @InterID output

	-- 10.4
	Update t_BillCodeRule Set FReChar = FReChar Where FBillTypeID =551

	SET @TmpID = (SELECT FID FROM t_BillCodeRule WITH(READUNCOMMITTED) WHERE fbilltypeid=551 and fprojectid=3)

	update t_billcoderule set fprojectval = fprojectval+1,flength=case when (flength-len(fprojectval)) >= 0 then flength else len(fprojectval) end where FID =  @TmpID 
	Update ICBillNo Set FCurNo = (select top 1 isnull(fprojectval,1) from t_billcoderule where fprojectid = 3 and fbilltypeid =551) where fbillid = 551
	   
	--长度和目前编码
	select @fprojectval=(fprojectval-1),@iLength=flength from t_BillCodeRule where fprojectid = 3 and fbilltypeid = 551
	  
	-- 前缀
	select @BillNo=fprojectval+left('0000000000',@iLength-(len(@fprojectval)))+@fprojectval from t_BillCodeRule where fprojectid = 1 and fbilltypeid = 551  --@iLength
               	
	DECLARE authors_cursor CURSOR FOR	
	select t1.forderbillno,t1.fitemid, t1.funitid, t1.fstockid, t1.fspid, t1.fdeptid, t1.fqtymust,t1.fqty, t1.ficmointerid, t1.ficmobillno, t1.fplanprice, t1.fplanamount, t1.fcostobjid, t1.fppbominterid, t1.fppbomentryid,t1.fbatchno from #SourceData t1 inner join t_icitem t2 on t1.fitemid = t2.fitemid where fdeptid=@fdeptid --and t2.ferpclsid = 2

    	set @entryid=1

	OPEN authors_cursor

	FETCH NEXT FROM authors_cursor 
	INTO @forderbillno,@fitemid,@funitid,@fstockid,@fspid,@fdeptid,@fqtymust,@fqty,@ficmointerid,@ficmobillno,@fplanprice,@fplanamount,@fcostobjid,@fppbominterid,@fppbomentryid,@fbatchno

	WHILE @@FETCH_STATUS = 0
	BEGIN 
		INSERT INTO ICMORptEntry (FInterID,FEntryID,FBrNo,FTeamID,FWorkerID,FDeviceID,FWorkStartDate,FWorkEndDate,FQtyFinish,FAuxQtyFinish,FQtyLoss,FAuxQtyLoss,FTimeUnitID,FStandardManHour,FTimeMachine,FTimeHrWork,FTimeEngPrepare,FTimeEngWork,FNote,FICMORptInterID,FQtyPass,FAuxQtyPass,FQtyScrap,FAuxQtyScrap,FQtyForItem,FAuxQtyForItem,FQtySelStock,FAuxQtySelStock,FQtyStock,FAuxQtyStock,FGMPBatchNo,FSourceEntryID,FSourceTranType,FSourceInterId,FSourceBillNo,FItemID, FUnitID) 
		VALUES (	          @InterId,@EntryId,'0',  40133,  0,        0,        @fdate,        @fdate,      @fqty,     @fqty,        0,       0,          11082,      0,               0,           0,          0,              0,           '',   0,              0,       0,          0,        0,           0,          0,             0,           0,              0,        0,           @fbatchno,  0,             85,             @ficmointerid, @ficmobillno, @fitemid,@funitid) 

		set @entryid=@entryid+1

		FETCH NEXT FROM authors_cursor 
		INTO @forderbillno,@fitemid,@funitid,@fstockid,@fspid,@fdeptid,@fqtymust,@fqty,@ficmointerid,@ficmobillno,@fplanprice,@fplanamount,@fcostobjid,@fppbominterid,@fppbomentryid,@fbatchno
	END

	CLOSE authors_cursor
	DEALLOCATE authors_cursor

	--EXEC p_UpdateBillRelateData 2,@InterId

	INSERT INTO ICMORpt(fheadselfj1115,fheadselfj1112,FHeadSelfJ1111,FInterID,FBillNo,FBrNo,FTranType,FCancellation,FStatus,FDate, FBillerID,FCheckDate,FWorkShop,FSelTranType) 
	VALUES (	    @flineid,      @factdate,     @fidentify,    @InterId,@BillNo,'0',  551,      0,            0,      @fdate,@fuserid, Null,      @fdeptid, 85)

	Update u1
	Set u1.fQtyFinish = Cast(u1.fAuxQtyFinish as Decimal(28,15))* Cast((IsNull(t2.FCoefficient, 1) + IsNull(t2.FScale, 0)) as Decimal(28,15))
	, u1.FQtyLoss = Cast(u1.FAuxQtyLoss as Decimal(28,15))* Cast((isnull(t2.FCoefficient,1)+isnull(t2.FScale,0)) as Decimal(28,15))
	, u1.FQtyPass = Cast(u1.FAuxQtyPass as Decimal(28,15))* Cast((isnull(t2.FCoefficient,1)+isnull(t2.FScale,0)) as Decimal(28,15))
	, u1.FQtyForItem = Cast(u1.FAuxQtyForItem as Decimal(28,15))* Cast((isnull(t2.FCoefficient,1)+isnull(t2.FScale,0)) as Decimal(28,15))
	, u1.FQtyScrap = Cast(u1.FAuxQtyScrap as Decimal(28,15))* Cast((isnull(t2.FCoefficient,1)+isnull(t2.FScale,0)) as Decimal(28,15))
	, u1.FBTimeHrWork = (case u1.FTimeUnitID when 11081 then Cast(u1.FTimeHrWork as Decimal(28,15)) / Cast(60.0 as Decimal(28,15)) When 11083 then Cast(u1.FTimeHrWork as Decimal(28,15)) * Cast(24.0 as Decimal(28,15)) else u1.FTimeHrWork end) 
	, u1.FBTimeEngPrepare = (case u1.FTimeUnitID when 11081 then Cast(u1.FTimeEngPrepare as Decimal(28,15)) / Cast(60.0 as Decimal(28,15)) When 11083 then Cast(u1.FTimeEngPrepare as Decimal(28,15)) * Cast(24.0 as Decimal(28,15)) else u1.FTimeEngPrepare end) 
	, u1.FBTimeEngWork = (case u1.FTimeUnitID when 11081 then Cast(u1.FTimeEngWork as Decimal(28,15)) / Cast(60.0 as Decimal(28,15)) When 11083 then Cast(u1.FTimeEngWork as Decimal(28,15)) * Cast(24.0 as Decimal(28,15)) else u1.FTimeEngWork end) 
	from IcmoRptEntry u1, t_MeasureUnit t2
	Where u1.FUnitID = t2.FItemID
	And u1.FInterID = @InterId
	       
	select @lngNoInterIDCount = count(*) from ICMORptEntry where FIcmoRptInterID = 0
	select @lngCurInterID = IsNull(FMaxNum,1000) from ICMaxNum where FTableName = 'IcmoRpt'
	select @lngIt = 1

	if @lngNoInterIDCount > 0
	Begin
		DECLARE IcmoRptEntry_cursor CURSOR SCROLL
		FOR Select FInterID, FEntryID, FICMORptInterID
			from ICMORptEntry where FIcmoRptInterID = 0
		Open IcmoRptEntry_cursor
		Fetch Next from IcmoRptEntry_cursor
		Into @lngFInterID,@lngFEntryID,@lngFIcmoRptInterID

		WHILE @@FETCH_STATUS = 0
		Begin
			Update IcmoRptEntry
			Set FIcmoRptInterID = @lngCurInterID + @lngIt
			WHERE CURRENT OF IcmoRptEntry_cursor

			Fetch Next from IcmoRptEntry_cursor
			Into @lngFInterID,@lngFEntryID,@lngFIcmoRptInterID

			select @lngIt = @lngIt + 1
		End

		Update ICMaxNum
		Set FMaxNum = @lngCurInterID + @lngNoInterIDCount
		Where FTableName = 'IcmoRpt'

		Close IcmoRptEntry_cursor
		DEALLOCATE IcmoRptEntry_cursor
	End

	Update ICMORpt Set FStatus=1,FCheckerID=@fuserid,FCheckDate=@fdate Where  FInterID=@InterId

	update src set @fsrccommitfield_prevalue=src.fqtyfinish,
	     @fsrccommitfield_endvalue=@fsrccommitfield_prevalue+dest.fqty,
	     @fcheck_fail=(case when (1=1) then @fcheck_fail else -1 end),
	     src.fqtyfinish=@fsrccommitfield_endvalue,
	     src.fauxqtyfinish=@fsrccommitfield_endvalue/cast(t1.fcoefficient as float)
	from icmo src inner join 
	(
		select u1.fsourceinterid as fsourceinterid,u1.fitemid,sum(u1.FQtyFinish) as fqty
		from  ICMORptEntry u1 
		where u1.finterid=@InterId
		group by u1.fsourceinterid,u1.fitemid
	) dest on dest.fsourceinterid = src.finterid and dest.fitemid = src.fitemid
	inner join t_measureunit t1 on src.funitid=t1.fitemid

	INSERT INTO t_Log (FDate,FUserID,FFunctionID,FStatement,FDescription,FMachineName,FIPAddress) VALUES (getdate(),@FUserId,'K010000',3,'编号为'+@BillNo+'的单据保存成功','KSW118','192.168.0.159')        		
	

	FETCH NEXT FROM icstockbillentry_cursor 
    INTO @fdeptid
END

CLOSE icstockbillentry_cursor
DEALLOCATE icstockbillentry_cursor

drop table #SourceData


set nocount off

go


IF EXISTS (select * from sysobjects where name='v_MyICQuotationFilter' and xtype='v')  drop  view v_MyICQuotationFilter

go

create view v_MyICQuotationFilter --这里用到的字段必须和v_MyICQuotationDetail一样
as

select '' 产品编码,'' 产品名称, '' 规格型号,'' 描述,'' 适用机型,'' 适用区域,'' 备注 


go



--
--IF EXISTS (select * from sysobjects where name='my_v_MrpInfo_81' and xtype='v')  drop  view my_v_MrpInfo_81
--
--go
--
--create view my_v_MrpInfo_81 
--as
--
--select --fbillno 计算编号,--暂不使用,直接用内码作为计算编号
--t1.frunid 计算编号,t1.fdate 计算日期,t1.fbilltime 计算时间,isnull(t5.fbillno,'') 销售订单,
--(select sum(cast(fqty as decimal(24,2))) from seorderentry where finterid=t5.finterid) 订单总数,t6.fname 业务员,
--t7.fnumber 客户编码,t7.fname 客户名称,
----t5.FHeadSelfS0144 客户订单号,t5.FHeadSelfS0142 包材交期,t5.FHeadSelfS0148 工厂交期,t5.FHeadSelfS0149 上线日期,t5.FHeadSelfS0150 装配完工日期,
--t1.fcommitdate 交货日期,t2.fname 计算用户,
--(case when t1.fstatus=0 then '' when t1.fstatus=1 then 'Y' end) 审核,isnull(t3.fname,'') 审核人,isnull(t1.fcheckdate,Null) 审核日期
--from my_t_Mrp t1 
--inner join t_user t2 on t1.fuserid=t2.fuserid
--left join t_user t3 on t1.fcheckerid=t3.fuserid and t3.fuserid<>0
--left join my_t_MrpSeOrder t4 on t4.frunid=t1.frunid and t4.fselect=1
--left join seorder t5 on t4.forderinterid=t5.finterid
--left join t_user t6 on t5.fbillerid=t6.fuserid and t6.fuserid<>0
--left join t_Organization t7 on t7.fitemid=t5.fcustid
--where t1.fsourcetrantype=81
--
--go
--
--
--IF EXISTS (select * from sysobjects where name='my_v_MrpInfo_87' and xtype='v')  drop  view my_v_MrpInfo_87
--
--go
--
--create view my_v_MrpInfo_87 
--as
--
--select --fbillno 计算编号,--暂不使用,直接用内码作为计算编号
--t1.frunid 计算编号,t1.fdate 计算日期,t1.fbilltime 计算时间,
--t1.fcommitdate 交货日期,t2.fname 计算用户,
--(case when t1.fstatus=0 then '' when t1.fstatus=1 then 'Y' end) 审核,isnull(t3.fname,'') 审核人,isnull(t1.fcheckdate,Null) 审核日期
--from my_t_Mrp t1 
--inner join t_user t2 on t1.fuserid=t2.fuserid
--left join t_user t3 on t1.fcheckerid=t3.fuserid and t3.fuserid<>0
--where t1.fsourcetrantype=87
--
--go


IF EXISTS (select * from sysobjects where name='v_MyPORequest' and xtype='v')  drop  view v_MyPORequest

go

create view v_MyPORequest 
as

select t1.fbillno 单据编号,isnull(t1.FHeadSelfP0126,'') 计算编号,t1.finterid 单据内码,t1.fdate 制单日期, t4.fname 制单人,
(case when t1.fstatus=0 then '' when t1.fstatus=1 then 'Y' end) 审核,
isnull(t5.fname,'') 审核人,isnull(t1.fcheckdate,Null) 审核日期,
isnull(t7.fnumber,'') 产品编码,isnull(t7.FName,'') 产品名称, isnull(t7.fmodel,'') 规格型号,
isnull(t7.fitemid,0) 产品内码,
t12.funitid 单位内码,t3.fname 单位,cast(t12.fqty as decimal(24,2)) 数量--,isnull(t10.fname,'') 采购类别
from porequest t1   
inner join t_User t4 on t1.fbillerid=t4.fuserid and t4.fuserid<>0  
left join t_User t5 on t1.fcheckerid=t5.fuserid and t5.fuserid<>0  
inner join PORequestEntry t12 on t1.finterid=t12.finterid  
inner join t_icitem t7 on t12.fitemid=t7.fitemid 
inner join t_measureunit t3 on t3.fitemid=t12.funitid
--left join t_item t10 on t10.fitemid=t7.f_115 and t10.fitemclassid=3002 and t10.fitemid<>0

go

--select * from icmo where fbillno='zp201505391'

--生成或刷新投料单-----半成品任务单的投料单直接由系统下达生成
--My_P_AddOrEditPPBom 16394,36372,0
IF EXISTS (select * from sysobjects where name='My_P_AddOrEditPPBom' and xtype='p')  drop  procedure My_P_AddOrEditPPBom

go

create procedure [dbo].My_P_AddOrEditPPBom(@fuserid int,@ficmointerid int,@fitemtype int) --@fitemtype  100 全部 0 成品 1 半成品  2 常规物料 3 包材 4 半制品

as
--declare @fuserid int,@ficmointerid int,@fitemtype int select @fuserid=16394,@ficmointerid=,@fitemtype=0
declare @fplanprice decimal(18,4),@fitemid int,@fpitemid int,@funitid int,@entryid int,@fqty int
declare @InterID int,@BillNo varchar (20),@FStockId int,@StockNumber varchar (20)
DECLARE @TmpID INT ,@fsupplyid int,@fcurrencyid int,@FMyPoInStockInterId int,@fscrap decimal(24,4)
declare @fsupplyno varchar(20),@forderdate datetime,@FValueAddRate decimal(28, 2),@FSendItemDate datetime
declare @iLength int,@FPrice decimal(28, 5),@FAmount decimal(20, 2),@FExchangeRate decimal(28, 10)
declare @FTaxPrice decimal(28, 5),@FTaxAmount decimal(20, 2),@SupplyId int,@FQtyScrap decimal(24,4)
declare @fprojectval varchar(200),@fspid int,@fempid int,@fdeptid int,@fqtymust decimal(24,2)
declare @FDateFormat varchar(200),@fdate datetime,@forginterid int,@FBomInputQty decimal(24,4)
declare @fsourceNumber varchar(200),@fpSourceNumber varchar(200),@fpXxSourceNumber varchar(200)
declare @fXxOldSourceNumber varchar(200),@empid int,@fsourcetrantype int
declare @FDCStockID int,@xx_FItemIDOld int,@fxxitemid int,@FOrgPPOInterID int
declare @FDCSPID int,@forderinterid int,@forderentryid int
declare @fsourceInterid int,@fsourceEntryid int,@fsourceBillNo varchar (100),@FOrderBillNo varchar (100)
declare @fyear int,@fperiod int,@FMangerID int,@FSourceSEBillNo varchar (100),@FSourcePOBillNo varchar (100)
declare @fresultbillno varchar (800),@FPlanFinishDate datetime,@fnote varchar(500)
declare @ftempbillno varchar(50),@fcostobjid int,@fplancommitdate datetime,@fsourceid int
declare @fplanorderinterid int,@fbominterid int,@forgsaleinterid int,@forgentryid int
--AIS20041229163526   AIS20080129143619
--declare @fbout varchar(10),@fcommitdate datetime

select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期
set @forderdate=@fdate  --'2009-06-15' --下单日期
--set @fcommitdate='2009-07-21' --到货日期
select @fresultbillno='',@BillNo='',@InterID=0

--set @fbout='204'

--select @fidentify=isnull(max(fid),0)+1 from my_t_identify
--insert into my_t_identify(fid,fuserid,fdate,FTrantypeID) values(@fidentify,@fuserid,getdate(),85)

create table #DataEntry(funitid int,fitemid int,FQtyScrap decimal(24,4),FBomInputQty  decimal(24,4),fscrap  decimal(24,4),fqtymust decimal(24,2),fstockid int)

select @FItemId=t1.fitemid,@funitid=t1.funitid,@fqty=t1.fqty,@fcostobjid=t1.FCostObjID,
@fsourceid=t1.fworkshop,@InterID=isnull(t2.finterid,0),@FSendItemDate=t1.fplancommitdate,
@fplancommitdate=fplancommitdate,@FPlanFinishDate=FPlanFinishDate,@fnote=isnull(t1.fnote,''),
@FSourcePOBillNo=t1.FHeadSelfJ0176,@FSourceSEBillNo=t1.FHeadSelfJ0177,
@FOrderBillNo=isnull(t3.fbillno,''),@forderinterid=isnull(t1.forderinterid,0)
from icmo t1
left join ppbom t2 on t2.ficmointerid=t1.finterid
left join seorder t3 on t1.forderinterid=t3.finterid
where t1.finterid=@ficmointerid

if @InterID=0
begin
	exec GetICMaxNum 'PPBOM', @InterID output

	-- 10.4
	Update t_BillCodeRule Set FReChar = FReChar Where FBillTypeID =88

	SET @TmpID = (SELECT FID FROM t_BillCodeRule WITH(READUNCOMMITTED) WHERE fbilltypeid=88 and fprojectid=3)

	update t_billcoderule set fprojectval = fprojectval+1,flength=case when (flength-len(fprojectval)) >= 0 then flength else len(fprojectval) end where FID =  @TmpID 
	Update ICBillNo Set FCurNo = (select top 1 isnull(fprojectval,1) from t_billcoderule where fprojectid = 3 and fbilltypeid =88) where fbillid = 88
	   
	--长度和目前编码
	select @fprojectval=(fprojectval-1),@iLength=flength from t_BillCodeRule where fprojectid = 3 and fbilltypeid = 88
	  
	-- 前缀
	select @BillNo=fprojectval+left('0000000000',@iLength-(len(@fprojectval)))+@fprojectval from t_BillCodeRule where fprojectid = 1 and fbilltypeid = 88  --@iLength

    Insert Into PPBOM (FHeadSelfY0226,FHeadSelfY0224,  FHeadSelfY0225,  FHeadSelfY0222,  FHeadSelfY0223,  FBrNo,FOrderInterID, FOrderBillNo, FInterID,FBillNo,FTranType,FDate, FBillerID , FCheckerID, FCheckDate,FStatus,FICMOInterID, FCancelLation,FItemID, FUnitID, FAuxQty,FType,FWorkShop) 
	Values(            @fnote,        @FSourcePOBillNo,@FSourceSEBillNo,@fplancommitdate,@FPlanFinishDate,'0',  @forderinterid,@FOrderBillNo,@InterId,@BillNo,88,       @fdate,@fuserid,   NULL,       Null,      0,      @FICMOInterID,0,            @FItemId,@funitid,@fqty,  1054, @fsourceid)

	Update PPBOM Set FStatus=1,FCheckerID=@fuserid,FCheckDate=@fdate Where FInterID=@InterId
end

if @fitemtype=0 --and not exists(select 1 from ppbomentry t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid where t1.finterid=@InterID and t1.fqty>0)
begin
	--外调自包
	--insert into #DataEntry(funitid,   fitemid,                     FQtyScrap,  FBomInputQty,          fscrap,  fqtymust,                  fstockid)
	--select                 t9.funitid,isnull(t9.fitemid,0) fitemid,1 FQtyScrap,t8.fqty*1 FBomInputQty,0 fscrap,(t8.fqty*1*(1+0)) fqtymust,29734
	--from seorderentry t1 
	--inner join seorder t7 on t1.finterid=t7.finterid
	--inner join t_icitem t2 on t1.fitemid=t2.fitemid 
	--inner join t_measureunit t3 on t3.fitemid=t2.funitid
	--inner join icmo t8 on t1.finterid=t8.forderinterid and t1.fentryid=t8.fsourceentryid  --已经下了任务单的
	--inner join t_icitem t9 on t9.fitemid=t1.fitemid  --半成品(自己)
	--where t8.finterid=@ficmointerid 
	----and not exists (select 1 from ppbomentry where ficmointerid=t8.finterid and (fitemid=t9.fitemid or isnull(folditemid,0)=t9.fitemid))
	----and left(t2.fnumber,1) in ('A','P')
	--and isnull(t1.FEntrySelfS0175,0) in (40090) --40089	自产自包,40090	外调自包,40091	外调外包

--	--半成品和常规物料或包材、非硒鼓成品下面的常规物料或包材
--	if not exists(select 1 from ppbomentry t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid where t1.finterid=@InterID and t1.fqty>0 and t2.fnumber not like '2.%')  --如果常规物料还未开始领料
--	begin
--	delete t1 
--	from ppbomentry t1 
--	inner join t_icitem t2 on t1.fitemid=t2.fitemid 
--	where t1.finterid=@InterID and t2.fnumber not like '2.%'  --有替换的???????????????
--	and t1.fqty=0 and isnull(t1.folditemid,0)=0

	----套件已设置为虚拟件,半成品任务单K3功能自动会展开最下一级
--	if exists (select * from t_SystemProfile where FCategory='IC' and fkey='FIsPlasticManage' and fvalue='1')
--	begin
--		insert into #DataEntry(funitid,   fitemid,   FQtyScrap,        FBomInputQty,                fscrap,   fqtymust,                                                           fstockid)
--		select                 t9.funitid,t9.fitemid,t1.fqty FQtyScrap,t8.fqty*t1.fqty FBomInputQty,t1.fscrap,cast((t8.fqty*t1.fqty*(1+t1.fscrap/100)) as decimal(24,2)) fqtymust,isnull(t9.fdefaultloc,0) fstockid
--		from icbomchild t1 
--		inner join icbom t7 on t1.finterid=t7.finterid
--		inner join t_icitem t2 on t7.fitemid=t2.fitemid 
--		inner join t_measureunit t3 on t3.fitemid=t2.funitid
--		inner join icmo t8 on t8.fitemid=t7.fitemid
--		inner join t_icitem t9 on t9.fitemid=t1.fitemid  --半成品BOM的常规物料或包材(有些包材直接用在半成品上)
--		where t8.finterid=@ficmointerid and t7.fusestatus=1072 and isnull(t8.forderinterid,0)=0 
--		and t9.fnumber not like '1.02.%'  --非套件
--		union all
--		select t6.funitid,t6.fitemid,t1.fqty*t5.fqty FQtyScrap,t8.fqty*t1.fqty*t5.fqty FBomInputQty,(1+t1.fscrap)*t5.fscrap fscrap,cast((t8.fqty*t1.fqty*(1+t1.fscrap/100)*t5.fqty*(1+t5.fscrap/100)) as decimal(24,2)) fqtymust,isnull(t6.fdefaultloc,0) fstockid
--		from icbomchild t1 
--		inner join icbom t7 on t1.finterid=t7.finterid
--		inner join t_icitem t2 on t7.fitemid=t2.fitemid 
--		inner join t_measureunit t3 on t3.fitemid=t2.funitid
--		inner join icmo t8 on t8.fitemid=t7.fitemid
--		inner join t_icitem t9 on t9.fitemid=t1.fitemid  --半成品BOM的常规物料或包材(有些包材直接用在半成品上)
--		inner join icbom t4 on t4.fitemid=t9.fitemid
--		inner join icbomchild t5 on t5.finterid=t4.finterid
--		inner join t_icitem t6 on t6.fitemid=t5.fitemid
--		where t8.finterid=@ficmointerid and t7.fusestatus=1072 and isnull(t8.forderinterid,0)=0 
--		and t9.fnumber like '1.02.%' and t6.fnumber like '6.%' --如果是套件,则展开到子件
--	end
--	else
--	begin  
--		insert into #DataEntry(funitid,   fitemid,   FQtyScrap,        FBomInputQty,                fscrap,   fqtymust,                                                           fstockid)
--		select                 t9.funitid,t9.fitemid,t1.fqty FQtyScrap,t8.fqty*t1.fqty FBomInputQty,t1.fscrap,cast((t8.fqty*t1.fqty*(1+t1.fscrap/100)) as decimal(24,2)) fqtymust,isnull(t9.fdefaultloc,0) fstockid
--		from icbomchild t1 
--		inner join icbom t7 on t1.finterid=t7.finterid
--		inner join t_icitem t2 on t7.fitemid=t2.fitemid 
--		inner join t_measureunit t3 on t3.fitemid=t2.funitid
--		inner join icmo t8 on t8.fitemid=t7.fitemid
--		inner join t_icitem t9 on t9.fitemid=t1.fitemid  --半成品BOM的常规物料或包材(有些包材直接用在半成品上)
--		where t8.finterid=@ficmointerid and t7.fusestatus=1072 and isnull(t8.forderinterid,0)=0 
--	end

	----非外调品要配置半成品和芯片
	insert into #DataEntry(funitid,   fitemid,                     FQtyScrap,  FBomInputQty,          fscrap,  fqtymust,                         fstockid)
	--select                 t9.funitid,isnull(t9.fitemid,0) fitemid,1 FQtyScrap,t8.fqty*1 FBomInputQty,0 fscrap,(t8.fqty*1*(1+0)) fqtymust,isnull(t9.fdefaultloc,0) fstockid
	--from seorderentry t1 
	--inner join seorder t7 on t1.finterid=t7.finterid
	--inner join t_icitem t2 on t1.fitemid=t2.fitemid 
	--inner join t_measureunit t3 on t3.fitemid=t2.funitid
	--inner join icmo t8 on t1.finterid=t8.forderinterid and t1.fentryid=t8.fsourceentryid  --已经下了任务单的
	--inner join t_icitem t9 on t9.fitemid=t1.fentryselfs0164 and t9.fitemid<>0 --半成品
	--where t8.finterid=@ficmointerid 
	----and not exists (select 1 from ppbomentry where ficmointerid=t8.finterid and (fitemid=t9.fitemid or isnull(folditemid,0)=t9.fitemid))
	--and left(t2.fnumber,1) in ('A','P')
	----and isnull(t1.FEntrySelfS0175,0) not in (40090,40091) --40089	自产自包,40090	外调自包,40091	外调外包
	--union all
	--select t9.funitid,isnull(t9.fitemid,0) fitemid,1 FQtyScrap,t8.fqty*1 FBomInputQty,0 fscrap,(t8.fqty*1*(1+0)) fqtymust,isnull(t9.fdefaultloc,0) fstockid
	--from seorderentry t1 
	--inner join seorder t7 on t1.finterid=t7.finterid
	--inner join t_icitem t2 on t1.fitemid=t2.fitemid 
	--inner join t_measureunit t3 on t3.fitemid=t2.funitid
	--inner join icmo t8 on t1.finterid=t8.forderinterid and t1.fentryid=t8.fsourceentryid --已经下了任务单的
	--inner join t_icitem t9 on t9.fitemid=t1.fentryselfs0161 and t9.fitemid<>0 --芯片
	--where t8.finterid=@ficmointerid 
	----and not exists (select 1 from ppbomentry where ficmointerid=t8.finterid and (fitemid=t9.fitemid or isnull(folditemid,0)=t9.fitemid))
	--and left(t2.fnumber,1) in ('A','P')
	--union all

	--and not exists (select 1 from ppbomentry where ficmointerid=t8.finterid and (fitemid=t9.fitemid or isnull(folditemid,0)=t9.fitemid))
	--union all

	select t9.funitid,isnull(t9.fitemid,0) fitemid,t1.fqty FQtyScrap,t8.fqty*t1.fqty FBomInputQty,t1.fscrap,
	ROUND((case when t9.FPutInteger=1 then ceiling(t1.fqty*t8.fqty*(1+t1.fscrap/100)) else t1.fqty*t8.fqty*(1+t1.fscrap/100) end),t9.FQtyDecimal) fqtymust,
	--cast((t8.fqty*t1.fqty*(1+t1.fscrap/100)) as decimal(24,2)) fqtymust,
	isnull(t9.fdefaultloc,0) fstockid
	from icbomchild t1 
	inner join icbom t7 on t1.finterid=t7.finterid
	inner join t_icitem t2 on t7.fitemid=t2.fitemid 
	inner join t_measureunit t3 on t3.fitemid=t2.funitid
	inner join icmo t8 on t8.fitemid=t7.fitemid
	inner join t_icitem t9 on t9.fitemid=t1.fitemid  --非硒鼓成品的BOM物料
	where t8.finterid=@ficmointerid and t7.fusestatus=1072 and isnull(t8.forderinterid,0)<>0 
	and left(t2.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0)
	and t9.fnumber not like '1.02.%'  --非套件
	union all
	select t6.funitid,t6.fitemid,t1.fqty*t5.fqty FQtyScrap,t8.fqty*t1.fqty*t5.fqty FBomInputQty,(1+t1.fscrap)*t5.fscrap fscrap,
	cast((t8.fqty*t1.fqty*(1+t1.fscrap/100)*t5.fqty*(1+t5.fscrap/100)) as decimal(24,2)) fqtymust,
	isnull(t6.fdefaultloc,0) fstockid
	from icbomchild t1 
	inner join icbom t7 on t1.finterid=t7.finterid
	inner join t_icitem t2 on t7.fitemid=t2.fitemid 
	inner join t_measureunit t3 on t3.fitemid=t2.funitid
	inner join icmo t8 on t8.fitemid=t7.fitemid
	inner join t_icitem t9 on t9.fitemid=t1.fitemid  --半成品BOM的常规物料或包材(有些包材直接用在半成品上)
	inner join icbom t4 on t4.fitemid=t9.fitemid
	inner join icbomchild t5 on t5.finterid=t4.finterid
	inner join t_icitem t6 on t6.fitemid=t5.fitemid
	where t8.finterid=@ficmointerid and t7.fusestatus=1072 and isnull(t8.forderinterid,0)<>0 
	and left(t2.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0)
	and t9.fnumber like '1.02.%' and t6.fnumber like '6.%' --如果是套件,则展开到子件

	--and not exists (select 1 from ppbomentry where ficmointerid=t8.finterid and fitemid=t9.fitemid)
end

----成品直接下级的包材--包材可能出现在以下情况: 1 半成品下面 2 非硒鼓成品BOM 3 包装方案  --此处只考虑 2 和 3 即可
----if not exists(select 1 from ppbomentry t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid where t1.finterid=@InterID and t1.fqty>0 and t2.fnumber like '2.%')  --如果包材物料还未开始领料
--if @fitemtype=3
--begin
----	delete t1 
----	from ppbomentry t1 
----	inner join t_icitem t2 on t1.fitemid=t2.fitemid 
----	inner join icmo t3 on t3.finterid=t1.ficmointerid
----	inner join t_icitem t4 on t4.fitemid=t3.fitemid
----	where t1.finterid=@InterID and t2.fnumber like '2.%' and isnull(t3.forderinterid,0)<>0
----	and t1.fqty=0 and isnull(t1.folditemid,0)=0 

--	insert into #DataEntry(funitid,   fitemid,                     FQtyScrap,         FBomInputQty,                 fscrap,                                                                   fstockid,                         fqtymust                                                                                                                     )
--	--select                 t9.funitid,isnull(t9.fitemid,0) fitemid,t12.fqty FQtyScrap,t8.fqty*t12.fqty FBomInputQty,(case when left(t9.fnumber,4) in ('2.05','2.06') then 0.3 else 0 end) fscrap,isnull(t9.fdefaultloc,0) fstockid,(case when left(t9.fnumber,5)='2.01.' then ceiling(t8.fqty*t12.fqty*(1+0/100)) else t8.fqty*t12.fqty*(1+(case when left(t9.fnumber,4) in ('2.05','2.06') then 0.3 else 0 end)/100) end) fqtymust
--	select                 t9.funitid,isnull(t9.fitemid,0) fitemid,t12.fqty FQtyScrap,t8.fqty*t12.fqty FBomInputQty,0 fscrap,isnull(t9.fdefaultloc,0) fstockid,(case when left(t9.fnumber,5)='2.01.' then ceiling(t8.fqty*t12.fqty*(1+0/100)) else t8.fqty*t12.fqty*(1+0/100) end) fqtymust
--	from seorderentry t1 
--	inner join seorder t7 on t1.finterid=t7.finterid
--	inner join t_icitem t2 on t1.fitemid=t2.fitemid 
--	inner join t_measureunit t3 on t3.fitemid=t2.funitid
--	inner join icmo t8 on t1.finterid=t8.forderinterid and t1.fentryid=t8.fsourceentryid --已经下了任务单的
--	inner join (select min(fid) fid,fproductid,fbrandid,min(fchecker) fchecker from t_BOSPackSub group by fproductid,fbrandid) t11 on t11.fproductid=t1.fitemid and t11.fbrandid=t1.fentryselfs0158
--	inner join t_BOSPackSubEntry t12 on t11.fid=t12.fid
--	inner join t_icitem t9 on t9.fitemid=t12.fitemid  --包材
--	where t8.finterid=@ficmointerid and isnull(t11.fchecker,0)>0 
--	--and not exists (select 1 from ppbomentry where ficmointerid=t8.finterid and (fitemid=t9.fitemid or isnull(folditemid,0)=t9.fitemid))
----	union all
----	select                 t9.funitid,isnull(t9.fitemid,0) fitemid,t1.fqty FQtyScrap, t8.fqty*t1.fqty FBomInputQty,t1.fscrap,isnull(t9.fdefaultloc,0) fstockid,cast((t8.fqty*t1.fqty*(1+t1.fscrap/100)) as decimal(24,2)) fqtymust
----	from icbomchild t1 
----	inner join icbom t7 on t1.finterid=t7.finterid
----	inner join t_icitem t2 on t7.fitemid=t2.fitemid 
----	inner join t_measureunit t3 on t3.fitemid=t2.funitid
----	inner join icmo t8 on t8.fitemid=t7.fitemid
----	inner join t_icitem t9 on t9.fitemid=t1.fitemid  --非硒鼓成品的BOM包材
----	where t8.finterid=@ficmointerid and t7.fusestatus=1072 and isnull(t8.forderinterid,0)<>0 and left(t2.fnumber,1) not in ('A','P')
----	and t9.fnumber like '2.%'
----	and not exists (select 1 from ppbomentry where ficmointerid=t8.finterid and fitemid=t9.fitemid)
--end



--上面先全部取数，此处再判断
if not exists(select 1 from PPBOMEntry t1 where t1.finterid=@InterID and (t1.fqty>0 or isnull(t1.folditemid,0)<>0))  --and t1.FEntrySelfY0259=@fitemtype
begin
	delete t1 
	from ppbomentry t1 
	where t1.finterid=@InterID --and t1.FEntrySelfY0259=@fitemtype

	select @entryid=isnull(max(fentryid),0)+1 from ppbomentry where finterid=@InterID
	
	DECLARE authorsentry_cursor CURSOR FOR
	select t1.funitid,t1.fitemid,t1.FQtyScrap,t1.FBomInputQty,t1.fscrap,t1.fqtymust,t1.fstockid 
	from #DataEntry t1 
	inner join t_icitem t2 on t1.fitemid=t2.fitemid
	order by t2.fnumber
		
	OPEN authorsentry_cursor

	FETCH NEXT FROM authorsentry_cursor 
	INTO @funitid,@fitemid,@FQtyScrap,@FBomInputQty,@fscrap,@fqtymust,@fstockid

	WHILE @@FETCH_STATUS = 0
	BEGIN 
		--icmo fstatus 5 确认 0 计划 1,2 下达 3 结案  fmrp 11061 mps产生 1052 手工录入 11077 mrp产生 
		--ppbomentry fqtyscrp 单位用量  FScrap 损耗率
		Insert Into PPBOMEntry (FEntrySelfY0259,fentryselfy0257,FICMOinterID,   FBrNo,FInterID,FEntryID,FItemID, FUnitID, FAuxQtyMust,FAuxQty,FMachinePos,FBomInputAuxQty,FauxQtyLoss,FSequenceID,FStockID, FNote,FSourceEntryID,FAuxQtyScrap,FScrap,  FSendItemDate,  FAuxQtyPick,  FSPID,FOperID,FOperSN,FMaterielType,FBackFlush,FMarshalType,FBOMInterID,FBatchNO )
		Values (                @fitemtype,     @fcostobjid,    @ficmointerid,  '0',  @Interid,@entryid,@fitemid,@funitid,@fqtymust,  0,      '',         @FBomInputQty,  0,          '',         @fstockid,'',   0,             @FQtyScrap,  @fscrap, @FSendItemDate, @FBomInputQty,0,    0,      0,      371,          1059,      385,         0,          '')

		set @entryid=@entryid+1

		FETCH NEXT FROM authorsentry_cursor 
		INTO @funitid,@fitemid,@FQtyScrap,@FBomInputQty,@fscrap,@fqtymust,@fstockid
	END

	CLOSE authorsentry_cursor
	DEALLOCATE authorsentry_cursor
end

EXEC prc_SHUpdateBillDoubleQty 88,@Interid


--单据编号自定义的

drop table #DataEntry

set nocount off

GO




IF EXISTS (select * from sysobjects where name='My_Tri_BosSeChangeRecord'  and xtype='TR')  drop  TRIGGER My_Tri_BosSeChangeRecord
go

Create TRIGGER [dbo].[My_Tri_BosSeChangeRecord] ON [dbo].[t_BosSeChangeRecord]
FOR UPDATE

AS
BEGIN
	SET NOCOUNT ON
	declare @FInterID int  
	declare @FChecker int,@FBrandId int,@FProductID int
	declare @fbillno varchar(30)
	declare @fstatus int,@s varchar(800)
	declare @fsourcebillno varchar(50),@ftargetbillno varchar(50),@fsourceitemid int,@ftargetitemid int,@fsourceinterid int,@ftargetinterid int

	select top 1 @fbillno=fbillno,@FInterID=fid,@FChecker=isnull(FChecker,0) from INSERTED 

	/*
	if update(FChecker) and @FChecker=0  --反审核
-- 	begin
-- 		if exists (select 1
-- 		from seorder t1
-- 		inner join seorderentry t2 on t1.finterid=t2.finterid
-- 		inner join t_icitem t4 on t4.fitemid=t2.fitemid
-- 		where t2.fentryselfs0160=@fbillno
-- 		)
-- 		begin
-- 			select @s='该包装方案已经被销售订单使用,不能反审核!'
-- 			--ROLLBACK TRAN
-- 			RAISERROR(@s,18,18)
-- 		end
-- 	end
	*/

	if update(FChecker) and @FChecker<>0  --审核
	begin
		exec My_P_SeChangeRecord @FChecker,@FInterID
	end
END


GO


--销售订单变更申请--***** --select * from t_BosSeChangeRecord where fbillno='sc001074'
--My_P_SeChangeRecord 16394,1854
IF EXISTS (select * from sysobjects where name='My_P_SeChangeRecord' and xtype='p')  drop  procedure My_P_SeChangeRecord
go

create procedure [dbo].My_P_SeChangeRecord (@fuserid int,@fsourceinterid int) --

as
set nocount on

--declare @fsourceinterid int,@fuserid int select @fsourceinterid=1840,@fuserid=16394

declare @funitid int,@entryid int,@fqty decimal(24,2),@fsourcebillno varchar(50),@fsourceentryid int
declare @fpackinterid int,@fchildqty decimal(24,2),@fbomqty decimal(24,2),@bHaveExists bit
DECLARE @TmpID INT ,@FBomInterID int,@flevel varchar(20),@fprepscrap decimal(24,4),@fprepscrapqty decimal(24,2)
declare @iLength int,@fserial varchar(20),@fstockid int,@fchilditemid int,@fhavechild bit
declare @fprojectval  varchar(200),@ferpclsname varchar(20),@fperqty decimal(24,2),@fcustid int
declare @sDateFormat  varchar(200),@fdate datetime,@s varchar(2000),@fsupplyid int,@FOLDItemID int
declare @FNumber varchar(200),@FChildNumber varchar(200),@FName varchar(200),@FChildName varchar(200)
declare @FUnit varchar(200),@FMachinePos varchar(200),@FNote varchar(200),@FPage varchar(200)
declare @FOLDBrandID int,@FBrandID int,@FOLDPackSub	varchar (50),@FPackSub varchar (50),@ficmointerid int
declare	@FOLDQty decimal (24,2),@FOLDPrice	decimal (24,2),@FPrice decimal (24,2)
declare @FOLDRemark	varchar (500),@FRemark	varchar (500),@FOLDChipVerID int,@FChipVerID int
declare @FCurrencyID int,@FOLDCurrencyID int,@FOLDCustID int,@forderinterid int,@Result bit

declare @ftaxprice decimal(24,4),@fcess decimal(24,2)
declare @famount decimal(24,2)
declare @fallamount decimal(24,2)
declare @FAllStdAmount decimal(24,2)
declare @FTaxAmt decimal(24,2),@FExchangeRate decimal(28,10)

select @fdate=replace(convert(varchar(10),getdate(),111),'/','-'),@fhavechild=0
declare @fitemid int,@fcontactno varchar(20),@flag int

select @FOLDBrandID=0,@FBrandID=0,@FOLDPackSub='',@FPackSub='',@FOLDQty=0,@FQty=0,@FOLDPrice=0,@FPrice=0,
@FOLDRemark='',@FRemark='' ,@FOLDItemID=0,@FItemID=0,@FPrice=0,@FOLDPrice=0,@FCurrencyID=0,@FOLDCurrencyID=0,
@FCustID=0,@FOLDCustID=0,@forderinterid=0

select @forderinterid=t2.FID_SRC,@FCurrencyID=isnull(t1.FCurrencyID,0) ,@FOLDCurrencyID=isnull(t1.FOLDCurrencyID,0),
@FCustID=isnull(t1.FCustID,0) ,@FOLDCustID=isnull(t1.FOLDCustID,0) 
from t_BosSeChangeRecord t1 
inner join t_BosSeChangeRecordEntry t2 on t1.fid=t2.fid
where t1.fid=@fsourceinterid 

--99999	35	1	跟单  --变更单价、币别、客户的权限
--99999	35	2	包装  --有第一次填写包装方式的权限
--99999	35	3	物控  --有变更包装方式、芯片版本的权限

if @FCurrencyID<>@FOLDCurrencyID  --如果改了币别,先改表头,表体在下面中改
begin
	--set @Result=0
	--exec My_p_IsHaveRight 99999,35,1,@fuserid,@Result output
	--if @Result=0
	--begin
	--	RAISERROR('你无变更[币别]的权限!',18,18)
	--end

	select @FExchangeRate=FExchangeRate from t_currency where fcurrencyid=@FCurrencyID

	update t1 set fcurrencyid=@FCurrencyID,FExchangeRate=@FExchangeRate from seorder t1 where finterid=@forderinterid
end

if @FCustID<>@FOLDCustID
begin
	--set @Result=0
	--exec My_p_IsHaveRight 99999,35,1,@fuserid,@Result output
	--if @Result=0
	--begin
	--	RAISERROR('你无变更[客户]的权限!',18,18)
	--end

	update t1 set fcustid=@FCustID from seorder t1 where finterid=@forderinterid
end

DECLARE Seorder_Cursor CURSOR FOR
select t2.fitemid,t2.FID_SRC,t2.FEntryID_SRC,isnull(t3.finterid,0) ficmointerid,
isnull(t2.FOLDBrandID,0) FOLDBrandID,isnull(t2.FBrandID,0) FBrandID,
isnull(t2.FOLDChipVerID,0) FOLDChipVerID,isnull(t2.FChipVerID,0) FChipVerID,
isnull(t2.FOLDPrice,0) FOLDPrice,isnull(t2.FPrice,0) FPrice
from t_BosSeChangeRecord t1
inner join t_BosSeChangeRecordEntry t2 on t1.fid=t2.fid
left join icmo t3 on t3.forderinterid=t2.FID_SRC and t2.FEntryID_SRC=t3.fsourceentryid and t3.fstatus in (1,2)  
where t1.fid=@fsourceinterid 

OPEN Seorder_Cursor

FETCH NEXT FROM Seorder_Cursor 
INTO @fitemid,@fsourceinterid,@fsourceentryid,@ficmointerid,@FOLDBrandID,@FBrandID,@FOLDChipVerID,@FChipVerID,@FOLDPrice,@FPrice

WHILE @@FETCH_STATUS = 0
BEGIN
	if @FOLDBrandID<>@FBrandID --包装方式
	begin
		--if @FOLDBrandID<>0 --不是第一次填
		--begin
		--	set @Result=0
		--	exec My_p_IsHaveRight 99999,35,3,@fuserid,@Result output
		--	if @Result=0
		--	begin
		--		RAISERROR('你无变更[包装方式]的权限!',18,18)
		--	end
		--end

		update t1 set fentryselfs0158=@FBrandID 
		from seorderentry t1 where t1.finterid=@fsourceinterid and t1.fentryid=@fsourceentryid

		update t2 set FEntrySelfP0247=@FBrandID 
		from seorderentry t1 
		inner join poorderentry t2 on t1.finterid=t2.fsourceinterid and t1.fentryid=t2.fsourceentryid and t2.fsourcetrantype=81
		where t1.finterid=@fsourceinterid and t1.fentryid=@fsourceentryid
	end

	if not exists(select 1 from ppbomentry t1 where ficmointerid=@ficmointerid and FEntrySelfY0259=3 and (t1.fqty>0 or isnull(t1.folditemid,0)<>0)) and @ficmointerid>0 --已经关联生产任务单 
	begin
		if @FOLDBrandID<>@FBrandID --改了包装方式
		begin
			exec My_P_AddOrEditPPBom @fuserid,@ficmointerid,3
		end
	end
    --exec My_p_IsHaveRight 

	if @FOLDBrandID<>@FChipVerID --改了芯片版本
	begin
		--set @Result=0
		--exec My_p_IsHaveRight 99999,35,3,@fuserid,@Result output
		--if @Result=0
		--begin
		--	RAISERROR('你无变更[芯片版本]的权限!',18,18)
		--end

		update t1 set fentryselfs0160=@FChipVerID from seorderentry t1 
		where t1.finterid=@fsourceinterid and t1.fentryid=@fsourceentryid

		update t2 set FEntrySelfP0248=@FChipVerID 
		from seorderentry t1 
		inner join poorderentry t2 on t1.finterid=t2.fsourceinterid and t1.fentryid=t2.fsourceentryid and t2.fsourcetrantype=81
		where t1.finterid=@fsourceinterid and t1.fentryid=@fsourceentryid
	end

	if (@FPrice<>@FOLDPrice) or (@FCurrencyID<>@FOLDCurrencyID) --改了单价
	begin
		--set @Result=0
		--exec My_p_IsHaveRight 99999,35,1,@fuserid,@Result output
		--if @Result=0
		--begin
		--	RAISERROR('你无变更[单价]的权限!',18,18)
		--end

		set @ftaxprice=@FPrice
		select @fcess=t1.fcess,@fqty=t1.fqty from seorderentry t1 where t1.finterid=@fsourceinterid and t1.fentryid=@fsourceentryid
		
		select @fprice=@ftaxprice/(1+@fcess/100)
		select @famount=@fprice*@fqty
		select @fallamount=@ftaxprice*@fqty
		--select @FAllStdAmount=@fallamount*@FExchangeRate
		select @FTaxAmt=@famount*(@fcess/100)  --销项税额 

		--select t2.finterid,Fauxprice=@fprice,FAuxTaxPrice=@ftaxprice,Famount=@famount,FCess=@FCess,FAuxPriceDiscount=@ftaxprice,FTaxAmt=@FTaxAmt,FAllAmount=@FAllAmount,FAllStdAmount=@fallamount*t2.FExchangeRate
		update t1 set Fauxprice=@fprice,FAuxTaxPrice=@ftaxprice,FTaxPrice=@ftaxprice,
		Famount=@famount,FCess=@FCess,FAuxPriceDiscount=@ftaxprice,FTaxAmt=@FTaxAmt,
		FAllAmount=@FAllAmount,FAllStdAmount=@fallamount*t2.FExchangeRate
		from SEOrderEntry t1
		inner join seorder t2 on t1.finterid=t2.finterid
		where t1.finterid=@fsourceinterid and t1.fentryid=@fsourceentryid

		update t2 set 
		fprice=t2.FTaxPrice/(1+t2.fcess/100),--单价与折扣率没关系
		FAuxPrice=t2.FTaxPrice/(1+t2.fcess/100),
		famount=cast(t2.fqty*t2.FTaxPrice*(1-t2.FTaxRate/100)/(1+t2.fcess/100) as decimal(28,2)),--不是等于单价×数量
		fpricediscount=t2.FTaxPrice*(1-t2.FTaxRate/100),--实际含税单价
		fauxpricediscount=t2.FTaxPrice*(1-t2.FTaxRate/100),
		ftaxamount=cast(t2.fqty*t2.FTaxPrice*t2.FTaxRate/100 as decimal(28,2)),--折扣额
		FTaxAmt=cast(t2.fqty*t2.FTaxPrice*(1-t2.FTaxRate/100)/(1+t2.fcess/100)*(t2.fcess/100) as decimal(28,2)) --税额
		from seorder t3
		inner join seorderentry t2 on t3.finterid=t2.finterid
		where t2.finterid=@fsourceinterid and t2.fentryid=@fsourceentryid

		update t2 set fallAmount=cast((t2.FTaxAmt+t2.famount) as decimal(28,2))
		from seorder t3
		inner join seorderentry t2 on t3.finterid=t2.finterid
		where t2.finterid=@fsourceinterid and t2.fentryid=@fsourceentryid

		update t2 set FAllStdAmount=cast(t2.fallAmount*t3.fexchangerate as decimal(28,2))  --单独更新  --价税合计！！！！！！！！！！！！！！！！！！
		from seorder t3
		inner join seorderentry t2 on t3.finterid=t2.finterid
		where t2.finterid=@fsourceinterid and t2.fentryid=@fsourceentryid

		EXEC p_UpdateBillRelateData 81,@fsourceinterid  --通过非Aux来更新Aux,非AUX为基本单位
	end

    FETCH NEXT FROM Seorder_Cursor
    INTO @fitemid,@fsourceinterid,@fsourceentryid,@ficmointerid,@FOLDBrandID,@FBrandID,@FOLDChipVerID,@FChipVerID,@FOLDPrice,@FPrice
END

CLOSE Seorder_Cursor
DEALLOCATE Seorder_Cursor

set nocount off

go


--计算信息--*****
IF not EXISTS (select * from sysobjects where name='my_t_Mrp' and xtype='u')  --drop  Table my_t_Mrp
begin
	create table my_t_Mrp(
	ftrantype int,
	frunid int,
	fstatus int,
	fbilltime datetime,FProspectDays int,
	fbillno varchar(20),
	fuserid int,
	fcheckerid int,
	fcheckdate datetime,
	fchecktime datetime,
	fdate datetime,
	fempid int,
	fdeptid int,ftype int default 40043,--40043 常规物料 40044 包材物料
	)
end

go

IF EXISTS (select * from sysobjects where name='my_t_Mrp' and xtype='u') and not EXISTS (select t1.id
from sysobjects t1 
inner join syscolumns t2 on t1.id=t2.id
where t1.name='my_t_Mrp' and t1.xtype='u' and t2.name='FProspectDays')
begin
	alter table my_t_Mrp add FProspectDays int default(0)
end

go


--毛需求--*****
IF not EXISTS (select * from sysobjects where name='My_t_MrpRoughNeedSource' and xtype='u')  --drop  Table My_t_MrpRoughNeedSource
begin
	create table My_t_MrpRoughNeedSource(frunid int,ftrantype int,fsourceinterid int,fsourceentryid int,fitemid int,
	fqty decimal(24,2),fpackinterid int,fneeddate datetime)  --
end

go

--预计入库--*****
IF not EXISTS (select * from sysobjects where name='My_t_MrpWillInStock' and xtype='u')  --drop  Table My_t_MrpWillInStock
begin
	create table My_t_MrpWillInStock(fdate datetime,frunid int,ftrantype int,finterid int ,fentryid int,fitemid int,fqty decimal(24,2)) --1 外购  3 委外
end

go

--库存--*****
IF not EXISTS (select * from sysobjects where name='My_t_MrpStock' and xtype='u')  --drop  Table My_t_MrpStock
begin
	create table My_t_MrpStock(frunid int,fstockid int,fitemid int,fqty decimal(24,2)) 
end

go

--MRP结果明细--*****
IF not EXISTS (select * from sysobjects where name='my_t_MrpResultDetail' and xtype='u')  --drop  Table my_t_MrpResultDetail
begin
	create table my_t_MrpResultDetail(fneeddate datetime,frunid int,fselect int,fitemid int,
	FRoughNeedQty decimal(24,4),FWillInStockQty decimal(24,4),
	FCanUseStockQty decimal(24,4),FStockQty decimal(24,4),FNeedQty decimal(24,4),fbatchappendqty decimal(24,4),
	fqtymin decimal(24,4),fsecinvqty decimal(24,4),FActNeedQty decimal(24,4),
	fsupplyid int default 0,fcurrencyid int default 0,fprice decimal(24,8) default 0.00,
	fempid int default 0,fqty decimal(24,4))
end

go

--MRP结果汇总--*****
IF not EXISTS (select * from sysobjects where name='my_t_MrpResultSum' and xtype='u')  --drop  Table my_t_MrpResultSum
begin
	create table my_t_MrpResultSum(frunid int,fselect int,fitemid int,FRoughNeedQty decimal(24,4),FWillInStockQty decimal(24,4),
	FCanUseStockQty decimal(24,4),FStockQty decimal(24,4),FNeedQty decimal(24,4),fbatchappendqty decimal(24,4),
	fqtymin decimal(24,4),fsecinvqty decimal(24,4),FActNeedQty decimal(24,4),fneeddate datetime,
	fsupplyid int default 0,fcurrencyid int default 0,fprice decimal(24,8) default 0.00,fempid int default 0,fqty decimal(24,4))
end

go


--*****
IF EXISTS (select * from sysobjects where name='my_v_MrpInfo' and xtype='v')  drop  view my_v_MrpInfo

go

create view my_v_MrpInfo 
as

select --fbillno 计算编号,--暂不使用,直接用内码作为计算编号
t1.frunid 计算编号,t1.fdate 计算日期,t1.fbilltime 计算时间,t2.fname 计算用户,isnull(t1.FProspectDays,0) 订单交期展望天数,
case when t1.ftrantype=0 then '成品' when t1.ftrantype=1 then '半成品' when t1.ftrantype=2 then '常规物料' when t1.ftrantype=3 then '包材' end 计算类型,
(case when isnull(t1.fstatus,0)=0 then '' else 'Y' end) 审核,isnull(t3.fname,'') 审核人,isnull(t1.fcheckdate,Null) 审核日期
from my_t_Mrp t1 
inner join t_user t2 on t1.fuserid=t2.fuserid
left join t_user t3 on t1.fcheckerid=t3.fuserid and t3.fuserid<>0

go

--*****

IF EXISTS (select * from sysobjects where name='my_v_MrpWillInStock ' and xtype='v')  drop  view my_v_MrpWillInStock

go

create view my_v_MrpWillInStock 
as

select t1.frunid 运算编号,'收料通知单' 单据类型,t1.fdate 日期,t2.fbillno 单据编号,t5.fnumber 厂商编号,t5.FShortName 厂商名称,  
t4.fnumber 物料编码,t4.fname 名称,t4.fmodel 规格型号,t6.fname 单位,t1.fqty 数量,isnull(t13.fname,'') 仓管员,isnull(t14.fname,'') 物料类别,isnull(t17.fname,'') 倒冲  
from My_t_MrpWillInStock t1  
inner join poinstock t2 on t1.ftrantype=72 and t1.finterid=t2.finterid  
inner join t_supplier t5 on t5.fitemid=t2.fsupplyid  
inner join t_icitem t4 on t4.fitemid=t1.fitemid  
inner join t_measureunit t6 on t4.funitid=t6.fitemid  
left join t_SubMessage t13 on t13.finterid=t4.F_114 and t13.ftypeid=10003  
left join t_SubMessage t14 on t14.finterid=t4.ftypeid and t14.ftypeid=504  
left join t_SubMessage t17 on t17.finterid=t4.F_115 and t17.ftypeid=10002  
union all 
select t1.frunid 运算编号,'采购订单' 单据类型,t1.fdate 日期,t2.fbillno 单据编号,t5.fnumber 厂商编号,t5.FShortName 厂商名称,  
t4.fnumber 物料编码,t4.fname 名称,t4.fmodel 规格型号,t6.fname 单位,t1.fqty 数量,isnull(t13.fname,'') 仓管员,isnull(t14.fname,'') 物料类别,isnull(t17.fname,'') 倒冲
from My_t_MrpWillInStock t1  
inner join poorder t2 on t1.ftrantype=71 and t1.finterid=t2.finterid  
inner join t_supplier t5 on t5.fitemid=t2.fsupplyid  
inner join t_icitem t4 on t4.fitemid=t1.fitemid  
inner join t_measureunit t6 on t4.funitid=t6.fitemid  
left join t_SubMessage t13 on t13.finterid=t4.F_114 and t13.ftypeid=10003  
left join t_SubMessage t14 on t14.finterid=t4.ftypeid and t14.ftypeid=504  
left join t_SubMessage t17 on t17.finterid=t4.F_115 and t17.ftypeid=10002 
union all 
select t1.frunid 运算编号,'采购申请单' 单据类型,t1.fdate 日期,t2.fbillno 单据编号,'' 厂商编号,'' 厂商名称,  
t4.fnumber 物料编码,t4.fname 名称,t4.fmodel 规格型号,t6.fname 单位,t1.fqty 数量,isnull(t13.fname,'') 仓管员,isnull(t14.fname,'') 物料类别,isnull(t17.fname,'') 倒冲
from My_t_MrpWillInStock t1  
inner join porequest t2 on t1.ftrantype=70 and t1.finterid=t2.finterid  
inner join t_icitem t4 on t4.fitemid=t1.fitemid  
inner join t_measureunit t6 on t4.funitid=t6.fitemid  
left join t_SubMessage t13 on t13.finterid=t4.F_114 and t13.ftypeid=10003  
left join t_SubMessage t14 on t14.finterid=t4.ftypeid and t14.ftypeid=504  
left join t_SubMessage t17 on t17.finterid=t4.F_115 and t17.ftypeid=10002   
union all 
select t1.frunid 运算编号,'生产任务单' 单据类型,t1.fdate 日期,t2.fbillno 单据编号,t5.fnumber 厂商编号,t5.FName 厂商名称,  
t4.fnumber 物料编码,t4.fname 名称,t4.fmodel 规格型号,t6.fname 单位,t1.fqty 数量,isnull(t13.fname,'') 仓管员,isnull(t14.fname,'') 物料类别,isnull(t17.fname,'') 倒冲
from My_t_MrpWillInStock t1  
inner join icmo t2 on t1.ftrantype=85 and t1.finterid=t2.finterid  
inner join t_icitem t4 on t4.fitemid=t1.fitemid  
inner join t_department t5 on t5.fitemid=t2.fworkshop  
inner join t_measureunit t6 on t4.funitid=t6.fitemid  
left join t_SubMessage t13 on t13.finterid=t4.F_114 and t13.ftypeid=10003  
left join t_SubMessage t14 on t14.finterid=t4.ftypeid and t14.ftypeid=504  
left join t_SubMessage t17 on t17.finterid=t4.F_115 and t17.ftypeid=10002 
union all 
select t1.frunid 运算编号,'外购入库单' 单据类型,t1.fdate 日期,t2.fbillno 单据编号,t5.fnumber 厂商编号,t5.FShortName 厂商名称,  
t4.fnumber 物料编码,t4.fname 名称,t4.fmodel 规格型号,t6.fname 单位,t1.fqty 数量,isnull(t13.fname,'') 仓管员,isnull(t14.fname,'') 物料类别,isnull(t17.fname,'') 倒冲
from My_t_MrpWillInStock t1  
inner join icstockbill t2 on t1.ftrantype=1 and t1.finterid=t2.finterid  
inner join t_icitem t4 on t4.fitemid=t1.fitemid  
inner join t_supplier t5 on t5.fitemid=t2.fsupplyid  
inner join t_measureunit t6 on t4.funitid=t6.fitemid  
left join t_SubMessage t13 on t13.finterid=t4.F_114 and t13.ftypeid=10003  
left join t_SubMessage t14 on t14.finterid=t4.ftypeid and t14.ftypeid=504  
left join t_SubMessage t17 on t17.finterid=t4.F_115 and t17.ftypeid=10002   
union all 
select t1.frunid 运算编号,'塑胶子件收料申请单' 单据类型,t1.fdate 日期,t2.fbillno 单据编号,t5.fnumber 厂商编号,t5.FShortName 厂商名称,  
t4.fnumber 物料编码,t4.fname 名称,t4.fmodel 规格型号,t6.fname 单位,t1.fqty 数量,isnull(t13.fname,'') 仓管员,isnull(t14.fname,'') 物料类别,isnull(t17.fname,'') 倒冲
from My_t_MrpWillInStock t1  
inner join t_BosPlasticPoInStock t2 on t1.ftrantype=200000022 and t1.finterid=t2.fid  
inner join t_icitem t4 on t4.fitemid=t1.fitemid  
inner join t_supplier t5 on t5.fitemid=t2.fsupplyid  
inner join t_measureunit t6 on t4.funitid=t6.fitemid  
left join t_SubMessage t13 on t13.finterid=t4.F_114 and t13.ftypeid=10003  
left join t_SubMessage t14 on t14.finterid=t4.ftypeid and t14.ftypeid=504  
left join t_SubMessage t17 on t17.finterid=t4.F_115 and t17.ftypeid=10002 

go


--*****
IF EXISTS (select * from sysobjects where name='my_v_MrpResultDetail' and xtype='v')  drop  view my_v_MrpResultDetail

go

create view my_v_MrpResultDetail

as

select t1.frunid 计算编号,t2.fneeddate 需求日期,t3.fitemid 物料内码,t3.fnumber 物料编码,t3.fname 名称,isnull(t3.fmodel,'') 规格型号,t4.fname 单位,
t2.FRoughNeedQty 毛需求数,t2.FWillInStockQty 预计入库数,--t2.FStockQty 库存数,
t2.FCanUseStockQty 可用库存数,t2.FNeedQty 净需求,(case when t2.FNeedQty>0 and t9.fitemid is null then 1 else 0 end) 标识内码 --,
--t2.fbatchappendqty 批量增量,t2.fqtymin 最小订货量,t2.fsecinvqty 安全库存,
--t2.FActNeedQty 计划定货量 ,t2.fqty 数量,isnull(t8.fname,'') 物料属性,t13.fname 仓管员,t14.fname 物料类别,t17.fname 倒冲
--isnull(t6.fname,'') 担当,isnull(t5.fshortnumber,'') 厂商代码,isnull(t5.fshortname,'') 厂商名称,isnull(t7.fname,'') 币别,isnull(t2.fprice,0) 单价
from my_t_Mrp t1
inner join my_t_MrpResultDetail t2 on t1.frunid=t2.frunid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_measureunit t4 on t3.funitid=t4.fitemid
left join t_Supplier t5 on t5.fitemid=t2.fsupplyid
left join t_emp t6 on t6.fitemid=t5.femployee
left join t_currency t7 on t7.fcurrencyid=t2.fcurrencyid
left join t_submessage t8 on t8.finterid=t3.ferpclsid
left join t_SubMessage t13 on t13.finterid=t3.f_114 and t13.ftypeid=10003
left join t_SubMessage t14 on t14.finterid=t3.ftypeid and t14.ftypeid=504
left join t_SubMessage t17 on t17.finterid=t3.f_115 and t17.ftypeid=10002
left join my_t_MrpResultSum t9 on t9.frunid=t2.frunid and t9.fitemid=t2.fitemid

GO


--*****
IF EXISTS (select * from sysobjects where name='my_v_MrpResultSum' and xtype='v')  drop  view my_v_MrpResultSum

go

create view my_v_MrpResultSum

as

select t1.frunid 计算编号,t2.fneeddate 需求日期,t3.fitemid 物料内码,t3.fnumber 物料编码,t3.fname 名称,
isnull(t3.fmodel,'') 规格型号,t4.fname 单位,
t2.FRoughNeedQty 毛需求数,t2.FWillInStockQty 预计入库数,t2.FStockQty 库存数,t2.FNeedQty 净需求,
t2.fbatchappendqty 批量增量,t2.fqtymin 最小订货量,t2.fsecinvqty 安全库存,
t2.FActNeedQty 计划定货量 ,t2.fqty 数量,isnull(t9.fmonaverageqty,0) 月耗数,isnull(t8.fname,'') 物料属性,
t13.fname 仓管员,t14.fname 物料类别,t17.fname 倒冲
--isnull(t6.fname,'') 担当,isnull(t5.fshortnumber,'') 厂商代码,isnull(t5.fshortname,'') 厂商名称,isnull(t7.fname,'') 币别,isnull(t2.fprice,0) 单价
from my_t_Mrp t1
inner join my_t_MrpResultSum t2 on t1.frunid=t2.frunid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_measureunit t4 on t3.funitid=t4.fitemid
left join t_Supplier t5 on t5.fitemid=t2.fsupplyid
left join t_emp t6 on t6.fitemid=t5.femployee
left join t_currency t7 on t7.fcurrencyid=t2.fcurrencyid
left join t_submessage t8 on t8.finterid=t3.ferpclsid
left join t_SubMessage t13 on t13.finterid=t3.f_114 and t13.ftypeid=10003
left join t_SubMessage t14 on t14.finterid=t3.ftypeid and t14.ftypeid=504
left join t_SubMessage t17 on t17.finterid=t3.f_115 and t17.ftypeid=10002
left join 
(
	select t2.fitemid,cast(sum(t2.fqty)/(case when datediff(day,min(t2.fdate),max(t2.fdate))<=30 then 1
										      when datediff(day,min(t2.fdate),max(t2.fdate))>=31 and datediff(day,min(t2.fdate),max(t2.fdate))<=60 then 2 
										      when datediff(day,min(t2.fdate),max(t2.fdate))>=61 then 3 end
										 ) as decimal(24,2)) fmonaverageqty
	from
	(
		select t2.fitemid,t2.fqty,t1.fdate
		from icstockbill t1 
		inner join icstockbillentry t2 on t1.finterid=t2.finterid
		where t1.fdate>=dateadd(day,-90,getdate()) and t1.fdate<=getdate() and t1.ftrantype=24 and t1.frob=1
		union all
		select t2.fitemid,t2.fqty,t1.fdate
		from zpstockbill t1 
		inner join zpstockbillentry t2 on t1.finterid=t2.finterid
		where t1.fdate>=dateadd(day,-90,getdate()) and t1.fdate<=getdate() and t1.ftrantype=26 and t1.frob=1
	) t2 group by t2.fitemid
) t9 on t9.fitemid=t2.fitemid

GO

--参与运算的订单--暂未使用
IF not EXISTS (select * from sysobjects where name='my_t_MrpSeOrder' and xtype='u')  --drop  Table my_t_MrpSeOrder
begin
	create table my_t_MrpSeOrder(frunid int,fselect bit default 0,
	forderinterid int,forderentryid int,fitemid int,fremark varchar(500),ftype int default 40043 --40044 常规物料 40044 包材
)
end

go

/*

Delete from My_t_MrpRoughNeedSource where frunid in (2170,2171,2172)  --select * from My_t_MrpRoughNeedSource
Delete from My_t_MrpWillInStock where frunid in (2170,2171,2172)  --select * from My_t_MrpWillInStock
Delete from my_t_MrpResultDetail where frunid in (2170,2171,2172)  --select * from my_t_MrpResultDetail
Delete from my_t_MrpResultSum where frunid in (2170,2171,2172)  --select * from my_t_MrpResultSum
Delete from my_t_MrpStock where frunid in (2170,2171,2172)  --select * from my_t_MrpStock
Delete from my_t_Mrp where frunid in (2170,2171,2172)  --select * from my_t_Mrp

*/



--任务单需求计划跟踪--横排--跟踪半成品下面的物料
--My_P_MaterielNeedPlanByICMO 16394,0,0,'2015-04-30'
IF EXISTS (select * from sysobjects where name='My_P_MaterielNeedPlanByICMO' and xtype='p')  drop  procedure My_P_MaterielNeedPlanByICMO
go

create procedure [dbo].My_P_MaterielNeedPlanByICMO(@fuserid int,@fitemtype int,@ftype int,@fenddate datetime) --@fitemtype  1 半成品  2 常规物料(目前只考虑芯片) 3 包材 0 全部  --@ftype 0 全部 1 选中任务单

as

set nocount on

--declare @fuserid int,@fitemtype int,@ftype int,@fenddate datetime select @fuserid=16394,@fitemtype=0,@ftype=0 ,@fenddate='2015-04-30'

declare @fdeptid int,@fitemid int,@fpqty decimal(24,2),@forderinterid int,@s varchar(8000),@forderbillno varchar(50)
declare @fqty decimal(24,4),@fplanqty decimal(24,4),@fstockqty decimal(24,4),@FWillInStockQty decimal(24,4),@FRoughNeedQty decimal(24,4)
declare @FCanUseStockQty decimal(24,4),@FNeedQty decimal(24,4),@fsourceinterid int,@fplandate datetime,@fentryid int
declare @fbegdate datetime,@fneeddate datetime,@finvdate datetime,@fcaldate datetime,@FOrderBillLike varchar(120),@fsourceentryid int
declare @fsendenddate datetime,@iRunID int, @iYear int,@iPeriod int,@fpackoutstockinterid int,@i int,@fnumbermatch varchar(20)
declare @ficmointerid int,@fplancommitdate datetime,@FPrepareDays int,@sqls varchar(8000),@iCount int,@frunid int
declare @varStrDate varchar(30),@sqls1 varchar(8000),@j int,@iCount2 int
declare @FProductProspectDays int,@FHalfProductProspectDays int,@FProductPrepareDays int,@FHalfProductPrepareDays int

select @FProductProspectDays=fvalue from t_SystemProfile where FCategory='IC' and fkey='FProductProspectDays' 
select @FHalfProductProspectDays=fvalue from t_SystemProfile where FCategory='IC' and fkey='FHalfProductProspectDays' 
select @FProductPrepareDays=fvalue from t_SystemProfile where FCategory='IC' and fkey='FProductPrepareDays' 
select @FHalfProductPrepareDays=fvalue from t_SystemProfile where FCategory='IC' and fkey='FHalfProductPrepareDays' 

select @s='',@i=1

declare @fdate datetime

select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期

create table #My_t_MrpRoughNeedSource(frunid int,ftrantype int,fsourceinterid int,fsourceentryid int,
fitemid int,fqty decimal(24,2),fpackinterid int,fneeddate datetime) 

create table #data(fnumber varchar(50),fplancommitdate datetime,fqty decimal(24,4),fsourceinterid int,
fsourceentryid int,fitemid int,fauxqtyscrap decimal(24,4),fqtymust decimal(24,4),fstockqty decimal(24,4),fscrap decimal(24,4),FPrepareDays int)

create table #temp(fitemid int)

create table #My_t_MrpWillInStock(fdate datetime,frunid int,ftrantype int,finterid int ,fentryid int,fitemid int,fqty decimal(24,0)) --1 外购  3 委外
create table #My_t_TempInventory(fdate datetime,frunid int,ftrantype int,finterid int ,fentryid int,fitemid int,fqty decimal(24,0)) --1 外购  3 委外

create table #My_t_MrpStock(frunid int,fstockid int,fitemid int,fqty decimal(24,0)) 

--投料单未发数--按生产计划分摊到日需求中--生产任务单中 成品是30天 半成品是15天

--注意：fqty 是父项的计划数
insert into #data(fqtymust,fstockqty,fnumber,fplancommitdate,fqty,fsourceinterid,fsourceentryid,fitemid,fauxqtyscrap,fscrap,FPrepareDays)
select t3.fqtymust,t3.fstockqty,t4.fnumber,--(case when t6.FHeadSelfS0154<@fdate then @fdate else t6.FHeadSelfS0154 end) fplancommitdate,--如果计划开工日期小于当天,则该任务单的需求日期则为当天
t11.fdate fplancommitdate,t11.fqty,
t5.finterid fsourceinterid,0 fsourceentryid,t3.fitemid,t3.fauxqtyscrap,t3.fscrap,
(case when isnull(t5.forderinterid,0)<>0 then @FProductPrepareDays else @FHalfProductPrepareDays end) FPrepareDays  --成品直接下级则取成品的准备期，否则则取半成品的准备期
from icmo t5 
inner join ppbom t2 on t5.finterid=t2.ficmointerid
inner join ppbomentry t3 on t2.finterid=t3.finterid
inner join t_icitem t4 on t3.fitemid=t4.fitemid --子项
inner join t_icitem t8 on t5.fitemid=t8.fitemid --父项
inner join my_t_scheduledetail t11 on t11.ficmointerid=t5.finterid
where t5.fstatus in (1,2,5) and (t3.fqtymust-t3.fstockqty)>0 
and t11.fdate>=@fdate --先只考虑当天以后的需求--出货日期在当天之前的，则认为已经出完货
and isnull(t5.forderinterid,0)=0
and t11.fdate<=@fenddate -- --只考虑在需求日期范围内的订单
and t4.fnumber not like '1.02.%' 
--and t4.fnumber not like '6.%'
--and t4.fnumber not like 'A.%' and t4.fnumber not like 'P.%'


----先只考虑包装的需求
--delete t1 from #data t1 
--inner join icmo t2 on t1.fsourceinterid=t2.finterid 
--where isnull(t2.forderinterid,0)=0
--
----先只考虑当天以后的需求--出货日期在当天之前的，则认为已经出完货
--delete t1 
--from #data t1 
--inner join icmo t2 on t1.fsourceinterid=t2.finterid 
--inner join seorderentry t3 on t3.finterid=t2.forderinterid and t3.fentryid=t2.fsourceentryid
--where t3.fdate<@fdate

if @ftype=1  --只考虑选中的任务单涉及到的物料
begin
	delete t5
	from #data t5 
	where t5.fitemid not in (
		select t5.fitemid
		from #data t5 
		inner join my_t_icmotemp t1 on t1.finterid=t5.fsourceinterid and t1.fuserid=@fuserid)
end

--@fitemtype  1 半成品  2 常规物料 3 包材
if @fitemtype=1
	delete from #data where left(fnumber,1) not in (select fitemtype from v_MyItemType where ftype=1) --fnumber not like '3.%' and fnumber not like '4.%'  --3.  4. 前缀物料编码为半成品
else if @fitemtype=3
	delete from #data where fnumber not like '2.%'   --2. 前缀物料编码为包材
else if @fitemtype=2
	delete from #data where left(fnumber,1) in (select fitemtype from v_MyItemType where ftype in(1,3)) --fnumber like '3.%' or fnumber like '4.%' or fnumber like '2.%' 

--delete from #data where fnumber like '2.01%' --纸箱

--未发数汇总
select sum(t3.fqtymust-t3.fstockqty) fqty,t5.finterid fsourceinterid,t4.fitemid 
into #NoOutStock
from icmo t5 
inner join ppbom t2 on t5.finterid=t2.ficmointerid
inner join ppbomentry t3 on t2.finterid=t3.finterid
inner join t_icitem t4 on t3.fitemid=t4.fitemid --子项
where t5.finterid in (select fsourceinterid from #data)
and t4.fitemid in (select fitemid from #data) 
group by t5.finterid,t4.fitemid


--未发数汇总--有领过的或者有改过应发数的
create table #Source(fqty decimal(24,4),fsourceinterid int,fitemid int)

insert into #Source(fqty,fsourceinterid,fitemid)
select sum(t1.fqty) fqty,t1.fsourceinterid,t1.fitemid
from
(
	select (t3.fqtymust-t3.fstockqty) fqty,t5.finterid fsourceinterid,t4.fitemid --有领过的
	from icmo t5 
	inner join ppbom t2 on t5.finterid=t2.ficmointerid
	inner join ppbomentry t3 on t2.finterid=t3.finterid
	inner join t_icitem t4 on t3.fitemid=t4.fitemid --子项
	where t5.finterid in (select fsourceinterid from #data)
	and t4.fitemid in (select fitemid from #data) and t3.fstockqty>0
	union all
	select t1.fqtymust,t1.ficmointerid,t1.fitemid --有改过应发数的
	from ppbomentry t1
	inner join
	(
		select t2.fsourceinterid,t2.fitemid,sum(t2.fqty*t2.fauxqtyscrap*(1+t2.fscrap/100)) fqty
		from #data t2  
		where t2.fstockqty=0
		group by t2.fsourceinterid,t2.fitemid
	) t2 on t1.ficmointerid=t2.fsourceinterid and t1.fitemid=t2.fitemid
	where t1.fqtymust<t2.fqty and t1.fstockqty=0
) t1 group by t1.fsourceinterid,t1.fitemid

--库存
insert into #My_t_MrpStock(frunid, fitemid,   fstockid,   fqty)
select                     @frunid,t1.fitemid,t1.fstockid,t1.fqty
from icinventory t1
inner join t_ICItem t2 on t1.FItemID=t2.FItemID
inner join t_stock t3 on t3.fitemid=t1.fstockid
where --t2.ferpclsid in (1) and 
t1.fqty>0 --and t3.fname not like '%计划%' 
and t3.fname not like '%不良%' and t3.fname not like '%报废%'
--and t3.fnumber not like '11.%' 
--and (t2.fnumber like 'H.%' or t2.fnumber like 'K.%' or t2.fnumber like 'M.%' or t2.fnumber like 'N.%')
and t2.fitemid in (select fitemid from #data)

insert into #My_t_MrpStock(frunid, fitemid,   fstockid,   fqty)
select @frunid,t1.fitemid,t1.fstockid,t1.fqty
from poinventory t1
inner join t_ICItem t2 on t1.FItemID=t2.FItemID
inner join t_stock t3 on t3.fitemid=t1.fstockid
where --t2.ferpclsid in (1) and 
t1.fqty>0 --and t3.fname not like '%计划%' 
and t3.fname not like '%不良%' and t3.fname not like '%报废%' and t3.fitemid=16483  --代管仓
--and t3.fnumber not like '11.%' 
--and (t2.fnumber like 'H.%' or t2.fnumber like 'K.%' or t2.fnumber like 'M.%' or t2.fnumber like 'N.%')
and t2.fitemid in (select fitemid from #data)

--库存够发的就不再显示
delete from #data where fitemid in 
(
	select t5.fitemid
	from (select fitemid,sum(fqty) fqty from #NoOutStock group by fitemid) t5 
	left join (select fitemid,sum(isnull(fqty,0)) fqty from #My_t_MrpStock group by fitemid) t4 on t4.fitemid=t5.fitemid
	where isnull(t4.fqty,0)>isnull(t5.fqty,0)  
)

delete from #NoOutStock where fitemid not in (select fitemid from #data)

--还没有领过的或者.....就直接作为毛需求
insert into #My_t_MrpRoughNeedSource(fneeddate,         ftrantype,frunid, fsourceinterid,    fsourceentryid,  fitemid,    fqty)
select                               t2.fplancommitdate,85,       @frunid,t2.fsourceinterid, 0,               t2.fitemid, t2.fqty*t2.fauxqtyscrap*(1+t2.fscrap/100) fqty
from #data t2  
where not exists (select 1 from #Source where fsourceinterid=t2.fsourceinterid and fitemid=t2.fitemid)
order by t2.fplancommitdate desc


declare @fminid int,@fmaxid int,@fentryminid int,@fentrymaxid int,@fpreitemid int
create table #Cursor(FID int identity(1,1),fsourceinterid int,fitemid int,FQty decimal(24,2),forderbillno varchar(15),fplandate datetime)
create table #CursorEntry(FID int identity(1,1),fplandate datetime,FPlanQty decimal(24,2))

-- DECLARE Seorder_Cursor CURSOR FOR
truncate table #Cursor
insert into #Cursor(FQty,fitemid,fsourceinterid)
select sum(isnull(fqty,0)) fqty,fitemid,fsourceinterid 
from #Source 
group by fitemid,fsourceinterid

-- OPEN Seorder_Cursor
-- 
-- FETCH NEXT FROM Seorder_Cursor 
-- INTO @fqty,@fitemid,@fsourceinterid
-- 
-- WHILE @@FETCH_STATUS = 0
-- BEGIN
select @fminid=0,@fmaxid=0
select @fminid=isnull(min(fid),0),@fmaxid=isnull(max(fid),0) from #Cursor

WHILE @fmaxid>0 and @fminid<=@fmaxid --@@FETCH_STATUS = 0  --先把可用库存按物料先分配下去
BEGIN 
	select @fsourceinterid=fsourceinterid,@fitemid=fitemid,@FQty=FQty from #Cursor where fid=@fminid

	truncate table #CursorEntry
	insert into #CursorEntry(fplandate,fplanqty)
-- 	DECLARE SeorderEntry_Cursor CURSOR FOR
	select t2.fplancommitdate,--Dateadd(day,-t2.FPrepareDays,t6.fdate) fplandate,--先不考虑提前期
	t2.fqty*t2.fauxqtyscrap*(1+t2.fscrap/100) fqty
	from #data t2  
	--inner join my_t_scheduledetail t6 on t6.ficmointerid=t2.fsourceinterid  
	where t2.fsourceinterid=@fsourceinterid and t2.fitemid=@fitemid --and t2.fstockqty>0 --and t6.fdate<=@fenddate and t6.fdate>=@fdate  --今天开始计起
	order by t2.fplancommitdate desc

-- 	OPEN SeorderEntry_Cursor
-- 
-- 	FETCH NEXT FROM SeorderEntry_Cursor 
-- 	INTO @fplandate,@fplanqty

	select @fentryminid=0,@fentrymaxid=0
	select @fentryminid=isnull(min(fid),0),@fentrymaxid=isnull(max(fid),0) from #CursorEntry

	WHILE @fentrymaxid>0 and @fentryminid<=@fentrymaxid --@@FETCH_STATUS = 0
	BEGIN 
		select @fplanqty=fplanqty,@fplandate=fplandate from #CursorEntry where fid=@fentryminid

-- 	WHILE @@FETCH_STATUS = 0 and @fqty>0  --
-- 	BEGIN
		if @fplanqty>=@fqty  --当天该物料的需求数大于未发数(余数)
		begin
			set @fplanqty=@fqty
			set @fqty=0
		end
		else
		begin
			set @fqty=@fqty-@fplanqty
		end	
		
		insert into #My_t_MrpRoughNeedSource(fneeddate, ftrantype,frunid, fsourceinterid,  fsourceentryid,  fitemid,  fqty)
		select                               @fplandate,85,       @frunid,@fsourceinterid, 0,               @fitemid, @fplanqty
	
		set @fentryminid=@fentryminid+1

-- 		FETCH NEXT FROM SeorderEntry_Cursor 
-- 		INTO @fplandate,@fplanqty
	end


-- 	CLOSE SeorderEntry_Cursor
-- 	DEALLOCATE SeorderEntry_Cursor
-- 
--    FETCH NEXT FROM Seorder_Cursor
--    INTO @fqty,@fitemid,@fsourceinterid
-- END
-- 
-- CLOSE Seorder_Cursor
-- DEALLOCATE Seorder_Cursor 


	set @fminid=@fminid+1
END

-- insert into #My_t_MrpRoughNeedSource(fneeddate,         ftrantype,frunid, fsourceinterid,    fsourceentryid,  fitemid,    fqty)
-- select                               t1.fplancommitdate,85,       @frunid,t1.fsourceinterid, 0,               t1.fitemid, t1.fqty
-- from #data t1

-- truncate table #data
-- 
-- insert into #data(fplancommitdate,fqty,   fsourceinterid,   fsourceentryid,fitemid,   fauxqtyscrap,fscrap,FPrepareDays)
-- select            t1.fneeddate,   t1.fqty,t1.fsourceinterid,0,             t1.fitemid,0,           0,     0    
-- from #My_t_MrpRoughNeedSource t1


--drop table #data  --select * from #data order by fnumber  
--select t2.fnumber,t1.* from My_t_MrpRoughNeedSource t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid where frunid=1001 order by t2.fnumber

----关联任务单未审核的生产领料单
--insert into My_t_MrpRoughNeedSource(fneeddate,ficmointerid,ftrantype,frunid, forderinterid,forderentryid,fitemid,   fchilditemid,   forderqty,finqty, fqty,fchildmustqty,fchildoutqty, fchildqty)
--select						        t2.fdate, t5.finterid, 0,        @frunid,0,            0,            t8.fitemid,t4.fitemid,     0,        0,      0,   t3.fqty,      0,            t3.fqty
--from icmo t5 
--inner join icstockbillentry t3 on t5.finterid=t3.ficmointerid
--inner join icstockbill t2 on t2.finterid=t3.finterid
--inner join t_icitem t4 on t3.fitemid=t4.fitemid
--inner join t_icitem t8 on t5.fitemid=t8.fitemid
--inner join t_SubMessage t13 on t13.finterid=t4.f_114 and t13.ftypeid=10004  --仓管员
--inner join t_SubMessage t17 on t17.finterid=t4.f_115 and t17.ftypeid=10003  --倒冲
--where t2.ftrantype=24 and t2.fstatus in (0) 

-- --毛需求--随单出货外购件
-- insert into #My_t_MrpRoughNeedSource(fneeddate, ftrantype,frunid, fsourceinterid,fsourceentryid,fitemid,   fqty   )
-- select	                            (case when t5.FHeadSelfS0154<@fdate then @fdate else t5.FHeadSelfS0154 end) fneeddate,/*Dateadd(day,-@FProductPrepareDays,t4.fdate)--先不考虑提前期*/ 
-- 										        81,       @frunid,t4.finterid,   t4.fentryid,   t4.fitemid,t4.fqty-isnull(t4.fstockqty,0)
-- from seorderentry t4 
-- inner join seorder t5  on t5.finterid=t4.finterid
-- inner join t_icitem t8 on t8.fitemid=t4.fitemid
-- inner join t_Organization t6 on t5.FCustID=t6.fitemid
-- inner join t_department t11 on t11.fitemid=t5.fdeptid
-- where t8.ferpclsid=1 and t4.fmrpclosed<>1 and (t5.fstatus>0 or isnull(t5.FMultiCheckLevel1,0)>0) --and t5.fdate>='2011-07-01'
-- --and datediff(day,getdate(),t4.fdate)=@FProductProspectDays  --成品30天
-- and t4.fqty>t4.fstockqty and t5.FHeadSelfS0148>=@fdate --只考虑交期为当天以后的--当天之前的视为已出货

--@fitemtype  1 半成品  2 常规物料 3 包材
if @fitemtype=1
	delete t1 from #My_t_MrpRoughNeedSource t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid 
	where left(t2.fnumber,1) not in (select fitemtype from v_MyItemType where ftype=1) --t2.fnumber not like '3.%' and t2.fnumber not like '4.%'  --3.  4. 前缀物料编码为半成品
else if @fitemtype=3
	delete t1 from #My_t_MrpRoughNeedSource t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid where t2.fnumber not like '2.%'   --2. 前缀物料编码为包材
else if @fitemtype=2
	delete t1 from #My_t_MrpRoughNeedSource t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid 
	where left(t2.fnumber,1) in (select fitemtype from v_MyItemType where ftype in(1,3)) --like '3.%' or t2.fnumber like '4.%' or t2.fnumber like '2.%' 

--预计入库--
/*
select                          @frunid,71,       t2.finterid,t2.fentryid,t2.fitemid,t2.fqty,  t2.fcommitqty,t2.fqty-t2.fcommitqty
from poorder t1
inner join poorderentry t2 on  t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where --t1.FClosed<>1 
t2.fmrpclosed<>1 
--and t4.fnumber not like '08.11.%' --and t1.fstatus>0 
and t1.fstatus<>3  --采购订单收料完毕就关闭，但不一定已经入库
and t3.ferpclsid in (1) 
--and (t3.fnumber like 'H.%' or t3.fnumber like 'K.%' or t3.fnumber like 'M.%' or t3.fnumber like 'N.%')
and (t2.fqty-t2.fcommitqty)>0
and t2.fitemid in (select fchilditemid from My_t_MrpRoughNeedSource where frunid=@frunid)
*/

--create table #plantemp(fplancommitdate datetime,fqty decimal(24,2),fsourceinterid int,fsourceentryid int,fitemid int) 

----预计入库--要把未收料的数量循环分摊到收料计划中--生产任务单一定有生产计划，而采购订单可能还没有收料计划
--insert into #plantemp(fplancommitdate,fqty,                  fsourceinterid,fsourceentryid,fitemid)
--select                case when t2.fdate<@fdate then @fdate when datediff(day,getdate(),t2.fdate)>30 then DATEADD(day,30,getdate()) else t2.fdate end,--如果填的交货日期小于当天，则表明采购员所填交货日期是有变动的，按当天处理       
--									 (t2.fqty-t2.fcommitqty),t2.finterid,   t2.fentryid,   t2.fitemid
--from poorderentry t2  
--inner join poorder t1 on t1.finterid=t2.finterid
--inner join t_icitem t3 on t2.fitemid=t3.fitemid
--inner join t_department t4 on t1.fdeptid=t4.fitemid
--where --t1.FClosed<>1 
--t2.fmrpclosed<>1 
----and t4.fnumber not like '08.11.%' --and t1.fstatus>0 
--and t1.fstatus<>3  --采购订单收料完毕就关闭，但不一定已经入库
--and t3.ferpclsid in (1) 
----and (t3.fnumber like 'H.%' or t3.fnumber like 'K.%' or t3.fnumber like 'M.%' or t3.fnumber like 'N.%')
--and (t2.fqty-t2.fcommitqty)>0
--and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource)
--
--DECLARE Seorder_Cursor CURSOR FOR
--select fqty,fitemid,fsourceinterid,fsourceentryid,fplancommitdate 
--from #plantemp 
--
--OPEN Seorder_Cursor
--
--FETCH NEXT FROM Seorder_Cursor 
--INTO @fqty,@fitemid,@fsourceinterid,@fsourceentryid,@fplancommitdate
--
--WHILE @@FETCH_STATUS = 0
--BEGIN
--	set @fplandate=null
--
--	DECLARE SeorderEntry_Cursor CURSOR FOR
--	select t2.fdate,t2.fqty
--	from my_t_scheduledetail t2  
--	where t2.fsourceinterid=@fsourceinterid and t2.fsourceentryid=@fsourceentryid 
--	and t2.fitemid=@fitemid and t2.fdate>=@fdate  --今天开始计起 
--	order by t2.fdate
--
--	OPEN SeorderEntry_Cursor
--
--	FETCH NEXT FROM SeorderEntry_Cursor 
--	INTO @fplandate,@fplanqty
--
--	WHILE @@FETCH_STATUS = 0 and @fqty>0  --
--	BEGIN
--		if @fplanqty>=@fqty
--		begin
--			set @fplanqty=@fqty
--			set @fqty=0
--		end
--		else
--		begin
--			set @fqty=@fqty-@fplanqty
--		end	
--		
--		insert into #My_t_MrpWillInStock(fdate,     frunid, ftrantype,finterid,       fentryid,       fitemid,   fqty)
--		select                           @fplandate,@frunid,71,       @fsourceinterid,@fsourceentryid,@fitemid,  @fplanqty
--	
--		FETCH NEXT FROM SeorderEntry_Cursor 
--		INTO @fplandate,@fplanqty
--	end
--
--	if @fqty>0 --如果还有剩余数则放在最后一天的计划--如果当天以前收多了，则没有剩余数，表示最后一天不用收那么多；如果当天以前收少了，则有剩余数；
--	begin
--		insert into #My_t_MrpWillInStock(frunid, ftrantype,finterid,       fentryid,       fitemid,   fqty ,fdate     )
--		select                           @frunid,71,       @fsourceinterid,@fsourceentryid,@fitemid,  @fqty,isnull(@fplandate,@fplancommitdate)/*如果没有当天或当天以后没有收料计划，则取订单收料日期*/
--	end
--
--	CLOSE SeorderEntry_Cursor
--	DEALLOCATE SeorderEntry_Cursor
--
--    FETCH NEXT FROM Seorder_Cursor
--    INTO @fqty,@fitemid,@fsourceinterid,@fsourceentryid,@fplancommitdate
--END
--
--CLOSE Seorder_Cursor
--DEALLOCATE Seorder_Cursor

--预计入库--采购订单--未关闭--未关联
insert into #My_t_MrpWillInStock(fdate,frunid, ftrantype,finterid,   fentryid,   fitemid,   fqty)
select                           case when t2.fdate<@fdate then @fdate when datediff(day,getdate(),t2.fdate)>30 then DATEADD(day,30,getdate()) else t2.fdate end,--如果填的交货日期小于当天，则表明采购员所填交货日期是有变动的，按当天处理       
									   @frunid,71,       t2.finterid,t2.fentryid,t2.fitemid,(t2.fqty-t2.fcommitqty)
from poorderentry t2  
inner join poorder t1 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where --t1.FClosed<>1 
t2.fmrpclosed<>1 
--and t4.fnumber not like '08.11.%' --and t1.fstatus>0 
and t1.fstatus<>3  --采购订单收料完毕就关闭，但不一定已经入库
and t3.ferpclsid in (1) 
--and (t3.fnumber like 'H.%' or t3.fnumber like 'K.%' or t3.fnumber like 'M.%' or t3.fnumber like 'N.%')
and (t2.fqty-t2.fcommitqty)>0
and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource)

--预计入库--(采购申请单--已审核未关闭--未关联数)
insert into #My_t_MrpWillInStock(fdate,frunid, ftrantype,finterid,   fentryid,   fitemid,   fqty)
select                           case when t2.FFetchTime<@fdate then @fdate when datediff(day,getdate(),t2.FFetchTime)>30 then DATEADD(day,30,getdate()) else t2.FFetchTime end,--如果填的交货日期小于当天，则表明采购员所填交货日期是有变动的，按当天处理       
									   @frunid,70,       t2.finterid,t2.fentryid,t2.fitemid,t2.fqty-t2.fcommitqty
from porequest t1
inner join porequestentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where --t1.fstatus>0 and 
t1.fstatus<>3 --and t2.FFetchTime>=@fdate  --今天开始计起
--and t4.fnumber not like '08.11.%'
and t3.ferpclsid in (1)
--and (t3.fnumber like 'H.%' or t3.fnumber like 'K.%' or t3.fnumber like 'M.%' or t3.fnumber like 'N.%')
and (t2.fqty-t2.fcommitqty)>0  and t2.FMRPClosed<>1
and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource)

--预计入库(收料通知单--未审核)--
insert into #My_t_MrpWillInStock(fdate,   frunid,  ftrantype,  finterid,   fentryid,   fitemid,   fqty)
select                           case when t1.fdate<@fdate then @fdate when datediff(day,getdate(),t1.fdate)>30 then DATEADD(day,30,getdate()) else t1.fdate end,--如果填的交货日期小于当天，则表明采购员所填交货日期是有变动的，按当天处理       
								          @frunid, 72,         t2.finterid,t2.fentryid,t2.fitemid,t2.fqty
from poinstock t1
inner join poinstockentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where t1.fstatus=0
--and t4.fnumber not like '08.11.%'
and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource) and t1.ftrantype=72

--预计入库(塑胶子件收料申请单--未关闭--未关联数)
insert into #My_t_MrpWillInStock(fdate,   frunid,  ftrantype,  finterid,fentryid,   fitemid,   fqty)
select                           t1.fdate,@frunid, 200000022,  t2.fid,  t2.fentryid,t2.fitemid,t2.fqty-t2.fcommitqty
from t_BOSPlasticPoInStock t1 
inner join t_BOSPlasticPoInStockEntry t2 on t1.fid=t2.fid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
--inner join t_department t4 on t1.fdeptid=t4.fitemid
inner join poorderentry t7 on t7.finterid=t2.fid_src and t7.fentryid=t2.fentryid_src 
where t7.FMrpClosed<>1 and isnull(t2.fmrpclosed,0)<>40019 --and t1.fstatus>0 
and (t2.fqty-t2.fcommitqty)>0
and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource) --and t1.FClassTypeID=200000022

--预计入库(塑胶子件-采购订单-未审核)
insert into #My_t_MrpWillInStock(fdate,   frunid,  ftrantype,  finterid,   fentryid,   fitemid,   fqty)
select                           t1.fdate,@frunid, 71,         t1.finterid,t1.fentryid,t9.fitemid,t1.fqty*t12.fqty*(1+t12.fscrap/100)  
from poorderentry t1 
inner join poorder t7 on t1.finterid=t7.finterid
inner join t_icitem t2 on t1.fitemid=t2.fitemid 
inner join t_measureunit t3 on t3.fitemid=t2.funitid
inner join icbom t11 on t11.fitemid=t1.fitemid --and t11.fusestatus=1072
inner join icbomchild t12 on t11.finterid=t12.finterid
inner join t_icitem t9 on t9.fitemid=t12.fitemid  --
where t7.fstatus=0
and t2.fnumber like '1.02.%' and t9.fnumber like '6.%' 
and t12.fitemid in (select fitemid from #My_t_MrpRoughNeedSource) 

--预计入库(塑胶子件--采购申请单-已审核未关闭--未关联数)
insert into #My_t_MrpWillInStock(fdate,        frunid,  ftrantype,  finterid,   fentryid,   fitemid,   fqty)
select                           t1.FFetchTime,@frunid, 71,         t1.finterid,t1.fentryid,t9.fitemid,(t1.fqty-t1.fcommitqty)*t12.fqty*(1+t12.fscrap/100)  
from porequestentry t1 
inner join porequest t7 on t1.finterid=t7.finterid
inner join t_icitem t2 on t1.fitemid=t2.fitemid 
inner join t_measureunit t3 on t3.fitemid=t2.funitid
inner join icbom t11 on t11.fitemid=t1.fitemid --and t11.fusestatus=1072
inner join icbomchild t12 on t11.finterid=t12.finterid
inner join t_icitem t9 on t9.fitemid=t12.fitemid  --
where --t1.fstatus>0 and 
t7.fstatus<>3 --and t2.FFetchTime>=@fdate  --今天开始计起
--and t4.fnumber not like '08.11.%'
--and (t3.fnumber like 'H.%' or t3.fnumber like 'K.%' or t3.fnumber like 'M.%' or t3.fnumber like 'N.%')
and (t1.fqty-t1.fcommitqty)>0  and t1.FMRPClosed<>1
and t2.fnumber like '1.02.%' and t9.fnumber like '6.%' 
and t12.fitemid in (select fitemid from #My_t_MrpRoughNeedSource) 


--待检--日期信息不重要

--待检(未审核的外购入库单)
insert into #My_t_TempInventory(fdate,   frunid, ftrantype,finterid,   fentryid,   fitemid,   fqty)
select                        t1.fdate,@frunid,1,        t2.finterid,t2.fentryid,t2.fitemid,t2.fqty
from icstockbill t1
inner join icstockbillentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where t1.fstatus=0 and t2.FSourceTranType=72 
--and t4.fnumber not like '08.11.%'
and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource) and t1.ftrantype=1

--待检(收料通知单--未关闭--未关联数)--已审核未关闭
insert into #My_t_TempInventory(fdate,   frunid,  ftrantype,  finterid,   fentryid,   fitemid,   fqty)
select                          t1.fdate,@frunid, 72,         t2.finterid,t2.fentryid,t2.fitemid,t2.fqty-t2.fcommitqty-t2.fbackqty
from poinstock t1
inner join poinstockentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where t1.fstatus>0 and t1.fstatus<>3 --
and t2.fqty>(t2.fcommitqty+t2.fbackqty)
--and t4.fnumber not like '08.11.%'
and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource) and t1.ftrantype=72

/*
--预计入库--预测订单
insert into My_t_MrpWillInStock(frunid, ftrantype,finterid,   fentryid,   fitemid,   forderqty,finqty,                       fqty)
select                          @frunid,87,       t2.finterid,t2.fentryid,t2.fitemid,t2.fqty,  isnull(t2.FEntrySelfY0121,0), t2.fqty-isnull(t2.FEntrySelfY0121,0)
from pporder t1
inner join pporderentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
--inner join t_department t4 on t1.FHeadSelfY0121=t4.fitemid
where t2.forderclosed<>1 and t1.fstatus>0 and t1.fstatus<>3
and (t2.fqty-isnull(t2.FEntrySelfY0121,0))>0
--and t4.fnumber not like '08.11.%'
and t2.fitemid in (select fchilditemid from My_t_MrpRoughNeedSource where frunid=@frunid)
*/

--预计入库--
/*
insert into My_t_MrpWillInStock(fneedate,frunid, ftrantype,finterid,   fentryid,   fitemid,   forderqty,finqty,                     fqty)
select                          @frunid,85,       t2.finterid,0,          t2.fitemid,t2.fqty,  isnull(t2.fstockqty,0),     t2.fqty-isnull(t2.fstockqty,0)
from icmo t2 
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t2.fworkshop=t4.fitemid
where t2.fstatus>0 and t2.fstatus<>3
and (t2.fqty-isnull(t2.fstockqty,0))>0
--and t4.fnumber not like '08.11.%'
and t2.fitemid in (select fchilditemid from My_t_MrpRoughNeedSource where frunid=@frunid)
*/

----预计入库--任务单--要把未入库的数量循环分摊到生产计划中
--select t2.fplancommitdate,(t2.fqty-t2.fstockqty) fqty,t2.finterid fsourceinterid,0 fsourceentryid,t2.fitemid
--into #source
--from icmo t2  
--inner join t_icitem t3 on t2.fitemid=t3.fitemid
--inner join t_department t4 on t2.fworkshop=t4.fitemid
--where t2.fstatus<>3
--and (t2.fqty-isnull(t2.fstockqty,0))>0
--and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource)
--
--DECLARE Seorder_Cursor CURSOR FOR
--select fqty,fitemid,fsourceinterid from #source 
--
--OPEN Seorder_Cursor
--
--FETCH NEXT FROM Seorder_Cursor 
--INTO @fqty,@fitemid,@fsourceinterid
--
--WHILE @@FETCH_STATUS = 0
--BEGIN
--	set @fplandate=null
--
--	DECLARE SeorderEntry_Cursor CURSOR FOR
--	select t2.fdate,t2.fqty
--	from my_t_scheduledetail t2  
--	where t2.ficmointerid=@fsourceinterid and t2.fitemid=@fitemid and t2.fdate>=@fdate  --今天开始计起
--	order by t2.fdate
--
--	OPEN SeorderEntry_Cursor
--
--	FETCH NEXT FROM SeorderEntry_Cursor 
--	INTO @fplandate,@fplanqty
--
--	WHILE @@FETCH_STATUS = 0 and @fqty>0
--	BEGIN
--		if @fplanqty>=@fqty
--		begin
--			set @fplanqty=@fqty
--			set @fqty=0
--		end
--		else
--		begin
--			set @fqty=@fqty-@fplanqty
--		end	
--		
--		insert into #My_t_MrpWillInStock(fdate,     frunid, ftrantype,finterid,       fentryid,       fitemid,   fqty)
--		select                          @fplandate,@frunid,85,       @fsourceinterid,@fsourceentryid,@fitemid,  @fplanqty
--	
--		FETCH NEXT FROM SeorderEntry_Cursor 
--		INTO @fplandate,@fplanqty
--	end
--
--	if @fqty>0 --生产任务单一定有生产计划,如果还有剩余数表示当天以前还有计划未执行
--	begin
--		insert into #My_t_MrpWillInStock(frunid, ftrantype,finterid,       fentryid,       fitemid,   fqty, fdate)
--		select                          @frunid,85,       @fsourceinterid,@fsourceentryid,@fitemid,  @fqty,isnull(@fplandate,@fdate)--当天或当天以后还有计划，则放在最后一天，没有则放在当天
--	end
--
--	CLOSE SeorderEntry_Cursor
--	DEALLOCATE SeorderEntry_Cursor
--
--    FETCH NEXT FROM Seorder_Cursor
--    INTO @fqty,@fitemid,@fsourceinterid
--END
--
--CLOSE Seorder_Cursor
--DEALLOCATE Seorder_Cursor

--预计入库--任务单
insert into #My_t_MrpWillInStock(frunid, ftrantype,finterid,   fentryid,fitemid,   fqty,                          fdate)
select                           @frunid,85,       t2.finterid,0,       t2.fitemid,t2.fqty-isnull(t2.fstockqty,0),t2.fplancommitdate
from icmo t2  
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t2.fworkshop=t4.fitemid
where t2.fstatus<>3
and (t2.fqty-isnull(t2.fstockqty,0))>0
and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource)


--select * from ictranstype

--半成品只取展望期内的需求
--if @fitemtype=1
--begin
--	delete t1
--	from #My_t_MrpRoughNeedSource t1 
--	inner join t_icitem t2 on t1.fitemid=t2.fitemid
--	where t1.frunid=@frunid and datediff(day,getdate(),t1.fneeddate)>@FHalfProductProspectDays  --半成品展望期30天
--
--	delete t1
--	from #My_t_MrpWillInStock t1 
--	inner join t_icitem t2 on t1.fitemid=t2.fitemid
--	where t1.frunid=@frunid and datediff(day,getdate(),t1.fdate)>@FHalfProductProspectDays  --半成品展望期30天
--end
 
--净需求具体到天
create table #my_t_MrpResultDetail(fneeddate datetime,fitemid int,funitid int,FRoughNeedQty decimal(24,4),
FWillInStockQty decimal(24,4),FCanUseStockQty decimal(24,4),FNeedQty decimal(24,4))


--select * into #sourcedata
--from 
--(
--	select t1.fneeddate,t1.fitemid,sum(t1.fqty) fqty,0 ftype
--	from My_t_MrpRoughNeedSource t1 where frunid=@frunid group by t1.fneeddate,t1.fitemid
--	union all
--	select t1.fdate fneeddate,t1.fitemid,sum(t1.fqty) fqty,1 ftype
--	from My_t_MrpWillInStock t1 where frunid=@frunid group by t1.fdate,t1.fitemid
--	union all
--	select '2100-01-01' fneeddate,t1.fitemid,sum(t1.fqty) fqty,2 ftype
--	from My_t_MrpStock t1 where frunid=@frunid group by t1.fitemid
--) t1

--select fitemid,fneeddate,isnull(sum(isnull(FRoughNeedQty,0)),0) FRoughNeedQty,isnull(sum(isnull(FWillInStockQty,0)),0) FWillInStockQty 
--into #sourcedata --ftype 0 毛需求 1 预计入库 2 库存
--from
--(
--	select fitemid,fneeddate,(case when ftype=0 then fqty else 0 end) FRoughNeedQty, 
--	(case when ftype=1 then fqty else 0 end) FWillInStockQty,
--	(case when ftype=2 then fqty else 0 end) FStockQty
--	from 
--	(
--		select t1.fneeddate,t1.fitemid,isnull(sum(isnull(t1.fqty,0)),0) fqty,0 ftype
--		from #My_t_MrpRoughNeedSource t1 group by t1.fneeddate,t1.fitemid
--		union all
--		select t1.fdate fneeddate,t1.fitemid,isnull(sum(isnull(t1.fqty,0)),0) fqty,1 ftype
--		from #My_t_MrpWillInStock t1 group by t1.fdate,t1.fitemid
--	) t1
--) t1 group by fitemid,fneeddate
--
--set @fentryid=0

--DECLARE Seorder_Cursor CURSOR FOR
--select t2.fitemid,isnull(max(isnull(t1.fstockqty,0)),0) fstockqty,1 fentryid
--from #sourcedata t2
--left join 			
--(
--	select t1.fitemid,isnull(sum(isnull(t1.fqty,0)),0) fstockqty
--	from #My_t_MrpStock t1 group by t1.fitemid
--) t1 on t1.fitemid=t2.fitemid
--group by t2.fitemid
--
--OPEN Seorder_Cursor
--
--FETCH NEXT FROM Seorder_Cursor 
--INTO @fitemid,@FStockQty,@fentryid
--
--WHILE @@FETCH_STATUS = 0
--BEGIN
--	DECLARE SeorderEntry_Cursor CURSOR FOR
--	select t2.fneeddate,t2.FRoughNeedQty,t2.FWillInStockQty
--	from #sourcedata t2
--	where t2.fitemid=@fitemid 
--	order by t2.fneeddate
--
--	OPEN SeorderEntry_Cursor
--
--	FETCH NEXT FROM SeorderEntry_Cursor 
--	INTO @fneeddate,@FRoughNeedQty,@FWillInStockQty
--	WHILE @@FETCH_STATUS = 0
--	BEGIN
--		if @fentryid=1
--			set @FCanUseStockQty=@fstockqty  --库存在第一次循环的时候才纳入
--
--		set @fentryid=@fentryid+1
--
--		set @FCanUseStockQty=@FWillInStockQty+@FCanUseStockQty-@FRoughNeedQty  --可用库存
--
----		if @FCanUseStockQty>=0
----			set @FNeedQty=0--净需求
----		else
----		begin
----			set @FNeedQty=-@FCanUseStockQty
----			set @FCanUseStockQty=0
----		end
--
----		insert into #my_t_MrpResultDetail(fitemid, fneeddate, FWillInStockQty, FCanUseStockQty, FRoughNeedQty, FNeedQty)
----								   values(@fitemid,@fneeddate,@FWillInStockQty,@FCanUseStockQty,@FRoughNeedQty,@FNeedQty)
--
--		insert into #my_t_MrpResultDetail(fitemid, fneeddate, FWillInStockQty, FCanUseStockQty, FRoughNeedQty, FNeedQty)
--								   values(@fitemid,@fneeddate,@FWillInStockQty,@FCanUseStockQty,@FRoughNeedQty,@FNeedQty)
--
--		--update t1 set fqty=@fqty from #MyMrpResultTemp t1 where fneeddate=@fneeddate and fitemid=@fitemid
--
--		FETCH NEXT FROM SeorderEntry_Cursor 
--		INTO @fneeddate,@FRoughNeedQty,@FWillInStockQty
--	end
--
--	CLOSE SeorderEntry_Cursor
--	DEALLOCATE SeorderEntry_Cursor
--
--    FETCH NEXT FROM Seorder_Cursor
--    INTO @fitemid,@FStockQty,@fentryid
--END
--
--CLOSE Seorder_Cursor
--DEALLOCATE Seorder_Cursor

select t1.finterid,cast('' as varchar(20)) fbillno,t1.fneeddate,t1.fitemid,sum(t1.fqty) fqty 
into #sourcedata
from
(
	select t4.finterid,t1.fneeddate,t1.fitemid,isnull(t1.fqty,0) fqty
	from #My_t_MrpRoughNeedSource t1 
	inner join icmo t4 on t1.fsourceinterid=t4.finterid
	where t1.ftrantype=85 and t1.fneeddate<=@fenddate
) t1 
group by t1.finterid,t1.fneeddate,t1.fitemid

update t1 set fbillno=right(isnull(t2.fbillno,''),5)
from #sourcedata t1
inner join icmo t2 on t1.finterid=t2.finterid

--创建表


-- DECLARE Seorder_Cursor CURSOR FOR
truncate table #Cursor
insert into #Cursor(fplandate,forderbillno)
select distinct t1.fneeddate,t1.fbillno from #sourcedata t1 order by t1.fneeddate,t1.fbillno

-- OPEN Seorder_Cursor
-- 
-- FETCH NEXT FROM Seorder_Cursor 
-- INTO @fplandate,@forderbillno
-- 
-- WHILE @@FETCH_STATUS = 0
-- BEGIN
select @fminid=0,@fmaxid=0
select @fminid=isnull(min(fid),0),@fmaxid=isnull(max(fid),0) from #Cursor

WHILE @fmaxid>0 and @fminid<=@fmaxid --@@FETCH_STATUS = 0  --先把可用库存按物料先分配下去
BEGIN 
	select @fplandate=fplandate,@forderbillno=forderbillno from #Cursor where fid=@fminid

	set @varStrDate=replace(convert(varchar(10),@fplandate,111),'/','-')+'-'+@forderbillno
	set @sqls=''
	set @sqls=@sqls+'alter table #temp add ['+@varStrDate+'] decimal(24,0) default 0 '  

	--print @sqls
	execute (@sqls) 

-- 	FETCH NEXT FROM Seorder_Cursor
-- 	INTO @fplandate,@forderbillno
-- END
-- 
-- CLOSE Seorder_Cursor
-- DEALLOCATE Seorder_Cursor

	set @fminid=@fminid+1
END



--创建表


create table #My_t_SourceTemp(fitemid int)

-- DECLARE Seorder_Cursor CURSOR FOR
truncate table #Cursor
insert into #Cursor(fplandate,forderbillno)
select distinct t1.fneeddate,t1.fbillno from #sourcedata t1 order by t1.fneeddate,t1.fbillno

-- OPEN Seorder_Cursor
-- 
-- FETCH NEXT FROM Seorder_Cursor 
-- INTO @fplandate,@forderbillno
-- 
-- WHILE @@FETCH_STATUS = 0
-- BEGIN
select @fminid=0,@fmaxid=0
select @fminid=isnull(min(fid),0),@fmaxid=isnull(max(fid),0) from #Cursor

WHILE @fmaxid>0 and @fminid<=@fmaxid --@@FETCH_STATUS = 0  --先把可用库存按物料先分配下去
BEGIN 
	select @fplandate=fplandate,@forderbillno=forderbillno from #Cursor where fid=@fminid

	set @varStrDate=replace(convert(varchar(10),@fplandate,111),'/','-')+'-'+@forderbillno

	set @sqls=''
	set @sqls=@sqls+'alter table #My_t_SourceTemp add ['+@varStrDate+'] decimal(24,0) default 0 '  

	execute (@sqls) 

-- 	FETCH NEXT FROM Seorder_Cursor
-- 	INTO @fplandate,@forderbillno
-- END
-- 
-- CLOSE Seorder_Cursor
-- DEALLOCATE Seorder_Cursor

	set @fminid=@fminid+1
END

--print @sqls


--先计算出物料在计划期间每天的需求数---------------------------------------------------------------



set @i=0

truncate table #Cursor
insert into #Cursor(fplandate,forderbillno)
-- DECLARE Seorder_Cursor CURSOR FOR
select distinct t1.fneeddate,t1.fbillno from #sourcedata t1 order by t1.fneeddate,t1.fbillno

-- OPEN Seorder_Cursor
-- 
-- FETCH NEXT FROM Seorder_Cursor 
-- INTO @fplandate,@forderbillno
-- 
-- WHILE @@FETCH_STATUS = 0
select @fminid=0,@fmaxid=0
select @fminid=isnull(min(fid),0),@fmaxid=isnull(max(fid),0) from #Cursor

WHILE @fmaxid>0 and @fminid<=@fmaxid --@@FETCH_STATUS = 0  --先把可用库存按物料先分配下去
BEGIN 
	select @fplandate=fplandate,@forderbillno=forderbillno from #Cursor where fid=@fminid

	set @varStrDate=replace(convert(varchar(10),@fplandate,111),'/','-')+'-'+@forderbillno
	set @sqls1=''
	set @sqls1=@sqls1+'insert into #My_t_SourceTemp (fitemid,['+@varStrDate+']) select fitemid,fqty from #sourcedata where fneeddate='+''''+left(@varStrDate,10)+''''+' and fbillno='+''''+substring(@varStrDate,12,(len(@varStrDate)-11))+''''

	--print @sqls1
	execute (@sqls1)  --结合下面的SQL执行 

-- 	FETCH NEXT FROM Seorder_Cursor
-- 	INTO @fplandate,@forderbillno
-- END
-- 
-- CLOSE Seorder_Cursor
-- DEALLOCATE Seorder_Cursor
	set @fminid=@fminid+1
END

--select * from #sourcedata
--select * from #My_t_SourceTemp

-- --先计算出物料在计划期间每天的需求数---------------------------------------------------------------
-- 
-- IF EXISTS (select * from sysobjects where name='My_t_SourceTemp' and xtype='u')  drop  Table My_t_SourceTemp
-- 
-- set @sqls1='select fitemid,'
-- 
-- set @i=0
-- 
-- truncate table #Cursor
-- insert into #Cursor(fplandate,forderbillno)
-- -- DECLARE Seorder_Cursor CURSOR FOR
-- select distinct t1.fneeddate,t1.fbillno from #sourcedata t1 order by t1.fneeddate,t1.fbillno
-- 
-- -- OPEN Seorder_Cursor
-- -- 
-- -- FETCH NEXT FROM Seorder_Cursor 
-- -- INTO @fplandate,@forderbillno
-- -- 
-- -- WHILE @@FETCH_STATUS = 0
-- select @fminid=0,@fmaxid=0
-- select @fminid=isnull(min(fid),0),@fmaxid=isnull(max(fid),0) from #Cursor
-- 
-- WHILE @fmaxid>0 and @fminid<=@fmaxid --@@FETCH_STATUS = 0  --先把可用库存按物料先分配下去
-- BEGIN 
-- 	select @fplandate=fplandate,@forderbillno=forderbillno from #Cursor where fid=@fminid
-- 
-- 	set @varStrDate=replace(convert(varchar(10),@fplandate,111),'/','-')+'-'+@forderbillno
-- 	set @sqls1=@sqls1+'(case when fneeddate='+''''+left(@varStrDate,10)+''''+' and fbillno='+''''+substring(@varStrDate,12,(len(@varStrDate)-11))+''''+' then fqty else 0 end) '+''''+@varStrDate+''''+','
-- 
-- -- 	FETCH NEXT FROM Seorder_Cursor
-- -- 	INTO @fplandate,@forderbillno
-- -- END
-- -- 
-- -- CLOSE Seorder_Cursor
-- -- DEALLOCATE Seorder_Cursor
-- 	set @fminid=@fminid+1
-- END
-- 
-- set @sqls1=substring(@sqls1,1,len(@sqls1)-1)
-- set @sqls1=@sqls1+' into My_t_SourceTemp from #sourcedata '  
-- 
-- print @sqls1
-- 
-- execute (@sqls1)  --结合下面的SQL执行 

--汇总-------------------------------------------------------------------

insert into #temp(fitemid) select t1.fitemid from #My_t_SourceTemp t1 group by t1.fitemid

-- set @sqls='insert into #temp select t1.fitemid,' 


truncate table #Cursor
insert into #Cursor(fplandate,forderbillno)
-- DECLARE Seorder_Cursor CURSOR FOR
select distinct t1.fneeddate,t1.fbillno from #sourcedata t1 order by t1.fneeddate,t1.fbillno

-- OPEN Seorder_Cursor
-- 
-- FETCH NEXT FROM Seorder_Cursor 
-- INTO @fplandate,@forderbillno
-- 
-- WHILE @@FETCH_STATUS = 0
select @fminid=0,@fmaxid=0
select @fminid=isnull(min(fid),0),@fmaxid=isnull(max(fid),0) from #Cursor

WHILE @fmaxid>0 and @fminid<=@fmaxid --@@FETCH_STATUS = 0  --先把可用库存按物料先分配下去
BEGIN 
	select @fplandate=fplandate,@forderbillno=forderbillno from #Cursor where fid=@fminid

	set @varStrDate=replace(convert(varchar(10),@fplandate,111),'/','-')+'-'+@forderbillno

	set @sqls=''
	set @sqls=@sqls+'update t1 set ['+@varStrDate +']=t2.['+@varStrDate +'] from #temp t1 inner join (select fitemid,sum(['+@varStrDate +']) ['+@varStrDate +'] from #My_t_SourceTemp group by fitemid ) t2 on t1.fitemid=t2.fitemid '  

	--print @sqls
	
	execute (@sqls)   --先计算出物料在计划期间每天的需求数

-- 	FETCH NEXT FROM Seorder_Cursor
-- 	INTO @fplandate,@forderbillno
-- 
-- CLOSE Seorder_Cursor
-- DEALLOCATE Seorder_Cursor 
	set @fminid=@fminid+1
END

-- set @sqls=substring(@sqls,1,len(@sqls)-1)
-- --set @sqls=@sqls+' from ('+@sqls1+') t1  group by t1.fitemid '  
-- set @sqls=@sqls+' from #My_t_SourceTemp t1  group by t1.fitemid '  


/*
update t1 set FModQty=FTempdNeedQty%fbatchappendqty from #MyMrpResultTemp t1 where fneedqty>0

update t1 set FActNeedQty=FTempdNeedQty+(fbatchappendqty-FModQty) 
from #MyMrpResultTemp t1 where fneedqty>0 and FModQty>0
*/
--select * from #temp
--保存结果--明细
--delete from my_t_MrpResultDetail where fhscount=@fhscount  --update my_t_MrpResultDetail set fremark=''

select cast(0 as bit) 选择,t2.fnumber 物料编码,t2.fname 名称,t2.fmodel 规格型号,t7.fname 仓库,t3.fname 单位,
cast(t5.fqty as int) 未发数,isnull(t4.fqty,0) 库存,isnull(t4.fqty,0)-cast(t5.fqty as int) 欠数,
isnull(t8.fqty,0) 待检,isnull(t6.fqty,0) 预计入库,t1.*
from #temp t1 
inner join t_icitem t2 on t1.fitemid=t2.fitemid
inner join t_measureunit t3 on t2.funitid=t3.fitemid
inner join (select fitemid,sum(fqty) fqty from #My_t_MrpRoughNeedSource group by fitemid) t5 on t5.fitemid=t1.fitemid
left join (select fitemid,sum(isnull(fqty,0)) fqty from #My_t_TempInventory group by fitemid) t8 on t8.fitemid=t1.fitemid
left join (select fitemid,sum(isnull(fqty,0)) fqty from #My_t_MrpStock group by fitemid) t4 on t4.fitemid=t1.fitemid
left join (select fitemid,sum(isnull(fqty,0)) fqty from #My_t_MrpWillInStock group by fitemid) t6 on t6.fitemid=t1.fitemid
left join t_stock t7 on t7.fitemid=t2.fdefaultloc
where isnull(t4.fqty,0)<isnull(t5.fqty,0)
order by t2.fnumber

drop table #My_t_SourceTemp
drop table #Cursor
drop table #CursorEntry
drop table #NoOutStock
drop table #temp
drop table #Source
drop table #data
drop table #my_t_MrpResultDetail
drop table #sourcedata
drop table #My_t_MrpRoughNeedSource
drop table #My_t_MrpWillInStock
drop table #My_t_TempInventory
drop table #My_t_MrpStock

set nocount off

GO


IF EXISTS (select * from sysobjects where name='My_P_ReplaceAnalyse' and xtype='p')  drop  procedure My_P_ReplaceAnalyse
go

--@fitemtype  100 全部 0 成品 1 半成品  2 常规物料 3 包材  @ftype 0 常规运算 1 按单运算
create procedure [dbo].My_P_ReplaceAnalyse (@fuserid int,@frunid int,@fbillno varchar(20),@fitemtype int)  --,@ftype int
 
as
set nocount on


if @frunid=0
	exec My_p_GetBillNo 50000010,'My_t_ReplaceAnalyse',@frunid output, @fbillno output
	
create table #replace(fproductid int,fitemid int,fstockqty decimal(24,4) default 0,fwillinqty decimal(24,4) default 0,fwilloutqty decimal(24,4) default 0,fendqty decimal(24,4) default 0,
frepitemid int,frepstockqty decimal(24,4) default 0,frepwillinqty decimal(24,4) default 0,frepwilloutqty decimal(24,4) default 0,frependqty decimal(24,4) default 0,forder int)

insert into #replace(fproductid,fitemid,FRepItemId,forder)
select distinct t4.fproductid,t5.fitemid,t5.FRepItemId,t5.FOrder
from ppbomentry t1
inner join ppbom t2 on t1.finterid=t2.finterid
inner join icmo t3 on t3.finterid=t1.ficmointerid
inner join t_BOSICItemReplace t4 on t4.fproductid=t3.fitemid
inner join t_BOSICItemReplaceEntry t5 on t4.fid=t5.fid and t5.fitemid=t1.fitemid
where t3.fstatus in (1,2,5) --确认或下达
and t1.fqtymust>t1.fstockqty --未发数>0的物料
and isnull(t1.folditemid,0)=0  --还没有替换过


select t1.finterid,t1.fentryid,t3.fitemid fproductid,t1.ficmointerid,
t1.fitemid,t1.fqtymust,t1.fstockqty,(t1.fqtymust-t1.fstockqty) fqty
into #sourcedata 
from ppbomentry t1
inner join ppbom t2 on t1.finterid=t2.finterid
inner join icmo t3 on t3.finterid=t1.ficmointerid
where t3.fstatus in (1,2,5) --确认或下达
and t1.fqtymust>t1.fstockqty --未发数>0的物料
and isnull(t1.folditemid,0)=0  --还没有替换过
and t3.fitemid in (select fprodcutid from #replace)
and t1.fitemid in (select fitemid from #replace)

set @fentryid=0

declare @fminid int,@fmaxid int,@fentryminid int,@fentrymaxid int,@fpreitemid int
create table #Cursor(FID int identity(1,1),finterid int,fentryid int,fitemid int,FQty decimal(24,2))
create table #CursorEntry(FID int identity(1,1),finterid int,fentryid int,fitemid int,FQty decimal(24,2),frepitemid int)

select @fpreitemid=0,@fcanuseqty=0

truncate table #Cursor
insert into #Cursor(fitemid,finterid,fentryid,FQty)
select fitemid,finterid,fentryid,FQty
from #sourcedata t1 
order by fitemid

select @fminid=0,@fmaxid=0
select @fminid=isnull(min(fid),0),@fmaxid=isnull(max(fid),0) from #Cursor

WHILE @fmaxid>0 and @fminid<=@fmaxid --@@FETCH_STATUS = 0  --先把可用库存按物料先分配下去
BEGIN 
	select @finterid=finterid,@fentryid=fentryid,@fitemid=fitemid,@FWillOutQty=FWillOutQty from #Cursor where fid=@fminid
	
	if @fpreitemid<>@fitemid
	begin
		select top 1 @fcanuseqty=fstockqty+fwillinqty from #replace where fitemid=@fitemid
	end	
	
	set @fpreitemid=@fitemid
	
	if @fcanuseqty>0
	begin
		if @fcanuseqty>=@FWillOutQty --库存够分配
		begin
			delete from #sourcedata where finterid=@finterid and fentryid=@fentryid
		end
		else
		begin
			update t1 set FWillOutQty=FWillOutQty-@fcanuseqty from #sourcedata t1 where finterid=@finterid and fentryid=@fentryid
		end
		
		set @fcanuseqty=@fcanuseqty-@FWillOutQty
	end
	
	set @fminid=@fminid+1
END

--1 该物料有未发数
--2 该物料的可用库存不够发
--3 该物料有可代替其的物料
--4 可代替其的物料扣除掉自己使用的库存外,还有剩余的库存	

truncate table #Cursor
insert into #Cursor(fproductid,fitemid)
select fproductid,fitemid
from #replace t1 
order by fitemid

select @fminid=0,@fmaxid=0
select @fminid=isnull(min(fid),0),@fmaxid=isnull(max(fid),0) from #Cursor

WHILE @fmaxid>0 and @fminid<=@fmaxid --@@FETCH_STATUS = 0
BEGIN 
	select @fproductid=fproductid,@FRepItemId=FRepItemId,@fitemid=fitemid,@FQty=FQty,@frependqty=frependqty 
	from #Cursor where fid=@fminid
	 
	truncate table #CursorEntry
	insert into #CursorEntry(finterid,fentryid,fwilloutqty)
	select t2.finterid,t2.fentryid,t2.fwilloutqty
	from #sourcedata t2	where fproduct=@fproductid and t2.fitemid=@fitemid order by t2.fneeddate

	select @fentryminid=0,@fentrymaxid=0
	select @fentryminid=isnull(min(fid),0),@fentrymaxid=isnull(max(fid),0) from #CursorEntry

	WHILE @fentrymaxid>0 and @fentryminid<=@fentrymaxid --@@FETCH_STATUS = 0
	BEGIN 
		select @finterid=finterid,@fentryid=fentryid,@fwilloutqty=fwilloutqty from #CursorEntry where fid=@fentryminid

		select @frepitemid=frepitemid,@frependqty=frependqty from #replace where fproduct=@fproductid and fitemid=@fitemid and frependqty>0

		if @frependqty>=@fwilloutqty --
		begin
			update t1 set frepitemid=@frepitemid,frepqty=@frependqty from #sourcedata t1 where finterid=@finterid and fentryid=@fentryid
		end
		else
		begin
			update t1 set fqty=fqty-@fwilloutqty from #sourcedata t1 where finterid=@finterid and fentryid=@fentryid
			
			insert into #sourcedate(finterid,fentryid,fitemid,fqty,frepitemid,frepqty)
			values(@finterid,@fentryid,@fitemid,@frependqty,@frepitemid,@frependqty)
		end

		update t1 set frependqty=frependqty-@fwilloutqty  from #replace t1 where fproduct=@fproductid and frepitemid=@frepitemid
		
		set @fentryminid=@fentryminid+1
	end
	set @fminid=@fminid+1
END

update t1 set fwilloutqty=t2.fqty
from #replace t1
inner join (select fitemid,sum(fqty) fqty from #willout group by fitemid) t2 on t1.fitemid=t2.fitemid

update t1 set frepwilloutqty=t2.fqty
from #replace t1
inner join (select fitemid,sum(fqty) fqty from #willout group by fitemid) t2 on t1.frepitemid=t2.fitemid

update t1 set fwillinqty=t2.fqty
from #replace t1
inner join (select fitemid,sum(fqty) fqty from #willin group by fitemid) t2 on t1.fitemid=t2.fitemid

update t1 set frepwillinqty=t2.fqty
from #replace t1
inner join (select fitemid,sum(fqty) fqty from #willin group by fitemid) t2 on t1.frepitemid=t2.fitemid

update t1 set fstockqty=t2.fqty
from #replace t1
inner join (select fitemid,sum(fqty) fqty from #stock group by fitemid) t2 on t1.fitemid=t2.fitemid

update t1 set frepstockqty=t2.fqty
from #replace t1
inner join (select fitemid,sum(fqty) fqty from #stock group by fitemid) t2 on t1.frepitemid=t2.fitemid

update #replace set fqty=fstockqty+fwillinqty-fwilloutqty
update #replace set frepqty=frepstockqty+frepwillinqty-frepwilloutqty

delete from #replace where fendqty>0 --剩余库存够用
delete from #replace where frependqty<=0 --替换物料剩余库存不够用

--预计出库
create table #willout(fitemid int,fqty decimal(24,4))

insert into #willout(fitemid,fqty)
select t3.fitemid,(t3.fqtymust-t3.fstockqty) fqty
from icmo t5 
inner join ppbom t2 on t5.finterid=t2.ficmointerid
inner join ppbomentry t3 on t2.finterid=t3.finterid
inner join t_icitem t4 on t3.fitemid=t4.fitemid --子项
inner join t_icitem t8 on t5.fitemid=t8.fitemid --父项
where t5.fstatus in (1,2,5) and (t3.fqtymust-t3.fstockqty)>0 
and (t3.fitemid in (select fitemid from #replace) or t2.fitemid in (select FRepItemId from #replace))

--预计出库--随单出货外购件
insert into #willout(fitemid,fqty)
select t4.fitemid,t4.fqty-isnull(t4.fstockqty,0)
from seorderentry t4 
inner join seorder t5  on t5.finterid=t4.finterid
inner join t_icitem t8 on t8.fitemid=t4.fitemid
where t8.ferpclsid=1 and t4.fmrpclosed<>1 and (t5.fstatus>0 or isnull(t5.FMultiCheckLevel1,0)>0) 
and (t4.fitemid in (select fitemid from #replace) or t2.fitemid in (select FRepItemId from #replace))

--预计入库
create table #willin(fitemid int,fqty decimal(24,4))

--预计入库--(采购申请单--未关闭--未关联数)--逻辑检查未关闭则中断MRP运算，因为采购申请单的到货日期是未确认的--此处开放为订单模拟时候用
insert into #willin(fitemid,fqty)
select t2.fitemid,t2.fqty-t2.fcommitqty
from porequest t1
inner join porequestentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where --t1.fstatus>0 and 
t1.fstatus<>3 and isnull(t2.fmrpclosed,0)<>1
--and t4.fnumber not like '08.11.%'
and t3.ferpclsid in (1)
--and (t3.fnumber like 'H.%' or t3.fnumber like 'K.%' or t3.fnumber like 'M.%' or t3.fnumber like 'N.%')
and (t2.fqty-t2.fcommitqty)>0 
and (t2.fitemid in (select fitemid from #replace) or t2.fitemid in (select FRepItemId from #replace))

--预计入库(未审核的外购入库单)
insert into #willin(fitemid,fqty)
select t2.fitemid,t2.fqty
from icstockbill t1
inner join icstockbillentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where t1.fstatus=0 and t2.FSourceTranType=72 
--and t4.fnumber not like '08.11.%'
and (t2.fitemid in (select fitemid from #replace) or t2.fitemid in (select FRepItemId from #replace))

--预计入库(收料通知单--未关闭--未关联数)
insert into #willin(fitemid,fqty)
select t2.fitemid,t2.fqty-t2.fcommitqty-t2.fbackqty
from poinstock t1
inner join poinstockentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where t1.fstatus<>3 --已经审核的才纳入????
and t2.fqty>(t2.fcommitqty+t2.fbackqty)
--and t4.fnumber not like '08.11.%'
and (t2.fitemid in (select fitemid from #replace) or t2.fitemid in (select FRepItemId from #replace))

--预计入库(塑胶子件收料申请单--未关闭--未关联数)
insert into #willin(fitemid,fqty)
select t2.fitemid,t2.fqty-t2.fcommitqty
from t_BOSPlasticPoInStock t1 
inner join t_BOSPlasticPoInStockEntry t2 on t1.fid=t2.fid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join poorderentry t7 on t7.finterid=t2.fid_src and t7.fentryid=t2.fentryid_src 
--inner join t_department t4 on t1.fdeptid=t4.fitemid
where t7.FMrpClosed<>1 and isnull(t2.fmrpclosed,0)<>40019 --and t1.fstatus>0 
and (t2.fqty-t2.fcommitqty)>0
and (t2.fitemid in (select fitemid from #replace) or t2.fitemid in (select FRepItemId from #replace))

--预计入库--生产任务单
insert into #willin(fitemid,fqty)
select t2.fitemid, t2.fqty-isnull(t2.fstockqty,0)
from icmo t2 
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t2.fworkshop=t4.fitemid
where t2.fstatus>0 and t2.fstatus<>3
and (t2.fqty-isnull(t2.fstockqty,0))>0
--and t4.fnumber not like '08.11.%'
and (t2.fitemid in (select fitemid from #replace) or t2.fitemid in (select FRepItemId from #replace))

--库存
create table #stock(fitemid int,fqty decimal(24,4))

insert into #stock(fitemid,fqty)
select t1.fitemid,t1.fqty
from icinventory t1
inner join t_ICItem t2 on t1.FItemID=t2.FItemID
inner join t_stock t3 on t3.fitemid=t1.fstockid
where --t2.ferpclsid in (1) and 
t1.fqty>0 --and t3.fname not like '%计划%' 
and t3.fname not like '%不良%' and t3.fname not like '%报废%'
--and t3.fnumber not like '11.%' 
--and (t2.fnumber like 'H.%' or t2.fnumber like 'K.%' or t2.fnumber like 'M.%' or t2.fnumber like 'N.%')
and (t2.fitemid in (select fitemid from #replace) or t2.fitemid in (select FRepItemId from #replace))

insert into #stock(fitemid,fqty)
select t1.fitemid,t1.fqty
from poinventory t1
inner join t_ICItem t2 on t1.FItemID=t2.FItemID
inner join t_stock t3 on t3.fitemid=t1.fstockid
where --t2.ferpclsid in (1) and 
t1.fqty>0 --and t3.fname not like '%计划%' 
and t3.fname not like '%不良%' and t3.fname not like '%报废%' and t3.fitemid=16483  --代管仓
--and t3.fnumber not like '11.%' 
--and (t2.fnumber like 'H.%' or t2.fnumber like 'K.%' or t2.fnumber like 'M.%' or t2.fnumber like 'N.%')
and (t2.fitemid in (select fitemid from #replace) or t2.fitemid in (select FRepItemId from #replace))


select * from t_BOSICItemReplace
select * from t_BOSICItemReplaceEntry
select
from icinventory t1
left join pp
where t1.fqty>0 and 

go

--MRP计算--*****--
--exec My_P_MrpCal 16394, 0, '',2 --

IF EXISTS (select * from sysobjects where name='My_P_MrpCal' and xtype='p')  drop  procedure My_P_MrpCal
go

--@fitemtype  100 全部 0 成品 1 外购半成品  2 常规物料 3 包材 4 芯片 5 自制半成品 @ftype 0 常规运算 1 按单运算
create procedure [dbo].My_P_MrpCal (@fuserid int,@frunid int,@fbillno varchar(20),@fitemtype int,@FProspectDays int)  --,@ftype int
 
as
set nocount on

--declare @fuserid int,@frunid int,@fbillno varchar(20),@fitemtype int select @fitemtype=2,@fbillno='',@fuserid=16394,@frunid=0  

if @frunid=0
	exec My_p_GetBillNo 50000002,'my_t_mrp',@frunid output, @fbillno output

declare @fdeptid int,@fitemid int,@fpqty decimal(24,2),@forderinterid int,@s varchar(8000),@forderbillno varchar(50)
declare @fqty decimal(24,4),@fplanqty decimal(24,4),@fstockqty decimal(24,4),@FWillInStockQty decimal(24,4),@FRoughNeedQty decimal(24,4)
declare @FCanUseStockQty decimal(24,4),@FNeedQty decimal(24,4),@fsourceinterid int,@fplandate datetime,@fentryid int
declare @fbegdate datetime,@fenddate datetime,@fneeddate datetime,@finvdate datetime,@fcaldate datetime,@FOrderBillLike varchar(120),@fsourceentryid int
declare @fsendenddate datetime,@iRunID int, @iYear int,@iPeriod int,@fpackoutstockinterid int,@i int,@fnumbermatch varchar(20)
declare @ficmointerid int,@fplancommitdate datetime,@FPrepareDays int

declare @FProductProspectDays int,@FHalfProductProspectDays int,@FProductPrepareDays int,@FHalfProductPrepareDays int

select @FProductProspectDays=fvalue from t_SystemProfile where FCategory='IC' and fkey='FProductProspectDays' 
select @FHalfProductProspectDays=fvalue from t_SystemProfile where FCategory='IC' and fkey='FHalfProductProspectDays' 
select @FProductPrepareDays=fvalue from t_SystemProfile where FCategory='IC' and fkey='FProductPrepareDays' 
select @FHalfProductPrepareDays=fvalue from t_SystemProfile where FCategory='IC' and fkey='FHalfProductPrepareDays' 

select @s='',@i=1

--生产任务单下达了才能排产，排产了才参与MRP运算；收料计划如果未排，则取采购订单的日期和数量，否则耦合性太强
--icmo fstatus 5 确认 0 计划 1,2 下达 3 结案  fmrp 11061 mps产生 1052 手工录入 11077 mrp产生 

--if exists(
--select t1.fbillno
--from icmo t1
--left join (select ficmointerid,sum(fqty) fqty from my_t_scheduledetail where fsourcetrantype=85 group by ficmointerid) t2 on t1.finterid=t2.ficmointerid
--where t1.fstatus<>3 and (t1.finterid is null  or t1.fqty>isnull(t2.fqty,0)) )
--begin
--	select @s=@s+','+m1.fbillno from
--	(
--		select t1.fbillno
--		from icmo t1
--		left join (select ficmointerid,sum(fqty) fqty from my_t_scheduledetail where fsourcetrantype=85 group by ficmointerid) t2 on t1.finterid=t2.ficmointerid
--		where t1.fstatus<>3 and (t1.finterid is null  or t1.fqty>isnull(t2.fqty,0))
--	) m1
--
--	set @s='任务单['+@s+']还未生成生产计划!'  --排不完就排到最后一天--
--	RAISERROR(@s,18,18)
--end 

------暂时未查出什么原因
------投料单关联错误--1 单据内码
------select t0.fbillno,t1.ficmointerid,t1.fppbomentryid,t1.fitemid,t1.fqty fqty,t1.fsourceinterid,t1.fsourceentryid,t1.*
--update t1 set FEntrySelfZOU30=t1.fsourceinterid,FEntrySelfZOU31=t1.fsourceentryid
--from ZPStockBill t0 --
--inner join ZPStockBillEntry t1 on t0.finterid=t1.finterid  --
--inner join icmo t3 on t3.finterid=t1.FSourceInterId
--where t0.ftrantype=26 --and t0.fbillno='ZOUT000548' 
--and t1.fsourcetrantype in (85) and isnull(t1.FEntrySelfZOU30,0)=0 
--and isnull(t1.fsourceinterid,0)<>0 
----
------投料单关联错误--2 选单数
----select t3.FCheckDate,t3.fbillno,t4.fnumber,t4.fname,t4.fmodel,t1.fqty,isnull(t2.fqty,0) fselectqty

Delete from My_t_MrpRoughNeedSource where frunid in (select frunid from my_t_Mrp where fdate<=Dateadd(day,-7,getdate()))
Delete from My_t_MrpWillInStock where frunid in (select frunid from my_t_Mrp where fdate<=Dateadd(day,-7,getdate()))
Delete from my_t_MrpResultDetail where frunid in (select frunid from my_t_Mrp where fdate<=Dateadd(day,-7,getdate()))
Delete from My_t_MrpStock where frunid in (select frunid from my_t_Mrp where fdate<=Dateadd(day,-7,getdate()))
Delete from my_t_MrpResultSum where frunid in (select frunid from my_t_Mrp where fdate<=Dateadd(day,-7,getdate()))

delete from my_t_scheduledetail where fdate<=Dateadd(day,-90,getdate())

declare @finterid int,@fnumber varchar(50),@fname varchar(500)
declare @FParentNumber varchar(50),@FParentID int,@FBootID int

DECLARE icbom_cursor CURSOR FOR	
select t1.fnumber,t1.fname 
from t_item t1
left join ICBomGroup t2 on t1.fnumber=t2.fnumber
where t1.fitemclassid=4 and left(t1.fnumber,1) in ('3','4','5','A','P','R','Q','J','X','Y','V') and t1.fdetail=0 
and t2.fnumber is null
order by t1.fnumber

OPEN icbom_cursor

FETCH NEXT FROM icbom_cursor 
INTO @fnumber,@fname

WHILE @@FETCH_STATUS = 0
BEGIN 
	if not exists(select 1 from ICBomGroup where fnumber=@fnumber)
	begin
		set @finterid=0
		SELECT @finterid=isnull(FMaxNum,0) FROM ICMaxNum WHERE FTableName='ICBOMGroup'
		set @finterid=@finterid+1

		if CHARINDEX('.',@fnumber)=0
		begin
			select @FParentID=0,@FBootID=@finterid
		end
		else
		begin
			select @FParentNumber=REVERSE(right(REVERSE(@fnumber),len(@fnumber)-CHARINDEX('.',REVERSE(@fnumber))))
			select @FParentID=FInterID,@FBootID=finterid from ICBomGroup where fnumber=@FParentNumber
		end

		INSERT INTO ICBomGroup (FInterID, FNumber, FName, FParentID, FBootID) 
		VALUES (				@finterid,@fnumber,@fname,@FParentID,@FBootID)

		UPDATE ICMaxNum SET FMaxNum=@finterid WHERE FTableName='ICBOMGroup'
	end

	FETCH NEXT FROM icbom_cursor 
    INTO @fnumber,@fname
END

CLOSE icbom_cursor
DEALLOCATE icbom_cursor


--BOM组别
update t2 set fparentid=t14.finterid
from t_icitem t1
inner join ICBom t2 on t1.fitemid=t2.fitemid
inner join t_item t13 on t1.FParentID=t13.fitemid
inner join ICBomGroup t14 on t14.fnumber=t13.fnumber
where t2.fparentid<>t14.finterid

update t1 set fqty=isnull(t2.fqty,0),fauxqty=isnull(t2.fqty,0)
from PPBOMEntry t1 --
left join 
(
	select t1.FEntrySelfZOU30 ficmointerid,t1.FEntrySelfZOU31 fppbomentryid,t1.fitemid,sum(t1.fqty) fqty
	from ZPStockBill t0 --
	inner join ZPStockBillEntry t1 on t0.finterid=t1.finterid  --
	inner join icmo t3 on t3.finterid=t1.FEntrySelfZOU30
	where t0.ftrantype=26 and t1.fsourcetrantype in (85,200000014)
	group by t1.FEntrySelfZOU30,t1.FEntrySelfZOU31,t1.fitemid
	union all
	select t1.ficmointerid,t1.fppbomentryid,t1.fitemid,sum(t1.fqty) fqty
	from ICStockBill t0 --
	inner join ICStockBillEntry t1 on t0.finterid=t1.finterid  --
	inner join icmo t3 on t3.finterid=t1.ficmointerid
	where t0.ftrantype=24 and t1.fsourcetrantype in (85,200000014)
	group by t1.ficmointerid,t1.fppbomentryid,t1.fitemid
) t2 on t1.ficmointerid=t2.ficmointerid and t1.FEntryID=t2.fppbomentryid and t1.fitemid=t2.fitemid
inner join icmo t3 on t1.ficmointerid=t3.finterid
inner join t_icitem t4 on t1.fitemid=t4.fitemid 
where t3.fstatus<>3 and t1.fqty<>isnull(t2.fqty,0) and t3.fbillno like '%'
--
------投料单关联错误--3 领料数
--select t3.FCheckDate,t3.fbillno,t4.fnumber,t4.fname,t4.fmodel,t1.fstockqty,isnull(t2.fqty,0) fselectqty
update t1 set fstockqty=isnull(t2.fqty,0),fauxstockqty=isnull(t2.fqty,0)
from PPBOMEntry t1 --
left join 
(
	select t1.FEntrySelfZOU30 ficmointerid,t1.FEntrySelfZOU31 fppbomentryid,t1.fitemid,sum(t1.fqty) fqty
	from ZPStockBill t0 --
	inner join ZPStockBillEntry t1 on t0.finterid=t1.finterid  --
	inner join icmo t3 on t3.finterid=t1.FEntrySelfZOU30
	where t0.ftrantype=26 and t1.fsourcetrantype in (85,200000014) and t0.fstatus>0
	group by t1.FEntrySelfZOU30,t1.FEntrySelfZOU31,t1.fitemid
	union all
	select t1.ficmointerid,t1.fppbomentryid,t1.fitemid,sum(t1.fqty) fqty
	from ICStockBill t0 --
	inner join ICStockBillEntry t1 on t0.finterid=t1.finterid  --
	inner join icmo t3 on t3.finterid=t1.ficmointerid
	where t0.ftrantype=24 and t1.fsourcetrantype in (85,200000014) and t0.fstatus>0
	group by t1.ficmointerid,t1.fppbomentryid,t1.fitemid
) t2 on t1.ficmointerid=t2.ficmointerid and t1.FEntryID=t2.fppbomentryid and t1.fitemid=t2.fitemid
inner join icmo t3 on t1.ficmointerid=t3.finterid
inner join t_icitem t4 on t1.fitemid=t4.fitemid
where t3.fstatus<>3 and t1.fstockqty<>isnull(t2.fqty,0) and t3.fbillno like '%'

--没有成本对象
update t1 set fcostobjid=t2.fitemid
from icmo t1
inner join cbcostobj t2 on t1.fitemid=t2.fstdproductid
where t1.fstatus<>3 and isnull(t1.fcostobjid,0)=0

--包材已经直接置入BOM
--if @fitemtype=3  --前台检查所选订单的包材需求在包装方案都齐备后计算--条件:已经下了生产任务单（但不是所有任务单都拿来计算,因为有些订单还没有配置包装方案）
--begin
--	select distinct t7.fbillno forderbillno,t8.finterid ficmointerid,t2.fnumber,isnull(t11.fid,0) fpacksubid
--	into #mosource
--	from seorderentry t1 
--	inner join seorder t7 on t1.finterid=t7.finterid
--	inner join t_icitem t2 on t1.fitemid=t2.fitemid 
--	inner join icmo t8 on t1.finterid=t8.forderinterid and t1.fentryid=t8.fsourceentryid
--	inner join t_item t9 on t9.fitemclassid=3002 and t9.fitemid=t1.fentryselfs0158
--	left join (select min(fid) fid,fproductid,fbrandid from t_BOSPackSub group by fproductid,fbrandid) t11 on t11.fproductid=t1.fitemid and t11.fbrandid=t1.fentryselfs0158  --包装方式
--	where t1.fmrpclosed<>1 --行业务未关闭
--	and t1.finterid in (select forderinterid from my_t_MrpSeOrder where frunid=@frunid and fselect=1) --去掉不参与运算的
--	--and (t7.fstatus>0 or isnull(t7.FMultiCheckLevel1,0)>0) --一审或者已经审核
--	and (t8.fqty>isnull(t8.fstockqty,0) and t8.fstatus in (1,2,5)) --未工的生产任务单
--	and t9.fname not like '%裸包%'

----	--非裸包但没有包装方案
----	if exists(select 1 from #mosource t1 where fpacksubid=0)
----	begin
----		select @s=@s+','+m1.fbillno from
----		(
----			select (t1.forderbillno+' | '+t1.fnumber) fbillno from #mosource t1 where fpacksubid=0
----		) m1
----
----		set @s='['+@s+']还没有包装方案!'  --
----		RAISERROR(@s,18,18)
----	end 

--	DECLARE Seorder_Cursor CURSOR FOR
--	select ficmointerid from #mosource group by ficmointerid

--	OPEN Seorder_Cursor

--	FETCH NEXT FROM Seorder_Cursor 
--	INTO @ficmointerid

--	WHILE @@FETCH_STATUS = 0
--	BEGIN
--		if not exists (select 1 from ppbomentry t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid 
--					   where t1.ficmointerid=@ficmointerid and (t1.fqty>0 or isnull(t1.folditemid,0)<>0) and t1.FEntrySelfY0259=3)  --如果投料单已经有包材,则不重新生成，防止用户有修改过标准投料单又被清除
--		begin
--			exec My_P_AddOrEditPPBom @fuserid,@ficmointerid,3
--		end

--		FETCH NEXT FROM Seorder_Cursor
--		INTO @ficmointerid
--	END

--	CLOSE Seorder_Cursor
--	DEALLOCATE Seorder_Cursor

--	drop table #mosource
--end

/*
update m2 set fstatus=3
--select distinct m4.fbillno
from icmo m2 
inner join seorderentry m1 on m2.forderinterid=m1.finterid and m2.fsourceentryid=m1.fentryid
inner join seorder m4 on m4.finterid=m1.finterid
where (m1.fmrpclosed=1 or m2.fstockqty>=m2.fqty) and m2.fstatus<>3
*/

--获取运算码--改为前台获取
--declare @iMaxRunID int
--if exists(select 1 from my_t_Mrp)
--  select @iMaxRunID=max(frunid)+1 from my_t_Mrp 
--else
--  set @iMaxRunID=100*10+1
--
--set @frunid=@iMaxRunID

--select dateadd(day,15,getdate()),datediff(day,getdate(),'2012-12-29')

declare @fdate datetime
select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期

--保存运算信息
if not exists(select 1 from my_t_Mrp where frunid=@frunid)
begin
	insert into my_t_Mrp(ftrantype, fbillno, frunid, fuserid, fbilltime,fdate) 
	values(              @fitemtype,@fbillno,@frunid,@fuserid,getdate(),@fdate)
end

----成品展望期内需求数
--insert into My_t_MrpRoughNeedSource(fneeddate,ficmointerid,ftrantype,frunid, forderinterid,forderentryid,fitemid,   fchilditemid,   forderqty,finqty, fqty,fchildmustqty,    fchildoutqty, fchildqty)
--select						        t6.fdate, t5.finterid, 0,        @frunid,0,            0,            t8.fitemid,t4.fitemid,     0,        0,      0,   t3.fmustqty,      t3.fstockqty, t3.fmustqty-t3.fstockqty
--from my_t_scheduledetail t6 
--inner join icmo t5 on t6.ficmointerid=t5.finterid
--inner join ppbom t2 on t5.finterid=t2.ficmointerid
--inner join ppbomentry t3 on t2.finterid=t3.finterid
--inner join t_icitem t4 on t3.fitemid=t4.fitemid --子项
--inner join t_icitem t8 on t5.fitemid=t8.fitemid --父项
--inner join t_SubMessage t13 on t13.finterid=t4.f_114 and t13.ftypeid=10004  --仓管员
--inner join t_SubMessage t17 on t17.finterid=t4.f_115 and t17.ftypeid=10003  --倒冲
--where t5.fstatus in (1,2) and (t3.fqtymust-t3.fstockqty)>0  --
--and isnull(t5.forderinterid,0)<>0 and datediff(day,getdate(),t6.fdate)=30  --成品展望期30天
----and t5.fqty>t5.fstockqty  --如何保证入库的是已经领了料的????????????????

create table #data(fitemid int,fnumber varchar(50),fplancommitdate datetime,fqty decimal(24,4),fsourceinterid int,
fsourceentryid int,fauxqtyscrap decimal(24,4),fscrap decimal(24,4),FPrepareDays int)

--投料单未发数--生产任务单中 成品是30天 半成品是15天
insert into #data(fnumber,fplancommitdate,fqty,fsourceinterid,fsourceentryid,fitemid,fauxqtyscrap,fscrap,FPrepareDays)
select t4.fnumber,t5.fplancommitdate,(t3.fqtymust-t3.fstockqty) fqty,
t5.finterid fsourceinterid,0 fsourceentryid,t3.fitemid,t3.fauxqtyscrap,t3.fscrap,
@FProductPrepareDays FPrepareDays  --成品直接下级则取成品的准备期，否则则取半成品的准备期
from icmo t5 
inner join ppbom t2 on t5.finterid=t2.ficmointerid
inner join ppbomentry t3 on t2.finterid=t3.finterid
inner join t_icitem t4 on t3.fitemid=t4.fitemid --子项
inner join t_icitem t8 on t5.fitemid=t8.fitemid --父项
inner join seorderentry t1 on t1.finterid=t5.forderinterid and t1.fentryid=t5.fsourceentryid
inner join seorder t6 on t6.finterid=t1.finterid
where t5.fstatus in (1,2,5) and (t3.fqtymust-t3.fstockqty)>0 
--and datediff(day,getdate(),t1.fdate)<=@FProductProspectDays  --成品展望期30天 
and t6.FHeadSelfS0148<>'1900-01-01' and t6.FHeadSelfS0148<>'2100-01-01'  --交期确定了以后才参与运算
and datediff(day,getdate(),t6.FHeadSelfS0148)<=@FProspectDays  --展望期 
union all
select t4.fnumber,t5.fplancommitdate,(t3.fqtymust-t3.fstockqty) fqty,
t5.finterid fsourceinterid,0 fsourceentryid,t3.fitemid,t3.fauxqtyscrap,t3.fscrap,
@FHalfProductPrepareDays FPrepareDays  --成品直接下级则取成品的准备期，否则则取半成品的准备期
from icmo t5 
inner join ppbom t2 on t5.finterid=t2.ficmointerid
inner join ppbomentry t3 on t2.finterid=t3.finterid
inner join t_icitem t4 on t3.fitemid=t4.fitemid --子项
inner join t_icitem t8 on t5.fitemid=t8.fitemid --父项
where t5.fstatus in (1,2,5) and (t3.fqtymust-t3.fstockqty)>0 and isnull(t5.forderinterid,0)=0 --半成品

--@fitemtype  100 全部 0 成品 1 外购半成品  2 常规物料 3 包材 4 芯片 5 自制半成品
if @fitemtype=1
	delete from #data where left(fnumber,1) not in ('7','8') -- (select fitemtype from v_MyItemType where ftype=1)  --3.  4. 前缀物料编码为半成品
else if @fitemtype=3
begin
	delete from #data where fnumber not like '2.%'   --2. 前缀物料编码为包材

	delete t1
	from #data t1
	inner join t_icitem t2 on t1.fitemid=t2.fitemid
	inner join t_stock t3 on t2.fdefaultloc=t3.fitemid
	where t3.ftypeid=503 --代管仓
end
else if @fitemtype=4
	delete from #data where fnumber not like '1.01.0010.%'   --1.01.0010. 前缀物料编码为芯片
if @fitemtype=5
	delete from #data where left(fnumber,1) not in ('3','4','5')
else if @fitemtype=2
	delete from #data where left(fnumber,1) in (select fitemtype from v_MyItemType where ftype in(1,3)) or fnumber like '1.01.0010.%'

--性能比较慢,先汇总不到明细
insert into My_t_MrpRoughNeedSource(fneeddate,      ftrantype,frunid, fsourceinterid,   fsourceentryid,   fitemid,   fqty)
select                              fplancommitdate,85,       @frunid,t2.fsourceinterid,t2.fsourceentryid,t2.fitemid,t2.fqty
from #data t2

------按生产计划分摊到日需求中
--DECLARE Seorder_Cursor CURSOR FOR
--select sum(fqty) fqty,fitemid,fsourceinterid 
--from #data 
--group by fitemid,fsourceinterid
--
--OPEN Seorder_Cursor
--
--FETCH NEXT FROM Seorder_Cursor 
--INTO @fqty,@fitemid,@fsourceinterid
--
--WHILE @@FETCH_STATUS = 0
--BEGIN
--	DECLARE SeorderEntry_Cursor CURSOR FOR
--	select Dateadd(day,-t2.FPrepareDays,t6.fdate) fplandate,t6.fqty*t2.fauxqtyscrap*(1+t2.fscrap/100) fqty
--	from #data t2  
--	inner join my_t_scheduledetail t6 on t6.ficmointerid=t2.fsourceinterid  
--	where t2.fsourceinterid=@fsourceinterid and t2.fitemid=@fitemid and t6.fdate>=@fdate  --今天开始计起
--	order by t6.fdate
--
--	OPEN SeorderEntry_Cursor
--
--	FETCH NEXT FROM SeorderEntry_Cursor 
--	INTO @fplandate,@fplanqty
--
--	WHILE @@FETCH_STATUS = 0 and @fqty>0  --
--	BEGIN
--		if @fplanqty>=@fqty  --当天该物料的需求数大于未发数(余数)
--		begin
--			set @fplanqty=@fqty
--			set @fqty=0
--		end
--		else
--		begin
--			set @fqty=@fqty-@fplanqty
--		end	
--		
--		insert into My_t_MrpRoughNeedSource(fneeddate, ftrantype,frunid, fsourceinterid,  fsourceentryid,  fitemid,  fqty)
--		select                              @fplandate,85,       @frunid,@fsourceinterid, 0,               @fitemid, @fplanqty
--	
--		FETCH NEXT FROM SeorderEntry_Cursor 
--		INTO @fplandate,@fplanqty
--	end
--
--	--可能出现当天或当天以后没有生产计划，有余数的话也放在今天的需求中
--	if @fqty>0 --如果还有剩余数则放在今天的需求中--如果当天以前领多了，则没有剩余数，表示最后一天不用领那么多；如果当天以前领少了，则有剩余数，即欠数，表示今天应领出来，否则影响生产；
--	begin
--		insert into My_t_MrpRoughNeedSource(fneeddate, ftrantype,frunid, fsourceinterid,  fsourceentryid,  fitemid,  fqty)
--		select                              @fdate,    85,       @frunid,@fsourceinterid, 0,               @fitemid, @fqty
--	end
--
--	CLOSE SeorderEntry_Cursor
--	DEALLOCATE SeorderEntry_Cursor
--
--    FETCH NEXT FROM Seorder_Cursor
--    INTO @fqty,@fitemid,@fsourceinterid
--END
--
--CLOSE Seorder_Cursor
--DEALLOCATE Seorder_Cursor  


----还没有下任务单的计划投料单--不参与分摊，直接插入--先屏蔽
--insert into My_t_MrpRoughNeedSource(fneeddate,      ftrantype,frunid, fsourceinterid,  fsourceentryid,  fitemid,   fqty)
--select Dateadd(day,-@FProductPrepareDays,t4.fdate), 81,       @frunid,t4.finterid,     t4.fentryid,     t3.fitemid,t1.fqty-isnull(t1.fcommitqty,0)
----select	t3.fnumber,t4.fdate fplancommitdate,(t1.fqty-isnull(t1.fcommitqty,0)) fqty,
----t4.finterid fsourceinterid,t4.fentryid fsourceentryid,t3.fitemid,t1.fbomqty fauxqtyscrap,0 fscrap,
----@FProductPrepareDays FPrepareDays
--from seorderentry t4 
--inner join seorder t5  on t5.finterid=t4.finterid
--inner join t_icitem t8 on t8.fitemid=t4.fitemid
--inner join t_Organization t6 on t5.FCustID=t6.fitemid
--inner join t_BOSPlanChangeStockEntry t1 on t4.finterid=t1.FID_SRC and t4.fentryid=t1.FEntryID_SRC
--inner join t_BOSPlanChangeStock t2 on t2.fid=t1.fid 
--inner join t_icitem t3 on t3.fitemid=t1.fitemid
--inner join t_department t11 on t11.fitemid=t5.fdeptid
--where t4.fmrpclosed<>1 and isnull(t1.fmrpclosed,0)<>40019 
----and (isnull(t5.fstatus,0)>0 or isnull(t5.FMultiCheckLevel1,0)>0) 
--and not exists (select 1 from icmo where forderinterid=t5.finterid) --and t5.finterid not in (select forderinterid from icmo) --不能写成这样!!!
--and (t1.fqty-isnull(t1.fcommitqty,0))>0 

--毛需求--随单出货外购件
insert into My_t_MrpRoughNeedSource(fneeddate,                                   ftrantype,frunid, fsourceinterid,fsourceentryid,fitemid,   fqty   )
select	                            Dateadd(day,-@FProductPrepareDays,t4.fdate), 81,       @frunid,t4.finterid,   t4.fentryid,   t4.fitemid,t4.fqty-isnull(t4.fstockqty,0)
from seorderentry t4 
inner join seorder t5  on t5.finterid=t4.finterid
inner join t_icitem t8 on t8.fitemid=t4.fitemid
inner join t_Organization t6 on t5.FCustID=t6.fitemid
inner join t_department t11 on t11.fitemid=t5.fdeptid
where t8.ferpclsid=1 and t4.fmrpclosed<>1 and (t5.fstatus>0 or isnull(t5.FMultiCheckLevel1,0)>0) --and t5.fdate>='2011-07-01'
--and 
--(
--	datediff(day,getdate(),t4.fdate)=@FProductProspectDays  --成品30天
--	or exists(select 1 from t_BOSPlanChangeStockEntry where FID_SRC=t4.finterid)  --有计划投料单的表示已经模拟
--) 
--and t5.finterid in (select t2.forderinterid from my_t_mrp t1 inner join my_t_mrpseorder t2 on t1.frunid=t2.frunid where t2.fselect=1)
and t4.fqty>t4.fstockqty

--if exists(select 1 from my_t_MrpSeOrder where frunid=@frunid)  --按单MRP运算  --只要计算过的都要考虑
--begin
--	delete from My_t_MrpRoughNeedSource where fitemid not in 
--	(
--		select t1.fitemid
--  		from My_t_MrpRoughNeedSource t1
--		inner join icmo t2 on t1.fsourceinterid=t2.finterid
--		where t1.frunid=@frunid and t1.ftrantype=85 and t2.forderinterid in (select forderinterid from my_t_MrpSeOrder where frunid=@frunid)
--		union all
--		select t1.fitemid
--		from My_t_MrpRoughNeedSource t1
--		where t1.frunid=@frunid and t1.ftrantype=81 and t1.fsourceinterid in (select forderinterid from my_t_MrpSeOrder where frunid=@frunid)
--	)
--end
	
	
--@fitemtype  100 全部 0 成品 1 外购半成品  2 常规物料 3 包材 4 芯片 5 自制半成品
if @fitemtype=1
begin
	delete t1 from My_t_MrpRoughNeedSource t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid 
	where t1.frunid=@frunid and left(t2.fnumber,1) not in ('7','8') -- (select fitemtype from v_MyItemType where ftype=1) --3.  4. 前缀物料编码为半成品
end	
else if @fitemtype=3
begin
	delete t1 from My_t_MrpRoughNeedSource t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid 
	where t1.frunid=@frunid and t2.fnumber not like '2.%'   --2. 前缀物料编码为常规物料
end	
else if @fitemtype=4
begin
	delete t1 from My_t_MrpRoughNeedSource t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid 
	where t1.frunid=@frunid and t2.fnumber not like '1.01.0010.%'   --1.01.0010. 前缀物料编码为芯片
end	
else if @fitemtype=5
begin
	delete t1 from My_t_MrpRoughNeedSource t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid 
	where t1.frunid=@frunid and left(t2.fnumber,1) not in ('3','4','5')
end		
else if @fitemtype=2
begin
	delete t1 from My_t_MrpRoughNeedSource t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid 
	where t1.frunid=@frunid and (left(t2.fnumber,1) in (select fitemtype from v_MyItemType where ftype in(1,3)) or t2.fnumber like '1.01.0010.%')
end

----关联任务单未审核的生产领料单
--insert into My_t_MrpRoughNeedSource(fneeddate,ficmointerid,ftrantype,frunid, forderinterid,forderentryid,fitemid,   fchilditemid,   forderqty,finqty, fqty,fchildmustqty,fchildoutqty, fchildqty)
--select						        t2.fdate, t5.finterid, 0,        @frunid,0,            0,            t8.fitemid,t4.fitemid,     0,        0,      0,   t3.fqty,      0,            t3.fqty
--from icmo t5 
--inner join icstockbillentry t3 on t5.finterid=t3.ficmointerid
--inner join icstockbill t2 on t2.finterid=t3.finterid
--inner join t_icitem t4 on t3.fitemid=t4.fitemid
--inner join t_icitem t8 on t5.fitemid=t8.fitemid
--inner join t_SubMessage t13 on t13.finterid=t4.f_114 and t13.ftypeid=10004  --仓管员
--inner join t_SubMessage t17 on t17.finterid=t4.f_115 and t17.ftypeid=10003  --倒冲
--where t2.ftrantype=24 and t2.fstatus in (0) 



--预计入库--要把未收料的数量循环分摊到收料计划中
/*
select                          @frunid,71,       t2.finterid,t2.fentryid,t2.fitemid,t2.fqty,  t2.fcommitqty,t2.fqty-t2.fcommitqty
from poorder t1
inner join poorderentry t2 on  t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where --t1.FClosed<>1 
t2.fmrpclosed<>1 
--and t4.fnumber not like '08.11.%' --and t1.fstatus>0 
and t1.fstatus<>3  --采购订单收料完毕就关闭，但不一定已经入库
and t3.ferpclsid in (1) 
--and (t3.fnumber like 'H.%' or t3.fnumber like 'K.%' or t3.fnumber like 'M.%' or t3.fnumber like 'N.%')
and (t2.fqty-t2.fcommitqty)>0
and t2.fitemid in (select fchilditemid from My_t_MrpRoughNeedSource where frunid=@frunid)
*/

--收料计划分摊--生产任务单一定有生产计划，而采购订单可能还没有收料计划
select t2.fdate fplancommitdate,(t2.fqty-t2.fcommitqty) fqty,
t2.finterid fsourceinterid,t2.fentryid fsourceentryid,t2.fitemid
into #temp
from poorderentry t2  
inner join poorder t1 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where --t1.FClosed<>1 
t2.fmrpclosed<>1 
--and t4.fnumber not like '08.11.%' --and t1.fstatus>0 
and t1.fstatus<>3  --采购订单收料完毕就关闭，但不一定已经入库
and t3.ferpclsid in (1) 
--and (t3.fnumber like 'H.%' or t3.fnumber like 'K.%' or t3.fnumber like 'M.%' or t3.fnumber like 'N.%')
and (t2.fqty-t2.fcommitqty)>0
and t2.fitemid in (select fitemid from My_t_MrpRoughNeedSource where frunid=@frunid)

--性能比较慢,先汇总不到明细
insert into My_t_MrpWillInStock(frunid, ftrantype,finterid,         fentryid,         fitemid,   fqty ,  fdate     )
select                          @frunid,71,       t2.fsourceinterid,t2.fsourceentryid,t2.fitemid,t2.fqty,t2.fplancommitdate
from #temp t2

--DECLARE Seorder_Cursor CURSOR FOR
--select fqty,fitemid,fsourceinterid,fsourceentryid,fplancommitdate 
--from #temp 
--
--OPEN Seorder_Cursor
--
--FETCH NEXT FROM Seorder_Cursor 
--INTO @fqty,@fitemid,@fsourceinterid,@fsourceentryid,@fplancommitdate
--
--WHILE @@FETCH_STATUS = 0
--BEGIN
--	set @fplandate=null
--
--	DECLARE SeorderEntry_Cursor CURSOR FOR
--	select t2.fdate,t2.fqty
--	from my_t_scheduledetail t2  
--	where t2.fsourceinterid=@fsourceinterid and t2.fsourceentryid=@fsourceentryid 
--	and t2.fitemid=@fitemid and t2.fdate>=@fdate  --今天开始计起 
--	order by t2.fdate
--
--	OPEN SeorderEntry_Cursor
--
--	FETCH NEXT FROM SeorderEntry_Cursor 
--	INTO @fplandate,@fplanqty
--
--	WHILE @@FETCH_STATUS = 0 and @fqty>0  --
--	BEGIN
--		if @fplanqty>=@fqty
--		begin
--			set @fplanqty=@fqty
--			set @fqty=0
--		end
--		else
--		begin
--			set @fqty=@fqty-@fplanqty
--		end	
--		
--		insert into My_t_MrpWillInStock(fdate,     frunid, ftrantype,finterid,       fentryid,       fitemid,   fqty)
--		select                          @fplandate,@frunid,71,       @fsourceinterid,@fsourceentryid,@fitemid,  @fplanqty
--	
--		FETCH NEXT FROM SeorderEntry_Cursor 
--		INTO @fplandate,@fplanqty
--	end
--
--	if @fqty>0 --如果还有剩余数则放在最后一天的计划--如果当天以前收多了，则没有剩余数，表示最后一天不用收那么多；如果当天以前收少了，则有剩余数；
--	begin
--		insert into My_t_MrpWillInStock(frunid, ftrantype,finterid,       fentryid,       fitemid,   fqty ,fdate     )
--		select                          @frunid,71,       @fsourceinterid,@fsourceentryid,@fitemid,  @fqty,isnull(@fplandate,@fplancommitdate)/*如果没有当天或当天以后没有收料计划，则取订单收料日期*/
--	end
--
--	CLOSE SeorderEntry_Cursor
--	DEALLOCATE SeorderEntry_Cursor
--
--    FETCH NEXT FROM Seorder_Cursor
--    INTO @fqty,@fitemid,@fsourceinterid,@fsourceentryid,@fplancommitdate
--END
--
--CLOSE Seorder_Cursor
--DEALLOCATE Seorder_Cursor

--预计入库--(采购申请单--未关闭--未关联数)--逻辑检查未关闭则中断MRP运算，因为采购申请单的到货日期是未确认的--此处开放为订单模拟时候用
insert into My_t_MrpWillInStock(fdate,        frunid, ftrantype,finterid,   fentryid,   fitemid,   fqty)
select                          t2.FFetchTime,@frunid,70,       t2.finterid,t2.fentryid,t2.fitemid,t2.fqty-t2.fcommitqty
from porequest t1
inner join porequestentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where --t1.fstatus>0 and 
t1.fstatus<>3 and isnull(t2.fmrpclosed,0)<>1
--and t4.fnumber not like '08.11.%'
and t3.ferpclsid in (1)
--and (t3.fnumber like 'H.%' or t3.fnumber like 'K.%' or t3.fnumber like 'M.%' or t3.fnumber like 'N.%')
and (t2.fqty-t2.fcommitqty)>0 
and t2.fitemid in (select fitemid from My_t_MrpRoughNeedSource where frunid=@frunid)

--预计入库(未审核的外购入库单)
insert into My_t_MrpWillInStock(fdate,   frunid, ftrantype,finterid,   fentryid,   fitemid,   fqty)
select                          t1.fdate,@frunid,1,        t2.finterid,t2.fentryid,t2.fitemid,t2.fqty
from icstockbill t1
inner join icstockbillentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where t1.fstatus=0 and t2.FSourceTranType=72 
--and t4.fnumber not like '08.11.%'
and t2.fitemid in (select fitemid from My_t_MrpRoughNeedSource where frunid=@frunid) and t1.ftrantype=1

--预计入库(收料通知单--未关闭--未关联数)
insert into My_t_MrpWillInStock(fdate,   frunid,  ftrantype,  finterid,   fentryid,   fitemid,   fqty)
select                          t1.fdate,@frunid, 72,         t2.finterid,t2.fentryid,t2.fitemid,t2.fqty-t2.fcommitqty-t2.fbackqty
from poinstock t1
inner join poinstockentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where t1.fstatus<>3 --已经审核的才纳入????
and t2.fqty>(t2.fcommitqty+t2.fbackqty)
--and t4.fnumber not like '08.11.%'
and t2.fitemid in (select fitemid from My_t_MrpRoughNeedSource where frunid=@frunid) and t1.ftrantype=72

--预计入库(塑胶子件收料申请单--未关闭--未关联数)
insert into My_t_MrpWillInStock(fdate,   frunid,  ftrantype,  finterid,fentryid,   fitemid,   fqty)
select                          t1.fdate,@frunid, 200000022,  t2.fid,  t2.fentryid,t2.fitemid,t2.fqty-t2.fcommitqty
from t_BOSPlasticPoInStock t1 
inner join t_BOSPlasticPoInStockEntry t2 on t1.fid=t2.fid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join poorderentry t7 on t7.finterid=t2.fid_src and t7.fentryid=t2.fentryid_src 
--inner join t_department t4 on t1.fdeptid=t4.fitemid
where t7.FMrpClosed<>1 
and isnull(t2.fmrpclosed,0)<>40019 --and t1.fstatus>0 
and (t2.fqty-t2.fcommitqty)>0
and t2.fitemid in (select fitemid from My_t_MrpRoughNeedSource where frunid=@frunid) --and t1.FClassTypeID=200000022


/*
--预计入库--预测订单
insert into My_t_MrpWillInStock(frunid, ftrantype,finterid,   fentryid,   fitemid,   forderqty,finqty,                       fqty)
select                          @frunid,87,       t2.finterid,t2.fentryid,t2.fitemid,t2.fqty,  isnull(t2.FEntrySelfY0121,0), t2.fqty-isnull(t2.FEntrySelfY0121,0)
from pporder t1
inner join pporderentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
--inner join t_department t4 on t1.FHeadSelfY0121=t4.fitemid
where t2.forderclosed<>1 and t1.fstatus>0 and t1.fstatus<>3
and (t2.fqty-isnull(t2.FEntrySelfY0121,0))>0
--and t4.fnumber not like '08.11.%'
and t2.fitemid in (select fchilditemid from My_t_MrpRoughNeedSource where frunid=@frunid)
*/

--预计入库--任务单--
--要把未入库的数量循环分摊到生产计划中!!!!!!!!!!!!!!!!!!!!!!!!!!!!
/*
insert into My_t_MrpWillInStock(fneedate,frunid, ftrantype,finterid,   fentryid,   fitemid,   forderqty,finqty,                     fqty)
select                          @frunid,85,       t2.finterid,0,          t2.fitemid,t2.fqty,  isnull(t2.fstockqty,0),     t2.fqty-isnull(t2.fstockqty,0)
from icmo t2 
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t2.fworkshop=t4.fitemid
where t2.fstatus>0 and t2.fstatus<>3
and (t2.fqty-isnull(t2.fstockqty,0))>0
--and t4.fnumber not like '08.11.%'
and t2.fitemid in (select fchilditemid from My_t_MrpRoughNeedSource where frunid=@frunid)
*/

select t2.fplancommitdate,(t2.fqty-t2.fstockqty) fqty,t2.finterid fsourceinterid,0 fsourceentryid,t2.fitemid
into #source
from icmo t2  
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t2.fworkshop=t4.fitemid
where t2.fstatus<>3
and (t2.fqty-isnull(t2.fstockqty,0))>0
and t2.fitemid in (select fitemid from My_t_MrpRoughNeedSource where frunid=@frunid)

--性能比较慢,先汇总不到明细
insert into My_t_MrpWillInStock(fdate,             frunid, ftrantype,finterid,         fentryid,         fitemid,   fqty)
select                          t2.fplancommitdate,@frunid,85,       t2.fsourceinterid,t2.fsourceentryid,t2.fitemid,t2.fqty
from #source t2

--DECLARE Seorder_Cursor CURSOR FOR
--select fqty,fitemid,fsourceinterid from #source 
--
--OPEN Seorder_Cursor
--
--FETCH NEXT FROM Seorder_Cursor 
--INTO @fqty,@fitemid,@fsourceinterid
--
--WHILE @@FETCH_STATUS = 0
--BEGIN
--	set @fplandate=null
--
--	DECLARE SeorderEntry_Cursor CURSOR FOR
--	select t2.fdate,t2.fqty
--	from my_t_scheduledetail t2  
--	where t2.ficmointerid=@fsourceinterid and t2.fitemid=@fitemid and t2.fdate>=@fdate  --今天开始计起
--	order by t2.fdate
--
--	OPEN SeorderEntry_Cursor
--
--	FETCH NEXT FROM SeorderEntry_Cursor 
--	INTO @fplandate,@fplanqty
--
--	WHILE @@FETCH_STATUS = 0 and @fqty>0
--	BEGIN
--		if @fplanqty>=@fqty
--		begin
--			set @fplanqty=@fqty
--			set @fqty=0
--		end
--		else
--		begin
--			set @fqty=@fqty-@fplanqty
--		end	
--		
--		insert into My_t_MrpWillInStock(fdate,     frunid, ftrantype,finterid,       fentryid,       fitemid,   fqty)
--		select                          @fplandate,@frunid,85,       @fsourceinterid,@fsourceentryid,@fitemid,  @fplanqty
--	
--		FETCH NEXT FROM SeorderEntry_Cursor 
--		INTO @fplandate,@fplanqty
--	end
--
--	if @fqty>0 --生产任务单一定有生产计划,如果还有剩余数表示当天以前还有计划未执行
--	begin
--		insert into My_t_MrpWillInStock(frunid, ftrantype,finterid,       fentryid,       fitemid,   fqty, fdate)
--		select                          @frunid,85,       @fsourceinterid,@fsourceentryid,@fitemid,  @fqty,isnull(@fplandate,@fdate)--当天或当天以后还有计划，则放在最后一天，没有则放在当天
--	end
--
--	CLOSE SeorderEntry_Cursor
--	DEALLOCATE SeorderEntry_Cursor
--
--    FETCH NEXT FROM Seorder_Cursor
--    INTO @fqty,@fitemid,@fsourceinterid
--END
--
--CLOSE Seorder_Cursor
--DEALLOCATE Seorder_Cursor

--库存
insert into My_t_MrpStock(frunid,fitemid,fstockid,fqty)
select @frunid,t1.fitemid,t1.fstockid,t1.fqty
from icinventory t1
inner join t_ICItem t2 on t1.FItemID=t2.FItemID
inner join t_stock t3 on t3.fitemid=t1.fstockid
where --t2.ferpclsid in (1) and 
t1.fqty>0 --and t3.fname not like '%计划%' 
and t3.fname not like '%不良%' and t3.fname not like '%报废%'
--and t3.fnumber not like '11.%' 
--and (t2.fnumber like 'H.%' or t2.fnumber like 'K.%' or t2.fnumber like 'M.%' or t2.fnumber like 'N.%')
and t2.fitemid in (select fitemid from My_t_MrpRoughNeedSource where frunid=@frunid)

insert into My_t_MrpStock(frunid,fitemid,fstockid,fqty)
select @frunid,t1.fitemid,t1.fstockid,t1.fqty
from poinventory t1
inner join t_ICItem t2 on t1.FItemID=t2.FItemID
inner join t_stock t3 on t3.fitemid=t1.fstockid
where --t2.ferpclsid in (1) and 
t1.fqty>0 --and t3.fname not like '%计划%' 
and t3.fname not like '%不良%' and t3.fname not like '%报废%' and t3.fitemid=16483  --代管仓
--and t3.fnumber not like '11.%' 
--and (t2.fnumber like 'H.%' or t2.fnumber like 'K.%' or t2.fnumber like 'M.%' or t2.fnumber like 'N.%')
and t2.fitemid in (select fitemid from My_t_MrpRoughNeedSource where frunid=@frunid)

--select * from ictranstype  select * from t_stock

--半成品只取展望期内的需求
--if @fitemtype=1
--begin
--	delete t1
--	from My_t_MrpRoughNeedSource t1 
--	inner join t_icitem t2 on t1.fitemid=t2.fitemid
--	where t1.frunid=@frunid and datediff(day,getdate(),t1.fneeddate)>@FHalfProductProspectDays  --半成品展望期30天
--
--	delete t1
--	from My_t_MrpWillInStock t1 
--	inner join t_icitem t2 on t1.fitemid=t2.fitemid
--	where t1.frunid=@frunid and datediff(day,getdate(),t1.fdate)>@FHalfProductProspectDays  --半成品展望期30天
--end
 
--汇总--毛需求-预计入库-库存=净需求
select (select min(fneeddate) from My_t_MrpRoughNeedSource where frunid=@frunid and fitemid=t2.fitemid) fneeddate,
t2.fitemid,t3.fitemid funitid,0 fcyid,0 fsupid,0 fempid,
cast (0 as decimal(24,5)) fprice,t1.FRoughNeedQty,t1.FWillInStockQty,t1.FStockQty,
(t1.FRoughNeedQty-t1.FWillInStockQty-t1.FStockQty) FNeedQty, 
isnull(t2.fbatchappendqty,0) fbatchappendqty,isnull(t2.fqtymin,0) fqtymin,isnull(t2.fsecinv,0) fsecinvqty,
0 FTempdNeedQty,0 FActNeedQty,0 FModQty,cast('' as varchar(50)) fremark
into #MyMrpResultSum
from
(
	select fitemid,isnull(sum(FRoughNeedQty),0) FRoughNeedQty,isnull(sum(FWillInStockQty),0) FWillInStockQty,
	isnull(sum(FStockQty),0) FStockQty --ftype 0 毛需求 1 预计入库 2 库存
	from
	(
		select fitemid,(case when ftype=0 then fqty else 0 end) FRoughNeedQty, 
		(case when ftype=1 then fqty else 0 end) FWillInStockQty,
		(case when ftype=2 then fqty else 0 end) FStockQty
		from 
		(
			select t1.fitemid,isnull(sum(t1.fqty),0) fqty,0 ftype
			from My_t_MrpRoughNeedSource t1 where frunid=@frunid group by t1.fitemid
			union all
			select t1.fitemid,isnull(sum(t1.fqty),0) fqty,1 ftype
			from My_t_MrpWillInStock t1 where frunid=@frunid group by t1.fitemid
			union all
			select t1.fitemid,isnull(sum(t1.fqty),0) fqty,2 ftype
			from My_t_MrpStock t1 where frunid=@frunid group by t1.fitemid
		) t1
	) t1 group by fitemid
) t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid
inner join t_measureunit t3 on t2.funitid=t3.fitemid
--where t2.fitemid=6736--t2.ferpclsid in (2)--t2.fhelpcode='39213'


--顺序: 净需求+安全库存=>净需求=>最小订货量=>批量增量
update t1 set FTempdNeedQty=
(case when (fneedqty+fsecinvqty)<fqtymin then fqtymin else (fneedqty+fsecinvqty) end),--考虑安全库存
FActNeedQty=
(case when (fneedqty+fsecinvqty)<fqtymin then fqtymin else (fneedqty+fsecinvqty) end)
from #MyMrpResultSum t1 
where fneedqty>0  --只有有需求的才考虑安全库存数

--保存结果--汇总
insert into my_t_MrpResultSum(fneeddate,frunid,fsupplyid,fcurrencyid,fempid,fprice, 
fitemid,FRoughNeedQty,FWillInStockQty,FStockQty,FNeedQty,fbatchappendqty,fqtymin,fsecinvqty,FActNeedQty,fqty)
select fneeddate,@frunid,isnull(fsupid,0),isnull(fcyid,0),isnull(fempid,0),isnull(fprice,0),fitemid,
FRoughNeedQty,FWillInStockQty,FStockQty,FNeedQty,fbatchappendqty,fqtymin,fsecinvqty,
--(case when t1.FNeedQty<100 and t1.FNeedQty>0 and t1.fqtymin>=1000 then 100 else t1.FActNeedQty end) FActNeedQty,--非合理订货数
--(case when t1.FNeedQty<100 and t1.FNeedQty>0 and t1.fqtymin>=1000 then 100 else t1.FActNeedQty end) FQty
FActNeedQty,FActNeedQty
from #MyMrpResultSum t1 --where fneedqty>0 

create table #MyMrpResultDetail(fneeddate datetime,fitemid int,funitid int,FRoughNeedQty decimal(24,4),
FWillInStockQty decimal(24,4),FCanUseStockQty decimal(24,4),FNeedQty decimal(24,4))

--净需求具体到天
--select * into #sourcedata
--from 
--(
--	select t1.fneeddate,t1.fitemid,sum(t1.fqty) fqty,0 ftype
--	from My_t_MrpRoughNeedSource t1 where frunid=@frunid group by t1.fneeddate,t1.fitemid
--	union all
--	select t1.fdate fneeddate,t1.fitemid,sum(t1.fqty) fqty,1 ftype
--	from My_t_MrpWillInStock t1 where frunid=@frunid group by t1.fdate,t1.fitemid
--	union all
--	select '2100-01-01' fneeddate,t1.fitemid,sum(t1.fqty) fqty,2 ftype
--	from My_t_MrpStock t1 where frunid=@frunid group by t1.fitemid
--) t1

select fitemid,fneeddate,isnull(sum(FRoughNeedQty),0) FRoughNeedQty,isnull(sum(FWillInStockQty),0) FWillInStockQty 
into #sourcedata --ftype 0 毛需求 1 预计入库 2 库存
from
(
	select fitemid,fneeddate,(case when ftype=0 then fqty else 0 end) FRoughNeedQty, 
	(case when ftype=1 then fqty else 0 end) FWillInStockQty,
	(case when ftype=2 then fqty else 0 end) FStockQty
	from 
	(
		select t1.fneeddate,t1.fitemid,isnull(sum(t1.fqty),0) fqty,0 ftype
		from My_t_MrpRoughNeedSource t1 where frunid=@frunid group by t1.fneeddate,t1.fitemid
		union all
		select t1.fdate fneeddate,t1.fitemid,isnull(sum(t1.fqty),0) fqty,1 ftype
		from My_t_MrpWillInStock t1 where frunid=@frunid group by t1.fdate,t1.fitemid
	) t1
) t1 group by fitemid,fneeddate

set @fentryid=0

declare @fminid int,@fmaxid int,@fentryminid int,@fentrymaxid int
create table #Cursor(FID int identity(1,1),fentryid int,fitemid int,FStockQty decimal(24,2))
create table #CursorEntry(FID int identity(1,1),fneeddate datetime,FRoughNeedQty decimal(24,2),FWillInStockQty decimal(24,2))

truncate table #Cursor
insert into #Cursor(fitemid,fstockqty,fentryid)
select t2.fitemid,isnull(max(t1.fstockqty),0) fstockqty,1 fentryid
from #sourcedata t2
left join 			
(
	select t1.fitemid,isnull(sum(t1.fqty),0) fstockqty
	from My_t_MrpStock t1 where frunid=@frunid group by t1.fitemid
) t1 on t1.fitemid=t2.fitemid
group by t2.fitemid

--OPEN icbom_cursor
--
--FETCH NEXT FROM icbom_cursor 
--INTO @fdeptid

select @fminid=0,@fmaxid=0
select @fminid=isnull(min(fid),0),@fmaxid=isnull(max(fid),0) from #Cursor

--DECLARE Seorder_Cursor CURSOR FOR
--select t2.fitemid,isnull(max(t1.fstockqty),0) fstockqty,1 fentryid
--from #sourcedata t2
--left join 			
--(
--	select t1.fitemid,isnull(sum(t1.fqty),0) fstockqty
--	from My_t_MrpStock t1 where frunid=@frunid group by t1.fitemid
--) t1 on t1.fitemid=t2.fitemid
--group by t2.fitemid
--
--OPEN Seorder_Cursor
--
--FETCH NEXT FROM Seorder_Cursor 
--INTO @fitemid,@FStockQty,@fentryid

WHILE @fmaxid>0 and @fminid<=@fmaxid --@@FETCH_STATUS = 0
BEGIN 
	select @fitemid=fitemid,@FStockQty=FStockQty,@fentryid=fentryid from #Cursor where fid=@fminid

--	DECLARE SeorderEntry_Cursor CURSOR FOR
--	select t2.fneeddate,t2.FRoughNeedQty,t2.FWillInStockQty
--	from #sourcedata t2
--	where t2.fitemid=@fitemid 
--	order by t2.fneeddate
--
--	OPEN SeorderEntry_Cursor
--
--	FETCH NEXT FROM SeorderEntry_Cursor 
--	INTO @fneeddate,@FRoughNeedQty,@FWillInStockQty

	truncate table #CursorEntry
	insert into #CursorEntry(fneeddate,FRoughNeedQty,FWillInStockQty)
	select t2.fneeddate,t2.FRoughNeedQty,t2.FWillInStockQty
	from #sourcedata t2	where t2.fitemid=@fitemid order by t2.fneeddate

	select @fentryminid=0,@fentrymaxid=0
	select @fentryminid=isnull(min(fid),0),@fentrymaxid=isnull(max(fid),0) from #CursorEntry

	WHILE @fentrymaxid>0 and @fentryminid<=@fentrymaxid --@@FETCH_STATUS = 0
	BEGIN 
		select @fneeddate=fneeddate,@FRoughNeedQty=FRoughNeedQty,@FWillInStockQty=FWillInStockQty from #CursorEntry where fid=@fentryminid

		if @fentryid=1
			set @FCanUseStockQty=@fstockqty  --库存在第一次循环的时候才纳入

		set @fentryid=@fentryid+1

		set @FCanUseStockQty=@FWillInStockQty+@FCanUseStockQty-@FRoughNeedQty  --可用库存

		if @FCanUseStockQty>=0
			set @FNeedQty=0--净需求
		else
		begin
			set @FNeedQty=-@FCanUseStockQty
			set @FCanUseStockQty=0
		end

		insert into #MyMrpResultDetail(fitemid, fneeddate, FWillInStockQty, FCanUseStockQty, FRoughNeedQty, FNeedQty)
								values(@fitemid,@fneeddate,@FWillInStockQty,@FCanUseStockQty,@FRoughNeedQty,@FNeedQty)

		--update t1 set fqty=@fqty from #MyMrpResultTemp t1 where fneeddate=@fneeddate and fitemid=@fitemid

		set @fentryminid=@fentryminid+1

--		FETCH NEXT FROM SeorderEntry_Cursor 
--		INTO @fneeddate,@FRoughNeedQty,@FWillInStockQty
	end

	set @fminid=@fminid+1
--	CLOSE SeorderEntry_Cursor
--	DEALLOCATE SeorderEntry_Cursor
--
--    FETCH NEXT FROM Seorder_Cursor
--    INTO @fitemid,@FStockQty,@fentryid
END

--CLOSE Seorder_Cursor
--DEALLOCATE Seorder_Cursor

/*
update t1 set FModQty=FTempdNeedQty%fbatchappendqty from #MyMrpResultTemp t1 where fneedqty>0

update t1 set FActNeedQty=FTempdNeedQty+(fbatchappendqty-FModQty) 
from #MyMrpResultTemp t1 where fneedqty>0 and FModQty>0
*/

--保存结果--明细
--delete from my_t_MrpResultDetail where fhscount=@fhscount  --update my_t_MrpResultDetail set fremark=''

insert into my_t_MrpResultDetail(fneeddate,frunid,fitemid,FRoughNeedQty,FWillInStockQty,FCanUseStockQty,FNeedQty)
select '1900-01-01' fneeddate,@frunid,t1.fitemid,0,0,isnull(sum(t1.fqty),0) fqty,0
from My_t_MrpStock t1 where frunid=@frunid group by t1.fitemid
union all
select t1.fneeddate,@frunid,t1.fitemid,t1.FRoughNeedQty,t1.FWillInStockQty,t1.FCanUseStockQty,t1.FNeedQty 
--,t2.fbatchappendqty,t2.fqtymin,t2.fsecinvqty,
--(case when t1.FNeedQty<100 and t1.FNeedQty>0 and t1.fqtymin>=1000 then 100 else t1.FActNeedQty end) FActNeedQty,--非合理订货数
--(case when t1.FNeedQty<100 and t1.FNeedQty>0 and t1.fqtymin>=1000 then 100 else t1.FActNeedQty end) FQty
--FActNeedQty,FActNeedQty
from #MyMrpResultDetail t1 --where fneedqty>0 
inner join t_icitem t2 on t1.fitemid=t2.fitemid
inner join t_measureunit t3 on t2.funitid=t3.fitemid

--@fitemtype  100 全部 0 成品 1 半成品  2 常规物料 3 包材  --全部的时候要分开
if @fitemtype=100
begin
	declare @fsourcerunid int
	set @fsourcerunid=@frunid

	--半成品
	if exists (select 1 from My_t_MrpRoughNeedSource t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid 
	           where t1.frunid=@fsourcerunid and left(t2.fnumber,1) in (select fitemtype from v_MyItemType where ftype=1))  --3.  4. 前缀物料编码为半成品
	begin
		update t1 set ftrantype=1 from my_t_Mrp t1 where frunid=@fsourcerunid
	end	

	--常规物料
	if exists (select 1 from My_t_MrpRoughNeedSource t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid 
	           where t1.frunid=@fsourcerunid and left(t2.fnumber,1) not in (select fitemtype from v_MyItemType where ftype in(1,3)))
	begin
		exec My_p_GetBillNo 50000002,'my_t_mrp',@frunid output, @fbillno output

		insert into my_t_Mrp(ftrantype, fbillno, frunid, fuserid, fbilltime,fdate) 
		values(              2,         @fbillno,@frunid,@fuserid,getdate(),@fdate)

		insert into my_t_MrpSeOrder(frunid, forderinterid,fselect,ftype) 
		select            distinct  @frunid,forderinterid,fselect,ftype 
		from my_t_MrpSeOrder 
		where frunid=@fsourcerunid

		update t1 set frunid=@frunid
		from My_t_MrpRoughNeedSource t1 
		inner join t_icitem t2 on t1.fitemid=t2.fitemid 
		where t1.frunid=@fsourcerunid and (left(t2.fnumber,1) not in (select fitemtype from v_MyItemType where ftype in(1,3)))  

		update t1 set frunid=@frunid
		from My_t_MrpStock t1 
		inner join t_icitem t2 on t1.fitemid=t2.fitemid 
		where t1.frunid=@fsourcerunid and (left(t2.fnumber,1) not in (select fitemtype from v_MyItemType where ftype in(1,3)))  

		update t1 set frunid=@frunid
		from My_t_MrpWillInStock t1 
		inner join t_icitem t2 on t1.fitemid=t2.fitemid 
		where t1.frunid=@fsourcerunid and (left(t2.fnumber,1) not in (select fitemtype from v_MyItemType where ftype in(1,3)))  

		update t1 set frunid=@frunid
		from my_t_MrpResultSum t1 
		inner join t_icitem t2 on t1.fitemid=t2.fitemid 
		where t1.frunid=@fsourcerunid and (left(t2.fnumber,1) not in (select fitemtype from v_MyItemType where ftype in(1,3)))  

		update t1 set frunid=@frunid
		from my_t_MrpResultDetail t1 
		inner join t_icitem t2 on t1.fitemid=t2.fitemid 
		where t1.frunid=@fsourcerunid and (left(t2.fnumber,1) not in (select fitemtype from v_MyItemType where ftype in(1,3)))  
	end	

	--包材
	if exists (select 1 from My_t_MrpRoughNeedSource t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid where t1.frunid=@fsourcerunid and t2.fnumber like '2.%')  
	begin
		exec My_p_GetBillNo 50000002,'my_t_mrp',@frunid output, @fbillno output

		insert into my_t_Mrp(ftrantype, fbillno, frunid, fuserid, fbilltime,fdate) 
		values(              3,         @fbillno,@frunid,@fuserid,getdate(),@fdate)

		insert into my_t_MrpSeOrder(frunid, forderinterid,fselect,ftype) 
		select         distinct     @frunid,forderinterid,fselect,ftype 
		from my_t_MrpSeOrder 
		where frunid=@fsourcerunid

		update t1 set frunid=@frunid
		from My_t_MrpRoughNeedSource t1 
		inner join t_icitem t2 on t1.fitemid=t2.fitemid 
		where t1.frunid=@fsourcerunid and t2.fnumber like '2.%' 

		update t1 set frunid=@frunid
		from My_t_MrpStock t1 
		inner join t_icitem t2 on t1.fitemid=t2.fitemid 
		where t1.frunid=@fsourcerunid and t2.fnumber like '2.%' 

		update t1 set frunid=@frunid
		from My_t_MrpWillInStock t1 
		inner join t_icitem t2 on t1.fitemid=t2.fitemid 
		where t1.frunid=@fsourcerunid and t2.fnumber like '2.%' 

		update t1 set frunid=@frunid
		from my_t_MrpResultSum t1 
		inner join t_icitem t2 on t1.fitemid=t2.fitemid 
		where t1.frunid=@fsourcerunid and t2.fnumber like '2.%' 

		update t1 set frunid=@frunid
		from my_t_MrpResultDetail t1 
		inner join t_icitem t2 on t1.fitemid=t2.fitemid 
		where t1.frunid=@fsourcerunid and t2.fnumber like '2.%' 
	end	
end

--select * from my_t_MrpResultDetail

drop table #temp
drop table #source
drop table #data
drop table #MyMrpResultSum
drop table #MyMrpResultDetail
drop table #sourcedata

set nocount off

GO


--生产计划合并，即任务单合并--*****
--exec My_P_ScheduleMerge 16394
IF EXISTS (select * from sysobjects where name='My_P_ScheduleMerge' and xtype='p')  drop  procedure My_P_ScheduleMerge
go

create procedure [dbo].My_P_ScheduleMerge(@fuserid int) 

as
set nocount on

declare @s varchar(8000),@fplaninterid int,@fplanqty decimal(24,4),@fplandate datetime
declare @funitid int,@fdeptid int,@fitemid int,@fnumber varchar(20),@fplansumqty decimal(24,4),@FTheICMOInterID int
declare @fppbominterid int

select @s=''

--选中的任务单
select t8.fnumber,t5.finterid ficmointerid,min(t5.fqty) fmoqty,sum(t3.fqty) fqty/*选单数*/ --,t2.finterid fplaninterid,t2.fdate fplandate,t2.fqty fplanqty 
into #temp
from my_t_icmotemp t6
inner join icmo t5 on t6.finterid=t5.finterid
inner join ppbom t7 on t5.finterid=t7.ficmointerid
inner join ppbomentry t3 on t7.finterid=t3.finterid
inner join t_icitem t8 on t5.fitemid=t8.fitemid --父项
where t6.fuserid=@fuserid and isnull(t5.forderinterid,0)=0  --关联订单的任务单不合并
group by t8.fnumber,t5.finterid

if exists(select fnumber from (select fnumber,ficmointerid from #temp where fqty>0) t1 group by fnumber having count(1)>1)
begin
	select @s=@s+','+m1.fnumber from
	(
		select fnumber from (select fnumber,ficmointerid from #temp where fqty>0) t1 group by fnumber having count(1)>1
	) m1

	set @s='['+@s+']每个产品最多只能有一个任务单已经发料!'  ----
	RAISERROR(@s,18,18)
end

DECLARE Seorder_Cursor CURSOR FOR
select distinct fnumber from #temp

OPEN Seorder_Cursor

FETCH NEXT FROM Seorder_Cursor 
INTO @fnumber

WHILE @@FETCH_STATUS = 0
BEGIN
	select @fplansumqty=0,@FTheICMOInterID=0

	if exists(select 1 from #temp where fqty>0 and fnumber=@fnumber)--如果该产品有已经开始领料的任务单，则其余的任务单都合并到这个任务单上去
	begin
		select @FTheICMOInterID=ficmointerid from #temp where fqty>0 and fnumber=@fnumber
	end
	else
	begin  --没有就找第一个任务单作为合并源
		select top 1 @FTheICMOInterID=ficmointerid from #temp where fnumber=@fnumber order by ficmointerid
	end

	DECLARE SeorderEntry_Cursor CURSOR FOR
	select t2.finterid fplaninterid,t2.fqty fplanqty,t2.fdate fplandate,t8.funitid,t2.fdeptid,t2.fitemid
	from My_t_ScheduleDetail t2
	inner join my_t_icmotemp t6 on t2.ficmointerid=t6.finterid
	inner join icmo t5 on t2.ficmointerid=t5.finterid
	inner join t_icitem t8 on t5.fitemid=t8.fitemid --父项
	where t6.fuserid=@fuserid and t8.fnumber=@fnumber and t5.finterid<>@FTheICMOInterID

	OPEN SeorderEntry_Cursor

	FETCH NEXT FROM SeorderEntry_Cursor 
	INTO @fplaninterid,@fplanqty,@fplandate,@funitid,@fdeptid,@fitemid

	WHILE @@FETCH_STATUS = 0
	BEGIN
		set @fplansumqty=@fplansumqty+@fplanqty

		if exists(select 1 from My_t_ScheduleDetail t2 inner join icmo t5 on t2.ficmointerid=t5.finterid where t5.finterid=@FTheICMOInterID and t2.fdate=@fplandate)
		begin
			update t2 set t2.fqty=t2.fqty+@fplanqty
			from My_t_ScheduleDetail t2 
			inner join icmo t5 on t2.ficmointerid=t5.finterid 
			where t5.finterid=@FTheICMOInterID and t2.fdate=@fplandate  --任务单+计划完工日期 唯一索引
		end
		else
		begin
			insert into my_t_scheduledetail (fbillerid, fsourcetrantype, ficmointerid,     funitid, fitemid, fdeptid, fdate,     fqty,     fnote)
									  values(@fuserid,  85,              @FTheICMOInterID, @funitid,@fitemid,@fdeptid,@fplandate,@fplanqty,'')
		end

		delete from my_t_scheduledetail where finterid=@fplaninterid

		FETCH NEXT FROM SeorderEntry_Cursor
		INTO @fplaninterid,@fplanqty,@fplandate,@funitid,@fdeptid,@fitemid
	END

	CLOSE SeorderEntry_Cursor
	DEALLOCATE SeorderEntry_Cursor

	--更新合并源任务单的数量
	update t5 set fqty=t2.fmoqty,fauxqty=t2.fmoqty,finlowlimitqty=t2.fmoqty,fauxinlowlimitqty=t2.fmoqty
	from (select sum(t2.fmoqty) fmoqty from #temp t2 where fnumber=@fnumber) t2
	inner join icmo t5 on 1=1
	where t5.finterid=@FTheICMOInterID

	update t5 set fstatus=0 --非合并源的任务单
	from #temp t2
	inner join icmo t5 on t2.ficmointerid=t5.finterid
	where t2.fnumber=@fnumber and t5.finterid<>@FTheICMOInterID

	delete t5  --删掉非合并源的任务单
	from #temp t2
	inner join icmo t5 on t2.ficmointerid=t5.finterid
	where t2.fnumber=@fnumber and t5.finterid<>@FTheICMOInterID

	--更新合并源任务单关联的投料单应发数
--	if @fplansumqty>0
--	begin
		update t3 set fqtymust=t3.fqtymust+isnull(t1.fmoqty,0)*t3.fauxqtyscrap*(1+t3.fscrap/100)
		from icmo t5 
		inner join ppbom t2 on t5.finterid=t2.ficmointerid
		inner join ppbomentry t3 on t2.finterid=t3.finterid
		inner join (select sum(t2.fmoqty) fmoqty from #temp t2 where fnumber=@fnumber and ficmointerid<>@FTheICMOInterID) t1 on 1=1
		where t5.finterid=@FTheICMOInterID
--	end

	select @fppbominterid=finterid from ppbom where ficmointerid=@FTheICMOInterID
	EXEC prc_SHUpdateBillDoubleQty 88,@fppbominterid

    FETCH NEXT FROM Seorder_Cursor
    INTO @fnumber
END

CLOSE Seorder_Cursor
DEALLOCATE Seorder_Cursor

go


--库存状态表--*****
IF not EXISTS (select * from sysobjects where name='My_t_RepAlsStockStatus' and xtype='u')  --drop  Table My_t_RepAlsStockStatus
begin
	create table My_t_RepAlsStockStatus(frunid int,fitemid int,finvqty decimal(24,4) default 0,fwillinqty decimal(24,4) default 0,
	                                    fwilloutqty decimal(24,4) default 0,fendqty decimal(24,4) default 0,
	                                    fremainqty decimal(24,4) default 0)
end

go

--替换表--*****
IF not EXISTS (select * from sysobjects where name='My_t_RepAlsItemReplace' and xtype='u')  --drop  Table My_t_RepAlsItemReplace
begin
	create table My_t_RepAlsItemReplace(frunid int,fproductid int,fitemid int,frepitemid int,forder int) --1 外购  3 委外
end

go

        
--结果--*****
IF not EXISTS (select * from sysobjects where name='My_t_RepAlsRoughNeedSource' and xtype='u')  --drop  Table My_t_RepAlsRoughNeedSource
begin
	create table My_t_RepAlsRoughNeedSource(findex int identity(1,1),fisselect bit default 0, frunid int,ftrantype int,
	finterid int,fentryid int,fitemid int,fistop bit default 0,fproductid int,ficmointerid int,fcostobjid int,folditemid int,
	fqtymust decimal(24,2)/*应发数*/,fstockqty decimal(24,2)/*已领数*/,fisreplace bit default 0,fisnew bit default 0,fisexecute bit default 0,
	fqty decimal(24,2)/*未发数*/,frepitemid int default 0/*替换物料*/,frepqty decimal(24,2) default 0/*替换数量*/,
	fwillinqty decimal(24,2) default 0,finvqty decimal(24,2) default 0,fcanuseqty decimal(24,2) default 0/*预计可用库存*/,
	fassignqty decimal(24,2) default 0/*分配数*/,fremainqty decimal(24,2) default 0/*剩余可用库存数*/,frepremainqty decimal(24,2) default 0/*替换物料剩余可用库存数*/,
	foweqty decimal(24,2) default 0/*欠数*/,fneeddate datetime)  --
end

go
     

--预计入库--*****
IF not EXISTS (select * from sysobjects where name='My_t_RepAlsWillInStock' and xtype='u')  --drop  Table My_t_RepAlsWillInStock
begin
	create table My_t_RepAlsWillInStock(fdate datetime,frunid int,ftrantype int,finterid int ,fentryid int,fitemid int,fqty decimal(24,2)) --1 外购  3 委外
end

go

--预计出库--*****
IF not EXISTS (select * from sysobjects where name='My_t_RepAlsWillOutStock' and xtype='u')  --drop  Table My_t_RepAlsWillOutStock
begin
	create table My_t_RepAlsWillOutStock(fdate datetime,frunid int,ftrantype int,finterid int ,fentryid int,ficmointerid int,
	fitemid int,fqtymust decimal(24,2),fstockqty decimal(24,2),fqty decimal(24,2)) --1 外购  3 委外
end

go

           
--库存--*****
IF not EXISTS (select * from sysobjects where name='My_t_RepAlsStock' and xtype='u')  --drop  Table My_t_RepAlsStock
begin
	create table My_t_RepAlsStock(frunid int,fstockid int,fitemid int,fqty decimal(24,2),fbatchno varchar(50)) 
end

go


--计算信息--*****
IF not EXISTS (select * from sysobjects where name='My_t_RepAls' and xtype='u')  --drop  Table My_t_RepAls
begin
	create table My_t_RepAls(
	ftrantype int ,
	frunid int,
	fstatus int,
	fbilltime datetime,
	fbillno varchar(20),
	fuserid int,
	fcheckerid int,
	fcheckdate datetime,
	fchecktime datetime,
	fdate datetime,
	fempid int,
	fdeptid int,ftype int default 40043,--40043 常规物料 40044 包材物料
	)
end

go


----*****
IF not EXISTS (select * from sysobjects where name='My_t_RepAlsTemp' and xtype='u')  --drop  Table My_t_RepAlsTemp
begin
	create table My_t_RepAlsTemp(
	fuserid int,
	frunid int,
	findex int
	)
end

go


IF EXISTS (select * from sysobjects where name='my_v_RepAlsReplace' and xtype='v')  drop  view my_v_RepAlsReplace

go

create view my_v_RepAlsReplace 
as

select t1.frunid 计算编号,t3.fnumber 产品编码,t3.fname 产品名称,t3.fmodel 产品规格型号, 
        t5.fnumber 物料编码,t5.fname 物料名称,t5.fmodel 物料规格型号,
        t23.fnumber 替换物料编码,t23.fname 替换物料名称,t23.fmodel 替换物料规格型号,t1.forder 优先次序
        from My_t_RepAlsItemReplace t1 
        inner join t_icitem t3 on t1.fproductid=t3.fitemid  
        inner join t_icitem t5 on t5.fitemid=t1.fitemid  
        inner join t_icitem t23 on t23.fitemid=t1.frepitemid
        inner join t_measureunit t6 on t5.funitid=t6.fitemid  
        left join t_SubMessage t13 on t13.finterid=t5.F_114 and t13.ftypeid=10003  
        left join t_SubMessage t14 on t14.finterid=t5.ftypeid and t14.ftypeid=504  
        left join t_SubMessage t17 on t17.finterid=t5.F_115 and t17.ftypeid=10002 
go       


IF EXISTS (select * from sysobjects where name='my_v_RepAlsResult' and xtype='v')  drop  view my_v_RepAlsResult

go

create view my_v_RepAlsResult 
as

select t1.fisselect 选择,t1.frunid 计算编号,t1.findex 序号,t22.fbillno 任务单编号,t1.ficmointerid 任务单内码,
	t3.fnumber 产品编码,t3.fname 产品名称,t3.fmodel 产品规格型号,t1.finterid 投料单内码,t1.fentryid 投料单分录号, 
        t5.fnumber 物料编码,t5.fname 物料名称,t5.fmodel 物料规格型号,t6.fname 单位,
        t1.fqtymust 应发数,0 关联数,t1.fstockqty 已发数,t1.fqty 未发量,
        t1.fwillinqty 预计入库,t1.finvqty 库存,t1.fcanuseqty 预计可用库存,
        t1.fassignqty 分配数,t1.fremainqty 剩余可用库存,t1.foweqty 欠数,
        isnull(t23.fnumber,'') 替换物料编码,isnull(t23.fname,'') 替换物料名称,isnull(t23.fmodel,'') 替换物料规格型号,t1.frepremainqty 替换物料可用库存数,t1.frepqty 替换数量,
	(case when t1.fisexecute=1 then 'Y' else '' end) 是否已执行,
        t13.fname 仓管员,t14.fname 物料类别,t17.fname 倒冲,--(case when t1.fisnew=1 then 'Y' else '' end) 是否新增,
	isnull(t8.fnumber,'')+'///'+isnull(t8.fname,'')+'///'+isnull(t8.fmodel,'') 备注  
        from My_t_RepAlsRoughNeedSource t1
--         inner join ppbomentry t20 on t20.finterid=t1.finterid and t20.fentryid=t1.fentryid  --没有意义，因为投料单可能已经变了
--         inner join ppbom t21 on t20.finterid=t21.finterid
        inner join icmo t22 on t1.ficmointerid=t22.finterid
        left join seorderentry t2 on t22.forderinterid=t2.finterid and t22.fsourceentryid=t2.fentryid  
        left join seorder t4 on t4.finterid=t2.finterid  
        inner join t_icitem t3 on t3.fitemid=t22.fitemid  
        inner join t_icitem t5 on t5.fitemid=t1.fitemid  
        left join t_icitem t23 on t23.fitemid=t1.frepitemid
        inner join t_measureunit t6 on t5.funitid=t6.fitemid  
        left join t_SubMessage t13 on t13.finterid=t5.F_114 and t13.ftypeid=10003  
        left join t_SubMessage t14 on t14.finterid=t5.ftypeid and t14.ftypeid=504  
        left join t_SubMessage t17 on t17.finterid=t5.F_115 and t17.ftypeid=10002 
 	left join t_icitem t8 on t8.fitemid=t1.folditemid  --
go            
       

--*****
IF EXISTS (select * from sysobjects where name='my_v_RepAlsInfo' and xtype='v')  drop  view my_v_RepAlsInfo

go

create view my_v_RepAlsInfo 
as

select --fbillno 计算编号,--暂不使用,直接用内码作为计算编号
t1.frunid 计算编号,t1.fdate 计算日期,t1.fbilltime 计算时间,t2.fname 计算用户,'替代分析' 计算类型,
(case when isnull(t1.fstatus,0)=0 then '' else 'Y' end) 审核,isnull(t3.fname,'') 审核人,isnull(t1.fcheckdate,Null) 审核日期
from My_t_RepAls t1 
inner join t_user t2 on t1.fuserid=t2.fuserid
left join t_user t3 on t1.fcheckerid=t3.fuserid and t3.fuserid<>0

go

IF EXISTS (select * from sysobjects where name='my_v_RepAlsWillOutStock' and xtype='v')  drop  view my_v_RepAlsWillOutStock

go

create view my_v_RepAlsWillOutStock 
as

select t1.frunid 计算编号,t22.fbillno 任务单编号,t3.fnumber 产品编码,t3.fname 产品名称,t3.fmodel 产品规格型号, 
        t5.fnumber 物料编码,t5.fname 物料名称,t5.fmodel 物料规格型号,t6.fname 单位,t1.fqtymust 应发数,
        t1.fstockqty 已发数,t1.fqty 数量,t13.fname 仓管员,t14.fname 物料类别,t17.fname 倒冲,'' 备注  
        from My_t_RepAlsWillOutStock t1
--         inner join ppbomentry t20 on t20.finterid=t1.finterid and t20.fentryid=t1.fentryid --没有意义，因为投料单可能已经变了
--         inner join ppbom t21 on t20.finterid=t21.finterid
        inner join icmo t22 on t1.ficmointerid=t22.finterid
        left join seorderentry t2 on t22.forderinterid=t2.finterid and t22.fsourceentryid=t2.fentryid  
        left join seorder t4 on t4.finterid=t2.finterid  
        inner join t_icitem t3 on t3.fitemid=t22.fitemid  
        inner join t_icitem t5 on t5.fitemid=t1.fitemid  
        inner join t_measureunit t6 on t5.funitid=t6.fitemid  
        left join t_SubMessage t13 on t13.finterid=t5.F_114 and t13.ftypeid=10003  
        left join t_SubMessage t14 on t14.finterid=t5.ftypeid and t14.ftypeid=504  
        left join t_SubMessage t17 on t17.finterid=t5.F_115 and t17.ftypeid=10002 

go
            
--*****

IF EXISTS (select * from sysobjects where name='my_v_RepAlsWillInStock ' and xtype='v')  drop  view my_v_RepAlsWillInStock

go

create view my_v_RepAlsWillInStock 
as

select t1.frunid 运算编号,'收料通知单' 单据类型,t1.fdate 日期,t2.fbillno 单据编号,t5.fnumber 厂商编号,t5.FShortName 厂商名称,  
t4.fnumber 物料编码,t4.fname 名称,t4.fmodel 规格型号,t6.fname 单位,t1.fqty 数量,isnull(t13.fname,'') 仓管员,isnull(t14.fname,'') 物料类别,isnull(t17.fname,'') 倒冲  
from My_t_RepAlsWillInStock t1  
inner join poinstock t2 on t1.ftrantype=72 and t1.finterid=t2.finterid  
inner join t_supplier t5 on t5.fitemid=t2.fsupplyid  
inner join t_icitem t4 on t4.fitemid=t1.fitemid  
inner join t_measureunit t6 on t4.funitid=t6.fitemid  
left join t_SubMessage t13 on t13.finterid=t4.F_114 and t13.ftypeid=10003  
left join t_SubMessage t14 on t14.finterid=t4.ftypeid and t14.ftypeid=504  
left join t_SubMessage t17 on t17.finterid=t4.F_115 and t17.ftypeid=10002  
union all 
select t1.frunid 运算编号,'采购订单' 单据类型,t1.fdate 日期,t2.fbillno 单据编号,t5.fnumber 厂商编号,t5.FShortName 厂商名称,  
t4.fnumber 物料编码,t4.fname 名称,t4.fmodel 规格型号,t6.fname 单位,t1.fqty 数量,isnull(t13.fname,'') 仓管员,isnull(t14.fname,'') 物料类别,isnull(t17.fname,'') 倒冲
from My_t_RepAlsWillInStock t1  
inner join poorder t2 on t1.ftrantype=71 and t1.finterid=t2.finterid  
inner join t_supplier t5 on t5.fitemid=t2.fsupplyid  
inner join t_icitem t4 on t4.fitemid=t1.fitemid  
inner join t_measureunit t6 on t4.funitid=t6.fitemid  
left join t_SubMessage t13 on t13.finterid=t4.F_114 and t13.ftypeid=10003  
left join t_SubMessage t14 on t14.finterid=t4.ftypeid and t14.ftypeid=504  
left join t_SubMessage t17 on t17.finterid=t4.F_115 and t17.ftypeid=10002 
union all 
select t1.frunid 运算编号,'采购申请单' 单据类型,t1.fdate 日期,t2.fbillno 单据编号,'' 厂商编号,'' 厂商名称,  
t4.fnumber 物料编码,t4.fname 名称,t4.fmodel 规格型号,t6.fname 单位,t1.fqty 数量,isnull(t13.fname,'') 仓管员,isnull(t14.fname,'') 物料类别,isnull(t17.fname,'') 倒冲
from My_t_RepAlsWillInStock t1  
inner join porequest t2 on t1.ftrantype=70 and t1.finterid=t2.finterid  
inner join t_icitem t4 on t4.fitemid=t1.fitemid  
inner join t_measureunit t6 on t4.funitid=t6.fitemid  
left join t_SubMessage t13 on t13.finterid=t4.F_114 and t13.ftypeid=10003  
left join t_SubMessage t14 on t14.finterid=t4.ftypeid and t14.ftypeid=504  
left join t_SubMessage t17 on t17.finterid=t4.F_115 and t17.ftypeid=10002   
union all 
select t1.frunid 运算编号,'生产任务单' 单据类型,t1.fdate 日期,t2.fbillno 单据编号,t5.fnumber 厂商编号,t5.FName 厂商名称,  
t4.fnumber 物料编码,t4.fname 名称,t4.fmodel 规格型号,t6.fname 单位,t1.fqty 数量,isnull(t13.fname,'') 仓管员,isnull(t14.fname,'') 物料类别,isnull(t17.fname,'') 倒冲
from My_t_RepAlsWillInStock t1  
inner join icmo t2 on t1.ftrantype=85 and t1.finterid=t2.finterid  
inner join t_icitem t4 on t4.fitemid=t1.fitemid  
inner join t_department t5 on t5.fitemid=t2.fworkshop  
inner join t_measureunit t6 on t4.funitid=t6.fitemid  
left join t_SubMessage t13 on t13.finterid=t4.F_114 and t13.ftypeid=10003  
left join t_SubMessage t14 on t14.finterid=t4.ftypeid and t14.ftypeid=504  
left join t_SubMessage t17 on t17.finterid=t4.F_115 and t17.ftypeid=10002 
union all 
select t1.frunid 运算编号,'外购入库单' 单据类型,t1.fdate 日期,t2.fbillno 单据编号,t5.fnumber 厂商编号,t5.FShortName 厂商名称,  
t4.fnumber 物料编码,t4.fname 名称,t4.fmodel 规格型号,t6.fname 单位,t1.fqty 数量,isnull(t13.fname,'') 仓管员,isnull(t14.fname,'') 物料类别,isnull(t17.fname,'') 倒冲
from My_t_RepAlsWillInStock t1  
inner join icstockbill t2 on t1.ftrantype=1 and t1.finterid=t2.finterid  
inner join t_icitem t4 on t4.fitemid=t1.fitemid  
inner join t_supplier t5 on t5.fitemid=t2.fsupplyid  
inner join t_measureunit t6 on t4.funitid=t6.fitemid  
left join t_SubMessage t13 on t13.finterid=t4.F_114 and t13.ftypeid=10003  
left join t_SubMessage t14 on t14.finterid=t4.ftypeid and t14.ftypeid=504  
left join t_SubMessage t17 on t17.finterid=t4.F_115 and t17.ftypeid=10002   
union all 
select t1.frunid 运算编号,'塑胶子件收料申请单' 单据类型,t1.fdate 日期,t2.fbillno 单据编号,t5.fnumber 厂商编号,t5.FShortName 厂商名称,  
t4.fnumber 物料编码,t4.fname 名称,t4.fmodel 规格型号,t6.fname 单位,t1.fqty 数量,isnull(t13.fname,'') 仓管员,isnull(t14.fname,'') 物料类别,isnull(t17.fname,'') 倒冲
from My_t_RepAlsWillInStock t1  
inner join t_BosPlasticPoInStock t2 on t1.ftrantype=200000022 and t1.finterid=t2.fid  
inner join t_icitem t4 on t4.fitemid=t1.fitemid  
inner join t_supplier t5 on t5.fitemid=t2.fsupplyid  
inner join t_measureunit t6 on t4.funitid=t6.fitemid  
left join t_SubMessage t13 on t13.finterid=t4.F_114 and t13.ftypeid=10003  
left join t_SubMessage t14 on t14.finterid=t4.ftypeid and t14.ftypeid=504  
left join t_SubMessage t17 on t17.finterid=t4.F_115 and t17.ftypeid=10002 

go

--物料代替分析----My_p_RepAls 16394,0,'',0   --select * from My_t_RepAls

IF EXISTS (select * from sysobjects where name='My_p_RepAls' and xtype='p')  drop  procedure My_p_RepAls

go

--@fitemtype  100 全部 0 成品 1 半成品  2 常规物料 3 包材  @ftype 0 常规运算 1 按单运算
create procedure [dbo].My_p_RepAls (@fuserid int,@frunid int,@fbillno varchar(20),@fitemtype int)  --,@ftype int
 
as
set nocount on

--1 该物料有未发数
--2 该物料的可用库存不够发
--3 该物料有可代替其的物料
--4 可代替其的物料扣除掉自己所需库存外,还有剩余的库存	

--------------------------------------------------------------------------------------------------------------------------------------------------
--表一   物料替换表
--------------------------------------------------------------------------------------------------------------------------------------------------
--产品     物料     替换物料          替换物料库存
--------------------------------------------------------------------------------------------------------------------------------------------------
--300107   001446   000001           90
--------------------------------------------------------------------------------------------------------------------------------------------------
--300107   001446   000002           100
--------------------------------------------------------------------------------------------------------------------------------------------------

--表二 投料单 --
--------------------------------------------------------------------------------------------------------------------------------------------------
--行号 产品     物料      应发数 已发数 未发数    预计入库   库存  预计可用库存     备注
--------------------------------------------------------------------------------------------------------------------------------------------------
--1    300339   001446   80     0     80        100       60    160              --300339+001446虽然没有物料替换组合，但仍然要取出，因为它自己有未发数，要先分配完
--------------------------------------------------------------------------------------------------------------------------------------------------
--2    300107   001446   120    0     120                                        
--------------------------------------------------------------------------------------------------------------------------------------------------
--3    300107   001446   60     0     60                                         
--------------------------------------------------------------------------------------------------------------------------------------------------
--4    300107   001446   100     0    100                                         
--------------------------------------------------------------------------------------------------------------------------------------------------

--表三 投料单 先用现有库存进行分配 --按物料进行排序循环 --update icmo set fbillno='WORK045030-1' where fbillno='WORK045031'
--------------------------------------------------------------------------------------------------------------------------------------------------
--行号 产品    物料      应发数 已发数 未发数   预计入库   库存  预计可用库存     分配到的数        欠数    库存剩余    备注
--------------------------------------------------------------------------------------------------------------------------------------------------
--1    300339  001446   80     0     80       100       60    160             80               0       80 
--------------------------------------------------------------------------------------------------------------------------------------------------
--2    300107  001446   120    0     120                                      80               40      0
--------------------------------------------------------------------------------------------------------------------------------------------------
--3    300107  001446   60     0     60                                       0                60      0  
--------------------------------------------------------------------------------------------------------------------------------------------------
--4    300107  001446   100     0    100                                      0                100     0  
--------------------------------------------------------------------------------------------------------------------------------------------------


--表四 有欠数的取出来，进行循环--有替换的则不再进行替换  --要有个表，动态记录替换物料的剩余库存数--【一条分录只替换一次】
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
--行号 源行号 产品     物料     应发数  已发数 未发数   预计入库   库存  预计可用库存      分配到的数     库存剩余   欠数   替换物料    替换物料可用库存    替换数量  替换物料剩余库存 是否执行替换  是否已执行 备注
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
--1    1     300339   001446   80     0      80      100        60    160              80            80        0 
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------     
--2    2     300107   001446   120    0      120                                       80            0         40     000001      90                 40       50              Y
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
--3    3     300107   001446   60     0      60                                        0             0         60     000001                         50       0               Y
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
--4    4     300107   001446   100    0      100                                       0             0         100    000002      100                100      0               Y
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------




--暂不处理-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
--4    3     300107   001446   10     0      10                                        0             0         10     000002      100                10       90              Y                       应发数=未发数=欠数=上一行欠数-上一行替换数;其他=0
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------------------------------------------
--表五  用户勾选要执行替换的数据，系统对投料单进行维护，有替换物料的才可以选择
--------------------------------------------------------------------------------------------------------------------------------------------------------------
--行号 源行号  产品     物料     原应发数 原已发数  原未发数  替换数量   应发数 已发数  未发数  原物料   操作  备注
--------------------------------------------------------------------------------------------------------------------------------------------------------------
--1    1      300339   001446   80      0         80         
--------------------------------------------------------------------------------------------------------------------------------------------------------------            
--2    2      300107   001446   120     0         120      40         80    0       80              UP    未发数>替换数 & 替换数>0;应发数=原应发数-替换数       
--------------------------------------------------------------------------------------------------------------------------------------------------------------                     
--3    2      300107   000001                                         40    0       40      001446  IN    未发数>替换数 & 替换数>0;应发数=替换数               
--------------------------------------------------------------------------------------------------------------------------------------------------------------                                        
--4    3      300107   001446   60      0         60       50         10    0       10              UP    未发数>替换数 & 替换数>0;应发数=原应发数-替换数                                      
--------------------------------------------------------------------------------------------------------------------------------------------------------------
--5    3      300107   000001                                         50    0       50      001446  IN    未发数>替换数 & 替换数>0;应发数=替换数   
--------------------------------------------------------------------------------------------------------------------------------------------------------------
--6    4      300107   000002   100     0         100      100        100   0       100     001446  UP    未发数=替换数 & 替换数>0;应发数=原应发数   
--------------------------------------------------------------------------------------------------------------------------------------------------------------

if @frunid=0
	exec My_p_GetBillNo 50000011,'My_t_RepAls',@frunid output, @fbillno output
	
declare @fdate datetime
select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期

--保存运算信息
if not exists(select 1 from My_t_RepAls where frunid=@frunid)
begin
	insert into My_t_RepAls(ftrantype, fbillno, frunid, fuserid, fbilltime,fdate) 
	values(                 @fitemtype,@fbillno,@frunid,@fuserid,getdate(),@fdate)
end


--数据源--先满足1,3条件;后面再对此数据进行处理以满足2,4条件;-------------------
insert into My_t_RepAlsRoughNeedSource(folditemid,   fcostobjid,   ficmointerid,fproductid,fneeddate,         ftrantype,frunid, finterid,   fentryid,   fitemid,   fqtymust,   fstockqty,   fqty)
select                                 t3.folditemid,t5.fcostobjid,t5.finterid, t5.fitemid,t5.fplancommitdate,88,       @frunid,t3.finterid,t3.fentryid,t3.fitemid,t3.fqtymust,t3.fstockqty,(t3.fqtymust-t3.fstockqty)
from icmo t5 
inner join ppbom t2 on t5.finterid=t2.ficmointerid
inner join ppbomentry t3 on t2.finterid=t3.finterid
inner join t_icitem t4 on t3.fitemid=t4.fitemid --子项
inner join t_icitem t8 on t5.fitemid=t8.fitemid --父项
where t5.fstatus in (1,2,5) and (t3.fqtymust-t3.fstockqty)>0 
and exists(select 1 from t_subsitem where fitemid=t3.fitemid)  --这里先不要加产品匹配条件
--and t4.fnumber not like '1.02%'
--and exists(select 1 from t_BOSICItemReplaceEntry where fitemid=t3.fitemid)
--and exists(select 1 from t_BOSICItemReplaceEntry where fproductid=t5.fitemid and fitemid=t3.fitemid)
--and (t3.fitemid in (select fitemid from #replace) or t2.fitemid in (select FRepItemId from #replace))
order by t3.fitemid,t5.fbillno

--create table #replace(fproductid int,fitemid int,fstockqty decimal(24,4) default 0,fwillinqty decimal(24,4) default 0,fwilloutqty decimal(24,4) default 0,fendqty decimal(24,4) default 0,
--frepitemid int,frepstockqty decimal(24,4) default 0,frepwillinqty decimal(24,4) default 0,frepwilloutqty decimal(24,4) default 0,frependqty decimal(24,4) default 0,forder int)

--insert into #replace(fproductid,fitemid,FRepItemId,forder)
--select distinct t2.fproductid,t2.fitemid,t2.FRepItemId,t2.FOrder
--from My_t_RepAlsRoughNeedSource t1
--inner join t_BOSICItemReplaceEntry t2 on t1.fproductid=t2.fproductid and t1.fitemid=t2.fitemid

--数据源涉及到的替换关系表
insert into My_t_RepAlsItemReplace(frunid, fproductid,   fitemid,   FRepItemId,    forder)
select        distinct             @frunid,t1.fproductid,t2.fitemid,t2.FSubsItemID,t2.FOrder
from My_t_RepAlsRoughNeedSource t1
inner join t_subsitem t2 on t1.fproductid=t2.FapplicableItem and t1.fitemid=t2.fitemid
--inner join t_BOSICItemReplaceEntry t2 on t1.fproductid=t2.fproductid and t1.fitemid=t2.fitemid
where t1.frunid=@frunid

--物料和替换物料的库存状态
insert into My_t_RepAlsStockStatus(frunid,fitemid) 
select distinct @frunid,t1.fitemid
from
(
	select distinct fitemid from My_t_RepAlsItemReplace where frunid=@frunid
	union all
	select distinct FRepItemId from My_t_RepAlsItemReplace where frunid=@frunid
) t1


--预计出库
--create table #willout(fitemid int,fqty decimal(24,4))

--insert into #willout(fitemid,fqty)
--select t3.fitemid,(t3.fqtymust-t3.fstockqty) fqty

----预计出库--随单出货外购件
--insert into #willout(fitemid,fqty)
--select t4.fitemid,t4.fqty-isnull(t4.fstockqty,0)
--from seorderentry t4 
--inner join seorder t5  on t5.finterid=t4.finterid
--inner join t_icitem t8 on t8.fitemid=t4.fitemid
--where t8.ferpclsid=1 and t4.fmrpclosed<>1 and (t5.fstatus>0 or isnull(t5.FMultiCheckLevel1,0)>0) 
--and (t4.fitemid in (select fitemid from #replace) or t2.fitemid in (select FRepItemId from #replace))

--My_t_RepAlsRoughNeedSource和My_t_RepAlsWillOutStock的数据意义是不一样的，这里只是计算涉及到的物料和替换物料的所有未出库数
insert into My_t_RepAlsWillOutStock(ficmointerid,fdate,             ftrantype,frunid, finterid,   fentryid,   fitemid,   fqtymust,   fstockqty,    fqty)
select                              t5.finterid, t5.fplancommitdate,88,       @frunid,t3.finterid,t3.fentryid,t3.fitemid,t3.fqtymust,t3.fstockqty,(t3.fqtymust-t3.fstockqty)
from icmo t5 
inner join ppbom t2 on t5.finterid=t2.ficmointerid
inner join ppbomentry t3 on t2.finterid=t3.finterid
inner join t_icitem t4 on t3.fitemid=t4.fitemid --子项
inner join t_icitem t8 on t5.fitemid=t8.fitemid --父项
where t5.fstatus in (1,2,5) and (t3.fqtymust-t3.fstockqty)>0 
and t3.fitemid in (select fitemid from My_t_RepAlsStockStatus where frunid=@frunid)


--预计入库
--create table #willin(fitemid int,fqty decimal(24,4))

----预计入库--(采购申请单--未关闭--未关联数)--逻辑检查未关闭则中断MRP运算，因为采购申请单的到货日期是未确认的--此处开放为订单模拟时候用
--insert into #willin(fitemid,fqty)
--select t2.fitemid,t2.fqty-t2.fcommitqty

insert into My_t_RepAlsWillInStock(fdate,        frunid, ftrantype,finterid,   fentryid,   fitemid,   fqty)
select                             t2.FFetchTime,@frunid,70,       t2.finterid,t2.fentryid,t2.fitemid,t2.fqty-t2.fcommitqty
from porequest t1
inner join porequestentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where --t1.fstatus>0 and 
t1.fstatus<>3 and isnull(t2.fmrpclosed,0)<>1
--and t4.fnumber not like '08.11.%'
and t3.ferpclsid in (1)
--and (t3.fnumber like 'H.%' or t3.fnumber like 'K.%' or t3.fnumber like 'M.%' or t3.fnumber like 'N.%')
and (t2.fqty-t2.fcommitqty)>0 
and t2.fitemid in (select fitemid from My_t_RepAlsStockStatus where frunid=@frunid)

--预计入库(未审核的外购入库单)
--insert into #willin(fitemid,fqty)
--select t2.fitemid,t2.fqty  --

insert into My_t_RepAlsWillInStock(fdate,   frunid, ftrantype,finterid,   fentryid,   fitemid,   fqty)
select                             t1.fdate,@frunid,1,        t2.finterid,t2.fentryid,t2.fitemid,t2.fqty
from icstockbill t1
inner join icstockbillentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where t1.fstatus=0 and t2.FSourceTranType=72 
--and t4.fnumber not like '08.11.%'
and t2.fitemid in (select fitemid from My_t_RepAlsStockStatus where frunid=@frunid)

--预计入库(收料通知单--未关闭--未关联数)
--insert into #willin(fitemid,fqty)
--select t2.fitemid,t2.fqty-t2.fcommitqty-t2.fbackqty

insert into My_t_RepAlsWillInStock(fdate,   frunid,  ftrantype,  finterid,   fentryid,   fitemid,   fqty)
select                             t1.fdate,@frunid, 72,         t2.finterid,t2.fentryid,t2.fitemid,t2.fqty-t2.fcommitqty-t2.fbackqty
from poinstock t1
inner join poinstockentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where t1.fstatus<>3 --已经审核的才纳入????
and t2.fqty>(t2.fcommitqty+t2.fbackqty)
--and t4.fnumber not like '08.11.%'
and t2.fitemid in (select fitemid from My_t_RepAlsStockStatus where frunid=@frunid)

--预计入库(塑胶子件收料申请单--未关闭--未关联数)
--insert into #willin(fitemid,fqty)
--select t2.fitemid,t2.fqty-t2.fcommitqty

insert into My_t_RepAlsWillInStock(fdate,   frunid,  ftrantype,  finterid,fentryid,   fitemid,   fqty)
select                             t1.fdate,@frunid, 200000022,  t2.fid,  t2.fentryid,t2.fitemid,t2.fqty-t2.fcommitqty
from t_BOSPlasticPoInStock t1 
inner join t_BOSPlasticPoInStockEntry t2 on t1.fid=t2.fid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
--inner join t_department t4 on t1.fdeptid=t4.fitemid
inner join poorderentry t7 on t7.finterid=t2.fid_src and t7.fentryid=t2.fentryid_src 
where t7.FMrpClosed<>1 and isnull(t2.fmrpclosed,0)<>40019 --and t1.fstatus>0 
and (t2.fqty-t2.fcommitqty)>0
and t2.fitemid in (select fitemid from My_t_RepAlsStockStatus where frunid=@frunid)

--预计入库--生产任务单
--insert into #willin(fitemid,fqty)
--select t2.fitemid, t2.fqty-isnull(t2.fstockqty,0)

insert into My_t_RepAlsWillInStock(fdate,             frunid, ftrantype,finterid,   fentryid,   fitemid,   fqty)
select                             t2.fplancommitdate,@frunid,85,       t2.finterid,0,          t2.fitemid,t2.fqty-isnull(t2.fstockqty,0)
from icmo t2 
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t2.fworkshop=t4.fitemid
where t2.fstatus>0 and t2.fstatus<>3
and (t2.fqty-isnull(t2.fstockqty,0))>0
--and t4.fnumber not like '08.11.%'
and t2.fitemid in (select fitemid from My_t_RepAlsStockStatus where frunid=@frunid)

--库存
--create table #stock(fitemid int,fqty decimal(24,4))

--insert into #stock(fitemid,fqty)
--select t1.fitemid,t1.fqty

insert into My_t_RepAlsStock(frunid,fitemid,fstockid,fqty,fbatchno)
select @frunid,t1.fitemid,t1.fstockid,t1.fqty,t1.fbatchno
from icinventory t1
inner join t_ICItem t2 on t1.FItemID=t2.FItemID
inner join t_stock t3 on t3.fitemid=t1.fstockid
where --t2.ferpclsid in (1) and 
t1.fqty>0 --and t3.fname not like '%计划%' 
and t3.fname not like '%不良%' and t3.fname not like '%报废%'
--and t3.fnumber not like '11.%' 
--and (t2.fnumber like 'H.%' or t2.fnumber like 'K.%' or t2.fnumber like 'M.%' or t2.fnumber like 'N.%')
and t2.fitemid in (select fitemid from My_t_RepAlsStockStatus where frunid=@frunid)

--insert into #stock(fitemid,fqty)
--select t1.fitemid,t1.fqty

insert into My_t_RepAlsStock(frunid,fitemid,fstockid,fqty,fbatchno)
select @frunid,t1.fitemid,t1.fstockid,t1.fqty,t1.fbatchno
from poinventory t1
inner join t_ICItem t2 on t1.FItemID=t2.FItemID
inner join t_stock t3 on t3.fitemid=t1.fstockid
where --t2.ferpclsid in (1) and 
t1.fqty>0 --and t3.fname not like '%计划%' 
and t3.fname not like '%不良%' and t3.fname not like '%报废%' and t3.fitemid=16483  --代管仓
--and t3.fnumber not like '11.%' 
--and (t2.fnumber like 'H.%' or t2.fnumber like 'K.%' or t2.fnumber like 'M.%' or t2.fnumber like 'N.%')
and t2.fitemid in (select fitemid from My_t_RepAlsStockStatus where frunid=@frunid)

--预计出库
update t1 set fwilloutqty=t2.fqty
from My_t_RepAlsStockStatus t1
inner join (select fitemid,sum(fqty) fqty from My_t_RepAlsWillOutStock where frunid=@frunid group by fitemid) t2 on t1.fitemid=t2.fitemid
where t1.frunid=@frunid

--update t1 set frepwilloutqty=t2.fqty
--from #replace t1
--inner join (select fitemid,sum(fqty) fqty from My_t_RepAlsRoughNeedSource group by fitemid) t2 on t1.frepitemid=t2.fitemid

--预计入库
update t1 set fwillinqty=t2.fqty
from My_t_RepAlsStockStatus t1
inner join (select fitemid,sum(fqty) fqty from My_t_RepAlsWillInStock where frunid=@frunid group by fitemid) t2 on t1.fitemid=t2.fitemid
where t1.frunid=@frunid

--update t1 set frepwillinqty=t2.fqty
--from #replace t1
--inner join (select fitemid,sum(fqty) fqty from My_t_RepAlsWillInStock group by fitemid) t2 on t1.frepitemid=t2.fitemid

--库存
update t1 set finvqty=t2.fqty
from My_t_RepAlsStockStatus t1
inner join (select fitemid,sum(fqty) fqty from My_t_RepAlsStock where frunid=@frunid group by fitemid) t2 on t1.fitemid=t2.fitemid
where t1.frunid=@frunid

--update t1 set frepstockqty=t2.fqty
--from #replace t1
--inner join (select fitemid,sum(fqty) fqty from My_t_RepAlsStock group by fitemid) t2 on t1.frepitemid=t2.fitemid

--剩余预计可用库存
update t1 set fendqty=finvqty+fwillinqty-fwilloutqty from My_t_RepAlsStockStatus t1 where t1.frunid=@frunid
update t1 set fremainqty=fendqty from My_t_RepAlsStockStatus t1 where t1.frunid=@frunid

--update #replace set frepqty=frepstockqty+frepwillinqty-frepwilloutqty

--delete from #replace where fendqty>0 --剩余库存够用
--delete from #replace where frependqty<=0 --替换物料剩余库存不够用

delete t1
from My_t_RepAlsItemReplace t1
inner join My_t_RepAlsStockStatus t2 on t1.fitemid=t2.fitemid and t2.frunid=@frunid
where t1.frunid=@frunid and t2.fendqty>0 --该物料剩余库存够用则去除,即使该物料有未发数和可替换其的物料

delete t1
from My_t_RepAlsItemReplace t1
inner join My_t_RepAlsStockStatus t2 on t1.frepitemid=t2.fitemid and t2.frunid=@frunid
where t1.frunid=@frunid and t2.fendqty<=0 --替换物料剩余库存不够用则去除

--只关注替换关系成立的数据源
delete t1
from My_t_RepAlsRoughNeedSource t1
where t1.frunid=@frunid 
and not exists(select 1 from My_t_RepAlsItemReplace where frunid=@frunid and fitemid=t1.fitemid)
--and not exists(select 1 from My_t_RepAlsItemReplace where frunid=@frunid and fproductid=t1.fproductid and fitemid=t1.fitemid)

--select t1.fsourceinterid finterid,t1.fsourceentryid fentryid,t1.fproductid,t1.fitemid,t1.fqty
--into #sourcedata 
--from My_t_RepAlsRoughNeedSource t1

--形成表二
update t1 set fwillinqty=t2.fwillinqty,finvqty=t2.finvqty,fcanuseqty=t2.fwillinqty+t2.finvqty,fistop=1
from My_t_RepAlsRoughNeedSource t1
inner join (select min(findex) findex from My_t_RepAlsRoughNeedSource where frunid=@frunid group by fitemid) t3 on t1.findex=t3.findex
inner join My_t_RepAlsStockStatus t2 on t1.fitemid=t2.fitemid and t2.frunid=@frunid
where t1.frunid=@frunid

--形成表三
--set @fentryid=0

declare @fminid int,@fmaxid int,@fentryminid int,@fentrymaxid int,@fpreitemid int,@fcanuseqty decimal(24,2)
declare @fproductid int,@fistop int,@fqty decimal(24,2) ,@fentryid int,@fitemid int, @fnewindex int
declare @frependqty decimal(24,2), @frepitemid decimal(24,2), @frepremainqty decimal(24,2), @foweqty decimal(24,2)
declare @finterid int, @findex int, @fassignqty decimal(24,2),@fremainqty decimal(24,2)

create table #Cursor(FID int identity(1,1),finterid int,fentryid int,fitemid int,FQty decimal(24,2),
fproductid int,fistop int,findex int, foweqty decimal(24,2))

create table #CursorEntry(FID int identity(1,1),finterid int,fentryid int,fitemid int,FQty decimal(24,2),frepitemid int)

select @fpreitemid=0,@fcanuseqty=0

truncate table #Cursor
insert into #Cursor(fproductid,finterid,fentryid,fitemid,fqty,fistop,findex)
select              fproductid,finterid,fentryid,fitemid,fqty,fistop,findex
from My_t_RepAlsRoughNeedSource t1 
where t1.frunid=@frunid
order by t1.findex

select @fminid=0,@fmaxid=0
select @fminid=isnull(min(fid),0),@fmaxid=isnull(max(fid),0) from #Cursor

WHILE @fmaxid>0 and @fminid<=@fmaxid --@@FETCH_STATUS = 0  --先把可用库存按物料先分配下去
BEGIN 
	select @fproductid=fproductid,@finterid=finterid,@fentryid=fentryid,@fistop=fistop,@fqty=fqty,@findex=findex 
	from #Cursor where fid=@fminid

	if @fistop=1
	begin
		select @fcanuseqty=fcanuseqty from My_t_RepAlsRoughNeedSource t1 where t1.frunid=@frunid and findex=@findex
	end
	
	if @fcanuseqty>0
	begin
		if @fcanuseqty>=@fqty --库存够分配
		begin
			select @fassignqty=@fqty,@fremainqty=@fcanuseqty-@fqty,@foweqty=0
		end
		else
		begin
			select @fassignqty=@fcanuseqty,@fremainqty=0,@foweqty=@fqty-@fcanuseqty
		end
	end
	else
	begin
		select @fassignqty=0,@fremainqty=0,@foweqty=@fqty	
	end
	
	update t1 set fassignqty=@fassignqty,fremainqty=@fremainqty,foweqty=@foweqty
	from My_t_RepAlsRoughNeedSource t1 where t1.frunid=@frunid and t1.findex=@findex
					
	set @fcanuseqty=@fcanuseqty-@fqty
	set @fminid=@fminid+1
END

--形成表四 --此时My_t_RepAlsRoughNeedSource表中,finterid+fentryid 是唯一的
truncate table #Cursor
insert into #Cursor(fproductid,   finterid,   fentryid,   fitemid,   fqty,   fistop,   findex,   foweqty)
select              t1.fproductid,t1.finterid,t1.fentryid,t1.fitemid,t1.fqty,t1.fistop,t1.findex,t1.foweqty
from My_t_RepAlsRoughNeedSource t1 
inner join ppbomentry t2 on t1.finterid=t2.finterid and t1.fentryid=t2.fentryid
where t1.frunid=@frunid and t1.foweqty>0 --不欠数的则不考虑
and isnull(t2.folditemid,0)=0 and t2.fqty=0 --已经有替换的或者已经有关联领料单的则不考虑
order by t1.findex

select @fminid=0,@fmaxid=0
select @fminid=isnull(min(fid),0),@fmaxid=isnull(max(fid),0) from #Cursor

WHILE @fmaxid>0 and @fminid<=@fmaxid --@@FETCH_STATUS = 0  --
BEGIN 
	select @fproductid=fproductid,@finterid=finterid,@fentryid=fentryid,@fistop=fistop,@fqty=fqty,@findex=findex,
	@foweqty=foweqty,@fitemid=fitemid
	from #Cursor where fid=@fminid

-- 	while @foweqty>0 and exists(select 1 from 
-- 				   (
-- 					     select t1.frepitemid from My_t_RepAlsItemReplace t1 where frunid=@frunid and t1.fproductid=@fproductid and t1.fitemid=@fitemid
-- 				    ) t1 inner join My_t_RepAlsStockStatus t2 on t1.frepitemid=t2.fitemid where t2.fremainqty>0) --是否存在可替换物料且替换物料的可用库存还有
-- 	begin
		set @frepremainqty=0
	
-- 		select top 1 @frepremainqty=t2.fremainqty,@frepitemid=t1.frepitemid from 
-- 		(
-- 		     select t1.frepitemid,t1.forder from My_t_RepAlsItemReplace t1 where frunid=@frunid and t1.fproductid=@fproductid and t1.fitemid=@fitemid
-- 		) t1 inner join My_t_RepAlsStockStatus t2 on t1.frepitemid=t2.fitemid where t2.fremainqty>0 order by t1.forder --是否存在可替换物料且替换物料的可用库存还有

		select top 1 @frepitemid=t1.frepitemid from My_t_RepAlsItemReplace t1 
		where frunid=@frunid and t1.fproductid=@fproductid and t1.fitemid=@fitemid 
		and t1.frepitemid in (select fitemid from My_t_RepAlsStockStatus where frunid=@frunid and fremainqty>0)
		order by t1.forder  --
		
		select @frepremainqty=fremainqty from My_t_RepAlsStockStatus where frunid=@frunid and fitemid=@frepitemid  --替换物料的剩余可用数
			
		if @frepremainqty>0
		begin
			update t1 set frepremainqty=@frepremainqty --替换物料的剩余可用数
			from My_t_RepAlsRoughNeedSource t1 
			where frunid=@frunid and findex=@findex

			if @frepremainqty>=@foweqty
			begin
				update t1 set frepitemid=@frepitemid,frepqty=@foweqty 
				from My_t_RepAlsRoughNeedSource t1 
				where frunid=@frunid and findex=@findex
				
				update t1 set fremainqty=fremainqty-@foweqty
				from My_t_RepAlsStockStatus t1 where frunid=@frunid and fitemid=@frepitemid  

-- 				set @foweqty=0
			end
			else  --是否允许同一批产品混合用料？
			begin
				update t1 set frepitemid=@frepitemid,frepqty=@frepremainqty 
				from My_t_RepAlsRoughNeedSource t1 
				where frunid=@frunid and findex=@findex
				
				update t1 set fremainqty=0
				from My_t_RepAlsStockStatus t1 where frunid=@frunid and fitemid=@frepitemid 
				 	
				/* --【一条投料单分录只处理一次，如果没有替换完，也不再进行分解了，否则投料单处理非常复杂】
				--此时My_t_RepAlsRoughNeedSource 表中,finterid+fentryid 可能是有多条记录的
				select @fnewindex=isnull(max(findex),0)+1 from My_t_RepAlsRoughNeedSource --与运算编号没关系
				
				insert into My_t_RepAlsRoughNeedSource(fisnew,ficmointerid,fcostobjid,fproductid,fneeddate,         ftrantype,frunid, finterid,   fentryid,  fitemid, fqtymust,                 fstockqty,  fqty,                     foweqty)
				select                                 1,     ficmointerid,fcostobjid,fproductid,fneeddate,         ftrantype,frunid, finterid,   fentryid,  fitemid, (@foweqty-@frepremainqty),0,          (@foweqty-@frepremainqty),(@foweqty-@frepremainqty)			
				from My_t_RepAlsRoughNeedSource where frunid=@frunid and findex=@findex
				
				insert into #Cursor(fproductid,   finterid,   fentryid,   fitemid,   fqty,   fistop,   findex,   foweqty)
				select              t1.fproductid,t1.finterid,t1.fentryid,t1.fitemid,t1.fqty,t1.fistop,t1.findex,t1.foweqty
				from My_t_RepAlsRoughNeedSource t1 
				where t1.frunid=@frunid and t1.findex=@fnewindex
				
				set @fmaxid=@fmaxid+1  --这里已经将新插入的记录再进行循环了
				*/
			end
		end
		
		set @fminid=@fminid+1
-- 	end
END

go

--exec My_p_RepAlsExe 16394,1014
IF EXISTS (select * from sysobjects where name='My_p_RepAlsExe' and xtype='p')  drop  procedure My_p_RepAlsExe
go

create procedure [dbo].My_p_RepAlsExe (@fuserid int,@frunid int)  
 
as
set nocount on

--declare @fuserid int,@frunid int select @fuserid =16394,@frunid =1017 
declare @fminid int,@fmaxid int,@fentryminid int,@fentrymaxid int,@fpreitemid int,@fcanuseqty decimal(24,2)
declare @fproductid int,@fistop int,@fqty decimal(24,2) ,@fentryid int,@fitemid int
declare @frependqty decimal(24,2), @frepitemid int, @frepremainqty decimal(24,2), @foweqty decimal(24,2)
declare @finterid int, @findex int, @fassignqty decimal(24,2),@fremainqty decimal(24,2)
declare @fcostobjid int,@ficmointerid int, @frepqty decimal(24,2),@fqtymust decimal(24,2)
declare @fnewentryid int,@fstockid int,@funitid int,@fisnew bit

create table #Cursor(FID int identity(1,1),fisnew int,fcostobjid int,ficmointerid int,fproductid int,finterid int,fentryid int,fitemid int,fqty decimal(24,2),fistop int,findex int,foweqty decimal(24,2),fqtymust decimal(24,2),frepqty decimal(24,2),frepitemid int)

truncate table #Cursor
insert into #Cursor(fisnew,   fcostobjid,   ficmointerid,   fproductid,   finterid,   fentryid,   fitemid,   fqty,   fistop,   findex,   foweqty,   fqtymust,   frepqty,   frepitemid)
select              t1.fisnew,t1.fcostobjid,t1.ficmointerid,t1.fproductid,t1.finterid,t1.fentryid,t1.fitemid,t1.fqty,t1.fistop,t1.findex,t1.foweqty,t1.fqtymust,t1.frepqty,t1.frepitemid
from My_t_RepAlsRoughNeedSource t1 
inner join My_t_RepAlsTemp t2 on t1.frunid=t2.frunid and t1.findex=t2.findex
where t1.frunid=@frunid and t2.fuserid=@fuserid and t1.frepitemid>0 and t1.frepqty>0 and t1.fisexecute=0 
order by t1.findex

select @fminid=0,@fmaxid=0
select @fminid=isnull(min(fid),0),@fmaxid=isnull(max(fid),0) from #Cursor

WHILE @fmaxid>0 and @fminid<=@fmaxid --@@FETCH_STATUS = 0  --
BEGIN 
	select @fcostobjid=fcostobjid,@ficmointerid=ficmointerid,@fproductid=fproductid,@frepitemid=frepitemid,@frepqty=frepqty,@fqtymust=fqtymust,
	@finterid=finterid,@fentryid=fentryid,@fistop=fistop,@fqty=fqty,@findex=findex,@foweqty=foweqty,@fitemid=fitemid
	from #Cursor where fid=@fminid

	if @fqtymust>@frepqty  ----应发数>替换数 (部分替换)  则 更新:应发数=应发数-替换数;         新增:应发数=替换数  物料为替换物料
	begin
-- 		if @fisnew=0
-- 		begin
			update ppbomentry set fqtymust=fqtymust-@frepqty,fauxqtymust=fauxqtymust-@frepqty,--fitemid=@frepitemid,folditemid=@fitemid,
			FAuxQtyPick=FAuxQtyPick-@frepqty,FBomInputAuxQty=FBomInputAuxQty-@frepqty
			where finterid=@finterid and fentryid=@fentryid
-- 		end
-- 		else
-- 		begin
			select @fnewentryid=isnull(max(fentryid),0)+1 from ppbomentry where finterid=@FInterID
		
			Insert Into PPBOMEntry (folditemid,fentryselfy0257,FICMOinterID,   FBrNo,FInterID, FEntryID,    FItemID,    FUnitID, FAuxQtyMust,FAuxQty,FMachinePos,FBomInputAuxQty,FauxQtyLoss,FSequenceID,FStockID,  FNote,FSourceEntryID,FAuxQtyScrap,FScrap,  FSendItemDate,  FAuxQtyPick,  FSPID,FOperID,FOperSN,FMaterielType,FBackFlush,FMarshalType,FBOMInterID,FBatchNO )
			select                  @fitemid,  @fcostobjid,    @ficmointerid,  '0',  @FInterID,@fnewentryid,@frepitemid,funitid, @frepqty,   0,      '',         @frepqty,       0,          '',         fstockid,  '',   0,             FQtyScrap,   fscrap,  FSendItemDate,  @frepqty,     0,    0,      0,      371,          1059,      385,         0,          ''
			from ppbomentry
			where finterid=@finterid and fentryid=@fentryid	
			
			--print cast(@FInterID as varchar(50))+' '+ cast(@fnewentryid as varchar(50))+' '+ cast(@frepitemid as varchar(50))
-- 		end
-- 		
-- 		select @fstockid=fdefaultloc,@funitid=funitid from t_icitem where fitemid=@frepitemid
-- 		
-- 		select @fnewentryid=isnull(max(fentryid),0)+1 from ppbomentry where finterid=@FInterID
-- 		
-- 		Insert Into PPBOMEntry (folditemid,fentryselfy0257,FICMOinterID,   FBrNo,FInterID, FEntryID,    FItemID,    FUnitID,  FAuxQtyMust,FAuxQty,FMachinePos,FBomInputAuxQty,FauxQtyLoss,FSequenceID,FStockID,  FNote,FSourceEntryID,FAuxQtyScrap,FScrap,  FSendItemDate,  FAuxQtyPick,  FSPID,FOperID,FOperSN,FMaterielType,FBackFlush,FMarshalType,FBOMInterID,FBatchNO )
-- 		select                  @fitemid,  @fcostobjid,    @ficmointerid,  '0',  @FInterID,@fnewentryid,@frepitemid,@funitid, @frepqty,   0,      '',         @frepqty,       0,          '',         @fstockid, '',   0,             FQtyScrap,   fscrap,  FSendItemDate,  @frepqty,     0,    0,      0,      371,          1059,      385,         0,          ''
-- 		from ppbomentry
-- 		where finterid=@finterid and fentryid=@fentryid		
	end
	else  --应发数<=替换数 则 更新; 应发数=替换数,物料为替换物料
	begin
-- 		if @fisnew=0
-- 		begin
			update ppbomentry set --fqtymust=@frepqty,fauxqtymust=@frepqty,
			--FAuxQtyPick=@frepqty,FBomInputAuxQty=@frepqty
			fitemid=@frepitemid,folditemid=@fitemid
			where finterid=@finterid and fentryid=@fentryid	
-- 		end
-- 		else
-- 		begin
-- 			select @fstockid=fdefaultloc,@funitid=funitid from t_icitem where fitemid=@frepitemid
-- 			
-- 			select @fnewentryid=isnull(max(fentryid),0)+1 from ppbomentry where finterid=@FInterID
-- 			
-- 			Insert Into PPBOMEntry (folditemid,fentryselfy0257,FICMOinterID,   FBrNo,FInterID, FEntryID,    FItemID,    FUnitID,  FAuxQtyMust,FAuxQty,FMachinePos,FBomInputAuxQty,FauxQtyLoss,FSequenceID,FStockID,  FNote,FSourceEntryID,FAuxQtyScrap,FScrap,  FSendItemDate,  FAuxQtyPick,  FSPID,FOperID,FOperSN,FMaterielType,FBackFlush,FMarshalType,FBOMInterID,FBatchNO )
-- 			select                  @fitemid,  @fcostobjid,    @ficmointerid,  '0',  @FInterID,@fnewentryid,@frepitemid,@funitid, @frepqty,   0,      '',         @frepqty,       0,          '',         @fstockid, '',   0,             FQtyScrap,   fscrap,  FSendItemDate,  @frepqty,     0,    0,      0,      371,          1059,      385,         0,          ''
-- 			from ppbomentry
-- 			where finterid=@finterid and fentryid=@fentryid			
-- 		end	
	end	

	EXEC prc_SHUpdateBillDoubleQty 88,@finterid	

	set @fminid=@fminid+1
END

update t1 set fisexecute=1
from My_t_RepAlsRoughNeedSource t1 
inner join My_t_RepAlsTemp t2 on t1.frunid=t2.frunid and t1.findex=t2.findex
where t1.frunid=@frunid and t2.fuserid=@fuserid 

drop table #Cursor

set nocount off

go


--订单需求计划跟踪--横排--跟踪成品下面的物料
--My_P_MaterielNeedPlanBySeOrder 16394,3,0,'2014-07-08'
IF EXISTS (select * from sysobjects where name='My_P_MaterielNeedPlanBySeOrder' and xtype='p')  drop  procedure My_P_MaterielNeedPlanBySeOrder
go

create procedure [dbo].My_P_MaterielNeedPlanBySeOrder(@fuserid int,@fitemtype int,@ftype int,@fenddate datetime) --@fitemtype  1 半成品  2 常规物料(目前只考虑芯片) 3 包材 0 全部  --@ftype 0 全部 1 选中任务单

as

set nocount on

--declare @fuserid int,@fitemtype int,@ftype int,@fenddate datetime select @fuserid=16394,@fitemtype=1,@ftype=0 ,@fenddate='2013-05-15'

declare @fdeptid int,@fitemid int,@fpqty decimal(24,2),@forderinterid int,@s varchar(8000),@forderbillno varchar(50)
declare @fqty decimal(24,4),@fplanqty decimal(24,4),@fstockqty decimal(24,4),@FWillInStockQty decimal(24,4),@FRoughNeedQty decimal(24,4)
declare @FCanUseStockQty decimal(24,4),@FNeedQty decimal(24,4),@fsourceinterid int,@fplandate datetime,@fentryid int
declare @fbegdate datetime,@fneeddate datetime,@finvdate datetime,@fcaldate datetime,@FOrderBillLike varchar(120),@fsourceentryid int
declare @fsendenddate datetime,@iRunID int, @iYear int,@iPeriod int,@fpackoutstockinterid int,@i int,@fnumbermatch varchar(20)
declare @ficmointerid int,@fplancommitdate datetime,@FPrepareDays int,@sqls varchar(8000),@iCount int,@frunid int
declare @varStrDate varchar(30),@sqls1 varchar(8000),@j int,@iCount2 int
declare @FProductProspectDays int,@FHalfProductProspectDays int,@FProductPrepareDays int,@FHalfProductPrepareDays int

select @FProductProspectDays=fvalue from t_SystemProfile where FCategory='IC' and fkey='FProductProspectDays' 
select @FHalfProductProspectDays=fvalue from t_SystemProfile where FCategory='IC' and fkey='FHalfProductProspectDays' 
select @FProductPrepareDays=fvalue from t_SystemProfile where FCategory='IC' and fkey='FProductPrepareDays' 
select @FHalfProductPrepareDays=fvalue from t_SystemProfile where FCategory='IC' and fkey='FHalfProductPrepareDays' 

select @s='',@i=1

declare @fdate datetime

select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期

create table #My_t_MrpRoughNeedSource(frunid int,ftrantype int,fsourceinterid int,fsourceentryid int,
fitemid int,fqty decimal(24,2),fpackinterid int,fneeddate datetime) 

create table #data(fnumber varchar(50),fplancommitdate datetime,fqty decimal(24,4),fsourceinterid int,
fsourceentryid int,fitemid int,fauxqtyscrap decimal(24,4),fscrap decimal(24,4),FPrepareDays int)

create table #temp(fitemid int)

create table #My_t_MrpWillInStock(fdate datetime,frunid int,ftrantype int,finterid int ,fentryid int,fitemid int,fqty decimal(24,0)) --1 外购  3 委外
create table #My_t_TempInventory(fdate datetime,frunid int,ftrantype int,finterid int ,fentryid int,fitemid int,fqty decimal(24,0)) --1 外购  3 委外

create table #My_t_MrpStock(frunid int,fstockid int,fitemid int,fqty decimal(24,0)) 


------投料单关联错误--3 领料数
--select t3.FCheckDate,t3.fbillno,t4.fnumber,t4.fname,t4.fmodel,t1.fstockqty,isnull(t2.fqty,0) fselectqty
update t1 set fstockqty=isnull(t2.fqty,0),fauxstockqty=isnull(t2.fqty,0)
from PPBOMEntry t1 --
left join 
(
	select t1.FEntrySelfZOU30 ficmointerid,t1.FEntrySelfZOU31 fppbomentryid,t1.fitemid,sum(t1.fqty) fqty
	from ZPStockBill t0 --
	inner join ZPStockBillEntry t1 on t0.finterid=t1.finterid  --
	inner join icmo t3 on t3.finterid=t1.FEntrySelfZOU30
	where t0.ftrantype=26 and t1.fsourcetrantype in (85,200000014) and t0.fstatus>0
	group by t1.FEntrySelfZOU30,t1.FEntrySelfZOU31,t1.fitemid
	union all
	select t1.ficmointerid,t1.fppbomentryid,t1.fitemid,sum(t1.fqty) fqty
	from ICStockBill t0 --
	inner join ICStockBillEntry t1 on t0.finterid=t1.finterid  --
	inner join icmo t3 on t3.finterid=t1.ficmointerid
	where t0.ftrantype=24 and t1.fsourcetrantype in (85,200000014) and t0.fstatus>0
	group by t1.ficmointerid,t1.fppbomentryid,t1.fitemid
) t2 on t1.ficmointerid=t2.ficmointerid and t1.FEntryID=t2.fppbomentryid and t1.fitemid=t2.fitemid
inner join icmo t3 on t1.ficmointerid=t3.finterid
inner join t_icitem t4 on t1.fitemid=t4.fitemid
where t3.fstatus<>3 and t1.fstockqty<>isnull(t2.fqty,0) and t3.fbillno like '%'

--投料单未发数--按生产计划分摊到日需求中--生产任务单中 成品是30天 半成品是15天

insert into #data(fnumber,fplancommitdate,fqty,fsourceinterid,fsourceentryid,fitemid,fauxqtyscrap,fscrap,FPrepareDays)
select t4.fnumber,
(case when t6.FHeadSelfS0154<@fdate then @fdate else t6.FHeadSelfS0154 end) fplancommitdate,--如果计划开工日期小于当天,则该任务单的需求日期则为当天
--(case when t6.FHeadSelfS0148<@fdate then @fdate else t6.FHeadSelfS0148 end) fplancommitdate,
(t3.fqtymust-t3.fstockqty) fqty,
t5.finterid fsourceinterid,0 fsourceentryid,t3.fitemid,t3.fauxqtyscrap,t3.fscrap,
(case when isnull(t5.forderinterid,0)<>0 then @FProductPrepareDays else @FHalfProductPrepareDays end) FPrepareDays  --成品直接下级则取成品的准备期，否则则取半成品的准备期
from icmo t5 
inner join ppbom t2 on t5.finterid=t2.ficmointerid
inner join ppbomentry t3 on t2.finterid=t3.finterid
inner join t_icitem t4 on t3.fitemid=t4.fitemid --子项
inner join t_icitem t8 on t5.fitemid=t8.fitemid --父项
inner join seorderentry t1 on t1.finterid=t5.forderinterid and t1.fentryid=t5.fsourceentryid 
inner join seorder t6 on t6.finterid=t1.finterid
where t5.fstatus in (1,2,5) and (t3.fqtymust-t3.fstockqty)>0 and isnull(t1.fmrpclosed,0)=0
and isnull(t6.FHeadSelfS0154,'1901-01-01')>=@fdate --先只考虑当天以后的需求--出货日期在当天之前的，则认为已经出完货
and t6.FHeadSelfS0148<>'1900-01-01'
--and t6.FHeadSelfS0148<=@fenddate 
and t6.FHeadSelfS0154<=@fenddate --只考虑在需求日期范围内的订单
and isnull(t1.finterid,0)<>0 --先只考虑包装的需求
and isnull(t6.FHeadSelfS0147,0) not in (40032,40033) --40032	样品订单-收费 40033	样品订单-免费
and t4.fnumber not like '1.02.%' and t4.fnumber not like '6.%'
--and t4.fnumber not like 'A.%' and t4.fnumber not like 'P.%'

----先只考虑包装的需求
--delete t1 from #data t1 
--inner join icmo t2 on t1.fsourceinterid=t2.finterid 
--where isnull(t2.forderinterid,0)=0
--
----先只考虑当天以后的需求--出货日期在当天之前的，则认为已经出完货
--delete t1 
--from #data t1 
--inner join icmo t2 on t1.fsourceinterid=t2.finterid 
--inner join seorderentry t3 on t3.finterid=t2.forderinterid and t3.fentryid=t2.fsourceentryid
--where t3.fdate<@fdate

if @ftype=1  --只考虑选中的任务单涉及到的物料
begin
	delete t5
	from #data t5 
	where t5.fitemid not in (
		select t5.fitemid
		from #data t5 
		inner join my_t_icmotemp t1 on t1.finterid=t5.fsourceinterid and t1.fuserid=@fuserid)
end

--@fitemtype  1 半成品  2 常规物料 3 包材
if @fitemtype=1
	delete from #data where left(fnumber,1) not in (select fitemtype from v_MyItemType where ftype=1) --fnumber not like '3.%' and fnumber not like '4.%'  --3.  4. 前缀物料编码为半成品
else if @fitemtype=3
	delete from #data where fnumber not like '2.%'   --2. 前缀物料编码为包材
else if @fitemtype=2
	delete from #data where left(fnumber,1) in (select fitemtype from v_MyItemType where ftype in(1,3)) --fnumber like '3.%' or fnumber like '4.%' or fnumber like '2.%' 

--delete from #data where fnumber like '2.01%' --纸箱

--DECLARE Seorder_Cursor CURSOR FOR
--select sum(isnull(fqty,0)) fqty,fitemid,fsourceinterid 
--from #data 
--group by fitemid,fsourceinterid
--
--OPEN Seorder_Cursor
--
--FETCH NEXT FROM Seorder_Cursor 
--INTO @fqty,@fitemid,@fsourceinterid
--
--WHILE @@FETCH_STATUS = 0
--BEGIN
--	DECLARE SeorderEntry_Cursor CURSOR FOR
--	select t6.fdate,--Dateadd(day,-t2.FPrepareDays,t6.fdate) fplandate,--先不考虑提前期
--	t6.fqty*t2.fauxqtyscrap*(1+t2.fscrap/100) fqty
--	from #data t2  
--	inner join my_t_scheduledetail t6 on t6.ficmointerid=t2.fsourceinterid  
--	where t2.fsourceinterid=@fsourceinterid and t2.fitemid=@fitemid and t6.fdate>=@fdate  --今天开始计起
--	order by t6.fdate desc
--
--	OPEN SeorderEntry_Cursor
--
--	FETCH NEXT FROM SeorderEntry_Cursor 
--	INTO @fplandate,@fplanqty
--
--	WHILE @@FETCH_STATUS = 0 and @fqty>0  --
--	BEGIN
--		if @fplanqty>=@fqty  --当天该物料的需求数大于未发数(余数)
--		begin
--			set @fplanqty=@fqty
--			set @fqty=0
--		end
--		else
--		begin
--			set @fqty=@fqty-@fplanqty
--		end	
--		
--		insert into #My_t_MrpRoughNeedSource(fneeddate, ftrantype,frunid, fsourceinterid,  fsourceentryid,  fitemid,  fqty)
--		select                               @fplandate,85,       @frunid,@fsourceinterid, 0,               @fitemid, @fplanqty
--	
--		FETCH NEXT FROM SeorderEntry_Cursor 
--		INTO @fplandate,@fplanqty
--	end
--
--	--可能出现当天或当天以后没有生产计划，有余数的话也放在今天的需求中
--	if @fqty>0 --如果还有剩余数则放在今天的需求中--如果当天以前领多了，则没有剩余数，表示最后一天不用领那么多；如果当天以前领少了，则有剩余数，即欠数，表示今天应领出来，否则影响生产；
--	begin
--		insert into #My_t_MrpRoughNeedSource(fneeddate, ftrantype,frunid, fsourceinterid,  fsourceentryid,  fitemid,  fqty)
--		select                               @fdate,    85,       @frunid,@fsourceinterid, 0,               @fitemid, @fqty
--	end
--
--	CLOSE SeorderEntry_Cursor
--	DEALLOCATE SeorderEntry_Cursor
--
--    FETCH NEXT FROM Seorder_Cursor
--    INTO @fqty,@fitemid,@fsourceinterid
--END
--
--CLOSE Seorder_Cursor
--DEALLOCATE Seorder_Cursor 

insert into #My_t_MrpRoughNeedSource(fneeddate,         ftrantype,frunid, fsourceinterid,    fsourceentryid,  fitemid,    fqty)
select                               t1.fplancommitdate,85,       @frunid,t1.fsourceinterid, 0,               t1.fitemid, t1.fqty
from #data t1

--drop table #data  --select * from #data order by fnumber  
--select t2.fnumber,t1.* from My_t_MrpRoughNeedSource t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid where frunid=1001 order by t2.fnumber

----关联任务单未审核的生产领料单
--insert into My_t_MrpRoughNeedSource(fneeddate,ficmointerid,ftrantype,frunid, forderinterid,forderentryid,fitemid,   fchilditemid,   forderqty,finqty, fqty,fchildmustqty,fchildoutqty, fchildqty)
--select						        t2.fdate, t5.finterid, 0,        @frunid,0,            0,            t8.fitemid,t4.fitemid,     0,        0,      0,   t3.fqty,      0,            t3.fqty
--from icmo t5 
--inner join icstockbillentry t3 on t5.finterid=t3.ficmointerid
--inner join icstockbill t2 on t2.finterid=t3.finterid
--inner join t_icitem t4 on t3.fitemid=t4.fitemid
--inner join t_icitem t8 on t5.fitemid=t8.fitemid
--inner join t_SubMessage t13 on t13.finterid=t4.f_114 and t13.ftypeid=10004  --仓管员
--inner join t_SubMessage t17 on t17.finterid=t4.f_115 and t17.ftypeid=10003  --倒冲
--where t2.ftrantype=24 and t2.fstatus in (0) 

--毛需求--随单出货外购件
insert into #My_t_MrpRoughNeedSource(fneeddate, ftrantype,frunid, fsourceinterid,fsourceentryid,fitemid,   fqty   )
select	                            (case when t5.FHeadSelfS0154<@fdate then @fdate else t5.FHeadSelfS0154 end) fneeddate,/*Dateadd(day,-@FProductPrepareDays,t4.fdate)--先不考虑提前期*/ 
										        81,       @frunid,t4.finterid,   t4.fentryid,   t4.fitemid,t4.fqty-isnull(t4.fstockqty,0)
from seorderentry t4 
inner join seorder t5  on t5.finterid=t4.finterid
inner join t_icitem t8 on t8.fitemid=t4.fitemid
inner join t_Organization t6 on t5.FCustID=t6.fitemid
inner join t_department t11 on t11.fitemid=t5.fdeptid
where t8.ferpclsid=1 and t4.fmrpclosed<>1 and (t5.fstatus>0 or isnull(t5.FMultiCheckLevel1,0)>0) --and t5.fdate>='2011-07-01'
--and datediff(day,getdate(),t4.fdate)=@FProductProspectDays  --成品30天
and t4.fqty>t4.fstockqty and t5.FHeadSelfS0148>=@fdate --只考虑交期为当天以后的--当天之前的视为已出货

--@fitemtype  1 半成品  2 常规物料 3 包材
if @fitemtype=1
	delete t1 from #My_t_MrpRoughNeedSource t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid 
	where left(t2.fnumber,1) not in (select fitemtype from v_MyItemType where ftype=1) --t2.fnumber not like '3.%' and t2.fnumber not like '4.%'  --3.  4. 前缀物料编码为半成品
else if @fitemtype=3
	delete t1 from #My_t_MrpRoughNeedSource t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid where t2.fnumber not like '2.%'   --2. 前缀物料编码为包材
else if @fitemtype=2
	delete t1 from #My_t_MrpRoughNeedSource t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid 
	where left(t2.fnumber,1) in (select fitemtype from v_MyItemType where ftype in(1,3)) --like '3.%' or t2.fnumber like '4.%' or t2.fnumber like '2.%' 

--预计入库--
/*
select                          @frunid,71,       t2.finterid,t2.fentryid,t2.fitemid,t2.fqty,  t2.fcommitqty,t2.fqty-t2.fcommitqty
from poorder t1
inner join poorderentry t2 on  t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where --t1.FClosed<>1 
t2.fmrpclosed<>1 
--and t4.fnumber not like '08.11.%' --and t1.fstatus>0 
and t1.fstatus<>3  --采购订单收料完毕就关闭，但不一定已经入库
and t3.ferpclsid in (1) 
--and (t3.fnumber like 'H.%' or t3.fnumber like 'K.%' or t3.fnumber like 'M.%' or t3.fnumber like 'N.%')
and (t2.fqty-t2.fcommitqty)>0
and t2.fitemid in (select fchilditemid from My_t_MrpRoughNeedSource where frunid=@frunid)
*/

--create table #plantemp(fplancommitdate datetime,fqty decimal(24,2),fsourceinterid int,fsourceentryid int,fitemid int) 

----预计入库--要把未收料的数量循环分摊到收料计划中--生产任务单一定有生产计划，而采购订单可能还没有收料计划
--insert into #plantemp(fplancommitdate,fqty,                  fsourceinterid,fsourceentryid,fitemid)
--select                case when t2.fdate<@fdate then @fdate when datediff(day,getdate(),t2.fdate)>30 then DATEADD(day,30,getdate()) else t2.fdate end,--如果填的交货日期小于当天，则表明采购员所填交货日期是有变动的，按当天处理       
--									 (t2.fqty-t2.fcommitqty),t2.finterid,   t2.fentryid,   t2.fitemid
--from poorderentry t2  
--inner join poorder t1 on t1.finterid=t2.finterid
--inner join t_icitem t3 on t2.fitemid=t3.fitemid
--inner join t_department t4 on t1.fdeptid=t4.fitemid
--where --t1.FClosed<>1 
--t2.fmrpclosed<>1 
----and t4.fnumber not like '08.11.%' --and t1.fstatus>0 
--and t1.fstatus<>3  --采购订单收料完毕就关闭，但不一定已经入库
--and t3.ferpclsid in (1) 
----and (t3.fnumber like 'H.%' or t3.fnumber like 'K.%' or t3.fnumber like 'M.%' or t3.fnumber like 'N.%')
--and (t2.fqty-t2.fcommitqty)>0
--and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource)
--
--DECLARE Seorder_Cursor CURSOR FOR
--select fqty,fitemid,fsourceinterid,fsourceentryid,fplancommitdate 
--from #plantemp 
--
--OPEN Seorder_Cursor
--
--FETCH NEXT FROM Seorder_Cursor 
--INTO @fqty,@fitemid,@fsourceinterid,@fsourceentryid,@fplancommitdate
--
--WHILE @@FETCH_STATUS = 0
--BEGIN
--	set @fplandate=null
--
--	DECLARE SeorderEntry_Cursor CURSOR FOR
--	select t2.fdate,t2.fqty
--	from my_t_scheduledetail t2  
--	where t2.fsourceinterid=@fsourceinterid and t2.fsourceentryid=@fsourceentryid 
--	and t2.fitemid=@fitemid and t2.fdate>=@fdate  --今天开始计起 
--	order by t2.fdate
--
--	OPEN SeorderEntry_Cursor
--
--	FETCH NEXT FROM SeorderEntry_Cursor 
--	INTO @fplandate,@fplanqty
--
--	WHILE @@FETCH_STATUS = 0 and @fqty>0  --
--	BEGIN
--		if @fplanqty>=@fqty
--		begin
--			set @fplanqty=@fqty
--			set @fqty=0
--		end
--		else
--		begin
--			set @fqty=@fqty-@fplanqty
--		end	
--		
--		insert into #My_t_MrpWillInStock(fdate,     frunid, ftrantype,finterid,       fentryid,       fitemid,   fqty)
--		select                           @fplandate,@frunid,71,       @fsourceinterid,@fsourceentryid,@fitemid,  @fplanqty
--	
--		FETCH NEXT FROM SeorderEntry_Cursor 
--		INTO @fplandate,@fplanqty
--	end
--
--	if @fqty>0 --如果还有剩余数则放在最后一天的计划--如果当天以前收多了，则没有剩余数，表示最后一天不用收那么多；如果当天以前收少了，则有剩余数；
--	begin
--		insert into #My_t_MrpWillInStock(frunid, ftrantype,finterid,       fentryid,       fitemid,   fqty ,fdate     )
--		select                           @frunid,71,       @fsourceinterid,@fsourceentryid,@fitemid,  @fqty,isnull(@fplandate,@fplancommitdate)/*如果没有当天或当天以后没有收料计划，则取订单收料日期*/
--	end
--
--	CLOSE SeorderEntry_Cursor
--	DEALLOCATE SeorderEntry_Cursor
--
--    FETCH NEXT FROM Seorder_Cursor
--    INTO @fqty,@fitemid,@fsourceinterid,@fsourceentryid,@fplancommitdate
--END
--
--CLOSE Seorder_Cursor
--DEALLOCATE Seorder_Cursor

--预计入库--采购订单--未关闭--未关联
insert into #My_t_MrpWillInStock(fdate,frunid, ftrantype,finterid,   fentryid,   fitemid,   fqty)
select                           case when t2.fdate<@fdate then @fdate when datediff(day,getdate(),t2.fdate)>30 then DATEADD(day,30,getdate()) else t2.fdate end,--如果填的交货日期小于当天，则表明采购员所填交货日期是有变动的，按当天处理       
									   @frunid,71,       t2.finterid,t2.fentryid,t2.fitemid,(t2.fqty-t2.fcommitqty)
from poorderentry t2  
inner join poorder t1 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where --t1.FClosed<>1 
t2.fmrpclosed<>1 
--and t4.fnumber not like '08.11.%' --and t1.fstatus>0 
and t1.fstatus<>3  --采购订单收料完毕就关闭，但不一定已经入库
and t3.ferpclsid in (1) 
--and (t3.fnumber like 'H.%' or t3.fnumber like 'K.%' or t3.fnumber like 'M.%' or t3.fnumber like 'N.%')
and (t2.fqty-t2.fcommitqty)>0
and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource)

--预计入库--(采购申请单--已审核未关闭--未关联数)
insert into #My_t_MrpWillInStock(fdate,frunid, ftrantype,finterid,   fentryid,   fitemid,   fqty)
select                           case when t2.FFetchTime<@fdate then @fdate when datediff(day,getdate(),t2.FFetchTime)>30 then DATEADD(day,30,getdate()) else t2.FFetchTime end,--如果填的交货日期小于当天，则表明采购员所填交货日期是有变动的，按当天处理       
									   @frunid,70,       t2.finterid,t2.fentryid,t2.fitemid,t2.fqty-t2.fcommitqty
from porequest t1
inner join porequestentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where --t1.fstatus>0 and 
t1.fstatus<>3 --and t2.FFetchTime>=@fdate  --今天开始计起
and t2.fmrpclosed=0
--and t4.fnumber not like '08.11.%'
and t3.ferpclsid in (1)
--and (t3.fnumber like 'H.%' or t3.fnumber like 'K.%' or t3.fnumber like 'M.%' or t3.fnumber like 'N.%')
and (t2.fqty-t2.fcommitqty)>0 
and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource)

--预计入库(收料通知单--未审核)--
insert into #My_t_MrpWillInStock(fdate,   frunid,  ftrantype,  finterid,   fentryid,   fitemid,   fqty)
select                           case when t1.fdate<@fdate then @fdate when datediff(day,getdate(),t1.fdate)>30 then DATEADD(day,30,getdate()) else t1.fdate end,--如果填的交货日期小于当天，则表明采购员所填交货日期是有变动的，按当天处理       
								          @frunid, 72,         t2.finterid,t2.fentryid,t2.fitemid,t2.fqty
from poinstock t1
inner join poinstockentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where t1.fstatus=0
--and t4.fnumber not like '08.11.%'
and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource) and t1.ftrantype=72

--预计入库(塑胶子件收料申请单--未关闭--未关联数)
insert into #My_t_MrpWillInStock(fdate,   frunid,  ftrantype,  finterid,fentryid,   fitemid,   fqty)
select                           t1.fdate,@frunid, 200000022,  t2.fid,  t2.fentryid,t2.fitemid,t2.fqty-t2.fcommitqty
from t_BOSPlasticPoInStock t1 
inner join t_BOSPlasticPoInStockEntry t2 on t1.fid=t2.fid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
--inner join t_department t4 on t1.fdeptid=t4.fitemid
inner join poorderentry t7 on t7.finterid=t2.fid_src and t7.fentryid=t2.fentryid_src 
where t7.FMrpClosed<>1 and isnull(t2.fmrpclosed,0)<>40019 --and t1.fstatus>0 
and (t2.fqty-t2.fcommitqty)>0
and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource) --and t1.FClassTypeID=200000022

--待检--日期信息不重要

--待检(未审核的外购入库单)
insert into #My_t_TempInventory(fdate,   frunid, ftrantype,finterid,   fentryid,   fitemid,   fqty)
select                        t1.fdate,@frunid,1,        t2.finterid,t2.fentryid,t2.fitemid,t2.fqty
from icstockbill t1
inner join icstockbillentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where t1.fstatus=0 and t2.FSourceTranType=72 
--and t4.fnumber not like '08.11.%'
and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource) and t1.ftrantype=1

--待检(收料通知单--未关闭--未关联数)--已审核未关闭
insert into #My_t_TempInventory(fdate,   frunid,  ftrantype,  finterid,   fentryid,   fitemid,   fqty)
select                          t1.fdate,@frunid, 72,         t2.finterid,t2.fentryid,t2.fitemid,t2.fqty-t2.fcommitqty-t2.fbackqty
from poinstock t1
inner join poinstockentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where t1.fstatus>0 and t1.fstatus<>3 --
and t2.fqty>(t2.fcommitqty+t2.fbackqty)
--and t4.fnumber not like '08.11.%'
and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource) and t1.ftrantype=72

/*
--预计入库--预测订单
insert into My_t_MrpWillInStock(frunid, ftrantype,finterid,   fentryid,   fitemid,   forderqty,finqty,                       fqty)
select                          @frunid,87,       t2.finterid,t2.fentryid,t2.fitemid,t2.fqty,  isnull(t2.FEntrySelfY0121,0), t2.fqty-isnull(t2.FEntrySelfY0121,0)
from pporder t1
inner join pporderentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
--inner join t_department t4 on t1.FHeadSelfY0121=t4.fitemid
where t2.forderclosed<>1 and t1.fstatus>0 and t1.fstatus<>3
and (t2.fqty-isnull(t2.FEntrySelfY0121,0))>0
--and t4.fnumber not like '08.11.%'
and t2.fitemid in (select fchilditemid from My_t_MrpRoughNeedSource where frunid=@frunid)
*/

--预计入库--
/*
insert into My_t_MrpWillInStock(fneedate,frunid, ftrantype,finterid,   fentryid,   fitemid,   forderqty,finqty,                     fqty)
select                          @frunid,85,       t2.finterid,0,          t2.fitemid,t2.fqty,  isnull(t2.fstockqty,0),     t2.fqty-isnull(t2.fstockqty,0)
from icmo t2 
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t2.fworkshop=t4.fitemid
where t2.fstatus>0 and t2.fstatus<>3
and (t2.fqty-isnull(t2.fstockqty,0))>0
--and t4.fnumber not like '08.11.%'
and t2.fitemid in (select fchilditemid from My_t_MrpRoughNeedSource where frunid=@frunid)
*/

----预计入库--任务单--要把未入库的数量循环分摊到生产计划中
--select t2.fplancommitdate,(t2.fqty-t2.fstockqty) fqty,t2.finterid fsourceinterid,0 fsourceentryid,t2.fitemid
--into #source
--from icmo t2  
--inner join t_icitem t3 on t2.fitemid=t3.fitemid
--inner join t_department t4 on t2.fworkshop=t4.fitemid
--where t2.fstatus<>3
--and (t2.fqty-isnull(t2.fstockqty,0))>0
--and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource)
--
--DECLARE Seorder_Cursor CURSOR FOR
--select fqty,fitemid,fsourceinterid from #source 
--
--OPEN Seorder_Cursor
--
--FETCH NEXT FROM Seorder_Cursor 
--INTO @fqty,@fitemid,@fsourceinterid
--
--WHILE @@FETCH_STATUS = 0
--BEGIN
--	set @fplandate=null
--
--	DECLARE SeorderEntry_Cursor CURSOR FOR
--	select t2.fdate,t2.fqty
--	from my_t_scheduledetail t2  
--	where t2.ficmointerid=@fsourceinterid and t2.fitemid=@fitemid and t2.fdate>=@fdate  --今天开始计起
--	order by t2.fdate
--
--	OPEN SeorderEntry_Cursor
--
--	FETCH NEXT FROM SeorderEntry_Cursor 
--	INTO @fplandate,@fplanqty
--
--	WHILE @@FETCH_STATUS = 0 and @fqty>0
--	BEGIN
--		if @fplanqty>=@fqty
--		begin
--			set @fplanqty=@fqty
--			set @fqty=0
--		end
--		else
--		begin
--			set @fqty=@fqty-@fplanqty
--		end	
--		
--		insert into #My_t_MrpWillInStock(fdate,     frunid, ftrantype,finterid,       fentryid,       fitemid,   fqty)
--		select                          @fplandate,@frunid,85,       @fsourceinterid,@fsourceentryid,@fitemid,  @fplanqty
--	
--		FETCH NEXT FROM SeorderEntry_Cursor 
--		INTO @fplandate,@fplanqty
--	end
--
--	if @fqty>0 --生产任务单一定有生产计划,如果还有剩余数表示当天以前还有计划未执行
--	begin
--		insert into #My_t_MrpWillInStock(frunid, ftrantype,finterid,       fentryid,       fitemid,   fqty, fdate)
--		select                          @frunid,85,       @fsourceinterid,@fsourceentryid,@fitemid,  @fqty,isnull(@fplandate,@fdate)--当天或当天以后还有计划，则放在最后一天，没有则放在当天
--	end
--
--	CLOSE SeorderEntry_Cursor
--	DEALLOCATE SeorderEntry_Cursor
--
--    FETCH NEXT FROM Seorder_Cursor
--    INTO @fqty,@fitemid,@fsourceinterid
--END
--
--CLOSE Seorder_Cursor
--DEALLOCATE Seorder_Cursor

--预计入库--任务单
insert into #My_t_MrpWillInStock(frunid, ftrantype,finterid,   fentryid,fitemid,   fqty,                          fdate)
select                           @frunid,85,       t2.finterid,0,       t2.fitemid,t2.fqty-isnull(t2.fstockqty,0),t2.fplancommitdate
from icmo t2  
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t2.fworkshop=t4.fitemid
where t2.fstatus<>3
and (t2.fqty-isnull(t2.fstockqty,0))>0
and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource)

--库存
insert into #My_t_MrpStock(frunid, fitemid,   fstockid,   fqty)
select                     @frunid,t1.fitemid,t1.fstockid,t1.fqty
from icinventory t1
inner join t_ICItem t2 on t1.FItemID=t2.FItemID
inner join t_stock t3 on t3.fitemid=t1.fstockid
where --t2.ferpclsid in (1) and 
t1.fqty>0 --and t3.fname not like '%计划%' 
and t3.fname not like '%不良%' and t3.fname not like '%报废%'
--and t3.fnumber not like '11.%' 
--and (t2.fnumber like 'H.%' or t2.fnumber like 'K.%' or t2.fnumber like 'M.%' or t2.fnumber like 'N.%')
and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource)

insert into #My_t_MrpStock(frunid, fitemid,   fstockid,   fqty)
select @frunid,t1.fitemid,t1.fstockid,t1.fqty
from poinventory t1
inner join t_ICItem t2 on t1.FItemID=t2.FItemID
inner join t_stock t3 on t3.fitemid=t1.fstockid
where --t2.ferpclsid in (1) and 
t1.fqty>0 --and t3.fname not like '%计划%' 
and t3.fname not like '%不良%' and t3.fname not like '%报废%' and t3.fitemid=16483  --代管仓
--and t3.fnumber not like '11.%' 
--and (t2.fnumber like 'H.%' or t2.fnumber like 'K.%' or t2.fnumber like 'M.%' or t2.fnumber like 'N.%')
and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource)

--select * from ictranstype

--半成品只取展望期内的需求
--if @fitemtype=1
--begin
--	delete t1
--	from #My_t_MrpRoughNeedSource t1 
--	inner join t_icitem t2 on t1.fitemid=t2.fitemid
--	where t1.frunid=@frunid and datediff(day,getdate(),t1.fneeddate)>@FHalfProductProspectDays  --半成品展望期30天
--
--	delete t1
--	from #My_t_MrpWillInStock t1 
--	inner join t_icitem t2 on t1.fitemid=t2.fitemid
--	where t1.frunid=@frunid and datediff(day,getdate(),t1.fdate)>@FHalfProductProspectDays  --半成品展望期30天
--end
 
--净需求具体到天
create table #my_t_MrpResultDetail(fneeddate datetime,fitemid int,funitid int,FRoughNeedQty decimal(24,4),
FWillInStockQty decimal(24,4),FCanUseStockQty decimal(24,4),FNeedQty decimal(24,4))


--select * into #sourcedata
--from 
--(
--	select t1.fneeddate,t1.fitemid,sum(t1.fqty) fqty,0 ftype
--	from My_t_MrpRoughNeedSource t1 where frunid=@frunid group by t1.fneeddate,t1.fitemid
--	union all
--	select t1.fdate fneeddate,t1.fitemid,sum(t1.fqty) fqty,1 ftype
--	from My_t_MrpWillInStock t1 where frunid=@frunid group by t1.fdate,t1.fitemid
--	union all
--	select '2100-01-01' fneeddate,t1.fitemid,sum(t1.fqty) fqty,2 ftype
--	from My_t_MrpStock t1 where frunid=@frunid group by t1.fitemid
--) t1

--select fitemid,fneeddate,isnull(sum(isnull(FRoughNeedQty,0)),0) FRoughNeedQty,isnull(sum(isnull(FWillInStockQty,0)),0) FWillInStockQty 
--into #sourcedata --ftype 0 毛需求 1 预计入库 2 库存
--from
--(
--	select fitemid,fneeddate,(case when ftype=0 then fqty else 0 end) FRoughNeedQty, 
--	(case when ftype=1 then fqty else 0 end) FWillInStockQty,
--	(case when ftype=2 then fqty else 0 end) FStockQty
--	from 
--	(
--		select t1.fneeddate,t1.fitemid,isnull(sum(isnull(t1.fqty,0)),0) fqty,0 ftype
--		from #My_t_MrpRoughNeedSource t1 group by t1.fneeddate,t1.fitemid
--		union all
--		select t1.fdate fneeddate,t1.fitemid,isnull(sum(isnull(t1.fqty,0)),0) fqty,1 ftype
--		from #My_t_MrpWillInStock t1 group by t1.fdate,t1.fitemid
--	) t1
--) t1 group by fitemid,fneeddate
--
--set @fentryid=0

--DECLARE Seorder_Cursor CURSOR FOR
--select t2.fitemid,isnull(max(isnull(t1.fstockqty,0)),0) fstockqty,1 fentryid
--from #sourcedata t2
--left join 			
--(
--	select t1.fitemid,isnull(sum(isnull(t1.fqty,0)),0) fstockqty
--	from #My_t_MrpStock t1 group by t1.fitemid
--) t1 on t1.fitemid=t2.fitemid
--group by t2.fitemid
--
--OPEN Seorder_Cursor
--
--FETCH NEXT FROM Seorder_Cursor 
--INTO @fitemid,@FStockQty,@fentryid
--
--WHILE @@FETCH_STATUS = 0
--BEGIN
--	DECLARE SeorderEntry_Cursor CURSOR FOR
--	select t2.fneeddate,t2.FRoughNeedQty,t2.FWillInStockQty
--	from #sourcedata t2
--	where t2.fitemid=@fitemid 
--	order by t2.fneeddate
--
--	OPEN SeorderEntry_Cursor
--
--	FETCH NEXT FROM SeorderEntry_Cursor 
--	INTO @fneeddate,@FRoughNeedQty,@FWillInStockQty
--	WHILE @@FETCH_STATUS = 0
--	BEGIN
--		if @fentryid=1
--			set @FCanUseStockQty=@fstockqty  --库存在第一次循环的时候才纳入
--
--		set @fentryid=@fentryid+1
--
--		set @FCanUseStockQty=@FWillInStockQty+@FCanUseStockQty-@FRoughNeedQty  --可用库存
--
----		if @FCanUseStockQty>=0
----			set @FNeedQty=0--净需求
----		else
----		begin
----			set @FNeedQty=-@FCanUseStockQty
----			set @FCanUseStockQty=0
----		end
--
----		insert into #my_t_MrpResultDetail(fitemid, fneeddate, FWillInStockQty, FCanUseStockQty, FRoughNeedQty, FNeedQty)
----								   values(@fitemid,@fneeddate,@FWillInStockQty,@FCanUseStockQty,@FRoughNeedQty,@FNeedQty)
--
--		insert into #my_t_MrpResultDetail(fitemid, fneeddate, FWillInStockQty, FCanUseStockQty, FRoughNeedQty, FNeedQty)
--								   values(@fitemid,@fneeddate,@FWillInStockQty,@FCanUseStockQty,@FRoughNeedQty,@FNeedQty)
--
--		--update t1 set fqty=@fqty from #MyMrpResultTemp t1 where fneeddate=@fneeddate and fitemid=@fitemid
--
--		FETCH NEXT FROM SeorderEntry_Cursor 
--		INTO @fneeddate,@FRoughNeedQty,@FWillInStockQty
--	end
--
--	CLOSE SeorderEntry_Cursor
--	DEALLOCATE SeorderEntry_Cursor
--
--    FETCH NEXT FROM Seorder_Cursor
--    INTO @fitemid,@FStockQty,@fentryid
--END
--
--CLOSE Seorder_Cursor
--DEALLOCATE Seorder_Cursor

select t1.finterid,cast('' as varchar(20)) fbillno,t1.fneeddate,t1.fitemid,sum(t1.fqty) fqty 
into #sourcedata
from
(
	select t3.finterid,t1.fneeddate,t1.fitemid,isnull(t1.fqty,0) fqty
	from #My_t_MrpRoughNeedSource t1 
	inner join seorderentry t2 on t1.fsourceinterid=t2.finterid and t1.fsourceentryid=t2.fentryid
	inner join seorder t3 on t2.finterid=t3.finterid
	where t1.ftrantype=81 and t1.fneeddate<=@fenddate
	union all
	select t3.finterid,t1.fneeddate,t1.fitemid,isnull(t1.fqty,0) fqty
	from #My_t_MrpRoughNeedSource t1 
	inner join icmo t4 on t1.fsourceinterid=t4.finterid
	inner join seorderentry t2 on t4.forderinterid=t2.finterid and t4.fsourceentryid=t2.fentryid
	inner join seorder t3 on t2.finterid=t3.finterid
	where t1.ftrantype=85 and t1.fneeddate<=@fenddate
) t1 
group by t1.finterid,t1.fneeddate,t1.fitemid

update t1 set fbillno=(case when isnull(t2.fheadselfs0143,'')='' then t2.fbillno else right(isnull(t2.fheadselfs0143,''),5) end)
from #sourcedata t1
inner join seorder t2 on t1.finterid=t2.finterid

declare @fminid int,@fmaxid int,@fentryminid int,@fentrymaxid int,@fpreitemid int
create table #Cursor(FID int identity(1,1),fsourceinterid int,fitemid int,FQty decimal(24,2),forderbillno varchar(15),fplandate datetime)
create table #CursorEntry(FID int identity(1,1),fplandate datetime,FPlanQty decimal(24,2))

--创建表
-- DECLARE Seorder_Cursor CURSOR FOR
truncate table #Cursor
insert into #Cursor(fplandate,forderbillno)
select distinct t1.fneeddate,t1.fbillno from #sourcedata t1 order by t1.fneeddate,t1.fbillno

-- OPEN Seorder_Cursor
-- 
-- FETCH NEXT FROM Seorder_Cursor 
-- INTO @fplandate,@forderbillno
-- 
-- WHILE @@FETCH_STATUS = 0
-- BEGIN
select @fminid=0,@fmaxid=0
select @fminid=isnull(min(fid),0),@fmaxid=isnull(max(fid),0) from #Cursor

WHILE @fmaxid>0 and @fminid<=@fmaxid --@@FETCH_STATUS = 0  --先把可用库存按物料先分配下去
BEGIN 
	select @fplandate=fplandate,@forderbillno=forderbillno from #Cursor where fid=@fminid

	set @varStrDate=replace(convert(varchar(10),@fplandate,111),'/','-')+'-'+@forderbillno
	set @sqls=''
	set @sqls=@sqls+'alter table #temp add ['+@varStrDate+'] decimal(24,0) default 0 '  

	--print @sqls
	execute (@sqls) 

-- 	FETCH NEXT FROM Seorder_Cursor
-- 	INTO @fplandate,@forderbillno
-- END
-- 
-- CLOSE Seorder_Cursor
-- DEALLOCATE Seorder_Cursor

	set @fminid=@fminid+1
END



--创建表  

--------------------------------------------------------------------------------------------------------
create table #My_t_SourceTemp(fitemid int)

-- DECLARE Seorder_Cursor CURSOR FOR
truncate table #Cursor
insert into #Cursor(fplandate,forderbillno)
select distinct t1.fneeddate,t1.fbillno from #sourcedata t1 order by t1.fneeddate,t1.fbillno

-- OPEN Seorder_Cursor
-- 
-- FETCH NEXT FROM Seorder_Cursor 
-- INTO @fplandate,@forderbillno
-- 
-- WHILE @@FETCH_STATUS = 0
-- BEGIN
select @fminid=0,@fmaxid=0
select @fminid=isnull(min(fid),0),@fmaxid=isnull(max(fid),0) from #Cursor

WHILE @fmaxid>0 and @fminid<=@fmaxid --@@FETCH_STATUS = 0  --先把可用库存按物料先分配下去
BEGIN 
	select @fplandate=fplandate,@forderbillno=forderbillno from #Cursor where fid=@fminid

	set @varStrDate=replace(convert(varchar(10),@fplandate,111),'/','-')+'-'+@forderbillno

	set @sqls=''
	set @sqls=@sqls+'alter table #My_t_SourceTemp add ['+@varStrDate+'] decimal(24,0) default 0 '  

	execute (@sqls) 

-- 	FETCH NEXT FROM Seorder_Cursor
-- 	INTO @fplandate,@forderbillno
-- END
-- 
-- CLOSE Seorder_Cursor
-- DEALLOCATE Seorder_Cursor

	set @fminid=@fminid+1
END

--先计算出物料在计划期间每天的需求数---------------------------------------------------------------


-- IF EXISTS (select * from sysobjects where name='My_t_SourceTemp' and xtype='u')  drop  Table My_t_SourceTemp
-- 
-- set @sqls1='select fitemid,'
-- 
-- set @i=0
-- 
-- DECLARE Seorder_Cursor CURSOR FOR
-- select distinct t1.fneeddate,t1.fbillno from #sourcedata t1 order by t1.fneeddate,t1.fbillno
-- 
-- OPEN Seorder_Cursor
-- 
-- FETCH NEXT FROM Seorder_Cursor 
-- INTO @fplandate,@forderbillno
-- 
-- WHILE @@FETCH_STATUS = 0
-- BEGIN
-- 	set @varStrDate=replace(convert(varchar(10),@fplandate,111),'/','-')+'-'+@forderbillno
-- 	set @sqls1=@sqls1+'(case when fneeddate='+''''+left(@varStrDate,10)+''''+' and fbillno='+''''+substring(@varStrDate,12,(len(@varStrDate)-11))+''''+' then fqty else 0 end) '+''''+@varStrDate+''''+','
-- 
-- 	FETCH NEXT FROM Seorder_Cursor
-- 	INTO @fplandate,@forderbillno
-- END
-- 
-- CLOSE Seorder_Cursor
-- DEALLOCATE Seorder_Cursor
-- 
-- set @sqls1=substring(@sqls1,1,len(@sqls1)-1)
-- set @sqls1=@sqls1+' into My_t_SourceTemp from #sourcedata '  
-- 
-- --print @sqls1
-- 
-- execute (@sqls1)  --结合下面的SQL执行 



set @i=0

truncate table #Cursor
insert into #Cursor(fplandate,forderbillno)
-- DECLARE Seorder_Cursor CURSOR FOR
select distinct t1.fneeddate,t1.fbillno from #sourcedata t1 order by t1.fneeddate,t1.fbillno

-- OPEN Seorder_Cursor
-- 
-- FETCH NEXT FROM Seorder_Cursor 
-- INTO @fplandate,@forderbillno
-- 
-- WHILE @@FETCH_STATUS = 0
select @fminid=0,@fmaxid=0
select @fminid=isnull(min(fid),0),@fmaxid=isnull(max(fid),0) from #Cursor

WHILE @fmaxid>0 and @fminid<=@fmaxid --@@FETCH_STATUS = 0  --先把可用库存按物料先分配下去
BEGIN 
	select @fplandate=fplandate,@forderbillno=forderbillno from #Cursor where fid=@fminid

	set @varStrDate=replace(convert(varchar(10),@fplandate,111),'/','-')+'-'+@forderbillno
	set @sqls1=''
	set @sqls1=@sqls1+'insert into #My_t_SourceTemp (fitemid,['+@varStrDate+']) select fitemid,fqty from #sourcedata where fneeddate='+''''+left(@varStrDate,10)+''''+' and fbillno='+''''+substring(@varStrDate,12,(len(@varStrDate)-11))+''''

	--print @sqls1
	execute (@sqls1)  --结合下面的SQL执行 

-- 	FETCH NEXT FROM Seorder_Cursor
-- 	INTO @fplandate,@forderbillno
-- END
-- 
-- CLOSE Seorder_Cursor
-- DEALLOCATE Seorder_Cursor
	set @fminid=@fminid+1
END


-- --汇总-------------------------------------------------------------------
-- set @sqls='insert into #temp select t1.fitemid,' 
-- 
-- 
-- DECLARE Seorder_Cursor CURSOR FOR
-- select distinct t1.fneeddate,t1.fbillno from #sourcedata t1 order by t1.fneeddate,t1.fbillno
-- 
-- OPEN Seorder_Cursor
-- 
-- FETCH NEXT FROM Seorder_Cursor 
-- INTO @fplandate,@forderbillno
-- 
-- WHILE @@FETCH_STATUS = 0
-- BEGIN
-- 	set @varStrDate=replace(convert(varchar(10),@fplandate,111),'/','-')+'-'+@forderbillno
-- 	set @sqls=@sqls+'sum(isnull(['+@varStrDate +'],0)) '+''''+@varStrDate+''+''''+','
-- 
-- 	FETCH NEXT FROM Seorder_Cursor
-- 	INTO @fplandate,@forderbillno
-- END
-- 
-- CLOSE Seorder_Cursor
-- DEALLOCATE Seorder_Cursor 
-- 
-- set @sqls=substring(@sqls,1,len(@sqls)-1)
-- --set @sqls=@sqls+' from ('+@sqls1+') t1  group by t1.fitemid '  
-- set @sqls=@sqls+' from My_t_SourceTemp t1  group by t1.fitemid '  
-- 
-- --print @sqls
-- 
-- execute (@sqls)   --先计算出物料在计划期间每天的需求数

insert into #temp(fitemid) select t1.fitemid from #My_t_SourceTemp t1 group by t1.fitemid

-- set @sqls='insert into #temp select t1.fitemid,' 


truncate table #Cursor
insert into #Cursor(fplandate,forderbillno)
-- DECLARE Seorder_Cursor CURSOR FOR
select distinct t1.fneeddate,t1.fbillno from #sourcedata t1 order by t1.fneeddate,t1.fbillno

-- OPEN Seorder_Cursor
-- 
-- FETCH NEXT FROM Seorder_Cursor 
-- INTO @fplandate,@forderbillno
-- 
-- WHILE @@FETCH_STATUS = 0
select @fminid=0,@fmaxid=0
select @fminid=isnull(min(fid),0),@fmaxid=isnull(max(fid),0) from #Cursor

WHILE @fmaxid>0 and @fminid<=@fmaxid --@@FETCH_STATUS = 0  --先把可用库存按物料先分配下去
BEGIN 
	select @fplandate=fplandate,@forderbillno=forderbillno from #Cursor where fid=@fminid

	set @varStrDate=replace(convert(varchar(10),@fplandate,111),'/','-')+'-'+@forderbillno

	set @sqls=''
	set @sqls=@sqls+'update t1 set ['+@varStrDate +']=t2.['+@varStrDate +'] from #temp t1 inner join (select fitemid,sum(['+@varStrDate +']) ['+@varStrDate +'] from #My_t_SourceTemp group by fitemid ) t2 on t1.fitemid=t2.fitemid '  

	--print @sqls
	
	execute (@sqls)   --先计算出物料在计划期间每天的需求数

-- 	FETCH NEXT FROM Seorder_Cursor
-- 	INTO @fplandate,@forderbillno
-- 
-- CLOSE Seorder_Cursor
-- DEALLOCATE Seorder_Cursor 
	set @fminid=@fminid+1
END

/*
update t1 set FModQty=FTempdNeedQty%fbatchappendqty from #MyMrpResultTemp t1 where fneedqty>0

update t1 set FActNeedQty=FTempdNeedQty+(fbatchappendqty-FModQty) 
from #MyMrpResultTemp t1 where fneedqty>0 and FModQty>0
*/
--select * from #temp
--保存结果--明细
--delete from my_t_MrpResultDetail where fhscount=@fhscount  --update my_t_MrpResultDetail set fremark=''

select cast(0 as bit) 选择,t2.fnumber 物料编码,t2.fname 名称,t2.fmodel 规格型号,t7.fname 仓库,t3.fname 单位,
cast(t5.fqty as int) 未发数,isnull(t4.fqty,0) 库存,isnull(t4.fqty,0)-cast(t5.fqty as int) 欠数,
isnull(t8.fqty,0) 待检,isnull(t6.fqty,0) 预计入库,t1.*
from #temp t1 
inner join t_icitem t2 on t1.fitemid=t2.fitemid
inner join t_measureunit t3 on t2.funitid=t3.fitemid
inner join (select fitemid,sum(fqty) fqty from #data group by fitemid) t5 on t5.fitemid=t1.fitemid
left join (select fitemid,sum(isnull(fqty,0)) fqty from #My_t_TempInventory group by fitemid) t8 on t8.fitemid=t1.fitemid
left join (select fitemid,sum(isnull(fqty,0)) fqty from #My_t_MrpStock group by fitemid) t4 on t4.fitemid=t1.fitemid
left join (select fitemid,sum(isnull(fqty,0)) fqty from #My_t_MrpWillInStock group by fitemid) t6 on t6.fitemid=t1.fitemid
left join t_stock t7 on t7.fitemid=t2.fdefaultloc
where isnull(t4.fqty,0)<isnull(t5.fqty,0)
order by t2.fnumber

--drop table #plantemp
drop table #temp
--drop table #source
drop table #data
drop table #my_t_MrpResultDetail
drop table #sourcedata
drop table #My_t_MrpRoughNeedSource
drop table #My_t_MrpWillInStock
drop table #My_t_TempInventory
drop table #My_t_MrpStock
drop table #My_t_SourceTemp

set nocount off

GO



--采购价格信息变更记录

--exec my_GetPackPriceChangeRecord '2014-05-01','2014-05-31','','2','','','有'

IF EXISTS (select * from sysobjects where name='my_GetPackPriceChangeRecord' and xtype='p')  drop  procedure my_GetPackPriceChangeRecord
go

create procedure my_GetPackPriceChangeRecord (@fbegdate datetime,@fenddate datetime,@fsupplyname varchar(50),@fnumber varchar(20),@fitemname varchar(50),@fitemmodel varchar(50),@ftype varchar(10)) --0 不分数量段 1 分

as

--declare @fbegdate datetime,@fenddate datetime,@fsupplyname varchar(50),@fnumber varchar(20),@fitemname varchar(50),@fitemmodel varchar(50)  select @fbegdate='2012-01-02',@fenddate='2012-02-25',@fsupplyname='',@fnumber='',@fitemname='',@fitemmodel=''

set nocount on

--drop table #data drop table #init
create table #data(fdate datetime,fitemid int,fsupplyid int,
fprice decimal(24,4),fprice1 decimal(24,4),fprice2 decimal(24,4),
fprice3 decimal(24,4),fprice4 decimal(24,4),
fprice5 decimal(24,4),fprice6 decimal(24,4),
fyearperiod int)

insert into #data(fdate,fitemid,fsupplyid,fprice,fprice1,fprice2,fprice3,fprice4,fprice5,fprice6,fyearperiod)
select t1.fdate,t1.fitemid,t1.fsupplyid,isnull(max(isnull(t1.fprice,0)),0) fprice,isnull(max(isnull(t1.fprice1,0)),0) fprice1,
isnull(max(isnull(t1.fprice2,0)),0) fprice2,
isnull(max(isnull(t1.fprice3,0)),0) fprice3,isnull(max(isnull(t1.fprice4,0)),0) fprice4,isnull(max(isnull(t1.fprice5,0)),0) fprice5,
isnull(max(isnull(t1.fprice6,0)),0) fprice6,
t1.fyearpeiod
from
(
	select t2.fitemid,t1.fsupplyid,t2.fprice,
	(case when t2.fqty>=1 and t2.fqty<=500 then t2.ftaxprice else 0 end) fprice1,
	(case when t2.fqty>=501 and t2.fqty<=1000 then t2.ftaxprice else 0 end) fprice2,
	(case when t2.fqty>=1001 and t2.fqty<=2000 then t2.ftaxprice else 0 end) fprice3,
	(case when t2.fqty>=2001 and t2.fqty<=3000 then t2.ftaxprice else 0 end) fprice4,
	(case when t2.fqty>=3001 and t2.fqty<=5000 then t2.ftaxprice else 0 end) fprice5,
	(case when t2.fqty>=5001  then t2.ftaxprice else 0 end) fprice6,
	t1.fdate,year(t1.fdate)*100+month(t1.fdate) fyearpeiod
	from poorder t1
	inner join poorderentry t2 on t1.finterid=t2.finterid
	inner join t_supplier t3 on t1.fsupplyid=t3.fitemid
	inner join t_icitem t4 on t4.fitemid=t2.fitemid
	--inner join t_item t10 on t10.fitemid=t4.F_105 and t10.fitemclassid=3002 and t10.fitemid<>0
	where t1.fstatus>0 and t2.ftaxprice>0 
	--and t1.fdate>='2014-04-01' and t1.fdate<='2014-04-30'
	--and t4.fnumber like '2.%'
	and t1.fdate>=@fbegdate and t1.fdate<=@fenddate
	and t3.fname like '%'+@fsupplyname+'%' and t4.fnumber like ''+@fnumber+'%' and t4.fname like '%'+@fitemname+'%' and isnull(t4.fmodel,'') like '%'+@fitemmodel+'%'
) t1
group by t1.fsupplyid,t1.fitemid,t1.fyearpeiod,t1.fdate
order by t1.fitemid,t1.fyearpeiod,t1.fdate

select t1.fitemid,t1.fsupplyid,isnull(max(isnull(t1.fprice,0)),0) fprice,isnull(max(isnull(t1.fprice1,0)),0) fprice1,
isnull(max(isnull(t1.fprice2,0)),0) fprice2,
isnull(max(isnull(t1.fprice3,0)),0) fprice3,isnull(max(isnull(t1.fprice4,0)),0) fprice4,
isnull(max(isnull(t1.fprice5,0)),0) fprice5,isnull(max(isnull(t1.fprice6,0)),0) fprice6
into #init
from
(
	select t2.fitemid,t1.fsupplyid,t2.fprice,
	(case when t2.fqty>=1 and t2.fqty<=500 then t2.ftaxprice else 0 end) fprice1,
	(case when t2.fqty>=501 and t2.fqty<=1000 then t2.ftaxprice else 0 end) fprice2,
	(case when t2.fqty>=1001 and t2.fqty<=2000 then t2.ftaxprice else 0 end) fprice3,
	(case when t2.fqty>=2001 and t2.fqty<=3000 then t2.ftaxprice else 0 end) fprice4,
	(case when t2.fqty>=3001 and t2.fqty<=5000 then t2.ftaxprice else 0 end) fprice5,
	(case when t2.fqty>=5001  then t2.ftaxprice else 0 end) fprice6,
	t1.fdate,year(t1.fdate)*100+month(t1.fdate) fyearpeiod
	from poorder t1
	inner join poorderentry t2 on t1.finterid=t2.finterid
	inner join t_supplier t3 on t1.fsupplyid=t3.fitemid
	inner join t_icitem t4 on t4.fitemid=t2.fitemid
	inner join 
	(
		select t2.fitemid,t1.fsupplyid,max(t1.finterid) finterid
		from poorder t1
		inner join poorderentry t2 on t1.finterid=t2.finterid
		inner join t_supplier t3 on t1.fsupplyid=t3.fitemid
		inner join t_icitem t4 on t4.fitemid=t2.fitemid
		where t1.fstatus>0 and t2.ftaxprice>0 
		and t1.fdate<@fbegdate --and t4.fnumber like '2.%'
		--and t1.fdate>=@fbegdate and t1.fdate<=@fenddate
		and t3.fname like '%'+@fsupplyname+'%' and t4.fnumber like ''+@fnumber+'%' and t4.fname like '%'+@fitemname+'%' and isnull(t4.fmodel,'') like '%'+@fitemmodel+'%'
		group by t2.fitemid,t1.fsupplyid
	) t5 on t1.fsupplyid=t5.fsupplyid and t2.fitemid=t5.fitemid and t1.finterid=t5.finterid

) t1
group by t1.fsupplyid,t1.fitemid

create table #datainit(fitemid int,fsupplyid int,fqty int,fprice decimal(24,2) default 0)

if @ftype='无'
begin
	insert into #datainit(fsupplyid,fitemid,fqty,fprice)
	select t1.fsupplyid,t1.fitemid,0,isnull(max(isnull(t2.fprice,0)),0) fprice
	from #data t1 
	left join #init t2 on t1.fsupplyid=t2.fsupplyid and t1.fitemid=t2.fitemid
	group by t1.fsupplyid,t1.fitemid
end

if @ftype='有'
begin
	insert into #datainit(fsupplyid,fitemid,fqty,fprice)
	
	select t1.fsupplyid,t1.fitemid,500,isnull(max(isnull(t2.fprice1,0)),0) fprice
	from #data t1 
	left join #init t2 on t1.fsupplyid=t2.fsupplyid and t1.fitemid=t2.fitemid
	group by t1.fsupplyid,t1.fitemid

	union all
	select t1.fsupplyid,t1.fitemid,1000,isnull(max(isnull(t2.fprice2,0)),0) fprice
	from #data t1 
	left join #init t2 on t1.fsupplyid=t2.fsupplyid and t1.fitemid=t2.fitemid
	group by t1.fsupplyid,t1.fitemid

	union all
	select t1.fsupplyid,t1.fitemid,2000,isnull(max(isnull(t2.fprice3,0)),0) fprice
	from #data t1 
	left join #init t2 on t1.fsupplyid=t2.fsupplyid and t1.fitemid=t2.fitemid
	group by t1.fsupplyid,t1.fitemid

	union all
	select t1.fsupplyid,t1.fitemid,3000,isnull(max(isnull(t2.fprice4,0)),0) fprice
	from #data t1 
	left join #init t2 on t1.fsupplyid=t2.fsupplyid and t1.fitemid=t2.fitemid
	group by t1.fsupplyid,t1.fitemid

	union all
	select t1.fsupplyid,t1.fitemid,5000,isnull(max(isnull(t2.fprice5,0)),0) fprice
	from #data t1 
	left join #init t2 on t1.fsupplyid=t2.fsupplyid and t1.fitemid=t2.fitemid
	group by t1.fsupplyid,t1.fitemid

	union all
	select t1.fsupplyid,t1.fitemid,999999,isnull(max(isnull(t2.fprice6,0)),0) fprice
	from #data t1 
	left join #init t2 on t1.fsupplyid=t2.fsupplyid and t1.fitemid=t2.fitemid
	group by t1.fsupplyid,t1.fitemid
end

/*
select fsupplyid,fitemid,fqty,fprice from #datainit order by fsupplyid,fitemid,fqty
select * from #data order by fsupplyid,fitemid
*/

--declare @fbegdate datetime,@fenddate datetime select @fbegdate='2014-04-01',@fenddate='2014-04-30'
declare @fitemid int,@fsupplyid int,@fprice decimal(24,4),@fprice1 decimal(24,4),@fqty int

declare @sqls varchar(8000),@sqls1 varchar(8000),@sqls2 varchar(8000),@sqls3 varchar(8000)
declare @i int,@iCount int,@iDifCount int,@j int
declare @varDate datetime,@fpredate datetime
declare @varStrDate varchar(12),@varStrDateS varchar(8000),@varDifStrDate varchar(12)

create table #temp(fsupplyid int,fitemid int,fqty int,fprice decimal(24,2) default 0)  --drop table #temp


--添加字段

set @sqls=''

set @i=0

select @iCount=Datediff(day,@fbegdate,@fenddate)

while @i<=@iCount
begin
  set @varStrDate=replace(convert(varchar(10),Dateadd(day,@i,@fbegdate),111),'/','-')
  set @sqls=@sqls+'alter table #temp add ['+@varStrDate+'] decimal(24,2) default 0 '
  set @i=@i+1
end 

--print @sqls

execute (@sqls)   

-----------------------------------------------------
DECLARE authorsentry_cursor CURSOR FOR	
select t1.fsupplyid,t1.fitemid,t1.fqty,t1.fprice
from #datainit t1 
order by t1.fsupplyid,t1.fitemid,t1.fqty

OPEN authorsentry_cursor

FETCH NEXT FROM authorsentry_cursor 
INTO @fsupplyid,@fitemid,@fqty,@fprice

WHILE @@FETCH_STATUS = 0 
BEGIN
	set @sqls1='select '+cast(@fsupplyid as varchar(50))+' fsupplyid,'+cast(@fitemid as varchar(50))+' fitemid,'+cast(@fqty as varchar(50))+' fqty,'+cast(@fprice as varchar(50))+' fprice,'

	set @i=0

	select @iCount=Datediff(day,@fbegdate,@fenddate)

	while @i<=@iCount  --要完善
	begin
		set @varStrDate=replace(convert(varchar(10),Dateadd(day,@i,@fbegdate),111),'/','-')
		
		if @fqty=0
			set @sqls1=@sqls1+'(case when fdate='+''''+@varStrDate +''''+ ' then fprice else 0 end) '+''''+@varStrDate+''''+','
				
		if @fqty=500
			set @sqls1=@sqls1+'(case when fdate='+''''+@varStrDate +''''+ ' then fprice1 else 0 end) '+''''+@varStrDate+''''+','
		
		if @fqty=1000
			set @sqls1=@sqls1+'(case when fdate='+''''+@varStrDate +''''+ ' then fprice2 else 0 end) '+''''+@varStrDate+''''+','
		
		if @fqty=2000
			set @sqls1=@sqls1+'(case when fdate='+''''+@varStrDate +''''+ ' then fprice3 else 0 end) '+''''+@varStrDate+''''+','
		
		if @fqty=3000
			set @sqls1=@sqls1+'(case when fdate='+''''+@varStrDate +''''+ ' then fprice4 else 0 end) '+''''+@varStrDate+''''+','
		
		if @fqty=5000
			set @sqls1=@sqls1+'(case when fdate='+''''+@varStrDate +''''+ ' then fprice5 else 0 end) '+''''+@varStrDate+''''+','
		
		if @fqty=999999
			set @sqls1=@sqls1+'(case when fdate='+''''+@varStrDate +''''+ ' then fprice6 else 0 end) '+''''+@varStrDate+''''+','
										
		set @i=@i+1
	end 

	set @sqls1=substring(@sqls1,1,len(@sqls1)-1)
	set @sqls1=@sqls1+' from #data where fsupplyid='+cast(@fsupplyid as varchar(50))+' and fitemid='+cast(@fitemid as varchar(50)) 

	--print @sqls1

	--execute (@sqls1)  --结合下面的SQL执行 

	--汇总-------------------------------------------------------------------
	set @sqls='insert into #temp select '+cast(@fsupplyid as varchar(50))+' fsupplyid,'+cast(@fitemid as varchar(50))+' fitemid,'+cast(@fqty as varchar(50))+' fqty,'+cast(@fprice as varchar(50))+' fprice,'

	set @i=0

	select @iCount=Datediff(day,@fbegdate,@fenddate)

	while @i<=@iCount
	begin
	  set @varStrDate=replace(convert(varchar(10),Dateadd(day,@i,@fbegdate),111),'/','-')
	  set @sqls=@sqls+'isnull(sum(['+@varStrDate +']),0) '+''''+@varStrDate+''''+','
	  set @i=@i+1
	end 

	set @sqls=substring(@sqls,1,len(@sqls)-1)
	set @sqls=@sqls+' from ('+@sqls1+') t1  '  

	--print @sqls

	execute (@sqls)   --
	
	FETCH NEXT FROM authorsentry_cursor 
	INTO @fsupplyid,@fitemid,@fqty,@fprice
END

CLOSE authorsentry_cursor
DEALLOCATE authorsentry_cursor
	
--select * from #datainit

--select * from #temp

--没有数据的日期字段要删掉
select t3.fnumber 厂商编码,t3.fshortname 厂商名称,t4.fshortnumber 物料编码,t4.fname 名称,t4.fmodel 规格型号,
t1.fqty 数量段,t5.fname 单位,t1.fprice 原单价,
--t1.fdate1 日期一,t1.fprice1 单价一,t1.fdate2 日期二,t1.fprice2 单价二,
t1.*
from #temp t1
inner join t_supplier t3 on t1.fsupplyid=t3.fitemid
inner join t_icitem t4 on t4.fitemid=t1.fitemid
inner join t_measureunit t5 on t5.fitemid=t4.funitid
order by t3.fname,t4.fnumber,t1.fqty

drop table #datainit
drop table #data
drop table #temp
drop table #init

set nocount off

go

--产品标准资料
IF EXISTS (select * from sysobjects where name='My_p_GetProStandWeight' and xtype='p')  drop  procedure My_p_GetProStandWeight

go

create procedure My_p_GetProStandWeight

as 

set nocount on  --select * from t_item where fitemclassid=3002

declare @fitemid int,@fpacksubid int

create table #data(fitemid int,fpacksubid int)

--工厂标准--傲威标准--
DECLARE icbom_cursor CURSOR FOR	
select t2.fbrandid fpacksubid,t2.fproductid fitemid 
from t_item t1 
inner join t_bospacksub t2 on t1.fitemid=t2.fbrandid
where fitemclassid=3002 
and (fnumber like 'A.1.%' or fnumber like 'B.1.%' )
and fname not like '%裸包%' 
order by t2.fproductid,t1.fnumber

OPEN icbom_cursor

FETCH NEXT FROM icbom_cursor 
INTO @fpacksubid,@fitemid

WHILE @@FETCH_STATUS = 0
BEGIN 
	if not exists(select fitemid from #data where fitemid=@fitemid)
	begin
		insert into #data(fitemid, fpacksubid )
		values(           @fitemid,@fpacksubid)
	end

	FETCH NEXT FROM icbom_cursor 
    INTO @fpacksubid,@fitemid
END

CLOSE icbom_cursor
DEALLOCATE icbom_cursor

--select * from #data

--有下单的产品用得最多的包装方式
insert into #data(fitemid,fpacksubid)
select fitemid,min(fpacksubid) fpacksubid 
from
(
	select t1.fitemid,fpacksubid,t1.fcount
	from
	(
		select t1.fitemid,t1.fentryselfs0158 fpacksubid,count(1) fcount 
		from seorderentry t1 inner join t_item t2 on t1.fentryselfs0158=t2.fitemid 
		where isnull(t1.fentryselfs0158,0)>0 and t2.fname not like '%裸包%'
		group by t1.fitemid,t1.fentryselfs0158
	) t1 inner join 
	(
		select fitemid,max(fcount) fcount
		from
		(
			select t1.fitemid,t1.fentryselfs0158 fpacksubid,count(1) fcount 
			from seorderentry t1 inner join t_item t2 on t1.fentryselfs0158=t2.fitemid 
			where isnull(t1.fentryselfs0158,0)>0 and t2.fname not like '%裸包%'
			group by t1.fitemid,t1.fentryselfs0158
		) t1 group by fitemid
	) t2 on t1.fitemid=t2.fitemid and t1.fcount=t2.fcount
) t1 where fitemid not in (select fitemid from #data) group by fitemid
order by fitemid

--剩余的非裸包
insert into #data(fitemid,fpacksubid)
select min(t2.fbrandid) fpacksubid,t2.fproductid fitemid 
from t_item t1 
inner join t_bospacksub t2 on t1.fitemid=t2.fbrandid
where fitemclassid=3002 
and fname not like '%裸包%' and t2.fproductid not in (select fitemid from #data) 
group by t2.fproductid

--剩余的裸包
insert into #data(fitemid,fpacksubid)
select min(t2.fbrandid) fpacksubid,t2.fproductid fitemid 
from t_item t1 
inner join t_bospacksub t2 on t1.fitemid=t2.fbrandid
where fitemclassid=3002 
and fname like '%裸包%' and t2.fproductid not in (select fitemid from #data) 
group by t2.fproductid

select identity(int,1,1) as findex,*
into #t1
from
(
	--半成品
	select isnull(t9.fname,'') fpacktype,isnull(t11.FBoxCount,0) FBoxCount,
	t4.fitemid forderentryid,999 fentryid,t4.fnumber,t4.fname,t4.fmodel,
	0 fnetweight,--整箱净重
	0 fgrossweight,--整箱毛重--0 fcartonnetweight,0 fallweight,
	isnull(t3.fnumber,'') fchilditemnumber,isnull(t3.fname,'') fchilditemname,
	isnull(t3.fmodel,'') fchilditemmodel,
	isnull(t3.fnetweight,0) fbanchengpinweight,--半成品重量
	isnull(t8.fheijiaodaiweight,0) fheijiaodaiweight,--黑胶袋重量--放在半成品下面,不是放在成品下面
	0 fqizhudaiweight,--气柱袋重量
	0 fcaiheweight,--彩盒重量
	0 fzhixiangweight,--纸箱重量
	isnull(t5.fname,'') funit,1 forderqty,1 fqty,1*1 fqtymust
	from 
	(
		select t4.fitemid,max(t11.fitemid) fchilditemid
		from icbomchild t6 --点零版本子项
		inner join icbom t7 on t6.finterid=t7.finterid  --点零版本BOM
		inner join t_icitem t4 on t7.fitemid=t4.fitemid --成品
		inner join t_icitem t10 on t10.fitemid=t6.fitemid --点零版本子项
		inner join t_icitem t11 on left(t10.fnumber,9)=left(t11.fnumber,9) --
		inner join icbom t2 on t11.fitemid=t2.fitemid and t2.fusestatus=1072
		WHERE left(t4.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0) 
		and t7.fusestatus=1072 and t11.fnetweight>0
		group by t4.fitemid--,t11.fitemid
	) t1 inner join t_icitem t4 on t1.fitemid=t4.fitemid --成品
	inner join t_icitem t3 on t1.fchilditemid=t3.fitemid 
	inner join icbom t2 on t3.fitemid=t2.fitemid
	inner join (select m1.finterid,sum(isnull(m3.fnetweight,0)*m2.fqty) fheijiaodaiweight from icbom m1 inner join icbomchild m2 on m1.finterid=m2.finterid inner join t_icitem m3 on m2.fitemid=m3.fitemid where m3.fnumber like '2.23.%' group by m1.finterid) t8 on t8.finterid=t2.finterid
	inner join t_measureunit t5 on t5.fitemid=t3.funitid
	inner join t_BOSPackSub t11 on t11.fproductid=t4.fitemid --and t11.fbrandid=@fpacksubid
	inner join #data t12 on t12.fitemid=t11.fproductid and t12.fpacksubid=t11.fbrandid
	inner join t_item t9 on t9.fitemclassid=3002 and t9.fitemid=t11.fbrandid
	WHERE left(t4.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0) 
	union all
	--包材
	select isnull(t9.fname,'') fpacktype,
	isnull(t1.FBoxCount,0) FBoxCount,t3.fitemid forderentryid,
	case when t2.FIndex=0 then 1 else isnull(t2.FIndex,111) end fentryid,
	t3.fnumber,t3.fname,t3.fmodel,
	0 fnetweight,--整箱净重
	0 fgrossweight,--整箱毛重,--0 fcartonnetweight,0 fallweight,
	isnull(t4.fnumber,'') fchilditemnumber,isnull(t4.fname,'') fchilditemname,isnull(t4.fmodel,'') fchilditemmodel,
	0 fbanchengpinweight,--半成品重量
	--(case when left(isnull(t4.fnumber,''),5)<>'2.23.' then 0 else isnull(t2.fqty,0)*isnull(t4.fnetweight,0) end) fheijiaodaiweight,--黑胶袋重量
	0 fheijiaodaiweight,--黑胶袋重量
	(case when left(isnull(t4.fnumber,''),5)<>'2.21.' then 0 else isnull(t2.fqty,0)*isnull(t4.fnetweight,0) end) fqizhudaiweight,--气柱袋重量
	(case when left(isnull(t4.fnumber,''),5) not in ('2.02.','2.03.','2.04.') then 0 else isnull(t2.fqty,0)*isnull(t4.fnetweight,0) end) fcaiheweight,--彩盒重量
	(case when left(isnull(t4.fnumber,''),5)='2.01.' then 1*isnull(t4.fnetweight,0) else 0 end) fzhixiangweight,--纸箱重量--用量取1
	isnull(t5.fname,'') funit,1 forderqty,
	isnull(t2.fqty,0) fqty,CEILING(1*isnull(t2.fqty,0)) fqtymust
	from t_icitem t6 
	inner join t_BOSPackSub t1 on t1.fproductid=t6.fitemid --and t1.fbrandid=@fpacksubid
	inner join t_BOSPackSubEntry t2 on t1.fid=t2.fid
	inner join t_icitem t4 on t2.fitemid=t4.fitemid
	inner join t_measureunit t5 on t5.fitemid=t4.funitid
	inner join t_icitem t3 on t6.fitemid=t3.fitemid
	inner join #data t12 on t12.fitemid=t1.fproductid and t12.fpacksubid=t1.fbrandid
	inner join t_item t9 on t9.fitemclassid=3002 and t9.fitemid=t1.fbrandid
	WHERE left(t6.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0)
) t1
order by forderentryid,fentryid

--select * from #t1

--半成品
update t1 set fbanchengpinweight=isnull(t2.fbanchengpinweight,0)
from #t1 t1
inner join (select forderentryid,min(findex) findex,sum(isnull(fbanchengpinweight,0)) fbanchengpinweight from #t1 group by forderentryid) t2 on t1.forderentryid=t2.forderentryid
where t1.findex=t2.findex

--主供应商非鑫威
update t1 set fbanchengpinweight=isnull(t2.fbanchengpinweight,0)
from #t1 t1
inner join (select forderentryid,min(findex) findex,sum(isnull(fbanchengpinweight,0)) fbanchengpinweight from #t1 group by forderentryid) t2 on t1.forderentryid=t2.forderentryid
inner join t_icitem t3 on t3.fitemid=t2.forderentryid
where t1.findex=t2.findex and isnull(t3.F_117,0) not in (0,25952)
and t3.fnetweight>0 


--黑胶袋
update t1 set fheijiaodaiweight=isnull(t2.fheijiaodaiweight,0)
from #t1 t1
inner join (select forderentryid,min(findex) findex,sum(isnull(fheijiaodaiweight,0)) fheijiaodaiweight from #t1 group by forderentryid) t2 on t1.forderentryid=t2.forderentryid
where t1.findex=t2.findex

--气柱袋
update t1 set fqizhudaiweight=isnull(t2.fqizhudaiweight,0)
from #t1 t1
inner join (select forderentryid,min(findex) findex,sum(isnull(fqizhudaiweight,0)) fqizhudaiweight from #t1 group by forderentryid) t2 on t1.forderentryid=t2.forderentryid
where t1.findex=t2.findex

--彩盒
update t1 set fcaiheweight=isnull(t2.fcaiheweight,0)
from #t1 t1
inner join (select forderentryid,min(findex) findex,sum(isnull(fcaiheweight,0)) fcaiheweight from #t1 group by forderentryid) t2 on t1.forderentryid=t2.forderentryid
where t1.findex=t2.findex

--纸箱
update t1 set fzhixiangweight=isnull(t2.fzhixiangweight,0)
from #t1 t1
inner join (select forderentryid,min(findex) findex,sum(isnull(fzhixiangweight,0)) fzhixiangweight from #t1 group by forderentryid) t2 on t1.forderentryid=t2.forderentryid
where t1.findex=t2.findex

--整箱净重=半成品净重×装箱数
update t1 set fnetweight=isnull(t1.fbanchengpinweight,0)*t1.fboxcount
from #t1 t1
inner join (select forderentryid,min(findex) findex from #t1 group by forderentryid) t2 on t1.forderentryid=t2.forderentryid
where t1.findex=t2.findex

--整箱毛重=(半成品净重+黑胶袋+气柱袋+彩盒)×装箱数+纸箱
update t1 set fgrossweight=(isnull(t1.fbanchengpinweight,0)+isnull(t1.fheijiaodaiweight,0)+isnull(t1.fqizhudaiweight,0)+isnull(t1.fcaiheweight,0))*t1.fboxcount+isnull(t1.fzhixiangweight,0)
from #t1 t1
inner join 
(
	select forderentryid,min(findex) findex
	from #t1 
	group by forderentryid
) t2 on t1.forderentryid=t2.forderentryid
where t1.findex=t2.findex

update t1 set fgrossweight=0
from #t1 t1
inner join 
(
	select forderentryid,min(findex) findex
	from #t1 
	group by forderentryid
) t2 on t1.forderentryid=t2.forderentryid
where t1.findex=t2.findex and (isnull(t1.fbanchengpinweight,0)=0 or isnull(t1.fheijiaodaiweight,0)=0 or isnull(t1.fqizhudaiweight,0)=0 or isnull(t1.fcaiheweight,0)=0 or isnull(t1.fzhixiangweight,0)=0)

--update t1 set fallweight=isnull(t1.fgrossweight,0)*t1.fboxcount+isnull(t1.fcartonnetweight,0) 
--from #t1 t1
--inner join (select forderentryid,min(findex) findex from #t1 group by forderentryid) t2 on t1.forderentryid=t2.forderentryid
--where t1.findex=t2.findex

update t1 set fnumber='',fname='',fmodel='',fpacktype='',FBoxCount=null,
fnetweight=null,fgrossweight=null,fbanchengpinweight=null,fheijiaodaiweight=null,
fqizhudaiweight=null,fcaiheweight=null,fzhixiangweight=null
from #t1 t1
left join (select forderentryid,min(findex) findex from #t1 group by forderentryid) t2 on t1.forderentryid=t2.forderentryid
where t1.findex<>t2.findex

delete t1 from #t1 t1 where left(t1.fnumber,1) not in (select fitemtype from v_myitemtype where ftype=0) and fentryid in (999,888)

select distinct fnumber 产品编码,fname 产品名称,fmodel 产品规格,
fbanchengpinweight [半成品(g)],fheijiaodaiweight [黑胶袋(g)],fqizhudaiweight [气柱袋(g)],fcaiheweight [彩盒(g)],fzhixiangweight [纸箱(g)],
FBoxCount 装箱数,cast(fnetweight as decimal(24,2)) [整箱净重(kg)],cast(fgrossweight as decimal(24,2)) [整箱毛重(kg)],--fcartonnetweight 纸箱净重,fallweight 整箱毛重,
fpacktype 包装方式
--,
--fentryid 序号,fchilditemnumber 物料编码,fchilditemname 物料名称,fchilditemmodel 物料规格,
--funit 单位,forderqty 订单数,fqty 单位用量,fqtymust 应发数
FROM #t1 where fnumber<>'' and fbanchengpinweight<>0

drop table #t1
drop table #data

set nocount off


go

--物料需求计划跟踪--横排--
--My_P_MaterielNeedPlan 16394,3,0
IF EXISTS (select * from sysobjects where name='My_P_MaterielNeedPlan' and xtype='p')  drop  procedure My_P_MaterielNeedPlan
go

create procedure [dbo].My_P_MaterielNeedPlan(@fuserid int,@fitemtype int,@ftype int) --@fitemtype  1 半成品  2 常规物料 3 包材 0 全部  --@ftype 0 全部 1 选中任务单

as

set nocount on

--declare @fuserid int,@fitemtype int,@ftype int,@fenddate datetime select @fuserid=16394,@fitemtype=1,@ftype=0 ,@fenddate='2013-05-15'

declare @fdeptid int,@fitemid int,@fpqty decimal(24,2),@forderinterid int,@s varchar(8000),@forderbillno varchar(50)
declare @fqty decimal(24,4),@fplanqty decimal(24,4),@fstockqty decimal(24,4),@FWillInStockQty decimal(24,4),@FRoughNeedQty decimal(24,4)
declare @FCanUseStockQty decimal(24,4),@FNeedQty decimal(24,4),@fsourceinterid int,@fplandate datetime,@fentryid int
declare @fbegdate datetime,@fneeddate datetime,@finvdate datetime,@fcaldate datetime,@FOrderBillLike varchar(120),@fsourceentryid int
declare @fsendenddate datetime,@iRunID int, @iYear int,@iPeriod int,@fpackoutstockinterid int,@i int,@fnumbermatch varchar(20)
declare @ficmointerid int,@fplancommitdate datetime,@FPrepareDays int,@sqls varchar(8000),@iCount int,@frunid int
declare @varStrDate varchar(30),@sqls1 varchar(8000),@j int,@iCount2 int
declare @FProductProspectDays int,@FHalfProductProspectDays int,@FProductPrepareDays int,@FHalfProductPrepareDays int

select @FProductProspectDays=fvalue from t_SystemProfile where FCategory='IC' and fkey='FProductProspectDays' 
select @FHalfProductProspectDays=fvalue from t_SystemProfile where FCategory='IC' and fkey='FHalfProductProspectDays' 
select @FProductPrepareDays=fvalue from t_SystemProfile where FCategory='IC' and fkey='FProductPrepareDays' 
select @FHalfProductPrepareDays=fvalue from t_SystemProfile where FCategory='IC' and fkey='FHalfProductPrepareDays' 

select @s='',@i=1

declare @fdate datetime,@fmaxdate datetime

select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期

create table #My_t_MrpRoughNeedSource(frunid int,ftrantype int,fsourceinterid int,fsourceentryid int,
fitemid int,fqty decimal(24,2),fpackinterid int,fneeddate datetime) 

create table #data(fnumber varchar(50),fplancommitdate datetime,fqty decimal(24,4),fsourceinterid int,
fsourceentryid int,fitemid int,fauxqtyscrap decimal(24,4),fscrap decimal(24,4),FPrepareDays int)

create table #temp(fitemid int)

create table #My_t_MrpWillInStock(fdate datetime,frunid int,ftrantype int,finterid int ,fentryid int,fitemid int,fqty decimal(24,0)) --1 外购  3 委外
create table #My_t_TempInventory(fdate datetime,frunid int,ftrantype int,finterid int ,fentryid int,fitemid int,fqty decimal(24,0)) --1 外购  3 委外

create table #My_t_MrpStock(frunid int,fstockid int,fitemid int,fqty decimal(24,0)) 

--投料单未发数--按生产计划分摊到日需求中--生产任务单中 成品是30天 半成品是15天

--成品
insert into #data(fnumber,fplancommitdate,fqty,fsourceinterid,fsourceentryid,fitemid,fauxqtyscrap,fscrap,FPrepareDays)
select t4.fnumber,--(case when t6.FHeadSelfS0154<@fdate then @fdate else t6.FHeadSelfS0154 end) fplancommitdate,--如果计划开工日期小于当天,则该任务单的需求日期则为当天
t6.FHeadSelfS0148 fplancommitdate,(t3.fqtymust-t3.fstockqty) fqty,
t5.finterid fsourceinterid,0 fsourceentryid,t3.fitemid,t3.fauxqtyscrap,t3.fscrap,
(case when isnull(t5.forderinterid,0)<>0 then @FProductPrepareDays else @FHalfProductPrepareDays end) FPrepareDays  --成品直接下级则取成品的准备期，否则则取半成品的准备期
from icmo t5 
inner join ppbom t2 on t5.finterid=t2.ficmointerid
inner join ppbomentry t3 on t2.finterid=t3.finterid
inner join t_icitem t4 on t3.fitemid=t4.fitemid --子项
inner join t_icitem t8 on t5.fitemid=t8.fitemid --父项
inner join seorderentry t1 on t1.finterid=t5.forderinterid and t1.fentryid=t5.fsourceentryid 
inner join seorder t6 on t6.finterid=t1.finterid
where t5.fstatus in (1,2,5) and (t3.fqtymust-t3.fstockqty)>0 and isnull(t1.fmrpclosed,0)=0
and t6.FHeadSelfS0148>=@fdate --只考虑交期为当天以后的--当天之前的视为已出货
and isnull(t6.FHeadSelfS0147,0) not in (40032,40033) --40032	样品订单-收费 40033	样品订单-免费
and t4.fnumber not like '1.02.%' and t4.fnumber not like '6.%'
and left(t4.fnumber,1) not in (select fitemtype from v_myitemtype where ftype=0) 

--半成品
insert into #data(fnumber,fplancommitdate,fqty,fsourceinterid,fsourceentryid,fitemid,fauxqtyscrap,fscrap,FPrepareDays)
select t4.fnumber,Null fplancommitdate,(t3.fqtymust-t3.fstockqty) fqty,
t5.finterid fsourceinterid,0 fsourceentryid,t3.fitemid,t3.fauxqtyscrap,t3.fscrap,
(case when isnull(t5.forderinterid,0)<>0 then @FProductPrepareDays else @FHalfProductPrepareDays end) FPrepareDays  --成品直接下级则取成品的准备期，否则则取半成品的准备期
from icmo t5 
inner join ppbom t2 on t5.finterid=t2.ficmointerid
inner join ppbomentry t3 on t2.finterid=t3.finterid
inner join t_icitem t4 on t3.fitemid=t4.fitemid --子项
inner join t_icitem t8 on t5.fitemid=t8.fitemid --父项
where t5.fstatus in (1,2,5) and (t3.fqtymust-t3.fstockqty)>0 
and isnull(t5.forderinterid,0)=0
and t4.fnumber not like '1.02.%' and t4.fnumber not like '6.%'

--半成品的需求日期--如果有滚动，则取最小日期
update t2 set fplancommitdate=t1.fdate
from
(
	select t1.fsourceinterid,min(t6.fdate) fdate
	from #data t1
	inner join icmo t2 on t1.fsourceinterid=t2.finterid
	inner join my_t_scheduledetail t6 on t6.ficmointerid=t1.fsourceinterid  
	where t1.fplancommitdate is null and t6.fdate>=@fdate  --今天开始计起
	group by t1.fsourceinterid
) t1 inner join #data t2 on t1.fsourceinterid=t2.fsourceinterid

--半成品的需求日期--如果没有滚动，则默认为当天
update t1 set fplancommitdate=@fdate
from #data t1
inner join icmo t2 on t1.fsourceinterid=t2.finterid
where t1.fplancommitdate is null 

if @ftype=1  --暂不起作用
begin
	delete t5
	from #data t5 
	where t5.fitemid not in (
		select t5.fitemid
		from #data t5 
		inner join my_t_icmotemp t1 on t1.finterid=t5.fsourceinterid and t1.fuserid=@fuserid)
	
	select @fmaxdate=max(t1.fplancommitdate) --大于选中的任务单的最大订单交期的订单不跟踪
	from
	(
		select (case when t6.FHeadSelfS0154<@fdate then @fdate else t6.FHeadSelfS0154 end) fplancommitdate
		from icmo t5 
		inner join seorderentry t1 on t1.finterid=t5.forderinterid and t1.fentryid=t5.fsourceentryid 
		inner join seorder t6 on t6.finterid=t1.finterid
		inner join my_t_icmotemp t11 on t11.finterid=t5.finterid and t11.fuserid=@fuserid
	) t1
	
	if @fmaxdate is not null
		delete t5 from #data t5 where fplancommitdate>@fmaxdate
end

--@fitemtype  1 半成品  2 常规物料 3 包材
if @fitemtype=1
	delete from #data where fnumber not like '3.%' and fnumber not like '4.%' and fnumber not like '5.%' and fnumber not like '7.%' and fnumber not like '8.%'  --3.  4. 前缀物料编码为半成品
else if @fitemtype=3
	delete from #data where fnumber not like '2.%'   --2. 前缀物料编码为包材
else if @fitemtype=2
	delete from #data where fnumber like '3.%' or fnumber like '4.%' or fnumber like '5.%' or fnumber like '7.%' or fnumber like '8.%' or fnumber like '2.%' 

--delete from #data where fnumber like '2.01%' --纸箱

insert into #My_t_MrpRoughNeedSource(fneeddate,         ftrantype,frunid, fsourceinterid,    fsourceentryid,  fitemid,    fqty)
select                               t1.fplancommitdate,85,       @frunid,t1.fsourceinterid, 0,               t1.fitemid, t1.fqty
from #data t1

--毛需求--随单出货外购件
insert into #My_t_MrpRoughNeedSource(fneeddate, ftrantype,frunid, fsourceinterid,fsourceentryid,fitemid,   fqty   )
select	                            (case when t5.FHeadSelfS0154<@fdate then @fdate else t5.FHeadSelfS0154 end) fplancommitdate,--如果计划开工日期小于当天,则该任务单的需求日期则为当天,  
												81,       @frunid,t4.finterid,   t4.fentryid,   t4.fitemid,t4.fqty-isnull(t4.fstockqty,0)
from seorderentry t4 
inner join seorder t5  on t5.finterid=t4.finterid
inner join t_icitem t8 on t8.fitemid=t4.fitemid
inner join t_Organization t6 on t5.FCustID=t6.fitemid
inner join t_department t11 on t11.fitemid=t5.fdeptid
where t8.ferpclsid=1 and t4.fmrpclosed<>1 and (t5.fstatus>0 or isnull(t5.FMultiCheckLevel1,0)>0) --and t5.fdate>='2011-07-01'
--and datediff(day,getdate(),t4.fdate)=@FProductProspectDays  --成品30天
and t4.fqty>t4.fstockqty and t5.FHeadSelfS0148>=@fdate --只考虑交期为当天以后的--当天之前的视为已出货

--@fitemtype  1 半成品  2 常规物料 3 包材
if @fitemtype=1
	delete t1 from #My_t_MrpRoughNeedSource t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid where t2.fnumber not like '3.%' and t2.fnumber not like '4.%' and t2.fnumber not like '5.%' and t2.fnumber not like '7.%' and t2.fnumber not like '8.%'  --3.  4. 前缀物料编码为半成品
else if @fitemtype=3
	delete t1 from #My_t_MrpRoughNeedSource t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid where t2.fnumber not like '2.%'   --2. 前缀物料编码为包材
else if @fitemtype=2
	delete t1 from #My_t_MrpRoughNeedSource t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid where t2.fnumber like '3.%' or t2.fnumber like '4.%' or t2.fnumber like '5.%' or t2.fnumber like '7.%' or t2.fnumber like '8.%' or t2.fnumber like '2.%' 


--预计入库--采购订单--未关闭--未关联
insert into #My_t_MrpWillInStock(fdate,frunid, ftrantype,finterid,   fentryid,   fitemid,   fqty)
select                           case when t2.fdate<@fdate then @fdate when datediff(day,getdate(),t2.fdate)>30 then DATEADD(day,30,getdate()) else t2.fdate end,--如果填的交货日期小于当天，则表明采购员所填交货日期是有变动的，按当天处理       
									   @frunid,71,       t2.finterid,t2.fentryid,t2.fitemid,(t2.fqty-t2.fcommitqty)
from poorderentry t2  
inner join poorder t1 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where --t1.FClosed<>1 
t2.fmrpclosed<>1 
--and t4.fnumber not like '08.11.%' --and t1.fstatus>0 
and t1.fstatus<>3  --采购订单收料完毕就关闭，但不一定已经入库
and t3.ferpclsid in (1) 
--and (t3.fnumber like 'H.%' or t3.fnumber like 'K.%' or t3.fnumber like 'M.%' or t3.fnumber like 'N.%')
and (t2.fqty-t2.fcommitqty)>0
and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource)

--预计入库--(采购申请单--已审核未关闭--未关联数)
insert into #My_t_MrpWillInStock(fdate,frunid, ftrantype,finterid,   fentryid,   fitemid,   fqty)
select                           case when t2.FFetchTime<@fdate then @fdate when datediff(day,getdate(),t2.FFetchTime)>30 then DATEADD(day,30,getdate()) else t2.FFetchTime end,--如果填的交货日期小于当天，则表明采购员所填交货日期是有变动的，按当天处理       
									   @frunid,70,       t2.finterid,t2.fentryid,t2.fitemid,t2.fqty-t2.fcommitqty
from porequest t1
inner join porequestentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where --t1.fstatus>0 and 
t1.fstatus<>3 --and t2.FFetchTime>=@fdate  --今天开始计起
and t2.fmrpclosed=0
--and t4.fnumber not like '08.11.%'
and t3.ferpclsid in (1)
--and (t3.fnumber like 'H.%' or t3.fnumber like 'K.%' or t3.fnumber like 'M.%' or t3.fnumber like 'N.%')
and (t2.fqty-t2.fcommitqty)>0 
and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource)

--预计入库(收料通知单--未审核)--
insert into #My_t_MrpWillInStock(fdate,   frunid,  ftrantype,  finterid,   fentryid,   fitemid,   fqty)
select                           case when t1.fdate<@fdate then @fdate when datediff(day,getdate(),t1.fdate)>30 then DATEADD(day,30,getdate()) else t1.fdate end,--如果填的交货日期小于当天，则表明采购员所填交货日期是有变动的，按当天处理       
								          @frunid, 72,         t2.finterid,t2.fentryid,t2.fitemid,t2.fqty
from poinstock t1
inner join poinstockentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where t1.fstatus=0
--and t4.fnumber not like '08.11.%'
and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource) and t1.ftrantype=72

--预计入库(塑胶子件收料申请单--未关闭--未关联数)
insert into #My_t_MrpWillInStock(fdate,   frunid,  ftrantype,  finterid,fentryid,   fitemid,   fqty)
select                           t1.fdate,@frunid, 200000022,  t2.fid,  t2.fentryid,t2.fitemid,t2.fqty-t2.fcommitqty
from t_BOSPlasticPoInStock t1 
inner join t_BOSPlasticPoInStockEntry t2 on t1.fid=t2.fid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
--inner join t_department t4 on t1.fdeptid=t4.fitemid
inner join poorderentry t7 on t7.finterid=t2.fid_src and t7.fentryid=t2.fentryid_src 
where t7.FMrpClosed<>1 and isnull(t2.fmrpclosed,0)<>40019 --and t1.fstatus>0 
and (t2.fqty-t2.fcommitqty)>0
and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource) --and t1.FClassTypeID=200000022


--预计入库--任务单
insert into #My_t_MrpWillInStock(frunid, ftrantype,finterid,   fentryid,fitemid,   fqty,                          fdate)
select                           @frunid,85,       t2.finterid,0,       t2.fitemid,t2.fqty-isnull(t2.fstockqty,0),t2.fplancommitdate
from icmo t2  
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t2.fworkshop=t4.fitemid
where t2.fstatus<>3
and (t2.fqty-isnull(t2.fstockqty,0))>0
and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource)

--待检--日期信息不重要

--待检(未审核的外购入库单)
insert into #My_t_TempInventory(fdate,   frunid, ftrantype,finterid,   fentryid,   fitemid,   fqty)
select                        t1.fdate,@frunid,1,        t2.finterid,t2.fentryid,t2.fitemid,t2.fqty
from icstockbill t1
inner join icstockbillentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where t1.fstatus=0 and t2.FSourceTranType=72 
--and t4.fnumber not like '08.11.%'
and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource) and t1.ftrantype=1

--待检(收料通知单--未关闭--未关联数)--已审核未关闭
insert into #My_t_TempInventory(fdate,   frunid,  ftrantype,  finterid,   fentryid,   fitemid,   fqty)
select                          t1.fdate,@frunid, 72,         t2.finterid,t2.fentryid,t2.fitemid,t2.fqty-t2.fcommitqty-t2.fbackqty
from poinstock t1
inner join poinstockentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where t1.fstatus>0 and t1.fstatus<>3 --
and t2.fqty>(t2.fcommitqty+t2.fbackqty)
--and t4.fnumber not like '08.11.%'
and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource) and t1.ftrantype=72

--库存
insert into #My_t_MrpStock(frunid, fitemid,   fstockid,   fqty)
select                     @frunid,t1.fitemid,t1.fstockid,t1.fqty
from icinventory t1
inner join t_ICItem t2 on t1.FItemID=t2.FItemID
inner join t_stock t3 on t3.fitemid=t1.fstockid
where --t2.ferpclsid in (1) and 
t1.fqty>0 --and t3.fname not like '%计划%' 
and t3.fname not like '%不良%' and t3.fname not like '%报废%'
--and t3.fnumber not like '11.%' 
--and (t2.fnumber like 'H.%' or t2.fnumber like 'K.%' or t2.fnumber like 'M.%' or t2.fnumber like 'N.%')
and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource)

insert into #My_t_MrpStock(frunid, fitemid,   fstockid,   fqty)
select @frunid,t1.fitemid,t1.fstockid,t1.fqty
from poinventory t1
inner join t_ICItem t2 on t1.FItemID=t2.FItemID
inner join t_stock t3 on t3.fitemid=t1.fstockid
where --t2.ferpclsid in (1) and 
t1.fqty>0 --and t3.fname not like '%计划%' 
and t3.fname not like '%不良%' and t3.fname not like '%报废%' and t3.fitemid=16483  --代管仓
--and t3.fnumber not like '11.%' 
--and (t2.fnumber like 'H.%' or t2.fnumber like 'K.%' or t2.fnumber like 'M.%' or t2.fnumber like 'N.%')
and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource)

--select * from ictranstype

----半成品只取展望期内的需求
--if @fitemtype=1
--begin
--	delete t1
--	from #My_t_MrpRoughNeedSource t1 
--	inner join t_icitem t2 on t1.fitemid=t2.fitemid
--	where t1.frunid=@frunid and datediff(day,getdate(),t1.fneeddate)>@FHalfProductProspectDays  --半成品展望期30天
--
--	delete t1
--	from #My_t_MrpWillInStock t1 
--	inner join t_icitem t2 on t1.fitemid=t2.fitemid
--	where t1.frunid=@frunid and datediff(day,getdate(),t1.fdate)>@FHalfProductProspectDays  --半成品展望期30天
--end
 
select cast(0 as bit) 选择,t2.fitemid 物料内码,t2.fnumber 物料编码,t2.fname 名称,t2.fmodel 规格型号,t3.fname 单位,
t9.fbillno 任务单号,isnull(t11.fbillno,'') 订单编号,isnull(t11.FHeadSelfS0144,'') 源销售订单号,isnull(t11.FHeadSelfS0143,'') 源采购订单号,
t1.fneeddate 需求日期,t5.fqty 未发总数,t1.fqty 未发数,isnull(t4.fqty,0) 库存,(isnull(t4.fqty,0)-t5.fqty) 库存余数,
isnull(t8.fqty,0) 待检,isnull(t6.fqty,0) 预计入库,
t1.fqty 预计可发,t1.fqty 库存可发
from #My_t_MrpRoughNeedSource t1 
inner join t_icitem t2 on t1.fitemid=t2.fitemid
inner join t_measureunit t3 on t2.funitid=t3.fitemid
inner join (select fitemid,sum(fqty) fqty from #data group by fitemid) t5 on t5.fitemid=t1.fitemid
left join (select fitemid,sum(isnull(fqty,0)) fqty from #My_t_TempInventory group by fitemid) t8 on t8.fitemid=t1.fitemid
left join (select fitemid,sum(isnull(fqty,0)) fqty from #My_t_MrpStock group by fitemid) t4 on t4.fitemid=t1.fitemid
left join (select fitemid,sum(isnull(fqty,0)) fqty from #My_t_MrpWillInStock group by fitemid) t6 on t6.fitemid=t1.fitemid
inner join icmo t9 on t9.finterid=t1.fsourceinterid
left join seorderentry t10 on t10.finterid=t9.forderinterid and t10.fentryid=t9.fsourceentryid
left join seorder t11 on t10.finterid=t11.finterid
where isnull(t5.fqty,0)>isnull(t4.fqty,0)
order by t2.fnumber,t1.fneeddate

--drop table #plantemp
--drop table #temp
--drop table #source
drop table #data
--drop table #my_t_MrpResultDetail
--drop table #sourcedata
drop table #My_t_MrpRoughNeedSource
drop table #My_t_MrpWillInStock
drop table #My_t_TempInventory
drop table #My_t_MrpStock

set nocount off

GO

--计划模拟--横排--只有生产计划和收料计划都正确的情况下数据分析才有意义
--My_P_SimulatePlanBySchedule 16394,1,0
IF EXISTS (select * from sysobjects where name='My_P_SimulatePlanBySchedule' and xtype='p')  drop  procedure My_P_SimulatePlanBySchedule
go

create procedure [dbo].My_P_SimulatePlanBySchedule(@fuserid int,@fitemtype int,@ftype int,@fenddate datetime) --@fitemtype  1 半成品  2 常规物料 3 包材 0 全部  --@ftype 0 全部 1 选中任务单

as

set nocount on

--declare @fuserid int,@fitemtype int,@ftype int select @fuserid=16394,@fitemtype=1,@ftype=0  

declare @fdeptid int,@fitemid int,@fpqty decimal(24,2),@forderinterid int,@s varchar(8000),@forderbillno varchar(50)
declare @fqty decimal(24,4),@fplanqty decimal(24,4),@fstockqty decimal(24,4),@FWillInStockQty decimal(24,4),@FRoughNeedQty decimal(24,4)
declare @FCanUseStockQty decimal(24,4),@FNeedQty decimal(24,4),@fsourceinterid int,@fplandate datetime,@fentryid int
declare @fbegindate datetime,@fbegdate datetime --,@fenddate datetime,
declare @fneeddate datetime,@finvdate datetime,@fcaldate datetime,@FOrderBillLike varchar(120),@fsourceentryid int
declare @fsendenddate datetime,@iRunID int, @iYear int,@iPeriod int,@fpackoutstockinterid int,@i int,@fnumbermatch varchar(20)
declare @ficmointerid int,@fplancommitdate datetime,@FPrepareDays int,@sqls varchar(8000),@iCount int,@frunid int
declare @varStrDate varchar(12),@sqls1 varchar(8000)
declare @FProductProspectDays int,@FHalfProductProspectDays int,@FProductPrepareDays int,@FHalfProductPrepareDays int

select @FProductProspectDays=fvalue from t_SystemProfile where FCategory='IC' and fkey='FProductProspectDays' 
select @FHalfProductProspectDays=fvalue from t_SystemProfile where FCategory='IC' and fkey='FHalfProductProspectDays' 
select @FProductPrepareDays=fvalue from t_SystemProfile where FCategory='IC' and fkey='FProductPrepareDays' 
select @FHalfProductPrepareDays=fvalue from t_SystemProfile where FCategory='IC' and fkey='FHalfProductPrepareDays' 

select @s='',@i=1

declare @fdate datetime
select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期

create table #My_t_MrpRoughNeedSource(frunid int,ftrantype int,fsourceinterid int,fsourceentryid int,
fitemid int,fqty decimal(24,2),fpackinterid int,fneeddate datetime) 

create table #data(fnumber varchar(50),fplancommitdate datetime,fqty decimal(24,4),fsourceinterid int,
fsourceentryid int,fitemid int,fauxqtyscrap decimal(24,4),fscrap decimal(24,4),FPrepareDays int)

create table #temp(fitemid int)

create table #My_t_MrpWillInStock(fdate datetime,frunid int,ftrantype int,finterid int ,fentryid int,fitemid int,fqty decimal(24,2)) --1 外购  3 委外
create table #My_t_TempInventory(fdate datetime,frunid int,ftrantype int,finterid int ,fentryid int,fitemid int,fqty decimal(24,0)) --1 外购  3 委外

create table #My_t_MrpStock(frunid int,fstockid int,fitemid int,fqty decimal(24,0)) 

--投料单未发数--按生产计划分摊到日需求中--生产任务单中 成品是30天 半成品是15天  --drop table #data

insert into #data(fnumber,fplancommitdate,fqty,fsourceinterid,fsourceentryid,fitemid,fauxqtyscrap,fscrap,FPrepareDays)
select t4.fnumber,t5.fplancommitdate,(t3.fqtymust-t3.fstockqty) fqty,
t5.finterid fsourceinterid,0 fsourceentryid,t3.fitemid,t3.fauxqtyscrap,t3.fscrap,
(case when isnull(t5.forderinterid,0)<>0 then @FProductPrepareDays else @FHalfProductPrepareDays end) FPrepareDays  --成品直接下级则取成品的准备期，否则则取半成品的准备期
from icmo t5 
inner join ppbom t2 on t5.finterid=t2.ficmointerid
inner join ppbomentry t3 on t2.finterid=t3.finterid
inner join t_icitem t4 on t3.fitemid=t4.fitemid --子项
inner join t_icitem t8 on t5.fitemid=t8.fitemid --父项
where t5.fstatus in (1,2,5) and (t3.fqtymust-t3.fstockqty)>0 
and t4.fnumber not like '1.02.%' and t4.fnumber not like '6.%'
--and t4.fnumber not like 'A.%' and t4.fnumber not like 'P.%'
and t5.forderinterid=0
union all
select t4.fnumber,t5.fplancommitdate,(t3.fqtymust-t3.fstockqty) fqty,
t5.finterid fsourceinterid,0 fsourceentryid,t3.fitemid,t3.fauxqtyscrap,t3.fscrap,
(case when isnull(t5.forderinterid,0)<>0 then @FProductPrepareDays else @FHalfProductPrepareDays end) FPrepareDays  --成品直接下级则取成品的准备期，否则则取半成品的准备期
from icmo t5 
inner join ppbom t2 on t5.finterid=t2.ficmointerid
inner join ppbomentry t3 on t2.finterid=t3.finterid
inner join t_icitem t4 on t3.fitemid=t4.fitemid --子项
inner join t_icitem t8 on t5.fitemid=t8.fitemid --父项
inner join seorderentry t1 on t1.finterid=t5.forderinterid and t1.fentryid=t5.fsourceentryid
inner join seorder t6 on t6.finterid=t1.finterid
where t5.fstatus in (1,2,5) and (t3.fqtymust-t3.fstockqty)>0 
and t4.fnumber not like '1.02.%' and t4.fnumber not like '6.%'
--and t4.fnumber not like 'A.%' and t4.fnumber not like 'P.%'
and t5.forderinterid<>0 and t1.fmrpclosed<>1 and t6.FHeadSelfS0148<>'1900-01-01'

if @ftype=1
begin
	delete t5
	from #data t5 
	where t5.fitemid not in (
		select t5.fitemid
		from #data t5 
		inner join my_t_icmotemp t1 on t1.finterid=t5.fsourceinterid and t1.fuserid=@fuserid)
end

--@fitemtype  1 半成品  2 常规物料 3 包材
if @fitemtype=1
	delete from #data where fnumber not like '3.%' and fnumber not like '4.%' and fnumber not like '5.%' --3.  4. 前缀物料编码为半成品
else if @fitemtype=3
	delete from #data where fnumber not like '2.%'   --2. 前缀物料编码为包材
else if @fitemtype=2
	delete from #data where fnumber like '3.%' or fnumber like '4.%'  or fnumber like '5.%' or fnumber like '2.%' 

DECLARE Seorder_Cursor CURSOR FOR
select sum(isnull(fqty,0)) fqty,fitemid,fsourceinterid 
from #data 
group by fitemid,fsourceinterid

OPEN Seorder_Cursor

FETCH NEXT FROM Seorder_Cursor 
INTO @fqty,@fitemid,@fsourceinterid

WHILE @@FETCH_STATUS = 0
BEGIN
	DECLARE SeorderEntry_Cursor CURSOR FOR
	select t6.fdate,--Dateadd(day,-t2.FPrepareDays,t6.fdate) fplandate,--先不考虑提前期
	t6.fqty*t2.fauxqtyscrap*(1+t2.fscrap/100) fqty
	from #data t2  
	inner join my_t_scheduledetail t6 on t6.ficmointerid=t2.fsourceinterid  
	where t2.fsourceinterid=@fsourceinterid and t2.fitemid=@fitemid and t6.fdate>=@fdate  --今天开始计起
	order by t6.fdate desc

	OPEN SeorderEntry_Cursor

	FETCH NEXT FROM SeorderEntry_Cursor 
	INTO @fplandate,@fplanqty

	WHILE @@FETCH_STATUS = 0 and @fqty>0  --
	BEGIN
		if @fplanqty>=@fqty  --当天该物料的需求数大于未发数(余数)
		begin
			set @fplanqty=@fqty
			set @fqty=0
		end
		else
		begin
			set @fqty=@fqty-@fplanqty
		end	
		
		insert into #My_t_MrpRoughNeedSource(fneeddate, ftrantype,frunid, fsourceinterid,  fsourceentryid,  fitemid,  fqty)
		select                               @fplandate,85,       @frunid,@fsourceinterid, 0,               @fitemid, @fplanqty
	
		FETCH NEXT FROM SeorderEntry_Cursor 
		INTO @fplandate,@fplanqty
	end

	--可能出现当天或当天以后没有生产计划，有余数的话也放在今天的需求中
	if @fqty>0 --如果还有剩余数则放在今天的需求中--如果当天以前领多了，则没有剩余数，表示最后一天不用领那么多；如果当天以前领少了，则有剩余数，即欠数，表示今天应领出来，否则影响生产；
	begin
		insert into #My_t_MrpRoughNeedSource(fneeddate, ftrantype,frunid, fsourceinterid,  fsourceentryid,  fitemid,  fqty)
		select                               @fdate,    85,       @frunid,@fsourceinterid, 0,               @fitemid, @fqty
	end

	CLOSE SeorderEntry_Cursor
	DEALLOCATE SeorderEntry_Cursor

    FETCH NEXT FROM Seorder_Cursor
    INTO @fqty,@fitemid,@fsourceinterid
END

CLOSE Seorder_Cursor
DEALLOCATE Seorder_Cursor  

--drop table #data  --select * from #data order by fnumber  
--select t2.fnumber,t1.* from My_t_MrpRoughNeedSource t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid where frunid=1001 order by t2.fnumber

----关联任务单未审核的生产领料单
--insert into My_t_MrpRoughNeedSource(fneeddate,ficmointerid,ftrantype,frunid, forderinterid,forderentryid,fitemid,   fchilditemid,   forderqty,finqty, fqty,fchildmustqty,fchildoutqty, fchildqty)
--select						        t2.fdate, t5.finterid, 0,        @frunid,0,            0,            t8.fitemid,t4.fitemid,     0,        0,      0,   t3.fqty,      0,            t3.fqty
--from icmo t5 
--inner join icstockbillentry t3 on t5.finterid=t3.ficmointerid
--inner join icstockbill t2 on t2.finterid=t3.finterid
--inner join t_icitem t4 on t3.fitemid=t4.fitemid
--inner join t_icitem t8 on t5.fitemid=t8.fitemid
--inner join t_SubMessage t13 on t13.finterid=t4.f_114 and t13.ftypeid=10004  --仓管员
--inner join t_SubMessage t17 on t17.finterid=t4.f_115 and t17.ftypeid=10003  --倒冲
--where t2.ftrantype=24 and t2.fstatus in (0) 

--毛需求--随单出货外购件
insert into #My_t_MrpRoughNeedSource(fneeddate,ftrantype,frunid, fsourceinterid,fsourceentryid,fitemid,   fqty   )
select	                             (case when t4.fdate<@fdate then @fdate else t4.fdate end)/*Dateadd(day,-@FProductPrepareDays,t4.fdate)--先不考虑提前期*/, 
											   81,       @frunid,t4.finterid,   t4.fentryid,   t4.fitemid,t4.fqty-isnull(t4.fstockqty,0)
from seorderentry t4 
inner join seorder t5  on t5.finterid=t4.finterid
inner join t_icitem t8 on t8.fitemid=t4.fitemid
inner join t_Organization t6 on t5.FCustID=t6.fitemid
inner join t_department t11 on t11.fitemid=t5.fdeptid
where t8.ferpclsid=1 and t4.fmrpclosed<>1 and (t5.fstatus>0 or isnull(t5.FMultiCheckLevel1,0)>0) --and t5.fdate>='2011-07-01'
--and datediff(day,getdate(),t4.fdate)=@FProductProspectDays  --成品30天
and t4.fqty>t4.fstockqty

--预计入库--
/*
select                          @frunid,71,       t2.finterid,t2.fentryid,t2.fitemid,t2.fqty,  t2.fcommitqty,t2.fqty-t2.fcommitqty
from poorder t1
inner join poorderentry t2 on  t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where --t1.FClosed<>1 
t2.fmrpclosed<>1 
--and t4.fnumber not like '08.11.%' --and t1.fstatus>0 
and t1.fstatus<>3  --采购订单收料完毕就关闭，但不一定已经入库
and t3.ferpclsid in (1) 
--and (t3.fnumber like 'H.%' or t3.fnumber like 'K.%' or t3.fnumber like 'M.%' or t3.fnumber like 'N.%')
and (t2.fqty-t2.fcommitqty)>0
and t2.fitemid in (select fchilditemid from My_t_MrpRoughNeedSource where frunid=@frunid)
*/

create table #plantemp(fplancommitdate datetime,fqty decimal(24,2),fsourceinterid int,fsourceentryid int,fitemid int) 

----预计入库--要把未收料的数量循环分摊到收料计划中--生产任务单一定有生产计划，而采购订单可能还没有收料计划
insert into #plantemp(fplancommitdate,fqty,                  fsourceinterid,fsourceentryid,fitemid)
select                case when t2.fdate<@fdate then @fdate when datediff(day,getdate(),t2.fdate)>30 then DATEADD(day,30,getdate()) else t2.fdate end,--如果填的交货日期小于当天，则表明采购员所填交货日期是有变动的，按当天处理       
									 (t2.fqty-t2.fcommitqty),t2.finterid,   t2.fentryid,   t2.fitemid
from poorderentry t2  
inner join poorder t1 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where --t1.FClosed<>1 
t2.fmrpclosed<>1 
--and t4.fnumber not like '08.11.%' --and t1.fstatus>0 
and t1.fstatus<>3  --采购订单收料完毕就关闭，但不一定已经入库
and t3.ferpclsid in (1) 
--and (t3.fnumber like 'H.%' or t3.fnumber like 'K.%' or t3.fnumber like 'M.%' or t3.fnumber like 'N.%')
and (t2.fqty-t2.fcommitqty)>0
and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource)

DECLARE Seorder_Cursor CURSOR FOR
select fqty,fitemid,fsourceinterid,fsourceentryid,fplancommitdate 
from #plantemp 

OPEN Seorder_Cursor

FETCH NEXT FROM Seorder_Cursor 
INTO @fqty,@fitemid,@fsourceinterid,@fsourceentryid,@fplancommitdate

WHILE @@FETCH_STATUS = 0
BEGIN
	set @fplandate=null

	DECLARE SeorderEntry_Cursor CURSOR FOR
	select t2.fdate,t2.fqty
	from my_t_scheduledetail t2  
	where t2.fsourceinterid=@fsourceinterid and t2.fsourceentryid=@fsourceentryid 
	and t2.fitemid=@fitemid and t2.fdate>=@fdate  --今天开始计起 
	order by t2.fdate

	OPEN SeorderEntry_Cursor

	FETCH NEXT FROM SeorderEntry_Cursor 
	INTO @fplandate,@fplanqty

	WHILE @@FETCH_STATUS = 0 and @fqty>0  --
	BEGIN
		if @fplanqty>=@fqty
		begin
			set @fplanqty=@fqty
			set @fqty=0
		end
		else
		begin
			set @fqty=@fqty-@fplanqty
		end	
		
		insert into #My_t_MrpWillInStock(fdate,     frunid, ftrantype,finterid,       fentryid,       fitemid,   fqty)
		select                           @fplandate,@frunid,71,       @fsourceinterid,@fsourceentryid,@fitemid,  @fplanqty
	
		FETCH NEXT FROM SeorderEntry_Cursor 
		INTO @fplandate,@fplanqty
	end

	if @fqty>0 --如果还有剩余数则放在最后一天的计划--如果当天以前收多了，则没有剩余数，表示最后一天不用收那么多；如果当天以前收少了，则有剩余数；
	begin
		insert into #My_t_MrpWillInStock(frunid, ftrantype,finterid,       fentryid,       fitemid,   fqty ,fdate     )
		select                           @frunid,71,       @fsourceinterid,@fsourceentryid,@fitemid,  @fqty,isnull(@fplandate,@fplancommitdate)/*如果没有当天或当天以后没有收料计划，则取订单收料日期*/
	end

	CLOSE SeorderEntry_Cursor
	DEALLOCATE SeorderEntry_Cursor

    FETCH NEXT FROM Seorder_Cursor
    INTO @fqty,@fitemid,@fsourceinterid,@fsourceentryid,@fplancommitdate
END

CLOSE Seorder_Cursor
DEALLOCATE Seorder_Cursor


--预计入库--(采购申请单--已审核未关闭--未关联数)
insert into #My_t_MrpWillInStock(fdate,        frunid, ftrantype,finterid,   fentryid,   fitemid,   fqty)
select                           case when t2.FFetchTime<@fdate then @fdate when datediff(day,getdate(),t2.FFetchTime)>30 then DATEADD(day,30,getdate()) else t2.FFetchTime end,--如果填的交货日期小于当天，则表明采购员所填交货日期是有变动的，按当天处理       
											   @frunid,70,       t2.finterid,t2.fentryid,t2.fitemid,t2.fqty-t2.fcommitqty
from porequest t1
inner join porequestentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where --t1.fstatus>0 and 
t1.fstatus<>3 --and t2.FFetchTime>=@fdate  --今天开始计起
--and t4.fnumber not like '08.11.%'
and t2.fmrpclosed=0
and t3.ferpclsid in (1)
--and (t3.fnumber like 'H.%' or t3.fnumber like 'K.%' or t3.fnumber like 'M.%' or t3.fnumber like 'N.%')
and (t2.fqty-t2.fcommitqty)>0 
and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource)


--预计入库(收料通知单--未审核)--
insert into #My_t_MrpWillInStock(fdate,   frunid,  ftrantype,  finterid,   fentryid,   fitemid,   fqty)
select                           case when t1.fdate<@fdate then @fdate when datediff(day,getdate(),t1.fdate)>30 then DATEADD(day,30,getdate()) else t1.fdate end,--如果填的交货日期小于当天，则表明采购员所填交货日期是有变动的，按当天处理       
								          @frunid, 72,         t2.finterid,t2.fentryid,t2.fitemid,t2.fqty
from poinstock t1
inner join poinstockentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where t1.fstatus=0
--and t4.fnumber not like '08.11.%'
and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource) and t1.ftrantype=72


--预计入库(塑胶子件收料申请单--未关闭--未关联数)
insert into #My_t_MrpWillInStock(fdate,   frunid,  ftrantype,  finterid,fentryid,   fitemid,   fqty)
select                           t1.fdate,@frunid, 200000022,  t2.fid,  t2.fentryid,t2.fitemid,t2.fqty-t2.fcommitqty
from t_BOSPlasticPoInStock t1 
inner join t_BOSPlasticPoInStockEntry t2 on t1.fid=t2.fid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
--inner join t_department t4 on t1.fdeptid=t4.fitemid
inner join poorderentry t7 on t7.finterid=t2.fid_src and t7.fentryid=t2.fentryid_src 
where t7.FMrpClosed<>1  and isnull(t2.fmrpclosed,0)<>40019 --and t1.fstatus>0 
and (t2.fqty-t2.fcommitqty)>0
and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource) --and t1.FClassTypeID=200000022

--待检--日期信息不重要

--待检(未审核的外购入库单)
insert into #My_t_TempInventory(fdate,   frunid, ftrantype,finterid,   fentryid,   fitemid,   fqty)
select                        t1.fdate,@frunid,1,        t2.finterid,t2.fentryid,t2.fitemid,t2.fqty
from icstockbill t1
inner join icstockbillentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where t1.fstatus=0 and t2.FSourceTranType=72 
--and t4.fnumber not like '08.11.%'
and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource) and t1.ftrantype=1

--待检(收料通知单--未关闭--未关联数)--已审核未关闭
insert into #My_t_TempInventory(fdate,   frunid,  ftrantype,  finterid,   fentryid,   fitemid,   fqty)
select                          t1.fdate,@frunid, 72,         t2.finterid,t2.fentryid,t2.fitemid,t2.fqty-t2.fcommitqty-t2.fbackqty
from poinstock t1
inner join poinstockentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where t1.fstatus>0 and t1.fstatus<>3 --
and t2.fqty>(t2.fcommitqty+t2.fbackqty)
--and t4.fnumber not like '08.11.%'
and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource) and t1.ftrantype=72


/*
--预计入库--预测订单
insert into My_t_MrpWillInStock(frunid, ftrantype,finterid,   fentryid,   fitemid,   forderqty,finqty,                       fqty)
select                          @frunid,87,       t2.finterid,t2.fentryid,t2.fitemid,t2.fqty,  isnull(t2.FEntrySelfY0121,0), t2.fqty-isnull(t2.FEntrySelfY0121,0)
from pporder t1
inner join pporderentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
--inner join t_department t4 on t1.FHeadSelfY0121=t4.fitemid
where t2.forderclosed<>1 and t1.fstatus>0 and t1.fstatus<>3
and (t2.fqty-isnull(t2.FEntrySelfY0121,0))>0
--and t4.fnumber not like '08.11.%'
and t2.fitemid in (select fchilditemid from My_t_MrpRoughNeedSource where frunid=@frunid)
*/

--预计入库--
/*
insert into My_t_MrpWillInStock(fneedate,frunid, ftrantype,finterid,   fentryid,   fitemid,   forderqty,finqty,                     fqty)
select                          @frunid,85,       t2.finterid,0,          t2.fitemid,t2.fqty,  isnull(t2.fstockqty,0),     t2.fqty-isnull(t2.fstockqty,0)
from icmo t2 
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t2.fworkshop=t4.fitemid
where t2.fstatus>0 and t2.fstatus<>3
and (t2.fqty-isnull(t2.fstockqty,0))>0
--and t4.fnumber not like '08.11.%'
and t2.fitemid in (select fchilditemid from My_t_MrpRoughNeedSource where frunid=@frunid)
*/

--预计入库--任务单--要把未入库的数量循环分摊到生产计划中
select t2.fplancommitdate,(t2.fqty-t2.fstockqty) fqty,t2.finterid fsourceinterid,0 fsourceentryid,t2.fitemid
into #source
from icmo t2  
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t2.fworkshop=t4.fitemid
where t2.fstatus<>3
and (t2.fqty-isnull(t2.fstockqty,0))>0
and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource)

DECLARE Seorder_Cursor CURSOR FOR
select fqty,fitemid,fsourceinterid from #source 

OPEN Seorder_Cursor

FETCH NEXT FROM Seorder_Cursor 
INTO @fqty,@fitemid,@fsourceinterid

WHILE @@FETCH_STATUS = 0
BEGIN
	set @fplandate=null

	DECLARE SeorderEntry_Cursor CURSOR FOR
	select t2.fdate,t2.fqty
	from my_t_scheduledetail t2  
	where t2.ficmointerid=@fsourceinterid and t2.fitemid=@fitemid and t2.fdate>=@fdate  --今天开始计起
	order by t2.fdate

	OPEN SeorderEntry_Cursor

	FETCH NEXT FROM SeorderEntry_Cursor 
	INTO @fplandate,@fplanqty

	WHILE @@FETCH_STATUS = 0 and @fqty>0
	BEGIN
		if @fplanqty>=@fqty
		begin
			set @fplanqty=@fqty
			set @fqty=0
		end
		else
		begin
			set @fqty=@fqty-@fplanqty
		end	
		
		insert into #My_t_MrpWillInStock(fdate,     frunid, ftrantype,finterid,       fentryid,       fitemid,   fqty)
		select                          @fplandate,@frunid,85,       @fsourceinterid,@fsourceentryid,@fitemid,  @fplanqty
	
		FETCH NEXT FROM SeorderEntry_Cursor 
		INTO @fplandate,@fplanqty
	end

	if @fqty>0 --生产任务单一定有生产计划,如果还有剩余数表示当天以前还有计划未执行
	begin
		insert into #My_t_MrpWillInStock(frunid, ftrantype,finterid,       fentryid,       fitemid,   fqty, fdate)
		select                          @frunid,85,       @fsourceinterid,@fsourceentryid,@fitemid,  @fqty,isnull(@fplandate,@fdate)--当天或当天以后还有计划，则放在最后一天，没有则放在当天
	end

	CLOSE SeorderEntry_Cursor
	DEALLOCATE SeorderEntry_Cursor

    FETCH NEXT FROM Seorder_Cursor
    INTO @fqty,@fitemid,@fsourceinterid
END

CLOSE Seorder_Cursor
DEALLOCATE Seorder_Cursor

--库存
insert into #My_t_MrpStock(frunid,fitemid,fstockid,fqty)
select @frunid,t1.fitemid,t1.fstockid,t1.fqty
from icinventory t1
inner join t_ICItem t2 on t1.FItemID=t2.FItemID
inner join t_stock t3 on t3.fitemid=t1.fstockid
where --t2.ferpclsid in (1) and 
t1.fqty>0 --and t3.fname not like '%计划%' 
and t3.fname not like '%不良品%'
--and t3.fnumber not like '11.%' 
--and (t2.fnumber like 'H.%' or t2.fnumber like 'K.%' or t2.fnumber like 'M.%' or t2.fnumber like 'N.%')
and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource)

insert into #My_t_MrpStock(frunid, fitemid,   fstockid,   fqty)
select @frunid,t1.fitemid,t1.fstockid,t1.fqty
from poinventory t1
inner join t_ICItem t2 on t1.FItemID=t2.FItemID
inner join t_stock t3 on t3.fitemid=t1.fstockid
where --t2.ferpclsid in (1) and 
t1.fqty>0 --and t3.fname not like '%计划%' 
and t3.fname not like '%不良%' and t3.fname not like '%报废%' and t3.fitemid=16483  --代管仓
--and t3.fnumber not like '11.%' 
--and (t2.fnumber like 'H.%' or t2.fnumber like 'K.%' or t2.fnumber like 'M.%' or t2.fnumber like 'N.%')
and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource)

--select * from ictranstype

--半成品只取展望期内的需求
--if @fitemtype=1
--begin
--	delete t1
--	from #My_t_MrpRoughNeedSource t1 
--	inner join t_icitem t2 on t1.fitemid=t2.fitemid
--	where t1.frunid=@frunid and datediff(day,getdate(),t1.fneeddate)>@FHalfProductProspectDays  --半成品展望期30天
--
--	delete t1
--	from #My_t_MrpWillInStock t1 
--	inner join t_icitem t2 on t1.fitemid=t2.fitemid
--	where t1.frunid=@frunid and datediff(day,getdate(),t1.fdate)>@FHalfProductProspectDays  --半成品展望期30天
--end
 
--净需求具体到天
create table #my_t_MrpResultDetail(fneeddate datetime,fitemid int,funitid int,FRoughNeedQty decimal(24,4),
FWillInStockQty decimal(24,4),FCanUseStockQty decimal(24,4),FNeedQty decimal(24,4))


--select * into #sourcedata
--from 
--(
--	select t1.fneeddate,t1.fitemid,sum(t1.fqty) fqty,0 ftype
--	from My_t_MrpRoughNeedSource t1 where frunid=@frunid group by t1.fneeddate,t1.fitemid
--	union all
--	select t1.fdate fneeddate,t1.fitemid,sum(t1.fqty) fqty,1 ftype
--	from My_t_MrpWillInStock t1 where frunid=@frunid group by t1.fdate,t1.fitemid
--	union all
--	select '2100-01-01' fneeddate,t1.fitemid,sum(t1.fqty) fqty,2 ftype
--	from My_t_MrpStock t1 where frunid=@frunid group by t1.fitemid
--) t1

select fitemid,fneeddate,isnull(sum(isnull(FRoughNeedQty,0)),0) FRoughNeedQty,isnull(sum(isnull(FWillInStockQty,0)),0) FWillInStockQty 
into #sourcedata --ftype 0 毛需求 1 预计入库 2 库存
from
(
	select fitemid,fneeddate,(case when ftype=0 then fqty else 0 end) FRoughNeedQty, 
	(case when ftype=1 then fqty else 0 end) FWillInStockQty,
	(case when ftype=2 then fqty else 0 end) FStockQty
	from 
	(
		select t1.fneeddate,t1.fitemid,isnull(sum(isnull(t1.fqty,0)),0) fqty,0 ftype
		from #My_t_MrpRoughNeedSource t1 group by t1.fneeddate,t1.fitemid
		union all
		select t1.fdate fneeddate,t1.fitemid,isnull(sum(isnull(t1.fqty,0)),0) fqty,1 ftype
		from #My_t_MrpWillInStock t1 group by t1.fdate,t1.fitemid
	) t1
) t1 group by fitemid,fneeddate

set @fentryid=0

DECLARE Seorder_Cursor CURSOR FOR
select t2.fitemid,isnull(max(isnull(t1.fstockqty,0)),0) fstockqty,1 fentryid
from #sourcedata t2
left join 			
(
	select t1.fitemid,isnull(sum(isnull(t1.fqty,0)),0) fstockqty
	from #My_t_MrpStock t1 group by t1.fitemid
) t1 on t1.fitemid=t2.fitemid
group by t2.fitemid

OPEN Seorder_Cursor

FETCH NEXT FROM Seorder_Cursor 
INTO @fitemid,@FStockQty,@fentryid

WHILE @@FETCH_STATUS = 0
BEGIN
	DECLARE SeorderEntry_Cursor CURSOR FOR
	select t2.fneeddate,t2.FRoughNeedQty,t2.FWillInStockQty
	from #sourcedata t2
	where t2.fitemid=@fitemid 
	order by t2.fneeddate

	OPEN SeorderEntry_Cursor

	FETCH NEXT FROM SeorderEntry_Cursor 
	INTO @fneeddate,@FRoughNeedQty,@FWillInStockQty
	WHILE @@FETCH_STATUS = 0
	BEGIN
		if @fentryid=1
			set @FCanUseStockQty=@fstockqty  --库存在第一次循环的时候才纳入

		set @fentryid=@fentryid+1

		set @FCanUseStockQty=@FWillInStockQty+@FCanUseStockQty-@FRoughNeedQty  --可用库存

--		if @FCanUseStockQty>=0
--			set @FNeedQty=0--净需求
--		else
--		begin
--			set @FNeedQty=-@FCanUseStockQty
--			set @FCanUseStockQty=0
--		end

--		insert into #my_t_MrpResultDetail(fitemid, fneeddate, FWillInStockQty, FCanUseStockQty, FRoughNeedQty, FNeedQty)
--								   values(@fitemid,@fneeddate,@FWillInStockQty,@FCanUseStockQty,@FRoughNeedQty,@FNeedQty)

		insert into #my_t_MrpResultDetail(fitemid, fneeddate, FWillInStockQty, FCanUseStockQty, FRoughNeedQty, FNeedQty)
								   values(@fitemid,@fneeddate,@FWillInStockQty,@FCanUseStockQty,@FRoughNeedQty,@FNeedQty)

		--update t1 set fqty=@fqty from #MyMrpResultTemp t1 where fneeddate=@fneeddate and fitemid=@fitemid

		FETCH NEXT FROM SeorderEntry_Cursor 
		INTO @fneeddate,@FRoughNeedQty,@FWillInStockQty
	end

	CLOSE SeorderEntry_Cursor
	DEALLOCATE SeorderEntry_Cursor

    FETCH NEXT FROM Seorder_Cursor
    INTO @fitemid,@FStockQty,@fentryid
END

CLOSE Seorder_Cursor
DEALLOCATE Seorder_Cursor


select @fbegindate=@fdate --,@fenddate=Dateadd(day,20,@fbegindate)

--创建表
set @sqls=''

set @i=0

select @iCount=Datediff(day,@fbegindate,@fenddate)

while @i<=@iCount
begin
  set @varStrDate=replace(convert(varchar(10),Dateadd(day,@i,@fbegindate),111),'/','-')
  set @sqls=@sqls+'alter table #temp add ['+@varStrDate+'] decimal(24,0) default 0 '  --预计入库
  set @sqls=@sqls+'alter table #temp add ['+@varStrDate+'-2] decimal(24,0) default 0 '  --毛需求
  set @sqls=@sqls+'alter table #temp add ['+@varStrDate+'-3] decimal(24,0) default 0 '  --需求

  set @i=@i+1
end 

--print @sqls

execute (@sqls)   


--先计算出物料在计划期间每天的需求数---------------------------------------------------------------

set @sqls1='select fitemid,'

set @i=0

select @iCount=Datediff(day,@fbegindate,@fenddate)

while @i<=@iCount
begin
  set @varStrDate=replace(convert(varchar(10),Dateadd(day,@i,@fbegindate),111),'/','-')
  set @sqls1=@sqls1+'(case when fneeddate='+''''+@varStrDate+'' +''''+ ' then FWillInStockQty else 0 end) '+''''+@varStrDate+''+''''+','
  set @sqls1=@sqls1+'(case when fneeddate='+''''+@varStrDate+'' +''''+ ' then FRoughNeedQty else 0 end) '+''''+@varStrDate+'-2'+''''+','
  set @sqls1=@sqls1+'(case when fneeddate='+''''+@varStrDate+'' +''''+ ' then FCanUseStockQty else 0 end) '+''''+@varStrDate+'-3'+''''+','
  set @i=@i+1
end 

set @sqls1=substring(@sqls1,1,len(@sqls1)-1)
set @sqls1=@sqls1+' from #my_t_MrpResultDetail '  

--print @sqls1

--execute (@sqls1)  --结合下面的SQL执行 

--汇总-------------------------------------------------------------------
set @sqls='insert into #temp select t1.fitemid,' 

set @i=0

select @iCount=Datediff(day,@fbegindate,@fenddate)

while @i<=@iCount
begin
  set @varStrDate=replace(convert(varchar(10),Dateadd(day,@i,@fbegindate),111),'/','-')
  set @sqls=@sqls+'sum(isnull(['+@varStrDate +'],0)) '+''''+@varStrDate+''+''''+','
  set @sqls=@sqls+'sum(isnull(['+@varStrDate +'-2],0)) '+''''+@varStrDate+'-2'+''''+','
  set @sqls=@sqls+'sum(isnull(['+@varStrDate +'-3],0)) '+''''+@varStrDate+'-3'+''''+','
  set @i=@i+1
end 

set @sqls=substring(@sqls,1,len(@sqls)-1)
set @sqls=@sqls+' from ('+@sqls1+') t1  group by t1.fitemid '  

--print @sqls

execute (@sqls)   --先计算出物料在计划期间每天的需求数

/*
update t1 set FModQty=FTempdNeedQty%fbatchappendqty from #MyMrpResultTemp t1 where fneedqty>0

update t1 set FActNeedQty=FTempdNeedQty+(fbatchappendqty-FModQty) 
from #MyMrpResultTemp t1 where fneedqty>0 and FModQty>0

select * from #my_t_MrpResultDetail where fitemid=66321 and fneeddate<=DATEADD(day,30,getdate()) select DATEADD(day,20,getdate())
select fitemid from t_icitem where fshortnumber='300140'

*/

--保存结果--明细
--delete from my_t_MrpResultDetail where fhscount=@fhscount  --update my_t_MrpResultDetail set fremark=''

select cast(0 as bit) 选择,t2.fnumber 物料编码,t2.fname 名称,t2.fmodel 规格型号,t3.fname 单位,
cast(t5.fqty as int) 总未发数,cast(t7.fqty as int) 未发数,isnull(t8.fqty,0) 待检,isnull(t4.fqty,0) 库存,t1.*
from #temp t1 
inner join t_icitem t2 on t1.fitemid=t2.fitemid
inner join t_measureunit t3 on t2.funitid=t3.fitemid
inner join (select fitemid,sum(fqty) fqty from #data group by fitemid) t5 on t5.fitemid=t1.fitemid
left join (select fitemid,sum(isnull(fqty,0)) fqty from #My_t_TempInventory group by fitemid) t8 on t8.fitemid=t1.fitemid
left join (select fitemid,sum(isnull(fqty,0)) fqty from #My_t_MrpStock group by fitemid) t4 on t4.fitemid=t1.fitemid
left join (select fitemid,sum(isnull(FRoughNeedQty,0)) fqty from #my_t_MrpResultDetail where fneeddate<=@fenddate /*DATEADD(day,20,getdate())*/ group by fitemid) t7 on t7.fitemid=t1.fitemid
where isnull(t5.fqty,0)>isnull(t4.fqty,0)
order by t2.fnumber

drop table #plantemp
drop table #temp
drop table #source
drop table #data
drop table #my_t_MrpResultDetail
drop table #sourcedata
drop table #My_t_MrpRoughNeedSource
drop table #My_t_MrpWillInStock
drop table #My_t_TempInventory
drop table #My_t_MrpStock

set nocount off

GO


IF EXISTS (select * from sysobjects where name='t_SupplyEntry' and xtype='u') and not EXISTS (select t1.id
from sysobjects t1 
inner join syscolumns t2 on t1.id=t2.id
where t1.name='t_SupplyEntry' and t1.xtype='u' and t2.name='ftaxprice')
begin
	alter table t_SupplyEntry add ftaxprice decimal(24,4) default(0)
	alter table t_SupplyEntry add fstandardprice decimal(24,4) default(0)
end

go

--模拟发料--*****--按排程明细--模拟作用: 1 现有物料是否已经下足 2 现有库存物料是否能满足生产所选单据 3 模拟的的结果要能清楚告诉用户数据来源是什么  4 只跟踪选中的数据涉及到的物料 
--exec My_P_SimulateOutStockBySchedule 16394
IF EXISTS (select * from sysobjects where name='My_P_SimulateOutStockBySchedule' and xtype='p')  drop  procedure My_P_SimulateOutStockBySchedule
go

create procedure [dbo].My_P_SimulateOutStockBySchedule(@fuserid int) --,@fordertype int @fordertype 

as

set nocount on

--declare @fcommitdate datetime,@fuserid int,@frunid int,@fbillno varchar(20) select @fbillno='',@fcommitdate='2011-07-23',@fuserid=16394,@frunid=0  

Create Table #MyData (/*FIndex int IDENTITY,*/ fproductid int,FItemID int null,fqty decimal(24,2),ftype int)  

declare @fdeptid int,@fitemid int,@fpqty decimal(24,2),@forderinterid int,@fqty decimal(24,2),@fsourceinterid int
declare @fsourcebillno varchar(50),@fsourceentryid int,@fnumber varchar(50),@fsourcetrantype int
declare @fbegdate datetime,@fenddate datetime,@finvdate datetime,@fcaldate datetime,@FOrderBillLike varchar(120)
declare @fsendenddate datetime,@iRunID int, @iYear int,@iPeriod int,@fpackoutstockinterid int

Create Table #Data (fsourcetrantype int,fsourceinterid int,fsourceentryid int,fscrap decimal(24,2),
fscrapqty decimal(24,2),fproductid int,fplanqty decimal(24,2),fdifqty decimal(24,2),FQtyFinish decimal(24,2),fstockid int,
fperqty decimal(24,2),fqtymust decimal(24,2),fcommitqty decimal(24,2),fitemid int,fqty decimal(24,2),ftype int)

declare @fdate datetime,@fscrap decimal(24,4),@fpacksubid int,@fstockid int,@forderentryid int
declare @fbomlevel int

select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期

Create Table #Mutidata     (  FIndex int IDENTITY,FEntryID INT, FBomInterid int, FItemID int null, FNeedQty decimal(28,14) default(0) null, FBOMLevel int null, 
FItemType int null, FParentID int default(0)null, FRate   decimal(28,14) default(0) null, FHistory int default(0) null, FHaveMrp smallint default(0) null, 
FLevelString varchar(300) null, FBom int, FMaterielType int  default(371) null,FOperSN Int NULL DEFAULT(0),FOperID int default(0)) 
 
Create Table #MutiParentItem(  FIndex int IDENTITY,FEntryID INT default(0), FBomInterid int, FItemID int null, FNeedQty decimal(28,14) default(0) null, FBOMLevel 
int null, FItemType int null,  FParentID int default(0)null, FRate   decimal(28,14) default(0) null, FHistory int default(0) null, FHaveMrp smallint default(0) 
null, FLevelString varchar(300) null , FBom int, FMaterielType int  default(371) null,FOperSN Int NULL DEFAULT(0),FOperID int default(0)) 

Create Table #Errors ( FIndex int IDENTITY, FType smallint default(0), FErrText nvarchar(655) )

--任务数与滚动计划数的平衡关系:任务数-当天以前的汇报数=当天和当天以后的计划数
select t1.finterid ficmointerid,isnull(t3.FQtyFinish,0) FQtyFinish,t1.fqty-isnull(t3.FQtyFinish,0)-isnull(t2.fplanqty,0) fdifqty
into #source1
from icmo t1
left join 
(
	select t1.fsourceinterid,sum(t1.FQtyFinish) FQtyFinish 
	from ICMORptEntry t1 
	inner join ICMORpt t2 on t1.finterid=t2.finterid
	where t2.fheadselfj1112<@fdate
	group by t1.fsourceinterid
) t3 on t1.finterid=t3.fsourceinterid
left join 
(
	select ficmointerid,sum(fqty) fplanqty 
	from my_t_scheduledetail 
	where fsourcetrantype=85 and fdate>=@fdate
	group by ficmointerid
) t2 on t1.finterid=t2.ficmointerid  
where t1.fqty>isnull(t1.fstockqty,0) and t1.fstatus in (1,2) --未工的生产任务单
--and t1.fqty<>(isnull(t2.fplanqty,0)+isnull(t3.FQtyFinish,0))

select t3.fstockqty fqty,t5.finterid ficmointerid,t3.fitemid,t3.fauxqtyscrap,t3.fscrap,t3.fstockid
into #source2
from icmo t5 
inner join ppbom t2 on t5.finterid=t2.ficmointerid
inner join ppbomentry t3 on t2.finterid=t3.finterid
inner join t_icitem t4 on t3.fitemid=t4.fitemid --子项
inner join t_icitem t8 on t5.fitemid=t8.fitemid --父项
where t5.fstatus in (1,2) and (t3.fqtymust-t3.fstockqty)>0 

insert into #Data(fsourcetrantype, fstockid,   fsourceinterid, fscrap,   fscrapqty,fplanqty,                                        fdifqty,                                               FQtyFinish,                                               fperqty,         fqtymust,                                                                                      fcommitqty,fitemid,   fqty,                                                                                                   ftype) 
select            85,              t1.fstockid,t1.ficmointerid,t1.fscrap,0,        t2.fsumplanqty*t1.fauxqtyscrap*(1+t1.fscrap/100),isnull(t3.fdifqty,0)*t1.fauxqtyscrap*(1+t1.fscrap/100),isnull(t3.FQtyFinish,0)*t1.fauxqtyscrap*(1+t1.fscrap/100),t1.fauxqtyscrap,(t2.fsumplanqty+isnull(t3.fdifqty,0)+isnull(t3.FQtyFinish,0))*t1.fauxqtyscrap*(1+t1.fscrap/100),t1.fqty,   t1.fitemid,(t2.fsumplanqty+isnull(t3.fdifqty,0)+isnull(t3.FQtyFinish,0))*t1.fauxqtyscrap*(1+t1.fscrap/100)-t1.fqty,0
from #source2 t1
inner join 
(
	select t3.ficmointerid,sum(t3.fqty) fsumplanqty /*选中的计划数*/
	from my_t_scheduledetail t3 
	inner join 
	(
		select t3.ficmointerid,max(t3.fdate) fdate
		from my_t_scheduledetail t3 
		inner join My_t_ScheduleDetailTemp t2 on t2.finterid=t3.finterid
		where t2.fuserid=@fuserid
		group by t3.ficmointerid
	) t2 on t3.ficmointerid=t2.ficmointerid and t3.fdate<=t2.fdate  --领料和模拟时，任务单关联的计划单的日期为[今天～截止]日期
	where t3.fdate>=@fdate  --前台已经控制只能选当天或当天以后的计划
	group by t3.ficmointerid
) t2 on t1.ficmointerid=t2.ficmointerid
left join #source1 t3 on t1.ficmointerid=t3.ficmointerid

--待检
create table #TempInventory(fitemid int,fqty decimal(24,2))

insert into #TempInventory(fitemid,   fqty)
/*
--直接用代检仓的数据
select                     t1.fitemid,sum(t1.fqty) fqty
from POInventory t1
inner join t_ICItem t2 on t1.FItemID=t2.FItemID
inner join t_stock t3 on t3.fitemid=t1.FStockID
where --t2.ferpclsid in (1) and 
t1.fqty>0 and t1.fstockid=18132
and t3.fnumber not like '11.%' 
and t2.fitemid in (select fitemid from #Data )
group by t1.fitemid
*/

--待检--已经审核且未关闭的收料通知单
select t2.fitemid,sum(t2.fqty-t2.fcommitqty-t2.fbackqty)
from poinstock t1
inner join poinstockentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where t1.fstatus in (1,2) and t2.fqty>(t2.fcommitqty+t2.fbackqty) and t1.ftrantype=72
and t2.fitemid in (select fitemid from #Data) 
--and t4.fnumber not like '08.11.%'
group by t2.fitemid

--待检(未审核的外购入库单)
insert into #TempInventory(fitemid,   fqty)
select                     t2.fitemid,t2.fqty
from icstockbill t1
inner join icstockbillentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where t1.fstatus=0 and t2.FSourceTranType=72 
--and t4.fnumber not like '08.11.%'
and t2.fitemid in (select fitemid from #Data) and t1.ftrantype=1

--库存
create table #Invdata(fitemid int,fqty decimal(24,2))

insert into #Invdata(fitemid,   fqty)
select               t1.fitemid,sum(t1.fqty) fqty
from icinventory t1
inner join t_ICItem t2 on t1.FItemID=t2.FItemID
inner join t_stock t3 on t3.fitemid=t1.fstockid
where --t2.ferpclsid in (1) and 
t1.fqty>0 and t3.fname not like '%不良%'
--and t3.fnumber not like '11.%' 
--and (t2.fnumber like 'H.%' or t2.fnumber like 'K.%' or t2.fnumber like 'M.%' or t2.fnumber like 'N.%')
and t2.fitemid in (select fitemid from #Data )
group by t1.fitemid

--在途
create table #OnOrder(fitemid int,fqty decimal(24,2))

--预计入库
create table #WillIn(fitemid int,fqty decimal(24,2))

--预计入库--采购订单
insert into #WillIn(fitemid,   fqty)
select               t2.fitemid,t2.fqty-t2.fcommitqty
from poorder t1
inner join poorderentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where --t1.FClosed<>1 
t2.fmrpclosed<>1 --and t1.fstatus>0 
--and t1.fstatus<>3  --采购订单收料完毕就关闭，但不一定已经入库
and t3.ferpclsid in (1) 
--and t4.fnumber not like '08.11.%'
--and (t3.fnumber like 'H.%' or t3.fnumber like 'K.%' or t3.fnumber like 'M.%' or t3.fnumber like 'N.%')
and (t2.fqty-t2.fcommitqty)>0
and t2.fitemid in (select fitemid from #Data )

--预计入库--采购申请单--不纳入--因为交货计划未确定
--insert into #WillIn(fitemid,   fqty)
--select               t2.fitemid,t2.fqty-t2.fcommitqty
--from porequest t1
--inner join porequestentry t2 on t1.finterid=t2.finterid
--inner join t_icitem t3 on t2.fitemid=t3.fitemid
--inner join t_department t4 on t1.fdeptid=t4.fitemid
--where --t1.fstatus>0 and 
--t1.fstatus<>3
--and t3.ferpclsid in (1) 
----and t4.fnumber not like '08.11.%'
----and (t3.fnumber like 'H.%' or t3.fnumber like 'K.%' or t3.fnumber like 'M.%' or t3.fnumber like 'N.%')
--and (t2.fqty-t2.fcommitqty)>0
--and t2.fitemid in (select fitemid from #Data )

--预计入库--未审核的收料通知单
insert into #WillIn(fitemid,   fqty)
select               t2.fitemid,sum(t2.fqty)
from poinstock t1
inner join poinstockentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where t1.fstatus in (0) and t1.ftrantype=72
and t2.fitemid in (select fitemid from #Data) 
--and t4.fnumber not like '08.11.%'
group by t2.fitemid

--预计入库--生产任务单
insert into #WillIn(fitemid,   fqty)
select               t2.fitemid,t2.fqty-isnull(t2.fstockqty,0)
from icmo t2 
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t2.fworkshop=t4.fitemid
where t2.fstatus>0 and t2.fstatus<>3
--and t4.fnumber not like '08.11.%'
and (t2.fqty-isnull(t2.fstockqty,0))>0
and t2.fitemid in (select fitemid from #Data)

--预测
create table #Forecast(fitemid int,fqty decimal(24,2))

--未出
create table #NoOut(fitemid int,fqty decimal(24,2))

select t2.fbillno 任务单号,isnull(t3.fbillno,'') 订单编号,t5.fnumber 产品编码,t5.fname 产品名称,t5.fmodel 产品规格型号,
t1.fplanqty 计划数,t1.fqtyfinish 本日之前汇报数,t1.fdifqty 未排数,
t6.fitemid 物料内码,t6.fnumber 物料编码,t6.fname 物料名称,t6.fmodel 物料规格型号,t11.fname 单位,
t1.fscrap 损耗率,t1.fqtymust 选单应发数,t1.fcommitqty 已发数,0 未出数,
isnull(t9.fqty,0) 在途数,isnull(t8.fqty,0) 待检数,isnull(t15.fqty,0) 预计入库,t1.fqty 毛需求,isnull(t7.fqty,0) 库存数,
t1.fqty 可发料数,
isnull(t13.fname,'') 仓管员,isnull(t14.fname,'') 物料类别
from #Data t1
inner join icmo t2 on t1.fsourceinterid=t2.finterid
left join seorder t3 on t3.finterid=t2.forderinterid 
inner join t_icitem t5 on t2.fitemid=t5.fitemid
inner join t_icitem t6 on t1.fitemid=t6.fitemid
left join #Invdata t7 on t7.fitemid=t1.fitemid
left join (select fitemid,sum(fqty) fqty from #TempInventory group by fitemid) t8 on t8.fitemid=t1.fitemid
left join (select fitemid,sum(fqty) fqty from #OnOrder group by fitemid) t9 on t9.fitemid=t1.fitemid
left join #NoOut t10 on t10.fitemid=t1.fitemid
inner join t_measureunit t11 on t11.fitemid=t6.funitid
left join t_SubMessage t13 on t13.finterid=t6.F_114 and t13.ftypeid=10003
left join t_SubMessage t14 on t14.finterid=t6.ftypeid and t14.ftypeid=504
left join (select fitemid,sum(fqty) fqty from #WillIn group by fitemid) t15 on t15.fitemid=t1.fitemid
left join #Forecast t12 on t12.fitemid=t1.fitemid
order by t6.fnumber,t1.fsourcetrantype,isnull(t3.fbillno,'')

drop table #OnOrder
drop table #Invdata
drop table #TempInventory
drop table #Data
drop table #MyData
drop table #Mutidata
drop table #MutiParentItem
drop table #Errors
drop table #NoOut
drop table #Source1
drop table #Source2

set nocount off

go 



--外购成品的包材生成包材发料通知单--按物料排序--
--My_p_GeneratePackOutStock 1851,16394,0  --select * from t_BOSPackOutStockEntry where FID_SRC=1851 --select * from t_BOSPackOutStock where fid=1432
IF EXISTS (select * from sysobjects where name='My_p_GeneratePackOutStock' and xtype='p')  drop  procedure My_p_GeneratePackOutStock

go

create procedure My_p_GeneratePackOutStock(@fsourceinterid int,@fuserid int,@InterID int output)

as

set nocount on

--declare @fsourceinterid int,@fuserid int,@InterID int  select @fsourceinterid=1851,@fuserid=16394,@InterID=0

declare @funitid int,@entryid int,@fqty decimal(24,2),@fsourcebillno varchar(50),@fsourceentryid int
declare @BillNo varchar (20),@fpackinterid int,@fchildqty decimal(24,2),@fbomqty decimal(24,2),@bHaveExists bit
DECLARE @TmpID INT ,@FBomInterID int,@flevel varchar(20),@fprepscrap decimal(24,4),@fprepscrapqty decimal(24,2)
declare @iLength int,@fserial varchar(20),@fstockid int,@fchilditemid int,@fhavechild bit,@fscrap decimal(24,4)
declare @fprojectval  varchar(200),@ferpclsname varchar(20),@fperqty decimal(24,2),@fpacksubid int
declare @FDateFormat  varchar(200),@fdate datetime,@s varchar(2000),@fsupplyid int,@fscrapqty decimal(24,4)
declare @FNumber varchar(200),@FChildNumber varchar(200),@FName varchar(200),@FChildName varchar(200)
declare @FUnit varchar(200),@FMachinePos varchar(200),@FNote varchar(200),@FPage varchar(200),@fdeptid int

select @fdate=replace(convert(varchar(10),getdate(),111),'/','-'),@fhavechild=0
declare @fitemid int,@fcontactno varchar(20),@flag int

select @fsourcebillno=fbillno from seorder where finterid=@fsourceinterid

select top 1 @fdeptid=fitemid from t_department

/*
if exists (select 1 from t_BOSPackOutStockEntry t1 inner join t_BOSPackOutStock t2 on t1.fid=t2.fid 
where t1.FID_SRC=@fsourceinterid and isnull(t2.fchecker,0)<>0)
begin
	RAISERROR('关联包材发料通知单已经审核!',18,18)
end


if exists (select 1 from t_BOSPackOutStockEntry t1 inner join t_BOSPackOutStock t2 on t1.fid=t2.fid 
where t1.FID_SRC=@fsourceinterid and isnull(t1.fcommitqty,0)>0)
begin
	RAISERROR('关联包材发料通知单部分已经调拨!',18,18)
end
*/

/*
if exists (select 1
from seorder t1
inner join seorderentry t2 on t1.finterid=t2.finterid
inner join t_icitem t4 on t4.fitemid=t2.fitemid
left join poorderentry t3 on t3.fsourceinterid=t2.finterid and t3.fsourceentryid=t2.fentryid and t3.fsourcetrantype=81 and t2.fitemid=t3.fitemid
where t1.finterid=@fsourceinterid and t4.ferpclsid=1 and t3.fitemid is null)
begin
	set @s='销售订单['+@fsourcebillno+']部分分录还未生成裸包采购订单!'
	RAISERROR(@s,18,18)
end
*/

--如果已经存在，则沿用原单据ID
if exists(select 1 from t_BOSPackOutStockEntry where FID_SRC=@fsourceinterid)
begin
	set @bHaveExists=1
	select top 1 @InterID=fid from t_BOSPackOutStockEntry where FID_SRC=@fsourceinterid

	--40019	1	10003	是  40016	2	10003	否
	--把没有出库的删掉重新生成，如果有出库或者行业务关闭的,则该分录的所有包材都不删除
	delete t2
	from t_BOSPackOutStock t1
	inner join t_BOSPackOutStockEntry t2 on t1.fid=t2.fid
	where t2.FID_SRC=@fsourceinterid 
	and t2.FEntryID_SRC not in (select distinct FEntryID_SRC from t_BOSPackOutStockEntry where FID_SRC=@fsourceinterid and (isnull(fcommitqty,0)>0 or isnull(fmrpclosed,0)=40019))
end
else
begin
	set @bHaveExists=0
	exec GetICMaxNum 't_BOSPackOutStock', @InterID output
end

Create Table #Mutidata     (  FIndex int IDENTITY,FEntryID INT, FBomInterid int, FItemID int null, FNeedQty decimal(28,14) default(0) null, FBOMLevel int null, 
FItemType int null, FParentID int default(0)null, FRate   decimal(28,14) default(0) null, FHistory int default(0) null, FHaveMrp smallint default(0) null, 
FLevelString varchar(300) null, FBom int, FMaterielType int  default(371) null,FOperSN Int NULL DEFAULT(0),FOperID int default(0)) 
 
Create Table #MutiParentItem(  FIndex int IDENTITY,FEntryID INT default(0), FBomInterid int, FItemID int null, FNeedQty decimal(28,14) default(0) null, FBOMLevel 
int null, FItemType int null,  FParentID int default(0)null, FRate   decimal(28,14) default(0) null, FHistory int default(0) null, FHaveMrp smallint default(0) 
null, FLevelString varchar(300) null , FBom int, FMaterielType int  default(371) null,FOperSN Int NULL DEFAULT(0),FOperID int default(0)) 

Create Table #Errors ( FIndex int IDENTITY, FType smallint default(0), FErrText nvarchar(655) )

Create Table #Data (fsourceentryid int,fscrap decimal(24,2),fscrapqty decimal(24,2),fproductid int,
fproductqty decimal(24,2),fstockid int,fsourceinterid int,
fperqty decimal(24,2),fbomqty decimal(24,2),fitemid int,fqty decimal(24,2),ftype int)

--exec GetICMaxNum 't_BOSPackOutStock', @InterID output

DECLARE Seorder_Cursor3 CURSOR FOR
select t3.fqty,t2.fbillno,t3.finterid,t3.fentryid,t3.fitemid,t1.fnumber,isnull(t7.fid,0) fpacksubid
from seorder t2
inner join seorderentry t3 on t2.finterid=t3.finterid
inner join t_icitem t1 on t1.fitemid=t3.fitemid
inner join (select min(fid) fid,fproductid,fbrandid,min(fbillno) fbillno from t_BOSPackSub group by fproductid,fbrandid) t7 on t7.fbillno=t3.fentryselfs0167 and t1.ferpclsid=1
where t2.finterid=@fsourceinterid 
order by t1.fnumber

OPEN Seorder_Cursor3

FETCH NEXT FROM Seorder_Cursor3 
INTO @fqty,@fsourcebillno,@fsourceinterid,@fsourceentryid,@fitemid,@fnumber,@fpacksubid

WHILE @@FETCH_STATUS = 0
BEGIN
	if @fpacksubid<>0
	begin
		set @fscrap=0

		--新增包材
		insert into #Data(fstockid,                fsourceinterid, fsourceentryid, fscrap, fscrapqty,fproductid,fproductqty,fperqty,fbomqty,      fitemid,   fqty,                              ftype) 
		select            isnull(t3.fdefaultloc,0),@fsourceinterid,@fsourceentryid,@fscrap,0,        @fitemid,  @fqty,      t2.fqty,@fqty*t2.fqty,t2.fitemid,(@fqty*t2.fqty*(1+@fscrap/100)),0
		from t_BOSPackSub t1 
		inner join t_BOSPackSubEntry t2 on t1.fid=t2.fid 
		inner join t_icitem t3 on t2.fitemid=t3.fitemid
		where t1.fid=@fpacksubid
	end

	--select top 1 @fstockid=fitemid from t_stock --

    FETCH NEXT FROM Seorder_Cursor3 
    INTO @fqty,@fsourcebillno,@fsourceinterid,@fsourceentryid,@fitemid,@fnumber,@fpacksubid
END

CLOSE Seorder_Cursor3
DEALLOCATE Seorder_Cursor3

--取得包材发料通知单最大ID
select @entryid=isnull(max(findex),0)+1 from t_BOSPackOutStockEntry where FID_SRC=@fsourceinterid

DECLARE Seorder_Cursor2 CURSOR FOR
select t1.fstockid,t1.fsourceentryid,t1.fqty,t1.fproductid,t1.fbomqty,t1.fperqty,t1.fitemid,t2.funitid,t1.fscrap,t1.fbomqty*t1.fscrap/100
from #Data t1
inner join t_icitem t2 on t1.fitemid=t2.fitemid
order by t2.fnumber

OPEN Seorder_Cursor2

FETCH NEXT FROM Seorder_Cursor2 
INTO @FStockID,@fsourceentryid,@fqty,@fitemid,@fbomqty,@fperqty,@fchilditemid,@funitid,@fscrap,@fscrapqty

WHILE @@FETCH_STATUS = 0
BEGIN
	INSERT INTO t_BOSPackOutStockEntry(fsupplyid,  fproductid,fscrap, fscrapqty,  fitemid,      FID,     FIndex,  FQty, fperqty, fbomqty, funitid, FStockID, FRemark,FBillNo_SRC,   FClassID_SRC,FCommitQty,FID_SRC,        FEntryID_SRC) 
	Values(							      0,          @fitemid,  @fscrap,@fscrapqty, @fchilditemid,@InterID,@entryid,@FQty,@fperqty,@fbomqty,@funitid,@FStockID,'',     @fsourcebillno,-81,         0,         @fsourceinterid,@fsourceentryid)

	set @entryid=@entryid+1
	set @fhavechild=1

    FETCH NEXT FROM Seorder_Cursor2 
    INTO @FStockID,@fsourceentryid,@fqty,@fitemid,@fbomqty,@fperqty,@fchilditemid,@funitid,@fscrap,@fscrapqty
END

CLOSE Seorder_Cursor2
DEALLOCATE Seorder_Cursor2

if @bHaveExists=0
begin
	--40128	硒鼓
	--40129	墨盒

	--墨盒类损耗率
	--if exists(select 1 from seorder where fheadselfs0159=40129 and finterid=@fsourceinterid)
	--begin
		update t3 set fscrap=(case when t1.fqty>0    and t1.fqty<=100  then 10 
								   when t1.fqty>100  and t1.fqty<=500  then 3
								   when t1.fqty>500  and t1.fqty<=1000 then 2
								   when t1.fqty>1000 and t1.fqty<=5000 then 1
								   when t1.fqty>5000 then 0.5 end),
		fscrapqty=cast(t1.fqty*(case when t1.fqty>0    and t1.fqty<=100  then 10 
									 when t1.fqty>100  and t1.fqty<=500  then 3
									 when t1.fqty>500  and t1.fqty<=1000 then 2
									 when t1.fqty>1000 and t1.fqty<=5000 then 1
									 when t1.fqty>5000 then 0.5 end)/100 as int),
		fqty=t3.fbomqty+cast((t1.fqty*(case when t1.fqty>0    and t1.fqty<=100  then 10 
												   when t1.fqty>100  and t1.fqty<=500  then 3
												   when t1.fqty>500  and t1.fqty<=1000 then 2
												   when t1.fqty>1000 and t1.fqty<=5000 then 1
												   when t1.fqty>5000 then 0.5 end)/100) as decimal(24,2))--先求整，不然会有小数
		from
		(
			select fitemid,min(fentryid) fentryid,sum(fbomqty) fqty  --是用BOM数量
			from t_BOSPackOutStockEntry where fid=@InterId group by fitemid
		) t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid
		inner join t_BOSPackOutStockEntry t3 on t3.fid=@InterID and t3.fentryid=t1.fentryid
	--end 

	-- 10.4
	Update t_BillCodeRule Set FReChar = FReChar Where FBillTypeID =200000009

	SET @TmpID = (SELECT FID FROM t_BillCodeRule WITH(READUNCOMMITTED) WHERE fbilltypeid=200000009 and fprojectid=3)

	update t_billcoderule set fprojectval = fprojectval+1,flength=case when (flength-len(fprojectval)) >= 0 then flength else len(fprojectval) end where FID =  @TmpID 
	Update ICBillNo Set FCurNo = (select top 1 isnull(fprojectval,1) from t_billcoderule where fprojectid = 3 and fbilltypeid =200000009) where fbillid = 200000009
	   
	--长度和目前编码
	select @fprojectval=(fprojectval-1),@iLength=flength from t_BillCodeRule where fprojectid = 3 and fbilltypeid = 200000009
	  
	--日期
	--select fprojectval,GetDate() AS DateNow from t_BillCodeRule where fprojectid = 2 and fbilltypeid = 100
	  --  sDateFormat = tempRs.Fields(fprojectval)
	  --  sDateFormat = Format(DateValue(tempRs.Fields(DateNow)), sDateFormat)

	-- 前缀
	select @BillNo=fprojectval+left('0000000000',@iLength-(len(@fprojectval)))+@fprojectval from t_BillCodeRule where fprojectid = 1 and fbilltypeid = 200000009  --@iLength

	INSERT INTO t_BOSPackOutStock(fdeptid, fsebillno,      FID,     FClassTypeID,FBillNo,FDate,  FBiller, FChecker,  FNOTE) 
	Values(                       @fdeptid,@fsourcebillno, @InterID,200000009,   @BillNo,@fdate, @fuserid,0       ,  '')

	--EXEC p_UpdateBillRelateData 200000009,@interid

	--set @fresultbillno=@fresultbillno+@billno

	declare @frunid int
	select top 1 @frunid=frunid from my_t_MrpSeOrder where forderinterid=@fsourceinterid and fselect=1 and ftype=40044 order by frunid desc

	update t1 set frunid=@frunid 
	from t_BOSPackOutStock t1 
	inner join t_BOSPackOutStockEntry t2 on t1.fid=t2.fid
	where t2.FID_SRC=@fsourceinterid
end 

update m2 set fnooutstockqty=m2.fqty-m2.FCommitQty
from t_BOSPackOutStockEntry m2 
inner join t_BOSPackOutStock m3 on m2.fid=m3.fid
where m3.fid=@InterID

delete t2 from t_BOSPackOutStock t2 where fid not in (select fid from t_BOSPackOutStockEntry)

set nocount off

GO


/*

→ 外购成品 → 直入直出
    ↓
  包材 → 包材发料通知单 → 其它出库/虚仓出库

→ 外购原材料 → 销售出库

→ 自制成品
   |   ↓
   ↓  BOM → 计划投料单(常规物料)  → 与 生产领料 对冲
  包材 → 计划投料单(包装材料) → 与 生产领料/虚仓出库 对冲  


生产任务单 → 投料单 
              |  ↓
              ↓ 领料单
            虚仓出库单

常规物料 1 包装材料 2

*/


IF not EXISTS (select * from sysobjects where name='My_t_PPOrderTemp' and xtype='u')  --drop  Table My_t_PPOrderTemp
begin
	create table My_t_PPOrderTemp(fuserid int,finterid int,fentryid int) 
end

go


IF not EXISTS (select * from sysobjects where name='My_t_SEOrderTemp' and xtype='u')  --drop  Table My_t_SEOrderTemp
begin
	create table My_t_SEOrderTemp(fuserid int,finterid int,fentryid int) 
end

go



--欠数查询
--exec My_P_OweMaterial 16394,0,3
IF EXISTS (select * from sysobjects where name='My_P_OweMaterial' and xtype='p')  drop  procedure My_P_OweMaterial
go

create procedure [dbo].My_P_OweMaterial(@fuserid int,@fordertype int,@ferpclsid int)  --@fordertype 0 非专利 1 专利 @ferpclsid 2 自制 1 外购 3 全部

as
set nocount on

--declare @fuserid int,@ferpclsid int select @fuserid=16394,@ferpclsid=3

Create Table #MyData (/*FIndex int IDENTITY,*/ fproductid int,FItemID int null,fqty decimal(24,2),ftype int)  

declare @fdeptid int,@fitemid int,@fpqty decimal(24,2),@forderinterid int,@fqty decimal(24,2),@fsourceinterid int
declare @fsourcebillno varchar(50),@fsourceentryid int,@fnumber varchar(50),@fsourcetrantype int
declare @fbegdate datetime,@fenddate datetime,@finvdate datetime,@fcaldate datetime,@FOrderBillLike varchar(120)
declare @fsendenddate datetime,@iRunID int, @iYear int,@iPeriod int,@fpackoutstockinterid int

Create Table #Data (finterid int,fbillno varchar(20),ftrantype int,fsourcebillno varchar(40),fsourcetrantype int,fsourceinterid int,fsourceentryid int,fscrap decimal(24,2),
fscrapqty decimal(24,2),fproductid int,fproductqty decimal(24,2),fstockid int,
fperqty decimal(24,2),fbomqty decimal(24,2),fitemid int,fqty decimal(24,2),ftype int)

declare @fdate datetime,@fscrap decimal(24,4),@fpacksubid int,@fstockid int,@forderentryid int
declare @FDeptPrefix varchar(50),@FStockPrefix varchar(50) 
select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期

Create Table #Mutidata     (  FIndex int IDENTITY,FEntryID INT, FBomInterid int, FItemID int null, FNeedQty decimal(28,14) default(0) null, FBOMLevel int null, 
FItemType int null, FParentID int default(0)null, FRate   decimal(28,14) default(0) null, FHistory int default(0) null, FHaveMrp smallint default(0) null, 
FLevelString varchar(300) null, FBom int, FMaterielType int  default(371) null,FOperSN Int NULL DEFAULT(0),FOperID int default(0)) 
 
Create Table #MutiParentItem(  FIndex int IDENTITY,FEntryID INT default(0), FBomInterid int, FItemID int null, FNeedQty decimal(28,14) default(0) null, FBOMLevel 
int null, FItemType int null,  FParentID int default(0)null, FRate   decimal(28,14) default(0) null, FHistory int default(0) null, FHaveMrp smallint default(0) 
null, FLevelString varchar(300) null , FBom int, FMaterielType int  default(371) null,FOperSN Int NULL DEFAULT(0),FOperID int default(0)) 

Create Table #Errors ( FIndex int IDENTITY, FType smallint default(0), FErrText nvarchar(655) )

create table #SourceData(fsourcebillno varchar(40),fsourcetrantype int,fqty decimal(24,2),fitemid int,forderinterid int,forderentryid int)

--毛需求 1 带有"-"的未审核的领料单/调拨单/其它出库单

insert into #Data(finterid,   fbillno,   ftrantype,fsourcebillno,fsourcetrantype,fstockid,      fsourceinterid,  fsourceentryid,    fscrap,fscrapqty,fproductid,  fproductqty,  fperqty,         fbomqty, fitemid,   fqty,   ftype) 
select            t3.finterid,t3.fbillno,24,       '',           0,              t4.fscstockid, 0,               0,                 0,     0,        0,           0,            0,               0,       t4.fitemid,t4.fqty,24  --领料单
from icstockbill t3 
inner join icstockbillentry t4 on t3.finterid=t4.finterid
inner join t_icitem t5 on t5.fitemid=t4.fitemid
inner join t_department t6 on t3.fdeptid=t6.fitemid
where t3.fstatus=0 and t3.ftrantype=24 and t3.fbillno like '%-%'
union all
select            t3.finterid,t3.fbillno,41,       '',           0,              t4.fscstockid, 0,               0,                 0,     0,        0,           0,            0,               0,       t4.fitemid,t4.fqty,41  --调拨单
from icstockbill t3 
inner join icstockbillentry t4 on t3.finterid=t4.finterid
inner join t_icitem t5 on t5.fitemid=t4.fitemid
inner join t_department t6 on t3.fdeptid=t6.fitemid
where t3.fstatus=0 and t3.ftrantype=41 and t3.fbillno like '%-%'
union all
select            t3.finterid,t3.fbillno,29,       '',           0,              t4.fdcstockid, 0,               0,                 0,     0,        0,           0,            0,               0,       t4.fitemid,t4.fqty,29  --其它出库单
from icstockbill t3 
inner join icstockbillentry t4 on t3.finterid=t4.finterid
inner join t_icitem t5 on t5.fitemid=t4.fitemid
inner join t_department t6 on t3.fdeptid=t6.fitemid
where t3.fstatus=0 and t3.ftrantype=29 and t3.fbillno like '%-%'

if @ferpclsid=1
	delete t2 from #Data t2 inner join t_icitem t3 on t2.fitemid=t3.fitemid where t3.ferpclsid=2
else if @ferpclsid=2
	delete t2 from #Data t2 inner join t_icitem t3 on t2.fitemid=t3.fitemid where t3.ferpclsid=1

--待检
create table #TempInventory(fitemid int,fqty decimal(24,2))

--待检--已经审核且未关闭的收料通知单

insert into #TempInventory(fitemid,   fqty) --收料通知单/退料通知单审核后会在代检仓加减库存
--直接用代检仓的数据
/*
select                     t1.fitemid,sum(t1.fqty) fqty
from POInventory t1
inner join t_ICItem t2 on t1.FItemID=t2.FItemID
inner join t_stock t3 on t3.fitemid=t1.FStockID
where --t2.ferpclsid in (1) and 
t1.fqty>0 and t1.fstockid=18132
--and t3.fnumber not like '11.%' 
and t2.fitemid in (select fitemid from #Data )
group by t1.fitemid
*/
select t2.fitemid,sum(t2.fqty-t2.fcommitqty-t2.fbackqty)
from poinstock t1
inner join poinstockentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where t1.fstatus in (1,2) and t2.fqty>(t2.fcommitqty+t2.fbackqty) and t1.ftrantype=72
and t2.fitemid in (select fitemid from #Data) 
--and t4.fnumber not like '08.11.%'
group by t2.fitemid


--待检(未审核的外购入库单)

insert into #TempInventory(fitemid,   fqty)
select                     t2.fitemid,t2.fqty
from icstockbill t1
inner join icstockbillentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where t1.fstatus=0 and t2.FSourceTranType=72 
--and t4.fnumber not like '08.11.%'
and t2.fitemid in (select fitemid from #Data) and t1.ftrantype=1


--库存
create table #Invdata(fitemid int,fqty decimal(24,2))


insert into #Invdata(fitemid,   fqty)
select               t1.fitemid,sum(t1.fqty) fqty
from icinventory t1
inner join t_ICItem t2 on t1.FItemID=t2.FItemID
inner join t_stock t3 on t3.fitemid=t1.fstockid
where --t2.ferpclsid in (1) and 
t1.fqty>0 and t3.fname not like '%不良%'
--and t3.fnumber not like '11.%' 
--and (t2.fnumber like 'H.%' or t2.fnumber like 'K.%' or t2.fnumber like 'M.%' or t2.fnumber like 'N.%')
and t2.fitemid in (select fitemid from #Data )
group by t1.fitemid


--在途
create table #OnOrder(fitemid int,fqty decimal(24,2))


--在途--采购订单

insert into #OnOrder(fitemid,   fqty)
select               t2.fitemid,t2.fqty-t2.fcommitqty
from poorder t1
inner join poorderentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where --t1.FClosed<>1 
t2.fmrpclosed<>1 --and t1.fstatus>0 
--and t4.fnumber not like '08.11.%'
and t1.fstatus<>3  --采购订单收料完毕就关闭，但不一定已经入库
and t3.ferpclsid in (1) 
--and (t3.fnumber like 'H.%' or t3.fnumber like 'K.%' or t3.fnumber like 'M.%' or t3.fnumber like 'N.%')
and (t2.fqty-t2.fcommitqty)>0
and t2.fitemid in (select fitemid from #Data )


--在途--采购申请单

insert into #OnOrder(fitemid,   fqty)
select               t2.fitemid,t2.fqty-t2.fcommitqty
from porequest t1
inner join porequestentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where --t1.fstatus>0 and 
t1.fstatus<>3
and t2.fmrpclosed=0
and t3.ferpclsid in (1)
--and t4.fnumber not like '08.11.%'
--and (t3.fnumber like 'H.%' or t3.fnumber like 'K.%' or t3.fnumber like 'M.%' or t3.fnumber like 'N.%')
and (t2.fqty-t2.fcommitqty)>0
and t2.fitemid in (select fitemid from #Data )


--在途--未审核的收料通知单

insert into #OnOrder(fitemid,   fqty)
select t2.fitemid,sum(t2.fqty)
from poinstock t1
inner join poinstockentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where t1.fstatus in (0) and t1.ftrantype=72
and t2.fitemid in (select fitemid from #Data) 
--and t4.fnumber not like '08.11.%'
group by t2.fitemid


--预计入库
create table #WillIn(fitemid int,fqty decimal(24,2))

--预计入库--生产任务单--半成品--相当于外购件的收料通知单

insert into #WillIn(fitemid,   fqty)
select               t2.fitemid,t2.fqty-isnull(t2.fstockqty,0)
from icmo t2 
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t2.fworkshop=t4.fitemid
where t2.fstatus>0 and t2.fstatus<>3
--and t4.fnumber not like '08.11.%'
and (t2.fqty-isnull(t2.fstockqty,0))>0
and t2.fitemid in (select fitemid from #Data)

--预计入库--日生产计划--半成品--相当于外购件的采购单

insert into #WillIn(fitemid,   fqty)
select t1.产品内码,t1.数量 
from v_MyScheduleDetail t1
inner join t_department t4 on t1.生产车间内码=t4.fitemid
where t1.状态<>'Y' and t1.产品内码 in (select fitemid from #Data)


--预测--半成品--相当于外购件的采购申请单
create table #Forecast(fitemid int,fqty decimal(24,2))

--预测--

insert into #Forecast(fitemid,   fqty)
select               t2.fitemid,sum(t2.fqty-isnull(t2.fentryselfy0121,0))  --fentryselfy0121 已排产
from pporderentry t2 
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join pporder t4 on t2.finterid=t4.finterid
--inner join t_department t5 on t4.FHeadSelfY0121=t5.fitemid
where --t4.fstatus>0 and 
t2.forderclosed<>1
--and t5.fnumber not like '08.11.%'
and (t2.fqty-isnull(t2.fentryselfy0121,0))>0
and t2.fitemid in (select fitemid from #Data)
group by t2.fitemid


--未出--去掉选择的订单涉及到的未出库数，因为毛需求已经包括
create table #NoOut(fitemid int,fqty decimal(24,2))

/*
insert into #NoOut(fitemid,   fqty)
select t4.fitemid,sum(t4.fqtymust-t4.fstockqty)
from ppbomentry t4 
inner join ppbom t5  on t5.finterid=t4.finterid
inner join t_icitem t8 on t8.fitemid=t4.fitemid
inner join icmo t1 on t4.ficmointerid=t1.finterid
inner join t_icitem t3 on t3.fitemid=t1.fitemid
where t1.fstatus>0 and t1.fstatus<>3 and t4.fqtymust>t4.fstockqty
and t4.fitemid in (select fitemid from #Data)
and not exists (select 1 from My_t_SEOrderTemp where fuserid=@fuserid and finterid=t1.forderinterid and fentryid=t1.fsourceentryid)
group by t4.fitemid
*/

select cast(0 as bit) 选择,t1.fbillno 单据编号,(case when t1.ftrantype=41 then '调拨单' when t1.ftrantype=24 then '领料单' when t1.ftrantype=29 then '其它出库单' end) 单据类型,
(case when t1.fsourcetrantype=81 then '销售订单' when t1.fsourcetrantype=8187 then '计划单' when t1.fsourcetrantype=85 then '任务单' end) 源单类型,isnull(t2.fbillno,'') 源单编号,
--t2.fdate 下单日期,t2.FHeadSelfS0142 包材交期,t2.FHeadSelfS0148 工厂交期,t2.FHeadSelfS0149 上线日期,t2.FHeadSelfS0150 装配完工日期,
--t5.fnumber 产品编码,t5.fname 产品名称,
'' 产品编码,'' 产品名称,
t6.fitemid 物料内码,t6.fnumber 物料编码,t6.fname+'///'+isnull(t6.fmodel,'') 物料名称,t11.fname 单位,
t1.fqty 毛需求,isnull(t10.fqty,0) 未出数,
isnull(t9.fqty,0) 在途数,isnull(t8.fqty,0) 待检数,
isnull(t4.fqty,0) 预计入库,isnull(t12.fqty,0) 预测数,
isnull(t7.fqty,0) 库存数,t1.fqty 预计可发料数,t1.fqty 可下计划数,t1.fqty 库存可发料数,
t13.fname 仓管员,t14.fname 物料类别
from #Data t1
left join seorderentry t3 on t3.finterid=t1.fsourceinterid and t1.fsourceentryid=t3.fentryid --and 
left join seorder t2 on t2.finterid=t3.finterid
left join t_icitem t5 on t3.fitemid=t5.fitemid
inner join t_icitem t6 on t1.fitemid=t6.fitemid
left join #Invdata t7 on t7.fitemid=t1.fitemid
left join (select fitemid,sum(fqty) fqty from #TempInventory group by fitemid) t8 on t8.fitemid=t1.fitemid
left join (select fitemid,sum(fqty) fqty from #OnOrder group by fitemid) t9 on t9.fitemid=t1.fitemid
left join #NoOut t10 on t10.fitemid=t1.fitemid
inner join t_measureunit t11 on t11.fitemid=t6.funitid
inner join t_SubMessage t13 on t13.finterid=t6.f_114 and t13.ftypeid=10003
inner join t_SubMessage t14 on t14.finterid=t6.ftypeid and t14.ftypeid=504
left join (select fitemid,sum(fqty) fqty from #WillIn group by fitemid) t4 on t4.fitemid=t1.fitemid
left join #Forecast t12 on t12.fitemid=t1.fitemid
order by t6.fnumber,t2.FHeadSelfS0148,isnull(t2.fbillno,'')


drop table #OnOrder
drop table #Invdata
drop table #TempInventory
drop table #Data
drop table #MyData
drop table #Mutidata
drop table #MutiParentItem
drop table #Errors
drop table #NoOut
drop table #Forecast
drop table #WillIn
drop table #SourceData

set nocount off

go 





--如果对选择的订单所关联的确认状态任务单进行模拟，意义为：这些任务单是否可下达---
--如果对选择的订单所关联的下达状态任务单进行模拟，意义为：如果只做这些任务单，是否欠料---
--如果对选择的订单所关联的任务单进行模拟，意义为：这些订单是否可提前交期

--模拟发料--按销售订单--
--exec My_P_SimulateOutStockBySEOrder 16394,0,0
IF EXISTS (select * from sysobjects where name='My_P_SimulateOutStockBySEOrder' and xtype='p')  drop  procedure My_P_SimulateOutStockBySEOrder
go

create procedure [dbo].My_P_SimulateOutStockBySEOrder (@fuserid int,@fitemtype int,@ftype int) --@fitemtype  1 半成品  2 常规物料 3 包材 0 全部  --@ftype 0 非下达任务单 1 下达任务单  2 所有

as

set nocount on

--declare @fuserid int,@fitemtype int,@ftype int,@fenddate datetime select @fuserid=16394,@fitemtype=0,@ftype=0 ,@fenddate='2013-05-15'

declare @fdeptid int,@fitemid int,@fpqty decimal(24,2),@forderinterid int,@s varchar(8000),@forderbillno varchar(50)
declare @fqty decimal(24,4),@fplanqty decimal(24,4),@fstockqty decimal(24,4),@FWillInStockQty decimal(24,4),@FRoughNeedQty decimal(24,4)
declare @FCanUseStockQty decimal(24,4),@FNeedQty decimal(24,4),@fsourceinterid int,@fplandate datetime,@fentryid int
declare @fbegdate datetime,@fneeddate datetime,@finvdate datetime,@fcaldate datetime,@FOrderBillLike varchar(120),@fsourceentryid int
declare @fsendenddate datetime,@iRunID int, @iYear int,@iPeriod int,@fpackoutstockinterid int,@i int,@fnumbermatch varchar(20)
declare @ficmointerid int,@fplancommitdate datetime,@FPrepareDays int,@sqls varchar(8000),@iCount int,@frunid int
declare @varStrDate varchar(30),@sqls1 varchar(8000),@j int,@iCount2 int
declare @FProductProspectDays int,@FHalfProductProspectDays int,@FProductPrepareDays int,@FHalfProductPrepareDays int

select @FProductProspectDays=fvalue from t_SystemProfile where FCategory='IC' and fkey='FProductProspectDays' 
select @FHalfProductProspectDays=fvalue from t_SystemProfile where FCategory='IC' and fkey='FHalfProductProspectDays' 
select @FProductPrepareDays=fvalue from t_SystemProfile where FCategory='IC' and fkey='FProductPrepareDays' 
select @FHalfProductPrepareDays=fvalue from t_SystemProfile where FCategory='IC' and fkey='FHalfProductPrepareDays' 

select @s='',@i=1

declare @fdate datetime,@fmaxdate datetime

select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期

create table #My_t_MrpRoughNeedSource(frunid int,ftrantype int,fsourceinterid int,fsourceentryid int,forderinterid int,
fitemid int,fqty decimal(24,2),fppbomentryid int,fneeddate datetime,fqtymust decimal(24,4),fishaverun int default 0,
fstockqty decimal(24,4) default 0,ffenpeiqty decimal(24,2) default 0,foweqty decimal(24,2) default 0,
ffenpeiqty2 decimal(24,2) default 0,foweqty2 decimal(24,2) default 0,
fordersuit bit default 0,fproductsuit bit default 0) 

create table #data(fppbomentryid int,fstatus int,fnumber varchar(50),fplancommitdate datetime,fqty decimal(24,4),fsourceinterid int,
fqtymust decimal(24,4),fstockqty decimal(24,4),forderinterid int,
fsourceentryid int,fitemid int,fauxqtyscrap decimal(24,4),fscrap decimal(24,4),FPrepareDays int)

--create table #temp(fitemid int)

create table #My_t_MrpWillInStock(fdate datetime,frunid int,ftrantype int,finterid int ,fentryid int,fitemid int,fqty decimal(24,4)) --1 外购  3 委外
create table #My_t_TempInventory(fdate datetime,frunid int,ftrantype int,finterid int ,fentryid int,fitemid int,fqty decimal(24,4),flastqty decimal(24,4) default 0) --1 外购  3 委外

create table #My_t_MrpStock(frunid int,fstockid int,fitemid int,fqty decimal(24,4),ffenpeiqty decimal(24,4) default 0,flastqty decimal(24,4) default 0) 

--投料单未发数--按生产计划分摊到日需求中--生产任务单中 成品是30天 半成品是15天

/*
delete from My_t_SEOrderTemp where fuserid=16394
insert into My_t_SEOrderTemp(fuserid,finterid,fentryid) 
select 16394,t1.finterid,t1.fentryid 
from seorderentry t1
inner join seorder t6 on t6.finterid=t1.finterid
where t6.FHeadSelfS0148>='2016-11-25' and t6.FHeadSelfS0148<='2016-12-07'
*/

insert into #data(fppbomentryid,forderinterid,fqtymust,fstockqty,fstatus,fnumber,fplancommitdate,fqty,
fsourceinterid,fsourceentryid,fitemid,fauxqtyscrap,fscrap,FPrepareDays)
select t3.fentryid,t1.finterid,t3.fqtymust,t3.fstockqty,t5.fstatus,t4.fnumber,--(case when t6.FHeadSelfS0154<@fdate then @fdate else t6.FHeadSelfS0154 end) fplancommitdate,--如果计划开工日期小于当天,则该任务单的需求日期则为当天
t6.FHeadSelfS0148 fplancommitdate,(t3.fqtymust-t3.fstockqty) fqty,
t5.finterid fsourceinterid,t1.fentryid fsourceentryid,t3.fitemid,t3.fauxqtyscrap,t3.fscrap,
(case when isnull(t5.forderinterid,0)<>0 then @FProductPrepareDays else @FHalfProductPrepareDays end) FPrepareDays  --成品直接下级则取成品的准备期，否则则取半成品的准备期
from icmo t5 
inner join ppbom t2 on t5.finterid=t2.ficmointerid
inner join ppbomentry t3 on t2.finterid=t3.finterid
inner join t_icitem t4 on t3.fitemid=t4.fitemid --子项
inner join t_icitem t8 on t5.fitemid=t8.fitemid --父项
inner join seorderentry t1 on t1.finterid=t5.forderinterid and t1.fentryid=t5.fsourceentryid 
inner join seorder t6 on t6.finterid=t1.finterid
inner join My_t_SEOrderTemp t14 on t1.finterid=t14.finterid and t1.fentryid=t14.fentryid and t14.fuserid=@fuserid
where t5.fstatus in (1,2,5) --icmo.fstatus 5 确认 0 计划 1,2 下达 3 结案
and (t3.fqtymust-t3.fstockqty)>0 and isnull(t1.fmrpclosed,0)=0
and (t5.fqty-t5.fcommitqty)>0
--and t6.FHeadSelfS0148>=@fdate --只考虑交期为当天以后的--当天之前的视为已出货
--and isnull(t6.FHeadSelfS0147,0) not in (40032,40033) --40032	样品订单-收费 40033	样品订单-免费
--and t4.fnumber not like '1.02.%' 
--and t4.fnumber not like '6.%'
and left(t4.fnumber,1) not in (select fitemtype from v_myitemtype where ftype=0) 

select @fmaxdate=max(fplancommitdate) from #data

if @ftype=0
  delete from #data where fstatus in (1,2)

if @ftype=1
  delete from #data where fstatus in (5)

----半成品
--insert into #data(fnumber,fplancommitdate,fqty,fsourceinterid,fsourceentryid,fitemid,fauxqtyscrap,fscrap,FPrepareDays)
--select t4.fnumber,Null fplancommitdate,(t3.fqtymust-t3.fstockqty) fqty,
--t5.finterid fsourceinterid,0 fsourceentryid,t3.fitemid,t3.fauxqtyscrap,t3.fscrap,
--(case when isnull(t5.forderinterid,0)<>0 then @FProductPrepareDays else @FHalfProductPrepareDays end) FPrepareDays  --成品直接下级则取成品的准备期，否则则取半成品的准备期
--from icmo t5 
--inner join ppbom t2 on t5.finterid=t2.ficmointerid
--inner join ppbomentry t3 on t2.finterid=t3.finterid
--inner join t_icitem t4 on t3.fitemid=t4.fitemid --子项
--inner join t_icitem t8 on t5.fitemid=t8.fitemid --父项
--where t5.fstatus in (1,2,5) and (t3.fqtymust-t3.fstockqty)>0 
--and isnull(t5.forderinterid,0)=0
--and t4.fnumber not like '1.02.%' and t4.fnumber not like '6.%'

----半成品的需求日期--如果有滚动，则取最小日期
--update t2 set fplancommitdate=t1.fdate
--from
--(
--	select t1.fsourceinterid,min(t6.fdate) fdate
--	from #data t1
--	inner join icmo t2 on t1.fsourceinterid=t2.finterid
--	inner join my_t_scheduledetail t6 on t6.ficmointerid=t1.fsourceinterid  
--	where t1.fplancommitdate is null and t6.fdate>=@fdate  --今天开始计起
--	group by t1.fsourceinterid
--) t1 inner join #data t2 on t1.fsourceinterid=t2.fsourceinterid

--半成品的需求日期--如果没有滚动，则默认为当天
--update t1 set fplancommitdate=@fdate
--from #data t1
--inner join icmo t2 on t1.fsourceinterid=t2.finterid
--where t1.fplancommitdate is null 

--if @ftype=1  --暂不起作用
--begin
--	delete t5
--	from #data t5 
--	where t5.fitemid not in (
--		select t5.fitemid
--		from #data t5 
--		inner join my_t_icmotemp t1 on t1.finterid=t5.fsourceinterid and t1.fuserid=@fuserid)
	
--	select @fmaxdate=max(t1.fplancommitdate) --大于选中的任务单的最大订单交期的订单不跟踪
--	from
--	(
--		select (case when t6.FHeadSelfS0154<@fdate then @fdate else t6.FHeadSelfS0154 end) fplancommitdate
--		from icmo t5 
--		inner join seorderentry t1 on t1.finterid=t5.forderinterid and t1.fentryid=t5.fsourceentryid 
--		inner join seorder t6 on t6.finterid=t1.finterid
--		inner join my_t_icmotemp t11 on t11.finterid=t5.finterid and t11.fuserid=@fuserid
--	) t1
	
--	if @fmaxdate is not null
--		delete t5 from #data t5 where fplancommitdate>@fmaxdate
--end

--@fitemtype  1 半成品  2 常规物料 3 包材
if @fitemtype=1
	delete from #data where fnumber not like '3.%' and fnumber not like '4.%' and fnumber not like '5.%'  --3.  4. 前缀物料编码为半成品
else if @fitemtype=3
	delete from #data where fnumber not like '2.%'   --2. 前缀物料编码为包材
else if @fitemtype=2
	delete from #data where fnumber like '3.%' or fnumber like '4.%' or fnumber like '5.%' or fnumber like '2.%' 

--delete from #data where fnumber like '2.01%' --纸箱

insert into #My_t_MrpRoughNeedSource(fppbomentryid,   forderinterid,   fqtymust,   fstockqty,   fneeddate,         ftrantype,frunid, fsourceinterid,    fsourceentryid,   fitemid,    fqty)
select                               t1.fppbomentryid,t1.forderinterid,t1.fqtymust,t1.fstockqty,t1.fplancommitdate,85,       @frunid,t1.fsourceinterid, t1.fsourceentryid,t1.fitemid, t1.fqty
from #data t1

----毛需求--随单出货外购件
--insert into #My_t_MrpRoughNeedSource(fneeddate, ftrantype,frunid, fsourceinterid,fsourceentryid,fitemid,   fqty   )
--select	                            (case when t5.FHeadSelfS0154<@fdate then @fdate else t5.FHeadSelfS0154 end) fplancommitdate,--如果计划开工日期小于当天,则该任务单的需求日期则为当天,  
--												81,       @frunid,t4.finterid,   t4.fentryid,   t4.fitemid,t4.fqty-isnull(t4.fstockqty,0)
--from seorderentry t4 
--inner join seorder t5  on t5.finterid=t4.finterid
--inner join t_icitem t8 on t8.fitemid=t4.fitemid
--inner join t_Organization t6 on t5.FCustID=t6.fitemid
--inner join t_department t11 on t11.fitemid=t5.fdeptid
--inner join My_t_SEOrderTemp t14 on t4.finterid=t14.finterid and t4.fentryid=t14.fentryid and t14.fuserid=@fuserid
--where t8.ferpclsid=1 and t4.fmrpclosed<>1 and (t5.fstatus>0 or isnull(t5.FMultiCheckLevel1,0)>0) --and t5.fdate>='2011-07-01'
----and datediff(day,getdate(),t4.fdate)=@FProductProspectDays  --成品30天
--and t4.fqty>t4.fstockqty --and t5.FHeadSelfS0148>=@fdate --只考虑交期为当天以后的--当天之前的视为已出货

----@fitemtype  1 半成品  2 常规物料 3 包材
--if @fitemtype=1
--	delete t1 from #My_t_MrpRoughNeedSource t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid where t2.fnumber not like '3.%' and t2.fnumber not like '4.%' and t2.fnumber not like '5.%'  --3.  4. 前缀物料编码为半成品
--else if @fitemtype=3
--	delete t1 from #My_t_MrpRoughNeedSource t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid where t2.fnumber not like '2.%'   --2. 前缀物料编码为包材
--else if @fitemtype=2
--	delete t1 from #My_t_MrpRoughNeedSource t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid where t2.fnumber like '3.%' or t2.fnumber like '4.%' or t2.fnumber like '5.%' or t2.fnumber like '2.%' 

--预计入库--采购订单--未关闭--未关联
insert into #My_t_MrpWillInStock(fdate,frunid, ftrantype,finterid,   fentryid,   fitemid,   fqty)
select                           case when t2.fdate<@fdate then @fdate when datediff(day,getdate(),t2.fdate)>30 then DATEADD(day,30,getdate()) else t2.fdate end,--如果填的交货日期小于当天，则表明采购员所填交货日期是有变动的，按当天处理       
									   @frunid,71,       t2.finterid,t2.fentryid,t2.fitemid,(t2.fqty-t2.fcommitqty)
from poorderentry t2  
inner join poorder t1 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where --t1.FClosed<>1 
t2.fmrpclosed<>1 
--and t4.fnumber not like '08.11.%' --and t1.fstatus>0 
and t1.fstatus<>3  --采购订单收料完毕就关闭，但不一定已经入库
and t3.ferpclsid in (1) 
--and (t3.fnumber like 'H.%' or t3.fnumber like 'K.%' or t3.fnumber like 'M.%' or t3.fnumber like 'N.%')
and (t2.fqty-t2.fcommitqty)>0
and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource)

--预计入库--(采购申请单--已审核未关闭--未关联数)
insert into #My_t_MrpWillInStock(fdate,frunid, ftrantype,finterid,   fentryid,   fitemid,   fqty)
select                           case when t2.FFetchTime<@fdate then @fdate when datediff(day,getdate(),t2.FFetchTime)>30 then DATEADD(day,30,getdate()) else t2.FFetchTime end,--如果填的交货日期小于当天，则表明采购员所填交货日期是有变动的，按当天处理       
									   @frunid,70,       t2.finterid,t2.fentryid,t2.fitemid,t2.fqty-t2.fcommitqty
from porequest t1
inner join porequestentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where --t1.fstatus>0 and 
t1.fstatus<>3 --and t2.FFetchTime>=@fdate  --今天开始计起
and t2.fmrpclosed=0
--and t4.fnumber not like '08.11.%'
and t3.ferpclsid in (1)
--and (t3.fnumber like 'H.%' or t3.fnumber like 'K.%' or t3.fnumber like 'M.%' or t3.fnumber like 'N.%')
and (t2.fqty-t2.fcommitqty)>0 
and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource)

--预计入库(收料通知单--未审核)--
insert into #My_t_MrpWillInStock(fdate,   frunid,  ftrantype,  finterid,   fentryid,   fitemid,   fqty)
select                           case when t1.fdate<@fdate then @fdate when datediff(day,getdate(),t1.fdate)>30 then DATEADD(day,30,getdate()) else t1.fdate end,--如果填的交货日期小于当天，则表明采购员所填交货日期是有变动的，按当天处理       
								          @frunid, 72,         t2.finterid,t2.fentryid,t2.fitemid,t2.fqty
from poinstock t1
inner join poinstockentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where t1.fstatus=0
--and t4.fnumber not like '08.11.%'
and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource) and t1.ftrantype=72

--预计入库(塑胶子件收料申请单--未关闭--未关联数)
insert into #My_t_MrpWillInStock(fdate,   frunid,  ftrantype,  finterid,fentryid,   fitemid,   fqty)
select                           t1.fdate,@frunid, 200000022,  t2.fid,  t2.fentryid,t2.fitemid,t2.fqty-t2.fcommitqty
from t_BOSPlasticPoInStock t1 
inner join t_BOSPlasticPoInStockEntry t2 on t1.fid=t2.fid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
--inner join t_department t4 on t1.fdeptid=t4.fitemid
inner join poorderentry t7 on t7.finterid=t2.fid_src and t7.fentryid=t2.fentryid_src 
where t7.FMrpClosed<>1 and isnull(t2.fmrpclosed,0)<>40019 --and t1.fstatus>0 
and (t2.fqty-t2.fcommitqty)>0
and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource) --and t1.FClassTypeID=200000022

--预计入库--任务单
insert into #My_t_MrpWillInStock(frunid, ftrantype,finterid,   fentryid,fitemid,   fqty,                          fdate)
select                           @frunid,85,       t2.finterid,0,       t2.fitemid,t2.fqty-isnull(t2.fstockqty,0),t2.fplancommitdate
from icmo t2  
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t2.fworkshop=t4.fitemid
where t2.fstatus<>3
and (t2.fqty-isnull(t2.fstockqty,0))>0
and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource)

--待检/未过账--日期信息不重要
insert into #My_t_TempInventory(fdate,     frunid,  ftrantype,  finterid,   fentryid,  fitemid,   fqty)
select                          null fdate,0 frunid,0 ftrantype,0 finterid, 0 fentryid,t1.fitemid,sum(t1.fqty)
from
(
	--未过账(未审核的外购入库单、产品入库单)
	select null fdate,0 frunid,0 ftrantype,0 finterid,0 fentryid,t2.fitemid,t2.fqty
	from icstockbill t1
	inner join icstockbillentry t2 on t1.finterid=t2.finterid
	inner join t_icitem t3 on t2.fitemid=t3.fitemid
	inner join t_department t4 on t1.fdeptid=t4.fitemid
	where t1.fstatus=0 and t2.FSourceTranType in (85,72 )
	and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource) and t1.ftrantype in (1,2)
	union all
	--待检(收料通知单--未关闭--未关联数)--已审核未关闭
	select null fdate,0 frunid,0 ftrantype,0 finterid,0 fentryid,t2.fitemid,(t2.fqty-t2.fcommitqty-t2.fbackqty) fqty
	from poinstock t1
	inner join poinstockentry t2 on t1.finterid=t2.finterid
	inner join t_icitem t3 on t2.fitemid=t3.fitemid
	inner join t_department t4 on t1.fdeptid=t4.fitemid
	where t1.fstatus>0 and t1.fstatus<>3 --
	and t2.fqty>(t2.fcommitqty+t2.fbackqty)
	and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource) and t1.ftrantype=72
) t1 group by t1.fitemid

--库存
insert into #My_t_MrpStock(frunid, fitemid,   fstockid,   fqty)
select                     @frunid,t1.fitemid,0 fstockid,sum(t1.fqty)
from
(
	select 0 frunid,t1.fitemid,0 fstockid,t1.fqty
	from icinventory t1
	inner join t_ICItem t2 on t1.FItemID=t2.FItemID
	inner join t_stock t3 on t3.fitemid=t1.fstockid
	where --t2.ferpclsid in (1) and 
	t1.fqty>0 
	and t3.fname not like '%不良%' and t3.fname not like '%报废%' and t3.fname not like '%试产仓%' 
	and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource)
	union all
	select 0 frunid,t1.fitemid,0 fstockid,t1.fqty
	from poinventory t1
	inner join t_ICItem t2 on t1.FItemID=t2.FItemID
	inner join t_stock t3 on t3.fitemid=t1.fstockid
	where --t2.ferpclsid in (1) and 
	t1.fqty>0  
	and t3.fname not like '%不良%' and t3.fname not like '%报废%' and t3.fitemid=16483 and t3.fname not like '%试产仓%'   --代管仓  t3.ftypeid in (500) --非代管仓
	and t2.fitemid in (select fitemid from #My_t_MrpRoughNeedSource)
) t1 group by t1.fitemid


--已分配数
if @ftype=0
begin
	update t1 set ffenpeiqty=t2.fqty
	from #My_t_MrpStock t1
	inner join
	(
		select t3.fitemid,sum(t3.fqtymust-t3.fstockqty) fqty
		from icmo t5 
		inner join ppbom t2 on t5.finterid=t2.ficmointerid
		inner join ppbomentry t3 on t2.finterid=t3.finterid
		inner join t_icitem t4 on t3.fitemid=t4.fitemid --子项
		inner join t_icitem t8 on t5.fitemid=t8.fitemid --父项
		inner join seorderentry t1 on t1.finterid=t5.forderinterid and t1.fentryid=t5.fsourceentryid 
		inner join seorder t6 on t6.finterid=t1.finterid
		where t5.fstatus in (1,2) --icmo.fstatus 5 确认 0 计划 1,2 下达 3 结案
		and (t3.fqtymust-t3.fstockqty)>0 
		and isnull(t1.fmrpclosed,0)=0
		and (t5.fqty-t5.fcommitqty)>0
		--and t6.FHeadSelfS0148>=@fdate --只考虑交期为当天以后的--当天之前的视为已出货
		--and isnull(t6.FHeadSelfS0147,0) not in (40032,40033) --40032	样品订单-收费 40033	样品订单-免费
		--and t4.fnumber not like '1.02.%' 
		--and t4.fnumber not like '6.%'
		--and left(t4.fnumber,1) not in (select fitemtype from v_myitemtype where ftype=0) 
		and t3.fitemid in (select fitemid from #My_t_MrpRoughNeedSource)
		group by t3.fitemid
	) t2 on t1.fitemid=t2.fitemid
end


if @ftype=2
begin
	update t1 set ffenpeiqty=t2.fqty
	from #My_t_MrpStock t1
	inner join
	(
		select t3.fitemid,sum(t3.fqtymust-t3.fstockqty) fqty
		from icmo t5 
		inner join ppbom t2 on t5.finterid=t2.ficmointerid
		inner join ppbomentry t3 on t2.finterid=t3.finterid
		inner join t_icitem t4 on t3.fitemid=t4.fitemid --子项
		inner join t_icitem t8 on t5.fitemid=t8.fitemid --父项
		inner join seorderentry t1 on t1.finterid=t5.forderinterid and t1.fentryid=t5.fsourceentryid 
		inner join seorder t6 on t6.finterid=t1.finterid
		where t5.fstatus in (1,2,5) --icmo.fstatus 5 确认 0 计划 1,2 下达 3 结案
		and (t3.fqtymust-t3.fstockqty)>0 
		and (t5.fqty-t5.fcommitqty)>0
		and isnull(t1.fmrpclosed,0)=0
		and t6.FHeadSelfS0148>=@fdate --只考虑交期为当天以后的--当天之前的视为已出货
		and t6.FHeadSelfS0148<=@fmaxdate
		and t6.finterid not in (select forderinterid from #My_t_MrpRoughNeedSource)
		--and isnull(t6.FHeadSelfS0147,0) not in (40032,40033) --40032	样品订单-收费 40033	样品订单-免费
		--and t4.fnumber not like '1.02.%' 
		--and t4.fnumber not like '6.%'
		--and left(t4.fnumber,1) not in (select fitemtype from v_myitemtype where ftype=0) 
		and t3.fitemid in (select fitemid from #My_t_MrpRoughNeedSource)
		group by t3.fitemid
	) t2 on t1.fitemid=t2.fitemid
end

update t1 set flastqty=fqty-ffenpeiqty from #My_t_MrpStock t1

update t1 set --fishaverun=0,
foweqty=fqty-ffenpeiqty from #My_t_MrpRoughNeedSource t1 

--整单配套----------------
WHILE exists(
	select 1
	from
	(
		select t1.forderinterid,t1.fitemid,(case when t1.fqty<=isnull(t2.flastqty,0) then 0 else 1 end) fisowe
		from
		(
			select t1.forderinterid,t1.fitemid,sum(t1.foweqty) fqty
			from #My_t_MrpRoughNeedSource t1
			where t1.foweqty>0 --and t1.fishaverun=0 
			group by t1.forderinterid,t1.fitemid
		) t1
		left join #My_t_MrpStock t2 on t1.fitemid=t2.fitemid
	) t1 group by t1.forderinterid
	having sum(t1.fisowe)=0)
begin
	select top 1 @forderinterid=t2.forderinterid
	from 
	(
		select t1.forderinterid
		from
		(
			select t1.forderinterid,t1.fitemid,(case when t1.fqty<=isnull(t2.flastqty,0) then 0 else 1 end) fisowe
			from
			(
				select t1.forderinterid,t1.fitemid,sum(t1.foweqty) fqty
				from #My_t_MrpRoughNeedSource t1
				where t1.foweqty>0 --and t1.fishaverun=0 
				group by t1.forderinterid,t1.fitemid
			) t1
			left join #My_t_MrpStock t2 on t1.fitemid=t2.fitemid
		) t1 group by t1.forderinterid
		having sum(t1.fisowe)=0
	) t1 inner join #My_t_MrpRoughNeedSource t2 on t1.forderinterid=t2.forderinterid
	order by t2.fneeddate

	update t2 set flastqty=t2.flastqty-t1.fqty  --要在下面之前更新
	from
	(
		select t1.fitemid,sum(t1.foweqty) fqty
		from #My_t_MrpRoughNeedSource t1
		where t1.forderinterid=@forderinterid
		group by t1.fitemid
	) t1 inner join #My_t_MrpStock t2 on t1.fitemid=t2.fitemid

	update t1 set ffenpeiqty=t1.foweqty,foweqty=0,fordersuit=1,fproductsuit=1 --,fishaverun=1
	from #My_t_MrpRoughNeedSource t1
	where t1.forderinterid=@forderinterid
end

--产品配套-------------
WHILE exists(
	select 1
	from
	(
		select t1.fsourceinterid,t1.fitemid,(case when t1.fqty<=isnull(t2.flastqty,0) then 0 else 1 end) fisowe
		from
		(
			select t1.fsourceinterid,t1.fitemid,sum(t1.foweqty) fqty
			from #My_t_MrpRoughNeedSource t1
			where t1.foweqty>0 --and t1.fishaverun=0 
			group by t1.fsourceinterid,t1.fitemid
		) t1
		left join #My_t_MrpStock t2 on t1.fitemid=t2.fitemid
	) t1 group by t1.fsourceinterid
	having sum(t1.fisowe)=0)
begin
	select top 1 @fsourceinterid=t2.fsourceinterid
	from 
	(
		select t1.fsourceinterid
		from
		(
			select t1.fsourceinterid,t1.fitemid,(case when t1.fqty<=isnull(t2.flastqty,0) then 0 else 1 end) fisowe
			from
			(
				select t1.fsourceinterid,t1.fitemid,sum(t1.foweqty) fqty
				from #My_t_MrpRoughNeedSource t1
				where t1.foweqty>0 --and t1.fishaverun=0 
				group by t1.fsourceinterid,t1.fitemid
			) t1
			left join #My_t_MrpStock t2 on t1.fitemid=t2.fitemid
		) t1 group by t1.fsourceinterid
		having sum(t1.fisowe)=0
	) t1 inner join #My_t_MrpRoughNeedSource t2 on t1.fsourceinterid=t2.fsourceinterid
	order by t2.fneeddate,t2.forderinterid

	update t2 set flastqty=t2.flastqty-t1.fqty  --要在下面之前更新
	from
	(
		select t1.fitemid,sum(t1.foweqty) fqty
		from #My_t_MrpRoughNeedSource t1
		where t1.fsourceinterid=@fsourceinterid
		group by t1.fitemid
	) t1 inner join #My_t_MrpStock t2 on t1.fitemid=t2.fitemid

	update t1 set ffenpeiqty=t1.foweqty,foweqty=0,fproductsuit=1 --,fishaverun=1
	from #My_t_MrpRoughNeedSource t1
	where t1.fsourceinterid=@fsourceinterid
end


declare @fminid int,@fmaxid int,@fentryminid int,@fentrymaxid int,@fppbomentryid int,@flastqty decimal(24,4),@foweqty decimal(24,4)

create table #Cursor(FID int identity(1,1),forderinterid int,fneeddate datetime,
fsourceinterid int,fppbomentryid int,fitemid int,foweqty decimal(24,4),forderbillno varchar(50)
)

--create table #CursorEntry(FID int identity(1,1),FDCStockID int,forderbillno varchar(30),FSourcePOBillNo varchar(30),
--FSourceSeBillNo varchar(30),ffmanagerid int,fplanbegindate datetime,
--fcbitemid int,fitemid int,funitid int,fstockid int,fspid int,fdeptid int,fqtymust decimal(24,4),fqty decimal(24,4),ficmointerid int,
--ficmobillno varchar(30),fplanprice decimal(24,4),fplanamount decimal(24,2),fcostobjid int,fppbominterid int,fppbomentryid int)

--分配库存-----------------------------------
truncate table #Cursor
insert into #Cursor(fsourceinterid,fppbomentryid,fitemid,fneeddate,foweqty)
select t1.fsourceinterid,t1.fppbomentryid,t1.fitemid,t1.fneeddate,t1.foweqty
from #My_t_MrpRoughNeedSource t1 where t1.foweqty>0
order by t1.fitemid,t1.fneeddate,t1.foweqty

--OPEN icbom_cursor
--
--FETCH NEXT FROM icbom_cursor 
--INTO @fsupplyid,@fdeptid,@flineid,@fsourcetrantype,@fsourceinterid,@fisbackflush,@fstockmanagerid,@fstockid

select @fminid=0,@fmaxid=0
select @fminid=isnull(min(fid),0),@fmaxid=isnull(max(fid),0) from #Cursor

WHILE @fmaxid>0 and @fminid<=@fmaxid -- @@FETCH_STATUS = 0
BEGIN 
	select @fppbomentryid=fppbomentryid,@fitemid=fitemid,@fsourceinterid=fsourceinterid,@foweqty=foweqty
	from #Cursor where fid=@fminid

	set @flastqty=0
	select @flastqty=flastqty from #My_t_MrpStock where fitemid=@fitemid

	if @flastqty>=0
	--begin
	--		update t1 set foweqty=@foweqty,ffenpeiqty=0
	--		from #My_t_MrpRoughNeedSource t1
	--		where t1.fsourceinterid=@fsourceinterid and t1.fppbomentryid=@fppbomentryid
	--end
	--else
	begin
		if @foweqty<=@flastqty
		begin
			update t1 set foweqty=0,ffenpeiqty=@foweqty
			from #My_t_MrpRoughNeedSource t1
			where t1.fsourceinterid=@fsourceinterid and t1.fppbomentryid=@fppbomentryid
	
			update t1 set flastqty=flastqty-@foweqty from #My_t_MrpStock t1 where t1.fitemid=@fitemid
		end
		else
		begin
			update t1 set foweqty=t1.foweqty-@flastqty,ffenpeiqty=@flastqty
			from #My_t_MrpRoughNeedSource t1
			where t1.fsourceinterid=@fsourceinterid and t1.fppbomentryid=@fppbomentryid
	
			update t1 set flastqty=0 from #My_t_MrpStock t1 where t1.fitemid=@fitemid
		end
	end

	set @fminid=@fminid+1
--	FETCH NEXT FROM icbom_cursor 
--    INTO @fsupplyid,@fdeptid,@flineid,@fsourcetrantype,@fsourceinterid,@fisbackflush,@fstockmanagerid,@fstockid
END

update t1 set ffenpeiqty2=0,foweqty2=foweqty from #My_t_MrpRoughNeedSource t1
update t1 set flastqty=fqty from #My_t_TempInventory t1

--分配待检/未过账-----------------------------------
truncate table #Cursor
insert into #Cursor(fsourceinterid,fppbomentryid,fitemid,fneeddate,foweqty)
select t1.fsourceinterid,t1.fppbomentryid,t1.fitemid,t1.fneeddate,t1.foweqty
from #My_t_MrpRoughNeedSource t1 where t1.foweqty>0
order by t1.fitemid,t1.fneeddate,t1.foweqty

--OPEN icbom_cursor
--
--FETCH NEXT FROM icbom_cursor 
--INTO @fsupplyid,@fdeptid,@flineid,@fsourcetrantype,@fsourceinterid,@fisbackflush,@fstockmanagerid,@fstockid

select @fminid=0,@fmaxid=0
select @fminid=isnull(min(fid),0),@fmaxid=isnull(max(fid),0) from #Cursor

WHILE @fmaxid>0 and @fminid<=@fmaxid -- @@FETCH_STATUS = 0
BEGIN 
	select @fppbomentryid=fppbomentryid,@fitemid=fitemid,@fsourceinterid=fsourceinterid,@foweqty=foweqty
	from #Cursor where fid=@fminid

	set @flastqty=0
	select @flastqty=flastqty from #My_t_TempInventory where fitemid=@fitemid

	if @flastqty>=0
	--begin
	--		update t1 set foweqty=@foweqty,ffenpeiqty=0
	--		from #My_t_MrpRoughNeedSource t1
	--		where t1.fsourceinterid=@fsourceinterid and t1.fppbomentryid=@fppbomentryid
	--end
	--else
	begin
		if @foweqty<=@flastqty
		begin
			update t1 set foweqty2=0,ffenpeiqty2=@foweqty
			from #My_t_MrpRoughNeedSource t1
			where t1.fsourceinterid=@fsourceinterid and t1.fppbomentryid=@fppbomentryid
	
			update t1 set flastqty=flastqty-@foweqty from #My_t_TempInventory t1 where t1.fitemid=@fitemid
		end
		else
		begin
			update t1 set foweqty2=t1.foweqty2-@flastqty,ffenpeiqty2=@flastqty
			from #My_t_MrpRoughNeedSource t1
			where t1.fsourceinterid=@fsourceinterid and t1.fppbomentryid=@fppbomentryid
	
			update t1 set flastqty=0 from #My_t_TempInventory t1 where t1.fitemid=@fitemid
		end
	end

	set @fminid=@fminid+1
--	FETCH NEXT FROM icbom_cursor 
--    INTO @fsupplyid,@fdeptid,@flineid,@fsourcetrantype,@fsourceinterid,@fisbackflush,@fstockmanagerid,@fstockid
END

--select * from ictranstype

----半成品只取展望期内的需求
--if @fitemtype=1
--begin
--	delete t1
--	from #My_t_MrpRoughNeedSource t1 
--	inner join t_icitem t2 on t1.fitemid=t2.fitemid
--	where t1.frunid=@frunid and datediff(day,getdate(),t1.fneeddate)>@FHalfProductProspectDays  --半成品展望期30天
--
--	delete t1
--	from #My_t_MrpWillInStock t1 
--	inner join t_icitem t2 on t1.fitemid=t2.fitemid
--	where t1.frunid=@frunid and datediff(day,getdate(),t1.fdate)>@FHalfProductProspectDays  --半成品展望期30天
--end

--结果临时存放----------- 
select identity(int,1,1) 序号,cast(t1.fproductsuit as bit) 选择,cast(t1.fordersuit as bit) 整单配套,
cast(t1.fproductsuit as bit) 产品配套,
t10.fentryid 分录号,t9.finterid 任务单内码,t9.fbillno 任务单号,
isnull(t11.fbillno,'') 订单编号,cast('' as varchar(200)) 配套分析,
isnull(t11.FHeadSelfS0144,'') 源销售订单号,isnull(t11.FHeadSelfS0143,'') 源采购订单号,t1.fneeddate 需求日期,
t7.fnumber 产品编码,t7.fname 产品名称,t7.fmodel 产品规格型号,cast(t9.FHeadSelfJ0183 as int) 任务数,
t2.fitemid 物料内码,t2.fnumber 物料编码,t2.fname 名称,t2.fmodel 规格型号,t3.fname 单位,
t5.fqty 未发总数,t1.fqty 未发数,isnull(t4.fqty,0) 库存,isnull(t4.ffenpeiqty,0) 已分配数,
(isnull(t4.fqty,0)-isnull(t4.ffenpeiqty,0)) 可用库存数,t1.ffenpeiqty 分配数,t1.foweqty 欠数,
--(isnull(t4.fqty,0)-isnull(t4.ffenpeiqty,0)-t5.fqty)库存余数,
isnull(t8.fqty,0) 待检,t1.ffenpeiqty2 分配数二,t1.foweqty2 欠数二,isnull(t6.fqty,0) 预计入库,t12.fname 仓库,t1.fsourceentryid 源单行号 --,t1.fqty 库存可发
--t1.fqty 预计可发,
into #temp
from #My_t_MrpRoughNeedSource t1 
inner join t_icitem t2 on t1.fitemid=t2.fitemid
inner join t_measureunit t3 on t2.funitid=t3.fitemid
inner join (select fitemid,sum(fqty) fqty from #My_t_MrpRoughNeedSource group by fitemid) t5 on t5.fitemid=t1.fitemid
left join (select fitemid,sum(isnull(fqty,0)) fqty from #My_t_TempInventory group by fitemid) t8 on t8.fitemid=t1.fitemid
left join (select fitemid,sum(isnull(fqty,0)) fqty,sum(isnull(ffenpeiqty,0)) ffenpeiqty from #My_t_MrpStock group by fitemid) t4 on t4.fitemid=t1.fitemid
left join (select fitemid,sum(isnull(fqty,0)) fqty from #My_t_MrpWillInStock group by fitemid) t6 on t6.fitemid=t1.fitemid
inner join icmo t9 on t9.finterid=t1.fsourceinterid
left join seorderentry t10 on t10.finterid=t9.forderinterid and t10.fentryid=t9.fsourceentryid
left join seorder t11 on t10.finterid=t11.finterid
inner join t_icitem t7 on t7.fitemid=t9.fitemid
inner join t_stock t12 on t12.fitemid=t2.fdefaultloc
--where isnull(t5.fqty,0)>isnull(t4.fqty,0)
order by t1.fordersuit desc,t1.fneeddate,t11.fbillno,t1.fproductsuit desc,
(case when t1.foweqty>0 then 1 else 0 end),
t9.fbillno,t2.fnumber

--配套分析
update t2 set 配套分析=t1.配套分析
from
(
	select 订单编号,'任务数 '+cast(任务数 as varchar(20))+'  ('+cast(分录数 as varchar(20))+')  ' +
	'配套数 '+cast(配套总数 as varchar(20))+'  ('+cast(配套分录数 as varchar(20))+')  ' +
	'未配套数 '+cast((任务数-配套总数) as varchar(20))+'  ('+cast((分录数-配套分录数) as varchar(20))+')  ' 配套分析
	from
	(
		select 订单编号,sum(任务数) 任务数,sum(配套总数) 配套总数,count(1) 分录数,sum(配套分录数) 配套分录数
		from
		(
			select t1.任务单内码,min(t1.任务数) 任务数,订单编号,min(t1.配套总数) 配套总数,min(t1.配套分录数) 配套分录数
			from 
			(
				select t1.任务单内码,t1.任务数,t1.订单编号,(case when 产品配套=1 then 任务数 else 0 end) 配套总数,
				(case when 产品配套=1 then 1 else 0 end) 配套分录数
				from #temp t1 
			) t1 group by t1.任务单内码,t1.订单编号
		) t1 group by 订单编号
	) t1
) t1 inner join #temp t2 on t1.订单编号=t2.订单编号

--处理分录号-------------
declare @ftemporderbillno varchar(50),@ftempentryid int select @ftemporderbillno='',@ftempentryid=1
truncate table #Cursor
insert into #Cursor(fsourceinterid,forderbillno)
select t1.任务单内码,订单编号 from (select t1.任务单内码,min(订单编号) 订单编号,min(t1.序号) 序号 from #temp t1 group by t1.任务单内码) t1 order by t1.序号

--OPEN icbom_cursor
--
--FETCH NEXT FROM icbom_cursor 
--INTO @fsupplyid,@fdeptid,@flineid,@fsourcetrantype,@fsourceinterid,@fisbackflush,@fstockmanagerid,@fstockid

select @fminid=0,@fmaxid=0
select @fminid=isnull(min(fid),0),@fmaxid=isnull(max(fid),0) from #Cursor

WHILE @fmaxid>0 and @fminid<=@fmaxid -- @@FETCH_STATUS = 0
BEGIN 
	select @fsourceinterid=fsourceinterid,@forderbillno=forderbillno from #Cursor where fid=@fminid

	if @ftemporderbillno<>@forderbillno
	begin
	    set @ftemporderbillno=@forderbillno
		set @ftempentryid=1
		update t1 set 分录号=1 from #temp t1 where 任务单内码=@fsourceinterid and 订单编号=@forderbillno
	end
	else
	begin
	    set @ftempentryid=@ftempentryid+1
		update t1 set 分录号=@ftempentryid from #temp t1 where 任务单内码=@fsourceinterid and 订单编号=@forderbillno
	end

	set @fminid=@fminid+1
--	FETCH NEXT FROM icbom_cursor 
--    INTO @fsupplyid,@fdeptid,@flineid,@fsourcetrantype,@fsourceinterid,@fisbackflush,@fstockmanagerid,@fstockid
END

--处理表头显示方式--------------
declare @ftempicmointerid int select @ftemporderbillno='', @ftempicmointerid=0
truncate table #Cursor
insert into #Cursor(fsourceinterid,forderbillno)
select t1.任务单内码,订单编号 from #temp t1 order by t1.序号

--OPEN icbom_cursor
--
--FETCH NEXT FROM icbom_cursor 
--INTO @fsupplyid,@fdeptid,@flineid,@fsourcetrantype,@fsourceinterid,@fisbackflush,@fstockmanagerid,@fstockid

select @fminid=0,@fmaxid=0
select @fminid=isnull(min(fid),0),@fmaxid=isnull(max(fid),0) from #Cursor

WHILE @fmaxid>0 and @fminid<=@fmaxid -- @@FETCH_STATUS = 0
BEGIN 
	select @fsourceinterid=fsourceinterid,@forderbillno=forderbillno from #Cursor where fid=@fminid

	--if @ftemporderbillno<>@forderbillno
	--begin
	--	set @ftemporderbillno=@forderbillno
	--end
	--else
	--begin
	--	update t1 set 订单编号='',源销售订单号='',源采购订单号='',需求日期='1901-01-01',配套分析=''
	--	from #temp t1 where 序号=@fminid
	--end

	if @ftempicmointerid<>@fsourceinterid
	begin
		set @ftempicmointerid=@fsourceinterid
	end
	else
	begin
		update t1 set 整单配套=0,产品配套=0,分录号=0,任务单号='',源销售订单号='',
		--源采购订单号='',需求日期='1901-01-01',订单编号='',
		产品编码='',产品名称='',产品规格型号='',任务数=0,配套分析='',源单行号=0
		from #temp t1 where 序号=@fminid
	end

	set @fminid=@fminid+1
--	FETCH NEXT FROM icbom_cursor 
--    INTO @fsupplyid,@fdeptid,@flineid,@fsourcetrantype,@fsourceinterid,@fisbackflush,@fstockmanagerid,@fstockid
END

--结果显示---------------
select 产品配套 选择,(case when 整单配套=0 then '' else 'Y' end) 整单配套,
(case when 产品配套=0 then '' else 'Y' end) 产品配套,
(case when 源单行号=0 then null else 源单行号 end) 源单行号,
(case when 分录号=0 then null else 分录号 end) 分录号,
任务单内码,(case when 需求日期='1901-01-01' then null else 需求日期 end) 需求日期,
源销售订单号,源采购订单号,订单编号,
任务单号,(case when 任务数=0 then null else 任务数 end) 任务数,配套分析,
产品编码,产品名称,产品规格型号,
物料内码,物料编码,名称,规格型号,单位,未发总数,未发数,库存,已分配数,
可用库存数,分配数,欠数,待检,分配数二,欠数二,预计入库,仓库 from #temp order by 序号

--drop table #plantemp
drop table #temp
--drop table #source
drop table #data
--drop table #my_t_MrpResultDetail
--drop table #sourcedata
drop table #My_t_MrpRoughNeedSource
drop table #My_t_MrpWillInStock
drop table #My_t_TempInventory
drop table #My_t_MrpStock

set nocount off

GO






--模拟发料--按预测订单--将选择的数据按BOM展开,半成品的料是要成套购买的,实际相当于半成品的MRP计算,不是真正意义上的模拟
--exec My_P_SimulateOutStockByPPOrder 16394,2
IF EXISTS (select * from sysobjects where name='My_P_SimulateOutStockByPPOrder' and xtype='p')  drop  procedure My_P_SimulateOutStockByPPOrder
go

create procedure [dbo].My_P_SimulateOutStockByPPOrder (@fuserid int,@fordertype int,@ferpclsid int)  --@fordertype 0 非专利 1 专利 @ferpclsid 2 自制

as
set nocount on

--declare @fuserid int,@ferpclsid int select @fuserid=16394,@ferpclsid=2

Create Table #MyData (/*FIndex int IDENTITY,*/ fproductid int,FItemID int null,fqty decimal(24,2),ftype int)  

declare @fdeptid int,@fitemid int,@fpqty decimal(24,2),@forderinterid int,@fqty decimal(24,2),@fsourceinterid int
declare @fsourcebillno varchar(50),@fsourceentryid int,@fnumber varchar(50),@fsourcetrantype int
declare @fbegdate datetime,@fenddate datetime,@finvdate datetime,@fcaldate datetime,@FOrderBillLike varchar(120)
declare @fsendenddate datetime,@iRunID int, @iYear int,@iPeriod int,@fpackoutstockinterid int

Create Table #Data (fsourceinterid int,fsourceentryid int,fscrap decimal(24,2),fscrapqty decimal(24,2),fproductid int,
fproductqty decimal(24,2),fharfproductid int,fstockid int,
fperqty decimal(24,2),fbomqty decimal(24,2),fitemid int,fqty decimal(24,2),ftype int)

Create Table #HarfData (fsourceinterid int,fsourceentryid int,fscrap decimal(24,2),fscrapqty decimal(24,2),fproductid int,
fproductqty decimal(24,2),fstockid int,
fperqty decimal(24,2),fbomqty decimal(24,2),fitemid int,fqty decimal(24,2),ftype int)


declare @fdate datetime,@fscrap decimal(24,4),@fpacksubid int,@fstockid int,@forderentryid int

select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期

Create Table #Mutidata     (  FIndex int IDENTITY,FEntryID INT, FBomInterid int, FItemID int null, FNeedQty decimal(28,14) default(0) null, FBOMLevel int null, 
FItemType int null, FParentID int default(0)null, FRate   decimal(28,14) default(0) null, FHistory int default(0) null, FHaveMrp smallint default(0) null, 
FLevelString varchar(300) null, FBom int, FMaterielType int  default(371) null,FOperSN Int NULL DEFAULT(0),FOperID int default(0)) 
 
Create Table #MutiParentItem(  FIndex int IDENTITY,FEntryID INT default(0), FBomInterid int, FItemID int null, FNeedQty decimal(28,14) default(0) null, FBOMLevel 
int null, FItemType int null,  FParentID int default(0)null, FRate   decimal(28,14) default(0) null, FHistory int default(0) null, FHaveMrp smallint default(0) 
null, FLevelString varchar(300) null , FBom int, FMaterielType int  default(371) null,FOperSN Int NULL DEFAULT(0),FOperID int default(0)) 

Create Table #Errors ( FIndex int IDENTITY, FType smallint default(0), FErrText nvarchar(655) )
create table #SourceData(fsourcetrantype int,fqty decimal(24,2),fitemid int,finterid int,fentryid int)

--if @fordertype=0
--begin
	insert into #SourceData(fsourcetrantype,fqty,fitemid,finterid,fentryid)
	select 87 fsourcetrantype,t2.fqty,t1.fitemid,t2.finterid,t2.fentryid
	from pporderentry t2
	inner join My_t_PPOrderTemp t5 on t2.finterid=t5.finterid and t2.fentryid=t5.fentryid
	inner join t_icitem t1 on t1.fitemid=t2.fitemid
	inner join icbom t3 on t3.fitemid=t2.fitemid and t3.fusestatus=1072
	inner join pporder t4 on t4.finterid=t2.finterid
	--inner join t_department t6 on t6.fitemid=t4.FHeadSelfY0121
	where t5.fuserid=@fuserid and t2.forderclosed<>1
	--and t6.fnumber not like '08.11.%'
--end
--else
--begin
--	insert into #SourceData(fsourcetrantype,fqty,fitemid,finterid,fentryid)
--	select 87 fsourcetrantype,t2.fqty,t1.fitemid,t2.finterid,t2.fentryid
--	from pporderentry t2
--	inner join My_t_PPOrderTemp t5 on t2.finterid=t5.finterid and t2.fentryid=t5.fentryid
--	inner join t_icitem t1 on t1.fitemid=t2.fitemid
--	inner join icbom t3 on t3.fitemid=t2.fitemid and t3.fusestatus=1072
--	inner join pporder t4 on t4.finterid=t2.finterid
--	inner join t_department t6 on t6.fitemid=t4.FHeadSelfY0121
--	where t5.fuserid=@fuserid and t6.fnumber like '08.11.%'
--end

DECLARE Seorder_Cursor CURSOR FOR
select fsourcetrantype,sum(fqty) fqty,fitemid,finterid,fentryid 
from #SourceData 
group by fsourcetrantype,fitemid,finterid,fentryid

OPEN Seorder_Cursor

FETCH NEXT FROM Seorder_Cursor 
INTO @fsourcetrantype,@fqty,@fitemid,@forderinterid,@forderentryid

WHILE @@FETCH_STATUS = 0
BEGIN
	Insert into #mutiParentItem (fbominterid,FItemID,FNeedQty,FBOMLevel,FParentID,FItemType,FBom)
	Select a.finterid, t1.FItemID,a.fqty, 0,0,(case t5.FID when 'WG' then 
	0 when 'ZZ' then 1 when 'WWJG' then 1 else 2 end) FItemtype,t1.FItemID 
	From icbom a
	inner join t_ICItem t1 on t1.FItemID = a.fitemid
	left join t_Submessage t5 on t1.FErpClsID = t5.FInterID 
	where --t5.FTypeID = 210 and  
	t1.fitemid =@fitemid and a.fusestatus=1072 

	declare @p5 int
	set @p5=0
	declare @p6 nchar(400)
	set @p6=''
	exec PlanMutiBomExpand 50,1,'1900-01-01 00:00:00:000','2100-01-01 00:00:00:000',@p5 output,@p6 output
 
	insert into #HarfData(fstockid,   fsourceinterid,fsourceentryid, fscrap,fscrapqty,fproductid,fproductqty,fperqty,    fbomqty,          fitemid,   fqty,             ftype) 
	select                t3.fstockid,@forderinterid,@forderentryid, 0,     0,        @fitemid,  @fqty,      t1.fneedqty,@fqty*t1.fneedqty,t1.fitemid,@fqty*t1.fneedqty*(1+t3.fscrap/100),0
	from #Mutidata t1 
	inner join t_icitem t2 on t1.fitemid=t2.fitemid 
	inner join icbomchild t3 on t1.fbominterid=t3.finterid and t3.fentryid=t1.fentryid
	where t2.ferpclsid in (5)

	insert into #Data(fharfproductid,fstockid,   fsourceinterid,fsourceentryid, fscrap,fscrapqty,fproductid,fproductqty,fperqty,    fbomqty,          fitemid,   fqty,             ftype) 
	select            (select top 1 fitemid from #HarfData where fproductid=@fitemid),
									 t3.fstockid,@forderinterid,@forderentryid, 0,     0,        @fitemid,  @fqty,      t1.fneedqty,@fqty*t1.fneedqty,t1.fitemid,@fqty*t1.fneedqty*(1+t3.fscrap/100),0
	from #Mutidata t1 
	inner join t_icitem t2 on t1.fitemid=t2.fitemid 
	inner join icbomchild t3 on t1.fbominterid=t3.finterid and t3.fentryid=t1.fentryid
	where t2.ferpclsid in (1,2)

	delete from #Mutidata
	delete from #mutiParentItem

    FETCH NEXT FROM Seorder_Cursor 
    INTO @fsourcetrantype,@fqty,@fitemid,@forderinterid,@forderentryid
END

CLOSE Seorder_Cursor
DEALLOCATE Seorder_Cursor

--待检
create table #TempInventory(fitemid int,fqty decimal(24,2))

--if @fordertype=0
--begin
	insert into #TempInventory(fitemid,   fqty)
	/*--直接用代检仓的数据
	select                     t1.fitemid,sum(t1.fqty) fqty
	from POInventory t1
	inner join t_ICItem t2 on t1.FItemID=t2.FItemID
	inner join t_stock t3 on t3.fitemid=t1.FStockID
	where --t2.ferpclsid in (1) and 
	t1.fqty>0 and t1.fstockid=18132
	and t3.fnumber not like '11.%' 
	and t2.fitemid in (select fitemid from #Data )
	group by t1.fitemid
	*/
	--待检--已经审核且未关闭的收料通知单
	select t2.fitemid,sum(t2.fqty-t2.fcommitqty-t2.fbackqty)
	from poinstock t1
	inner join poinstockentry t2 on t1.finterid=t2.finterid
	inner join t_icitem t3 on t2.fitemid=t3.fitemid
	inner join t_department t4 on t1.fdeptid=t4.fitemid
	where t1.fstatus in (1,2) and t2.fqty>(t2.fcommitqty+t2.fbackqty) and t1.ftrantype=72
	and t2.fitemid in (select fitemid from #Data) 
	--and t4.fnumber not like '08.11.%'
	group by t2.fitemid
--end
--else
--begin
--	insert into #TempInventory(fitemid,   fqty)
--	select t2.fitemid,sum(t2.fqty-t2.fcommitqty-t2.fbackqty)
--	from poinstock t1
--	inner join poinstockentry t2 on t1.finterid=t2.finterid
--	inner join t_icitem t3 on t2.fitemid=t3.fitemid
--	inner join t_department t4 on t1.fdeptid=t4.fitemid
--	where t1.fstatus<>3 and t2.fqty>(t2.fcommitqty+t2.fbackqty) and t1.ftrantype=72
--	and t2.fitemid in (select fitemid from #Data) and t4.fnumber like '08.11.%'
--	group by t2.fitemid
--end

--待检(未审核的外购入库单)
insert into #TempInventory(fitemid,   fqty)
select                     t2.fitemid,t2.fqty
from icstockbill t1
inner join icstockbillentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where t1.fstatus=0 and t2.FSourceTranType=72 
--and t4.fnumber not like '08.11.%'
and t2.fitemid in (select fitemid from #Data) and t1.ftrantype=1

--库存
create table #Invdata(fitemid int,fqty decimal(24,2))

--if @fordertype=0
--begin
	insert into #Invdata(fitemid,   fqty)
	select               t1.fitemid,sum(t1.fqty) fqty
	from icinventory t1
	inner join t_ICItem t2 on t1.FItemID=t2.FItemID
	inner join t_stock t3 on t3.fitemid=t1.fstockid
	where --t2.ferpclsid in (1) and 
	t1.fqty>0 and t3.fname not like '%不良%'
	--and t3.fnumber not like '11.%' 
	--and (t2.fnumber like 'H.%' or t2.fnumber like 'K.%' or t2.fnumber like 'M.%' or t2.fnumber like 'N.%')
	and t2.fitemid in (select fitemid from #Data )
	group by t1.fitemid
--end
--else
--begin
--	insert into #Invdata(fitemid,   fqty)
--	select               t1.fitemid,sum(t1.fqty) fqty
--	from icinventory t1
--	inner join t_ICItem t2 on t1.FItemID=t2.FItemID
--	inner join t_stock t3 on t3.fitemid=t1.fstockid
--	where --t2.ferpclsid in (1) and 
--	t1.fqty>0 and t3.fname not like '%不良%'
--	and t3.fnumber like '11.%' 
--	--and (t2.fnumber like 'H.%' or t2.fnumber like 'K.%' or t2.fnumber like 'M.%' or t2.fnumber like 'N.%')
--	and t2.fitemid in (select fitemid from #Data )
--	group by t1.fitemid
--end

--在途
create table #OnOrder(fitemid int,fqty decimal(24,2))


--在途--采购订单
--if @fordertype=0
--begin
	insert into #OnOrder(fitemid,   fqty)
	select               t2.fitemid,t2.fqty-t2.fcommitqty
	from poorder t1
	inner join poorderentry t2 on t1.finterid=t2.finterid
	inner join t_icitem t3 on t2.fitemid=t3.fitemid
	inner join t_department t4 on t1.fdeptid=t4.fitemid
	where --t1.FClosed<>1 
	t2.fmrpclosed<>1 --and t1.fstatus>0 
	--and t4.fnumber not like '08.11.%'
	--and t1.fstatus<>3  --采购订单收料完毕就关闭，但不一定已经入库
	and t3.ferpclsid in (1) 
	--and (t3.fnumber like 'H.%' or t3.fnumber like 'K.%' or t3.fnumber like 'M.%' or t3.fnumber like 'N.%')
	and (t2.fqty-t2.fcommitqty)>0
	and t2.fitemid in (select fitemid from #Data )
--end
--else
--begin
--	insert into #OnOrder(fitemid,   fqty)
--	select               t2.fitemid,t2.fqty-t2.fcommitqty
--	from poorder t1
--	inner join poorderentry t2 on t1.finterid=t2.finterid
--	inner join t_icitem t3 on t2.fitemid=t3.fitemid
--	inner join t_department t4 on t1.fdeptid=t4.fitemid
--	where --t1.FClosed<>1 
--	t2.fmrpclosed<>1 --and t1.fstatus>0 
--	and t4.fnumber like '08.11.%'
--	--and t1.fstatus<>3  --采购订单收料完毕就关闭，但不一定已经入库
--	and t3.ferpclsid in (1) 
--	--and (t3.fnumber like 'H.%' or t3.fnumber like 'K.%' or t3.fnumber like 'M.%' or t3.fnumber like 'N.%')
--	and (t2.fqty-t2.fcommitqty)>0
--	and t2.fitemid in (select fitemid from #Data )
--end

--在途--采购申请单
--if @fordertype=0
--begin
	insert into #OnOrder(fitemid,   fqty)
	select               t2.fitemid,t2.fqty-t2.fcommitqty
	from porequest t1
	inner join porequestentry t2 on t1.finterid=t2.finterid
	inner join t_icitem t3 on t2.fitemid=t3.fitemid
	inner join t_department t4 on t1.fdeptid=t4.fitemid
	where --t1.fstatus>0 and 
	t1.fstatus<>3 and t2.fmrpclosed=0
	and t3.ferpclsid in (1)
	--and t4.fnumber not like '08.11.%'
	--and (t3.fnumber like 'H.%' or t3.fnumber like 'K.%' or t3.fnumber like 'M.%' or t3.fnumber like 'N.%')
	and (t2.fqty-t2.fcommitqty)>0
	and t2.fitemid in (select fitemid from #Data )
--end
--else
--begin
--	insert into #OnOrder(fitemid,   fqty)
--	select               t2.fitemid,t2.fqty-t2.fcommitqty
--	from porequest t1
--	inner join porequestentry t2 on t1.finterid=t2.finterid
--	inner join t_icitem t3 on t2.fitemid=t3.fitemid
--	inner join t_department t4 on t1.fdeptid=t4.fitemid
--	where t1.fstatus>0 and t1.fstatus<>3
--	and t3.ferpclsid in (1)
--	and t4.fnumber like '08.11.%'
--	--and (t3.fnumber like 'H.%' or t3.fnumber like 'K.%' or t3.fnumber like 'M.%' or t3.fnumber like 'N.%')
--	and (t2.fqty-t2.fcommitqty)>0
--	and t2.fitemid in (select fitemid from #Data )
--end

--在途--未审核的收料通知单
insert into #OnOrder(fitemid,   fqty)
select               t2.fitemid,sum(t2.fqty)
from poinstock t1
inner join poinstockentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where t1.fstatus in (0) and t1.ftrantype=72
and t2.fitemid in (select fitemid from #Data) 
--and t4.fnumber not like '08.11.%'
group by t2.fitemid

--预计入库
create table #WillIn(fitemid int,fqty decimal(24,2))


--预测
create table #Forecast(fitemid int,fqty decimal(24,2))


--未出--去掉选择的订单涉及到的未出库数，因为毛需求已经包括
create table #NoOut(fitemid int,fqty decimal(24,2))

--if @fordertype=0
--begin
	insert into #NoOut(fitemid,   fqty)
	select t4.fitemid,sum(t4.fqtymust-t4.fstockqty)
	from ppbomentry t4 
	inner join ppbom t5  on t5.finterid=t4.finterid
	inner join t_icitem t8 on t8.fitemid=t4.fitemid
	inner join icmo t1 on t4.ficmointerid=t1.finterid
	inner join t_icitem t3 on t3.fitemid=t1.fitemid
	inner join t_department t6 on t1.fworkshop=t6.fitemid
	inner join pporderentry t2 on t2.finterid=t1.fpporderinterid and t2.fentryid=t1.fsourceentryid
	where t1.fstatus>0 and t1.fstatus<>3 and t4.fqtymust>t4.fstockqty
	and t4.fitemid in (select fitemid from #Data) and t1.fpporderinterid<>0 and t2.forderclosed<>1
	--and t6.fnumber not like '08.11.%'
	and not exists (select 1 from My_t_PPOrderTemp where fuserid=@fuserid and finterid=t1.fpporderinterid and fentryid=t1.fsourceentryid)
	group by t4.fitemid
--end
--else
--begin
--	insert into #NoOut(fitemid,   fqty)
--	select t4.fitemid,sum(t4.fqtymust-t4.fstockqty)
--	from ppbomentry t4 
--	inner join ppbom t5  on t5.finterid=t4.finterid
--	inner join t_icitem t8 on t8.fitemid=t4.fitemid
--	inner join icmo t1 on t4.ficmointerid=t1.finterid
--	inner join t_icitem t3 on t3.fitemid=t1.fitemid
--	inner join t_department t6 on t1.fworkshop=t6.fitemid
--	where t1.fstatus>0 and t1.fstatus<>3 and t4.fqtymust>t4.fstockqty
--	and t4.fitemid in (select fitemid from #Data)
--	and t6.fnumber like '08.11.%'
--	and not exists (select 1 from My_t_PPOrderTemp where fuserid=@fuserid and finterid=t1.fpporderinterid and fentryid=t1.fsourceentryid)
--	group by t4.fitemid
--end

select cast(0 as bit) 选择,(case when 87=87 then '预测订单' else '销售订单' end ) 源单类型,
isnull(t2.fbillno,'') 源单编号,t2.fdate 下单日期,
t5.fnumber 产品编码,t5.fname 产品名称,t15.fitemid 半制品内码,t15.fnumber 半制品编码,t15.fname 半制品名称,
t6.fitemid 物料内码,t6.fnumber 物料编码,t6.fname 物料名称,t11.fname 单位,t1.fqty 毛需求,isnull(t10.fqty,0) 未出数,
isnull(t9.fqty,0) 在途数,isnull(t8.fqty,0) 待检数,isnull(t7.fqty,0) 库存数,--isnull(t12.fqty,0) 预测数,
--isnull(t4.fqty,0) 预计入库,
t1.fqty 可发料数,--t1.fqty 可下计划数,
t13.fname 仓管员,t14.fname 物料类别,t17.fname 倒冲
from #Data t1
inner join pporderentry t3 on t3.finterid=t1.fsourceinterid and t1.fsourceentryid=t3.fentryid --and 
inner join pporder t2 on t2.finterid=t3.finterid
inner join t_icitem t5 on t3.fitemid=t5.fitemid
inner join t_icitem t6 on t1.fitemid=t6.fitemid
left join #Invdata t7 on t7.fitemid=t1.fitemid
left join (select fitemid,sum(fqty) fqty from #TempInventory group by fitemid) t8 on t8.fitemid=t1.fitemid
left join (select fitemid,sum(fqty) fqty from #OnOrder group by fitemid) t9 on t9.fitemid=t1.fitemid
left join #NoOut t10 on t10.fitemid=t1.fitemid
inner join t_measureunit t11 on t11.fitemid=t6.funitid
inner join t_SubMessage t13 on t13.finterid=t6.f_114 and t13.ftypeid=10003
inner join t_SubMessage t14 on t14.finterid=t6.ftypeid and t14.ftypeid=504
left join t_SubMessage t17 on t17.finterid=t6.f_115 and t17.ftypeid=10002
left join (select fitemid,sum(fqty) fqty from #WillIn group by fitemid) t4 on t4.fitemid=t1.fitemid
left join #Forecast t12 on t12.fitemid=t1.fitemid
left join t_icitem t15 on t15.fitemid=t1.fharfproductid
where t6.ferpclsid=@ferpclsid
order by t15.fnumber,t6.fnumber,isnull(t2.fbillno,'')

drop table #OnOrder
drop table #Invdata
drop table #TempInventory
drop table #Data
drop table #MyData
drop table #Mutidata
drop table #MutiParentItem
drop table #Errors
drop table #NoOut
drop table #Forecast
drop table #WillIn
drop table #HarfData
drop table #SourceData

set nocount off

go 


----模拟发料--按排程明细--模拟有2种目的: 1 现有物料是否已经下足 2 现有库存物料是否能满足生产所选单据 3 模拟的的结果要能清楚告诉用户数据来源是什么  4 只跟踪选中的数据涉及到的物料  5 订单模拟优先考虑计划单和任务单，计划单模拟优先考虑任务单
----exec My_P_SimulateOutStock 16394
--IF EXISTS (select * from sysobjects where name='My_P_SimulateOutStock' and xtype='p')  drop  procedure My_P_SimulateOutStock
--go
--
--create procedure [dbo].My_P_SimulateOutStock (@fuserid int) --,@fordertype int @fordertype 0 非专利 1 专利
--
--as
--set nocount on
--
----declare @fcommitdate datetime,@fuserid int,@frunid int,@fbillno varchar(20) select @fbillno='',@fcommitdate='2011-07-23',@fuserid=16394,@frunid=0  
--
--Create Table #MyData (/*FIndex int IDENTITY,*/ fproductid int,FItemID int null,fqty decimal(24,2),ftype int)  
--
--declare @fdeptid int,@fitemid int,@fpqty decimal(24,2),@forderinterid int,@fqty decimal(24,2),@fsourceinterid int
--declare @fsourcebillno varchar(50),@fsourceentryid int,@fnumber varchar(50),@fsourcetrantype int
--declare @fbegdate datetime,@fenddate datetime,@finvdate datetime,@fcaldate datetime,@FOrderBillLike varchar(120)
--declare @fsendenddate datetime,@iRunID int, @iYear int,@iPeriod int,@fpackoutstockinterid int
--
--Create Table #Data (fsourcetrantype int,fsourceinterid int,fsourceentryid int,fscrap decimal(24,2),fscrapqty decimal(24,2),fproductid int,
--fproductqty decimal(24,2),fstockid int,
--fperqty decimal(24,2),fbomqty decimal(24,2),fitemid int,fqty decimal(24,2),ftype int)
--
--declare @fdate datetime,@fscrap decimal(24,4),@fpacksubid int,@fstockid int,@forderentryid int
--declare @fbomlevel int
--
--select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期
--
--Create Table #Mutidata     (  FIndex int IDENTITY,FEntryID INT, FBomInterid int, FItemID int null, FNeedQty decimal(28,14) default(0) null, FBOMLevel int null, 
--FItemType int null, FParentID int default(0)null, FRate   decimal(28,14) default(0) null, FHistory int default(0) null, FHaveMrp smallint default(0) null, 
--FLevelString varchar(300) null, FBom int, FMaterielType int  default(371) null,FOperSN Int NULL DEFAULT(0),FOperID int default(0)) 
-- 
--Create Table #MutiParentItem(  FIndex int IDENTITY,FEntryID INT default(0), FBomInterid int, FItemID int null, FNeedQty decimal(28,14) default(0) null, FBOMLevel 
--int null, FItemType int null,  FParentID int default(0)null, FRate   decimal(28,14) default(0) null, FHistory int default(0) null, FHaveMrp smallint default(0) 
--null, FLevelString varchar(300) null , FBom int, FMaterielType int  default(371) null,FOperSN Int NULL DEFAULT(0),FOperID int default(0)) 
--
--Create Table #Errors ( FIndex int IDENTITY, FType smallint default(0), FErrText nvarchar(655) )
--
--DECLARE Seorder_Cursor CURSOR FOR
--select t2.fsourcetrantype,t2.finterid fsourceinterid,t2.fqty,t1.fitemid,t2.forderinterid,t2.forderentryid --排程明细
--from My_t_ScheduleDetail t2
--inner join My_t_ScheduleDetailTemp t5 on t2.finterid=t5.finterid
--inner join t_icitem t1 on t1.fitemid=t2.fitemid
--inner join icbom t3 on t3.fitemid=t2.fitemid and t3.fusestatus=1072
--where t5.fuserid=@fuserid
--union all
--select 8581 fsourcetrantype,t1.finterid fsourceinterid,t1.fqty,t1.fitemid,t1.forderinterid,t1.fsourceentryid  --计划状态的任务单
--from icmo t1
--inner join t_department t4 on t1.fworkshop=t4.fitemid
--where isnull(t1.forderinterid,0)<>0 and t1.fstatus in (0)
--union all
--select 8587 fsourcetrantype,t1.finterid fsourceinterid,t1.fqty,t1.fitemid,t1.fpporderinterid,t1.fsourceentryid  --计划状态的任务单
--from icmo t1
--inner join t_department t4 on t1.fworkshop=t4.fitemid
--where isnull(t1.fpporderinterid,0)<>0 and t1.fstatus in (0)
--
--OPEN Seorder_Cursor
--
--FETCH NEXT FROM Seorder_Cursor 
--INTO @fsourcetrantype,@fsourceinterid,@fqty,@fitemid,@forderinterid,@forderentryid
--
--WHILE @@FETCH_STATUS = 0
--BEGIN
--	Insert into #mutiParentItem (fbominterid,FItemID,FNeedQty,FBOMLevel,FParentID,FItemType,FBom)
--	Select a.finterid, t1.FItemID,a.fqty, 0,0,(case t5.FID when 'WG' then 
--	0 when 'ZZ' then 1 when 'WWJG' then 1 else 2 end) FItemtype,t1.FItemID 
--	From icbom a
--	inner join t_ICItem t1 on t1.FItemID = a.fitemid
--	left join t_Submessage t5 on t1.FErpClsID = t5.FInterID 
--	where --t5.FTypeID = 210 and  
--	t1.fitemid =@fitemid and a.fusestatus=1072 
--
--	declare @p5 int
--	set @p5=0
--	declare @p6 nchar(400)
--	set @p6=''
--	exec PlanMutiBomExpand 50,1,'1900-01-01 00:00:00:000','2100-01-01 00:00:00:000',@p5 output,@p6 output
-- 
--	if @fsourcetrantype in (81,8581)  --如果是销售订单，则直接下一级即可
--		set @fbomlevel=1
--	else
--		set @fbomlevel=10
--		
--	insert into #Data(fsourcetrantype, fstockid,   fsourceinterid, fscrap,fscrapqty,fproductid,fproductqty,fperqty,    fbomqty,          fitemid,   fqty,             ftype) 
--	select            @fsourcetrantype,t3.fstockid,@forderinterid, 0,     0,        @fitemid,  @fqty,      t1.fneedqty,@fqty*t1.fneedqty,t1.fitemid,@fqty*t1.fneedqty*(1+t3.fscrap/100),0
--	from #Mutidata t1 
--	inner join t_icitem t2 on t1.fitemid=t2.fitemid 
--	inner join icbomchild t3 on t1.fbominterid=t3.finterid and t3.fentryid=t1.fentryid
--	where t2.ferpclsid in (1,2) and t1.fbomlevel<=@fbomlevel
--
--	delete from #Mutidata
--	delete from #mutiParentItem
--
--	if @fsourcetrantype in (8581,81) and exists(select 1 from seorderentry where finterid=@forderinterid and fentryid=@fsourceentryid and fentryselfs0167<>'')
--	begin
--		select top 1 @fpacksubid=isnull(t7.fid,0) 
--		from seorder t2
--		inner join seorderentry t3 on t2.finterid=t3.finterid
--		inner join t_icitem t1 on t1.fitemid=t3.fitemid
--		inner join t_BOSPackSub t7 on t7.fbillno=t3.fentryselfs0167
--		where t3.finterid=@forderinterid and t3.fentryid=@forderentryid
-- 
--		if @fpacksubid<>0
--		begin
--			set @fscrap=0
--
--			/*
--			--取损耗率
--			select top 1 @fscrap=t2.fscrap,@fstockid=t2.fstockid
--			from #Data t2
--			inner join t_icitem t3 on t2.fitemid=t3.fitemid
--			where t2.fsourceinterid=@fsourceinterid --forderinterid and forderentryid 在My_t_ScheduleDetail中可能不唯一
--			and t3.fnumber like '2.01.01.%'
--
--			--删除标签
--			delete t2 
--			from #Data t2 
--			inner join t_icitem t3 on t2.fitemid=t3.fitemid
--			where t2.fsourceinterid=@fsourceinterid and t3.fnumber like '2.01.01.%'
--			*/
--			--新增包材
--			insert into #Data(fsourcetrantype, fstockid, fsourceinterid, fsourceentryid, fscrap, fscrapqty,fproductid,fproductqty,fperqty,fbomqty,      fitemid,   fqty,                              ftype) 
--			select            @fsourcetrantype,@fstockid,@forderinterid, @fsourceentryid,@fscrap,0,        @fitemid,  @fqty,      t2.fqty,@fqty*t2.fqty,t2.fitemid,(@fqty*t2.fqty*(1+@fscrap/100)),0
--			from t_BOSPackSub t1 
--			inner join t_BOSPackSubEntry t2 on t1.fid=t2.fid 
--			inner join t_icitem t3 on t2.fitemid=t3.fitemid
--			where t1.fid=@fpacksubid
--		end
--	end
--    FETCH NEXT FROM Seorder_Cursor 
--    INTO @fsourcetrantype,@fsourceinterid,@fqty,@fitemid,@forderinterid,@forderentryid
--END
--
--CLOSE Seorder_Cursor
--DEALLOCATE Seorder_Cursor
--
----未发完料的任务单--销售订单
--insert into #Data(fsourcetrantype,  fstockid,      fsourceinterid,  fsourceentryid,    fscrap,fscrapqty,fproductid,  fproductqty,  fperqty,        fbomqty,                fitemid,   fqty,                    ftype) 
--select            8581,             t2.fdefaultloc,t1.forderinterid,t1.fsourceentryid, 0,     0,        t1.fitemid,  t1.fqty,      t4.FBOMInPutQTY,t1.fqty*t4.FBOMInPutQTY,t4.fitemid,t4.fqtymust-t4.fstockqty,0  --确认或下达状态的任务单的未出库数
--from icmo t1 
--inner join t_icitem t2 on t1.fitemid=t2.fitemid 
--inner join ppbom t3 on t1.finterid=t3.ficmointerid 
--inner join ppbomentry t4 on t3.finterid=t4.finterid
--inner join t_icitem t5 on t5.fitemid=t4.fitemid
--inner join t_department t6 on t1.fworkshop=t6.fitemid
--inner join seorderentry t7 on t7.finterid=t1.forderinterid and t7.fentryid=t1.fsourceentryid
--where t7.fmrpclosed<>1 and isnull(t1.forderinterid,0)<>0 and t1.fstatus in (1,2,5) and t4.fqtymust>t4.fstockqty
--and t4.fitemid in (select fitemid from #Data) 
--
-- 
----未发完料的任务单--预测订单
--insert into #Data(fsourcetrantype,  fstockid,      fsourceinterid,    fsourceentryid,    fscrap,fscrapqty,fproductid,  fproductqty,  fperqty,        fbomqty,                fitemid,   fqty,                    ftype) 
--select            8587,             t2.fdefaultloc,t1.fpporderinterid,t1.fsourceentryid, 0,     0,        t1.fitemid,  t1.fqty,      t4.FBOMInPutQTY,t1.fqty*t4.FBOMInPutQTY,t4.fitemid,t4.fqtymust-t4.fstockqty,0  --确认或下达状态的任务单的未出库数
--from icmo t1 
--inner join t_icitem t2 on t1.fitemid=t2.fitemid 
--inner join ppbom t3 on t1.finterid=t3.ficmointerid 
--inner join ppbomentry t4 on t3.finterid=t4.finterid
--inner join t_icitem t5 on t5.fitemid=t4.fitemid
--inner join t_department t6 on t1.fworkshop=t6.fitemid
--inner join pporderentry t7 on t7.finterid=t1.fpporderinterid and t7.fentryid=t1.fsourceentryid
--where t7.fmrpclosed<>1 and isnull(t1.fpporderinterid,0)<>0 and t1.fstatus in (1,2,5) and t4.fqtymust>t4.fstockqty
--
----待检
--create table #TempInventory(fitemid int,fqty decimal(24,2))
--
--insert into #TempInventory(fitemid,   fqty)
--/*
----直接用代检仓的数据
--select                     t1.fitemid,sum(t1.fqty) fqty
--from POInventory t1
--inner join t_ICItem t2 on t1.FItemID=t2.FItemID
--inner join t_stock t3 on t3.fitemid=t1.FStockID
--where --t2.ferpclsid in (1) and 
--t1.fqty>0 and t1.fstockid=18132
--and t3.fnumber not like '11.%' 
--and t2.fitemid in (select fitemid from #Data )
--group by t1.fitemid
--*/
--
----待检--已经审核且未关闭的收料通知单
--select t2.fitemid,sum(t2.fqty-t2.fcommitqty-t2.fbackqty)
--from poinstock t1
--inner join poinstockentry t2 on t1.finterid=t2.finterid
--inner join t_icitem t3 on t2.fitemid=t3.fitemid
--inner join t_department t4 on t1.fdeptid=t4.fitemid
--where t1.fstatus in (1,2) and t2.fqty>(t2.fcommitqty+t2.fbackqty) and t1.ftrantype=72
--and t2.fitemid in (select fitemid from #Data) 
----and t4.fnumber not like '08.11.%'
--group by t2.fitemid
--
--
----待检(未审核的外购入库单)
--insert into #TempInventory(fitemid,   fqty)
--select                     t2.fitemid,t2.fqty
--from icstockbill t1
--inner join icstockbillentry t2 on t1.finterid=t2.finterid
--inner join t_icitem t3 on t2.fitemid=t3.fitemid
--inner join t_department t4 on t1.fdeptid=t4.fitemid
--where t1.fstatus=0 and t2.FSourceTranType=72 
----and t4.fnumber not like '08.11.%'
--and t2.fitemid in (select fitemid from #Data) and t1.ftrantype=1
--
----库存
--create table #Invdata(fitemid int,fqty decimal(24,2))
--
--insert into #Invdata(fitemid,   fqty)
--select               t1.fitemid,sum(t1.fqty) fqty
--from icinventory t1
--inner join t_ICItem t2 on t1.FItemID=t2.FItemID
--inner join t_stock t3 on t3.fitemid=t1.fstockid
--where --t2.ferpclsid in (1) and 
--t1.fqty>0 and t3.fname not like '%不良%'
----and t3.fnumber not like '11.%' 
----and (t2.fnumber like 'H.%' or t2.fnumber like 'K.%' or t2.fnumber like 'M.%' or t2.fnumber like 'N.%')
--and t2.fitemid in (select fitemid from #Data )
--group by t1.fitemid
--
----在途
--create table #OnOrder(fitemid int,fqty decimal(24,2))
--
--
----在途--采购订单
--insert into #OnOrder(fitemid,   fqty)
--select               t2.fitemid,t2.fqty-t2.fcommitqty
--from poorder t1
--inner join poorderentry t2 on t1.finterid=t2.finterid
--inner join t_icitem t3 on t2.fitemid=t3.fitemid
--inner join t_department t4 on t1.fdeptid=t4.fitemid
--where --t1.FClosed<>1 
--t2.fmrpclosed<>1 --and t1.fstatus>0 
----and t1.fstatus<>3  --采购订单收料完毕就关闭，但不一定已经入库
--and t3.ferpclsid in (1) 
----and t4.fnumber not like '08.11.%'
----and (t3.fnumber like 'H.%' or t3.fnumber like 'K.%' or t3.fnumber like 'M.%' or t3.fnumber like 'N.%')
--and (t2.fqty-t2.fcommitqty)>0
--and t2.fitemid in (select fitemid from #Data )
--
----在途--采购申请单
--insert into #OnOrder(fitemid,   fqty)
--select               t2.fitemid,t2.fqty-t2.fcommitqty
--from porequest t1
--inner join porequestentry t2 on t1.finterid=t2.finterid
--inner join t_icitem t3 on t2.fitemid=t3.fitemid
--inner join t_department t4 on t1.fdeptid=t4.fitemid
--where --t1.fstatus>0 and 
--t1.fstatus<>3
--and t3.ferpclsid in (1) 
----and t4.fnumber not like '08.11.%'
----and (t3.fnumber like 'H.%' or t3.fnumber like 'K.%' or t3.fnumber like 'M.%' or t3.fnumber like 'N.%')
--and (t2.fqty-t2.fcommitqty)>0
--and t2.fitemid in (select fitemid from #Data )
--
----在途--未审核的收料通知单
--insert into #OnOrder(fitemid,   fqty)
--select               t2.fitemid,sum(t2.fqty)
--from poinstock t1
--inner join poinstockentry t2 on t1.finterid=t2.finterid
--inner join t_icitem t3 on t2.fitemid=t3.fitemid
--inner join t_department t4 on t1.fdeptid=t4.fitemid
--where t1.fstatus in (0) and t1.ftrantype=72
--and t2.fitemid in (select fitemid from #Data) 
----and t4.fnumber not like '08.11.%'
--group by t2.fitemid
--
--
----预计入库
--create table #WillIn(fitemid int,fqty decimal(24,2))
--
----预计入库--生产任务单
--insert into #WillIn(fitemid,   fqty)
--select               t2.fitemid,t2.fqty-isnull(t2.fstockqty,0)
--from icmo t2 
--inner join t_icitem t3 on t2.fitemid=t3.fitemid
--inner join t_department t4 on t2.fworkshop=t4.fitemid
--where t2.fstatus>0 and t2.fstatus<>3
----and t4.fnumber not like '08.11.%'
--and (t2.fqty-isnull(t2.fstockqty,0))>0
--and t2.fitemid in (select fitemid from #Data)
--
----预计入库--日生产计划
--insert into #WillIn(fitemid,   fqty)
--select t1.产品内码,t1.数量 
--from v_MyScheduleDetail t1
--inner join t_department t4 on t1.生产车间内码=t4.fitemid
--where t1.状态<>'Y' and t1.产品内码 in (select fitemid from #Data)
----and t4.fnumber not like '08.11.%'
--
----预测
--create table #Forecast(fitemid int,fqty decimal(24,2))
--
----预测--
--insert into #Forecast(fitemid,   fqty)
--select               t2.fitemid,sum(t2.fqty-isnull(t2.fentryselfy0121,0))  --fentryselfy0121 已排产
--from pporderentry t2 
--inner join t_icitem t3 on t2.fitemid=t3.fitemid
--inner join pporder t4 on t2.finterid=t4.finterid
----inner join t_department t1 on t4.FHeadSelfY0121=t1.fitemid
--where --t4.fstatus>0 and 
--t2.forderclosed<>1 --预测订单行业务关闭用此字段
----and t1.fnumber not like '08.11.%'
--and (t2.fqty-isnull(t2.fentryselfy0121,0))>0
----and t2.fitemid in (select fitemid from #Data)
--group by t2.fitemid
--
----未出
--create table #NoOut(fitemid int,fqty decimal(24,2))
--
--select (case when t1.fsourcetrantype=81 then '计划单(销售)' 
--			 when t1.fsourcetrantype=87 then '计划单(预测)' 
--			 when t1.fsourcetrantype=8581 then '任务单(销售)'
--			 when t1.fsourcetrantype=8587 then '任务单(预测)' end ) 源单类型,
--isnull(t3.fbillno,t4.fbillno) 源单编号,t5.fnumber 产品编码,t5.fname 产品名称,
--t6.fitemid 物料内码,t6.fnumber 物料编码,t6.fname 物料名称,t11.fname 单位,
--t1.fqty 毛需求,isnull(t10.fqty,0) 未出数,isnull(t9.fqty,0) 在途数,isnull(t8.fqty,0) 待检数,isnull(t7.fqty,0) 库存数,
--isnull(t12.fqty,0) 预测数,isnull(t15.fqty,0) 预计入库,t1.fqty 可发料数,
--t13.fname 仓管员,t14.fname 物料类别
--from #Data t1
----inner join My_t_ScheduleDetail t2 on t1.fsourceinterid=t2.finterid
--left join seorder t3 on t3.finterid=t1.fsourceinterid and t1.fsourcetrantype in (81,8581)
--left join pporder t4 on t4.finterid=t1.fsourceinterid and t1.fsourcetrantype in (87,8587)
--inner join t_icitem t5 on t1.fproductid=t5.fitemid
--inner join t_icitem t6 on t1.fitemid=t6.fitemid
--left join #Invdata t7 on t7.fitemid=t1.fitemid
--left join (select fitemid,sum(fqty) fqty from #TempInventory group by fitemid) t8 on t8.fitemid=t1.fitemid
--left join (select fitemid,sum(fqty) fqty from #OnOrder group by fitemid) t9 on t9.fitemid=t1.fitemid
--left join #NoOut t10 on t10.fitemid=t1.fitemid
--inner join t_measureunit t11 on t11.fitemid=t6.funitid
--inner join t_SubMessage t13 on t13.finterid=t6.f_114 and t13.ftypeid=10004
--inner join t_SubMessage t14 on t14.finterid=t6.ftypeid and t14.ftypeid=504
--left join (select fitemid,sum(fqty) fqty from #WillIn group by fitemid) t15 on t15.fitemid=t1.fitemid
--left join #Forecast t12 on t12.fitemid=t1.fitemid
--order by t6.fnumber,t1.fsourcetrantype,isnull(t3.fbillno,t4.fbillno)
--
--drop table #OnOrder
--drop table #Invdata
--drop table #TempInventory
--drop table #Data
--drop table #MyData
--drop table #Mutidata
--drop table #MutiParentItem
--drop table #Errors
--drop table #NoOut
--
--set nocount off
--
--go 



--My_P_ICItemINFO 6068
IF EXISTS (select * from sysobjects where name='My_P_ICItemINFO' and xtype='p')  drop  procedure My_P_ICItemINFO
go

create procedure [dbo].My_P_ICItemINFO (@fitemid int) 

as
set nocount on

--待检
create table #data(ftype varchar(20),ftrantype varchar(50),ftrantypeid int,fbillno varchar(30),finterid int,fitemid int,fqty decimal(24,2))

--待检--已经审核且未关闭的收料通知单
insert into #data(ftype,ftrantype,ftrantypeid,fbillno,finterid,fitemid,fqty)
select '待检','收料通知单',72,t1.fbillno,t1.finterid,t2.fitemid,t2.fqty-t2.fcommitqty-t2.fbackqty
from poinstock t1
inner join poinstockentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where t1.fstatus in (1,2) and t2.fqty>(t2.fcommitqty+t2.fbackqty) and t1.ftrantype=72
and t2.fitemid=@fitemid
--and t4.fnumber not like '08.11.%'


--待检(未审核的外购入库单)
insert into #data(ftype,ftrantype,ftrantypeid,fbillno,finterid,fitemid,fqty)
select  '待检','外购入库单',1,t1.fbillno,t1.finterid,t2.fitemid,t2.fqty
from icstockbill t1
inner join icstockbillentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where t1.fstatus=0 and t2.FSourceTranType=72 
--and t4.fnumber not like '08.11.%'
and t2.fitemid=@fitemid and t1.ftrantype=1

--库存
insert into #data(ftype,ftrantype,ftrantypeid,fbillno,finterid,fitemid,fqty)
select '库存',t3.fname,0,'',0,t1.fitemid,t1.fqty
from icinventory t1
inner join t_ICItem t2 on t1.FItemID=t2.FItemID
inner join t_stock t3 on t3.fitemid=t1.fstockid
where --t2.ferpclsid in (1) and 
t1.fqty>0 and t3.fname not like '%不良%'
--and t3.fnumber not like '11.%' 
--and (t2.fnumber like 'H.%' or t2.fnumber like 'K.%' or t2.fnumber like 'M.%' or t2.fnumber like 'N.%')
and t2.fitemid=@fitemid

--在途--采购订单
insert into #data(ftype,ftrantype,ftrantypeid,fbillno,finterid,fitemid,fqty)
select '在途','采购订单',71,t1.fbillno,t1.finterid,t2.fitemid,t2.fqty-t2.fcommitqty
from poorder t1
inner join poorderentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where --t1.FClosed<>1 
t2.fmrpclosed<>1 --and t1.fstatus>0 
--and t1.fstatus<>3  --采购订单收料完毕就关闭，但不一定已经入库
--and t3.ferpclsid in (1) 
--and t4.fnumber not like '08.11.%'
and t2.fitemid=@fitemid
and (t2.fqty-t2.fcommitqty)>0


--在途--采购申请单
insert into #data(ftype,ftrantype,ftrantypeid,fbillno,finterid,fitemid,fqty)
select '在途','采购申请单',70,t1.fbillno,t1.finterid,t2.fitemid,t2.fqty-t2.fcommitqty
from porequest t1
inner join porequestentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where --t1.fstatus>0 and 
t1.fstatus<>3
and t3.ferpclsid in (1)  and t2.fmrpclosed=0
--and t4.fnumber not like '08.11.%'
--and (t3.fnumber like 'H.%' or t3.fnumber like 'K.%' or t3.fnumber like 'M.%' or t3.fnumber like 'N.%')
and (t2.fqty-t2.fcommitqty)>0
and t2.fitemid=@fitemid

--在途--未审核的收料通知单
insert into #data(ftype,ftrantype,ftrantypeid,fbillno,finterid,fitemid,fqty)
select  '在途','收料通知单',72,t1.fbillno, t1.finterid,t2.fitemid,t2.fqty
from poinstock t1
inner join poinstockentry t2 on t1.finterid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t1.fdeptid=t4.fitemid
where t1.fstatus in (0) and t1.ftrantype=72
and t2.fitemid=@fitemid
--and t4.fnumber not like '08.11.%'


--预计入库

--预计入库--生产任务单
insert into #data(ftype,ftrantype,ftrantypeid,fbillno,finterid,fitemid,fqty)
select  '预计入库','生产任务单',85,t2.fbillno, t2.finterid,  t2.fitemid,t2.fqty-isnull(t2.fstockqty,0)
from icmo t2 
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join t_department t4 on t2.fworkshop=t4.fitemid
where t2.fstatus>0 and t2.fstatus<>3
--and t4.fnumber not like '08.11.%'
and (t2.fqty-isnull(t2.fstockqty,0))>0
and t2.fitemid=@fitemid

--预计入库--日生产计划
insert into #data(ftype,ftrantype,ftrantypeid,fbillno,finterid,fitemid,fqty)
select  '预计入库','计划单',0,'', 0,t1.产品内码,t1.数量 
from v_MyScheduleDetail t1
inner join t_department t4 on t1.生产车间内码=t4.fitemid
where t1.状态<>'Y' and t1.产品内码=@fitemid
--and t4.fnumber not like '08.11.%'

--预测
insert into #data(ftype,ftrantype,ftrantypeid,fbillno,finterid,fitemid,fqty)
select  '产品预测','预测单',87,t4.fbillno, t4.finterid,t2.fitemid,t2.fqty-isnull(t2.fentryselfy0121,0)  --fentryselfy0121 已排产
from pporderentry t2 
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join pporder t4 on t2.finterid=t4.finterid
--inner join t_department t1 on t4.FHeadSelfY0121=t1.fitemid
where --t4.fstatus>0 and 
t2.forderclosed<>1 --预测订单行业务关闭用此字段
--and t1.fnumber not like '08.11.%'
and (t2.fqty-isnull(t2.fentryselfy0121,0))>0
and t2.fitemid=@fitemid

--未出
--insert into #data(ftype,ftrantype,ftrantypeid,fbillno,finterid,fitemid,fqty)
--select  '未发','任务单',85,t1.fbillno,t1.finterid,t4.fitemid,t4.fqtymust-t4.fstockqty
--from ppbomentry t4 
--inner join ppbom t5  on t5.finterid=t4.finterid
--inner join t_icitem t8 on t8.fitemid=t4.fitemid
--inner join icmo t1 on t4.ficmointerid=t1.finterid
--inner join t_icitem t3 on t3.fitemid=t1.fitemid
--where t1.fstatus>0 and t1.fstatus<>3 and t4.fqtymust>t4.fstockqty
--and t4.fitemid=@fitemid

select t1.ftype 事务,t1.ftrantype 单据类型,t1.ftrantypeid 单据类型内码,t1.fbillno 单据编号,t1.finterid 单据内码,
t2.fnumber 编码,t2.fname 名称,t2.fmodel 规格型号,t1.fqty 数量
from #data t1
inner join t_icitem t2 on t1.fitemid=t2.fitemid
order by t1.ftype,t1.ftrantype

drop table #data

set nocount off

go

--排产数有误
--
--IF EXISTS (select * from sysobjects where name='my_RepairSechedulRealData' and xtype='p')  drop  procedure my_RepairSechedulRealData
--go
--
--create procedure [dbo].my_RepairSechedulRealData
--
--as
--
----FEntrySelfS0169 已排产  FEntrySelfS0170 未排产
--
--update m2 set FEntrySelfS0169=0,FEntrySelfS0170=m2.fqty
--from seorderentry m2 
--inner join seorder m3 on m2.finterid=m3.finterid
--where isnull(m2.FMrpClosed,0)<>1
--
--update m2 set FEntrySelfS0169=isnull(m1.fqty,0),FEntrySelfS0170=m2.fqty-isnull(m1.fqty,0)
--from seorderentry m2 
--inner join seorder m3 on m2.finterid=m3.finterid
--left join 
--(
--	select fsourcetrantype,forderinterid,forderentryid,sum(fqty) fqty --,fitemid
--	from my_t_scheduledetail 
--	where fsourcetrantype=81 
--	group by fsourcetrantype,forderinterid,forderentryid--,fitemid
--) m1 on m1.forderinterid=m2.finterid and m1.forderentryid=m2.fentryid --and m2.fitemid=m1.fitemid
--where isnull(m2.FMrpClosed,0)<>1
--
--
----FEntrySelfY0121 已排产  FEntrySelfY0122 未排产
--
--update m2 set FEntrySelfY0121=0,FEntrySelfY0122=m2.fqty
--from pporderentry m2 
--inner join pporder m3 on m2.finterid=m3.finterid
--
--update m2 set FEntrySelfY0121=isnull(m1.fqty,0),FEntrySelfY0122=m2.fqty-isnull(m1.fqty,0)
--from pporderentry m2 
--inner join pporder m3 on m2.finterid=m3.finterid
--left join 
--(
--	select fsourcetrantype,forderinterid,forderentryid,sum(fqty) fqty --,fitemid
--	from my_t_scheduledetail 
--	where fsourcetrantype=87 
--	group by fsourcetrantype,forderinterid,forderentryid --,fitemid
--) m1 on m1.forderinterid=m2.finterid and m1.forderentryid=m2.fentryid --and m2.fitemid=m1.fitemid
--
--go

--由生产计划导入生成ICMO-----------------------------++++++++++++++++++++++++++++++++
--IF EXISTS (select * from sysobjects where name='My_P_GenerateICMO' and xtype='p')  drop  procedure My_P_GenerateICMO
--
--go
--
--create procedure [dbo].[My_P_GenerateICMO](@fuserid int,@FBegBillNo varchar(40) output,@FEndBillNo varchar(40) output,@fidentify int output)
--
--as
--declare @fplanprice decimal(18,4),@fitemid int,@fpitemid int,@funitid int,@entryid int,@fqty int
--declare @InterID int,@BillNo varchar (20),@FStockId int,@StockNumber varchar (20)
--DECLARE @TmpID INT ,@fsupplyid int,@fcurrencyid int,@FMyPoInStockInterId int
--declare @fsupplyno varchar(20),@forderdate datetime,@FValueAddRate decimal(28, 2)
--declare @iLength int,@FPrice decimal(28, 5),@FAmount decimal(20, 2),@FExchangeRate decimal(28, 10)
--declare @FTaxPrice decimal(28, 5),@FTaxAmount decimal(20, 2),@SupplyId int
--declare @fprojectval  varchar(200),@fspid int,@fempid int,@fdeptid int
--declare @FDateFormat  varchar(200),@fdate datetime,@forginterid int
--declare @fsourceNumber varchar(200),@fpSourceNumber varchar(200),@fpXxSourceNumber varchar(200)
--declare @fXxOldSourceNumber varchar(200),@empid int,@fsourcetrantype int
--declare @FDCStockID int,@xx_FItemIDOld int,@fxxitemid int,@FOrgPPOInterID int
--declare @FDCSPID int,@forderinterid int,@forderentryid int
--declare @fsourceInterid int,@fsourceEntryid int,@fsourceBillNo varchar (100)
--declare @fyear int,@fperiod int,@FMangerID int
--declare @fresultbillno varchar (800)
--declare @ftempbillno varchar(50),@fcostobjid int,@fplancommitdate datetime,@fsourceid int
--declare @fplanorderinterid int,@fbominterid int,@forgsaleinterid int,@forgentryid int
----AIS20041229163526   AIS20080129143619
----declare @fbout varchar(10),@fcommitdate datetime
--
--select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期
--set @forderdate=@fdate  --'2009-06-15' --下单日期
----set @fcommitdate='2009-07-21' --到货日期
--select @fresultbillno='',@BillNo=''
--
----set @fbout='204'

--
--select @fidentify=isnull(max(fid),0)+1 from my_t_identify
--insert into my_t_identify(fid,fuserid,fdate,FTrantypeID) values(@fidentify,@fuserid,getdate(),85)
--
--DECLARE authors_cursor CURSOR FOR	
--
--select t1.finterid,t1.fsourcetrantype,t5.fitemid fcostobjid,t1.fitemid,t2.funitid,t1.fqty,t1.fdate,
--t1.fdeptid,0 fplanorderinterid,t4.finterid fbominterid,
--t1.forderinterid,t1.forderentryid
--from my_t_scheduledetail t1 
--inner join t_icitem t2 on t1.fitemid=t2.fitemid 
--inner join t_measureunit t3 on t3.fitemid=t2.funitid
--inner join icbom t4 on t2.fitemid=t4.fitemid
--inner join cbCostObj t5 on t5.FStdProductID=t2.fitemid
--inner join My_t_ScheduleDetailTemp t6 on t1.finterid=t6.finterid
--where t6.fuserid=@fuserid
----group by t1.forderinterid,t1.forderentryid,t1.fitemid,t1.fdate,t1.fdeptid,t2.funitid,t4.finterid,t5.fitemid
--order by t1.fdate,t1.fdeptid,t1.forderinterid,t1.forderentryid
--
--set @entryid=1
--
--OPEN authors_cursor
--
--FETCH NEXT FROM authors_cursor 
--INTO @forginterid,@fsourcetrantype,@fcostobjid,@fitemid,@funitid,@fqty,@fplancommitdate,@fsourceid,@fplanorderinterid,@fbominterid,@forderinterid,@forgentryid
--
--WHILE @@FETCH_STATUS = 0
--BEGIN 
--	if @fsourcetrantype=81
--	begin
--		select @FOrgSaleInterID =@forderinterid,@FOrgPPOInterID=0
--		select @fsourceBillNo=fbillno from seorder where finterid=@forderinterid
--	end
--	else
--	begin
--		select @FOrgSaleInterID =0,@FOrgPPOInterID=@forderinterid,@fsourceBillNo=''
--	end
--
--	exec GetICMaxNum 'ICMO', @InterID output
--
--	-- 10.4
--	Update t_BillCodeRule Set FReChar = FReChar Where FBillTypeID =85
--
--	SET @TmpID = (SELECT FID FROM t_BillCodeRule WITH(READUNCOMMITTED) WHERE fbilltypeid=85 and fprojectid=3)
--
--	update t_billcoderule set fprojectval = fprojectval+1,flength=case when (flength-len(fprojectval)) >= 0 then flength else len(fprojectval) end where FID =  @TmpID 
--	Update ICBillNo Set FCurNo = (select top 1 isnull(fprojectval,1) from t_billcoderule where fprojectid = 3 and fbilltypeid =85) where fbillid = 85
--	   
--	--长度和目前编码
--	select @fprojectval=(fprojectval-1),@iLength=flength from t_BillCodeRule where fprojectid = 3 and fbilltypeid = 85
--	  
--	-- 前缀
--	select @BillNo=fprojectval+left('0000000000',@iLength-(len(@fprojectval)))+@fprojectval from t_BillCodeRule where fprojectid = 1 and fbilltypeid = 85  --@iLength
--
--    if @entryid=1 
--		set @fbegBillNo=@BillNo
--
--	--icmo fstatus 5 确认 0 计划 1,2 下达 3 结案  fmrp 11061 mps产生 1052 手工录入 11077 mrp产生 --select forderinterid,fpporderinterid,fsourceentryid,* from icmo
--	insert icmo(FHeadSelfJ0174,FHeadSelfJ0173,FInterID,FBillNo,FBrNo,FTranType,FCancellation,FCheckDate,Fstatus,FMRP, FWorktypeID,FCostObjID, FBomInterID, FRoutingID,FWorkShop, FSupplyID,FItemID, FUnitID,Fauxqty,FPlanCommitDate,FPlanFinishDate,Fnote,FCommitDate,FBillerID,FOrderInterID,    FParentInterID,FPPOrderInterID, FType,FSourceEntryID,FProcessPrice,FProcessFee,FPlanOrderInterID, FScheduleID,FCustID,FMultiCheckLevel1,FMultiCheckDate1,FMultiCheckLevel2,FMultiCheckDate2,FMultiCheckLevel3,FMultiCheckDate3,FMultiCheckLevel4,FMultiCheckDate4,FMultiCheckLevel5,FMultiCheckDate5,FMultiCheckLevel6,FMultiCheckDate6,FConfirmDate,FInHighLimit,FAuxInHighLimitQty,FInLowLimit,FAuxInLowLimitQty,FGMPBatchNo,    FMrpLockFlag,FChangeTimes,FCloseDate,FHeadSelfJ0173)
--	values(     @fidentify,    @forginterid,  @InterId,@BillNo,0,    85,       0,            @fdate    ,0,      11077,55,         @FCostObjID,@fbominterid,0         ,@fsourceid,0,        @FItemId,@funitid,@fqty,@FPlanCommitDate,@FPlanCommitDate,'',  @fdate,     @fuserid, @FOrgSaleInterID, 0,             @FOrgPPOInterID, 1054, @forgentryid,  0,            0,          @fplanorderinterid,0,          0,      NULL,             NULL	,           NULL	,         NULL	,          NULL	,            NULL,            NULL,            	NULL,            NULL,             NULL	           ,NULL	,         NULL	      ,    @fdate,     0,	        1000000,             0,          @fqty,            @fsourceBillNo, 0,           0,           NULL,      40011	)
--
--	set @entryid=@entryid+1
--
--	FETCH NEXT FROM authors_cursor 
--	INTO @forginterid,@fsourcetrantype,@fcostobjid,@fitemid,@funitid,@fqty,@fplancommitdate,@fsourceid,@fplanorderinterid,@fbominterid,@forderinterid,@forgentryid
--END
--
--CLOSE authors_cursor
--DEALLOCATE authors_cursor
--

--
----单据编号自定义的
--
--set @fendBillNo=@BillNo
--
--set nocount off
--GO



--由销售订单导入生成ICMO
IF EXISTS (select * from sysobjects where name='My_P_GenerateICMOBySE' and xtype='p')  drop  procedure My_P_GenerateICMOBySE

go

create procedure [dbo].My_P_GenerateICMOBySE(@fuserid int,@FBegBillNo varchar(40) output,@FEndBillNo varchar(40) output,@fidentify int output)

as
declare @fplanprice decimal(18,4),@fitemid int,@fpitemid int,@funitid int,@entryid int,@fqty int
declare @InterID int,@BillNo varchar (20),@FStockId int,@StockNumber varchar (20)
DECLARE @TmpID INT ,@fsupplyid int,@fcurrencyid int,@FMyPoInStockInterId int
declare @fsupplyno varchar(20),@forderdate datetime,@FValueAddRate decimal(28, 2)
declare @iLength int,@FPrice decimal(28, 5),@FAmount decimal(20, 2),@FExchangeRate decimal(28, 10)
declare @FTaxPrice decimal(28, 5),@FTaxAmount decimal(20, 2),@SupplyId int
declare @fprojectval  varchar(200),@fspid int,@fempid int,@fdeptid int
declare @FDateFormat  varchar(200),@fdate datetime,@forginterid int
declare @fsourceNumber varchar(200),@fpSourceNumber varchar(200),@fpXxSourceNumber varchar(200)
declare @fXxOldSourceNumber varchar(200),@empid int,@fsourcetrantype int
declare @FDCStockID int,@xx_FItemIDOld int,@fxxitemid int,@FOrgPPOInterID int
declare @FDCSPID int,@forderinterid int,@forderentryid int
declare @fsourceInterid int,@fsourceEntryid int,@fsourceBillNo varchar (100)
declare @fyear int,@fperiod int,@FMangerID int
declare @fresultbillno varchar (800)
declare @ftempbillno varchar(50),@fcostobjid int,@fplancommitdate datetime,@fsourceid int
declare @fplanorderinterid int,@fbominterid int,@forgsaleinterid int,@forgentryid int
--AIS20041229163526   AIS20080129143619
--declare @fbout varchar(10),@fcommitdate datetime

select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期
set @forderdate=@fdate  --'2009-06-15' --下单日期
--set @fcommitdate='2009-07-21' --到货日期
select @fresultbillno='',@BillNo=''

--set @fbout='204'


select @fidentify=isnull(max(fid),0)+1 from my_t_identify
insert into my_t_identify(fid,fuserid,fdate,FTrantypeID) values(@fidentify,@fuserid,getdate(),85)

DECLARE authors_cursor CURSOR FOR	

select 0 forginterid,81 fsourcetrantype,t5.fitemid fcostobjid,t1.fitemid,t2.funitid,t1.fqty,t1.fdate,
isnull(t2.fsource,0) fdeptid,0 fplanorderinterid,t4.finterid fbominterid,
t1.finterid forderinterid,t1.fentryid forderentryid
from seorderentry t1 
inner join seorder t7 on t1.finterid=t7.finterid
inner join t_icitem t2 on t1.fitemid=t2.fitemid 
inner join t_measureunit t3 on t3.fitemid=t2.funitid
inner join icbom t4 on t2.fitemid=t4.fitemid
inner join cbCostObj t5 on t5.FStdProductID=t2.fitemid
inner join My_t_SEOrderTemp t6 on t1.finterid=t6.finterid and t1.fentryid=t6.fentryid
where t6.fuserid=@fuserid
--group by t1.forderinterid,t1.forderentryid,t1.fitemid,t1.fdate,t1.fdeptid,t2.funitid,t4.finterid,t5.fitemid
order by t1.fdate,t1.fdeptid,t1.finterid,t1.fentryid

set @entryid=1

OPEN authors_cursor

FETCH NEXT FROM authors_cursor 
INTO @forginterid,@fsourcetrantype,@fcostobjid,@fitemid,@funitid,@fqty,@fplancommitdate,@fsourceid,@fplanorderinterid,@fbominterid,@forderinterid,@forgentryid

WHILE @@FETCH_STATUS = 0
BEGIN 
	if @fsourcetrantype=81
	begin
		select @FOrgSaleInterID =@forderinterid,@FOrgPPOInterID=0
		select @fsourceBillNo=fbillno from seorder where finterid=@forderinterid
	end
	else
	begin
		select @FOrgSaleInterID =0,@FOrgPPOInterID=@forderinterid,@fsourceBillNo=''
	end

	exec GetICMaxNum 'ICMO', @InterID output

	-- 10.4
	Update t_BillCodeRule Set FReChar = FReChar Where FBillTypeID =85

	SET @TmpID = (SELECT FID FROM t_BillCodeRule WITH(READUNCOMMITTED) WHERE fbilltypeid=85 and fprojectid=3)

	update t_billcoderule set fprojectval = fprojectval+1,flength=case when (flength-len(fprojectval)) >= 0 then flength else len(fprojectval) end where FID =  @TmpID 
	Update ICBillNo Set FCurNo = (select top 1 isnull(fprojectval,1) from t_billcoderule where fprojectid = 3 and fbilltypeid =85) where fbillid = 85
	   
	--长度和目前编码
	select @fprojectval=(fprojectval-1),@iLength=flength from t_BillCodeRule where fprojectid = 3 and fbilltypeid = 85
	  
	-- 前缀
	select @BillNo=fprojectval+left('0000000000',@iLength-(len(@fprojectval)))+@fprojectval from t_BillCodeRule where fprojectid = 1 and fbilltypeid = 85  --@iLength

    if @entryid=1 
		set @fbegBillNo=@BillNo

	--icmo fstatus 5 确认 0 计划 1,2 下达 3 结案  fmrp 11061 mps产生 1052 手工录入 11077 mrp产生 --select forderinterid,fpporderinterid,fsourceentryid,* from icmo
	insert icmo(FHeadSelfJ0174,FHeadSelfJ0173,FInterID,FBillNo,FBrNo,FTranType,FCancellation,FCheckDate,Fstatus,FMRP, FWorktypeID,FCostObjID, FBomInterID, FRoutingID,FWorkShop, FSupplyID,FItemID, FUnitID,Fauxqty,FPlanCommitDate,FPlanFinishDate,Fnote,FCommitDate,FBillerID,FOrderInterID,    FParentInterID,FPPOrderInterID, FType,FSourceEntryID,FProcessPrice,FProcessFee,FPlanOrderInterID, FScheduleID,FCustID,FMultiCheckLevel1,FMultiCheckDate1,FMultiCheckLevel2,FMultiCheckDate2,FMultiCheckLevel3,FMultiCheckDate3,FMultiCheckLevel4,FMultiCheckDate4,FMultiCheckLevel5,FMultiCheckDate5,FMultiCheckLevel6,FMultiCheckDate6,FConfirmDate,FInHighLimit,FAuxInHighLimitQty,FInLowLimit,FAuxInLowLimitQty,FGMPBatchNo,    FMrpLockFlag,FChangeTimes,FCloseDate,FHeadSelfJ0173)
	values(     @fidentify,    @forginterid,  @InterId,@BillNo,0,    85,       0,            @fdate    ,0,      11077,55,         @FCostObjID,@fbominterid,0         ,@fsourceid,0,        @FItemId,@funitid,@fqty,@FPlanCommitDate,@FPlanCommitDate,'',  @fdate,     @fuserid, @FOrgSaleInterID, 0,             @FOrgPPOInterID, 1054, @forgentryid,  0,            0,          @fplanorderinterid,0,          0,      NULL,             NULL	,           NULL	,         NULL	,          NULL	,            NULL,            NULL,            	NULL,            NULL,             NULL	           ,NULL	,         NULL	      ,    @fdate,     0,	        1000000,             0,          @fqty,            @fsourceBillNo, 0,           0,           NULL,      40011	)

	set @entryid=@entryid+1

	FETCH NEXT FROM authors_cursor 
	INTO @forginterid,@fsourcetrantype,@fcostobjid,@fitemid,@funitid,@fqty,@fplancommitdate,@fsourceid,@fplanorderinterid,@fbominterid,@forderinterid,@forgentryid
END

CLOSE authors_cursor
DEALLOCATE authors_cursor


--单据编号自定义的

set @fendBillNo=@BillNo

set nocount off

GO


--MRP运算错误检查--*****--
--My_P_MrpCalCheck 1
IF EXISTS (select * from sysobjects where name='My_P_MrpCalCheck' and xtype='p')  drop  procedure My_P_MrpCalCheck

go

create procedure [dbo].My_P_MrpCalCheck(@frunid int)  --

as

--declare @fitemtype int select @fitemtype=0

set nocount on 

declare @fitemtype int  --0 成品 1 半成品 2 常规物料 3 包材 

select @fitemtype=ftrantype from my_t_mrp where frunid=@frunid

create table #temp(ftype int,fsourcetrantype varchar(50),fsourcebillno varchar(20),
fsourceinterid int,fsourceentryid int,fitemid int,ferr varchar(1000))

--ftype 1 生产计划有未排数 2 采购申请单未关闭 3 收料计划有未排数 4 未配置半成品 5 未配置芯片 6 未做包装方案 7 未做BOM
declare @fdate datetime
select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期

declare @FProductProspectDays int,@FHalfProductProspectDays int,@FProductPrepareDays int,@FHalfProductPrepareDays int

select @FProductProspectDays=fvalue from t_SystemProfile where FCategory='IC' and fkey='FProductProspectDays' 
select @FHalfProductProspectDays=fvalue from t_SystemProfile where FCategory='IC' and fkey='FHalfProductProspectDays' 
select @FProductPrepareDays=fvalue from t_SystemProfile where FCategory='IC' and fkey='FProductPrepareDays' 
select @FHalfProductPrepareDays=fvalue from t_SystemProfile where FCategory='IC' and fkey='FHalfProductPrepareDays' 
--

if @fitemtype=9999 --@fitemtype<>0  --先屏蔽
begin
	insert into #temp(ftype,fsourcetrantype,fsourcebillno,fsourceinterid,fsourceentryid,fitemid,   ferr)
	select            1,    '汇报单',       t2.fbillno,   t1.finterid,   0   ,          t1.fitemid,'汇报单未审核'
	from ICMORptEntry t1 
	inner join ICMORpt t2 on t1.finterid=t2.finterid
	where t2.fstatus=0 --and t2.fheadselfj1112<@fdate  

	--任务数与滚动计划数的平衡关系:任务数-当天以前的汇报数=当天和当天以后的计划数
	insert into #temp(ftype,fsourcetrantype,fsourcebillno,fsourceinterid,fsourceentryid,fitemid,   ferr)
	select            1,    '任务单',       t1.fbillno,   t1.finterid,   0   ,          t1.fitemid,'生产计划有未排数'
	from icmo t1
	left join 
	(
		select t1.fsourceinterid,sum(t1.FQtyFinish) FQtyFinish 
		from ICMORptEntry t1 
		inner join ICMORpt t2 on t1.finterid=t2.finterid
		where t2.fheadselfj1112<@fdate
		group by t1.fsourceinterid
	) t3 on t1.finterid=t3.fsourceinterid
	left join 
	(
		select ficmointerid,sum(fqty) fplanqty 
		from my_t_scheduledetail 
		where fsourcetrantype=85 and fdate>=@fdate
		group by ficmointerid
	) t2 on t1.finterid=t2.ficmointerid  
	where t1.fqty>isnull(t1.fstockqty,0) and t1.fstatus in (1,2,5) --未工的生产任务单
	and t1.fqty<>(isnull(t2.fplanqty,0)+isnull(t3.FQtyFinish,0))

	insert into #temp(ftype,fsourcetrantype,fsourcebillno,fsourceinterid,fsourceentryid,fitemid,   ferr)
	select            2,    '采购申请单',   t1.fbillno,   t2.finterid,   t2.fentryid,   t2.fitemid,'采购申请单未关闭'
	from porequest t1
	inner join porequestentry t2 on t1.finterid=t2.finterid
	inner join t_icitem t3 on t2.fitemid=t3.fitemid
	inner join t_department t4 on t1.fdeptid=t4.fitemid
	where --t1.fstatus>0 and 
	t1.fstatus<>3 and isnull(t2.fmrpclosed,0)<>1
	--and t4.fnumber not like '08.11.%'
	--and t3.ferpclsid in (1)
	--and (t3.fnumber like 'H.%' or t3.fnumber like 'K.%' or t3.fnumber like 'M.%' or t3.fnumber like 'N.%')
	and (t2.fqty-t2.fcommitqty)>0 

	insert into #temp(ftype,fsourcetrantype,fsourcebillno,fsourceinterid,fsourceentryid,fitemid,   ferr)
	select            3,    '采购订单',     t5.fbillno,   t1.finterid,   t1.fentryid,   t1.fitemid,'收料计划有未排数'
	from poorderentry t1
	inner join poorder t5 on t1.finterid=t5.finterid
	left join 
	(
		select t1.fsourceinterid,t1.fsourceentryid,sum(t1.fqty-t1.fbackqty) FQtyFinish 
		from poinstockentry t1 
		inner join poinstock t2 on t1.finterid=t2.finterid
		where t2.fdate<@fdate and t2.ftrantype=72--不审核的也纳入，因为以后将可以由收料计划下推生成收料通知单
		group by t1.fsourceinterid,t1.fsourceentryid
	) t3 on t1.finterid=t3.fsourceinterid and t1.fentryid=t3.fsourceentryid 
	left join 
	(
		select fsourceinterid,fsourceentryid,sum(fqty) fplanqty 
		from my_t_scheduledetail 
		where fsourcetrantype=71 and fdate>=@fdate
		group by fsourceinterid,fsourceentryid
	) t2 on t1.finterid=t2.fsourceinterid and t1.fentryid=t2.fsourceentryid  
	where t1.fqty>isnull(t1.fcommitqty,0) and t5.fstatus in (1,2,5) --未完成的采购订单
	and t1.fmrpclosed<>1 and t1.fqty<>(isnull(t2.fplanqty,0)+isnull(t3.FQtyFinish,0))

	if @fitemtype in (2,3) --2 常规物料 3 包材
	begin
		if @fitemtype=2
		begin
			--收料计划和采购申请单按类别检查
			delete t1
			from #temp t1
			inner join t_icitem t2 on t1.fitemid=t2.fitemid
			where t1.ftype in (2,3) and t2.fnumber like '2.%'  --
		end
		else
		begin
			--收料计划和采购申请单按类别检查
			delete t1
			from #temp t1
			inner join t_icitem t2 on t1.fitemid=t2.fitemid
			where t1.ftype in (2,3) and t2.fnumber not like '2.%'  --

			--生产计划按类别检查--包材只检查成品的任务单
			delete t1
			from #temp t1
			inner join t_icitem t2 on t1.fitemid=t2.fitemid
			inner join icmo t3 on t1.fsourceinterid=t3.finterid
			where t1.ftype in (1) and isnull(t3.forderinterid,0)=0
		end
	end
end

if @fitemtype=0  --半成品和芯片是通过订单配置出来的
begin
	insert into #temp(fsourcetrantype,fsourcebillno,fsourceinterid,fsourceentryid,fitemid,   ferr)
	select            '销售订单',     t7.fbillno,   t1.finterid,   t1.fentryid   ,t1.fitemid,'BOM未做/未审核/未使用'
	from seorderentry t1 
	inner join seorder t7 on t1.finterid=t7.finterid
	inner join t_icitem t2 on t1.fitemid=t2.fitemid 
	left join icbom t3 on t3.fitemid=t1.fitemid and t3.fusestatus=1072
	--left join (select forderinterid,fsourceentryid,sum(fqty) fqty from icmo t1 group by forderinterid,fsourceentryid) t8 on t1.finterid=t8.forderinterid and t1.fentryid=t8.fsourceentryid
	where --datediff(day,getdate(),t1.fdate)<=@FProductProspectDays  --成品展望期30天 
	t1.finterid in (select forderinterid from my_t_MrpSeOrder where frunid=@frunid and fselect=1) --去掉不参与运算的
	and t1.fmrpclosed<>1 --行业务未关闭
	and (t7.fstatus>0 or isnull(t7.FMultiCheckLevel1,0)>0) --一审或者已经审核
	--and (t1.fqty>isnull(t8.fqty,0)) --未完全生成生产任务单
	and left(t2.fnumber,1) in (select fitemtype from v_myitemtype where ftype=0)
	and t3.finterid is null
	--and isnull(t1.FEntrySelfS0175,0)=0 --40089	自产自包,40090	外调自包,40091	外调外包
	and t2.ferpclsid=2 --and t7.fbillno not in ('xw1304008')
	--and isnull(t7.FHeadSelfS0147,0) not in (40032,40033) --40032	样品订单-收费 40033	样品订单-免费

--	insert into #temp(fsourcetrantype,fsourcebillno,fsourceinterid,fsourceentryid,fitemid,   ferr)
--	select            '销售订单',     t7.fbillno,   t1.finterid,   t1.fentryid   ,t1.fitemid,'未配置交付方式'
--	from seorderentry t1 
--	inner join seorder t7 on t1.finterid=t7.finterid
--	inner join t_icitem t2 on t1.fitemid=t2.fitemid 
--	--left join (select forderinterid,fsourceentryid,sum(fqty) fqty from icmo t1 group by forderinterid,fsourceentryid) t8 on t1.finterid=t8.forderinterid and t1.fentryid=t8.fsourceentryid
--	where --datediff(day,getdate(),t1.fdate)<=@FProductProspectDays  --成品展望期30天 
--	t1.finterid in (select forderinterid from my_t_MrpSeOrder where frunid=@frunid and fselect=1) --去掉不参与运算的
--	and t1.fmrpclosed<>1 --行业务未关闭
--	and (t7.fstatus>0 or isnull(t7.FMultiCheckLevel1,0)>0) --一审或者已经审核
--	--and (t1.fqty>isnull(t8.fqty,0)) --未完全生成生产任务单
--	and (t2.fnumber like 'A.%' or t2.fnumber like 'P.%') 
--	and isnull(t1.FEntrySelfS0175,0)=0 --40089	自产自包,40090	外调自包,40091	外调外包
--	and t2.ferpclsid=2 --and t7.fbillno not in ('xw1304008')
--	and isnull(t7.FHeadSelfS0147,0) not in (40032,40033) --40032	样品订单-收费 40033	样品订单-免费

--	/*  --目前都是外调自包,这里先屏蔽,不然时间进度太慢
--	insert into #temp(fsourcetrantype,fsourcebillno,fsourceinterid,fsourceentryid,fitemid,   ferr)
--	select            '销售订单',     t7.fbillno,   t1.finterid,   t1.fentryid   ,t1.fitemid,'未生成采购订单'
--	from seorderentry t1 
--	inner join seorder t7 on t1.finterid=t7.finterid
--	inner join t_icitem t2 on t1.fitemid=t2.fitemid 
--	--left join (select forderinterid,fsourceentryid,sum(fqty) fqty from icmo t1 group by forderinterid,fsourceentryid) t8 on t1.finterid=t8.forderinterid and t1.fentryid=t8.fsourceentryid
--	left join poorderentry t3 on t3.fsourceinterid=t1.finterid and t3.fsourceentryid=t1.fentryid and t3.fsourcetrantype=81
--	where --datediff(day,getdate(),t1.fdate)<=@FProductProspectDays  --成品展望期30天 
--	t1.finterid in (select forderinterid from my_t_MrpSeOrder where frunid=@frunid and fselect=1) --去掉不参与运算的
--	and t1.fmrpclosed<>1 --行业务未关闭
--	and (t7.fstatus>0 or isnull(t7.FMultiCheckLevel1,0)>0) --一审或者已经审核
--	--and (t1.fqty>isnull(t8.fqty,0)) --未完全生成生产任务单
--	and t3.finterid is null 
--	and (t2.fnumber like 'A.%' or t2.fnumber like 'P.%') 
--	and isnull(t1.FEntrySelfS0175,0) in (40090,40091) --40089	自产自包,40090	外调自包,40091	外调外包
--	and t2.ferpclsid=2 --and t7.fbillno not in ('xw1304008')
--	and isnull(t7.FHeadSelfS0147,0) not in (40032,40033) --40032	样品订单-收费 40033	样品订单-免费
--	*/

--	insert into #temp(fsourcetrantype,fsourcebillno,fsourceinterid,fsourceentryid,fitemid,   ferr)
--	select            '销售订单',     t7.fbillno,   t1.finterid,   t1.fentryid   ,t1.fitemid,'未配置半成品'
--	from seorderentry t1 
--	inner join seorder t7 on t1.finterid=t7.finterid
--	inner join t_icitem t2 on t1.fitemid=t2.fitemid 
--	--left join (select forderinterid,fsourceentryid,sum(fqty) fqty from icmo t1 group by forderinterid,fsourceentryid) t8 on t1.finterid=t8.forderinterid and t1.fentryid=t8.fsourceentryid
--	left join t_icitem t9 on t9.fitemid=t1.fentryselfs0164  --半成品
--	where --datediff(day,getdate(),t1.fdate)<=@FProductProspectDays  --成品展望期30天 
--	t1.finterid in (select forderinterid from my_t_MrpSeOrder where frunid=@frunid and fselect=1) --去掉不参与运算的
--	and t1.fmrpclosed<>1 --行业务未关闭
--	and (t7.fstatus>0 or isnull(t7.FMultiCheckLevel1,0)>0) --一审或者已经审核
--	--and (t1.fqty>isnull(t8.fqty,0)) --未完全生成生产任务单
--	and (t2.fnumber like 'A.%' or t2.fnumber like 'P.%') 
--	and isnull(t1.FEntrySelfS0175,0) not in (40090,40091) --40089	自产自包,40090	外调自包,40091	外调外包
--	and t2.ferpclsid=2 and isnull(t9.fitemid,0)=0 --and t7.fbillno not in ('xw1304008')
--	and isnull(t7.FHeadSelfS0147,0) not in (40032,40033) --40032	样品订单-收费 40033	样品订单-免费

--	insert into #temp(fsourcetrantype,fsourcebillno,fsourceinterid,fsourceentryid,fitemid,   ferr)
--	select            '销售订单',     t7.fbillno,   t1.finterid,   t1.fentryid   ,t1.fitemid,'未配置芯片'
--	from seorderentry t1 
--	inner join seorder t7 on t1.finterid=t7.finterid
--	inner join t_icitem t2 on t1.fitemid=t2.fitemid 
--	--left join (select forderinterid,fsourceentryid,sum(fqty) fqty from icmo t1 group by forderinterid,fsourceentryid) t8 on t1.finterid=t8.forderinterid and t1.fentryid=t8.fsourceentryid
--	left join t_item t13 on t13.fitemid=t1.fentryselfs0160 and t13.fitemclassid=3006 --芯片版本  --16465  无芯片
--	left join t_icitem t10 on t10.fitemid=t1.fentryselfs0161  --芯片
--	where --datediff(day,getdate(),t1.fdate)<=@FProductProspectDays  --成品展望期30天 
--	t1.finterid in (select forderinterid from my_t_MrpSeOrder where frunid=@frunid and fselect=1) --去掉不参与运算的
--	and t1.fmrpclosed<>1 --行业务未关闭
--	and (t7.fstatus>0 or isnull(t7.FMultiCheckLevel1,0)>0) --一审或者已经审核
--	--and (t1.fqty>isnull(t8.fqty,0)) --未完全生成生产任务单
--	and (t2.fnumber like 'A.%' or t2.fnumber like 'P.%')  
--	and isnull(t1.FEntrySelfS0175,0) not in (40090,40091) --40089	自产自包,40090	外调自包,40091	外调外包
--	and isnull(t13.fitemid,0)<>16465 and isnull(t10.fitemid,0)=0 --and t7.fbillno not in ('xw1304008')
--	and isnull(t7.FHeadSelfS0147,0) not in (40032,40033) --40032	样品订单-收费 40033	样品订单-免费
end

--if @fitemtype in (3)
--begin
--	insert into #temp(fsourcetrantype,fsourcebillno,fsourceinterid,fsourceentryid,fitemid,   ferr)
--	select            '销售订单',     t7.fbillno,   t1.finterid,   t1.fentryid   ,t1.fitemid,(case when isnull(t11.fid,0)=0 then '未做包装方案' else '包装方案未审核' end)
--	from seorderentry t1 
--	inner join seorder t7 on t1.finterid=t7.finterid
--	inner join t_icitem t2 on t1.fitemid=t2.fitemid 
--	--inner join icmo t8 on t1.finterid=t8.forderinterid and t1.fentryid=t8.fsourceentryid
--	inner join t_item t9 on t9.fitemclassid=3002 and t9.fitemid=t1.fentryselfs0158
--	left join (select min(fid) fid,fproductid,fbrandid,min(fbillno) fbillno,min(FChecker) FChecker from t_BOSPackSub group by fproductid,fbrandid) t11 on t11.fproductid=t1.fitemid and t11.fbrandid=t1.fentryselfs0158  --包装方式
--	where --datediff(day,getdate(),t1.fdate)<=@FProductProspectDays  --成品展望期30天 
--	t1.finterid in (select forderinterid from my_t_MrpSeOrder where frunid=@frunid and fselect=1) --去掉不参与运算的
--	and t1.fmrpclosed<>1 --行业务未关闭
--	--and (t8.fqty>isnull(t8.fstockqty,0) and t8.fstatus in (1,2,5)) --未工的生产任务单
--	and t9.fname not like '%裸包%' and (isnull(t11.fid,0)=0 or isnull(t11.FChecker,0)=0 )
--	and isnull(t7.FHeadSelfS0147,0) not in (40032,40033) --40032	样品订单-收费 40033	样品订单-免费
--end

if @fitemtype in (1) --计算半成品需求时要导入K3生成任务单，所以要有BOM
begin
	insert into #temp(fsourcetrantype,fsourcebillno,fsourceinterid,fsourceentryid,fitemid,   ferr)
	select            '任务单',       t8.fbillno,   t8.finterid,   0   ,          t8.fitemid,(case when isnull(t11.finterid,0)=0 then '未做BOM' else 'BOM未使用' end)
	from icmo t8 
	left join icbom t11 on t11.fitemid=t8.fitemid 
	inner join t_icitem t1 on t1.fitemid=t8.fitemid
	where (t8.fqty>isnull(t8.fstockqty,0) and t8.fstatus in (1,2,5)) --未工的生产任务单
	and (isnull(t11.finterid,0)=0 or isnull(t11.fusestatus,0)<>1072 )
	and isnull(t8.forderinterid,0)=0  --暂时只控制半成品--因为成品有了BOM后才能进行配置，成品MRP运算的时候已经检查成品是否已经进行配置
end

select t1.fsourcetrantype 单据类型,t1.fsourceinterid 单据内码,t1.fsourcebillno 单据编号,t1.fsourceentryid 分录号,
t2.fnumber 物料编码,t2.fname 名称,t2.fmodel 规格型号,t1.ferr 备注
from #temp t1
inner join t_icitem t2 on t1.fitemid=t2.fitemid
order by t1.fsourcetrantype,t1.fsourcebillno,t1.fsourceentryid,t2.fnumber

drop table #temp

set nocount off

go


--My_P_GetMrpSeorder 3  --

IF EXISTS (select * from sysobjects where name='My_P_GetMrpSeorder' and xtype='p')  drop  procedure My_P_GetMrpSeorder

go

create procedure [dbo].My_P_GetMrpSeorder(@fitemtype int)  --0 成品 1 半成品 2 常规物料 3 包材

as

set nocount on 

create table #data(finterid int,fselect bit default 1)
 
--常规物料和半成品都是直接抓取任务单未发料数作为毛需求,所以不用选订单

if @fitemtype=0  --成品
begin
	insert into #data(finterid)  --没有生成生产任务单的订单
	select distinct t7.finterid
	from seorderentry t1 
	inner join seorder t7 on t1.finterid=t7.finterid
	inner join t_icitem t2 on t1.fitemid=t2.fitemid 
	left join (select forderinterid,fsourceentryid,sum(fqty) fqty from icmo t1 group by forderinterid,fsourceentryid) t8 on t1.finterid=t8.forderinterid and t1.fentryid=t8.fsourceentryid
	where t7.FCancellation=0 and t1.fmrpclosed<>1 --行业务未关闭
	and (t7.fstatus>0 or isnull(t7.FMultiCheckLevel1,0)>0) --一审或者已经审核
	and (t1.fqty>isnull(t8.fqty,0)) --未完全生成生产任务单
	--and (t2.fnumber like 'A.%' or t2.fnumber like 'P.%') 
	and t2.ferpclsid=2 --and t7.fbillno not in ('xw1304008')
	--and isnull(t7.FHeadSelfS0147,0) not in (40032,40033) --40032	样品订单-收费 40033	样品订单-免费

	update t2 set fselect=0  --BOM没有做/未审核/未使用
	from
	(
		select distinct t2.finterid
		from seorder t1  
		inner join seorderentry t2 on t1.finterid=t2.finterid
		inner join t_icitem t4 on t4.fitemid=t2.fitemid
		--inner join t_item t9 on t9.fitemclassid=3002 and t9.fitemid=t2.fentryselfs0158
		left join icbom t11 on t11.fitemid=t2.fitemid and t11.fusestatus=1072
		where t11.finterid is null
	) t1 inner join #data t2 on t1.finterid=t2.finterid
	
	/*
	update t3 set fselect=0  --未配置交付方式
	from seorderentry t1 
	inner join seorder t7 on t1.finterid=t7.finterid
	inner join t_icitem t2 on t1.fitemid=t2.fitemid 
	inner join #data t3 on t3.finterid=t1.finterid
	where /*表体的条件才加*/
	t1.fmrpclosed<>1 --行业务未关闭
	--and (t1.fqty>isnull(t8.fqty,0)) --未完全生成生产任务单
	and (t2.fnumber like 'A.%' or t2.fnumber like 'P.%') 
	and isnull(t1.FEntrySelfS0175,0)=0 --40089	自产自包,40090	外调自包,40091	外调外包
	and t2.ferpclsid=2 

	update t4 set fselect=0  --未生成采购订单
	from seorderentry t1 
	inner join seorder t7 on t1.finterid=t7.finterid
	inner join t_icitem t2 on t1.fitemid=t2.fitemid 
	inner join #data t4 on t4.finterid=t1.finterid
	left join poorderentry t3 on t3.fsourceinterid=t1.finterid and t3.fsourceentryid=t1.fentryid and t3.fsourcetrantype=81
	where t1.fmrpclosed<>1 --行业务未关闭
	--and (t1.fqty>isnull(t8.fqty,0)) --未完全生成生产任务单
	and t3.finterid is null 
	and (t2.fnumber like 'A.%' or t2.fnumber like 'P.%') 
	and isnull(t1.FEntrySelfS0175,0) in (40090,40091) --40089	自产自包,40090	外调自包,40091	外调外包
	and t2.ferpclsid=2

	update t2 set fselect=0  --没有配置半成品或芯片
	from
	(
		select distinct t2.finterid
		from seorder t1  
		inner join seorderentry t2 on t1.finterid=t2.finterid
		inner join t_icitem t4 on t4.fitemid=t2.fitemid
		left join t_icitem t9 on t9.fitemid=t2.fentryselfs0164  --半成品
		left join t_icitem t10 on t10.fitemid=t2.fentryselfs0161  --芯片
		left join t_item t13 on t13.fitemid=t2.fentryselfs0160 and t13.fitemclassid=3006 --芯片版本  --16465  无芯片
		where t2.fmrpclosed<>1 --行业务未关闭
		and (left(t4.fnumber,1) in ('A','P') and t4.ferpclsid=2 and isnull(t9.fitemid,0)=0) 
		or (isnull(t13.fitemid,0)<>16465 and isnull(t10.fitemid,0)=0)
	) t1 inner join #data t2 on t1.finterid=t2.finterid
	*/
end

if @fitemtype=3 --包材
begin
	insert into #data(finterid)  --已经生成生产任务单的订单
	select distinct t7.finterid
	from seorderentry t1 
	inner join seorder t7 on t1.finterid=t7.finterid
	inner join t_icitem t2 on t1.fitemid=t2.fitemid 
	inner join (select forderinterid,fsourceentryid,sum(fqty) fqty from icmo t1 group by forderinterid,fsourceentryid) t8 on t1.finterid=t8.forderinterid and t1.fentryid=t8.fsourceentryid
	where t7.FCancellation=0 and t1.fmrpclosed<>1 --行业务未关闭
	and (t7.fstatus>0 or isnull(t7.FMultiCheckLevel1,0)>0) --一审或者已经审核
	--and (t1.fqty>isnull(t8.fqty,0)) --未完全生成生产任务单
	and (left(t2.fnumber,1) in (select fitemtype from v_MyItemType where ftype=0)) 
	and t2.ferpclsid=2 --and t7.fbillno not in ('xw1304008')
	--and isnull(t7.FHeadSelfS0147,0) not in (40032,40033) --40032	样品订单-收费 40033	样品订单-免费
	and t7.finterid not in (select t2.forderinterid from my_t_mrp t1 inner join my_t_mrpseorder t2 on t1.frunid=t2.frunid where t1.ftrantype=3 and t2.fselect=1)  --已经计算过包材的就不给选择了

	insert into #data(finterid)  --直接买包材
	select distinct t7.finterid
	from seorderentry t1 
	inner join seorder t7 on t1.finterid=t7.finterid
	inner join t_icitem t2 on t1.fitemid=t2.fitemid 
	where t7.FCancellation=0 and t1.fmrpclosed<>1 --行业务未关闭
	and (t7.fstatus>0 or isnull(t7.FMultiCheckLevel1,0)>0) --一审或者已经审核
	--and (t1.fqty>isnull(t8.fqty,0)) --未完全生成生产任务单
	and t2.fnumber like '2.%' 
	and t2.ferpclsid=1 --and t7.fbillno not in ('xw1304008')
	--and isnull(t7.FHeadSelfS0147,0) not in (40032,40033) --40032	样品订单-收费 40033	样品订单-免费
	and t7.finterid not in (select t2.forderinterid from my_t_mrp t1 inner join my_t_mrpseorder t2 on t1.frunid=t2.frunid where t1.ftrantype=3 and t2.fselect=1)  --已经计算过包材的就不给选择了

	/*
	update t2 set fselect=0  --没有做包装方案或包装方案未审核
	from
	(
		select distinct t2.finterid
		from seorder t1  
		inner join seorderentry t2 on t1.finterid=t2.finterid
		inner join t_icitem t4 on t4.fitemid=t2.fitemid
		inner join t_item t9 on t9.fitemclassid=3002 and t9.fitemid=t2.fentryselfs0158
		left join t_BOSPackSub t11 on t11.fproductid=t2.fitemid and t11.fbrandid=t2.fentryselfs0158  --包装方式
		where t9.fname not like '%裸包%' and (isnull(t11.fid,0)=0 or isnull(t11.FChecker,0)=0 )
	) t1 inner join #data t2 on t1.finterid=t2.finterid
	*/
end

select t3.fselect 选择,t2.fbillno 单据编号,t2.FHeadSelfS0144 源销售订单号,t2.FHeadSelfS0143 源采购订单号,
t7.fnumber 客户编码,t7.fname 客户名称,t2.finterid 单据内码,t4.fname 制单人,t2.fdate 制单日期,
(select max(fdate) from seorderentry where finterid=t2.finterid) 订单交期  
from seorder t2  
inner join t_user t4 on t4.fuserid=t2.fbillerid  
left join t_Organization t7 on t7.fitemid=t2.fcustid  
inner join t_department t1 on t1.fitemid=t2.fdeptid   
inner join #data t3 on t2.finterid=t3.finterid
--where t2.FHeadSelfS0148<>'1900-01-01' and t2.FHeadSelfS0148<>'2100-01-01'
order by t2.fdate desc   

drop table #data

set nocount off

go


----产品预测生成任务单--%%%%%--modify at 2017-04-24
--My_P_GenerateICMOByMrp 16394,1007,'','',0
IF EXISTS (select * from sysobjects where name='My_P_GenerateICMOByPP' and xtype='p')  drop  procedure My_P_GenerateICMOByPP

go

create procedure [dbo].My_P_GenerateICMOByPP(@fuserid int,@FBegBillNo varchar(40) output,@FEndBillNo varchar(40) output,@fidentify int output)

as
declare @fplanprice decimal(18,4),@fitemid int,@fpitemid int,@funitid int,@entryid int,@fqty int
declare @InterID int,@BillNo varchar (20),@FStockId int,@StockNumber varchar (20)
DECLARE @TmpID INT ,@fsupplyid int,@fcurrencyid int,@FMyPoInStockInterId int
declare @fsupplyno varchar(20),@forderdate datetime,@FValueAddRate decimal(28, 2)
declare @iLength int,@FPrice decimal(28, 5),@FAmount decimal(20, 2),@FExchangeRate decimal(28, 10)
declare @FTaxPrice decimal(28, 5),@FTaxAmount decimal(20, 2),@SupplyId int
declare @fprojectval  varchar(200),@fspid int,@fempid int,@fdeptid int
declare @FDateFormat  varchar(200),@fdate datetime,@forginterid int,@flineid int
declare @fsourceNumber varchar(200),@fpSourceNumber varchar(200),@fpXxSourceNumber varchar(200)
declare @fXxOldSourceNumber varchar(200),@empid int,@fsourcetrantype int
declare @FDCStockID int,@xx_FItemIDOld int,@fxxitemid int,@FOrgPPOInterID int
declare @FDCSPID int,@forderinterid int,@forderentryid int
declare @fsourceInterid int,@fsourceEntryid int,@fsourceBillNo varchar (100)
declare @fyear int,@fperiod int,@FMangerID int,@fplandate datetime,@fplanqty decimal(24,2)
declare @fresultbillno varchar (800)
declare @ftempbillno varchar(50),@fcostobjid int,@fplancommitdate datetime,@fsourceid int
declare @fplanorderinterid int,@fbominterid int,@forgsaleinterid int,@forgentryid int
--AIS20041229163526   AIS20080129143619
--declare @fbout varchar(10),@fcommitdate datetime

select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期
set @forderdate=@fdate  --'2009-06-15' --下单日期
--set @fcommitdate='2009-07-21' --到货日期
select @fresultbillno='',@BillNo=''

--set @fbout='204'
ALTER  TABLE  seorder  DISABLE  TRIGGER  My_Tri_SEOrder 

select @fidentify=isnull(max(fid),0)+1 from my_t_identify
insert into my_t_identify(fid,fuserid,fdate,FTrantypeID) values(@fidentify,@fuserid,getdate(),85)

DECLARE authors_cursor CURSOR FOR	

select 85 fsourcetrantype,t5.fitemid fcostobjid,t6.fitemid,t2.funitid,isnull(t6.FEntrySelfY0122,t6.fqty) fqty,@fdate fneeddate,
t2.fsource,0 fplanorderinterid,t4.finterid fbominterid,t6.finterid forderinterid,t6.fentryid forderentryid,isnull(t6.FEntrySelfY0123,0) flineid
from My_t_PPOrderTemp t1
inner join pporderentry t6 on t6.finterid=t1.finterid and t6.fentryid=t1.fentryid
inner join pporder t7 on t6.finterid=t7.finterid 
inner join t_icitem t2 on t6.fitemid=t2.fitemid 
inner join t_measureunit t3 on t3.fitemid=t2.funitid
inner join icbom t4 on t2.fitemid=t4.fitemid
left join cbCostObj t5 on t5.FStdProductID=t2.fitemid
where t2.ferpclsid=2 and t7.fstatus>0 and isnull(t6.FEntrySelfY0122,t6.fqty)>0
and t1.fuserid=@fuserid

set @entryid=1

OPEN authors_cursor

FETCH NEXT FROM authors_cursor 
INTO @fsourcetrantype,@fcostobjid,@fitemid,@funitid,@fqty,@fplancommitdate,@fsourceid,@fplanorderinterid,@fbominterid,@forderinterid,@forgentryid,@flineid

WHILE @@FETCH_STATUS = 0
BEGIN 
	exec GetICMaxNum 'ICMO', @InterID output

	-- 10.4
	Update t_BillCodeRule Set FReChar = FReChar Where FBillTypeID =85

	SET @TmpID = (SELECT FID FROM t_BillCodeRule WITH(READUNCOMMITTED) WHERE fbilltypeid=85 and fprojectid=3)

	update t_billcoderule set fprojectval = fprojectval+1,flength=case when (flength-len(fprojectval)) >= 0 then flength else len(fprojectval) end where FID =  @TmpID 
	Update ICBillNo Set FCurNo = (select top 1 isnull(fprojectval,1) from t_billcoderule where fprojectid = 3 and fbilltypeid =85) where fbillid = 85
	   
	--长度和目前编码
	select @fprojectval=(fprojectval-1),@iLength=flength from t_BillCodeRule where fprojectid = 3 and fbilltypeid = 85
	  
	-- 前缀
	select @BillNo=fprojectval+left('0000000000',@iLength-(len(@fprojectval)))+@fprojectval from t_BillCodeRule where fprojectid = 1 and fbilltypeid = 85  --@iLength

    if @entryid=1 
		set @fbegBillNo=@BillNo

	--icmo fstatus 5 确认 0 计划 1,2 下达 3 结案  fmrp 11061 mps产生 1052 手工录入 11077 mrp产生 --select forderinterid,fpporderinterid,fsourceentryid,* from icmo
	insert into icmo(FHeadSelfJ0187,FHeadSelfJ0174,FHeadSelfJ0175,FInterID,FBillNo,FBrNo,FTranType,FCancellation,FCheckDate,Fstatus,FMRP, FWorktypeID,FCostObjID, FBomInterID, FRoutingID,FWorkShop, FSupplyID,FItemID, FUnitID, Fauxqty,FPlanCommitDate, FPlanFinishDate,Fnote,FCommitDate,FBillerID,FOrderInterID,    FParentInterID,FPPOrderInterID, FType,FSourceEntryID,FProcessPrice,FProcessFee,FPlanOrderInterID, FScheduleID,FCustID,FMultiCheckLevel1,FMultiCheckDate1,FMultiCheckLevel2,FMultiCheckDate2,FMultiCheckLevel3,FMultiCheckDate3,FMultiCheckLevel4,FMultiCheckDate4,FMultiCheckLevel5,FMultiCheckDate5,FMultiCheckLevel6,FMultiCheckDate6,FConfirmDate,FInHighLimit,FAuxInHighLimitQty,FInLowLimit,FAuxInLowLimitQty,FGMPBatchNo,               FMrpLockFlag,FChangeTimes,FCloseDate)
	values(          @flineid,      @fidentify,    0,             @InterId,@BillNo,0,    85,       0,            @fdate    ,0,      11077,55,         @FCostObjID,@fbominterid,0         ,@fsourceid,0,        @FItemId,@funitid,@fqty,  @FPlanCommitDate,@FPlanCommitDate,'',  @fdate,     @fuserid, @FOrgSaleInterID, 0,             @FOrderInterID, 1054, @forgentryid,  0,            0,          @fplanorderinterid,0,          0,      NULL,             NULL	,           NULL	,         NULL	,          NULL	,            NULL,            NULL,            	NULL,            NULL,             NULL	           ,NULL	,         NULL	      ,  @fdate,      0,	       1000000,           0,          @fqty,            isnull(@fsourceBillNo,''), 0,           0,           NULL	)

--	exec My_P_AddOrEditPPBom @fuserid,@InterId  --非成品的投料单由用户点下达生成

	--update icmo set Fstatus=1,FConfirmerID=@fuserid , FConfirmDate=@fdate , FConveyerID=@fuserid , FCommitDate=@fdate where finterid=@InterId
	--update icmo set Fstatus=5,FConfirmerID=@fuserid , FConfirmDate=@fdate where finterid=@InterId

	/*--用户手工排计划
	DECLARE SeorderEntry_Cursor CURSOR FOR
	select t5.fneeddate,t5.fneedqty
	from my_t_mrpresultdetail t5 
	where t5.frunid=@frunid and t5.fitemid=@fitemid and t5.fneedqty>0
	order by t5.fneeddate

	OPEN SeorderEntry_Cursor

	FETCH NEXT FROM SeorderEntry_Cursor 
	INTO @fplandate,@fplanqty

	WHILE @@FETCH_STATUS = 0 and @fqty>0  --
	BEGIN
		if @fplanqty>=@fqty  --
		begin
			set @fplanqty=@fqty
			set @fqty=0
		end
		else
		begin
			set @fqty=@fqty-@fplanqty
		end	
		
		insert into my_t_scheduledetail (fbillerid, fsourcetrantype, ficmointerid,funitid, fitemid, fdeptid,   fdate,     fqty,     fnote)
								  values(@fuserid,  85,              @InterId,    @funitid,@fitemid,@fsourceid,@fplandate,@fplanqty,'')

		FETCH NEXT FROM SeorderEntry_Cursor 
		INTO @fplandate,@fplanqty
	end

	if @fqty>0 
	begin
		if exists(select 1 from my_t_scheduledetail where ficmointerid=@InterId and fdate=@fplandate)
		begin
			update t1 set fqty=t1.fqty+@fqty from my_t_scheduledetail t1 where ficmointerid=@InterId and fdate=@fplandate
		end
		else
		begin
			insert into my_t_scheduledetail (fbillerid, fsourcetrantype, ficmointerid,funitid, fitemid, fdeptid,   fdate,     fqty, fnote)
									  values(@fuserid,  85,              @InterId,    @funitid,@fitemid,@fsourceid,@fplandate,@fqty,'')			
		end
	end

	CLOSE SeorderEntry_Cursor
	DEALLOCATE SeorderEntry_Cursor
	*/
	set @entryid=@entryid+1

	FETCH NEXT FROM authors_cursor 
	INTO @fsourcetrantype,@fcostobjid,@fitemid,@funitid,@fqty,@fplancommitdate,@fsourceid,@fplanorderinterid,@fbominterid,@forderinterid,@forgentryid,@flineid
END

CLOSE authors_cursor
DEALLOCATE authors_cursor

ALTER  TABLE  seorder  ENABLE  TRIGGER  My_Tri_SEOrder 

--单据编号自定义的

set @fendBillNo=@BillNo

set nocount off

GO


--成品MRP运算--生成、确认、下达任务单;生成生产计划--外购件直接生成生产计划??????--%%%%%
--My_P_MrpCalProduct 16394,1,'',0
IF EXISTS (select * from sysobjects where name='My_P_MrpCalProduct' and xtype='p')  drop  procedure My_P_MrpCalProduct

go

create procedure [dbo].My_P_MrpCalProduct(@fuserid int,@frunid int,@fbillno varchar(20),@fidentify int output)

as

--declare @fuserid int select @fuserid=16394

set nocount on 

declare @fplanprice decimal(18,4),@fitemid int,@fpitemid int,@funitid int,@entryid int,@fqty int
declare @InterID int,@BillNo varchar (20),@FStockId int,@StockNumber varchar (20)
DECLARE @TmpID INT ,@fsupplyid int,@fcurrencyid int,@FMyPoInStockInterId int
declare @fsupplyno varchar(20),@forderdate datetime,@FValueAddRate decimal(28, 2)
declare @iLength int,@FPrice decimal(28, 5),@FAmount decimal(20, 2),@FExchangeRate decimal(28, 10)
declare @FTaxPrice decimal(28, 5),@FTaxAmount decimal(20, 2),@SupplyId int
declare @fprojectval varchar(200),@fspid int,@fempid int,@fdeptid int,@fplanbegindate datetime
declare @FDateFormat varchar(200),@fdate datetime,@forginterid int,@fpacktype varchar(50)
declare @FSourcePOBillNo varchar(100),@FSourceSeBillNo varchar(100),@fcustid int
declare @fsourceNumber varchar(200),@fpSourceNumber varchar(200),@fpXxSourceNumber varchar(200)
declare @fXxOldSourceNumber varchar(200),@empid int,@fsourcetrantype int,@fbatchno varchar(50)
declare @FDCStockID int,@xx_FItemIDOld int,@fxxitemid int,@FOrgPPOInterID int
declare @FDCSPID int,@forderinterid int,@forderentryid int,@forderbillno varchar(30)
declare @fsourceInterid int,@fsourceEntryid int,@fsourceBillNo varchar (100)
declare @fyear int,@fperiod int,@FMangerID int,@s varchar(8000),@fdeliverid int
declare @fresultbillno varchar (800),@FBegBillNo varchar(20),@FEndBillNo varchar(20)
declare @ftempbillno varchar(50),@fcostobjid int,@fplancommitdate datetime,@fsourceid int
declare @fplanorderinterid int,@fbominterid int,@forgsaleinterid int,@forgentryid int
--AIS20041229163526   AIS20080129143619
--declare @fbout varchar(10),@fcommitdate datetime

declare @FProductProspectDays int,@FHalfProductProspectDays int,@FProductPrepareDays int,@FHalfProductPrepareDays int

select @FProductProspectDays=fvalue from t_SystemProfile where FCategory='IC' and fkey='FProductProspectDays' 
select @FHalfProductProspectDays=fvalue from t_SystemProfile where FCategory='IC' and fkey='FHalfProductProspectDays' 
select @FProductPrepareDays=fvalue from t_SystemProfile where FCategory='IC' and fkey='FProductPrepareDays' 
select @FHalfProductPrepareDays=fvalue from t_SystemProfile where FCategory='IC' and fkey='FHalfProductPrepareDays' 


select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期
select @fresultbillno='',@BillNo='',@s=''

--保存运算信息
if not exists(select 1 from my_t_Mrp where frunid=@frunid)
begin
	insert into my_t_Mrp(ftrantype, fbillno, frunid, fuserid, fbilltime,fdate) 
	values(              0,         @fbillno,@frunid,@fuserid,getdate(),@fdate)
end

--set @fbout='204'


select @fidentify=isnull(max(fid),0)+1 from my_t_identify

insert into my_t_identify(fid,fuserid,fdate,FTrantypeID) values(@fidentify,@fuserid,getdate(),85)
select isnull(t1.FEntrySelfS0175,40089) fdeliverid,isnull(t7.fheadselfs0143,'') FSourcePoBillNo,isnull(t7.fheadselfs0144,'') FSourceSeBillNo,
--Dateadd(day,-@FProductPrepareDays,t1.fdate) fplancommitdate/*计划完工日期=订单出货日期-提前期*/,
t7.FHeadSelfS0154 fplanbegindate,t1.fdate /*t7.FHeadSelfS0148*/ fplancommitdate,
t7.fcustid,t14.fname fpacktype,
81 fsourcetrantype,isnull(t5.fitemid,0) fcostobjid,t1.fitemid,t4.finterid fbominterid,
t2.funitid,t1.fqty-isnull(t8.fqty,0) fqty,(case when left(t2.fnumber,4)='v.e.' then 175684 else 176 end) fdeptid,
isnull(t11.fid,0) fpacksubid,
isnull(t9.fitemid,0) fchilditemid,isnull(t10.fitemid,0) fchipitemid,isnull(t13.fitemid,0) fchipverid,
t1.finterid forderinterid,t1.fentryid forderentryid,t7.fbillno forderbillno,t2.ferpclsid,t2.fnumber
into #data
from seorderentry t1 
inner join seorder t7 on t1.finterid=t7.finterid
inner join t_icitem t2 on t1.fitemid=t2.fitemid 
inner join t_measureunit t3 on t3.fitemid=t2.funitid
inner join icbom t4 on t2.fitemid=t4.fitemid and t4.fusestatus=1072 --成品BOM
left join cbCostObj t5 on t5.FStdProductID=t2.fitemid  --成本对象 --t5.fnumber=t2.fnumber -- 
left join (select forderinterid,fsourceentryid,sum(fqty) fqty from icmo t1 group by forderinterid,fsourceentryid) t8 on t1.finterid=t8.forderinterid and t1.fentryid=t8.fsourceentryid
left join t_icitem t9 on t9.fitemid=t1.fentryselfs0164  --半成品
left join t_icitem t10 on t10.fitemid=t1.fentryselfs0161  --芯片
left join (select min(fid) fid,fproductid,fbrandid from t_BOSPackSub group by fproductid,fbrandid) t11 on t11.fproductid=t1.fitemid and t11.fbrandid=t1.fentryselfs0158  --成品的包装方式
left join t_item t13 on t13.fitemid=t1.fentryselfs0160 and t13.fitemclassid=3006 --芯片版本  --16465  无芯片
left join t_item t14 on t14.fitemclassid=3002 and t14.fitemid=t1.fentryselfs0158  --包装方式
where --datediff(day,getdate(),t1.fdate)<=@FProductProspectDays  --成品展望期30天 
t1.finterid in (select forderinterid from my_t_MrpSeOrder where frunid=@frunid and fselect=1) --去掉不参与运算的
and t1.fmrpclosed<>1 --行业务未关闭
and (t7.fstatus>0 or isnull(t7.FMultiCheckLevel1,0)>0) --一审或者已经审核
and (t1.fqty>isnull(t8.fqty,0)) --未完全生成生产任务单
order by t1.fdate,t1.fdeptid,t1.finterid,t1.fentryid


--放在前台检查
----自制件但没配置半成品
--if exists(select t1.forderbillno,t1.fnumber from #data t1 where ferpclsid=2 and fchilditemid=0)
--begin
--	select @s=@s+','+m1.fbillno from
--	(
--		select (t1.forderbillno+' | '+t1.fnumber) fbillno from #data t1 where ferpclsid=2 and fchilditemid=0
--	) m1
--
--	set @s='['+@s+']还未配置半成品!'  --
--	RAISERROR(@s,18,18)
--end 
--
----要芯片但没有配置芯片
--if exists(select t1.forderbillno,t1.fnumber from #data t1 where fchipverid<>16465 and fchipitemid=0)
--begin
--	select @s=@s+','+m1.fbillno from
--	(
--		select (t1.forderbillno+' | '+t1.fnumber) fbillno from #data t1 where fchipverid<>16465 and fchipitemid=0
--	) m1
--
--	set @s='['+@s+']还未配置芯片!'  --
--	RAISERROR(@s,18,18)
--end 

DECLARE authors_cursor CURSOR FOR	

select t1.fpacktype,t1.fcustid,t1.fdeliverid,t1.FSourcePoBillNo,t1.FSourceSeBillNo,t1.fsourcetrantype,t1.fcostobjid,t1.fitemid,t1.funitid,t1.fqty,
t1.fplanbegindate,(case when t1.fplancommitdate<@fdate then @fdate else t1.fplancommitdate end) fplancommitdate,
t1.fdeptid,t1.fbominterid,t1.forderinterid,t1.forderentryid,t1.forderbillno
from #data t1 

OPEN authors_cursor

FETCH NEXT FROM authors_cursor 
INTO @fpacktype,@fcustid,@fdeliverid,@FSourcePoBillNo,@FSourceSeBillNo,@fsourcetrantype,@fcostobjid,@fitemid,@funitid,@fqty,@fplanbegindate,@fplancommitdate,@fsourceid,@fbominterid,@forderinterid,@forderentryid,@forderbillno

WHILE @@FETCH_STATUS = 0
BEGIN 
	exec GetICMaxNum 'ICMO', @InterID output

	-- 10.4
	Update t_BillCodeRule Set FReChar = FReChar Where FBillTypeID =85

	SET @TmpID = (SELECT FID FROM t_BillCodeRule WITH(READUNCOMMITTED) WHERE fbilltypeid=85 and fprojectid=3)

	update t_billcoderule set fprojectval = fprojectval+1,flength=case when (flength-len(fprojectval)) >= 0 then flength else len(fprojectval) end where FID =  @TmpID 
	Update ICBillNo Set FCurNo = (select top 1 isnull(fprojectval,1) from t_billcoderule where fprojectid = 3 and fbilltypeid =85) where fbillid = 85
	   
	--长度和目前编码
	select @fprojectval=(fprojectval-1),@iLength=flength from t_BillCodeRule where fprojectid = 3 and fbilltypeid = 85
	  
	-- 前缀
	select @BillNo=fprojectval+left('0000000000',@iLength-(len(@fprojectval)))+@fprojectval from t_BillCodeRule where fprojectid = 1 and fbilltypeid = 85  --@iLength

	--40089	自产自包,40090	外调自包,40091	外调外包

	set @fsupplyid=0

	if @fdeliverid in (40090,40091)
	begin
		select top 1 @fsupplyid=t1.FSupplyID
		from poorder t1
		inner join poorderentry t2 on t1.finterid=t2.finterid
		where t2.fsourceinterid=@forderinterid and t2.fsourceentryid=@forderentryid and t2.fsourcetrantype=81
	end

	--if @fcustid=16707 --诚华
	--	set @fbatchno=@fpacktype
	--else 
		set @fbatchno=@forderbillno

	--icmo fstatus 5 确认 0 计划 1,2 下达 3 结案  
	--fbillerid 制单人 fcheckdate 制单日期 FConfirmerID 确认人 FConfirmDate 确认日期 FConveyerID 下达人 FCommitDate 下达日期 FCheckerID 结案人 FCloseDate 结案日期
	--fmrp 11061 mps产生 1052 手工录入 11077 mrp产生 --select forderinterid,fpporderinterid,fsourceentryid,* from icmo
	insert into icmo(FHeadSelfJ0182,FHeadSelfJ0180,       FHeadSelfJ0176 , FHeadSelfJ0177 , FHeadSelfJ0174,FHeadSelfJ0175,FInterID,FBillNo,FBrNo,FTranType,FCancellation,FCheckDate,Fstatus,FMRP, FWorktypeID,FCostObjID, FBomInterID, FRoutingID,FWorkShop, FSupplyID,FItemID, FUnitID, Fauxqty,FPlanCommitDate, FPlanFinishDate,Fnote,FCommitDate,FBillerID,FOrderInterID,  FParentInterID,FPPOrderInterID, FType,FSourceEntryID,FProcessPrice,FProcessFee,FPlanOrderInterID, FScheduleID,FCustID,FMultiCheckLevel1,FMultiCheckDate1,FMultiCheckLevel2,FMultiCheckDate2,FMultiCheckLevel3,FMultiCheckDate3,FMultiCheckLevel4,FMultiCheckDate4,FMultiCheckLevel5,FMultiCheckDate5,FMultiCheckLevel6,FMultiCheckDate6,FConfirmDate,FInHighLimit,FAuxInHighLimitQty,FInLowLimit,FAuxInLowLimitQty,FGMPBatchNo,   FMrpLockFlag,FChangeTimes,FCloseDate)
			  values(@fdeliverid ,  isnull(@fsupplyid,0), @FSourcePOBillNo,@FSourceSeBillNo,@fidentify,    @frunid,       @InterId,@BillNo,0,    85,       0,            @fdate    ,0,      11077,55,         @FCostObjID,@fbominterid,0         ,@fsourceid,0,        @FItemId,@funitid,@fqty,  @fplanbegindate, @FPlanCommitDate,'',  @fdate,     @fuserid, @FOrderInterID, 0,             0,               1054, @forderentryid,0,            0,          0,                 0,          0,      NULL,             NULL	,          NULL	,         NULL	,          NULL	,            NULL,            NULL,            	NULL,            NULL,             NULL	           ,NULL	,         NULL	      ,       @fdate,      0,	        @fqty,             0,          @fqty,            @fbatchno,     0,           0,           NULL	)

	insert into My_t_MrpRoughNeedSource(fneeddate,      ftrantype,frunid, fsourceinterid, fsourceentryid,  fitemid,  fqty)
	select                              @fplanbegindate,81,       @frunid,@FOrderInterID, @forderentryid,  @fitemid, @fqty

	exec My_P_AddOrEditPPBom @fuserid,@InterId,0

	--不能设置为确认状态,因为成品的BOM是虚拟的,下达时会提示BOM不存在
	--update icmo set Fstatus=1,FConfirmerID=@fuserid , FConfirmDate=@fdate , FConveyerID=@fuserid , FCommitDate=@fdate where finterid=@InterId
	update icmo set Fstatus=5,FConfirmerID=@fuserid , FConfirmDate=@fdate where finterid=@InterId

    --insert into my_t_scheduledetail (fbillerid, fsourcetrantype, ficmointerid,funitid, fitemid, fdeptid,   fdate,          fqty, fnote)
				--		      values(@fuserid,  85,              @InterId,    @funitid,@fitemid,@fsourceid,@fplanbegindate,@fqty,'')

	FETCH NEXT FROM authors_cursor 
	INTO @fpacktype,@fcustid,@fdeliverid,@FSourcePoBillNo,@FSourceSeBillNo,@fsourcetrantype,@fcostobjid,@fitemid,@funitid,@fqty,@fplanbegindate,@fplancommitdate,@fsourceid,@fbominterid,@forderinterid,@forderentryid,@forderbillno
END

CLOSE authors_cursor
DEALLOCATE authors_cursor



--单据编号自定义的

set @fendBillNo=@BillNo

drop table #data

set nocount off

GO


----追加包材投料
--IF EXISTS (select * from sysobjects where name='My_P_AddPackPPBomEntry' and xtype='p')  drop  procedure My_P_AddPackPPBomEntry
--
--go
--
--create procedure [dbo].My_P_AddPackPPBomEntry(@finterid int)
--
--as
--set nocount on
--
--declare @fuserid int
--declare @fplanprice decimal(18,4),@fitemid int,@fpitemid int,@funitid int,@entryid int,@fqty int
--declare @InterID int,@BillNo varchar (20),@FStockId int,@StockNumber varchar (20)
--DECLARE @TmpID INT ,@fsupplyid int,@fcurrencyid int,@FMyPoInStockInterId int
--declare @fsupplyno varchar(20),@forderdate datetime,@FValueAddRate decimal(28, 2)
--declare @iLength int,@FPrice decimal(28, 5),@FAmount decimal(20, 2),@FExchangeRate decimal(28, 10)
--declare @FTaxPrice decimal(28, 5),@FTaxAmount decimal(20, 2),@SupplyId int
--declare @fprojectval  varchar(200),@fspid int,@fempid int,@fdeptid int
--declare @sDateFormat  varchar(200),@fdate datetime,@forginterid int,@ficmointerid int
--declare @fsourceNumber varchar(200),@fpSourceNumber varchar(200),@fpXxSourceNumber varchar(200)
--declare @fXxOldSourceNumber varchar(200),@empid int,@fsourcetrantype int,@fchipitemid int
--declare @FDCStockID int,@xx_FItemIDOld int,@fxxitemid int,@FOrgPPOInterID int
--declare @FDCSPID int,@forderinterid int,@forderentryid int,@fppbominterid int,@fpacksubid int
--declare @fsourceInterid int,@fsourceEntryid int,@fsourceBillNo varchar (100)
--declare @fyear int,@fperiod int,@FMangerID int,@fmoqty decimal(24,2),@FSendItemDate datetime
--declare @fresultbillno varchar (800),@FQtyScrap decimal(24,2),@FBomInputQty decimal(24,2),@fqtymust decimal(24,2)
--declare @ftempbillno varchar(50),@fcostobjid int,@fplancommitdate datetime,@fsourceid int
--declare @fplanorderinterid int,@fbominterid int,@forgsaleinterid int,@forgentryid int,@fscrap decimal(24,4)
----AIS20041229163526   AIS20080129143619
----declare @fbout varchar(10),@fcommitdate datetime
--
--select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期
--set @forderdate=@fdate  --'2009-06-15' --下单日期
----set @fcommitdate='2009-07-21' --到货日期
--set @fresultbillno=''
--
--select @fmoqty=t5.fqty,@ficmointerid=t5.finterid,@fppbominterid=t8.finterid,@fpacksubid=isnull(t7.fid,0),@fchipitemid=isnull(t1.fitemid,0)
--from icmo t5 
--inner join t_icitem t2 on t5.fitemid=t2.fitemid 
--inner join t_measureunit t3 on t3.fitemid=t2.funitid
----inner join icbom t4 on t2.fitemid=t4.fitemid
--inner join seorderentry t6 on t6.finterid=t5.forderinterid and t5.fsourceentryid=t6.fentryid
--inner join seorder t9 on t9.finterid=t6.finterid
--left join t_BOSPackSub t7 on t7.fproductid=t1.fitemid and t7.fbrandid=t1.fentryselfs0158
--inner join ppbom t8 on t8.ficmointerid=t5.finterid
--left join t_icitem t1 on t6.fentryselfs0160=t1.fitemid
--where t5.finterid=@finterid --and t9.fdate>='2011-10-08'
--order by t5.fbillno
--
--set @fscrap=0
--
----取发料日期
--select top 1 @FSendItemDate=FSendItemDate
--from ppbomentry t2 
--inner join t_icitem t3 on t2.fitemid=t3.fitemid
--where t2.finterid=@fppbominterid
--
--select @entryid=max(fentryid)+1 from ppbomentry where finterid=@fppbominterid
--
----新增包材
--DECLARE authorsentry_cursor CURSOR FOR	
--select t2.fitemid,t2.fqty FQtyScrap,@fmoqty*t2.fqty FBomInputQty,
--(@fmoqty*t2.fqty*(1+@fscrap)) fqtymust,t2.funitid,isnull(t3.fdefaultloc,0) fstockid
--from t_BOSPackSub t1 
--inner join t_BOSPackSubEntry t2 on t1.fid=t2.fid 
--inner join t_icitem t3 on t2.fitemid=t3.fitemid
--where t1.fid=@fpacksubid
--
--OPEN authorsentry_cursor
--
--FETCH NEXT FROM authorsentry_cursor 
--INTO @fitemid,@FQtyScrap,@FBomInputQty,@fqtymust,@funitid,@fstockid
--
--WHILE @@FETCH_STATUS = 0
--BEGIN 
--	--print @fitemid
--	--icmo fstatus 5 确认 0 计划 1 下达 3 结案  fmrp 11061 mps产生 1052 手工录入 11077 mrp产生 
--	--ppbomentry fqtyscrp 单位用量  FScrap 损耗率
--	Insert Into PPBOMEntry (FICMOinterID,  FBrNo,FInterID,      FEntryID,FItemID, FUnitID, FAuxQtyMust,FAuxQty,FMachinePos,FBomInputAuxQty,FauxQtyLoss,FSequenceID,FStockID, FNote,FSourceEntryID,FAuxQtyScrap,FScrap,  FSendItemDate,  FAuxQtyPick,  FSPID,FOperID,FOperSN,FMaterielType,FBackFlush,FMarshalType,FBOMInterID,FBatchNO )
--	Values (                @ficmointerid,'0',   @fppbominterid,@entryid,@fitemid,@funitid,@fqtymust,  0,      '',         @FBomInputQty,  0,          '',         @fstockid,'',   0,             @FQtyScrap,  @fscrap, @FSendItemDate, @FBomInputQty,0,    0,      0,      371,          1059,      385,         0,          '')
--
--	set @entryid=@entryid+1
--
--	FETCH NEXT FROM authorsentry_cursor 
--	INTO @fitemid,@FQtyScrap,@FBomInputQty,@fqtymust,@funitid,@fstockid
--END
--
--CLOSE authorsentry_cursor
--DEALLOCATE authorsentry_cursor
--
--EXEC prc_SHUpdateBillDoubleQty 88,@fppbominterid
--
--set nocount off
--
--GO


--导入生成直入直出单据-----------------------------++++++++++++++++++++++++++++++++
/*
IF EXISTS (select * from sysobjects where name='My_P_GenerateDirectInOut' and xtype='p')  drop  procedure My_P_GenerateDirectInOut



create procedure [dbo].My_P_GenerateDirectInOut(@fuserid int,@fdate datetime,@InterID int output)

as
declare @fplanprice decimal(18,4),@fitemid int,@fpitemid int,@funitid int,@entryid int,@fqty int
declare @forderbillno varchar (20),@FStockId int,@StockNumber varchar (20)
DECLARE @TmpID INT ,@fsupplyid int,@fcurrencyid int,@FMyPoInStockInterId int
declare @fsupplyno varchar(20),@forderdate datetime,@FValueAddRate decimal(28, 2)
declare @iLength int,@FPrice decimal(28, 5),@FAmount decimal(20, 2),@FExchangeRate decimal(28, 10)
declare @FTaxPrice decimal(28, 5),@FTaxAmount decimal(20, 2),@SupplyId int
declare @fprojectval  varchar(200),@fspid int,@fempid int,@fdeptid int
declare @FDateFormat  varchar(200),@forginterid int,@BillNo varchar(50)
declare @fsourceNumber varchar(200),@fpSourceNumber varchar(200),@fpXxSourceNumber varchar(200)
declare @fXxOldSourceNumber varchar(200),@empid int,@fsourcetrantype int
declare @FDCStockID int,@xx_FItemIDOld int,@fxxitemid int,@FOrgPPOInterID int
declare @FDCSPID int,@forderinterid int,@forderentryid int
declare @fsourceInterid int,@fsourceEntryid int,@fsourceBillNo varchar (100)
declare @fyear int,@fperiod int,@FMangerID int
declare @fresultbillno varchar (800)
declare @ftempbillno varchar(50),@fcostobjid int,@fplancommitdate datetime,@fsourceid int
declare @fplanorderinterid int,@fbominterid int,@forgsaleinterid int,@forgentryid int
--AIS20041229163526   AIS20080129143619
--declare @fbout varchar(10),@fcommitdate datetime

--select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期
set @forderdate=@fdate  --'2009-06-15' --下单日期
--set @fcommitdate='2009-07-21' --到货日期
set @fresultbillno=''

exec GetICMaxNum 't_BosDirectInOut', @InterID output

DECLARE authors_cursor CURSOR FOR	

select t1.finterid,t1.fsourcetrantype,0 fcostobjid,t1.fitemid,t2.funitid,t1.fqty,t1.fdate,
t1.fdeptid,0 fplanorderinterid,t4.finterid fbominterid,
t1.forderinterid,t1.forderentryid,t4.fbillno
from my_t_scheduledetail t1 
inner join t_icitem t2 on t1.fitemid=t2.fitemid 
inner join t_measureunit t3 on t3.fitemid=t2.funitid
inner join My_t_ScheduleDetailTemp t6 on t1.finterid=t6.finterid
inner join seorder t4 on t4.finterid=t1.forderinterid
where t6.fuserid=@fuserid and t2.ferpclsid<>2
--group by t1.forderinterid,t1.forderentryid,t1.fitemid,t1.fdate,t1.fdeptid,t2.funitid,t4.finterid,t5.fitemid
order by t1.fdate,t1.fdeptid,t1.forderinterid,t1.forderentryid

set @entryid=1

OPEN authors_cursor

FETCH NEXT FROM authors_cursor 
INTO @forginterid,@fsourcetrantype,@fcostobjid,@fitemid,@funitid,@fqty,@fplancommitdate,@fsourceid,@fplanorderinterid,@fbominterid,@forderinterid,@forgentryid,@forderbillno

WHILE @@FETCH_STATUS = 0
BEGIN 
	INSERT INTO t_BosDirectInOutEntry(fdeptid,   fsourceinterid,fsupplyid,  fproductid,fprepscrap,  fitemid, FID,     FIndex,  FQty, fperqty, fbomqty, funitid, FRemark,   FCommitQty,FBillNo_SRC,   FClassID_SRC,FID_SRC,        FEntryID_SRC) 
	Values(							  @fsourceid,@forginterid,  0,          0,         0,           @fitemid,@InterID,@entryid,@FQty,0,       0,       @funitid,'',        0,         @forderbillno, -81,         @forderinterid, @forgentryid)

	set @entryid=@entryid+1

	FETCH NEXT FROM authors_cursor 
	INTO @forginterid,@fsourcetrantype,@fcostobjid,@fitemid,@funitid,@fqty,@fplancommitdate,@fsourceid,@fplanorderinterid,@fbominterid,@forderinterid,@forgentryid,@forderbillno
END

CLOSE authors_cursor
DEALLOCATE authors_cursor

-- 10.4
Update t_BillCodeRule Set FReChar = FReChar Where FBillTypeID =200000006

SET @TmpID = (SELECT FID FROM t_BillCodeRule WITH(READUNCOMMITTED) WHERE fbilltypeid=200000006 and fprojectid=3)

update t_billcoderule set fprojectval = fprojectval+1,flength=case when (flength-len(fprojectval)) >= 0 then flength else len(fprojectval) end where FID =  @TmpID 
Update ICBillNo Set FCurNo = (select top 1 isnull(fprojectval,1) from t_billcoderule where fprojectid = 3 and fbilltypeid =200000006) where fbillid = 200000006
   
--长度和目前编码
select @fprojectval=(fprojectval-1),@iLength=flength from t_BillCodeRule where fprojectid = 3 and fbilltypeid = 200000006
  
--日期
--select fprojectval,GetDate() AS DateNow from t_BillCodeRule where fprojectid = 2 and fbilltypeid = 100
  --  sDateFormat = tempRs.Fields(fprojectval)
  --  sDateFormat = Format(DateValue(tempRs.Fields(DateNow)), sDateFormat)

-- 前缀
select @BillNo=fprojectval+left('0000000000',@iLength-(len(@fprojectval)))+@fprojectval from t_BillCodeRule where fprojectid = 1 and fbilltypeid = 200000006  --@iLength

INSERT INTO t_BosDirectInOut(FID,     FClassTypeID,FBillNo,FDate,  FBiller, FChecker,  FNOTE) 
Values(                      @InterID,200000006,   @BillNo,@fdate, @fuserid,0       ,  '')

set nocount off
*/
GO


----MRP计算生成任务单--%%%%%
--My_P_GenerateICMOByMrp 16394,1007,'','',0
IF EXISTS (select * from sysobjects where name='My_P_GenerateICMOByMrp' and xtype='p')  drop  procedure My_P_GenerateICMOByMrp

go

create procedure [dbo].My_P_GenerateICMOByMrp(@fuserid int,@frunid int,@FBegBillNo varchar(40) output,@FEndBillNo varchar(40) output,@fidentify int output)

as
declare @fplanprice decimal(18,4),@fitemid int,@fpitemid int,@funitid int,@entryid int,@fqty int
declare @InterID int,@BillNo varchar (20),@FStockId int,@StockNumber varchar (20)
DECLARE @TmpID INT ,@fsupplyid int,@fcurrencyid int,@FMyPoInStockInterId int
declare @fsupplyno varchar(20),@forderdate datetime,@FValueAddRate decimal(28, 2)
declare @iLength int,@FPrice decimal(28, 5),@FAmount decimal(20, 2),@FExchangeRate decimal(28, 10)
declare @FTaxPrice decimal(28, 5),@FTaxAmount decimal(20, 2),@SupplyId int
declare @fprojectval  varchar(200),@fspid int,@fempid int,@fdeptid int
declare @FDateFormat  varchar(200),@fdate datetime,@forginterid int
declare @fsourceNumber varchar(200),@fpSourceNumber varchar(200),@fpXxSourceNumber varchar(200)
declare @fXxOldSourceNumber varchar(200),@empid int,@fsourcetrantype int
declare @FDCStockID int,@xx_FItemIDOld int,@fxxitemid int,@FOrgPPOInterID int
declare @FDCSPID int,@forderinterid int,@forderentryid int
declare @fsourceInterid int,@fsourceEntryid int,@fsourceBillNo varchar (100)
declare @fyear int,@fperiod int,@FMangerID int,@fplandate datetime,@fplanqty decimal(24,2)
declare @fresultbillno varchar (800)
declare @ftempbillno varchar(50),@fcostobjid int,@fplancommitdate datetime,@fsourceid int
declare @fplanorderinterid int,@fbominterid int,@forgsaleinterid int,@forgentryid int
--AIS20041229163526   AIS20080129143619
--declare @fbout varchar(10),@fcommitdate datetime

select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期
set @forderdate=@fdate  --'2009-06-15' --下单日期
--set @fcommitdate='2009-07-21' --到货日期
select @fresultbillno='',@BillNo=''

--set @fbout='204'
ALTER  TABLE  seorder  DISABLE  TRIGGER  My_Tri_SEOrder 

select @fidentify=isnull(max(fid),0)+1 from my_t_identify
insert into my_t_identify(fid,fuserid,fdate,FTrantypeID) values(@fidentify,@fuserid,getdate(),85)

DECLARE authors_cursor CURSOR FOR	

select 85 fsourcetrantype,t5.fitemid fcostobjid,t1.fitemid,t2.funitid,t1.fqty,t1.fneeddate,
t2.fsource,0 fplanorderinterid,t4.finterid fbominterid,0 forderinterid,0 forderentryid
from my_t_MrpResultSum t1 
inner join t_icitem t2 on t1.fitemid=t2.fitemid 
inner join t_measureunit t3 on t3.fitemid=t2.funitid
inner join icbom t4 on t2.fitemid=t4.fitemid
inner join cbCostObj t5 on t5.FStdProductID=t2.fitemid
where t2.ferpclsid=2 and t1.FQty>0 and t1.fselect=1
and t1.frunid=@frunid

set @entryid=1

OPEN authors_cursor

FETCH NEXT FROM authors_cursor 
INTO @fsourcetrantype,@fcostobjid,@fitemid,@funitid,@fqty,@fplancommitdate,@fsourceid,@fplanorderinterid,@fbominterid,@forderinterid,@forgentryid

WHILE @@FETCH_STATUS = 0
BEGIN 
	exec GetICMaxNum 'ICMO', @InterID output

	-- 10.4
	Update t_BillCodeRule Set FReChar = FReChar Where FBillTypeID =85

	SET @TmpID = (SELECT FID FROM t_BillCodeRule WITH(READUNCOMMITTED) WHERE fbilltypeid=85 and fprojectid=3)

	update t_billcoderule set fprojectval = fprojectval+1,flength=case when (flength-len(fprojectval)) >= 0 then flength else len(fprojectval) end where FID =  @TmpID 
	Update ICBillNo Set FCurNo = (select top 1 isnull(fprojectval,1) from t_billcoderule where fprojectid = 3 and fbilltypeid =85) where fbillid = 85
	   
	--长度和目前编码
	select @fprojectval=(fprojectval-1),@iLength=flength from t_BillCodeRule where fprojectid = 3 and fbilltypeid = 85
	  
	-- 前缀
	select @BillNo=fprojectval+left('0000000000',@iLength-(len(@fprojectval)))+@fprojectval from t_BillCodeRule where fprojectid = 1 and fbilltypeid = 85  --@iLength

    if @entryid=1 
		set @fbegBillNo=@BillNo

	--icmo fstatus 5 确认 0 计划 1,2 下达 3 结案  fmrp 11061 mps产生 1052 手工录入 11077 mrp产生 --select forderinterid,fpporderinterid,fsourceentryid,* from icmo
	insert into icmo(FHeadSelfJ0174,FHeadSelfJ0175,FInterID,FBillNo,FBrNo,FTranType,FCancellation,FCheckDate,Fstatus,FMRP, FWorktypeID,FCostObjID, FBomInterID, FRoutingID,FWorkShop, FSupplyID,FItemID, FUnitID, Fauxqty,FPlanCommitDate, FPlanFinishDate,Fnote,FCommitDate,FBillerID,FOrderInterID,    FParentInterID,FPPOrderInterID, FType,FSourceEntryID,FProcessPrice,FProcessFee,FPlanOrderInterID, FScheduleID,FCustID,FMultiCheckLevel1,FMultiCheckDate1,FMultiCheckLevel2,FMultiCheckDate2,FMultiCheckLevel3,FMultiCheckDate3,FMultiCheckLevel4,FMultiCheckDate4,FMultiCheckLevel5,FMultiCheckDate5,FMultiCheckLevel6,FMultiCheckDate6,FConfirmDate,FInHighLimit,FAuxInHighLimitQty,FInLowLimit,FAuxInLowLimitQty,FGMPBatchNo,               FMrpLockFlag,FChangeTimes,FCloseDate)
	values(          @fidentify,    @frunid,       @InterId,@BillNo,0,    85,       0,            @fdate    ,0,      11077,55,         @FCostObjID,@fbominterid,0         ,@fsourceid,0,        @FItemId,@funitid,@fqty,  @FPlanCommitDate,@FPlanCommitDate,'',  @fdate,     @fuserid, @FOrgSaleInterID, 0,             @FOrgPPOInterID, 1054, @forgentryid,  0,            0,          @fplanorderinterid,0,          0,      NULL,             NULL	,           NULL	,         NULL	,          NULL	,            NULL,            NULL,            	NULL,            NULL,             NULL	           ,NULL	,         NULL	      ,  @fdate,      0,	       1000000,           0,          @fqty,            isnull(@fsourceBillNo,''), 0,           0,           NULL	)

	--exec My_P_AddOrEditPPBom @fuserid,@InterId --非成品的投料单由用户点下达生成

	--update icmo set Fstatus=1,FConfirmerID=@fuserid , FConfirmDate=@fdate , FConveyerID=@fuserid , FCommitDate=@fdate where finterid=@InterId
	update icmo set Fstatus=5,FConfirmerID=@fuserid , FConfirmDate=@fdate where finterid=@InterId

	DECLARE SeorderEntry_Cursor CURSOR FOR
	select t5.fneeddate,t5.fneedqty
	from my_t_mrpresultdetail t5 
	where t5.frunid=@frunid and t5.fitemid=@fitemid and t5.fneedqty>0
	order by t5.fneeddate

	OPEN SeorderEntry_Cursor

	FETCH NEXT FROM SeorderEntry_Cursor 
	INTO @fplandate,@fplanqty

	WHILE @@FETCH_STATUS = 0 and @fqty>0  --
	BEGIN
		if @fplanqty>=@fqty  --
		begin
			set @fplanqty=@fqty
			set @fqty=0
		end
		else
		begin
			set @fqty=@fqty-@fplanqty
		end	
		
		--insert into my_t_scheduledetail (fbillerid, fsourcetrantype, ficmointerid,funitid, fitemid, fdeptid,   fdate,     fqty,     fnote)
		--						  values(@fuserid,  85,              @InterId,    @funitid,@fitemid,@fsourceid,@fplandate,@fplanqty,'')

		FETCH NEXT FROM SeorderEntry_Cursor 
		INTO @fplandate,@fplanqty
	end

	--if @fqty>0 
	--begin
	--	if exists(select 1 from my_t_scheduledetail where ficmointerid=@InterId and fdate=@fplandate)
	--	begin
	--		update t1 set fqty=t1.fqty+@fqty from my_t_scheduledetail t1 where ficmointerid=@InterId and fdate=@fplandate
	--	end
	--	else
	--	begin
	--		insert into my_t_scheduledetail (fbillerid, fsourcetrantype, ficmointerid,funitid, fitemid, fdeptid,   fdate,     fqty, fnote)
	--								  values(@fuserid,  85,              @InterId,    @funitid,@fitemid,@fsourceid,@fplandate,@fqty,'')			
	--	end
	--end

	CLOSE SeorderEntry_Cursor
	DEALLOCATE SeorderEntry_Cursor

	set @entryid=@entryid+1

	FETCH NEXT FROM authors_cursor 
	INTO @fsourcetrantype,@fcostobjid,@fitemid,@funitid,@fqty,@fplancommitdate,@fsourceid,@fplanorderinterid,@fbominterid,@forderinterid,@forgentryid
END

CLOSE authors_cursor
DEALLOCATE authors_cursor

ALTER  TABLE  seorder  ENABLE  TRIGGER  My_Tri_SEOrder 

--单据编号自定义的

set @fendBillNo=@BillNo

set nocount off

GO



--MRP计算生成采购申请单--*****
--My_p_GeneratePORequestByMrp 16394,1,0
IF EXISTS (select * from sysobjects where name='My_p_GeneratePORequestByMrp' and xtype='p')  drop  procedure My_p_GeneratePORequestByMrp

go

create procedure [dbo].My_p_GeneratePORequestByMrp (@fuserid int ,@frunid int,@FBegBillNo varchar(40) output,@FEndBillNo varchar(40) output,@fidentify int output)

as
SET NOCOUNT ON

--declare @fbout varchar(20),@iuserid int ,@frunid int,@fcommitdate datetime  select @fbout='215',@iuserid=16482,@frunid=2155,@fcommitdate='2010-06-17'

declare @fplanprice decimal(18,4),@fitemid int,@fpitemid int,@funitid int,@entryid int,@fqty int
declare @BillNo varchar (20),@FStockId int,@StockNumber varchar (20)
DECLARE @TmpID INT ,@fsupplyid int,@fcurrencyid int,@FMyPoInStockInterId int
declare @fsupplyno varchar(20),@forderdate datetime,@FValueAddRate decimal(28, 2)
declare @iLength int,@FPrice decimal(28, 5),@FAmount decimal(20, 2),@FExchangeRate decimal(28, 10)
declare @FTaxPrice decimal(28, 5),@FTaxAmount decimal(20, 2),@SupplyId int
declare @fprojectval  varchar(200),@fspid int,@fempid int,@fdeptid int
declare @FDateFormat  varchar(200),@fdate datetime,@InterID int
declare @fsourceNumber varchar(200),@fpSourceNumber varchar(200),@fpXxSourceNumber varchar(200)
declare @fXxOldSourceNumber varchar(200),@empid int,@fcommitdate datetime
declare @FDCStockID int,@xx_FItemIDOld int,@fxxitemid int
declare @FDCSPID int,@forderinterid int,@forderentryid int
declare @fsourceInterid int,@fsourceEntryid int,@fsourceBillNo varchar (100)
declare @fyear int,@fperiod int,@FMangerID int,@fcustid int
declare @fresultbillno varchar (800),@fsebillno varchar(50),@fbillerid int
declare @ftempbillno varchar(50),@fremark varchar(500),@fpoitemtype varchar(50)
--AIS20041229163526   AIS20080129143619

select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期

select @fresultbillno='', @fyear=2009,@fperiod=1,@fresultbillno='',@FMangerID=0 --19787

select @fidentify=isnull(max(fid),0)+1 from my_t_identify
insert into my_t_identify(fid,fuserid,fdate,FTrantypeID) values(@fidentify,@fuserid,getdate(),70)

select t1.fitemid,t1.fqty,t2.funitid,t2.fnumber fitemnumber,0 fsupplyid,t6.fempid,t1.fneeddate,
0 fcurrencyid,t6.fdeptid,cast(''as varchar(10)) fsebillno,0 fcustid,--isnull(t10.fname,'') fitemtype,
--case when t10.fitemid=13626 then 16413 else 16423 end fbillerid
@fuserid fbillerid
into #data
from my_t_MrpResultSum t1 
inner join t_icitem t2 on t1.fitemid=t2.fitemid
--left join t_currency t3 on t3.fcurrencyid=t1.fcurrencyid
left join t_emp t4 on t4.fitemid=t1.fempid 
left join t_supplier t5 on t5.fitemid=t2.fsource
inner join my_t_mrp t6 on t6.frunid=t1.frunid
--left join my_t_MrpSeOrder t7 on t6.frunid=t7.frunid and t7.fselect=1
--left join seorder t8 on t8.finterid=t7.forderinterid
--left join t_item t10 on t10.fitemid=t2.f_115 and t10.fitemclassid=3002 and t10.fitemid<>0
where t2.ferpclsid=1 and t1.FQty>0 and t1.fselect=1
and t1.frunid=@frunid --and t1.fisdelete=0


DECLARE icbom_cursor CURSOR FOR	

select distinct fsupplyid,fempid,fcurrencyid,fdeptid,fsebillno,fcustid,fbillerid --,fitemtype
from #data

OPEN icbom_cursor

FETCH NEXT FROM icbom_cursor 
INTO @fsupplyid,@fempid,@FCurrencyID,@FDeptID,@fsebillno,@fcustid,@fbillerid--,@fitemtype

WHILE @@FETCH_STATUS = 0
BEGIN 
	exec GetICMaxNum 'POrequest', @InterID output

	-- 10.4
	Update t_BillCodeRule Set FReChar = FReChar Where FBillTypeID =70

	SET @TmpID = (SELECT FID FROM t_BillCodeRule WITH(READUNCOMMITTED) WHERE fbilltypeid=70 and fprojectid=3)

	update t_billcoderule set fprojectval = fprojectval+1,flength=case when (flength-len(fprojectval)) >= 0 then flength else len(fprojectval) end where FID =  @TmpID 
	Update ICBillNo Set FCurNo = (select top 1 isnull(fprojectval,1) from t_billcoderule where fprojectid = 3 and fbilltypeid =70) where fbillid = 70
	   
	--长度和目前编码
	select @fprojectval=(fprojectval-1),@iLength=flength from t_BillCodeRule where fprojectid = 3 and fbilltypeid = 70
	  
	-- 前缀
	select @BillNo=fprojectval+left('0000000000',@iLength-(len(@fprojectval)))+@fprojectval from t_BillCodeRule where fprojectid = 1 and fbilltypeid = 70  --@iLength
    
	DECLARE authors_cursor CURSOR FOR	

	--select t1.fitemid,t1.fsupplyno,t1.fsupplyid,t1.FExchangeRate,t1.FValueAddRate,t1.funitid,t1.fqty,t1.fprice,t1.famount,t1.ftaxprice,t1.ftaxamount from #mydate t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid where t2.ferpclsid=1 and t1.fsupplyid=@fsupplyid and t1.FCurrencyID=@FCurrencyID order by t2.fhelpcode

	select fneeddate,fitemid,funitid,fqty 
	from #data --where fitemtype=@fitemtype 
	order by fitemnumber

    set @entryid=1

	OPEN authors_cursor

	FETCH NEXT FROM authors_cursor 
	INTO @fcommitdate,@fitemid,@funitid,@fqty

	WHILE @@FETCH_STATUS = 0
	BEGIN 
		--FAPurchTime 建议采购日期
		INSERT INTO POrequestEntry(FInterID,FEntryID,FBrNo,FItemID, FAuxPropID,FQty, FUnitID, Fauxqty,FSecCoefficient,FSecQty,FAPurchTime, Fuse,FSupplyID,FFetchTime, FPlanOrderInterID,FSourceBillNo,FSourceTranType,FSourceInterId,FSourceEntryID,FMrpLockFlag) 
		VALUES (                   @InterId,@EntryId,'0',  @FItemId,0,         @fqty,@funitid,@fqty,  0,              0,      @fcommitdate,'',  0,       @fcommitdate,0,                '',           0,              0,             0,             0)

		set @entryid=@entryid+1

		FETCH NEXT FROM authors_cursor 
		INTO @fcommitdate,@fitemid,@funitid,@fqty
	END

	CLOSE authors_cursor
	DEALLOCATE authors_cursor

	INSERT INTO POrequest(FHeadSelfP0127,FInterID,FBillNo,FBrNo,FTranType,FCancellation,FStatus,Fdate, FDeptID, Fnote,FRequesterID,FCheckTime,FBillerID,  FMRP,FMultiCheckLevel1,FMultiCheckDate1,FMultiCheckLevel2,FMultiCheckDate2,FMultiCheckLevel3,FMultiCheckDate3,FMultiCheckLevel4,FMultiCheckDate4,FMultiCheckLevel5,FMultiCheckDate5,FMultiCheckLevel6,FMultiCheckDate6,FSelTranType) 
	VALUES (              @frunid,       @InterId,@BillNo,'0',  70,       0,            0,      @fdate,@fdeptid,'',   @fempid,     Null,      @fbillerid, 0,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,0)

    EXEC p_UpdateBillRelateData 70,@interid

	set @fresultbillno=@fresultbillno+@billno

	FETCH NEXT FROM icbom_cursor 
    INTO @fsupplyid,@fempid,@FCurrencyID,@FDeptID,@fsebillno,@fcustid,@fbillerid--,@fitemtype

END

CLOSE icbom_cursor
DEALLOCATE icbom_cursor

set nocount off

GO


--产品预测后生成采购申请单

IF EXISTS (select * from sysobjects where name='My_p_GeneratePORequestByPP' and xtype='p')  drop  procedure My_p_GeneratePORequestByPP

go


create procedure [dbo].My_p_GeneratePORequestByPP (@fuserid int ,@fordertype int,@InterID int output)

as
SET NOCOUNT ON

--declare @fbout varchar(20),@iuserid int ,@frunid int,@fcommitdate datetime  select @fbout='215',@iuserid=16482,@frunid=2155,@fcommitdate='2010-06-17'

declare @fplanprice decimal(18,4),@fitemid int,@fpitemid int,@funitid int,@entryid int,@fqty int
declare @BillNo varchar (20),@FStockId int,@StockNumber varchar (20)
DECLARE @TmpID INT ,@fsupplyid int,@fcurrencyid int,@FMyPoInStockInterId int
declare @fsupplyno varchar(20),@forderdate datetime,@FValueAddRate decimal(28, 2)
declare @iLength int,@FPrice decimal(28, 5),@FAmount decimal(20, 2),@FExchangeRate decimal(28, 10)
declare @FTaxPrice decimal(28, 5),@FTaxAmount decimal(20, 2),@SupplyId int
declare @fprojectval  varchar(200),@fspid int,@fempid int,@fdeptid int
declare @FDateFormat  varchar(200),@fdate datetime,@fcommitdate datetime
declare @fsourceNumber varchar(200),@fpSourceNumber varchar(200),@fpXxSourceNumber varchar(200)
declare @fXxOldSourceNumber varchar(200),@empid int
declare @FDCStockID int,@xx_FItemIDOld int,@fxxitemid int
declare @FDCSPID int,@forderinterid int,@forderentryid int
declare @fsourceInterid int,@fsourceEntryid int,@fsourceBillNo varchar (100)
declare @fyear int,@fperiod int,@FMangerID int,@fcustid int
declare @fresultbillno varchar (800),@fsebillno varchar(50),@fbillerid int
declare @ftempbillno varchar(50),@fremark varchar(500),@fpoitemtype varchar(50)
--AIS20041229163526   AIS20080129143619

select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期
select @forderdate=@fdate,@fcommitdate=@fdate  --'2009-06-15' --下单日期
--set @fcommitdate='2009-07-15' --到货日期


set @fresultbillno=''
--set @fempid=19784  --select fname,* from t_department where fname like '%%'


set @fdeptid=28427

set @fyear=2009
set @fperiod=1

--set @fuserid=16454  
set @fresultbillno=''
set @FMangerID=0 --19787

select t1.fitemid,t1.fqty,t9.fnumber fharfitemnumber,t2.fnumber fitemnumber,0 fsupplyid,0 fcurrencyid,cast(''as varchar(10)) fsebillno,0 fcustid,--isnull(t10.fname,'') fpoitemtype,
--case when t10.fitemid=13626 then 16413 else 16423 end fbillerid
@fuserid fbillerid,t2.funitid
into #data
from (select fharfproductid,fitemid,sum(fqty) fqty from My_t_ICItemTempByPP where fuserid=@fuserid group by fharfproductid,fitemid) t1 
inner join t_icitem t2 on t1.fitemid=t2.fitemid
left join t_icitem t9 on t1.fharfproductid=t9.fitemid
--left join t_currency t3 on t3.fcurrencyid=t1.fcurrencyid
--left join t_emp t4 on t4.fitemid=t1.fempid 
--left join t_supplier t5 on t5.fitemid=t1.fsupplyid
--inner join my_t_mrp t6 on t6.frunid=t1.frunid
--left join my_t_MrpSeOrder t7 on t6.frunid=t7.frunid and t7.fselect=1
--left join seorder t8 on t8.finterid=t7.forderinterid
--left join t_item t10 on t10.fitemid=t2.f_115 and t10.fitemclassid=3002 and t10.fitemid<>0
where t2.ferpclsid=1 and t1.FQty>0 
order by t9.fnumber,t2.fnumber

--周中明	222  物控部	166

DECLARE icbom_cursor CURSOR FOR	

select distinct fsupplyid,222 fempid,fcurrencyid,@fdeptid fdeptid,fsebillno,fcustid,fbillerid from #data

OPEN icbom_cursor

FETCH NEXT FROM icbom_cursor 
INTO @fsupplyid,@fempid,@FCurrencyID,@FDeptID,@fsebillno,@fcustid,@fbillerid--,@fpoitemtype

WHILE @@FETCH_STATUS = 0
BEGIN 
	exec GetICMaxNum 'POrequest', @InterID output

	-- 10.4
	Update t_BillCodeRule Set FReChar = FReChar Where FBillTypeID =70

	SET @TmpID = (SELECT FID FROM t_BillCodeRule WITH(READUNCOMMITTED) WHERE fbilltypeid=70 and fprojectid=3)

	update t_billcoderule set fprojectval = fprojectval+1,flength=case when (flength-len(fprojectval)) >= 0 then flength else len(fprojectval) end where FID =  @TmpID 
	Update ICBillNo Set FCurNo = (select top 1 isnull(fprojectval,1) from t_billcoderule where fprojectid = 3 and fbilltypeid =70) where fbillid = 70
	   
	--长度和目前编码
	select @fprojectval=(fprojectval-1),@iLength=flength from t_BillCodeRule where fprojectid = 3 and fbilltypeid = 70
	  
	-- 前缀
	select @BillNo=fprojectval+left('0000000000',@iLength-(len(@fprojectval)))+@fprojectval from t_BillCodeRule where fprojectid = 1 and fbilltypeid = 70  --@iLength
    
	DECLARE authors_cursor CURSOR FOR	

	--select t1.fitemid,t1.fsupplyno,t1.fsupplyid,t1.FExchangeRate,t1.FValueAddRate,t1.funitid,t1.fqty,t1.fprice,t1.famount,t1.ftaxprice,t1.ftaxamount from #mydate t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid where t2.ferpclsid=1 and t1.fsupplyid=@fsupplyid and t1.FCurrencyID=@FCurrencyID order by t2.fhelpcode

	select fitemid,funitid,fqty 
	from #data --where fpoitemtype=@fpoitemtype 
	order by fharfitemnumber,fitemnumber

    set @entryid=1

	OPEN authors_cursor

	FETCH NEXT FROM authors_cursor 
	INTO @fitemid,@funitid,@fqty

	WHILE @@FETCH_STATUS = 0
	BEGIN 
		--FAPurchTime 建议采购日期
		INSERT INTO POrequestEntry(FInterID,FEntryID,FBrNo,FItemID, FAuxPropID,FQty, FUnitID, Fauxqty,FSecCoefficient,FSecQty,FAPurchTime, Fuse,FSupplyID,FFetchTime, FPlanOrderInterID,FSourceBillNo,FSourceTranType,FSourceInterId,FSourceEntryID,FMrpLockFlag) 
		VALUES (                   @InterId,@EntryId,'0',  @FItemId,0,         @fqty,@funitid,@fqty,  0,              0,      @fcommitdate,'',  0,       @fcommitdate,0,                '',           0,              0,             0,             0)

		set @entryid=@entryid+1

		FETCH NEXT FROM authors_cursor 
		INTO @fitemid,@funitid,@fqty
	END

	CLOSE authors_cursor
	DEALLOCATE authors_cursor

	INSERT INTO POrequest(FInterID,FBillNo,FBrNo,FTranType,FCancellation,FStatus,Fdate, FDeptID, Fnote,FRequesterID,FCheckTime,FBillerID,  FMRP,FMultiCheckLevel1,FMultiCheckDate1,FMultiCheckLevel2,FMultiCheckDate2,FMultiCheckLevel3,FMultiCheckDate3,FMultiCheckLevel4,FMultiCheckDate4,FMultiCheckLevel5,FMultiCheckDate5,FMultiCheckLevel6,FMultiCheckDate6,FSelTranType) 
	VALUES (              @InterId,@BillNo,'0',  70,       0,            0,      @fdate,@fdeptid,'',   @fempid,     Null,      @fbillerid, 0,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,0)

    EXEC p_UpdateBillRelateData 70,@interid

	set @fresultbillno=@fresultbillno+@billno

	FETCH NEXT FROM icbom_cursor 
    INTO @fsupplyid,@fempid,@FCurrencyID,@FDeptID,@fsebillno,@fcustid,@fbillerid--,@fpoitemtype

END

CLOSE icbom_cursor
DEALLOCATE icbom_cursor

set nocount off

GO


--生成预测订单

IF EXISTS (select * from sysobjects where name='My_p_GeneratePPOrder' and xtype='p')  drop  procedure My_p_GeneratePPOrder

go


create procedure [dbo].My_p_GeneratePPOrder (@fuserid int ,@frunid int,@fcommitdate datetime,@InterID int output)

as
SET NOCOUNT ON

--declare @fbout varchar(20),@iuserid int ,@frunid int,@fcommitdate datetime  select @fbout='215',@iuserid=16482,@frunid=2155,@fcommitdate='2010-06-17'

declare @fplanprice decimal(18,4),@fitemid int,@fpitemid int,@funitid int,@entryid int,@fqty int
declare @BillNo varchar (20),@FStockId int,@StockNumber varchar (20)
DECLARE @TmpID INT ,@fsupplyid int,@fcurrencyid int,@FMyPoInStockInterId int
declare @fsupplyno varchar(20),@forderdate datetime,@FValueAddRate decimal(28, 2)
declare @iLength int,@FPrice decimal(28, 5),@FAmount decimal(20, 2),@FExchangeRate decimal(28, 10)
declare @FTaxPrice decimal(28, 5),@FTaxAmount decimal(20, 2),@SupplyId int
declare @fprojectval  varchar(200),@fspid int,@fempid int,@fdeptid int
declare @FDateFormat  varchar(200),@fdate datetime
declare @fsourceNumber varchar(200),@fpSourceNumber varchar(200),@fpXxSourceNumber varchar(200)
declare @fXxOldSourceNumber varchar(200),@empid int
declare @FDCStockID int,@xx_FItemIDOld int,@fxxitemid int
declare @FDCSPID int,@forderinterid int,@forderentryid int
declare @fsourceInterid int,@fsourceEntryid int,@fsourceBillNo varchar (100)
declare @fyear int,@fperiod int,@FMangerID int,@fcustid int
declare @fresultbillno varchar (800),@fsebillno varchar(50),@fbillerid int
declare @ftempbillno varchar(50),@fremark varchar(500),@fpoitemtype varchar(50)
--AIS20041229163526   AIS20080129143619

select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期
set @forderdate=@fdate  --'2009-06-15' --下单日期
--set @fcommitdate='2009-07-15' --到货日期

set @fresultbillno=''
--set @fempid=19784  --select fname,* from t_emp where fname like '%%'
--set @fdeptid=19781

set @fyear=2009
set @fperiod=1

--set @fuserid=16454  
set @fresultbillno=''
set @FMangerID=0 --19787


select t1.fitemid,t1.fqty,t2.funitid,t2.fnumber fitemnumber,0 fsupplyid,t6.fempid,0 fcurrencyid,t6.fdeptid,cast(''as varchar(10)) fsebillno,0 fcustid,--isnull(t10.fname,'') fpoitemtype,
--case when t10.fitemid=13626 then 16413 else 16423 end fbillerid
16394 fbillerid
into #data
from my_t_MrpResultDetail t1 
inner join t_icitem t2 on t1.fitemid=t2.fitemid
--left join t_currency t3 on t3.fcurrencyid=t1.fcurrencyid
left join t_emp t4 on t4.fitemid=t1.fempid 
--left join t_supplier t5 on t5.fitemid=t1.fsupplyid
inner join my_t_mrp t6 on t6.frunid=t1.frunid
--left join my_t_MrpSeOrder t7 on t6.frunid=t7.frunid and t7.fselect=1
--left join seorder t8 on t8.finterid=t7.forderinterid
--left join t_item t10 on t10.fitemid=t2.f_115 and t10.fitemclassid=3002 and t10.fitemid<>0
where t2.ferpclsid=2 and t1.FQty>0 and t1.fselect=1
and t1.frunid=@frunid and t1.fisdelete=0

DECLARE icbom_cursor CURSOR FOR	

select distinct fsupplyid,fempid,fcurrencyid,fdeptid,fsebillno,fcustid,fbillerid from #data

OPEN icbom_cursor

FETCH NEXT FROM icbom_cursor 
INTO @fsupplyid,@fempid,@FCurrencyID,@FDeptID,@fsebillno,@fcustid,@fbillerid--,@fpoitemtype

WHILE @@FETCH_STATUS = 0
BEGIN 
	exec GetICMaxNum 'PPOrder', @InterID output

	-- 10.4
	Update t_BillCodeRule Set FReChar = FReChar Where FBillTypeID =87

	SET @TmpID = (SELECT FID FROM t_BillCodeRule WITH(READUNCOMMITTED) WHERE fbilltypeid=87 and fprojectid=3)

	update t_billcoderule set fprojectval = fprojectval+1,flength=case when (flength-len(fprojectval)) >= 0 then flength else len(fprojectval) end where FID =  @TmpID 
	Update ICBillNo Set FCurNo = (select top 1 isnull(fprojectval,1) from t_billcoderule where fprojectid = 3 and fbilltypeid =87) where fbillid = 87
	   
	--长度和目前编码
	select @fprojectval=(fprojectval-1),@iLength=flength from t_BillCodeRule where fprojectid = 3 and fbilltypeid = 87
	  
	-- 前缀
	select @BillNo=fprojectval+left('0000000000',@iLength-(len(@fprojectval)))+@fprojectval from t_BillCodeRule where fprojectid = 1 and fbilltypeid = 87  --@iLength
    
	DECLARE authors_cursor CURSOR FOR	

	--select t1.fitemid,t1.fsupplyno,t1.fsupplyid,t1.FExchangeRate,t1.FValueAddRate,t1.funitid,t1.fqty,t1.fprice,t1.famount,t1.ftaxprice,t1.ftaxamount from #mydate t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid where t2.ferpclsid=1 and t1.fsupplyid=@fsupplyid and t1.FCurrencyID=@FCurrencyID order by t2.fhelpcode

	select fitemid,funitid,fqty 
	from #data --where fpoitemtype=@fpoitemtype 
	order by fitemnumber

    set @entryid=1

	OPEN authors_cursor

	FETCH NEXT FROM authors_cursor 
	INTO @fitemid,@funitid,@fqty

	WHILE @@FETCH_STATUS = 0
	BEGIN 
		INSERT INTO PPOrderEntry (FInterID,FEntryID,FBrNo,FSourceEntryID,FCustID,FItemID, FQty, FSelQty,FSaleQty,FUnitID, FAuxQty,FAuxSelQty,FAuxSaleQty,FNeedDate,   FNeedDateEnd,FSplitCycleID,FBomInterID,FNote,FMrpLockFlag) 
		VALUES (                 @InterId, @EntryId,'0',  0,             0,      @FItemId,@fqty,0,      0,       @funitid,@fqty,  0,         0,          @fcommitdate,@fcommitdate,11030,        0,          '',   0) 

		set @entryid=@entryid+1

		FETCH NEXT FROM authors_cursor 
		INTO @fitemid,@funitid,@fqty
	END

	CLOSE authors_cursor
	DEALLOCATE authors_cursor

	INSERT INTO PPOrder(FHeadSelfY0120,FInterID,FBillNo,FBrNo,FTranType,FCancellation,FStatus,FDate, FCheckDate,FBillerID,FMultiCheckLevel1,FMultiCheckLevel2,FMultiCheckLevel3,FMultiCheckLevel4,FMultiCheckLevel5,FMultiCheckLevel6,FMultiCheckDate1,FMultiCheckDate2,FMultiCheckDate3,FMultiCheckDate4,FMultiCheckDate5,FMultiCheckDate6) 
	VALUES (            @frunid,       @InterId,@BillNo,'0',  87,       0,            0,      @fdate,Null,      @fbillerid,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null)

    EXEC p_UpdateBillRelateData 87,@interid

	set @fresultbillno=@fresultbillno+@billno

	FETCH NEXT FROM icbom_cursor 
    INTO @fsupplyid,@fempid,@FCurrencyID,@FDeptID,@fsebillno,@fcustid,@fbillerid--,@fpoitemtype
END

CLOSE icbom_cursor
DEALLOCATE icbom_cursor

drop table #data

set nocount off

GO


IF not EXISTS (select * from sysobjects where name='My_t_ICItemTemp' and xtype='u')  --drop  Table My_t_ICItemTemp
begin
	create table My_t_ICItemTemp(fuserid int,fitemid int,fqty decimal(24,2)) 
end

go

IF not EXISTS (select t1.id
from sysobjects t1 
inner join syscolumns t2 on t1.id=t2.id
where t1.name='My_t_ICItemTemp' and t1.xtype='u' and t2.name='findex')
begin
	alter table My_t_ICItemTemp add findex int default 0
	alter table My_t_ICItemTemp add FRelatedID int default 0
	alter table My_t_ICItemTemp add FSubID int default 0
	alter table My_t_ICItemTemp add fnumber varchar(50) default ''
end

go

IF not EXISTS (select * from sysobjects where name='My_t_ICItemTempByPP' and xtype='u')  --drop  Table My_t_ICItemTempByPP
begin
	create table My_t_ICItemTempByPP(fuserid int,fharfproductid int,fitemid int,fqty decimal(24,2)) 
end

go


--通过销售订单模拟后生成预测订单--
IF EXISTS (select * from sysobjects where name='My_p_GeneratePPOrderBySEOrder' and xtype='p')  drop  procedure My_p_GeneratePPOrderBySEOrder

go


create procedure [dbo].My_p_GeneratePPOrderBySEOrder (@fuserid int,@fordertype int,@InterID int output)--@fordertype 0 非专利 1 专利  

as
SET NOCOUNT ON

--declare @fbout varchar(20),@iuserid int ,@frunid int,@fcommitdate datetime  select @fbout='215',@iuserid=16482,@frunid=2155,@fcommitdate='2010-06-17'

declare @fplanprice decimal(18,4),@fitemid int,@fpitemid int,@funitid int,@entryid int,@fqty int
declare @BillNo varchar (20),@FStockId int,@StockNumber varchar (20)
DECLARE @TmpID INT ,@fsupplyid int,@fcurrencyid int,@FMyPoInStockInterId int
declare @fsupplyno varchar(20),@forderdate datetime,@FValueAddRate decimal(28, 2)
declare @iLength int,@FPrice decimal(28, 5),@FAmount decimal(20, 2),@FExchangeRate decimal(28, 10)
declare @FTaxPrice decimal(28, 5),@FTaxAmount decimal(20, 2),@SupplyId int
declare @fprojectval  varchar(200),@fspid int,@fempid int,@fdeptid int
declare @FDateFormat  varchar(200),@fdate datetime,@fcommitdate datetime
declare @fsourceNumber varchar(200),@fpSourceNumber varchar(200),@fpXxSourceNumber varchar(200)
declare @fXxOldSourceNumber varchar(200),@empid int
declare @FDCStockID int,@xx_FItemIDOld int,@fxxitemid int
declare @FDCSPID int,@forderinterid int,@forderentryid int
declare @fsourceInterid int,@fsourceEntryid int,@fsourceBillNo varchar (100)
declare @fyear int,@fperiod int,@FMangerID int,@fcustid int
declare @fresultbillno varchar (800),@fsebillno varchar(50),@fbillerid int
declare @ftempbillno varchar(50),@fremark varchar(500),@fpoitemtype varchar(50)
--AIS20041229163526   AIS20080129143619

select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期
select @forderdate=@fdate,@fcommitdate =@fdate --'2009-06-15' --下单日期
--set @fcommitdate='2009-07-15' --到货日期

set @fresultbillno=''
--set @fempid=19784  --select fname,* from t_department where fname like '%%'

--专利制造室	28426
--制造室	22358

if @fordertype=0
  set @fdeptid=22358
else
  set @fdeptid=28426

set @fyear=2009
set @fperiod=1

--set @fuserid=16454  
set @fresultbillno=''
set @FMangerID=0 --19787


select t1.fitemid,t1.fqty,t2.funitid,t2.fnumber fitemnumber,0 fsupplyid,0 fempid,0 fcurrencyid,
@fdeptid fdeptid,cast(''as varchar(10)) fsebillno,0 fcustid,--isnull(t10.fname,'') fpoitemtype,
--case when t10.fitemid=13626 then 16413 else 16423 end fbillerid
16394 fbillerid
into #data
from (select fitemid,sum(fqty) fqty from My_t_ICItemTemp where fuserid=@fuserid group by fitemid) t1 
inner join t_icitem t2 on t1.fitemid=t2.fitemid
--left join t_currency t3 on t3.fcurrencyid=t1.fcurrencyid
--left join t_emp t4 on t4.fitemid=t1.fempid 
--left join t_supplier t5 on t5.fitemid=t1.fsupplyid
--left join my_t_MrpSeOrder t7 on t6.frunid=t7.frunid and t7.fselect=1
--left join seorder t8 on t8.finterid=t7.forderinterid
--left join t_item t10 on t10.fitemid=t2.f_115 and t10.fitemclassid=3002 and t10.fitemid<>0
where t2.ferpclsid=2 

DECLARE icbom_cursor CURSOR FOR	

select distinct fsupplyid,fempid,fcurrencyid,fdeptid,fsebillno,fcustid,fbillerid from #data

OPEN icbom_cursor

FETCH NEXT FROM icbom_cursor 
INTO @fsupplyid,@fempid,@FCurrencyID,@FDeptID,@fsebillno,@fcustid,@fbillerid--,@fpoitemtype

WHILE @@FETCH_STATUS = 0
BEGIN 
	exec GetICMaxNum 'PPOrder', @InterID output

	-- 10.4
	Update t_BillCodeRule Set FReChar = FReChar Where FBillTypeID =87

	SET @TmpID = (SELECT FID FROM t_BillCodeRule WITH(READUNCOMMITTED) WHERE fbilltypeid=87 and fprojectid=3)

	update t_billcoderule set fprojectval = fprojectval+1,flength=case when (flength-len(fprojectval)) >= 0 then flength else len(fprojectval) end where FID =  @TmpID 
	Update ICBillNo Set FCurNo = (select top 1 isnull(fprojectval,1) from t_billcoderule where fprojectid = 3 and fbilltypeid =87) where fbillid = 87
	   
	--长度和目前编码
	select @fprojectval=(fprojectval-1),@iLength=flength from t_BillCodeRule where fprojectid = 3 and fbilltypeid = 87
	  
	-- 前缀
	select @BillNo=fprojectval+left('0000000000',@iLength-(len(@fprojectval)))+@fprojectval from t_BillCodeRule where fprojectid = 1 and fbilltypeid = 87  --@iLength
    
	DECLARE authors_cursor CURSOR FOR	

	--select t1.fitemid,t1.fsupplyno,t1.fsupplyid,t1.FExchangeRate,t1.FValueAddRate,t1.funitid,t1.fqty,t1.fprice,t1.famount,t1.ftaxprice,t1.ftaxamount from #mydate t1 inner join t_icitem t2 on t1.fitemid=t2.fitemid where t2.ferpclsid=1 and t1.fsupplyid=@fsupplyid and t1.FCurrencyID=@FCurrencyID order by t2.fhelpcode

	select fitemid,funitid,fqty 
	from #data --where fpoitemtype=@fpoitemtype 
	order by fitemnumber

    set @entryid=1

	OPEN authors_cursor

	FETCH NEXT FROM authors_cursor 
	INTO @fitemid,@funitid,@fqty

	WHILE @@FETCH_STATUS = 0
	BEGIN 
		INSERT INTO PPOrderEntry (FInterID,FEntryID,FBrNo,FSourceEntryID,FCustID,FItemID, FQty, FSelQty,FSaleQty,FUnitID, FAuxQty,FAuxSelQty,FAuxSaleQty,FNeedDate,   FNeedDateEnd,FSplitCycleID,FBomInterID,FNote,FMrpLockFlag) 
		VALUES (                 @InterId, @EntryId,'0',  0,             0,      @FItemId,@fqty,0,      0,       @funitid,@fqty,  0,         0,          @fcommitdate,@fcommitdate,11030,        0,          '',   0) 

		set @entryid=@entryid+1

		FETCH NEXT FROM authors_cursor 
		INTO @fitemid,@funitid,@fqty
	END

	CLOSE authors_cursor
	DEALLOCATE authors_cursor

	INSERT INTO PPOrder(FHeadSelfY0120,FInterID,FBillNo,FBrNo,FTranType,FCancellation,FStatus,FDate, FCheckDate,FBillerID,FMultiCheckLevel1,FMultiCheckLevel2,FMultiCheckLevel3,FMultiCheckLevel4,FMultiCheckLevel5,FMultiCheckLevel6,FMultiCheckDate1,FMultiCheckDate2,FMultiCheckDate3,FMultiCheckDate4,FMultiCheckDate5,FMultiCheckDate6) 
	VALUES (            0,             @InterId,@BillNo,'0',  87,       0,            0,      @fdate,Null,      @fbillerid,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null,Null)

    EXEC p_UpdateBillRelateData 87,@interid

	set @fresultbillno=@fresultbillno+@billno

	FETCH NEXT FROM icbom_cursor 
    INTO @fsupplyid,@fempid,@FCurrencyID,@FDeptID,@fsebillno,@fcustid,@fbillerid--,@fpoitemtype

END

CLOSE icbom_cursor
DEALLOCATE icbom_cursor

drop table #data

set nocount off

GO


--虚仓出入库表触发器--新增、更新
IF EXISTS (select * from sysobjects where name='My_Tri_ZPStockBill_In'  and xtype='TR')  drop  TRIGGER My_Tri_ZPStockBill_In
go

Create TRIGGER My_Tri_ZPStockBill_In
            ON ZPStockBill
for update

AS
BEGIN
	SET NOCOUNT ON
	declare @iMaxIndex int,@FInterID int, @FMyInterID int ,@s varchar(200),@fcurrencyid int,@fcheckerid int
	declare @fbillno varchar(30),@ftrantype int ,@frob int,@fdate datetime,@ftoday datetime

	select top 1 @frob=frob,@ftrantype=ftrantype,@fcheckerid=isnull(fcheckerid,0),
	@fbillno=fbillno,@FInterID=FInterID,@fdate=fdate,@ftoday=replace(convert(varchar(10),getdate(),111),'/','-') from INSERTED 
		
	IF @ftrantype=26     
	BEGIN
		if update(fcheckerid) and @fcheckerid>0  --审核
		begin
			--更新投料单已领数--因为K3自带功能是不能反写的--也可以调用My_p_UpdateBillRelateData_24_26,但此方法性能快一点
			update t1 set fstockqty=t1.fstockqty+isnull(t2.fqty,0),fauxstockqty=t1.fauxstockqty+isnull(t2.fqty,0)
			from PPBOMEntry t1 --
			inner join 
			(
				select t1.FEntrySelfZOU30 ficmointerid,t1.FEntrySelfZOU31 fppbomentryid,t1.fitemid,sum(t1.fqty) fqty
				from ZPStockBillEntry t1
				inner join icmo t3 on t3.finterid=t1.ficmointerid
				where t1.finterid=@finterid and t1.fsourcetrantype in (85,200000014)
				group by t1.FEntrySelfZOU30,t1.FEntrySelfZOU31,t1.fitemid

			) t2 on t1.ficmointerid=t2.ficmointerid and t1.FEntryID=t2.fppbomentryid and t1.fitemid=t2.fitemid
		end
		if update(fcheckerid) and @fcheckerid<=0  --反审核--更新计划投料单已关联数--也可以调用My_p_UpdateBillRelateData_24_26,但此方法性能快一点
		begin
--			update t1 set fcommitqty=t1.fcommitqty-isnull(t2.fqty,0),FNoOutStockQty=t1.FNoOutStockQty+isnull(t2.fqty,0)
--			from t_BOSPlanChangeStockEntry t1 --
--			inner join 
--			(
--				select t2.forderinterid,t2.fsourceentryid,t1.fitemid,sum(t1.fqty) fqty
--				from ZPStockBillEntry t1 
--				inner join icmo t2 on t1.FSourceInterId=t2.finterid
--				where t1.finterid=@finterid and t2.forderinterid<>0 and t1.fsourcetrantype=85
--				group by t2.forderinterid,t2.fsourceentryid,t1.fitemid
--			) t2 on t1.FID_SRC=t2.forderinterid and t1.FEntryID_SRC=t2.fsourceentryid and t1.fitemid=t2.fitemid	

			--更新投料单已领数--因为K3自带功能是不能反写的--也可以调用My_p_UpdateBillRelateData_24_26,但此方法性能快一点
			update t1 set fstockqty=t1.fstockqty-isnull(t2.fqty,0),fauxstockqty=t1.fauxstockqty-isnull(t2.fqty,0)
			from PPBOMEntry t1 --
			inner join 
			(
				select t1.FEntrySelfZOU30 ficmointerid,t1.FEntrySelfZOU31 fppbomentryid,t1.fitemid,sum(t1.fqty) fqty
				from ZPStockBillEntry t1
				inner join icmo t3 on t3.finterid=t1.ficmointerid
				where t1.finterid=@finterid and t1.fsourcetrantype in (85,200000014)
				group by t1.FEntrySelfZOU30,t1.FEntrySelfZOU31,t1.fitemid
			) t2 on t1.ficmointerid=t2.ficmointerid and t1.FEntryID=t2.fppbomentryid and t1.fitemid=t2.fitemid
		end 
	end
end

go


IF EXISTS (select * from sysobjects where name='My_Tri_ZPStockBill'  and xtype='TR')  drop  TRIGGER My_Tri_ZPStockBill
go

Create TRIGGER [dbo].[My_Tri_ZPStockBill]
            ON [dbo].[ZPStockBill]
after insert

AS
BEGIN
	SET NOCOUNT ON
	declare @iMaxIndex int
	declare @FInterID int  
	declare @FMyInterID int ,@s varchar(200)
	declare @fcurrencyid int
	declare @fbillno varchar(30)
	declare @ftrantype int ,@frob int
	declare @fdate datetime,@ftoday datetime
	declare @fcheck_fail int
	declare @fsrccommitfield_prevalue decimal(28,13)
	declare @fsrccommitfield_endvalue decimal(28,13)
	declare @maxorder int 

	select top 1 @frob=frob,@ftrantype=ftrantype,
	@fbillno=fbillno,@FInterID=FInterID,@fdate=fdate,@ftoday=replace(convert(varchar(10),getdate(),111),'/','-') from INSERTED 
		
	IF @ftrantype=6  --
	BEGIN
		--先加
		update src set @fsrccommitfield_prevalue=src.FEntrySelfP0336,
			 @fsrccommitfield_endvalue=@fsrccommitfield_prevalue+dest.fauxqty,
			 @fcheck_fail=case isnull(@maxorder,0) when 1 then 0 else (case when (1=1) then @fcheck_fail else -1 end) end,
			 src.FEntrySelfP0336=@fsrccommitfield_endvalue
		 from poinstockentry src 
			 inner join poinstock srchead on src.finterid=srchead.finterid
			 inner join 
		 (select u1.fsourceinterid as fsourceinterid,u1.fsourceentryid,u1.fitemid,sum(u1.fauxqty) as fauxqty
		 from  zpstockbillentry u1 
		 where u1.finterid=@finterid
		 group by u1.fsourceinterid,u1.fsourceentryid,u1.fitemid) dest 
		 on dest.fsourceinterid = src.finterid
		 and dest.fitemid = src.fitemid
		 and src.fentryid = dest.fsourceentryid

		--反写收料通知单单据状态和关闭标识
		UPDATE T1 SET T1.FStatus=(
		CASE WHEN NOT EXISTS (SELECT 1 FROM poinstockentry WHERE FInterID=T1.FInterID AND (FCommitQty+isnull(FEntrySelfP0336,0))<>0) THEN 1    --还没有关联数则状态是审核
			 WHEN NOT EXISTS (SELECT 1 FROM poinstockentry WHERE FInterID=T1.FInterID AND FQty>(FCommitQty+isnull(FEntrySelfP0336,0))) THEN 3  --全部都关联完成则状态为关闭
		ELSE 2 END),
		T1.FCLOSED=(CASE WHEN NOT EXISTS (SELECT 1 FROM poinstockentry WHERE FInterID=T1.FInterID AND FQty>(FCommitQty+isnull(FEntrySelfP0336,0))) THEN 1 ELSE 0 END)
		FROM POInStock T1
		inner join ZPStockBillEntry T2 on T1.FInterID = T2.FSourceInterID
		inner join inserted t3 on t2.finterid=t3.finterid
		WHERE t3.ftrantype=6  --T3.FInterID=@finterid and 

		--再减
		update src set @fsrccommitfield_prevalue=src.FEntrySelfP0336,
			 @fsrccommitfield_endvalue=@fsrccommitfield_prevalue-dest.fauxqty,
			 @fcheck_fail=case isnull(@maxorder,0) when 1 then 0 else (case when (1=1) then @fcheck_fail else -1 end) end,
			 src.FEntrySelfP0336=@fsrccommitfield_endvalue
		 from poinstockentry src 
			 inner join poinstock srchead on src.finterid=srchead.finterid
			 inner join 
		 (select u1.fsourceinterid as fsourceinterid,u1.fsourceentryid,u1.fitemid,sum(u1.fauxqty) as fauxqty
		 from  zpstockbillentry u1 
		 where u1.finterid=@finterid
		 group by u1.fsourceinterid,u1.fsourceentryid,u1.fitemid) dest 
		 on dest.fsourceinterid = src.finterid
		 and dest.fitemid = src.fitemid
		 and src.fentryid = dest.fsourceentryid

		--反写采购订单的入库数量
		IF EXISTS(SELECT 1 FROM ZPStockBillEntry t1 inner join poinstockentry t2 on t1.fsourceinterid=t2.finterid and t1.fsourceentryid=t2.fentryid inner join poorderentry t3 on t3.finterid=t2.forderinterid and t3.fentryid=t2.forderentryid WHERE t1.FInterID=@FInterID)
		begin
			UPDATE u1
			SET u1.FStockQty=u1.FStockQty+1*Cast(u2.FStockQty as Float)
			 ,u1.FSecStockQty=u1.FSecStockQty+1*Cast(u2.FSecStockQty as Float)
			 ,u1.FAuxStockQty=ROUND((u1.FStockQty+1*Cast(u2.FStockQty as Float))/Cast(t3.FCoefficient as Float),t1.FQtyDecimal)
			FROM POOrderEntry u1 
			INNER JOIN 
			(
				SELECT t2.FOrderInterID,t2.FOrderEntryID,t2.FItemID,SUM(t1.FQty)AS FStockQty,SUM(t1.FAuxQty) AS FAuxStockQty,SUM(t1.FSecQty) AS FSecStockQty
				FROM ZPStockBillEntry t1 
				inner join poinstockentry t2 on t1.fsourceinterid=t2.finterid and t1.fsourceentryid=t2.fentryid 
				WHERE t1.FInterID=@FInterID
				GROUP BY t2.FOrderInterID,t2.FOrderEntryID,t2.FItemID
			) u2 ON u1.FInterID=u2.FOrderInterID AND u1.FEntryID=u2.FOrderEntryID AND u1.FItemID=u2.FItemID
			INNER JOIN t_ICItem t1 ON u1.FItemID=t1.FItemID 
			INNER JOIN t_MeasureUnit t3 ON u1.FUnitID=t3.FItemID
		end

		--反写采购订单的行业务关闭标识
		UPDATE p1 
		SET p1.FMrpClosed=CASE WHEN ISNULL(p1.FMRPAutoClosed,1)=1 THEN (CASE WHEN p1.FStockQty<p1.FQty THEN 0 ELSE 1 END) ELSE p1.FMrpClosed END
		FROM POOrderEntry p1 
		INNER JOIN poinstockentry u1 ON u1.FOrderInterID=p1.FInterID AND u1.FOrderEntryID=p1.FEntryID
		inner join ZPStockBillEntry t1 on t1.fsourceinterid=u1.finterid and t1.fsourceentryid=u1.fentryid 
		WHERE t1.FInterID=@FInterID
	end

	IF @ftrantype=26 
	BEGIN
--		update t1 set ficmointerid=t1.fsourceinterid,fppbomentryid=t1.fsourceentryid --不能这样写，因为关联退补料的单据fsourceinterid和ficmointerid是不一样的，而ficmointerid在保存时会不见
--		from ZPStockBillEntry t1--
--		inner join inserted t2 on t1.finterid=t2.finterid
--		where t0.ftrantype=26 and t1.fsourcetrantype in (85,200000014)

--		if exists (select 1 from zpstockbillentry t1 inner join INSERTED t2 on t1.finterid=t2.finterid 
--		where isnull(t1.fsourceinterid,0)=0 and t2.fdate>'2013-03-20')
--		begin
--			RAISERROR('生产领料必须关联单据生成!',18,18)
--		end
--
--		if exists (select 1 from zpstockbillentry t1 inner join INSERTED t2 on t1.finterid=t2.finterid 
--		where cast(t1.fqty as decimal(24,2))>cast(t1.fqtymust as decimal(24,2)) and t2.fdate>'2013-03-20' and t1.fqty>0)
--		begin
--			RAISERROR('实发数不能大于申请数!',18,18)
--		end

		--/*
		--更新投料单选单数量
		update t1 set fqty=isnull(t2.fqty,0),fauxqty=isnull(t2.fqty,0)  --与My_P_GenerateOutStock24的写法不一样
		from PPBOMEntry t1 --
		inner join 
		(
			select t1.FEntrySelfZOU30 ficmointerid,t1.FEntrySelfZOU31 fppbomentryid,t1.fitemid,sum(t1.fqty) fqty
			from ZPStockBill t0 --
			inner join ZPStockBillEntry t1 on t0.finterid=t1.finterid  --
			inner join 
			(	  
				select distinct t1.FEntrySelfZOU30 ficmointerid 
				from ZPStockBillEntry t1--
				inner join inserted t2 on t1.finterid=t2.finterid
				--where t1.finterid=@FInterID
			) t2 on t1.FEntrySelfZOU30=t2.ficmointerid
			inner join icmo t3 on t3.finterid=t1.FEntrySelfZOU30
			where t0.ftrantype=26 and t1.fsourcetrantype in (85,200000014)
			group by t1.FEntrySelfZOU30,t1.FEntrySelfZOU31,t1.fitemid
		) t2 on t1.ficmointerid=t2.ficmointerid and t1.FEntryID=t2.fppbomentryid and t1.fitemid=t2.fitemid

		--*/
		--先加
		update src set @fsrccommitfield_prevalue=src.FEntrySelfS0233,
			 @fsrccommitfield_endvalue=@fsrccommitfield_prevalue+dest.fauxqty,
			 @fcheck_fail=case isnull(@maxorder,0) when 1 then 0 else (case when (1=1) then @fcheck_fail else -1 end) end,
			 src.FEntrySelfS0233=@fsrccommitfield_endvalue
		 from seoutstockentry src 
			 inner join seoutstock srchead on src.finterid=srchead.finterid
			 inner join 
		 (select u1.fsourceinterid as fsourceinterid,u1.fsourceentryid,u1.fitemid,sum(u1.fauxqty) as fauxqty
		 from  zpstockbillentry u1 
		 where u1.finterid=@finterid
		 group by u1.fsourceinterid,u1.fsourceentryid,u1.fitemid) dest 
		 on dest.fsourceinterid = src.finterid
		 and dest.fitemid = src.fitemid
		 and src.fentryid = dest.fsourceentryid

		--反写发货通知单单据状态和关闭标识
		UPDATE T1 SET T1.FStatus=(
		CASE WHEN NOT EXISTS (SELECT 1 FROM SEOutStockEntry WHERE FInterID=T1.FInterID AND (FCommitQty+isnull(FEntrySelfS0233,0))<>0) THEN 1    --还没有关联数则状态是审核
			 WHEN NOT EXISTS (SELECT 1 FROM SEOutStockEntry WHERE FInterID=T1.FInterID AND FQty>(FCommitQty+isnull(FEntrySelfS0233,0))) THEN 3  --全部都关联完成则状态为关闭
		ELSE 2 END),
		T1.FCLOSED=(CASE WHEN NOT EXISTS (SELECT 1 FROM SEOutStockEntry WHERE FInterID=T1.FInterID AND FQty>(FCommitQty+isnull(FEntrySelfS0233,0))) THEN 1 ELSE 0 END)
		FROM SEOutStock T1
		inner join ZPStockBillEntry T2 on T1.FInterID = T2.FSourceInterID
		inner join inserted t3 on t2.finterid=t3.finterid
		WHERE t3.ftrantype=26 --T3.FInterID=@finterid and 

		--再减
		update src set @fsrccommitfield_prevalue=src.FEntrySelfS0233,
			 @fsrccommitfield_endvalue=@fsrccommitfield_prevalue-dest.fauxqty,
			 @fcheck_fail=case isnull(@maxorder,0) when 1 then 0 else (case when (1=1) then @fcheck_fail else -1 end) end,
			 src.FEntrySelfS0233=@fsrccommitfield_endvalue
		 from seoutstockentry src 
			 inner join seoutstock srchead on src.finterid=srchead.finterid
			 inner join 
		 (select u1.fsourceinterid as fsourceinterid,u1.fsourceentryid,u1.fitemid,sum(u1.fauxqty) as fauxqty
		 from  zpstockbillentry u1 
		 where u1.finterid=@finterid
		 group by u1.fsourceinterid,u1.fsourceentryid,u1.fitemid) dest 
		 on dest.fsourceinterid = src.finterid
		 and dest.fitemid = src.fitemid
		 and src.fentryid = dest.fsourceentryid

		--反写销售订单的出库数量
		IF EXISTS(SELECT 1 FROM ZPStockBillEntry t1 inner join seoutstockentry t2 on t1.fsourceinterid=t2.finterid and t1.fsourceentryid=t2.fentryid inner join seorderentry t3 on t3.finterid=t2.forderinterid and t3.fentryid=t2.forderentryid WHERE t1.FInterID=@FInterID)
		begin
			UPDATE u1
			SET u1.FStockQty=u1.FStockQty+1*Cast(u2.FStockQty as Float)
			 ,u1.FSecStockQty=u1.FSecStockQty+1*Cast(u2.FSecStockQty as Float)
			 ,u1.FAuxStockQty=ROUND((u1.FStockQty+1*Cast(u2.FStockQty as Float))/Cast(t3.FCoefficient as Float),t1.FQtyDecimal)
			FROM SEOrderEntry u1 
			INNER JOIN 
			(
				SELECT t2.FOrderInterID,t2.FOrderEntryID,t2.FItemID,SUM(t1.FQty)AS FStockQty,SUM(t1.FAuxQty) AS FAuxStockQty,SUM(t1.FSecQty) AS FSecStockQty
				FROM ZPStockBillEntry t1 
				inner join seoutstockentry t2 on t1.fsourceinterid=t2.finterid and t1.fsourceentryid=t2.fentryid 
				WHERE t1.FInterID=@FInterID
				GROUP BY t2.FOrderInterID,t2.FOrderEntryID,t2.FItemID
			) u2 ON u1.FInterID=u2.FOrderInterID AND u1.FEntryID=u2.FOrderEntryID AND u1.FItemID=u2.FItemID
			INNER JOIN t_ICItem t1 ON u1.FItemID=t1.FItemID 
			INNER JOIN t_MeasureUnit t3 ON u1.FUnitID=t3.FItemID
		end

		--反写销售订单的行业务关闭标识
		UPDATE p1 
		SET p1.FMrpClosed=CASE WHEN ISNULL(p1.FMRPAutoClosed,1)=1 THEN (CASE WHEN p1.FStockQty<p1.FQty THEN 0 ELSE 1 END) ELSE p1.FMrpClosed END
		FROM SEOrderEntry p1 
		INNER JOIN seoutstockentry u1 ON u1.FOrderInterID=p1.FInterID AND u1.FOrderEntryID=p1.FEntryID
		inner join ZPStockBillEntry t1 on t1.fsourceinterid=u1.finterid and t1.fsourceentryid=u1.fentryid 
		WHERE t1.FInterID=@FInterID
	end
end

go

--虚仓出入库自带触发器
IF EXISTS (select * from sysobjects where name='ZPStockBill_DEL'  and xtype='TR')  drop  TRIGGER ZPStockBill_DEL
go

Create TRIGGER [dbo].[ZPStockBill_DEL]
            ON [dbo].[ZPStockBill]
FOR DELETE
AS
	SET NOCOUNT ON
	declare @iMaxIndex int
	declare @FInterID int  
	declare @FMyInterID int ,@s varchar(200)
	declare @fcurrencyid int
	declare @fbillno varchar(30)
	declare @ftrantype int ,@frob int
	declare @fdate datetime,@ftoday datetime
	declare @fcheck_fail int
	declare @fsrccommitfield_prevalue decimal(28,13)
	declare @fsrccommitfield_endvalue decimal(28,13)
	declare @maxorder int 

	select top 1 @frob=frob,@ftrantype=ftrantype,
	@fbillno=fbillno,@FInterID=FInterID,@fdate=fdate,@ftoday=replace(convert(varchar(10),getdate(),111),'/','-') from deleted 
		
    IF EXISTS ( SELECT 1 FROM deleted WHERE FCheckerID <> 0)
    BEGIN
        ROLLBACK TRAN
        RAISERROR('不能删除已经审核的单据!',18,18)
    END
    ELSE IF EXISTS ( SELECT 1 FROM deleted WHERE FCancellation = 1)
    BEGIN
        ROLLBACK TRAN
        RAISERROR('不能删除已经作废的单据!',18,18)
    END
    ELSE
	begin
		IF @ftrantype=6  --虚仓入库
		BEGIN
			--先减
			update src set @fsrccommitfield_prevalue=src.FEntrySelfP0336,
				 @fsrccommitfield_endvalue=@fsrccommitfield_prevalue-dest.fauxqty,
				 @fcheck_fail=case isnull(@maxorder,0) when 1 then 0 else (case when (1=1) then @fcheck_fail else -1 end) end,
				 src.FEntrySelfP0336=@fsrccommitfield_endvalue
			 from poinstockentry src 
				 inner join poinstock srchead on src.finterid=srchead.finterid
				 inner join 
			 (select u1.fsourceinterid as fsourceinterid,u1.fsourceentryid,u1.fitemid,sum(u1.fauxqty) as fauxqty
			 from  zpstockbillentry u1 
			 where u1.finterid=@finterid
			 group by u1.fsourceinterid,u1.fsourceentryid,u1.fitemid) dest 
			 on dest.fsourceinterid = src.finterid
			 and dest.fitemid = src.fitemid
			 and src.fentryid = dest.fsourceentryid
			

			--反写收料通知单单据状态和关闭标识
			UPDATE T1 SET T1.FStatus=(
			CASE WHEN NOT EXISTS (SELECT 1 FROM poinstockentry WHERE FInterID=T1.FInterID AND (FCommitQty+isnull(FEntrySelfP0336,0))<>0) THEN 1    --还没有关联数则状态是审核
				 WHEN NOT EXISTS (SELECT 1 FROM poinstockentry WHERE FInterID=T1.FInterID AND FQty>(FCommitQty+isnull(FEntrySelfP0336,0))) THEN 3  --全部都关联完成则状态为关闭
			ELSE 2 END),
			T1.FCLOSED=(CASE WHEN NOT EXISTS (SELECT 1 FROM poinstockentry WHERE FInterID=T1.FInterID AND FQty>(FCommitQty+isnull(FEntrySelfP0336,0))) THEN 1 ELSE 0 END)
			FROM POInStock T1
			inner join ZPStockBillEntry T2 on T1.FInterID = T2.FSourceInterID
			inner join deleted t3 on t2.finterid=t3.finterid
			WHERE T3.FInterID=@finterid and t3.ftrantype=6

			--再加
			update src set @fsrccommitfield_prevalue=src.FEntrySelfP0336,
				 @fsrccommitfield_endvalue=@fsrccommitfield_prevalue+dest.fauxqty,
				 @fcheck_fail=case isnull(@maxorder,0) when 1 then 0 else (case when (1=1) then @fcheck_fail else -1 end) end,
				 src.FEntrySelfP0336=@fsrccommitfield_endvalue
			 from poinstockentry src 
				 inner join poinstock srchead on src.finterid=srchead.finterid
				 inner join 
			 (select u1.fsourceinterid as fsourceinterid,u1.fsourceentryid,u1.fitemid,sum(u1.fauxqty) as fauxqty
			 from  zpstockbillentry u1 
			 where u1.finterid=@finterid
			 group by u1.fsourceinterid,u1.fsourceentryid,u1.fitemid) dest 
			 on dest.fsourceinterid = src.finterid
			 and dest.fitemid = src.fitemid
			 and src.fentryid = dest.fsourceentryid

			--反写采购订单的入库数量
			IF EXISTS(SELECT 1 FROM ZPStockBillEntry t1 inner join poinstockentry t2 on t1.fsourceinterid=t2.finterid and t1.fsourceentryid=t2.fentryid inner join poorderentry t3 on t3.finterid=t2.forderinterid and t3.fentryid=t2.forderentryid WHERE t1.FInterID=@FInterID)
			begin
				UPDATE u1
				SET u1.FStockQty=u1.FStockQty-1*Cast(u2.FStockQty as Float)
				 ,u1.FSecStockQty=u1.FSecStockQty-1*Cast(u2.FSecStockQty as Float)
				 ,u1.FAuxStockQty=ROUND((u1.FStockQty-1*Cast(u2.FStockQty as Float))/Cast(t3.FCoefficient as Float),t1.FQtyDecimal)
				FROM POOrderEntry u1 
				INNER JOIN 
				(
					SELECT t2.FOrderInterID,t2.FOrderEntryID,t2.FItemID,SUM(t1.FQty)AS FStockQty,SUM(t1.FAuxQty) AS FAuxStockQty,SUM(t1.FSecQty) AS FSecStockQty
					FROM ZPStockBillEntry t1 
					inner join poinstockentry t2 on t1.fsourceinterid=t2.finterid and t1.fsourceentryid=t2.fentryid 
					WHERE t1.FInterID=@FInterID
					GROUP BY t2.FOrderInterID,t2.FOrderEntryID,t2.FItemID
				) u2 ON u1.FInterID=u2.FOrderInterID AND u1.FEntryID=u2.FOrderEntryID AND u1.FItemID=u2.FItemID
				INNER JOIN t_ICItem t1 ON u1.FItemID=t1.FItemID 
				INNER JOIN t_MeasureUnit t3 ON u1.FUnitID=t3.FItemID
			end

			--反写采购订单的行业务关闭标识
			UPDATE p1 
			SET p1.FMrpClosed=CASE WHEN ISNULL(p1.FMRPAutoClosed,1)=1 THEN (CASE WHEN p1.FStockQty<p1.FQty THEN 0 ELSE 1 END) ELSE p1.FMrpClosed END
			FROM POOrderEntry p1 
			INNER JOIN poinstockentry u1 ON u1.FOrderInterID=p1.FInterID AND u1.FOrderEntryID=p1.FEntryID
			inner join ZPStockBillEntry t1 on t1.fsourceinterid=u1.finterid and t1.fsourceentryid=u1.fentryid 
			WHERE t1.FInterID=@FInterID
		end


		IF @ftrantype=26  --虚仓出库--更新销售订单出库日期
		BEGIN
			--更新投料单已选数
			update t1 set fqty=t1.fqty-isnull(t2.fqty,0),fauxqty=t1.fauxqty-isnull(t2.fqty,0)
			from PPBOMEntry t1 --
			inner join 
			(
				select t1.FEntrySelfZOU30 ficmointerid,t1.FEntrySelfZOU31 fppbomentryid,t1.fitemid,sum(t1.fqty) fqty
				from ZPStockBillEntry t1
				inner join icmo t3 on t3.finterid=t1.FSourceInterId
				where t1.finterid=@finterid and t1.fsourcetrantype in (85,200000014)
				group by t1.FEntrySelfZOU30,t1.FEntrySelfZOU31,t1.fitemid
			) t2 on t1.ficmointerid=t2.ficmointerid and t1.FEntryID=t2.fppbomentryid and t1.fitemid=t2.fitemid

			--先减
			--/*
			update src set @fsrccommitfield_prevalue=src.FEntrySelfS0233,
				 @fsrccommitfield_endvalue=@fsrccommitfield_prevalue-dest.fauxqty,
				 @fcheck_fail=case isnull(@maxorder,0) when 1 then 0 else (case when (1=1) then @fcheck_fail else -1 end) end,
				 src.FEntrySelfS0233=@fsrccommitfield_endvalue
			 from seoutstockentry src 
				 inner join seoutstock srchead on src.finterid=srchead.finterid
				 inner join 
			 (select u1.fsourceinterid as fsourceinterid,u1.fsourceentryid,u1.fitemid,sum(u1.fauxqty) as fauxqty
			 from  zpstockbillentry u1 
			 where u1.finterid=@finterid
			 group by u1.fsourceinterid,u1.fsourceentryid,u1.fitemid) dest 
			 on dest.fsourceinterid = src.finterid
			 and dest.fitemid = src.fitemid
			 and src.fentryid = dest.fsourceentryid
			--*/

			--反写发货通知单单据状态和关闭标识
			UPDATE T1 SET T1.FStatus=(
			CASE WHEN NOT EXISTS (SELECT 1 FROM SEOutStockEntry WHERE FInterID=T1.FInterID AND (FCommitQty+isnull(FEntrySelfS0233,0))<>0) THEN 1    --还没有关联数则状态是审核
				 WHEN NOT EXISTS (SELECT 1 FROM SEOutStockEntry WHERE FInterID=T1.FInterID AND FQty>(FCommitQty+isnull(FEntrySelfS0233,0))) THEN 3  --全部都关联完成则状态为关闭
			ELSE 2 END),
			T1.FCLOSED=(CASE WHEN NOT EXISTS (SELECT 1 FROM SEOutStockEntry WHERE FInterID=T1.FInterID AND FQty>(FCommitQty+isnull(FEntrySelfS0233,0))) THEN 1 ELSE 0 END)
			FROM SEOutStock T1
			inner join ZPStockBillEntry T2 on T1.FInterID = T2.FSourceInterID
			inner join deleted t3 on t2.finterid=t3.finterid
			WHERE T3.FInterID=@finterid and t3.ftrantype=26

			--再加
			--/*
			update src set @fsrccommitfield_prevalue=src.FEntrySelfS0233,
				 @fsrccommitfield_endvalue=@fsrccommitfield_prevalue+dest.fauxqty,
				 @fcheck_fail=case isnull(@maxorder,0) when 1 then 0 else (case when (1=1) then @fcheck_fail else -1 end) end,
				 src.FEntrySelfS0233=@fsrccommitfield_endvalue
			 from seoutstockentry src 
				 inner join seoutstock srchead on src.finterid=srchead.finterid
				 inner join 
			 (select u1.fsourceinterid as fsourceinterid,u1.fsourceentryid,u1.fitemid,sum(u1.fauxqty) as fauxqty
			 from  zpstockbillentry u1 
			 where u1.finterid=@finterid
			 group by u1.fsourceinterid,u1.fsourceentryid,u1.fitemid) dest 
			 on dest.fsourceinterid = src.finterid
			 and dest.fitemid = src.fitemid
			 and src.fentryid = dest.fsourceentryid
			--*/

			--反写销售订单的出库数量
			IF EXISTS(SELECT 1 FROM ZPStockBillEntry t1 inner join seoutstockentry t2 on t1.fsourceinterid=t2.finterid and t1.fsourceentryid=t2.fentryid inner join seorderentry t3 on t3.finterid=t2.forderinterid and t3.fentryid=t2.forderentryid WHERE t1.FInterID=@FInterID)
			begin
				UPDATE u1
				SET u1.FStockQty=u1.FStockQty-1*Cast(u2.FStockQty as Float)
				 ,u1.FSecStockQty=u1.FSecStockQty-1*Cast(u2.FSecStockQty as Float)
				 ,u1.FAuxStockQty=ROUND((u1.FStockQty-1*Cast(u2.FStockQty as Float))/Cast(t3.FCoefficient as Float),t1.FQtyDecimal)
				FROM SEOrderEntry u1 
				INNER JOIN 
				(
					SELECT t2.FOrderInterID,t2.FOrderEntryID,t2.FItemID,SUM(t1.FQty)AS FStockQty,SUM(t1.FAuxQty) AS FAuxStockQty,SUM(t1.FSecQty) AS FSecStockQty
					FROM ZPStockBillEntry t1 
					inner join seoutstockentry t2 on t1.fsourceinterid=t2.finterid and t1.fsourceentryid=t2.fentryid 
					WHERE t1.FInterID=@FInterID
					GROUP BY t2.FOrderInterID,t2.FOrderEntryID,t2.FItemID
				) u2 ON u1.FInterID=u2.FOrderInterID AND u1.FEntryID=u2.FOrderEntryID AND u1.FItemID=u2.FItemID
				INNER JOIN t_ICItem t1 ON u1.FItemID=t1.FItemID 
				INNER JOIN t_MeasureUnit t3 ON u1.FUnitID=t3.FItemID
			end

			--反写销售订单的行业务关闭标识
			UPDATE p1 
			SET p1.FMrpClosed=CASE WHEN ISNULL(p1.FMRPAutoClosed,1)=1 THEN (CASE WHEN p1.FStockQty<p1.FQty THEN 0 ELSE 1 END) ELSE p1.FMrpClosed END
			FROM SEOrderEntry p1 
			INNER JOIN seoutstockentry u1 ON u1.FOrderInterID=p1.FInterID AND u1.FOrderEntryID=p1.FEntryID
			inner join ZPStockBillEntry t1 on t1.fsourceinterid=u1.finterid and t1.fsourceentryid=u1.fentryid 
			WHERE t1.FInterID=@FInterID
		end

        DELETE E
          FROM ZPStockBillEntry E
               INNER JOIN deleted D ON E.FInterID = D.FInterID
	end
go


IF not EXISTS (select * from sysobjects where name='my_t_backflushchangestock' and xtype='u')  --drop  Table my_t_backflushchangestock
begin
	CREATE TABLE [dbo].my_t_backflushchangestock(
		fuserid int,
		fitemid [int] NOT NULL,
		fdcstockid int, --调入仓库
		fscstockid int,  --调出仓库
		fqty decimal(24,2),
		fnote varchar(50)
	)
end

go

--My_p_GetSchedulePlan 16394

--生产计划横排--*****--只管当天和当天以后的数据--包装基本上是按照订单交期在排，意义不大
IF EXISTS (select * from sysobjects where name='My_p_GetSchedulePlan' and xtype='p')  drop  procedure My_p_GetSchedulePlan

go

create procedure My_p_GetSchedulePlan(@fuserid int)

as

set nocount on

declare @fdate datetime
declare @sqls varchar(8000),@sqls1 varchar(8000),@sqls2 varchar(8000),@sqls3 varchar(8000)
declare @i int,@iCount int,@iDifCount int,@j int
declare @fbegindate datetime,@fenddate datetime
declare @varDate datetime,@fpredate datetime
declare @varStrDate varchar(12),@varStrDateS varchar(8000),@varDifStrDate varchar(12)

select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')
select @fpredate=replace(convert(varchar(10),Dateadd(day,-1,getdate()),111),'/','-')

select @fbegindate=@fdate,@fenddate=Dateadd(day,30,@fbegindate)

create table #temp(ficmointerid int)

--订单已经关闭或者未回复交期的清掉
delete t9 
from icmo t1
inner join my_t_icmotemp t9 on t9.finterid=t1.finterid and t9.fuserid=@fuserid
inner join seorderentry t2 on t1.forderinterid=t2.finterid and t1.fsourceentryid=t2.fentryid
inner join seorder t3 on t2.finterid=t3.finterid
where --t3.fstatus=3 
t2.fmrpclosed=1
or t3.FHeadSelfS0148='1900-01-01'

--任务数与滚动计划数的平衡关系:任务数-当天以前的汇报数=当天和当天以后的计划数
-- select t1.finterid ficmointerid,0 fneedqty,isnull(t4.FQtyFinish,0) FQtyFinishToday,
-- isnull(t3.FQtyFinish,0) FQtyFinish,isnull(t5.FPreQtyFinish,0) FPreQtyFinish,
-- t1.fqty-isnull(t3.FQtyFinish,0)-isnull(t2.fplanqty,0) fdifqty
-- into #source
-- from icmo t1
-- inner join my_t_icmotemp t9 on t9.finterid=t1.finterid and t9.fuserid=@fuserid
-- left join 
-- (
-- 	select t1.fsourceinterid,sum(t1.FQtyFinish) FQtyFinish 
-- 	from ICMORptEntry t1 
-- 	inner join ICMORpt t2 on t1.finterid=t2.finterid
-- 	where t2.fheadselfj1112<@fdate and t2.fstatus>0
-- 	group by t1.fsourceinterid
-- ) t3 on t1.finterid=t3.fsourceinterid
-- left join 
-- (
-- 	select t1.fsourceinterid,sum(t1.FQtyFinish) FQtyFinish 
-- 	from ICMORptEntry t1 
-- 	inner join ICMORpt t2 on t1.finterid=t2.finterid
-- 	where t2.fheadselfj1112>=@fdate and t2.fstatus>0
-- 	group by t1.fsourceinterid
-- ) t4 on t1.finterid=t4.fsourceinterid
-- left join 
-- (
-- 	select ficmointerid,sum(fqty) fplanqty 
-- 	from my_t_scheduledetail 
-- 	where fsourcetrantype=85 and fdate>=@fdate
-- 	group by ficmointerid
-- ) t2 on t1.finterid=t2.ficmointerid 
-- left join 
-- (
-- 	select t1.fsourceinterid,sum(t1.FQtyFinish) FPreQtyFinish 
-- 	from ICMORptEntry t1 
-- 	inner join ICMORpt t2 on t1.finterid=t2.finterid
-- 	inner join 
-- 	(
-- 		select max(m2.fheadselfj1112) fpredate--,m1.fsourceinterid,
-- 		from ICMORptEntry m1 
-- 		inner join ICMORpt m2 on m1.finterid=m2.finterid
-- 		where m2.fheadselfj1112<@fdate /*不是<=*/ --and m2.fstatus>0  
-- 		--group by m1.fsourceinterid
-- 	) t3 on t2.fheadselfj1112=t3.fpredate --and t1.fsourceinterid=t3.fsourceinterid  
-- 	where t2.fstatus>0
-- 	group by t1.fsourceinterid
-- ) t5 on t1.finterid=t5.fsourceinterid 
-- where t1.fqty>isnull(t1.fstockqty,0) and t1.fstatus in (1,2,5) --未工的生产任务单
-- --and t1.fqty<>(isnull(t2.fplanqty,0)+isnull(t3.FQtyFinish,0))

select t9.findex,t1.finterid ficmointerid,0 fneedqty,
t1.fqty*isnull(y.fqty,1) fqty,--任务数
t1.fcommitqty*isnull(y.fqty,1) fcommitqty,--汇报数
(t1.fqty-t1.fcommitqty)*isnull(y.fqty,1) fnocommitqty,--未汇报数
t1.fstockqty*isnull(y.fqty,1) fstockqty,--入库数
isnull(t3.FQtyFinish,0)*isnull(y.fqty,1) FQtyFinish,--本日之前汇报数
isnull(t4.FQtyFinish,0)*isnull(y.fqty,1) FQtyFinishToday,--本日汇报数
isnull(t21.ftodayplanqty,0) FTodayPlanQty,--本日排产数
isnull(t32.FSumBeforeTodayPlanQty,0) FSumBeforeTodayPlanQty,--本日之前排产数
isnull(t5.FPreQtyFinish,0)*isnull(y.fqty,1) FPreQtyFinish,--上一工作日汇报数
isnull(t12.FPrePlanQty,0) FPrePlanQty,--上一工作日排产数
--t1.fqty*isnull(y.fqty,1)-isnull(t3.FQtyFinish,0)*isnull(y.fqty,1)-isnull(t2.fplanqty,0) fdifqty --未排数
t1.fqty*isnull(y.fqty,1)-isnull(t22.fsumplanqty,0) fdifqty --未排数
into #source
from icmo t1
inner join my_t_icmotemp t9 on t9.finterid=t1.finterid and t9.fuserid=@fuserid
left join 
(
	select c.fitemid,isnull(sum(isnull(b.fqty,1)),1)  as fqty
	from icbom a inner join icbomchild b on a.finterid=b.finterid
						inner join t_icitem c on a.fitemid=c.fitemid
						inner join t_icitem d on b.fitemid=d.fitemid
	where left(d.fnumber,1) in ('3','4','5','7','8')
	group by c.fitemid
) y on t1.fitemid=y.fitemid
left join 
(
	select ficmointerid,sum(fqty) fplanqty 
	from my_t_scheduledetail 
	where fsourcetrantype=85 and fdate>=@fdate
	group by ficmointerid
) t2 on t1.finterid=t2.ficmointerid
left join 
(
	select ficmointerid,sum(fqty) fsumplanqty 
	from my_t_scheduledetail 
	where fsourcetrantype=85 --and fdate>=@fdate
	group by ficmointerid
) t22 on t1.finterid=t22.ficmointerid
left join 
(
	select ficmointerid,sum(fqty) fsumbeforetodayplanqty 
	from my_t_scheduledetail 
	where fsourcetrantype=85 and fdate<@fdate
	group by ficmointerid
) t32 on t1.finterid=t32.ficmointerid
left join 
(
	select ficmointerid,sum(fqty) ftodayplanqty 
	from my_t_scheduledetail 
	where fsourcetrantype=85 and fdate=@fdate
	group by ficmointerid
) t21 on t1.finterid=t21.ficmointerid
left join 
(
	select t1.ficmointerid fsourceinterid,sum(t1.fqty) FPrePlanQty
	from my_t_scheduledetail t1 
	inner join 
	(
		select max(m1.fdate) fpredate,m1.ficmointerid
		from my_t_scheduledetail m1 
		where m1.fdate<@fdate and m1.fsourcetrantype=85 /*不是<=*/ --and m2.fstatus>0  
		group by m1.ficmointerid
	) t3 on t1.fdate=t3.fpredate and t1.ficmointerid=t3.ficmointerid  
	where t1.fsourcetrantype=85 --and t4.forderinterid=0 --t2.fstatus>0
	group by t1.ficmointerid
) t12 on t1.finterid=t12.fsourceinterid 
left join 
(
	select t1.ficmointerid fsourceinterid,sum(t1.fqty) FQtyFinish 
	from icstockbillentry t1 
	inner join icstockbill t2 on t1.finterid=t2.finterid
	inner join icmo t3 on t3.finterid=t1.ficmointerid
	where t2.fdate<@fdate and t2.ftrantype=2 --and t3.forderinterid=0 --and t2.fstatus>0
	group by t1.ficmointerid
) t3 on t1.finterid=t3.fsourceinterid
left join 
(
	select t1.ficmointerid fsourceinterid,sum(t1.fqty) FQtyFinish 
	from icstockbillentry t1 
	inner join icstockbill t2 on t1.finterid=t2.finterid
	inner join icmo t3 on t3.finterid=t1.ficmointerid
	where t2.fdate>=@fdate and t2.ftrantype=2 --and t3.forderinterid=0 --and t2.fstatus>0
	group by t1.ficmointerid
) t4 on t1.finterid=t4.fsourceinterid
left join 
(
	select t1.ficmointerid fsourceinterid,sum(t1.fqty) FPreQtyFinish 
	from icstockbillentry t1 
	inner join icstockbill t2 on t1.finterid=t2.finterid
	inner join icmo t4 on t4.finterid=t1.ficmointerid
	inner join 
	(
		select max(m2.fdate) fpredate,m1.fsourceinterid
		from icstockbillentry m1 
		inner join icstockbill m2 on m1.finterid=m2.finterid
		where m2.fdate<@fdate and m2.ftrantype=2 /*不是<=*/ --and m2.fstatus>0  
		group by m1.fsourceinterid
	) t3 on t2.fdate=t3.fpredate and t4.finterid=t3.fsourceinterid  
	where t2.ftrantype=2 --and t4.forderinterid=0 --t2.fstatus>0
	group by t1.ficmointerid
) t5 on t1.finterid=t5.fsourceinterid 
where t1.fqty>isnull(t1.fstockqty,0) and t1.fstatus in (1,2,5) --未工的生产任务单
--and t1.fqty<>(isnull(t2.fplanqty,0)+isnull(t3.FQtyFinish,0))

select t2.ficmointerid,isnull(t1.fdate,'2100-01-01') fdate,isnull(t1.fqty,0) fqty
into #data
from #source t2
left join my_t_scheduledetail t1 on t1.ficmointerid=t2.ficmointerid

--创建表
set @sqls=''

set @i=0

select @iCount=Datediff(day,@fbegindate,@fenddate)

while @i<=@iCount
begin
  set @varStrDate=replace(convert(varchar(10),Dateadd(day,@i,@fbegindate),111),'/','-')
  set @sqls=@sqls+'alter table #temp add ['+@varStrDate+'] decimal(24,4) default 0 '
  set @i=@i+1
end 

--print @sqls

execute (@sqls)   

--先计算出物料在计划期间每天的需求数---------------------------------------------------------------

set @sqls1='select ficmointerid,'

set @i=0

select @iCount=Datediff(day,@fbegindate,@fenddate)

while @i<=@iCount
begin
  set @varStrDate=replace(convert(varchar(10),Dateadd(day,@i,@fbegindate),111),'/','-')
  set @sqls1=@sqls1+'(case when fdate='+''''+@varStrDate +''''+ ' then fqty else 0 end) '+''''+@varStrDate+''''+','
  set @i=@i+1
end 

set @sqls1=substring(@sqls1,1,len(@sqls1)-1)
set @sqls1=@sqls1+' from #data '  

--print @sqls1

--execute (@sqls1)  --结合下面的SQL执行 

--汇总-------------------------------------------------------------------
set @sqls='insert into #temp select t1.ficmointerid,' 

set @i=0

select @iCount=Datediff(day,@fbegindate,@fenddate)

while @i<=@iCount
begin
  set @varStrDate=replace(convert(varchar(10),Dateadd(day,@i,@fbegindate),111),'/','-')
  set @sqls=@sqls+'sum(['+@varStrDate +']) '+''''+@varStrDate+''''+','
  set @i=@i+1
end 

set @sqls=substring(@sqls,1,len(@sqls)-1)
set @sqls=@sqls+' from ('+@sqls1+') t1  group by t1.ficmointerid '  

--print @sqls

execute (@sqls)   --先计算出物料在计划期间每天的需求数


select cast(0 as bit) 选择,isnull(t4.fentryid,0) 源单行号,t2.finterid 任务单内码,isnull(t7.fname,'') 生产车间,t4.fdate 订单交期,
isnull(t5.fheadselfs0143,'') 源采购订单号,isnull(t5.fheadselfs0144,'') 源销售订单号,isnull(t5.fbillno,'') 订单编号,
t2.fbillno 任务单号,
(case when t2.fstatus=0 then '计划' when t2.fstatus in (1,2) then '下达' when t2.fstatus=5 then '确认' when t2.fstatus=3 then '结案' end) 任务单状态,
isnull(t7.fitemid,0) 生产车间内码,t2.fitemid 产品内码,
t3.fnumber 产品编码,t3.fname 名称,t3.fmodel 规格型号,t3.funitid 单位内码,
(case when isnull(t5.FHeadSelfS0149,'')<>'' and isnull(t2.fnote,'')<>'' then isnull(t2.fnote,'')+'/////'+isnull(t5.FHeadSelfS0149,'') else isnull(t2.fnote,'')+isnull(t5.FHeadSelfS0149,'') end) 备注,
isnull(t4.fqty,0) 订单数,
--t2.FQty*isnull(y.fqty,1) 任务纯PCS数,
t8.fqty 任务数,
isnull(t8.fdifqty,0) 未排数,--未排数=任务数-累计汇报数-(当天+当天以后)的排产数
t8.fcommitqty 汇报数,t8.fnocommitqty 未汇报数,t8.fstockqty 入库数,--isnull(t8.fscheqty,0) 已排数,
--(case when t2.forderinterid<>0 then t2.fcommitqty else 0 end) 汇报数,
--t2.FQtyFinish 汇报数,t2.fqty-t2.FQtyFinish 未汇报数,
isnull(t8.FQtyFinish,0) 本日之前汇报数,
isnull(t8.FSumBeforeTodayPlanQty,0) 本日之前排产数,
--isnull(t8.FPreQtyFinish,0) 上一工作日汇报数,
--isnull(t8.FPrePlanQty,0) 上一工作日排产数,
isnull(t8.FQtyFinishToday,0) 本日汇报数,
--isnull(t8.FTodayPlanQty,0) 本日排产数,
--(isnull(t8.FPreQtyFinish,0)+isnull(t8.FQtyFinishToday,0)-isnull(t8.FPrePlanQty,0)-isnull(t8.FTodayPlanQty,0)) 差异数,
(isnull(t8.FQtyFinish,0)-isnull(t8.FSumBeforeTodayPlanQty,0)) 差异数,
isnull(t2.FHeadSelfJ0186,'') 摘要,
t1.*
from icmo t2
inner join #temp t1 on t1.ficmointerid=t2.finterid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
left join seorderentry t4 on t4.finterid=t2.forderinterid and t4.fentryid=t2.fsourceentryid
left join seorder t5 on t4.finterid=t5.finterid
inner join t_measureunit t6 on t6.fitemid=t3.funitid
left join t_department t7 on t7.fitemid=t2.fworkshop
inner join #source t8 on t8.ficmointerid=t2.finterid
--inner join my_t_icmotemp t9 on t9.finterid=t2.finterid
--left join 
--(
--	select c.fitemid,isnull(sum(isnull(b.fqty,1)),1)  as fqty
--	from icbom a inner join icbomchild b on a.finterid=b.finterid
--						inner join t_icitem c on a.fitemid=c.fitemid
--						inner join t_icitem d on b.fitemid=d.fitemid
--	where left(d.fnumber,1) in ('3','4','5','7','8')
--	group by c.fitemid
--) y on t2.fitemid=y.fitemid
where (t2.fqty-t2.fcommitqty)>0 --t9.fuserid=@fuserid and 
order by t8.findex,t7.fname,t3.fnumber

--select * from #temp  select * from #data  select * from #difdata

drop table #temp 
drop table #data
drop table #source

go


--收料计划横排--*****
--exec My_p_GetPOInStcokPlan 16394
IF EXISTS (select * from sysobjects where name='My_p_GetPOInStcokPlan' and xtype='p')  drop  procedure My_p_GetPOInStcokPlan

go

create procedure My_p_GetPOInStcokPlan(@fuserid int)

as

set nocount on

declare @fdate datetime
declare @sqls varchar(8000),@sqls1 varchar(8000),@sqls2 varchar(8000),@sqls3 varchar(8000)
declare @i int,@iCount int,@iDifCount int,@j int
declare @fbegindate datetime,@fenddate datetime
declare @varDate datetime
declare @varStrDate varchar(12),@varStrDateS varchar(8000),@varDifStrDate varchar(12)

select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')
select @fbegindate=@fdate,@fenddate=Dateadd(day,30,@fbegindate)

create table #temp(forderinterid int,forderentryid int)

--订单数与滚动计划数的平衡关系:订单数-当天以前的收料数=当天和当天以后的计划数
select t1.finterid forderinterid,t1.fentryid forderentryid,isnull(t3.FQtyFinish,0) FQtyFinish,isnull(t5.FQtyFinish,0) FQtyFinishToday,
t1.fqty-isnull(t3.FQtyFinish,0)-isnull(t2.fplanqty,0) fdifqty
into #source
from poorderentry t1
inner join poorder t4 on t1.finterid=t4.finterid
left join 
(
	select fsourceinterid,fsourceentryid,sum(fqty) fplanqty 
	from my_t_scheduledetail 
	where fsourcetrantype=71 and fdate>=@fdate
	group by fsourceinterid,fsourceentryid
) t2 on t1.finterid=t2.fsourceinterid and t1.fentryid=t2.fsourceentryid 
left join 
(
	select t1.fsourceinterid,t1.fsourceentryid,sum(t1.fqty-t1.fbackqty) FQtyFinish 
	from poinstockentry t1 
	inner join poinstock t2 on t1.finterid=t2.finterid
	where t2.ftrantype=72 and t2.fdate<@fdate --不审核的也纳入，因为以后将可以由收料计划下推生成收料通知单
	group by t1.fsourceinterid,t1.fsourceentryid
) t3 on t1.finterid=t3.fsourceinterid and t1.fentryid=t3.fsourceentryid 
left join 
(
	select t1.fsourceinterid,t1.fsourceentryid,sum(t1.fqty-t1.fbackqty) FQtyFinish 
	from poinstockentry t1 
	inner join poinstock t2 on t1.finterid=t2.finterid
	where t2.ftrantype=72 and t2.fdate>=@fdate --不审核的也纳入，因为以后将可以由收料计划下推生成收料通知单
	group by t1.fsourceinterid,t1.fsourceentryid
) t5 on t1.finterid=t5.fsourceinterid and t1.fentryid=t5.fsourceentryid 
inner join t_icitem t6 on t6.fitemid=t1.fitemid
where t1.fqty>isnull(t1.fstockqty,0) and t4.fstatus in (1,2) --未完成的采购订单
--and t1.fqty<>(isnull(t2.fplanqty,0)+isnull(t3.FQtyFinish,0)) 
and (t1.fmrpclosed=0 --or exists(select 1 from my_t_scheduledetail where fsourcetrantype=71 and fdate>=@fdate and fsourceinterid=t1.finterid and fsourceentryid=t2.fentryid)
)

select t2.forderinterid,t2.forderentryid,isnull(t1.fdate,'2100-01-01') fdate,isnull(t1.fqty,0) fqty 
into #data
from #source t2
left join my_t_scheduledetail t1 on t1.fsourceinterid=t2.forderinterid and t1.fsourceentryid=t2.forderentryid


--创建表
set @sqls=''

set @i=0

select @iCount=Datediff(day,@fbegindate,@fenddate)

while @i<=@iCount
begin
  set @varStrDate=replace(convert(varchar(10),Dateadd(day,@i,@fbegindate),111),'/','-')
  set @sqls=@sqls+'alter table #temp add ['+@varStrDate+'] decimal(24,4) default 0 '
  set @i=@i+1
end 

--print @sqls

execute (@sqls)   

--先计算出物料在计划期间每天的需求数---------------------------------------------------------------

set @sqls1='select forderinterid,forderentryid,'

set @i=0

select @iCount=Datediff(day,@fbegindate,@fenddate)

while @i<=@iCount
begin
  set @varStrDate=replace(convert(varchar(10),Dateadd(day,@i,@fbegindate),111),'/','-')
  set @sqls1=@sqls1+'(case when fdate='+''''+@varStrDate +''''+ ' then fqty else 0 end) '+''''+@varStrDate+''''+','
  set @i=@i+1
end 

set @sqls1=substring(@sqls1,1,len(@sqls1)-1)
set @sqls1=@sqls1+' from #data '  

--print @sqls1

--execute (@sqls1)  --结合下面的SQL执行 

--汇总-------------------------------------------------------------------
set @sqls='insert into #temp select t1.forderinterid,t1.forderentryid,' 

set @i=0

select @iCount=Datediff(day,@fbegindate,@fenddate)

while @i<=@iCount
begin
  set @varStrDate=replace(convert(varchar(10),Dateadd(day,@i,@fbegindate),111),'/','-')
  set @sqls=@sqls+'sum(['+@varStrDate +']) '+''''+@varStrDate+''''+','
  set @i=@i+1
end 

set @sqls=substring(@sqls,1,len(@sqls)-1)
set @sqls=@sqls+' from ('+@sqls1+') t1  group by t1.forderinterid,t1.forderentryid '  

--print @sqls

execute (@sqls)   --先计算出物料在计划期间每天的需求数

select cast(0 as bit) 选择,t5.fname 制单人,isnull(t7.fshortname,'') 厂商,t4.fbillno 订单编号,
t2.fitemid 产品内码,isnull(t2.fnote,'') 备注,
(case when t4.fstatus=0 then '未审核' when t4.fstatus in (1,2) then '审核' when (t4.fstatus=3 or t2.fmrpclosed=1) then '关闭' end) 订单状态,
t2.fdate 订单交期,t3.fnumber 产品编码,t3.fname 名称,t3.fmodel 规格型号,t3.funitid 单位内码,
t2.fqty 订单数,t2.fstockqty 入库数,t2.fcommitqty 收料数,
isnull(t8.FQtyFinish,0) 本日之前收料数,isnull(t8.FQtyFinishToday,0) 本日收料数,isnull(t8.fdifqty,0) 未排数,
t1.*
from poorderentry t2
inner join #temp t1 on t1.forderinterid=t2.finterid and t1.forderentryid=t2.fentryid
inner join t_icitem t3 on t2.fitemid=t3.fitemid
inner join poorder t4 on t4.finterid=t2.finterid
inner join t_measureunit t6 on t6.fitemid=t3.funitid
inner join t_supplier t7 on t7.fitemid=t4.fsupplyid
left join #source t8 on t8.forderinterid=t2.finterid and t8.forderentryid=t2.fentryid
inner join My_t_POOrderTemp t9 on t9.finterid=t2.finterid and t9.fentryid=t2.fentryid
inner join t_user t5 on t5.fuserid=t4.fbillerid
where t9.fuserid=@fuserid 
and t3.fnumber not like '1.02.%'  --套件
and t3.fnumber not like '6.%'  --子件
and t3.fnumber not like 'A.%' and t3.fnumber not like 'P.%'  
order by t9.findex,t7.fname,t3.fnumber,t4.fbillno

drop table #temp 
drop table #data
drop table #source

go



--生成倒冲物料调拨申请单--按物料排序

/*
IF EXISTS (select * from sysobjects where name='My_p_GenerateBackFlushPlanChangeStock' and xtype='p')  drop  procedure My_p_GenerateBackFlushPlanChangeStock

create procedure My_p_GenerateBackFlushPlanChangeStock(@fuserid int,@fdate datetime,@fdeptname varchar(250),@InterID int output)

as

set nocount on

--declare @fsourceinterid int,@fuserid int select @fsourceinterid=1127,@fuserid=16394

declare @funitid int,@entryid int,@fqty decimal(24,2),@fsourcebillno varchar(50),@fsourceentryid int
declare @BillNo varchar (20),@fpackinterid int,@fchildqty decimal(24,2),@fbomqty decimal(24,2),@FDCStockID int
DECLARE @TmpID INT ,@FBomInterID int,@flevel varchar(20),@fprepscrap decimal(24,4),@fprepscrapqty decimal(24,2)
declare @iLength int,@fserial varchar(20),@fstockid int,@fchilditemid int,@fhavechild bit,@fscstockid int
declare @fprojectval  varchar(200),@ferpclsname varchar(20),@fperqty decimal(24,2)
declare @FDateFormat  varchar(200),@s varchar(2000),@fsupplyid int
declare @FNumber varchar(200),@FChildNumber varchar(200),@FName varchar(200),@FChildName varchar(200)
declare @FUnit varchar(200),@FMachinePos varchar(200),@FNote varchar(200),@FPage varchar(200)

--select @fdate=replace(convert(varchar(10),getdate(),111),'/','-'),@fhavechild=0
declare @fitemid int,@fcontactno varchar(20),@flag int

Create Table #Mutidata     (  FIndex int IDENTITY,FEntryID INT, FBomInterid int, FItemID int null, FNeedQty decimal(28,14) default(0) null, FBOMLevel int null, 
FItemType int null, FParentID int default(0)null, FRate   decimal(28,14) default(0) null, FHistory int default(0) null, FHaveMrp smallint default(0) null, 
FLevelString varchar(300) null, FBom int, FMaterielType int  default(371) null,FOperSN Int NULL DEFAULT(0),FOperID int default(0)) 
 
Create Table #MutiParentItem(  FIndex int IDENTITY,FEntryID INT default(0), FBomInterid int, FItemID int null, FNeedQty decimal(28,14) default(0) null, FBOMLevel 
int null, FItemType int null,  FParentID int default(0)null, FRate   decimal(28,14) default(0) null, FHistory int default(0) null, FHaveMrp smallint default(0) 
null, FLevelString varchar(300) null , FBom int, FMaterielType int  default(371) null,FOperSN Int NULL DEFAULT(0),FOperID int default(0)) 

Create Table #Errors ( FIndex int IDENTITY, FType smallint default(0), FErrText nvarchar(655) )

Create Table #Data (fentryid int,fscrap decimal(24,2),fscrapqty decimal(24,2),fproductid int,
fproductqty decimal(24,2),fstockid int,
fperqty decimal(24,2),fbomqty decimal(24,2),fitemid int,fqty decimal(24,2),ftype int)

exec GetICMaxNum 't_BackFlushPlanChangeStock', @InterID output

set @entryid=1 --------------------------------------

DECLARE Seorder_Cursor2 CURSOR FOR
select t1.fscstockid fdcstockid,t2.fdefaultloc fscstockid,sum(t1.fqty) fqty,t2.fitemid,t2.funitid  
from my_t_backflushchangestock t1
inner join t_icitem t2 on t1.fitemid=t2.fitemid
where t1.fuserid=@fuserid
group by t2.fnumber,t2.fitemid,t2.funitid,t2.fdefaultloc,t1.fscstockid
order by t2.fnumber

OPEN Seorder_Cursor2

FETCH NEXT FROM Seorder_Cursor2 
INTO @FDCStockID,@fscstockid,@fqty,@fitemid,@funitid

WHILE @@FETCH_STATUS = 0
BEGIN
	INSERT INTO t_BackFlushPlanChangeStockEntry(fsupplyid,  fproductid,fprepscrap,  fitemid, FID,     FIndex,  FQty, fperqty, fbomqty, funitid, FSCStockID, FDCStockID, FRemark,   FCommitQty) 
	Values(							            0,          0,         0,           @fitemid,@InterID,@entryid,@FQty,0,       0,       @funitid,@FSCStockID,@FDCStockID,'',        0)

	set @entryid=@entryid+1
	set @fhavechild=1

    FETCH NEXT FROM Seorder_Cursor2 
    INTO @FDCStockID,@fscstockid,@fqty,@fitemid,@funitid
END

CLOSE Seorder_Cursor2
DEALLOCATE Seorder_Cursor2

-- 10.4
Update t_BillCodeRule Set FReChar = FReChar Where FBillTypeID =200000002

SET @TmpID = (SELECT FID FROM t_BillCodeRule WITH(READUNCOMMITTED) WHERE fbilltypeid=200000002 and fprojectid=3)

update t_billcoderule set fprojectval = fprojectval+1,flength=case when (flength-len(fprojectval)) >= 0 then flength else len(fprojectval) end where FID =  @TmpID 
Update ICBillNo Set FCurNo = (select top 1 isnull(fprojectval,1) from t_billcoderule where fprojectid = 3 and fbilltypeid =200000002) where fbillid = 200000002
   
--长度和目前编码
select @fprojectval=(fprojectval-1),@iLength=flength from t_BillCodeRule where fprojectid = 3 and fbilltypeid = 200000002
  
--日期
--select fprojectval,GetDate() AS DateNow from t_BillCodeRule where fprojectid = 2 and fbilltypeid = 100
  --  sDateFormat = tempRs.Fields(fprojectval)
  --  sDateFormat = Format(DateValue(tempRs.Fields(DateNow)), sDateFormat)

-- 前缀
select @BillNo=fprojectval+left('0000000000',@iLength-(len(@fprojectval)))+@fprojectval from t_BillCodeRule where fprojectid = 1 and fbilltypeid = 200000002  --@iLength

INSERT INTO t_BackFlushPlanChangeStock(FID,     FClassTypeID,FBillNo,FDate,  FBiller, FChecker,  FNOTE) 
Values(                                @InterID,200000002,   @BillNo,@fdate, @fuserid,0       ,  @fdeptname)

--EXEC p_UpdateBillRelateData 200000001,@interid

--set @fresultbillno=@fresultbillno+@billno

update m2 set fnooutstockqty=m2.fqty-m2.FCommitQty
from t_BackFlushPlanChangeStockEntry m2 
inner join t_BackFlushPlanChangeStock m3 on m2.fid=m3.fid
where m3.fid=@InterID

set nocount off

*/

GO


--收料通知单触发器--新增、更新--
IF EXISTS (select * from sysobjects where name='My_Tri_POInStock_UP'  and xtype='TR')  drop  TRIGGER My_Tri_POInStock_UP
go

Create TRIGGER [dbo].My_Tri_POInStock_UP ON [dbo].POInStock
FOR update
AS
SET NOCOUNT ON

DECLARE	@InterID  int,@fentryid int,@fmrpautoclosed INT,@fmrpclosed int,@s varchar(200)
declare @FSourceTranType int,@FSourceInterId int,@fstatus int,@fcheckerid int,@ftrantype int

SELECT @InterID=finterid,@fstatus=fstatus,@fcheckerid=fcheckerid,@ftrantype=ftrantype FROM inserted

		--and exists(select 1 from poinstockentry where FStockID<>18132 and finterid=@InterID)
		--RAISERROR('仓库必须为待检仓!',18,18)

if update(fstatus) and @ftrantype=73  --退料通知单  --and @fstatus=1
begin
	--子件回写关联数量--一审是业务级审核，就会更新fstatus --收料通知单系统自带功能会回写，退料通知单则不能回写负数，所有用触发器处理
	update t5 set fcommitqty=t5.fcommitqty+(case when @fstatus=1 then -1 else 1 end)*t1.fqty,
	FNoCommitQty=t5.FNoCommitQty+(case when @fstatus=1 then 1 else -1 end)*t1.fqty
	from 
	(
		select t1.fsourceinterid,t1.fsourceentryid,t1.fsourcetrantype,sum(t1.fqty) fqty
		from poinstockentry t1--
		inner join inserted t2 on t1.finterid=t2.finterid
		group by t1.fsourceinterid,t1.fsourceentryid,t1.fsourcetrantype
	) t1 inner join poinstockentry t3 on t1.fsourceinterid=t3.finterid and t1.fsourceentryid=t3.fentryid and t1.fsourcetrantype=72
	inner join poinstock t4 on t3.finterid=t4.finterid
	inner join t_bosPlasticPoInStockEntry t5 on t5.fid=t3.fsourceinterid and t5.fentryid=t3.fsourceentryid and t3.fsourcetrantype=200000022
	inner join t_bosPlasticPoInStock t6 on t6.fid=t5.fid
end

go


--收料通知单触发器--新增、更新--
IF EXISTS (select * from sysobjects where name='My_Tri_POInStock'  and xtype='TR')  drop  TRIGGER My_Tri_POInStock
go

Create TRIGGER [dbo].My_Tri_POInStock ON [dbo].POInStock
FOR insert,update
AS
SET NOCOUNT ON

DECLARE	@InterID  int,@fentryid int,@fmrpautoclosed INT,@fmrpclosed int,@s varchar(200)
declare @FSourceTranType int,@FSourceInterId int,@fstatus int

SELECT @InterID=finterid,@fstatus=fstatus FROM inserted

if exists(	select 1
			from poinstock t1
			inner join poinstockentry t2 on t1.finterid=t2.finterid
			inner join t_icitem t3 on t2.fitemid=t3.fitemid  --套件
			where t1.finterid=@InterID and t3.fnumber like '1.02.%' 
			) 
			and exists (select * from t_SystemProfile where FCategory='IC' and fkey='FIsPlasticManage' and fvalue='1')
begin
	RAISERROR('套件不允许出入库!',18,18)
end


if update(fstatus) and @fstatus=1 and exists(select 1 from poinstockentry where FStockID<>16482 and finterid=@InterID)
begin
	RAISERROR('仓库必须为待检仓!',18,18)
end

--select * from t_stock where fitemid=18132  --update poinstockentry set fstockid=16482 where fstockid<>16482


go


--
IF EXISTS (select * from sysobjects where name='My_Tri_SEOrder'  and xtype='TR')  drop  TRIGGER My_Tri_SEOrder
go

Create TRIGGER My_Tri_SEOrder ON [dbo].[SEOrder]
FOR Insert,UPDATE

AS
BEGIN
	SET NOCOUNT ON
	declare @iMaxIndex int,@fpackoutstockinterid int
	declare @FInterID int  ,@fcustid int,@fuserid int
	declare @FMyInterID int ,@ftoday datetime,@fdate datetime,@fplanbegdate datetime
	declare @fcurrencyid int,@FMultiCheckLevel1 int
	declare @fbillno varchar(30)
	declare @ftrantype int ,@fdeptid int
	declare @fstatus int,@s varchar(800)

	select top 1 @fdeptid=fdeptid,@fstatus=fstatus,@fuserid=fbillerid,@fcurrencyid=fcurrencyid,
	@ftoday=replace(convert(varchar(10),getdate(),111),'/','-'),@s='',
	@FMultiCheckLevel1=isnull(FMultiCheckLevel1,0),@fbillno=fbillno,@FInterID=FInterID,@fcustid=@fcustid from INSERTED 

	select top 1 @fdate=fdate from seorderentry where finterid=@FInterID
	
	--update t2 set FHeadSelfS0148='1900-01-01',FHeadSelfS0154='1900-01-01' 
	--from INSERTED t1 
	--inner join seorder t2 on t1.finterid=t2.finterid 
	--where isnull(t2.FHeadSelfS0147,0) in (40032,40033) --40032	样品订单-收费 40033	样品订单-免费)

	if @FMultiCheckLevel1=0 --初始化表头的工厂交期和计划开工日期
	begin
-- 	        If DateDiff(day, @ftoday, @fdate) >= 3 
-- 	           set @fplanbegdate = DateAdd(day, -3, @fdate)
-- 	        Else
-- 	           set @fplanbegdate = @ftoday
-- 	          
-- 	        update t2 set FHeadSelfS0148=@fdate,FHeadSelfS0154=@fplanbegdate from INSERTED t1 inner join seorder t2 on t1.finterid=t2.finterid  

	        update t2 set FHeadSelfS0148='1900-01-01',FHeadSelfS0154='1900-01-01',FHeadSelfS0149='',FHeadSelfS0157=''
			from INSERTED t1 
			inner join seorder t2 on t1.finterid=t2.finterid  
	end

--	--未排产数
--	update m2 set FEntrySelfS0170=m2.fqty-isnull(m2.FEntrySelfS0169,0)
--	from seorderentry m2 
--	inner join seorder m3 on m2.finterid=m3.finterid
--	where m3.finterid=@finterid

    update t1 set FAdviceConsignDate=t1.fdate from seorderentry t1 where t1.finterid=@FInterID and t1.FAdviceConsignDate<>t1.fdate

	update t2 set FHeadSelfS0156=t1.fdate 
	from seorderentry t1 
	inner join seorder t2 on t1.finterid=t2.finterid
	where t1.finterid=@FInterID

	--FENTRYSELFS0160 实际裸包单价  FENTRYSELFS0161 包装单价   fentryselfs0165 品牌 fentryselfs0167  包装方案

	/*
	update t1 set FENTRYSELFS0160=t1.fprice-isnull(t1.FENTRYSELFS0161,0)
	from seorderentry t1
	where t1.finterid=@FInterID 
	and isnull(t1.FENTRYSELFS0160,0)=0
	*/

	update t1 set FEntrySelfS0174=t1.fqty-isnull(t1.fstockqty,0)
	from seorderentry t1
	where t1.finterid=@FInterID 

	--未出库纯PCS数
	update x set x.FEntrySelfS0190=x.FQty*isnull(y.fqty,1)-isnull(x.fstockqty,0)*isnull(y.fqty,1)
	from seorderentry x left join 
			(
				select c.fitemid,isnull(sum(isnull(b.fqty,1)),1)  as fqty
				from icbom a inner join icbomchild b on a.finterid=b.finterid
									 inner join t_icitem c on a.fitemid=c.fitemid
									 inner join t_icitem d on b.fitemid=d.fitemid
				where left(d.fnumber,1) in ('3','4','5','7','8')
				group by c.fitemid
			) y on x.fitemid=y.fitemid
	inner join seorder t1 on t1.finterid=x.finterid
	where x.finterid=@finterid --and t1.fdate>='2016-05-03'

	update t1 set fvisible=1,FVisForQuest=1,FVisForOrder=1
	FROM ICChatBillTitle t1 
	WHERE t1.FTypeid=61 AND t1.FInterid>0 AND t1.FColCaption<>'$' 
	and t1.fcolname='fstockqty'

	--纯PCS数
	update x set x.FEntrySelfS0188=x.FQty*isnull(y.fqty,1)
	from seorderentry x left join 
			(
				select c.fitemid,isnull(sum(isnull(b.fqty,1)),1)  as fqty
				from icbom a inner join icbomchild b on a.finterid=b.finterid
									 inner join t_icitem c on a.fitemid=c.fitemid
									 inner join t_icitem d on b.fitemid=d.fitemid
				where left(d.fnumber,1) in ('3','4','5','7','8')
				group by c.fitemid
			) y on x.fitemid=y.fitemid
	inner join seorder t1 on t1.finterid=x.finterid
	where x.finterid=@finterid --and t1.fdate>='2016-05-03'

	--客户最新价格
	update t1 set fentryselfs0189=isnull(t2.ftaxprice,0)
	from seorderentry t1
	inner join 
	(	
		select t1.ftaxprice,t1.fitemid  --该客户物料的最新单据的价格
		from seorderentry t1
		inner join 
		(
			select t2.fitemid,isnull(max(t1.finterid),0) finterid --该客户物料的最新单据
			from seorder t1
			inner join seorderentry t2 on t1.finterid=t2.finterid
			where t1.fcustid=@fcustid and t1.finterid<@finterid and t1.fstatus>0
			group by t2.fitemid
		) t2 on t1.finterid=t2.finterid and t1.fitemid=t2.fitemid
	) t2 on t1.fitemid=t2.fitemid
	where t1.finterid=@finterid 
	--and isnull(t1.fentryselfs0189,0)=0

	exec My_p_UpdateSeorder @FInterID

	--if exists (select 1 from t_BOSPlanChangeStockEntry t1 inner join t_BOSPlanChangeStock t2 on t1.fid=t2.fid where t1.FID_SRC=@FInterID)
	--begin
		/*
		if exists (select 1 from t_BOSPlanChangeStockEntry t1 inner join t_BOSPlanChangeStock t2 on t1.fid=t2.fid 
		where t1.FID_SRC=@InterID and isnull(t2.fchecker,0)<>0)
		begin
			RAISERROR('关联计划投料单已经审核!',18,18)
		end
		*/

		/*
		if exists (select 1 from t_BOSPlanChangeStockEntry t1 inner join t_BOSPlanChangeStock t2 on t1.fid=t2.fid 
		where t1.FID_SRC=@InterID and isnull(t1.fcommitqty,0)>0)
		begin
			RAISERROR('关联计划投料单部分已经调拨!',18,18)
		end
		*/

		/*  --放在前台去执行,不然总是触发，影响性能
		select top 1 @fuserid=t2.FBiller from t_BOSPlanChangeStockEntry t1 inner join t_BOSPlanChangeStock t2 on t1.fid=t2.fid where t1.FID_SRC=@FInterID
		set @fpackoutstockinterid=0
		exec My_p_GeneratePlanChangeStock @FInterID,@fuserid,@fpackoutstockinterid output
		*/
	--end 
END

GO


IF EXISTS (select * from sysobjects where name='My_Tri_SEOrder_UP'  and xtype='TR')  drop  TRIGGER My_Tri_SEOrder_UP
go

Create TRIGGER My_Tri_SEOrder_UP ON [dbo].[SEOrder]
FOR UPDATE

AS
BEGIN
	SET NOCOUNT ON
	declare @iMaxIndex int,@fpackoutstockinterid int
	declare @FInterID int  ,@fcustid int,@fuserid int
	declare @FMyInterID int 
	declare @fcurrencyid int,@FMultiCheckLevel1 int
	declare @fbillno varchar(30)
	declare @ftrantype int 
	declare @fstatus int,@s varchar(800)

	select top 1 @fstatus=fstatus,@fuserid=fbillerid,@fcurrencyid=fcurrencyid,@s='',
	@FMultiCheckLevel1=isnull(FMultiCheckLevel1,0),@fbillno=fbillno,@FInterID=FInterID,@fcustid=@fcustid from INSERTED 

	if update(fstatus) and @fstatus=0  --只要单据未审核，就更新为最新的
	begin
		update t1 set FAdviceConsignDate=t1.fdate from seorderentry t1 where t1.finterid=@FInterID --and t1.FAdviceConsignDate<>t1.fdate

		--附件标识
		if exists ( 
						select 1
						from t_accessory
						where FTypeid=200081 and fitemid=@FInterID
				   )
		begin
			update t1 set fheadselfs0150='Y' from seorder t1 where finterid=@FInterID
		end
		else
		begin
			update t1 set fheadselfs0150='' from seorder t1 where finterid=@FInterID
		end
	end

	if (update(fstatus) and @fstatus=1) or (update(FMultiCheckLevel1) and @FMultiCheckLevel1>0)
	begin
		if exists(select 1
					from seorderentry t1 
					inner join inserted t7 on t1.finterid=t7.finterid
					inner join t_icitem t2 on t1.fitemid=t2.fitemid 
					left join icbom t11 on t11.fitemid=t1.fitemid and t11.fusestatus=1072
					where t2.ferpclsid=2 and t11.fitemid is null)
		begin
			select @s=@s+','+m1.fnumber from
			(
				select distinct t2.fshortnumber fnumber
				from seorderentry t1 
				inner join inserted t7 on t1.finterid=t7.finterid
				inner join t_icitem t2 on t1.fitemid=t2.fitemid 
				left join icbom t11 on t11.fitemid=t1.fitemid and t11.fusestatus=1072
				where t2.ferpclsid=2 and t11.fitemid is null
			) m1

			set @s='以下物料无BOM或者BOM未使用['+@s+']'
			RAISERROR(@s,18,18)
		end

		if exists(select 1
					from seorderentry t1 
					inner join inserted t7 on t1.finterid=t7.finterid
					inner join t_icitem t2 on t1.fitemid=t2.fitemid 
					where left(t2.fnumber,1) in ('0','1','2','3','4','5','6','7','8','9') and t7.fcustid in ( 123 ,16708))
		begin
			select @s=@s+','+m1.fnumber from
			(
				select distinct t2.fshortnumber fnumber
				from seorderentry t1 
				inner join inserted t7 on t1.finterid=t7.finterid
				inner join t_icitem t2 on t1.fitemid=t2.fitemid 
				where left(t2.fnumber,1) in ('0','1','2','3','4','5','6','7','8','9') and t7.fcustid in ( 123 ,16708)
			) m1

			set @s='以下物料请以配件的形式录入['+@s+']'
			RAISERROR(@s,18,18)
		end	
		
		if exists(select 1
					from seorderentry t1 
					inner join inserted t7 on t1.finterid=t7.finterid
					inner join t_icitem t2 on t1.fitemid=t2.fitemid 
					inner join icbom t4 on t2.fitemid=t4.fitemid
					inner join icbomchild t5 on t4.finterid=t5.finterid
					inner join t_icitem t6 on t5.fitemid=t6.fitemid
					left join t_supplyentry t8 on t8.fitemid=t6.fitemid
					where t8.fitemid is null and left(t6.fnumber,1) in ('7','8') )
		begin
			select @s=@s+','+m1.fnumber from
			(
				select distinct '['+t2.fshortnumber+' | '+t6.fshortnumber+']' fnumber
				from seorderentry t1 
				inner join inserted t7 on t1.finterid=t7.finterid
				inner join t_icitem t2 on t1.fitemid=t2.fitemid 
				inner join icbom t4 on t2.fitemid=t4.fitemid
				inner join icbomchild t5 on t4.finterid=t5.finterid
				inner join t_icitem t6 on t5.fitemid=t6.fitemid
				left join t_supplyentry t8 on t8.fitemid=t6.fitemid
				where t8.fitemid is null and left(t6.fnumber,1) in ('7','8') 
			) m1

			set @s='以下外调品无采购单价['+@s+']'
			RAISERROR(@s,18,18)
		end
			
		update t2 set fentryselfs0164=t6.fitemid,fentryselfs0165=t6.fnumber,fentryselfs0166=t6.fname+'////'+isnull(t6.fmodel,'')  --半成品
		from inserted t1
		inner join seorderentry t2 on t1.finterid=t2.finterid
		inner join t_icitem t3 on t2.fitemid=t3.fitemid
		inner join icbom t4 on t3.fitemid=t4.fitemid
		inner join icbomchild t5 on t4.finterid=t5.finterid
		inner join t_icitem t6 on t5.fitemid=t6.fitemid
		where left(t6.fnumber,1) in ('3','4','5','7','8') 
			
		update t2 set fentryselfs0161=t6.fitemid,fentryselfs0162=t6.fnumber,fentryselfs0163=t6.fname+'////'+isnull(t6.fmodel,'')  --芯片
		from inserted t1
		inner join seorderentry t2 on t1.finterid=t2.finterid
		inner join t_icitem t3 on t2.fitemid=t3.fitemid
		inner join icbom t4 on t3.fitemid=t4.fitemid
		inner join icbomchild t5 on t4.finterid=t5.finterid
		inner join t_icitem t6 on t5.fitemid=t6.fitemid
		where t6.fnumber like '1.01.0010.%' 
				
		--主供应商 默认鑫威
		--update t2 set fentryselfs0176=25952
		--from inserted t1
		--inner join seorderentry t2 on t1.finterid=t2.finterid
		--inner join t_icitem t3 on t2.fitemid=t3.fitemid
		--where isnull(t2.fentryselfs0176,0)=0
		
		--自制的主供应商更新为鑫威
		update t2 set fentryselfs0176=25952 
		from inserted t1
		inner join seorderentry t2 on t1.finterid=t2.finterid
		inner join t_icitem t3 on t2.fitemid=t3.fitemid
		inner join icbom t4 on t3.fitemid=t4.fitemid
		inner join icbomchild t5 on t4.finterid=t5.finterid
		inner join t_icitem t6 on t5.fitemid=t6.fitemid
		where left(t6.fnumber,1) in ('3','4','5') --and isnull(t2.fentryselfs0176,0)=0	
		
		--外调的主供应商更新为。。。		
		update t2 set fentryselfs0176=t7.fsupid --t3.F_117  
		--select t9.fname
		from inserted t1
		inner join seorderentry t2 on t1.finterid=t2.finterid
		inner join t_icitem t3 on t2.fitemid=t3.fitemid
		inner join icbom t4 on t3.fitemid=t4.fitemid
		inner join icbomchild t5 on t4.finterid=t5.finterid
		inner join t_icitem t6 on t5.fitemid=t6.fitemid
		inner join t_supplyentry t7 on t7.fitemid=t6.fitemid
		inner join (select fitemid,max(fentryid) fentryid from (select t1.fitemid,t1.fentryid from t_supplyentry t1 inner join (select fitemid,max(FQuoteTime) FQuoteTime from t_SupplyEntry group by fitemid) t2 on t1.fitemid=t2.fitemid and t1.FQuoteTime=t2.FQuoteTime) t1 group by fitemid) t8 on t7.fitemid=t8.fitemid and t7.fentryid=t8.fentryid
		inner join t_supplier t9 on t9.fitemid=t7.fsupid
		where left(t6.fnumber,1) in ('7','8') --and isnull(t2.fentryselfs0176,0)=0	

		--色带的主供应商更新为。。。		
		update t2 set fentryselfs0176=t7.fsupid --t3.F_117  
		from inserted t1
		inner join seorderentry t2 on t1.finterid=t2.finterid
		inner join t_icitem t3 on t2.fitemid=t3.fitemid
		inner join t_supplyentry t7 on t7.fitemid=t3.fitemid
		inner join (select fitemid,max(fentryid) fentryid from (select t1.fitemid,t1.fentryid from t_supplyentry t1 inner join (select fitemid,max(FQuoteTime) FQuoteTime from t_SupplyEntry group by fitemid) t2 on t1.fitemid=t2.fitemid and t1.FQuoteTime=t2.FQuoteTime) t1 group by fitemid) t8 on t7.fitemid=t8.fitemid and t7.fentryid=t8.fentryid
		where left(t3.fnumber,1) in ('M') --and isnull(t2.fentryselfs0176,0)=0	
		
		--交付方式 默认为自产自包 --40089	自产自包,40090	外调自包,40091	外调外包
		--update t2 set fentryselfs0175=40089  
		--from inserted t1
		--inner join seorderentry t2 on t1.finterid=t2.finterid
		--inner join t_icitem t3 on t2.fitemid=t3.fitemid
		----where t2.finterid=@FInterID 
		----and isnull(t2.fentryselfs0176,0)=25952 and isnull(t2.fentryselfs0175,0)=0
		
		update t2 set fentryselfs0175=40089
		from inserted t1
		inner join seorderentry t2 on t1.finterid=t2.finterid
		inner join t_icitem t3 on t2.fitemid=t3.fitemid
		inner join icbom t4 on t3.fitemid=t4.fitemid
		inner join icbomchild t5 on t4.finterid=t5.finterid
		inner join t_icitem t6 on t5.fitemid=t6.fitemid
		where --t2.finterid=@FInterID and 
		left(t6.fnumber,1) in ('3','4','5') --and isnull(t2.fentryselfs0175,0)=0		

		update t2 set fentryselfs0175=40090
		from inserted t1
		inner join seorderentry t2 on t1.finterid=t2.finterid
		inner join t_icitem t3 on t2.fitemid=t3.fitemid
		inner join icbom t4 on t3.fitemid=t4.fitemid
		inner join icbomchild t5 on t4.finterid=t5.finterid
		inner join t_icitem t6 on t5.fitemid=t6.fitemid
		where --t2.finterid=@FInterID and 
		left(t6.fnumber,1) in ('7','8') --and isnull(t2.fentryselfs0175,0)=0	

		update t2 set fentryselfs0175=40090
		from inserted t1
		inner join seorderentry t2 on t1.finterid=t2.finterid
		inner join t_icitem t3 on t2.fitemid=t3.fitemid
		where --t2.finterid=@FInterID and 
		left(t3.fnumber,1) in ('M') --and isnull(t2.fentryselfs0175,0)=0
		
		--exec My_p_UpdateSeorder @FInterID

		--update t2 set fentryselfs0175=40090  
		--from seorder t1
		--inner join seorderentry t2 on t1.finterid=t2.finterid
		--inner join t_icitem t3 on t2.fitemid=t3.fitemid
		--where t2.finterid=@FInterID and isnull(t2.fentryselfs0176,0) not in (0,25952) and isnull(t2.fentryselfs0175,0)=0				
	end

--	if (update(fstatus) and @fstatus=1) or (update(FMultiCheckLevel1) and @FMultiCheckLevel1>0)
--	begin
--		if exists (select 1
--		from seorder t1
--		inner join seorderentry t2 on t1.finterid=t2.finterid
--		inner join t_icitem t4 on t4.fitemid=t2.fitemid
--		inner join t_item t5 on t5.fitemid=t2.fentryselfs0158 and t5.fitemclassid=3002
--		left join t_BOSPackSub t3 on t3.fbillno=t2.fentryselfs0159 and isnull(t3.FChecker,0)>0
--		where t1.finterid=@FInterID and t4.ferpclsid=2 --and (t4.fnumber not like 'H.%' and t4.fnumber not like 'K.%' and t4.fnumber not like 'M.%' and t4.fnumber not like 'N.%')
--		and isnull(t5.fnumber,'') not like '99.%' and t3.fid is null)
--		begin
--			set @s='部分分录还未设置包装方案或者包装方案未审核!'
--			RAISERROR(@s,18,18)
--		end
--	end

	if (update(fstatus) and @fstatus=0) or (update(FMultiCheckLevel1) and @FMultiCheckLevel1<=0)  --反审核要判断是否有排产
	begin
		if exists (select 1
		from my_t_scheduledetail t1
		inner join icmo t3 on t1.ficmointerid=t3.finterid
		inner join seorder t2 on t3.forderinterid=t2.finterid
		where t2.finterid=@FInterID and t1.fsourcetrantype=85 )
		begin
			set @s='该订单已经有排产,不能反审核!'
			RAISERROR(@s,18,18)
		end

		--fentryselfs0161  --芯片  fentryselfs0164  --半成品
		--if exists (select 1
		--from seorderentry t1
		--inner join seorder t2 on t1.finterid=t2.finterid
		--where t2.finterid=@FInterID and (isnull(t1.fentryselfs0161,0)<>0 or isnull(t1.fentryselfs0164,0)<>0) )
		--begin
		--	set @s='该订单已经配置,不能反审核!'
		--	RAISERROR(@s,18,18)
		--end
	end
END

GO


----销售订单分录触发器--更新
--IF EXISTS (select * from sysobjects where name='My_Tri_SEOrderEntry_UP'  and xtype='TR')  drop  TRIGGER My_Tri_SEOrderEntry_UP
--go

--Create TRIGGER [dbo].[My_Tri_SEOrderEntry_UP] ON [dbo].[SEOrderEntry]
--FOR update
--AS
--SET NOCOUNT ON

--DECLARE	@InterID  int,@fentryid int,@fmrpautoclosed INT,@fmrpclosed int,@s varchar(200),@fuserid int
--declare @foldqty decimal(24,5),@fnewqty decimal(24,5),@fstatus int,@fpackoutstockinterid int
--declare @FSourceTranType int,@FSourceInterId int

--SELECT @FSourceTranType=FSourceTranType,@FSourceInterId=FSourceInterId,@InterID=finterid,@fentryid=fentryid,@fmrpclosed=fmrpclosed,@fmrpautoclosed=fmrpautoclosed FROM inserted
--SELECT @foldqty=fqty FROM seorderentry where finterid=@InterID and fentryid=@fentryid
--select @fstatus=fstatus FROM seorder where finterid=@InterID 

----if update(fmrpclosed) and @fmrpclosed=1  --行业务关闭的时候关闭关联计划投料单
----begin
----	update t1 set fmrpclosed=40019
----	from inserted t4 
----	inner join seorder t5  on t5.finterid=t4.finterid
----	inner join t_icitem t8 on t8.fitemid=t4.fitemid
----	inner join t_Organization t6 on t5.FCustID=t6.fitemid
----	inner join t_BOSPlanChangeStockEntry t1 on t4.finterid=t1.FID_SRC and t4.fentryid=t1.FEntryID_SRC
----	inner join t_BOSPlanChangeStock t2 on t2.fid=t1.fid 
----	inner join t_icitem t3 on t3.fitemid=t1.fitemid
----	where (t4.fmrpclosed=1 or (t4.fstockqty>=t4.fqty)) and ((isnull(t1.fmrpclosed,0)<>40019 ) or (t1.fqty>t1.fcommitqty))
----end

--go



----销售订单分录触发器--删除
--IF EXISTS (select * from sysobjects where name='My_Tri_SEOrderEntry_Del'  and xtype='TR')  drop  TRIGGER My_Tri_SEOrderEntry_Del
--go

--Create TRIGGER [dbo].[My_Tri_SEOrderEntry_Del] ON [dbo].[SEOrderEntry]
--FOR delete
--AS
--SET NOCOUNT ON

--DECLARE	@InterID  int,@fentryid int,@fmrpautoclosed INT,@fmrpclosed int,@s varchar(200)
--declare @FSourceTranType int,@FSourceInterId int

--SELECT @FSourceTranType=FSourceTranType,@FSourceInterId=FSourceInterId,@InterID=finterid,
--@fentryid=fentryid,@fmrpclosed=fmrpclosed,@fmrpautoclosed=fmrpautoclosed FROM deleted

--/*
--if exists (select 1 from t_BOSPlanChangeStockEntry t1 inner join t_BOSPlanChangeStock t2 on t1.fid=t2.fid 
--where t1.FID_SRC=@InterID and isnull(t2.fchecker,0)<>0)
--begin
--	RAISERROR('关联计划投料单已经审核!',18,18)
--end

--if exists (select 1 from t_BOSPlanChangeStockEntry t1 inner join t_BOSPlanChangeStock t2 on t1.fid=t2.fid 
--where t1.FID_SRC=@InterID and isnull(t1.fcommitqty,0)>0)
--begin
--	RAISERROR('关联计划投料单部分已经调拨!',18,18)
--end

--delete t1
--from t_BOSPlanChangeStockEntry t1
--inner join deleted t2 on t1.FID_SRC=t2.finterid and t2.fsourceentryid=t1.FEntryID
--*/

--go


--预测订单触发器--新增,更新
IF EXISTS (select * from sysobjects where name='My_Tri_PPOrder_Up'  and xtype='TR')  drop  TRIGGER My_Tri_PPOrder_Up
go

Create TRIGGER [dbo].My_Tri_PPOrder_Up ON [dbo].[PPOrder]
FOR insert,update
AS
SET NOCOUNT ON

DECLARE	@InterID  int,@fentryid int,@fmrpautoclosed INT,@fmrpclosed int,@s varchar(200)
declare @FSourceTranType int,@FSourceInterId int,@fstatus int,@fdeptid int

SELECT @InterID=finterid,@fstatus=fstatus,@fdeptid=0 FROM inserted

if update (fstatus) and @fstatus=0
begin
	if exists (select 1 from icmo t1 
			   inner join pporderentry t2 on t1.fpporderinterid=t2.FInterID and t1.fsourceentryid=t2.fentryid
			   inner join inserted t3 on t2.finterid=t3.finterid )
	begin
		RAISERROR('已经有关联任务单据!',18,18)
	end
end

--未排产数
update m2 set FEntrySelfY0121=0,FEntrySelfY0122=m2.fqty
from pporderentry m2 
inner join pporder m3 on m2.finterid=m3.finterid
where m3.finterid=@InterID and m3.fstatus=0

--update m2 set FEntrySelfY0122=m2.fqty-isnull(m2.FEntrySelfY0121,0)
--from pporderentry m2 
--inner join pporder m3 on m2.finterid=m3.finterid
--where m3.finterid=@InterID

go

--
----预测订单分录触发器--删除
--IF EXISTS (select * from sysobjects where name='My_Tri_PPOrderEntry_Del'  and xtype='TR')  drop  TRIGGER My_Tri_PPOrderEntry_Del
--go
--
--Create TRIGGER [dbo].My_Tri_PPOrderEntry_Del ON [dbo].[PPOrderEntry]
--FOR delete
--AS
--SET NOCOUNT ON
--
--DECLARE	@InterID  int,@fentryid int,@fmrpautoclosed INT,@fmrpclosed int,@s varchar(200)
--declare @FSourceTranType int,@FSourceInterId int
--
--SELECT @InterID=finterid,@fentryid=fentryid FROM deleted
--
--if exists (select 1 from my_t_scheduledetail where fsourcetrantype=87 and forderinterid=@InterID and forderentryid=@fentryid)
--begin
--	RAISERROR('已经有关联排产单据!',18,18)
--end
--

go


--产品入库表触发器--新增、修改
/*
IF EXISTS (select * from sysobjects where name='My_Tri_ICStockBill2'  and xtype='TR')  drop  TRIGGER My_Tri_ICStockBill2


Create TRIGGER My_Tri_ICStockBill2 ON [dbo].ICStockBill
FOR Insert ,update

AS
BEGIN
	SET NOCOUNT ON
	declare @finterid int,@FMultiCheckLevel1 int,@fdate datetime,@ftrantype int
	declare @fsrccommitfield_prevalue decimal(24,2),@fsrccommitfield_endvalue decimal(24,2)

	select top 1 @finterid=finterid,@ftrantype=ftrantype--,@FMultiCheckLevel1=isnull(FMultiCheckLevel1,0),
	--@fdate=replace(convert(varchar(10),FMultiCheckDate1,111),'/','-')
	from inserted

	if @ftrantype=2
	begin

		update src set src.FEntrySelfY0123=dest.fqty
		from pporderentry src 
		inner join pporder srchead on src.finterid=srchead.finterid
		inner join 
		(
			select u4.fpporderinterid forderinterid,u4.fsourceentryid forderentryid,u1.fitemid,sum(u1.fqty) as fqty
			from  icstockbillentry u1 
			inner join t_icitem u2 on u1.fitemid=u2.fitemid
			inner join inserted u3 on u3.finterid=u1.finterid
			inner join icmo u4 on u4.finterid=u1.ficmointerid
			where u3.ftrantype=2
			group by u4.fpporderinterid,u4.fsourceentryid,u1.fitemid
		) dest on dest.forderinterid = src.finterid and dest.forderentryid=src.fentryid and dest.fitemid = src.fitemid
		inner join t_measureunit t1 on src.funitid=t1.fitemid

		update u4 set FHeadSelfJ0176=u3.fdate
		from  icstockbillentry u1 
		inner join t_icitem u2 on u1.fitemid=u2.fitemid
		inner join inserted u3 on u3.finterid=u1.finterid
		inner join icmo u4 on u4.finterid=u1.ficmointerid

		update u1 set fentryselfa0236=u5.fentryselfs0162/*计件单价*/,fentryselfa0237=cast(u1.fqty*u5.fentryselfs0162 as decimal(24,2))/*包装工资*/
		from  icstockbillentry u1 
		inner join t_icitem u2 on u1.fitemid=u2.fitemid
		inner join inserted u3 on u3.finterid=u1.finterid
		inner join icmo u4 on u4.finterid=u1.ficmointerid
		inner join seorderentry u5 on u4.forderinterid=u5.finterid and u4.fsourceentryid=u5.fentryid
	
	end

	set nocount off
end

*/

go



--倒冲物料调拨申请单触发器--未调拨数
/*
IF EXISTS (select * from sysobjects where name='t_BackFlushPlanChangeStock_Update'  and xtype='TR')  drop  TRIGGER t_BackFlushPlanChangeStock_Update


create trigger t_BackFlushPlanChangeStock_Update on t_BackFlushPlanChangeStock
after update
as
set nocount on

declare @fstatus int,@finterid int,@FChecker int
select @finterid=fid,@FChecker=isnull(FChecker,0) from inserted

update m2 set fnooutstockqty=m2.fqty-m2.FCGStockQty
from t_BackFlushPlanChangeStockEntry m2 
inner join t_BackFlushPlanChangeStock m3 on m2.fid=m3.fid
where m3.fid=@finterid

if update(FChecker) and @FChecker>0
begin
	update m2 set finvqty=cast(isnull(m4.fqty,0) as decimal(24,2))
	from t_BackFlushPlanChangeStockEntry m2 
	inner join t_BackFlushPlanChangeStock m3 on m2.fid=m3.fid
	left join (select t1.fitemid,sum(t1.fqty) fqty from icinventory t1 inner join t_stock t2 on t1.fstockid=t2.fitemid where t2.fname not like '不良%' group by t1.fitemid) m4 on m4.fitemid=m2.fitemid
	where m3.fid=@finterid  
end
*/
go


--代管物料出库申请单触发器--未关联数
/*
IF EXISTS (select * from sysobjects where name='t_PackOutRequest_Update'  and xtype='TR')  drop  TRIGGER t_PackOutRequest_Update


create trigger t_PackOutRequest_Update on t_PackOutRequest
after update
as
set nocount on

declare @fstatus int,@finterid int,@FChecker int
select @finterid=fid,@FChecker=isnull(FChecker,0) from inserted

update m2 set fnooutstockqty=m2.fqty-m2.FCommitQty
from t_BOS200000004Entry2 m2 
inner join t_PackOutRequest m3 on m2.fid=m3.fid
where m3.fid=@finterid

if update(FChecker) and @FChecker>0
begin
	update m2 set finvqty=cast(isnull(m4.fqty,0) as decimal(24,2))
	from t_BOS200000004Entry2 m2 
	inner join t_PackOutRequest m3 on m2.fid=m3.fid
	left join (select t1.fitemid,sum(t1.fqty) fqty from icinventory t1 inner join t_stock t2 on t1.fstockid=t2.fitemid where t2.fname not like '不良%' group by t1.fitemid) m4 on m4.fitemid=m2.fitemid
	where m3.fid=@finterid  
end
*/
go


--其它出库申请单触发器--未关联数
IF EXISTS (select * from sysobjects where name='t_OtherOutRequest_Update'  and xtype='TR')  drop  TRIGGER t_OtherOutRequest_Update
go

create trigger t_OtherOutRequest_Update on t_OtherOutRequest
after update
as
set nocount on

declare @fstatus int,@finterid int,@FChecker int
select @finterid=fid,@FChecker=isnull(FChecker,0) from inserted

update m2 set fnooutstockqty=m2.fqty-m2.FCommitQty
from t_OtherOutRequestEntry m2 
inner join t_OtherOutRequest m3 on m2.fid=m3.fid
where m3.fid=@finterid

if update(FChecker) and @FChecker>0
begin
	update m2 set finvqty=cast(isnull(m4.fqty,0) as decimal(24,2))
	from t_OtherOutRequestEntry m2 
	inner join t_OtherOutRequest m3 on m2.fid=m3.fid
	left join (select t1.fitemid,sum(t1.fqty) fqty from icinventory t1 inner join t_stock t2 on t1.fstockid=t2.fitemid where t2.fname not like '不良%' group by t1.fitemid) m4 on m4.fitemid=m2.fitemid
	where m3.fid=@finterid  
end

go


--办公用品采购申请单触发器--未关联数
IF EXISTS (select * from sysobjects where name='t_BosOfficeRequest_Update'  and xtype='TR')  drop  TRIGGER t_BosOfficeRequest_Update
go

create trigger t_BosOfficeRequest_Update on t_BosOfficeRequest
after update
as
set nocount on

declare @fstatus int,@finterid int,@FChecker int
select @finterid=fid,@FChecker=isnull(FChecker,0) from inserted

update m2 set fnooutstockqty=m2.fqty-m2.FCommitQty
from t_BosOfficeRequestEntry m2 
inner join t_BosOfficeRequest m3 on m2.fid=m3.fid
where m3.fid=@finterid

if update(FChecker) and @FChecker>0
begin
	update m2 set finvqty=cast(isnull(m4.fqty,0) as decimal(24,2))
	from t_BosOfficeRequestEntry m2 
	inner join t_BosOfficeRequest m3 on m2.fid=m3.fid
	left join (select t1.fitemid,sum(t1.fqty) fqty from icinventory t1 inner join t_stock t2 on t1.fstockid=t2.fitemid where t2.fname not like '不良%' group by t1.fitemid) m4 on m4.fitemid=m2.fitemid
	where m3.fid=@finterid  
end

go


IF EXISTS (select * from sysobjects where name='My_p_UpdateSeorder' and xtype='p') drop procedure My_p_UpdateSeorder

go

create procedure My_p_UpdateSeorder(@finterid int)
as
begin

set nocount on

declare @FUSDExchangerate decimal(24,4),@FMakeDivPiece decimal(24,4)
declare @FThreeDivPiece decimal(24,4), @FTax decimal(24,4), @FBackTax decimal(24,4)
declare @FStdPackPiece decimal(24,4)

select @FUSDExchangerate=fvalue from T_SYSTEMPROFILE where fkey='FUSDExchangerate'
select @FMakeDivPiece=fvalue from T_SYSTEMPROFILE where fkey='FMakeDivPiece'
select @FThreeDivPiece=fvalue from T_SYSTEMPROFILE where fkey='FThreeDivPiece'
select @FTax=fvalue from T_SYSTEMPROFILE where fkey='FTax'
select @FBackTax=fvalue from T_SYSTEMPROFILE where fkey='FBackTax'
select @FStdPackPiece=fvalue from T_SYSTEMPROFILE where fkey='FStdPackPiece'

create table #data(
	FIndex int IDENTITY,
	fcalprice1000 decimal(24,4) default(0),--计算出来的参考价格--美金
	fcalprice1 decimal(24,4) default(0),--计算出来的参考价格--人民币
	fprice1000 decimal(24,4) default(0),--现-实际单价--美金
	fprice1 decimal(24,4) default(0),--现-实际单价--人民币
	fprofit1 decimal(24,4) default 0,  --现-实际利润率--人民币
	fprofit1000 decimal(24,4) default 0,  --现-实际利润率--美金
	fmaterialfee decimal(24,4) default(0), --现-材料
	fchipprice decimal(24,4) default(0),
	fpackprice decimal(24,4) default(0),
	fchildprice decimal(24,4) default(0),
	fotherprice decimal(24,4) default(0),
	fpiecefee decimal(24,4) default(0), --现-人工
	ffinancefee decimal(24,4) default(0), --现-费用 = 三大费用 + 制造费用
	ftargetprofit decimal(24,4) default 0,  --目标利润率
	flowestprofit decimal(24,4) default 0,  --最低利润率
	fbacktax decimal(24,4) default 0,  --怔退税率差
	ftax decimal(24,4) default 0,  --所得税率
	fprogradeid int default 0,--产品分级
	FItemID int NOT NULL,
	fbanitemid int, --半成品
	fxinitemid int,--芯片
	fcalxs decimal(24,4) default 0,  --结算系数
	fmakefee decimal(24,4) default 0,  --制造费用
	fthreefee decimal(24,4) default 0,  --三大费用
	FStdPackFee decimal(24,4) default 0,  --标准包装价
) 

insert into #data (fitemid)
select distinct t3.fitemid  
from t_icitem t3 
inner join seorderentry t2 on t2.fitemid=t3.fitemid
where t2.finterid=@finterid

--采购单价
select t4.fitemid,(case when t5.fcyid=1000 then t5.ftaxprice*t1.fexchangerate else t5.ftaxprice end) fprice
into #temp --
from (select fitemid,max(fentryid) fentryid from (select t1.fitemid,t1.fentryid from t_supplyentry t1 inner join (select fitemid,max(FQuoteTime) FQuoteTime from t_SupplyEntry group by fitemid) t2 on t1.fitemid=t2.fitemid and t1.FQuoteTime=t2.FQuoteTime) t1 group by fitemid) t4 
inner join t_supplyentry t5 on t4.fitemid=t5.fitemid and t4.fentryid=t5.fentryid
inner join t_currency t1 on t1.fcurrencyid=t5.fcyid

--人工=半成品+包装
update t3 set fpiecefee=isnull(t1.FPiece,0)+isnull(t2.FPieceRate,0.35)
from #data t3
inner join t_icitem t2 on t2.fitemid=t3.fitemid
left join  
(
	select fitemid,sum(FPiece) FPiece
	from
	(
		select t1.fitemid,isnull(t4.FPieceRate,0)*t3.fqty FPiece
		from t_icitem t1
		inner join icbom t2 on t1.fitemid=t2.fitemid
		inner join icbomchild t3 on t2.finterid=t3.finterid
		inner join t_icitem t4 on t3.fitemid=t4.fitemid
		where t1.fitemid in (select fitemid from #data)
		and isnull(t1.f_126,0)=40019 --and t1.fname not like '%禁用%' and t2.fstatus>0 and t1.fdeleted=0
		and left(t4.fnumber,1) in ('3','4','5')
	) t1 group by t1.fitemid
) t1 on t3.fitemid=t1.fitemid 


--制造费用
update t1 set fmakefee= isnull(t1.fpiecefee,0)*isnull(@FMakeDivPiece,0)
from #data t1

--三大费用
update t1 set fthreefee= isnull(t1.fpiecefee,0)*isnull(@FThreeDivPiece,0)
from #data t1

--费用 = 三大费用 + 制造费用 + 人工
update t1 set ffinancefee= isnull(t1.fthreefee,0)+isnull(t1.fmakefee,0)+isnull(t1.fpiecefee,0)
from #data t1

--所得税率
update t1 set FTax= isnull(@FTax,0)
from #data t1

--怔退税率差
update t1 set fbacktax= isnull(@fbacktax,0)
from #data t1


--其它
update t1 set FStdPackFee= isnull(t3.F_138,0),-- 标准包装价
fcalxs=0.95,--(case when Charindex('高配',t3.fname,1)>0 then 0.93 else 0.95 end), -- 结算系数
fprogradeid=isnull(t4.fitemid,0), --产品分级
ftargetprofit=isnull(t4.F_101,0),  --目标利润率
flowestprofit=isnull(t4.F_102,0)   --最低利润率
from #data t1
inner join t_icitem t3 on t1.fitemid=t3.fitemid
left join t_Item_3018 t4 on t3.F_136=t4.fitemid


--材料成本
update t4 set fmaterialfee=t2.fprice,fchipprice=t2.fchipprice,fpackprice=t2.fpackprice,fotherprice=t2.fotherprice,fchildprice=t2.fchildprice
--select t3.fnumber 产品编码,t3.fname 产品名称,t3.fmodel 产品规格型号,t2.fprice 单位成本
from t_ICItemMaterial t1
inner join 
(
	select t1.fitemid,sum(fchipprice) fchipprice,sum(fpackprice) fpackprice,
	sum(fchildprice) fchildprice,sum(fotherprice) fotherprice,sum(fprice) fprice
	from
	(
		select t1.fitemid,(case when t1.ftype=1 then fprice else 0 end) fchipprice,
		(case when t1.ftype=2 then fprice else 0 end) fpackprice,
		(case when t1.ftype=3 then fprice else 0 end) fchildprice,
		(case when t1.ftype=4 then fprice else 0 end) fotherprice,t1.fprice
		from
		(
			select t1.fitemid,t1.ftype,sum(fprice) fprice
			from
			(
				--外购成品--色带
				SELECT 4 ftype,t2.fitemid,(1*isnull(t5.fprice,0)) fprice
				from t_icitem t2  --成品
				left join #temp t5 on t5.fitemid=t2.fitemid
				--left join icbom t7 on t7.fitemid=t2.fitemid --and t7.fstatus>0--成品
				where --t7.fitemid is null and --没有BOM--
				t2.fitemid in (select fitemid from #data) and left(t2.fnumber,1) in ('M')
				--and t2.fshortnumber='D10054'
				union all
				--外购半成品
				select 3 ftype,t2.fitemid,(t3.fqty*t5.fprice) fprice  
				from t_icitem t1
				inner join icbom t2 on t1.fitemid=t2.fitemid --and t2.fstatus>0
				inner join icbomchild t3 on t2.finterid=t3.finterid
				inner join #temp t5 on t5.fitemid=t3.fitemid
				inner join t_icitem t6 on t6.fitemid=t3.fitemid
				where left(t6.fnumber,1) in ('7','8') --and t1.ferpclsid=2 
				and t1.fitemid in (select fitemid from #data) and left(t1.fnumber,1) in ('A', 'J', 'P', 'Q', 'R', 'V', 'X', 'Y')
				and t6.fdefaultloc<>16483  --
				union all
				--芯片
				select 1 ftype,t2.fitemid,(t3.fqty*t5.fprice) fprice  
				from t_icitem t1
				inner join icbom t2 on t1.fitemid=t2.fitemid --and t2.fstatus>0
				inner join icbomchild t3 on t2.finterid=t3.finterid
				inner join #temp t5 on t5.fitemid=t3.fitemid
				inner join t_icitem t6 on t6.fitemid=t3.fitemid
				where t1.fitemid in (select fitemid from #data) and left(t1.fnumber,1) in ('A', 'J', 'P', 'Q', 'R', 'V', 'X', 'Y')
				and t6.fdefaultloc<>16483  --
				and t6.fnumber like '1.01.0010%'
				union all
				--包装
				select 2 ftype,t2.fitemid,(t3.fqty*t5.fprice) fprice
				from t_icitem t1
				inner join icbom t2 on t1.fitemid=t2.fitemid --and t2.fstatus>0
				inner join icbomchild t3 on t2.finterid=t3.finterid
				inner join #temp t5 on t5.fitemid=t3.fitemid
				inner join t_icitem t6 on t6.fitemid=t3.fitemid
				where left(t6.fnumber,1) not in ('3','4','5','7','8') --and t1.ferpclsid=2 
				and t1.fitemid in (select fitemid from #data) and left(t1.fnumber,1) in ('A', 'J', 'P', 'Q', 'R', 'V', 'X', 'Y')
				and t6.fdefaultloc<>16483  --
				and t6.fnumber not like '1.01.0010%' 
				union all
				--半成品
				select 3 ftype,t2.fitemid,(t3.fqty*t12.fqty*t5.fprice) fprice
				from t_icitem t1
				inner join icbom t2 on t1.fitemid=t2.fitemid --and t2.fstatus>0 --成品
				inner join icbomchild t3 on t2.finterid=t3.finterid  --半成品
				inner join icbom t11 on t11.fitemid=t3.fitemid  --半成品
				inner join icbomchild t12 on t11.finterid=t12.finterid  --半成品子项
				inner join #temp t5 on t5.fitemid=t12.fitemid
				inner join t_icitem t6 on t6.fitemid=t3.fitemid --半成品
				inner join t_icitem t7 on t7.fitemid=t2.fitemid --成品
				inner join t_icitem t8 on t8.fitemid=t12.fitemid --半成品子项
				where left(t6.fnumber,1) in ('3','4') --and t1.ferpclsid=2
				and t1.fitemid in (select fitemid from #data) and left(t1.fnumber,1) in ('A', 'J', 'P', 'Q', 'R', 'V', 'X', 'Y')
				union all
				select 3 ftype,t2.fitemid,(t3.fqty*t12.fqty*t5.fprice) fprice
				from t_icitem t1
				inner join icbom t2 on t1.fitemid=t2.fitemid --and t2.fstatus>0 --成品
				inner join icbomchild t3 on t2.finterid=t3.finterid  --半成品
				inner join icbom t11 on t11.fitemid=t3.fitemid  --半成品
				inner join icbomchild t12 on t11.finterid=t12.finterid  --半成品子项
				inner join #temp t5 on t5.fitemid=t12.fitemid
				inner join t_icitem t6 on t6.fitemid=t3.fitemid --半成品
				inner join t_icitem t7 on t7.fitemid=t2.fitemid --成品
				inner join t_icitem t8 on t8.fitemid=t12.fitemid --半成品子项
				where left(t6.fnumber,1) in ('5') and t8.fname not like '回收件%' --and t1.ferpclsid=2
				and t1.fitemid in (select fitemid from #data) and left(t1.fnumber,1) in ('A', 'J', 'P', 'Q', 'R', 'V', 'X', 'Y')
				union all
				select 3 ftype,t2.fitemid,(t3.fqty*t5.fprice) fprice
				from t_icitem t1
				inner join icbom t2 on t1.fitemid=t2.fitemid --and t2.fstatus>0 --成品
				inner join icbomchild t3 on t2.finterid=t3.finterid  --半成品
				inner join icbom t11 on t11.fitemid=t3.fitemid  --半成品
				inner join (
		-- 			select distinct t1.fitemid,(select top 1 fitemid from t_icitem where fparentid=t1.fparentid and fname like '%拆盒%' ) fchiheitemid
		-- 			from t_icitem t1
		-- 			inner join icbomchild t2 on t1.fitemid=t2.fitemid
		-- 			where t1.fnumber like '5.%' and t1.fname not like '%拆盒%'
					select distinct t1.fitemid,
					(
						select top 1 m4.fitemid 
						from t_icitem m1 
						inner join icbomchild m2 on m1.fitemid=m2.fitemid
						inner join icbom m3 on m2.finterid=m3.finterid
						inner join t_icitem m4 on m3.fitemid=m4.fitemid
						where m4.fnumber like '5.%' and m4.fname like '%拆盒%' and m1.fitemid=t5.fitemid 
					) fchiheitemid
					from t_icitem t1
					inner join icbomchild t2 on t1.fitemid=t2.fitemid
					inner join icbom t3 on t1.fitemid=t3.fitemid
					inner join icbomchild t4 on t4.finterid=t3.finterid
					inner join t_icitem t5 on t5.fitemid=t4.fitemid
					where t1.fnumber like '5.%' and t1.fname not like '%拆盒%' and t5.fnumber like '1.02.%'
				) t12 on t11.fitemid=t12.fitemid --半成品同级回收壳
				inner join t_icitem t6 on t6.fitemid=t3.fitemid --半成品
				inner join t_icitem t7 on t7.fitemid=t2.fitemid --成品
				inner join t_icitem t8 on t8.fitemid=t12.fchiheitemid --半成品同级回收壳
				inner join #temp t5 on t5.fitemid=t8.fitemid
				where left(t6.fnumber,1) in ('5') --and t1.ferpclsid=2
				and t1.fitemid in (select fitemid from #data) and left(t1.fnumber,1) in ('A', 'J', 'P', 'Q', 'R', 'V', 'X', 'Y')
			) t1 group by t1.fitemid,t1.ftype
		) t1 
	) t1 group by t1.fitemid
) t2 on t1.fitemid=t2.fitemid
inner join t_icitem t3 on t3.fitemid=t1.fitemid
inner join #data t4 on t4.fitemid=t1.fitemid 


update t2 set fentryselfs0179=t1.fmaterialfee,
fentryselfs0192=t1.fchipprice,fentryselfs0193=t1.fpackprice,--fotherprice=t2.fotherprice,
fentryselfs0191=t1.fchildprice,
fentryselfs0185=t1.fprogradeid,
fentryselfs0181=t1.ftargetprofit,fentryselfs0182=t1.flowestprofit,fentryselfs0180=t1.ffinancefee
from t_icitem t3 
inner join seorderentry t2 on t2.fitemid=t3.fitemid
inner join #data t1 on t1.fitemid=t3.fitemid
left join t_Item_3018 t4 on t1.fprogradeid=t4.fitemid
where t2.finterid=@finterid


drop table #temp
drop table #data

set nocount off

end

go

--配件批量生成
--declare @fitemid int set @fitemid=0 exec My_p_GenerateAccessory 16394,32099,@fitemid print @fitemid  --select * from t_icitem where fshortnumber='000042'

IF EXISTS (select * from sysobjects where name='My_p_GenerateAccessory' and xtype='p')  drop  procedure My_p_GenerateAccessory

go

create procedure [dbo].My_p_GenerateAccessory(@fuserid int,@fsourceitemid int,@fitemid int output,@fnumber varchar(30) output,@ftypeno varchar(30))
--with encryption 
as
SET NOCOUNT ON

--declare @fuserid int,@fsourceitemid int,@fitemid int select @fuserid=16394,@fsourceitemid=32099,@fitemid=0
declare @iMaxIndex int,@fname varchar(2000),@fmodel varchar(2000),@fdescription varchar(2000)
declare @FCompatArea varchar(2000),@FCompatModel varchar(2000),@FNetWeight decimal(24,2)
declare @FLength decimal(24,2),@FWidth decimal(24,2),@FHeight decimal(24,2)
declare @FStdBoxSize varchar(300),@FStdColourSize varchar(300),@FStandardQty int
declare @FInterID int ,@fcheckerid int,@fsource int,@fprintbrandid int
declare @FMyInterID int ,@FSupplyId int,@fusername varchar(30),@FLevel int,@ftempshortnumber varchar(20)
declare @fcurrencyid int,@FPType int,@fstartqty int,@fendqty int,@fnote varchar(500)
declare @fbillno varchar(30),@fprice decimal(24,4),@ftempprice decimal(24,4)
declare @funitid int,@FColourSizeTypeID int,@ftempnumber varchar(20),@ftempname varchar(2000)
declare @fstatus int,@fsubid int,@foldprice1 decimal(24,4),@foldprice2 decimal(24,4),@foldprice3 decimal(24,4)
declare @fdate datetime,@freasonid int,@FShortNumber varchar(20),@FParentNumber varchar(100),@FParentNamd varchar(2000)
declare @ftrantype varchar(50),@FParentID int,@ffullname varchar(3000)
declare @InterID int,@BillNo varchar (20),@fbomgroupid int,@TmpID INT ,@FBomInterID int,@iLength int
declare @fprojectval  varchar(200),@ferpclsname varchar(20),@sDateFormat  varchar(200)

select @fdate=replace(convert(varchar(10),getdate(),111),'/','-')  --制单日期
select @fusername=t1.fname from t_user t1 where t1.fuserid=@fuserid

if not exists(select t4.fnumber from t_icitem t1 inner join icbomchild t2 on t1.fitemid=t2.fitemid
			  inner join icbom t3 on t2.finterid=t3.finterid inner join t_icitem t4 on t4.fitemid=t3.fitemid 
			  where t4.fnumber like 'R.%' and t1.fitemid=@fsourceitemid and t2.fentryid=1)
begin
	select @FShortNumber='RX'+isnull(left('00000',(len('00000')-len((max(cast(right(fshortnumber,5) as int))+1))))+CAST((max(cast(right(fshortnumber,5) as int))+1) as varchar(10)),'00000') from t_icitem where fnumber like 'R.%'

	if @ftypeno='黑色'
		select @FParentNumber='R.01.002'
	else
		select @FParentNumber='R.02.002'

	select @fnumber=@FParentNumber+'.'+@FShortNumber
	select @FParentID=fitemid,@FLevel=FLevel+1 from t_item where fnumber=@FParentNumber and fdetail=0 and fitemclassid=4

	select @fname='配件/'+fname,@fmodel=fmodel from t_icitem where fitemid=@fsourceitemid

	INSERT INTO t_Item (ffullnumber,FItemClassID,FParentID, FLevel, FName,  FNumber, FShortNumber,  FDetail,UUID,     FDeleted) 
	VALUES 		   (@fnumber,   4,           @FParentID,@FLevel,@fname, @fnumber,@FShortNumber, 1,      newid() , 0)

	INSERT INTO t_Log (FDate,    FUserID,    FFunctionID,FStatement,FDescription,                                  FMachineName,FIPAddress) 
	VALUES 		      (getdate(),@fuserid,  'A00701',   5,         '新建核算项目:'+@fnumber+' 核算项目类别:物料','KSW103',    '192.168.0.89')

	select @fitemid=FItemID,@ffullname=ffullname from t_Item where fdetail=1 and fitemclassid=4 and fnumber=@fnumber
	
	INSERT INTO t_ICItem (FHelpCode,FModel,   FAuxClassID,FErpClsID,FTypeID,FUnitGroupID,FUnitID,FOrderUnitID,FSaleUnitID,FProductUnitID,FStoreUnitID,FSecUnitID,FSecCoefficient,  FDefaultLoc,FSPID,FSource,F_136,F_114,F_115,F_117,f_110,F_109,  F_111,  F_140, FQtyDecimal,FLowLimit,FHighLimit,FSecInv,FUseState,FIsEquipment,FEquipmentNum,FIsSparePart,FFullName,  FApproveNo,FAlias,FOrderRector,FPOHighPrice,FPOHghPrcMnyType,FWWHghPrc,FWWHghPrcMnyType,FSOLowPrc,FSOLowPrcMnyType,FIsSale,FProfitRate,FOrderPrice,FSalePrice,FIsSpecialTax,FISKFPeriod,FKFPeriod,FStockTime,FBatchManager,FBookPlan,FBeforeExpire,FCheckCycUnit,FOIHighLimit,FOILowLimit,FSOHighLimit,FSOLowLimit,FInHighLimit,FInLowLimit,FTrack,FPlanPrice,FPriceDecimal,FAcctID,FSaleAcctID,FCostAcctID,FAPAcctID,FAdminAcctID,FGoodSpec,FTaxRate,FCostProject,FIsSNManage,FNote,FPlanTrategy,FOrderTrategy,FFixLeadTime,FLeadTime,FTotalTQQ,FOrderInterVal,FQtyMin,FQtyMax,FBatchAppendQty,FOrderPoint,FBatFixEconomy,FBatChangeEconomy,FRequirePoint,FPlanPoint,FDefaultRoutingID,FDefaultWorkTypeID,FProductPrincipal,FPlanner,FPutInteger,FDailyConsume,FMRPCon,FMRPOrder,FChartNumber,FIsKeyItem,FGrossWeight,FNetWeight, FMaund,FLength, FWidth, FHeight,  FSize,FCubicMeasure,FStandardCost,FStandardManHour,FStdPayRate,FChgFeeRate,FStdFixFeeRate,FOutMachFee,FPieceRate,FInspectionLevel,FProChkMde,FWWChkMde,FSOChkMde,FWthDrwChkMde,FStkChkMde,FOtherChkMde,FStkChkPrd,FStkChkAlrm,FInspectionProject,FIdentifier,FVersion,FNameEn,FModelEn,FHSNumber,FFirstUnit,FSecondUnit,FImpostTaxRate,FConsumeTaxRate,FFirstUnitRate,FSecondUnitRate,FIsManage,FManageType,FLenDecimal,FCubageDecimal,FWeightDecimal,FIsCharSourceItem,FShortNumber, FNumber, FName, FParentID, FItemID)   
	select top 1          NULL,     @fmodel,  0,          2,        FTypeID,FUnitGroupID,FUnitID,FOrderUnitID,FSaleUnitID,FProductUnitID,FStoreUnitID,FSecUnitID,FSecCoefficient,  FDefaultLoc,FSPID,176,    F_136,F_114,F_115,25952,0,    '0*0*0','0*0*0',F_140, FQtyDecimal,FLowLimit,FHighLimit,FSecInv,FUseState,FIsEquipment,FEquipmentNum,FIsSparePart,@ffullname, FApproveNo,FAlias,FOrderRector,FPOHighPrice,FPOHghPrcMnyType,FWWHghPrc,FWWHghPrcMnyType,FSOLowPrc,FSOLowPrcMnyType,FIsSale,FProfitRate,FOrderPrice,FSalePrice,FIsSpecialTax,FISKFPeriod,FKFPeriod,FStockTime,FBatchManager,FBookPlan,FBeforeExpire,FCheckCycUnit,FOIHighLimit,FOILowLimit,FSOHighLimit,FSOLowLimit,FInHighLimit,FInLowLimit,FTrack,FPlanPrice,FPriceDecimal,FAcctID,FSaleAcctID,FCostAcctID,FAPAcctID,FAdminAcctID,FGoodSpec,FTaxRate,FCostProject,FIsSNManage,FNote,FPlanTrategy,FOrderTrategy,FFixLeadTime,FLeadTime,FTotalTQQ,FOrderInterVal,FQtyMin,FQtyMax,FBatchAppendQty,FOrderPoint,FBatFixEconomy,FBatChangeEconomy,FRequirePoint,FPlanPoint,FDefaultRoutingID,FDefaultWorkTypeID,FProductPrincipal,FPlanner,FPutInteger,FDailyConsume,FMRPCon,FMRPOrder,FChartNumber,FIsKeyItem,FGrossWeight,FNetWeight, FMaund,FLength, FWidth, FHeight,  FSize,FCubicMeasure,FStandardCost,FStandardManHour,FStdPayRate,FChgFeeRate,FStdFixFeeRate,FOutMachFee,FPieceRate,FInspectionLevel,FProChkMde,FWWChkMde,FSOChkMde,FWthDrwChkMde,FStkChkMde,FOtherChkMde,FStkChkPrd,FStkChkAlrm,FInspectionProject,FIdentifier,FVersion,FNameEn,FModelEn,FHSNumber,FFirstUnit,FSecondUnit,FImpostTaxRate,FConsumeTaxRate,FFirstUnitRate,FSecondUnitRate,FIsManage,FManageType,FLenDecimal,FCubageDecimal,FWeightDecimal,FIsCharSourceItem,@FShortNumber,@FNumber,@FName,@FParentID,@FItemID
	from t_icitem where fnumber like left(@FParentNumber,1)+'.%'

	exec cbAddCostObj @fitemid,0

	if not exists (select 1 from t_BaseProperty where FItemID=@fitemid)
	begin
		Insert Into t_BaseProperty(FTypeID, FItemID,  FCreateDate, FCreateUser, FLastModDate, FLastModUser, FDeleteDate, FDeleteUser)
				    Values(4,       @fitemid, getdate(),   @fusername,  Null,         Null,         Null,        Null)
	end
end

if not exists(select 1 from icbom where fitemid=@fitemid) and @fitemid<>0
begin
	exec GetICMaxNum 'icbom', @InterID output

	-- 10.4
	Update t_BillCodeRule Set FReChar = FReChar Where FBillTypeID =50

	SET @TmpID = (SELECT FID FROM t_BillCodeRule WITH(READUNCOMMITTED) WHERE fbilltypeid=50 and fprojectid=3)

	update t_billcoderule set fprojectval = fprojectval+1,flength=case when (flength-len(fprojectval)) >= 0 then flength else len(fprojectval) end where FID =  @TmpID 
	Update ICBillNo Set FCurNo = (select top 1 isnull(fprojectval,1) from t_billcoderule where fprojectid = 3 and fbilltypeid =50) where fbillid = 50
	   
	--长度和目前编码
	select @fprojectval=(fprojectval-1),@iLength=flength from t_BillCodeRule where fprojectid = 3 and fbilltypeid = 50

	-- 前缀
	select @BillNo=fprojectval+left('0000000000',@iLength-(len(@fprojectval)))+@fprojectval from t_BillCodeRule where fprojectid = 1 and fbilltypeid = 50  --@iLength

	INSERT INTO ICBomChild (FInterID,FEntryID,FBrNo,FItemID,       FMachinePos,FNote,FAuxQty,FScrap,FOffSetDay,FUnitID,FQty, FMaterielType,FMarshalType,FBeginDay,   FEndDay,     FPercent,FPositionNo,FItemSize,FItemSuite,FOperSN,FOperID,FBackFlush,FStockID,   FSPID,FAuxPropID,FPDMImportDate,FDetailID) 
	select                  @InterID,1,       '0',  @FSourceItemID,'',         '',   1,      0,     0,         FUnitID,1,    371,          385,         '1900-01-01','2100-01-01',100,     '',         '',       '',        '',     0,      1059,      fdefaultloc,0,    0,         null,          NEWID() 
	from t_icitem where fitemid=@FSourceItemID

	Update t1 set t1.FQty=cast(t1.FAuxQty as decimal(28,15)) * cast( isnull(t3.FCoefficient,1)  + cast(isnull(t3.FScale,0) as float) as decimal(28,15) )
	from ICBOMChild  t1,t_MeasureUnit t3
	Where t1.FInterID=@InterID and fentryid=1 and t3.FItemID = t1.FUnitID 

	select top 1 @fbomgroupid=t2.FParentID
	from t_icitem t1 
	inner join icbom t2 on t1.fitemid=t2.fitemid 
	where t1.fnumber like left(@FParentNumber,1)+'.%'
		
	INSERT INTO ICBom(fcheckerid,FInterID, FBomNumber,FItemID, FOperatorID,FEnterTime,FBrNo,FTranType,FCancellation,FStatus,FVersion,FUseStatus,FUnitID,FAuxPropID,FAuxQty,fqty,FYield,FNote,FCheckID,FCheckDate,FRoutingID,FBomType,FCustID,FParentID,   FAudDate,FImpMode,FPDMImportDate,FBOMSkip) 
	select            @fuserid,  @InterID, @BillNo,   @FItemID,@fuserid,   @fdate,    '0',  50,       0,            1,      '',      1072,      FUnitID,0,         1,      1,   100,   '',   @fuserid,@fdate,    0,         0,       0,      @fbomgroupid,@fdate,  0,       null,          1059
	from t_icitem where fitemid=@fitemid
end

set nocount off

go


--办公用品领用申请单触发器--未关联数
IF EXISTS (select * from sysobjects where name='t_BOSOfficeOutRequest_Update'  and xtype='TR')  drop  TRIGGER t_BOSOfficeOutRequest_Update
go

create trigger t_BOSOfficeOutRequest_Update on t_BOSOfficeOutRequest
after update
as
set nocount on

declare @fstatus int,@finterid int,@FChecker int
select @finterid=fid,@FChecker=isnull(FChecker,0) from inserted

update m2 set fnooutstockqty=m2.fqty-m2.FCommitQty
from t_BOSOfficeOutRequestEntry m2 
inner join t_BOSOfficeOutRequest m3 on m2.fid=m3.fid
where m3.fid=@finterid

if update(FChecker) and @FChecker>0
begin
	update m2 set finvqty=cast(isnull(m4.fqty,0) as decimal(24,2))
	from t_BOSOfficeOutRequestEntry m2 
	inner join t_BOSOfficeOutRequest m3 on m2.fid=m3.fid
	left join (select t1.fitemid,sum(t1.fqty) fqty from icinventory t1 inner join t_stock t2 on t1.fstockid=t2.fitemid where t2.fname not like '不良%' group by t1.fitemid) m4 on m4.fitemid=m2.fitemid
	where m3.fid=@finterid  
end

go


IF not EXISTS (select * from sysobjects where name='My_t_PIDataChangeList' and xtype='u')  --drop  Table My_t_PIDataChangeList
begin
	create table My_t_PIDataChangeList(finterid int,fuserid int,fdate datetime,folddate datetime,fnowdate datetime,fnote varchar(500)) 
end

go


-------------------------------------------------
--select * from dbo.ICTransactionType
--插件--BOS新单据在BOS中设置即可

if not exists(select * from t_thirdpartycomponent where ftypedetailid=10 and fcomponentname like 'MyNewWay.clsBOM')
begin
	insert into t_thirdpartycomponent (ftypeid,ftypedetailid,findex,fcomponentname)
	values (0,50,100,'MyNewWay.clsBOM')
end


if not exists(select * from t_thirdpartycomponent where ftypedetailid=10 and fcomponentname like 'MyNewWay.clsICStock10')
begin
	insert into t_thirdpartycomponent (ftypeid,ftypedetailid,findex,fcomponentname)
	values (0,10,100,'MyNewWay.clsICStock10')
end

if not exists(select * from t_thirdpartycomponent where ftypedetailid=88 and fcomponentname like 'MyNewWay.clsPPBomList')
begin
	insert into t_thirdpartycomponent (ftypeid,ftypedetailid,findex,fcomponentname)
	values (0,88,100,'MyNewWay.clsPPBomList')
end

if not exists(select * from t_thirdpartycomponent where ftypedetailid=87 and fcomponentname like 'MyNewWay.clsPPOrder')
begin
	insert into t_thirdpartycomponent (ftypeid,ftypedetailid,findex,fcomponentname)
	values (0,87,100,'MyNewWay.clsPPOrder')
end

if not exists(select * from t_thirdpartycomponent where ftypedetailid=71 and fcomponentname like 'MyNewWay.clsPOOrder')
begin
	insert into t_thirdpartycomponent (ftypeid,ftypedetailid,findex,fcomponentname)
	values (0,71,100,'MyNewWay.clsPOOrder')
end

if not exists(select * from t_thirdpartycomponent where ftypedetailid=72 and fcomponentname like 'MyNewWay.clsPOInStock')
begin
	insert into t_thirdpartycomponent (ftypeid,ftypedetailid,findex,fcomponentname)
	values (0,72,100,'MyNewWay.clsPOInStock')
end

if not exists(select * from t_thirdpartycomponent where ftypedetailid=81 and fcomponentname like 'MyNewWay.clsSeOrder')
begin
	insert into t_thirdpartycomponent (ftypeid,ftypedetailid,findex,fcomponentname)
	values (0,81,100,'MyNewWay.clsSeOrder')
end

if not exists(select * from t_thirdpartycomponent where ftypedetailid=21 and fcomponentname like 'MyNewWay.clsICStock21')
begin
	insert into t_thirdpartycomponent (ftypeid,ftypedetailid,findex,fcomponentname)
	values (0,21,100,'MyNewWay.clsICStock21')
end

if not exists(select * from t_thirdpartycomponent where ftypedetailid=1 and fcomponentname like 'MyNewWay.clsICStock1')
begin
	insert into t_thirdpartycomponent (ftypeid,ftypedetailid,findex,fcomponentname)
	values (0,1,100,'MyNewWay.clsICStock1')
end

if not exists(select * from t_thirdpartycomponent where ftypedetailid=24 and fcomponentname like 'MyNewWay.clsICStock24')
begin
	insert into t_thirdpartycomponent (ftypeid,ftypedetailid,findex,fcomponentname)
	values (0,24,100,'MyNewWay.clsICStock24')
end

if not exists(select * from t_thirdpartycomponent where ftypedetailid=29 and fcomponentname like 'MyNewWay.clsICStock29')
begin
	insert into t_thirdpartycomponent (ftypeid,ftypedetailid,findex,fcomponentname)
	values (0,29,100,'MyNewWay.clsICStock29')
end

if not exists(select * from t_thirdpartycomponent where ftypedetailid=41 and fcomponentname like 'MyNewWay.clsICStock41')
begin
	insert into t_thirdpartycomponent (ftypeid,ftypedetailid,findex,fcomponentname)
	values (0,41,100,'MyNewWay.clsICStock41')
end

if not exists(select * from t_thirdpartycomponent where ftypedetailid=26 and fcomponentname like 'MyNewWay.clsZPStock26')
begin
	insert into t_thirdpartycomponent (ftypeid,ftypedetailid,findex,fcomponentname)
	values (0,26,100,'MyNewWay.clsZPStock26')
end

if not exists(select * from t_thirdpartycomponent where ftypedetailid=83 and fcomponentname like 'MyNewWay.clsSeOutStock')
begin
	insert into t_thirdpartycomponent (ftypeid,ftypedetailid,findex,fcomponentname)
	values (0,83,100,'MyNewWay.clsSeOutStock')
end

if not exists(select * from t_thirdpartycomponent where ftypedetailid=70 and fcomponentname like 'MyNewWay.clsPORequest')
begin
	insert into t_thirdpartycomponent (ftypeid,ftypedetailid,findex,fcomponentname)
	values (0,70,100,'MyNewWay.clsPORequest')
end



go


IF EXISTS (select * from sysobjects where name='My_p_InsertObjectType' and xtype='p')  drop  procedure My_p_InsertObjectType


go


create procedure My_p_InsertObjectType (@ObjectTypeName varchar(50))

as
set nocount on

declare @MaxObjectId  int

select @MaxObjectId=isnull(max(fobjectid),0) from t_objecttype where fobjecttype=99999

if  @MaxObjectId=0
begin 
	insert into t_objecttype(fobjecttype,fobjectid,fname) values (99999,0,'二次开发')
end

if not exists (select * from t_objecttype where fobjecttype=99999 and fname=@ObjectTypeName)
begin
	set @MaxObjectId=@MaxObjectId+1
	insert into t_objecttype(fobjecttype,fobjectid,fname) values (99999,@MaxObjectId,@ObjectTypeName)
end

--select * from t_objecttype where fobjecttype=99999

set nocount off

go


IF EXISTS (select * from sysobjects where name='My_p_InsertObjectAccessType' and xtype='p')  drop  procedure My_p_InsertObjectAccessType


go


create procedure My_p_InsertObjectAccessType(@ObjectTypeName varchar(200),@AccessuseName varchar(200))

as

declare @ObjectId int --权限类型属于权限对象
declare @MaxIndex int
declare @Maxaccessmask int

set @ObjectId=0
set @Maxaccessmask=0

select @ObjectId=fobjectid from t_objecttype where fobjecttype=99999 and fname=@ObjectTypeName

if @ObjectId>0
begin
	select @MaxIndex=isnull(max(findex),0)+1,@Maxaccessmask=isnull(min(faccessmask),0) from t_objectaccesstype 
	where fobjecttype=99999 and fobjectid=@ObjectId

	If @Maxaccessmask = 0 
	begin
		set @Maxaccessmask = 1073741824
	End
	else
	begin 
		set @Maxaccessmask = @Maxaccessmask / 2
		If @Maxaccessmask = 524288 
		begin 
			set @Maxaccessmask = @Maxaccessmask / 4
		End
	end
	
	if not exists (select * from t_ObjectAccessType where fobjecttype=99999 and fobjectid=@ObjectId and fname=@AccessuseName)
	begin
		insert into t_ObjectAccessType(fobjecttype,fobjectid,findex,faccessmask,faccessuse,fname)
		values(99999,@ObjectId,@MaxIndex,@Maxaccessmask,0,@AccessuseName)
	end
end

go


--权限定义

exec My_p_InsertObjectType '生产排程'
exec My_p_InsertObjectType '[成品]MRP计算'
exec My_p_InsertObjectType '[半成品]MRP计算'
exec My_p_InsertObjectType '订单进度跟踪表'
exec My_p_InsertObjectType '订单进度跟踪表二'
exec My_p_InsertObjectType '[成品]领料单'
exec My_p_InsertObjectType '[半成品]领料单'
exec My_p_InsertObjectType '日计划领料单'
exec My_p_InsertObjectType '日计划调拨单'
exec My_p_InsertObjectType '包装车间生产日计划打印'
exec My_p_InsertObjectType '发货通知单'
exec My_p_InsertObjectType '收料通知单'
exec My_p_InsertObjectType '销售订单'
exec My_p_InsertObjectType '销售订单二'
exec My_p_InsertObjectType '销售订单三'
exec My_p_InsertObjectType '[包材]MRP计算'
exec My_p_InsertObjectType '采购价格联络'
exec My_p_InsertObjectType '销售价格联络'
exec My_p_InsertObjectType '物料信息变更一'
exec My_p_InsertObjectType '标准成本变更联络'
exec My_p_InsertObjectType '其它出库'
exec My_p_InsertObjectType '物料对应'
exec My_p_InsertObjectType '生产领料单'
exec My_p_InsertObjectType '生产任务单'
exec My_p_InsertObjectType '虚仓出库单'
exec My_p_InsertObjectType '调拨单'
exec My_p_InsertObjectType '生产任务单二'
exec My_p_InsertObjectType '包装方案'
exec My_p_InsertObjectType '包装方案批量变更'
exec My_p_InsertObjectType 'BOM批量变更'
exec My_p_InsertObjectType '生产计划'
exec My_p_InsertObjectType '收料计划'
exec My_p_InsertObjectType '[常规物料]MRP计算'
exec My_p_InsertObjectType '计划投料单'
exec My_p_InsertObjectType '包材文件管理'
exec My_p_InsertObjectType '销售订单变更'
exec My_p_InsertObjectType '配件批量新增'
exec My_p_InsertObjectType '采购订单'
exec My_p_InsertObjectType '生产任务单三'
exec My_p_InsertObjectType 'BOM'
exec My_p_InsertObjectType '物料'
exec My_p_InsertObjectType '物料代替'
exec My_p_InsertObjectType '物料信息变更二'
exec My_p_InsertObjectType '存货核算'

exec My_p_InsertObjectAccessType '生产排程','查看'
exec My_p_InsertObjectAccessType '生产排程','编辑'
exec My_p_InsertObjectAccessType '生产排程','导入'

exec My_p_InsertObjectAccessType '[成品]MRP计算','查看'
exec My_p_InsertObjectAccessType '[成品]MRP计算','编辑'
exec My_p_InsertObjectAccessType '[成品]MRP计算','导入'
exec My_p_InsertObjectAccessType '[成品]MRP计算','审核'

exec My_p_InsertObjectAccessType '[半成品]MRP计算','查看'
exec My_p_InsertObjectAccessType '[半成品]MRP计算','编辑'
exec My_p_InsertObjectAccessType '[半成品]MRP计算','导入'
exec My_p_InsertObjectAccessType '[半成品]MRP计算','审核'

exec My_p_InsertObjectAccessType '订单进度跟踪表','查看'
exec My_p_InsertObjectAccessType '订单进度跟踪表','编辑'
exec My_p_InsertObjectAccessType '订单进度跟踪表','引出'
exec My_p_InsertObjectAccessType '订单进度跟踪表','查看客户'

exec My_p_InsertObjectAccessType '订单进度跟踪表二','打印'
exec My_p_InsertObjectAccessType '订单进度跟踪表二','客供包材编辑'
exec My_p_InsertObjectAccessType '订单进度跟踪表二','工厂包材编辑'
exec My_p_InsertObjectAccessType '订单进度跟踪表二','更新计划开工日期'

exec My_p_InsertObjectAccessType '[成品]领料单','编辑'
exec My_p_InsertObjectAccessType '[半成品]领料单','编辑'

exec My_p_InsertObjectAccessType '日计划领料单','编辑'
exec My_p_InsertObjectAccessType '日计划领料单','查询'
exec My_p_InsertObjectAccessType '日计划领料单','倒冲查询'
exec My_p_InsertObjectAccessType '日计划领料单','非倒冲查询'

exec My_p_InsertObjectAccessType '日计划调拨单','编辑'
exec My_p_InsertObjectAccessType '日计划调拨单','查询'

exec My_p_InsertObjectAccessType '包装车间生产日计划打印','查询'

exec My_p_InsertObjectAccessType '发货通知单','出库方式变更'
exec My_p_InsertObjectAccessType '发货通知单','获取修改权限'--

exec My_p_InsertObjectAccessType '收料通知单','入库方式变更'
exec My_p_InsertObjectAccessType '收料通知单','获取修改权限'--
exec My_p_InsertObjectAccessType '收料通知单','编辑'--

exec My_p_InsertObjectAccessType '销售订单','傲威销售订单导入'
exec My_p_InsertObjectAccessType '销售订单','附件上传'
exec My_p_InsertObjectAccessType '销售订单','附件查看'
exec My_p_InsertObjectAccessType '销售订单','附件删除'

exec My_p_InsertObjectAccessType '销售订单二','超威销售订单导入'
exec My_p_InsertObjectAccessType '销售订单二','重新生成包材发料通知'
exec My_p_InsertObjectAccessType '销售订单二','重新生成计划投料单'
exec My_p_InsertObjectAccessType '销售订单二','销售价格查询'

exec My_p_InsertObjectAccessType '销售订单三','产品配置'
exec My_p_InsertObjectAccessType '销售订单三','泰格销售订单导入'

exec My_p_InsertObjectAccessType '[包材]MRP计算','查看'
exec My_p_InsertObjectAccessType '[包材]MRP计算','编辑'
exec My_p_InsertObjectAccessType '[包材]MRP计算','导入'
exec My_p_InsertObjectAccessType '[包材]MRP计算','审核'

exec My_p_InsertObjectAccessType '采购价格联络','查看'
exec My_p_InsertObjectAccessType '采购价格联络','编辑'
exec My_p_InsertObjectAccessType '采购价格联络','审核'
exec My_p_InsertObjectAccessType '采购价格联络','引出'

exec My_p_InsertObjectAccessType '销售价格联络','查看'
exec My_p_InsertObjectAccessType '销售价格联络','编辑'
exec My_p_InsertObjectAccessType '销售价格联络','审核'
exec My_p_InsertObjectAccessType '销售价格联络','引出'

exec My_p_InsertObjectAccessType '物料信息变更一','基本信息'
exec My_p_InsertObjectAccessType '物料信息变更一','装箱资料'
exec My_p_InsertObjectAccessType '物料信息变更一','来源'
exec My_p_InsertObjectAccessType '物料信息变更一','计件单价'  

exec My_p_InsertObjectAccessType '标准成本变更联络','查看'
exec My_p_InsertObjectAccessType '标准成本变更联络','编辑'
exec My_p_InsertObjectAccessType '标准成本变更联络','审核'
exec My_p_InsertObjectAccessType '标准成本变更联络','引出'

exec My_p_InsertObjectAccessType '其它出库','变更使用人'
exec My_p_InsertObjectAccessType '其它出库','欠数拆分'--
exec My_p_InsertObjectAccessType '其它出库','批量打印'--
exec My_p_InsertObjectAccessType '其它出库','获取修改权限'--

exec My_p_InsertObjectAccessType '物料对应','傲威物料对应'
exec My_p_InsertObjectAccessType '物料对应','超威物料对应'

exec My_p_InsertObjectAccessType '生产领料单','批量生成'
exec My_p_InsertObjectAccessType '生产领料单','欠数拆分'
exec My_p_InsertObjectAccessType '生产领料单','批量打印'
exec My_p_InsertObjectAccessType '生产领料单','获取修改权限'--

exec My_p_InsertObjectAccessType '生产任务单','批量更新计划开工日期'
exec My_p_InsertObjectAccessType '生产任务单','批量生成领料单'
exec My_p_InsertObjectAccessType '生产任务单','批量生成调拨单'
exec My_p_InsertObjectAccessType '生产任务单','下达/反下达'

exec My_p_InsertObjectAccessType '虚仓出库单','欠数拆分'
exec My_p_InsertObjectAccessType '虚仓出库单','批量打印'
exec My_p_InsertObjectAccessType '虚仓出库单','获取修改权限'--

exec My_p_InsertObjectAccessType '调拨单','欠数拆分'
exec My_p_InsertObjectAccessType '调拨单','批量打印'
exec My_p_InsertObjectAccessType '调拨单','获取修改权限'--

exec My_p_InsertObjectAccessType '生产任务单二','汇报'
exec My_p_InsertObjectAccessType '生产任务单二','入库'
exec My_p_InsertObjectAccessType '生产任务单二','投料单批量维护'
exec My_p_InsertObjectAccessType '生产任务单二','重新生成投料单'


exec My_p_InsertObjectAccessType '包装方案','包装方式批量更新'
exec My_p_InsertObjectAccessType '包装方案','确认'

exec My_p_InsertObjectAccessType '包装方案批量变更','查看'
exec My_p_InsertObjectAccessType '包装方案批量变更','编辑'
exec My_p_InsertObjectAccessType '包装方案批量变更','审核'
exec My_p_InsertObjectAccessType '包装方案批量变更','变更'

exec My_p_InsertObjectAccessType 'BOM批量变更','查看'
exec My_p_InsertObjectAccessType 'BOM批量变更','编辑'
exec My_p_InsertObjectAccessType 'BOM批量变更','审核'
exec My_p_InsertObjectAccessType 'BOM批量变更','变更'

exec My_p_InsertObjectAccessType '生产计划','查看'
exec My_p_InsertObjectAccessType '生产计划','编辑'
exec My_p_InsertObjectAccessType '生产计划','审核'

exec My_p_InsertObjectAccessType '收料计划','查看'
exec My_p_InsertObjectAccessType '收料计划','编辑'
exec My_p_InsertObjectAccessType '收料计划','审核'
exec My_p_InsertObjectAccessType '收料计划','厂商可见'

exec My_p_InsertObjectAccessType '[常规物料]MRP计算','查看'
exec My_p_InsertObjectAccessType '[常规物料]MRP计算','编辑'
exec My_p_InsertObjectAccessType '[常规物料]MRP计算','导入'
exec My_p_InsertObjectAccessType '[常规物料]MRP计算','审核'

exec My_p_InsertObjectAccessType '计划投料单','新增'

exec My_p_InsertObjectAccessType '包材文件管理','查看'
exec My_p_InsertObjectAccessType '包材文件管理','下载'
exec My_p_InsertObjectAccessType '包材文件管理','查看源文件'

exec My_p_InsertObjectAccessType '销售订单变更','跟单'  --变更单价、币别、客户的权限
exec My_p_InsertObjectAccessType '销售订单变更','包装'  --有第一次填写包装方式的权限
exec My_p_InsertObjectAccessType '销售订单变更','物控'  --有变更包装方式、芯片版本的权限
exec My_p_InsertObjectAccessType '销售订单变更','查看单价'  --

exec My_p_InsertObjectAccessType '配件批量新增','编辑'  --

exec My_p_InsertObjectAccessType '采购订单','单价变更'  --
exec My_p_InsertObjectAccessType '采购订单','采购价格趋势分析'  --

exec My_p_InsertObjectAccessType '生产任务单三','刷新投料单(包材)'
exec My_p_InsertObjectAccessType '生产任务单三','刷新投料单(非包材)'
exec My_p_InsertObjectAccessType '生产任务单三','更新生产车间'

exec My_p_InsertObjectAccessType 'BOM','确认(包材)'
exec My_p_InsertObjectAccessType 'BOM','确认(非包材)'

exec My_p_InsertObjectAccessType '物料','批量维护'

exec My_p_InsertObjectAccessType '物料代替','查看'
exec My_p_InsertObjectAccessType '物料代替','设置'
exec My_p_InsertObjectAccessType '物料代替','分析'

exec My_p_InsertObjectAccessType '物料信息变更二','安全库存' 
exec My_p_InsertObjectAccessType '物料信息变更二','产品分级'  
exec My_p_InsertObjectAccessType '物料信息变更二','重量' 

exec My_p_InsertObjectAccessType '存货核算','对账单价更新'  --

go

--select t1.fname,t1.fobjecttype,t1.fobjectid,t2.findex,t2.fname from t_ObjectType t1 inner join t_ObjectAccessType t2 on t1.fobjecttype=t2.fobjecttype and t1.fobjectid=t2.fobjectid where t1.fobjecttype=99999

--delete t1 from t_ObjectAccessType t1 where fobjecttype=99999 and t1.fobjectid=39 and t1.findex=1

/*

delete from t_DataFlowTimeStamp  --MyNewWay 写成了 MyKingWay,改过后也要执行此语句

--select * from t_DataFlowSubFunc where ffuncname like '%预测%'  [FSubFuncID]>=17000  --仓库

--父级菜单
delete from t_DataFlowSubFunc where [FSubFuncID] in (19003,19030)

select * 
--update t1 set ffuncname='生产计划',FFuncName_CHT='生产计划',,FFuncName_EN='生产计划'
from t_DataFlowSubFunc t1 where  [FSubFuncID] in (19003,19030)


INSERT INTO [t_DataFlowSubFunc]([FSubFuncID], [FSubSysID], [FIndex], [FFuncName],     [FFuncName_CHT], [FFuncName_EN],     [FClassName], [FClassParam], [FVisible], [FAcctType], [FFuncType], [FRefresh], [FSetEnable], [FSubID], [FIsEdit])
select                          19028	,     22	,      1	,    '对账-单价更新'	, '对账-单价更新'	,  '对账-单价更新'	,  '',           '',	        1	,       '',          0	,         0	,         0	,	        'cg',     1


select                          19003	,     23	,      2	,    '珠海傲威科技订单导入', '珠海傲威科技订单导入' ,'珠海傲威科技订单导入'	,  '',           '',	        1	,       '',          0	,         0	,         0	,	        'xs',     1
union all
select                          19030	,     23	,      2	,    '香港傲威科技订单导入', '香港傲威科技订单导入' ,'香港傲威科技订单导入'	,  '',           '',	        1	,       '',          0	,         0	,         0	,	        'xs',     1


select                          19039	,     25	,      3	,    '条码管理'	, '条码管理'	,  '条码管理'	,      '',           '',	        1	,       '',          0	,         0	,         0	,	        'xs',     1

select                          19038	,     139	,      2	,    '物料替代设置'	, '物料替代设置'	,  '物料替代设置'	,  '',           '',	        1	,       '',          0	,         0	,         0	,	        'cg',     1

select                          19017	,     21	,      2	,    '产品入库|汇报'	, '产品入库|汇报'	,  '产品入库|汇报'	,  '',           '',	        1	,       '',          0	,         0	,         0	,	        'cg',     1

select                          19037	,     25	,      3	,    '物料批量维护'	, '物料批量维护'	,  '物料批量维护'	,      '',           '',	        1	,       '',          0	,         0	,         0	,	        'xs',     1

select                          19036	,     139	,      2	,    '物料替代分析'	, '物料替代分析'	,  '物料替代分析'	,  '',           '',	        1	,       '',          0	,         0	,         0	,	        'cg',     1

-- select                          19035	,     139	,      1	,    '工序汇报查询'	, '工序汇报查询'	,  '工序汇报查询'	,  '',           '',	        1	,       '',          0	,         0	,         0	,	        'cg',     1
-- union all
-- select                          19034	,     139	,      1	,    '产品组装查询'	, '产品组装查询'	,  '产品组装查询'	,  '',           '',	        1	,       '',          0	,         0	,         0	,	        'cg',     1
-- union all
-- select                          19033	,     139	,      1	,    '工序汇报'	, '工序汇报'	,  '工序汇报'	,  '',           '',	        1	,       '',          0	,         0	,         0	,	        'cg',     1
-- union all
-- select                          19032	,     139	,      1	,    '产品组装'	, '产品组装'	,  '产品组装'	,  '',           '',	        1	,       '',          0	,         0	,         0	,	        'cg',     1

select                          19031	,     20	,      4	,    '采购价格趋势分析'	, '采购价格趋势分析',  '采购价格趋势分析'	,  '',           '',	        1	,       '',          0	,         0	,         0	,	        'cg',     1


select                          19029	,     25	,      3	,    '配件批量新增'	, '配件批量新增'	,  '配件批量新增'	,      '',           '',	        1	,       '',          0	,         0	,         0	,	        'xs',     1

select                          19026	,     23	,      1	,    '用户冲突'	, '用户冲突'	,  '用户冲突'	,      '',           '',	        1	,       '',          0	,         0	,         0	,	        'xs',     1
union all
select                          19025	,     47	,      2	,    '成品生产投料单-打印'	, '成品生产投料单-打印',  '成品生产投料单-打印'	,  '',           '',	        1	,       '',          0	,         0	,         0	,	        'cg',     1
union all
select                          19024	,     20	,      2	,    '收料计划-排程'	, '收料计划-排程',  '收料计划-排程'	,  '',           '',	        1	,       '',          0	,         0	,         0	,	        'cg',     1
union all
select                          19023	,     139	,      1	,    '生产计划-排产'	, '生产计划-排产'	,  '生产计划-排产'	,  '',           '',	        1	,       '',          0	,         0	,         0	,	        'cg',     1
union all
select                          19022	,     20	,      2	,    '收料计划'	, '收料计划',  '收料计划'	,  '',           '',	        1	,       '',          0	,         0	,         0	,	        'cg',     1
union all
select                          19021	,     139	,      1	,    '生产计划'	, '生产计划'	,  '生产计划'	,  '',           '',	        1	,       '',          0	,         0	,         0	,	        'cg',     1

union all
select                          19020	,     25	,      3	,    'BOM批量变更'	, 'BOM批量变更'	,  'BOM批量变更'	,      '',           '',	        1	,       '',          0	,         0	,         0	,	        'xs',     1
union all
select                          19019	,     25	,      3	,    '包装方案批量变更'	, '包装方案批量变更'	,  '包装方案批量变更'	,      '',           '',	        1	,       '',          0	,         0	,         0	,	        'xs',     1
union all
select                          19018	,     23	,      2	,    '销售价格查询'	, '销售价格查询'  ,'销售价格查询'	,  '',           '',	        1	,       '',          0	,         0	,         0	,	        'xs',     1
union all

select                          19016	,     21	,      21	,    '物料欠数查询'	, '物料欠数查询'	,  '物料欠数查询'	,  '',           '',	        1	,       '',          0	,         0	,         0	,	        'cg',     1
union all
select                          19015	,     23	,      2	,    '超威产品对应表', '超威产品对应表' ,'超威产品对应表'	,  '',           '',	        1	,       '',          0	,         0	,         0	,	        'xs',     1
union all
select                          19014	,     23	,      2	,    '傲威产品对应表', '傲威产品对应表' ,'傲威产品对应表'	,  '',           '',	        1	,       '',          0	,         0	,         0	,	        'xs',     1
union all
select                          19008	,     23	,      2	,    '标准成本变更联络'	, '标准成本变更联络'  ,'标准成本变更联络'	,  '',           '',	        1	,       '',          0	,         0	,         0	,	        'xs',     1
union all
select                          19007	,     23	,      2	,    '销售价格联络'	, '销售价格联络'  ,'销售价格联络'	,  '',           '',	        1	,       '',          0	,         0	,         0	,	        'xs',     1
union all
select                          19006	,     20	,      2	,    '采购价格联络'	, '采购价格联络',  '采购价格联络'	,  '',           '',	        1	,       '',          0	,         0	,         0	,	        'cg',     1
union all
select                          19004	,     23	,      2	,    '超威订单导入', '超威订单导入' ,'超威订单导入'	,  '',           '',	        1	,       '',          0	,         0	,         0	,	        'xs',     1
union all
select                          19002	,     23	,      2	,    '订单进度跟踪表', '订单进度跟踪表' ,'订单进度跟踪表'	,  '',           '',	        1	,       '',          0	,         0	,         0	,	        'xs',     1
union all
--select                        18002	,     139	,      3	,    '[半成品]MRP计算'	, '[半成品]MRP计算'	,  '[半成品]MRP计算'	,  '',           '',	        1	,       '',          0	,         0	,         0	,	        'cg',     1
--union all
select                          18001	,     139	,      2	,    'MRP计算'	, 'MRP计算'	,  'MRP计算'	,  '',           '',	        1	,       '',          0	,         0	,         0	,	        'cg',     1
union all
select                          18000	,     139	,      1	,    '生产排程明细'	, '生产排程明细'	,  '生产排程明细'	,  '',           '',	        1	,       '',          0	,         0	,         0	,	        'cg',     1
union all
select                          17000	,     21	,      2	,    '日计划领料单'	, '日计划领料单'	,  '日计划领料单'	,  '',           '',	        1	,       '',          0	,         0	,         0	,	        'cg',     1


--子级菜单--可以不要上级，直接在子级插入-------------------------
--select * from t_DataFlowDetailFunc where ffuncname like '%预测%' and [FSubFuncID]=19000

--select * from t_DataFlowDetailFunc where [FDetailFuncID] in (99990120)

select * 
--update t1 set ffuncname='生产计划',FFuncName_CHT='生产计划',,FFuncName_EN='生产计划'
from t_DataFlowDetailFunc t1 where [FSubFuncID] in (19032,19033,19034,19035)

delete  from t_DataFlowDetailFunc where [FDetailFuncID] in (99990109,99990132)


INSERT INTO t_DataFlowDetailFunc([FDetailFuncID],     [FFuncName],      [FFuncName_CHT], [FFuncName_EN], [FSubFuncID], [FIndex], [FClassName],          [FClassParam], [FIsNormal], [FHelpCode], [FVisible], [FAcctType], [FFuncType], [FEnable], [FShowName], [FShowName_CHT], [FShowName_EN], [FIsEdit])
select                           99990130,	      '对账-单价更新',	    '对账-单价更新'	,'对账-单价更新'	,19028	,      2	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1


select                           99990109,	      '珠海傲威科技订单导入',	'珠海傲威科技订单导入','珠海傲威科技订单导入',19003	,      2	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1
union all
select                           99990132,	      '香港傲威科技订单导入',	'香港傲威科技订单导入','香港傲威科技订单导入',19030	,      2	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1



select                           99990148,	      '工序',	        '工序'	,        '工序'	,        19039	,      2	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1


select                           99990146,	      '工序汇报',	'工序汇报'	,'工序汇报'	,19039	,      2	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1
union all
select                           99990147,	      '工序汇报-查询',	'工序汇报-查询'	,'工序汇报-查询'	,19039	,      2	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1


select                           99990144,	      '产品组装',	'产品组装'	,'产品组装'	,19039	,      2	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1
union all
select                           99990145,	      '产品组装-查询',	'产品组装-查询'	,'产品组装-查询'	,19039	,      2	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1

select                           99990141,	      '模板设置',	'模板设置'	,'模板设置'	,19039	,      2	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1
union all
select                           99990142,	      '条码查询',	'条码查询'	,'条码查询'	,19039	,      2	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1
union all
select                           99990143,	      '条码打印',	'条码打印'	,'条码打印'	,19039	,      2	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1


union all


select                           99990140,	      '物料替代设置',	'物料替代设置'	,'物料替代设置'	,19038	,      2	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1

select                           99990120,	      '产品入库|汇报',	'产品入库|汇报'	,'产品入库|汇报'	,19017	,      2	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1
union all

select                           99990139,	      '物料批量维护',	'物料批量维护'	,'物料批量维护'	,19037	,      100	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1

select                           99990138,	      '物料替代分析',	'物料替代分析'	,'物料替代分析'	,19036	,      2	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1
-- 
-- select                           99990137,	      '工序汇报查询',	'工序汇报查询'	,'工序汇报查询'	,19035	,      1	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1
-- union all
-- select                           99990136,	      '产品组装查询',	'产品组装查询'	,'产品组装查询'	,19034	,      1	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1
-- union all
-- select                           99990135,	      '工序汇报',	'工序汇报'	,'工序汇报'	,19033	,      1	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1
-- union all
-- select                           99990134,	      '产品组装',	'产品组装'	,'产品组装'	,19032	,      1	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1
-- 

select                           99990133,	      '采购价格趋势分析',	'采购价格趋势分析'	,'采购价格趋势分析'	,19031	,      2	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1

select                           99990132,	      '香港傲威科技订单导入',	'香港傲威科技订单导入','香港傲威科技订单导入',19030	,      2	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1


select                           99990131,	      '配件批量新增',	'配件批量新增'	,'配件批量新增'	,19029	,      100	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1

select                           99990129,	      '用户冲突',	    '用户冲突'	,'用户冲突'	,19026	,      2	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1
union all
select                           99990128,	      '成品生产投料单-打印',	'成品生产投料单-打印'	,'成品生产投料单-打印'	,19025	,      100	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1
union all
select                           99990127,	      '收料计划-排程',	'收料计划-排程'	,'收料计划-排程'	,19024	,      100	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1
union all
select                           99990126,	      '生产计划-排产',	'生产计划-排产'	,'生产计划-排产'	,19023	,      100	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1
union all
select                           99990125,	      '收料计划',	'收料计划'	,'收料计划'	,19022	,      100	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1
union all
select                           99990124,	      '生产计划',	'生产计划'	,'生产计划'	,19021	,      100	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1
union all

select                           99990123,	      'BOM批量变更',	'BOM批量变更'	,'BOM批量变更'	,19020	,      100	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1
union all
select                           99990122,	      '包装方案批量变更',	'包装方案批量变更'	,'包装方案批量变更'	,19019	,      100	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1
union all
select                           99990121,	      '销售价格查询',	'销售价格查询'	,'销售价格查询'	,19018	,      2	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1
union all

select                           99990118,	      '物料欠数查询',	'物料欠数查询'	,'物料欠数查询'	,19016	,      2	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1
union all
select                           99990117,	      '超威产品对应表',	'超威产品对应表','超威产品对应表',19015	,      2	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1
union all
select                           99990116,	      '傲威产品对应表',	'傲威产品对应表','傲威产品对应表',19014	,      2	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1
union all
select                           99990115,	      '标准成本变更联络',	'标准成本变更联络'	,'标准成本变更联络'	,19008	,      2	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1
union all
select                           99990114,	      '销售价格联络',	'销售价格联络'	,'销售价格联络'	,19007	,      2	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1
union all
select                           99990113,	      '采购价格联络',	'采购价格联络'	,'采购价格联络'	,19006	,      2	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1
union all
select                           99990110,	      '超威订单导入',	'超威订单导入','超威订单导入',19004	,      2	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1
union all

--select                           99990108,	      '包装车间生产日计划(成品) - 打印',	'包装车间生产日计划(成品) - 打印'	,'包装车间生产日计划(成品) - 打印'	,13901	,      2	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1
--union all
select                           99990105,	      '订单进度跟踪表',	'订单进度跟踪表','订单进度跟踪表',19002	,      2	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1
union all
--select                           99990103,	      '[半成品]MRP计算',	'[半成品]MRP计算'	,'[半成品]MRP计算'	,18002	,      3	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1
--union all
select                           99990102,	      'MRP计算',	'MRP计算'	,'MRP计算'	,18001	,      2	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1
union all
select                           99990101,	      '生产排程明细',	'生产排程明细'	,'生产排程明细'	,18000	,      1	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1
union all
select                           99990106,	      '日计划领料单',	'日计划领料单'	,'日计划领料单'	,17000	,      2	,     'MyNewWay.MyMenu'	,   ''	,          0	,	    '',          1	,	     '' ,         0	,          1	,     ''	   ,   '',              '',             1

--叙事簿增加一个按钮菜单

select fmenuid,* from iclisttemplate where fid=32

--FBandID 是菜单的位置，1表示放到1级栏目下，2表示放在文件下面，3表示放在编辑下面，4表示放在查看下面，5表示放在格式下面，53表示放在工具栏上，可根据查询的结果来估计位置
--FToolID FID+FTOOLID 是唯一的

--select * from t_MenuToolBar where fname like '%' and ftoolid>=10059 --update t1 set fvisible=0 from t_MenuToolBar t1 where fname like 'fmy%' and ftoolid>=10000

--select FToolID,FName,FCaption,FCaption_CHT,FCaption_EN,FImageName,FToolTip_CHT,FToolTip,FToolTip_EN,FControlType,FBeginGroup,FVisible,FEnable,FChecked,FShortCut,FShortChar,FCBList,FCBList_CHT,FCBList_EN,FCBStyle,FBandID,FSubBandID,FSubBandName,FCBWidth,FBandName,FType,FBandVisible,FBandCaption,FBandCaption_CHT,FBandCaption_EN,FStyle,FComName,FToolCaption,FToolCaption_CHT,FToolCaption_EN from v_tools where FMenuGroupID = 82 order by FBandID,FIndex

10032, 'FMyMenuPrint26','打印 虚仓出库单'
10033, 'FMyMenuPrint29','打印 其他出库单'
10034, 'FMyMenuPrint41','打印 调拨单'
10035, 'FMyMenuPrint24','打印 领料单'
10028, 'FMyMenuGenerateOutStock41','批量生成调拨单[倒冲]'
10026, 'FMyMenuGenerateOutStock24','批量生成领料单'
select * from ictranstype
--delete from t_MenuToolBar where FToolID=10073


insert into t_MenuToolBar ( FToolID,FName,    FCaption,    FCaption_CHT,FCaption_EN,  FImageName,FToolTip,  FToolTip_CHT,FToolTip_EN, FControlType,FVisible,FEnable,FChecked,FShortCut,FCBList,FCBList_CHT,FCBList_EN,FCBStyle,FCBWidth,FIndex,FToolCaption,FToolCaption_CHT,FToolCaption_EN)
select                      10059, 'FMyMenuToICMOFromPP','生成 生产任务单',   '生成 生产任务单',    '生成 生产任务单',     '',        '生成 生产任务单',  '生成 生产任务单',    '生成 生产任务单',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '生成 生产任务单',    '生成 生产任务单',        '生成 生产任务单'

select                      10073, 'FMyMenuGenerateICMOBillNo','刷新单据编号',   '刷新单据编号',    '刷新单据编号',     '',        '刷新单据编号',  '刷新单据编号',    '刷新单据编号',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '刷新单据编号',    '刷新单据编号',        '刷新单据编号'

select                      10072, 'FMyMenuUpdateWorkshop','更新生产车间',   '更新生产车间',    '更新生产车间',     '',        '更新生产车间',  '更新生产车间',    '更新生产车间',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '更新生产车间',    '更新生产车间',        '更新生产车间'

select                      10057, 'FMyMenuBarcodePrint','条码打印',   '条码打印',    '条码打印',     '',        '条码打印',  '条码打印',    '条码打印',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '条码打印',    '条码打印',        '条码打印'

select                      10071, 'FMyMenuRptAndInStock','汇报/入库',   '汇报/入库',    '汇报/入库',     '',        '汇报/入库',  '汇报/入库',    '汇报/入库',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '汇报/入库',    '汇报/入库',        '汇报/入库'

select                      10058, 'FCPPPBomListPrint','生产配料清单-打印',   '生产配料清单-打印',    '生产配料清单-打印',     '',        '生产配料清单-打印',  '生产配料清单-打印',    '生产配料清单-打印',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '生产配料清单-打印',    '生产配料清单-打印',        '生产配料清单-打印'



select                      10056, 'FMyMenuUnOrder','任务反下达',   '任务反下达',    '任务反下达',     '',        '任务反下达',  '任务反下达',    '任务反下达',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '任务反下达',    '任务反下达',        '任务反下达'
union all
select                      10055, 'FMyMenuOrder','任务下达',   '任务下达',    '任务下达',     '',        '任务下达',  '任务下达',    '任务下达',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '任务下达',    '任务下达',        '任务下达'

select                      10062, 'FReGeneratePPBOMNotPack','重新生成投料单(非包材)',   '重新生成投料单(非包材)',    '重新生成投料单(非包材)',     '',        '重新生成投料单(非包材)',  '重新生成投料单(非包材)',    '重新生成投料单(非包材)',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '重新生成投料单(非包材)',    '重新生成投料单(非包材)',        '重新生成投料单(非包材)'


select                      10061, 'FReGeneratePPBOMPack','重新生成投料单(包材)',   '重新生成投料单(包材)',    '重新生成投料单(包材)',     '',        '重新生成投料单(包材)',  '重新生成投料单(包材)',    '重新生成投料单(包材)',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '重新生成投料单(包材)',    '重新生成投料单(包材)',        '重新生成投料单(包材)'

select                      10060, 'FMyMenuPOOrderPriceChange','单价变更',   '单价变更',    '单价变更',     '',        '单价变更',  '单价变更',    '单价变更',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '单价变更',    '单价变更',        '单价变更'


union all
select                      10058, 'FMyMenuPORequestPackFile','包材文件',   '包材文件',    '包材文件',     '',        '包材文件',  '包材文件',    '包材文件',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '包材文件',    '包材文件',        '包材文件'
union all

--FMyMenuUpdateLine --暂未使用
select                      10057, 'FMyMenuUpdateLine','更新生产拉线',   '更新生产拉线',    '更新生产拉线',     '',        '更新生产拉线',  '更新生产拉线',    '更新生产拉线',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '更新生产拉线',    '更新生产拉线',        '更新生产拉线'
union all

select                      10054, 'FMyMenuSEOrderPackFile','包材文件',   '包材文件',    '包材文件',     '',        '包材文件',  '包材文件',    '包材文件',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '包材文件',    '包材文件',        '包材文件'
union all
select                      10053, 'FMyMenuPOOrderPackFile','包材文件',   '包材文件',    '包材文件',     '',        '包材文件',  '包材文件',    '包材文件',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '包材文件',    '包材文件',        '包材文件'


select                      10052, 'FMyMenuMrpByOrder','物料需求计算',   '物料需求计算',    '物料需求计算',     '',        '物料需求计算',  '物料需求计算',    '物料需求计算',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '物料需求计算',    '物料需求计算',        '物料需求计算'
union all
select                      10051, 'FMyMenuPPBomEdit','投料单批量查看/维护',   '投料单批量查看/维护',    '投料单批量查看/维护',     '',        '投料单批量查看/维护',  '投料单批量查看/维护',    '投料单批量查看/维护',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '投料单批量查看/维护',    '投料单批量查看/维护',        '投料单批量查看/维护'
union all
select                      10050, 'FReGeneratePPBOM','重新生成投料单',   '重新生成投料单',    '重新生成投料单',     '',        '重新生成投料单',  '重新生成投料单',    '重新生成投料单',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '重新生成投料单',    '重新生成投料单',        '重新生成投料单'
union all
select                      10049, 'FCPPPBomPrint','生产投料单-打印',   '生产投料单-打印',    '生产投料单-打印',     '',        '生产投料单-打印',  '生产投料单-打印',    '生产投料单-打印',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '生产投料单-打印',    '生产投料单-打印',        '生产投料单-打印'
union all
select                      10048, 'FMyMenuUpdatePlanEndDate','更新计划完工日期',   '更新计划完工日期',    '更新计划完工日期',     '',        '更新计划完工日期',  '更新计划完工日期',    '更新计划完工日期',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '更新计划完工日期',    '更新计划完工日期',        '更新计划完工日期'
union all
select                      10047, 'FMyMenuGetRelZP1','关联虚仓单据',   '关联虚仓单据',    '关联虚仓单据',     '',        '关联虚仓单据',  '关联虚仓单据',    '关联虚仓单据',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '关联虚仓单据',    '关联虚仓单据',        '关联虚仓单据'
union all
select                      10046, 'FMyMenuGetRelZP10','关联虚仓单据',   '关联虚仓单据',    '关联虚仓单据',     '',        '关联虚仓单据',  '关联虚仓单据',    '关联虚仓单据',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '关联虚仓单据',    '关联虚仓单据',        '关联虚仓单据'
union all
select                      10045, 'FMyMenuGetRelZP24','关联虚仓单据',   '关联虚仓单据',    '关联虚仓单据',     '',        '关联虚仓单据',  '关联虚仓单据',    '关联虚仓单据',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '关联虚仓单据',    '关联虚仓单据',        '关联虚仓单据'
union all
select                      10044, 'FMyMenuGetRelZP29','关联虚仓单据',   '关联虚仓单据',    '关联虚仓单据',     '',        '关联虚仓单据',  '关联虚仓单据',    '关联虚仓单据',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '关联虚仓单据',    '关联虚仓单据',        '关联虚仓单据'
union all
select                      10043, 'FMyMenuChangeBiller72','获取修改权限',   '获取修改权限',    '获取修改权限',     '',        '获取修改权限',  '获取修改权限',    '获取修改权限',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '获取修改权限',    '获取修改权限',        '获取修改权限'
union all
select                      10042, 'FMyMenuChangeBiller83','获取修改权限',   '获取修改权限',    '获取修改权限',     '',        '获取修改权限',  '获取修改权限',    '获取修改权限',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '获取修改权限',    '获取修改权限',        '获取修改权限'
union all
select                      10041, 'FMyMenuChangeBiller24','获取修改权限',   '获取修改权限',    '获取修改权限',     '',        '获取修改权限',  '获取修改权限',    '获取修改权限',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '获取修改权限',    '获取修改权限',        '获取修改权限'
union all
select                      10040, 'FMyMenuChangeBiller26','获取修改权限',   '获取修改权限',    '获取修改权限',     '',        '获取修改权限',  '获取修改权限',    '获取修改权限',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '获取修改权限',    '获取修改权限',        '获取修改权限'
union all
select                      10039, 'FMyMenuChangeBiller29','获取修改权限',   '获取修改权限',    '获取修改权限',     '',        '获取修改权限',  '获取修改权限',    '获取修改权限',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '获取修改权限',    '获取修改权限',        '获取修改权限'
union all
select                      10038, 'FMyMenuChangeBiller41','获取修改权限',   '获取修改权限',    '获取修改权限',     '',        '获取修改权限',  '获取修改权限',    '获取修改权限',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '获取修改权限',    '获取修改权限',        '获取修改权限'
union all
select                      10037, 'FMyMenuProductConfig','产品配置',   '产品配置',    '产品配置',     '',        '产品配置',  '产品配置',    '产品配置',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '产品配置',    '产品配置',        '产品配置'
union all
select                      10036, 'FMyMenuBatchPPBomEdit','投料单批量查看/维护',   '投料单批量查看/维护',    '投料单批量查看/维护',     '',        '投料单批量查看/维护',  '投料单批量查看/维护',    '投料单批量查看/维护',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '投料单批量查看/维护',    '投料单批量查看/维护',        '投料单批量查看/维护'
union all
select                      10035, 'FMyMenuPrint24','打印 领料单',   '打印 领料单',    '打印 领料单',     '',        '打印 领料单',  '打印 领料单',    '打印 领料单',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '打印 领料单',    '打印 领料单',        '打印 领料单'
union all
select                      10034, 'FMyMenuPrint41','打印 调拨单',   '打印 调拨单',    '打印 调拨单',     '',        '打印 调拨单',  '打印 调拨单',    '打印 调拨单',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '打印 调拨单',    '打印 调拨单',        '打印 调拨单'
union all
select                      10033, 'FMyMenuPrint29','打印 其他出库单',   '打印 其他出库单',    '打印 其他出库单',     '',        '打印 其他出库单',  '打印 其他出库单',    '打印 其他出库单',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '打印 其他出库单',    '打印 其他出库单',        '打印 其他出库单'
union all
select                      10032, 'FMyMenuPrint26','打印 虚仓出库单',   '打印 虚仓出库单',    '打印 虚仓出库单',     '',        '打印 虚仓出库单',  '打印 虚仓出库单',    '打印 虚仓出库单',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '打印 虚仓出库单',    '打印 虚仓出库单',        '打印 虚仓出库单'
union all
select                      10031, 'FMyMenuSpilit26','拆分虚仓出库单',   '拆分虚仓出库单',    '拆分虚仓出库单',     '',        '拆分虚仓出库单',  '拆分虚仓出库单',    '拆分虚仓出库单',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '拆分虚仓出库单',    '拆分虚仓出库单',        '拆分虚仓出库单'
union all
select                      10030, 'FMyMenuSpilit29','拆分其他出库单',   '拆分其他出库单',    '拆分其他出库单',     '',        '拆分其他出库单',  '拆分其他出库单',    '拆分其他出库单',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '拆分其他出库单',    '拆分其他出库单',        '拆分其他出库单'
union all
select                      10029, 'FMyMenuSpilit41','拆分调拨单',   '拆分调拨单',    '拆分调拨单',     '',        '拆分调拨单',  '拆分调拨单',    '拆分调拨单',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '拆分调拨单',    '拆分调拨单',        '拆分调拨单'
union all
select                      10028, 'FMyMenuGenerateOutStock41','批量生成调拨单[倒冲]',   '批量生成调拨单[倒冲]',    '批量生成调拨单[倒冲]',     '',        '批量生成调拨单[倒冲]',  '批量生成调拨单[倒冲]',    '批量生成调拨单[倒冲]',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '批量生成调拨单[倒冲]',    '批量生成调拨单[倒冲]',        '批量生成调拨单[倒冲]'
union all
select                      10027, 'FMyMenuSpilit','拆分领料单',   '拆分领料单',    '拆分领料单',     '',        '拆分领料单',  '拆分领料单',    '拆分领料单',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '拆分领料单',    '拆分领料单',        '拆分领料单'
union all
select                      10026, 'FMyMenuGenerateOutStock24','批量生成领料单',   '批量生成领料单',    '批量生成领料单',     '',        '批量生成领料单',  '批量生成领料单',    '批量生成领料单',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '批量生成领料单',    '批量生成领料单',        '批量生成领料单'
union all
select                      10025, 'FMyMenuChangeUser29','变更使用人',   '变更使用人',    '变更使用人',     '',        '变更使用人',  '变更使用人',    '变更使用人',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '变更使用人',    '变更使用人',        '变更使用人'
union all
select                      10020, 'FMyMenuReGeneratePlanBOM','重新生成计划投料单',   '重新生成计划投料单',    '重新生成计划投料单',     '',        '重新生成计划投料单',  '重新生成计划投料单',    '重新生成计划投料单',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '重新生成计划投料单',    '重新生成计划投料单',        '重新生成计划投料单'
union all
select                      10019, 'FMyMenuReGeneratePackOut','重新生成包材发料通知单',   '重新生成包材发料通知单',    '重新生成包材发料通知单',     '',        '重新生成包材发料通知单',  '重新生成包材发料通知单',    '重新生成包材发料通知单',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '重新生成包材发料通知单',    '重新生成包材发料通知单',        '重新生成包材发料通知单'
union all
select                      10018, 'FMyMenuOrderFileUp','上传附件',   '上传附件',    '上传附件',     '',        '上传附件',  '上传附件',    '上传附件',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '上传附件',    '上传附件',        '上传附件'
union all
select                      10017, 'FMyMenuOrderFileDown','查看附件',   '查看附件',    '查看附件',     '',        '查看附件',  '查看附件',    '查看附件',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '查看附件',    '查看附件',        '查看附件'
union all
select                      10016, 'FMyMenuSimulateAll','模拟发料(全部)',   '模拟发料(全部)',    '模拟发料(全部)',     '',        '模拟发料(全部)',  '模拟发料(全部)',    '模拟发料(全部)',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '模拟发料(全部)',    '模拟发料(全部)',        '模拟发料(全部)'
union all
select                      10015, 'FMyMenuChangeInType','入库方式变更',   '入库方式变更',    '入库方式变更',     '',        '入库方式变更',  '入库方式变更',    '入库方式变更',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '入库方式变更',    '入库方式变更',        '入库方式变更'
union all
select                      10014, 'FMyMenuSimulateWGByPP','模拟发料',   '模拟发料',    '模拟发料',     '',        '模拟发料',  '模拟发料',    '模拟发料',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '模拟发料',    '模拟发料',        '模拟发料'
union all
select                      10013, 'FMyMenuChangeFromPP','预测订单变更',   '生预测订单变更',    '预测订单变更',     '',        '预测订单变更',  '生预测订单变更',    '预测订单变更',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '预测订单变更',    '预测订单变更',        '预测订单变更'
union all
select                      10011, 'FMyMenuSimulateZZ','模拟发料(半成品)',   '模拟发料(半成品)',    '模拟发料(半成品)',     '',        '模拟发料(半成品)',  '模拟发料(半成品)',    '模拟发料(半成品)',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '模拟发料(半成品)',    '模拟发料(半成品)',        '模拟发料(半成品)'
union all
select                      10012, 'FMyMenuSimulateWG','模拟发料(外购)',   '模拟发料(外购)',    '模拟发料(外购)',     '',        '模拟发料(外购)',  '模拟发料(外购)',    '模拟发料(外购)',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '模拟发料(外购)',    '模拟发料(外购)',        '模拟发料(外购)'
union all
select                      10009, 'FMyMenuChangeOutType','出库方式变更',   '出库方式变更',    '出库方式变更',     '',        '出库方式变更',  '出库方式变更',    '出库方式变更',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '出库方式变更',    '出库方式变更',        '出库方式变更'
union all
select                      10008, 'FMyMenuUpdatePlanBeginDate','更新计划开工日期',   '更新计划开工日期',    '更新计划开工日期',     '',        '更新计划开工日期',  '更新计划开工日期',    '更新计划开工日期',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '更新计划开工日期',    '更新计划开工日期',        '更新计划开工日期'
union all
select                      10006, 'FMyMenuToScheduleDetailFromPP','生成 生产排程明细',   '生成 生产排程明细',    '生成 生产排程明细',     '',        '生成 生产排程明细',  '生成 生产排程明细',    '生成 生产排程明细',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '生成 生产排程明细',    '生成 生产排程明细',        '生成 生产排程明细'
union all
select                      10005, 'FMyMenuToScheduleDetail','生成 生产排程明细',   '生成 生产排程明细',    '生成 生产排程明细',     '',        '生成 生产排程明细',  '生成 生产排程明细',    '生成 生产排程明细',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     '生成 生产排程明细',    '生成 生产排程明细',        '生成 生产排程明细'
union all
select                      10004, 'FMyMenuCI','CI引出',   'CI引出',    'CI引出',     '',        'CI引出',  'CI引出',    'CI引出',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     'CI引出',    'CI引出',        'CI引出'
union all
select                      10003, 'FMyMenuPI','PI引出',   'PI引出',    'PI引出',     '',        'PI引出',  'PI引出',    'PI引出',    0,           0,       1,      0,       0,        '',     '',         '',        0,       0,       0,     'PI引出',    'PI引出',        'PI引出'

--select fmenuid,* from iclisttemplate where FLogicStr like '%FMyMenu%'

--外购入库
select t1.*
--Update t1 set FLogicStr='H:OrderAffirm,OrderRefuse,OrderAppend,ViewCAV,ViewFee,ViewContract,HookBill,UnHookBill,ReHookBill,UnReHookBill,Union,MakeDown,ReMakeDown,Complete,ReComplete,MakeMaterialGet,CheckBOM,MakeLowerBills,ViewMaterialDiff,ViewMaterial,LockStock,UnLockStock,Diminution,UnDiminution,ATPQuery,LockQuery|V:|FModule:1089|FModelDetail:1|V:FMyMenuGetRelZP1'
from IclistTemplate t1
where FID =1

--生产投料单
select t1.*
--Update t1 set FLogicStr='H:MOPORelation,UnionPlanOrder,UndoUnion,Split,New,Delete,ViewAdviceCancelInfo,StarUp,UnStarUp,ICMOAppend,ViewSourceRequire,ViewSourceDetail,ViewAdviceInfo,ViewPutReport,PutInBillAfterModify,PutInBill,OperOutStock,OutStockByStock,PlanOperCheck,PlanOperUnCheck,ThinQuery,EditBillRpt,ItemChange,EditOperRpt,EditSHWorkBill,CopySelBill,CopyAllBill,PausePlan,UnPausePlan,Union,MakeDown,ReMakeDown,Complete,ReComplete,BillCancel,UndoBillCancel,UnionBill,ViewBomCompare,SplitBill,MakeMaterialGet,MakeLowerBills,CheckBOM,ViewVoucher,SplitICMO|FModule:1023|FModelDetail:11|V:FMyMenuPPBomEdit'
from IclistTemplate t1
where FID =610

--其他入库
select t1.*
--Update t1 set FLogicStr='H:OrderAffirm,OrderRefuse,OrderAppend,ViewCAV,ViewFee,ViewContract,ViewHookBill,HookBill,UnHookBill,UnReHookBill,ReHookBill,KickBackBill,UndoKickBackBill,Union,MakeDown,ReMakeDown,Complete,ReComplete,UnionBill,SplitBill,MakeMaterialGet,MakeLowerBills,CheckBOM,ViewMaterialDiff,ViewMaterial,LockStock,UnLockStock,Diminution,UnDiminution,ATPQuery,LockQuery|V:|FModule:1089|FModelDetail:4|V:FMyMenuGetRelZP10'
from IclistTemplate t1
where FID =7

--生产领料
select t1.*
--Update t1 set FLogicStr='H:OrderAffirm,OrderRefuse,OrderAppend,ViewCAV,ViewFee,ViewContract,ViewHookBill,HookBill,UnHookBill,ReHookBill,UnReHookBill,KickBackBill,UndoKickBackBill,Union,MakeDown,ReMakeDown,Complete,ReComplete,UnionBill,SplitBill,MakeMaterialGet,MakeLowerBills,CheckBOM,ViewMaterialDiff,ViewMaterial,LockStock,UnLockStock,Diminution,UnDiminution,ATPQuery,LockQuery|FModule:1090|FModelDetail:2|V:FMyMenuSpilit,FMyMenuPrint24,FMyMenuChangeBiller24,FMyMenuGetRelZP24'
from IclistTemplate t1
where FID =11 

--其他出库
select t1.*
--Update t1 set FLogicStr='H:OrderAffirm,OrderRefuse,OrderAppend,ViewCAV,ViewFee,ViewContract,ViewHookBill,HookBill,UnHookBill,ReHookBill,UnReHookBill,KickBackBill,UndoKickBackBill,Union,MakeDown,ReMakeDown,Complete,ReComplete,UnionBill,SplitBill,MakeMaterialGet,MakeLowerBills,CheckBOM,ViewMaterialDiff,ViewMaterial,LockStock,UnLockStock,Diminution,UnDiminution,ATPQuery,LockQuery|V:|FModule:1090|FModelDetail:4|V:FMyMenuChangeUser29,FMyMenuSpilit29,FMyMenuPrint29,FMyMenuChangeBiller29,FMyMenuGetRelZP29'
from IclistTemplate t1
where FID =16

--虚仓出库
select t1.*
--Update t1 set FLogicStr='H:OrderAffirm,OrderRefuse,ViewVoucher,ViewCAV,ViewFee,OrderAppend,ViewContract,ViewHookBill,HookBill,UnHookBill,UnReHookBill,ReHookBill,KickBackBill,UndoKickBackBill,Union,MakeDown,ReMakeDown,Complete,ReComplete,UnionBill,SplitBill,MakeMaterialGet,MakeLowerBills,CheckBOM,ViewMaterialDiff,ViewMaterial,LockStock,UnLockStock,Diminution,UnDiminution,ATPQuery,LockQuery|V:|FModule:1088|FModelDetail:33|V:FMyMenuSpilit26,FMyMenuPrint26,FMyMenuChangeBiller26'
from IclistTemplate t1
where FID =14 

--仓库调拨
select t1.*
--Update t1 set FLogicStr='H:OrderAffirm,OrderRefuse,OrderAppend,ViewCAV,ViewFee,ViewContract,ViewHookBill,HookBill,UnHookBill,ReHookBill,UnReHookBill,KickBackBill,UndoKickBackBill,Union,MakeDown,ReMakeDown,Complete,ReComplete,UnionBill,SplitBill,MakeMaterialGet,MakeLowerBills,CheckBOM,ViewMaterialDiff,ViewMaterial,LockStock,UnLockStock,Diminution,UnDiminution,ATPQuery,LockQuery|V:|FModule:1088|FModelDetail:30|V:FMyMenuSpilit41,FMyMenuPrint41,FMyMenuChangeBiller41'
from IclistTemplate t1
where FID =18 

--采购订单
select t1.*
--Update t1 set FLogicStr='H:ViewHookBill,HookBill,UnHookBill,ReHookBill,UnReHookBill,ViewCAV,ViewFee,KickBackBill,UndoKickBackBill,Union,MakeDown,ReMakeDown,Complete,ReComplete,UnionBill,SplitBill,MakeMaterialGet,MakeLowerBills,ViewVoucher,CheckBOM,ViewMaterialDiff,ViewMaterial,LockStock,UnLockStock,Diminution,UnDiminution,ATPQuery,LockQuery|V:BizUnClosed,BizClosed|FModule:1088|FModelDetail:2|V:FMyMenuPOOrderPackFile,FMyMenuPOOrderPriceChange'
from IclistTemplate t1
where FID =26

--收料通知单
select t1.*
--Update t1 set FLogicStr='H:OrderAffirm,OrderRefuse,OrderAppend,ViewCAV,ViewFee,ViewContract,ViewHookBill,HookBill,UnHookBill,UnReHookBill,ReHookBill,KickBackBill,UndoKickBackBill,Union,MakeDown,ReMakeDown,Complete,ReComplete,UnionBill,SplitBill,MakeMaterialGet,MakeLowerBills,ViewVoucher,CheckBOM,ViewMaterialDiff,ViewMaterial,LockStock,UnLockStock,Diminution,UnDiminution,ATPQuery,LockQuery|X:Fauxprice,Famount|FModule:1088|FModelDetail:3|V:FMyMenuChangeInType,FMyMenuChangeBiller72'
from IclistTemplate t1
where FID =27 

--销售订单
select t1.*
--Update t1 set FLogicStr='H:ViewHookBill,HookBill,UnHookBill,ReHookBill,UnReHookBill,ViewCAV,ViewFee,KickBackBill,UndoKickBackBill,Union,MakeDown,ReMakeDown,Complete,ReComplete,UnionBill,SplitBill,MakeMaterialGet,MakeLowerBills,ViewVoucher,CheckBOM,ViewMaterialDiff,ViewMaterial|V:BizUnClosed,BizClosed,ViewSeOrderQuery|FModule:1088|FModelDetail:21|V:FMyMenuOrderFileDown,FMyMenuOrderFileUp,FMyMenuProductConfig,FCPPPBomPrint,FMyMenuSEOrderPackFile,FCPPPBomListPrint'
from IclistTemplate t1
where FID =32 

--发货通知
select t1.*
--Update t1 set FLogicStr='H:OrderAffirm,OrderRefuse,OrderAppend,ViewCAV,ViewFee,ViewContract,ViewHookBill,HookBill,UnHookBill,ReHookBill,UnReHookBill,KickBackBill,UndoKickBackBill,Union,MakeDown,ReMakeDown,Complete,ReComplete,UnionBill,SplitBill,MakeMaterialGet,MakeLowerBills,ViewVoucher,CheckBOM,ViewMaterialDiff,ViewMaterial,LockStock,UnLockStock,Diminution,UnDiminution,ATPQuery,LockQuery|X:Fauxprice,Famount|FModule:1088|FModelDetail:22|V:FMyMenuCI,FMyMenuChangeOutType,FMyMenuChangeBiller83'
from IclistTemplate t1
where FID =34 


--生产任务单
select t1.*
--Update t1 set FLogicStr='H:ICMOAppend,UnionPlanOrder,UndoUnion,Split,ViewAdviceCancelInfo,StarUp,UnStarUp,ViewSourceRequire,ViewSourceDetail,ViewAdviceInfo,ViewPutReport,PutInBillAfterModify,PutInBill,OperOutStock,OperCheck,SHWIPRet,SHLockStock,SHUnLockStock,PlanOperCheck,PlanOperUnCheck,ItemMake,ThinQuery,EditBillRpt,EditOperRpt,ItemChange,Union,BillCheck,AdCheck,ViewBomCompare,UnionBill,SplitBill,MakeMaterialGet,ViewVoucher,ViewMaterial|V:BillUnConfirm,BillConfirm,ICMOBatchMaintain,ICMOTrackQuery|FModule:1022|FModelDetail:10|V:FMyMenuUpdatePlanBeginDate,FMyMenuBatchPPBomEdit,FMyMenuUpdatePlanEndDate,FMyMenuGenerateOutStock24,FReGeneratePPBOM,FReGeneratePPBOMPack,FReGeneratePPBOMNotPack,FMyMenuOrder,FMyMenuUnOrder,FMyMenuBarcodePrint,FMyMenuRptAndInStock,FMyMenuUpdateWorkshop,FMyMenuGenerateICMOBillNo'
from IclistTemplate t1
where FID =36 

--产品预测单
select t1.*
--Update t1 set FLogicStr='H:PlanOperCheck,PlanOperUnCheck,EditBillRpt,ItemMake,EditOperRpt,EditSHWorkBill,ThinQuery,PausePlan,UnPausePlan,ItemChange,Union,MakeDown,ReMakeDown,Complete,ReComplete,UnionBill,SplitBill,ViewPrvBill,MakeMaterialGet,MakeLowerBills,ViewVoucher,CheckBOM,ViewMaterialDiff,ViewMaterial,SplitICMO|FModule:1015|FModelDetail:14|V:FMyMenuToScheduleDetailFromPP,FMyMenuChangeFromPP,FMyMenuSimulateWGByPP,FMyMenuToICMOFromPP'
from IclistTemplate t1
where FID =600
 
--select * from IclistTemplate
--select * from t_BandToolMapping where ftoolid in (10020) select * from t_BandToolMapping where fid=610
--fid 为fmenuid
--select * from t_BandToolMapping where ftoolid>=10058  --delete from t_BandToolMapping where ftoolid=10006


insert into t_BandToolMapping(FID,FBandID,FToolID,FSubBandID,FIndex,FComName,                  FBeginGroup)
select                        88, 12,     10059,  0,         17,    '|MyNewWay.clsPPOrderList',0  --FMyMenuToICMOFromPP	生成 生产任务单

select                        90, 17,     10073,  0,         122,   '|MyNewWay.clsICMOList',0  --FMyMenuGenerateICMOBillNo	

select                        90, 17,     10072,  0,         121,   '|MyNewWay.clsICMOList',0  --FMyMenuUpdateWorkshop	

select                        90, 17,     10057,  0,         121,   '|MyNewWay.clsICMOList',0  --FMyMenuBarcodePrint	条码打印

select                        90, 17,     10071,  0,         100,   '|MyNewWay.clsICMOList',0  --FMyMenuRptAndInStock	汇报/入库

select                        100,38,     10058,  0,         17,    '|MyNewWay.clsSeOrderList',0  --FCPPPBomListPrint	成品生产配料清单打印

select                        90, 17,     10056,  0,         121,   '|MyNewWay.clsICMOList',0  --FMyMenuUnOrder	反下达
union all
select                        90, 17,     10055,  0,         120,   '|MyNewWay.clsICMOList',0  --FMyMenuOrder	下达

select                        90, 17,     10062,  0,         100,   '|MyNewWay.clsICMOList',0  --FReGeneratePPBOMNotPack	重新生成投料单(非包材)

select                        90, 17,     10061,  0,         100,   '|MyNewWay.clsICMOList',0  --FReGeneratePPBOMPack	重新生成投料单(包材)

select                        81, 2,      10060,  0,         17,    '|MyNewWay.clsPOOrderList',0  --FMyMenuPOOrderPriceChange	单价变更


union all
select                        82, 2,      10058,  0,         17,    '|MyNewWay.clsPORequestList',0  --FMyMenuPORequestPackFile	包材文件
union all
select                        90, 17,     10057,  0,         122,   '|MyNewWay.clsICMOList',0  --FMyMenuUpdateLine	更新生产拉线  --暂未使用
union all


select                        100,38,     10054,  0,         17,    '|MyNewWay.clsSeOrderList',0  --FMyMenuSEOrderPackFile	包材文件
union all
select                        81, 2,      10053,  0,         17,    '|MyNewWay.clsPOOrderList',0  --FMyMenuPOOrderPackFile	包材文件
union all
select                        100,38,     10052,  0,         17,    '|MyNewWay.clsSeOrderList',0  --FMyMenuMrpByOrder	物料需求计算
union all
select                        90, 17,     10051,  0,         100,   '|MyNewWay.clsPPBomList',0  --FMyMenuPPBomEdit	投料单批量维护
union all
select                        90, 17,     10050,  0,         100,   '|MyNewWay.clsICMOList',0  --FReGeneratePPBOM	重新生成投料单
union all
select                        100,38,     10049,  0,         17,    '|MyNewWay.clsSeOrderList',0  --FCPPPBomPrint	成品生产投料单打印
union all
select                        90, 17,     10048,  0,         100,   '|MyNewWay.clsICMOList',0  --FMyMenuUpdatePlanEndDate	更新计划完工日期
union all
select                        82, 2,      10047,  0,         18,    '|MyNewWay.clsICStockList1',0  --FMyMenuGetRelZP1	关联虚仓单据 外购入库
union all
select                        82, 2,      10046,  0,         18,    '|MyNewWay.clsICStockList10',0  --FMyMenuGetRelZP10	关联虚仓单据 其它入库
union all
select                        82, 2,      10045,  0,         18,    '|MyNewWay.clsICStockList24',0  --FMyMenuGetRelZP24	关联虚仓单据 领料单
union all
select                        82, 2,      10044,  0,         18,    '|MyNewWay.clsICStockList29',0  --FMyMenuGetRelZP29	关联虚仓单据 其他出库单
union all
select                        82, 2,      10043,  0,         18,    '|MyNewWay.clsPOInStockList',0  --FMyMenuChangeBiller72	获取变更权限 收料通知单
union all
select                        82, 2,      10042,  0,         18,    '|MyNewWay.clsSEOutStockList',0  --FMyMenuChangeBiller83	获取变更权限 发货通知单
union all
select                        82, 2,      10041,  0,         18,    '|MyNewWay.clsICStockList24',0  --FMyMenuChangeBiller24	获取变更权限 领料单
union all
select                        82, 2,      10040,  0,         18,    '|MyNewWay.clsZPStockList26',0  --FMyMenuChangeBiller26	获取变更权限 虚仓出库单
union all
select                        82, 2,      10039,  0,         18,    '|MyNewWay.clsICStockList29',0  --FMyMenuChangeBiller29	获取变更权限 其他出库单
union all
select                        82, 2,      10038,  0,         18,    '|MyNewWay.clsICStockList41',0  --FMyMenuChangeBiller41	获取变更权限 调拨单
union all

select                        100,38,     10037,  0,         17,    '|MyNewWay.clsSeOrderList',0  --FMyMenuPI	PI引出
union all
select                        90, 17,     10036,  0,         104,   '|MyNewWay.clsICMOList',0  --FMyMenuBatchPPBomEdit	投料单批量维护
union all
select                        82, 2,      10035,  0,         18,    '|MyNewWay.clsICStockList24',0  --FMyMenuPrint24	打印 领料单
union all
select                        82, 2,      10034,  0,         18,    '|MyNewWay.clsICStockList41',0  --FMyMenuPrint41	打印 调拨单
union all
select                        82, 2,      10033,  0,         18,    '|MyNewWay.clsICStockList29',0  --FMyMenuPrint29	打印 其他出库单
union all
select                        82, 2,      10032,  0,         18,    '|MyNewWay.clsZPStockList26',0  --FMyMenuPrint26	打印 虚仓出库单
union all
select                        82, 2,      10031,  0,         18,    '|MyNewWay.clsZPStockList26',0  --FMyMenuSpilit26	拆分虚仓出库单
union all
select                        82, 2,      10030,  0,         18,    '|MyNewWay.clsICStockList29',0  --FMyMenuSpilit29	拆分其他出库单
union all
select                        82, 2,      10029,  0,         18,    '|MyNewWay.clsICStockList41',0  --FMyMenuSpilit41	拆分调拨单
union all
select                        90, 17,     10028,  0,         100,   '|MyNewWay.clsICMOList',0  --FMyMenuGenerateOutStock41	批量生成调拨单[倒冲]
union all
select                        82, 2,      10027,  0,         18,    '|MyNewWay.clsICStockList24',0  --FMyMenuSpilit	拆分领料单
union all
select                        90, 17,     10026,  0,         100,   '|MyNewWay.clsICMOList',0  --FMyMenuGenerateOutStock24	批量生成领料单
union all
select                        82, 2,      10025,  0,         18,    '|MyNewWay.clsICStockList29',0  --FMyMenuChangeUser29	变更使用人
union all
select                        100,38,     10020,  0,         17,    '|MyNewWay.clsSeOrderList',0  --FMyMenuReGeneratePlanBOM	重新生成计划投料单
union all
select                        100,38,     10019,  0,         17,    '|MyNewWay.clsSeOrderList',0  --FMyMenuReGeneratePackOut	重新生成包材发料通知单
union all
select                        100,38,     10018,  0,         19,    '|MyNewWay.clsSeOrderList',0  --FMyMenuOrderFileUp	上传附件
union all
select                        100,38,     10017,  0,         18,    '|MyNewWay.clsSeOrderList',0  --FMyMenuOrderFileDown	查看附件
union all
select                        100,38,     10016,  0,         17,    '|MyNewWay.clsSeOrderList',0  --FMyMenuSimulateAll	模拟发料(全部)
union all
select                        82, 2,      10015,  0,         17,    '|MyNewWay.clsPOInStockList',0  --FMyMenuChangeInType	入库方式变更
union all
select                        88, 12,     10014,  0,         17,    '|MyNewWay.clsPPOrderList',0  --FMyMenuSimulateWGByPP	模拟发料
union all
select                        88, 12,     10013,  0,         17,    '|MyNewWay.clsPPOrderList',0  --FMyMenuChangeFromPP	预测订单变更
union all
select                        100,38,     10012,  0,         18,    '|MyNewWay.clsSeOrderList',0  --FMyMenuSimulateWG	模拟发料(外购)
union all
select                        100,38,     10011,  0,         18,    '|MyNewWay.clsSeOrderList',0  --FMyMenuSimulateZZ	模拟发料(半成品)
union all
select                        82, 2,      10009,  0,         17,    '|MyNewWay.clsSEOutStockList',0  --FMyMenuChangeOutType	出库方式变更
union all
select                        90, 17,     10008,  0,         100,   '|MyNewWay.clsICMOList',0  --FMyMenuUpdatePlanBeginDate	更新计划开工日期
union all
select                        88, 12,     10006,  0,         17,    '|MyNewWay.clsPPOrderList',0  --FMyMenuToScheduleDetailFromPP	生成 生产排程明细
union all
select                        100,38,     10005,  0,         17,    '|MyNewWay.clsSeOrderList',0  --FMyMenuToScheduleDetail	生成 生产排程明细
union all
select                        82, 2,      10004,  0,         17,    '|MyNewWay.clsSEOutStockList',0  --FMyMenuCI	CI引出
union all
select                        100,38,     10003,  0,         17,    '|MyNewWay.clsSeOrderList',0  --FMyMenuPI	PI引出

go

*/

